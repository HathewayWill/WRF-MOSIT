#!/bin/bash
ulimit -s unlimited

# Conda environment test
if [ -n "$CONDA_DEFAULT_ENV" ]; then
	echo "CONDA_DEFAULT_ENV is active: $CONDA_DEFAULT_ENV"
	echo "Turning off $CONDA_DEFAULT_ENV"
	conda deactivate
	conda deactivate
else
	echo "CONDA_DEFAULT_ENV is not active."
	echo "Continuing script"
fi

start=$(date)
START=$(date +"%s")

############################### Version Numbers ##########################
# For Ease of updating
##########################################################################
export METPLUS_Version=6.2.0
export met_Version_number=12.2.0
export met_VERSION_number=12.2
export METPLUS_DATA=6.2

export Zlib_Version=1.3.1
export Mpich_Version=4.3.2
export Libpng_Version=1.6.51
export Jasper_Version=1.900.1
export HDF5_Version=1.14.6
export Pnetcdf_Version=1.14.1
export Netcdf_C_Version=4.9.3
export Netcdf_Fortran_Version=4.6.2
export Netcdf_CXX_Version=4.3.1

export WRF_VERSION=4.7.1
export WPS_VERSION=4.6.0
export CMAQ_VERSION=5.5

export HYDRO_CROTON_TEST_CASE=5.4.0
export HYDRO_CROTON_TEST_CASE_MINOR=5.4

############################### Citation Requirement  ####################
echo " "
echo " The GitHub software WRF-MOSIT (Version 2.1.1) by W. Hatheway (2023)"
echo " "
echo "It is important to note that any usage or publication that incorporates or references this software must include a proper citation to acknowledge the work of the author."
echo " "
echo -e "This is not only a matter of respect and academic integrity, but also a \e[31mrequirement\e[0m set by the author. Please ensure to adhere to this guideline when using this software."
echo " "
echo -e "\e[31mCitation: Hatheway, W., Snoun, H., ur Rehman, H., & Mwanthi, A. WRF-MOSIT: a modular and cross-platform tool for configuring and installing the WRF model [Computer software]. https://doi.org/10.1007/s12145-023-01136-y]\e[0m"

echo " "
read -p "Press enter to continue"

############################### System Architecture Type #################
# Determine if the system is 32 or 64-bit based on the architecture
##########################################################################
export SYS_ARCH=$(uname -m)

if [ "$SYS_ARCH" = "x86_64" ] || [ "$SYS_ARCH" = "arm64" ]; then
	export SYSTEMBIT="64"
else
	export SYSTEMBIT="32"
fi

# Determine the chip type if on macOS (ARM or Intel)
if [ "$SYS_ARCH" = "arm64" ]; then
	export MAC_CHIP="ARM"
else
	export MAC_CHIP="Intel"
fi

############################# System OS Version #############################
# Detect if the OS is macOS or Linux
#############################################################################
export SYS_OS=$(uname -s)

if [ "$SYS_OS" = "Darwin" ]; then
	export SYSTEMOS="MacOS"
	# Get the macOS version using sw_vers
	export MACOS_VERSION=$(sw_vers -productVersion)
	echo "Operating system detected: MacOS, Version: $MACOS_VERSION"
elif [ "$SYS_OS" = "Linux" ]; then
	export SYSTEMOS="Linux"
fi

########## RHL and Linux Distribution Detection #############
# More accurate Linux distribution detection using /etc/os-release
#################################################################
if [ "$SYSTEMOS" = "Linux" ]; then
	if [ -f /etc/os-release ]; then
		# Extract the distribution name and version from /etc/os-release
		export DISTRO_NAME=$(grep -w "NAME" /etc/os-release | cut -d'=' -f2 | tr -d '"')
		export DISTRO_VERSION=$(grep -w "VERSION_ID" /etc/os-release | cut -d'=' -f2 | tr -d '"')

		# Print the distribution name and version
		echo "Operating system detected: $DISTRO_NAME, Version: $DISTRO_VERSION"

		# Check if the system is RHL based on /etc/os-release
		if grep -q "RHL" /etc/os-release; then
			export SYSTEMOS="RHL"
		fi

		# Check if dnf or yum is installed (dnf is used on newer systems, yum on older ones)
		if command -v dnf >/dev/null 2>&1; then
			echo "dnf is installed."
			export SYSTEMOS="RHL" # Set SYSTEMOS to RHL if dnf is detected
		elif command -v yum >/dev/null 2>&1; then
			echo "yum is installed."
			export SYSTEMOS="RHL" # Set SYSTEMOS to RHL if yum is detected
		else
			echo "No package manager (dnf or yum) found."
		fi
	else
		echo "Unable to detect the Linux distribution version."
	fi
fi

# Print the final detected OS
echo "Final operating system detected: $SYSTEMOS"

############################### Intel or GNU Compiler Option #############

# Only proceed with RHL-specific logic if the system is RHL
if [ "$SYSTEMOS" = "RHL" ]; then
	# Check for 32-bit RHL system
	if [ "$SYSTEMBIT" = "32" ]; then
		echo "Your system is not compatible with this script."
		exit
	fi

	# Check for 64-bit RHL system
	if [ "$SYSTEMBIT" = "64" ]; then
		echo "Your system is a 64-bit version of RHL Linux Kernel."

		# Check if RHL_64bit_Intel or RHL_64bit_GNU environment variables are set
		if [ -n "$RHL_64bit_Intel" ] || [ -n "$RHL_64bit_GNU" ]; then
			echo "The environment variable RHL_64bit_Intel/GNU is already set."
		else
			echo "The environment variable RHL_64bit_Intel/GNU is not set."

			# Prompt user to select a compiler (Intel or GNU)
			while read -r -p "Which compiler do you want to use?
                - Intel
                - GNU
                Please answer Intel or GNU and press enter (case-sensitive): " yn; do
				case $yn in
				Intel)
					echo "Intel is selected for installation."
					export RHL_64bit_Intel=1
					break
					;;
				GNU)
					echo "GNU is selected for installation."
					export RHL_64bit_GNU=1
					break
					;;
				*)
					echo "Please answer Intel or GNU (case-sensitive)."
					;;
				esac
			done
		fi

		# Check for the version of the GNU compiler (gcc)
		if [ -n "$RHL_64bit_GNU" ]; then
			export gcc_test_version=$(gcc -dumpversion 2>&1 | awk '{print $1}')
			export gcc_test_version_major=$(echo $gcc_test_version | awk -F. '{print $1}')
			export gcc_version_9="9"

			if [[ $gcc_test_version_major -lt $gcc_version_9 ]]; then
				export RHL_64bit_GNU=2
				echo "OLD GNU FILES FOUND."
				echo "RHL_64bit_GNU=$RHL_64bit_GNU"
			fi
		fi
	fi
fi

# Check for 64-bit Linux system (Debian/Ubuntu)
if [ "$SYSTEMBIT" = "64" ] && [ "$SYSTEMOS" = "Linux" ]; then
	echo "Your system is a 64-bit version of Debian Linux Kernel."
	echo ""

	# Check if Ubuntu_64bit_Intel or Ubuntu_64bit_GNU environment variables are set
	if [ -n "$Ubuntu_64bit_Intel" ] || [ -n "$Ubuntu_64bit_GNU" ]; then
		echo "The environment variable Ubuntu_64bit_Intel/GNU is already set."
	else
		echo "The environment variable Ubuntu_64bit_Intel/GNU is not set."

		# Prompt user to select a compiler (Intel or GNU)
		while read -r -p "Which compiler do you want to use?
            - Intel
            -- Please note that WRF_CMAQ is only compatible with GNU Compilers
            - GNU
            Please answer Intel or GNU and press enter (case-sensitive): " yn; do
			case $yn in
			Intel)
				echo "Intel is selected for installation."
				export Ubuntu_64bit_Intel=1
				break
				;;
			GNU)
				echo "GNU is selected for installation."
				export Ubuntu_64bit_GNU=1
				break
				;;
			*)
				echo "Please answer Intel or GNU (case-sensitive)."
				;;
			esac
		done
	fi
fi

# Check for 32-bit Linux system
if [ "$SYSTEMBIT" = "32" ] && [ "$SYSTEMOS" = "Linux" ]; then
	echo "Your system is not compatible with this script."
	exit
fi

############################# macOS Handling ##############################

# Check for 32-bit MacOS system
if [ "$SYSTEMBIT" = "32" ] && [ "$SYSTEMOS" = "MacOS" ]; then
	echo "Your system is not compatible with this script."
	exit
fi

# Check for 64-bit Intel-based MacOS system
if [ "$SYSTEMBIT" = "64" ] && [ "$SYSTEMOS" = "MacOS" ] && [ "$MAC_CHIP" = "Intel" ]; then
	echo "Your system is a 64-bit version of macOS with an Intel chip."
	echo "Intel compilers are not compatible with this script."
	echo "Setting compiler to GNU."
	export macos_64bit_GNU=1

	# Ensure Xcode Command Line Tools are installed
	if ! xcode-select --print-path &>/dev/null; then
		echo "Installing Xcode Command Line Tools..."
		xcode-select --install

		# Add a loop to wait for the installation to be completed
		echo "Waiting for Xcode Command Line Tools to install. Please follow the installer prompts..."
		while ! xcode-select --print-path &>/dev/null; do
			sleep 30 # Wait for 5 seconds before checking again
		done

		echo "Xcode Command Line Tools installation confirmed."
	fi

	# Install Homebrew for Intel Macs in /usr/local
	echo "Installing Homebrew..."
	/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

	echo 'eval "$(/usr/local/bin/brew shellenv)"' >>~/.profile
	eval "$(/usr/local/bin/brew shellenv)"

	chsh -s /bin/bash
fi

# Check for 64-bit ARM-based MacOS system (M1, M2 chips)
if [ "$SYSTEMBIT" = "64" ] && [ "$SYSTEMOS" = "MacOS" ] && [ "$MAC_CHIP" = "ARM" ]; then
	echo "Your system is a 64-bit version of macOS with an ARM chip (M1/M2)."
	echo "Intel compilers are not compatible with this script."
	echo "Setting compiler to GNU."
	export macos_64bit_GNU=1

	# Ensure Xcode Command Line Tools are installed
	if ! xcode-select --print-path &>/dev/null; then
		echo "Installing Xcode Command Line Tools..."
		xcode-select --install

		# Add a loop to wait for the installation to be completed
		echo "Waiting for Xcode Command Line Tools to install. Please follow the installer prompts..."
		while ! xcode-select --print-path &>/dev/null; do
			sleep 5 # Wait for 5 seconds before checking again
		done

		echo "Xcode Command Line Tools installation confirmed."
	fi

	# Install Homebrew for ARM Macs in /opt/homebrew
	echo "Installing Homebrew..."
	/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

	echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >>~/.profile
	eval "$(/opt/homebrew/bin/brew shellenv)"

	chsh -s /bin/bash
fi

################### System Information Tests ##############################

echo ""
echo "--------------------------------------------------"
echo "Testing for storage space for installation."

# Cross-platform disk space check (Linux + macOS)

HOME_DIR="${HOME}"
REQUIRED_GB=350
REQUIRED_KB=$((REQUIRED_GB * 1024 * 1024))   # 350 GB in KiB

# df -k prints sizes in 1K blocks on both GNU (Linux) and BSD (macOS)
AVAILABLE_KB=$(df -k "$HOME_DIR" | awk 'NR==2 {print $4}')

if [ -z "$AVAILABLE_KB" ]; then
    echo "ERROR: Could not determine available disk space for $HOME_DIR"
    exit 1
fi

# Human-readable strings (GiB)
AVAILABLE_HR=$(awk -v kb="$AVAILABLE_KB" 'BEGIN { printf "%.1f GiB", kb/1024/1024 }')
REQUIRED_HR=$(awk -v kb="$REQUIRED_KB" 'BEGIN { printf "%.1f GiB", kb/1024/1024 }')

if [ "$AVAILABLE_KB" -lt "$REQUIRED_KB" ]; then
    echo
    echo "############################################################"
    echo "Not enough free disk space in $HOME_DIR."
    echo "  Required:  $REQUIRED_HR"
    echo "  Available: $AVAILABLE_HR"
    echo "Please free up space and rerun this script."
    echo "############################################################"
    echo
    exit 1
else
    echo "Disk space check passed: $AVAILABLE_HR available (need at least $REQUIRED_HR)."
fi


echo "--------------------------------------------------"
############################# Enter sudo users information #############################
echo "-------------------------------------------------- "
while true; do
	# Prompt for the initial password
	read -r -s -p "
    Password is only saved locally and will not be seen when typing.
    Please enter your sudo password: " password1
	echo " "
	# Prompt for password verification
	read -r -s -p "Please re-enter your password to verify: " password2
	echo " "

	# Check if the passwords match
	if [ "$password1" = "$password2" ]; then
		export PASSWD=$password1
		echo "Password verified successfully."
		break
	else
		echo "Passwords do not match. Please enter the passwords again."
	fi
done

echo "Beginning Installation"

############################# Chose GrADS or OpenGrADS #########################
PS3="Enter your choice: "
options=("OpenGrADS" "GrADS")
select opt in "${options[@]}"; do
	case $opt in
	"OpenGrADS")
		echo -e "\nOpenGrADS selected for installation"
		export GRADS_PICK=1
		break
		;;
	"GrADS")
		echo -e "\nGrADS selected for installation"
		export GRADS_PICK=2
		break
		;;
	*)
		echo -e "\nInvalid option. Please select 1 or 2."
		;;
	esac
done

##################################### Auto Configuration Test ##################
PS3="Enter your choice (1 or 2): "

echo "Auto Configuration Check"
echo "Would you like the script to select all the configure options for you?"
echo "This will use Basic Nesting for WRF Configuration."

options=("Yes" "No")

select answer in "${options[@]}"; do
	case $answer in
	"Yes")
		export auto_config=1
		echo "Auto configuration enabled."
		break
		;;
	"No")
		export auto_config=0
		echo "Manual configuration selected."
		break
		;;
	*)
		echo "Invalid selection. Please try again."
		;;
	esac
done

echo ""

#!/bin/bash

################################# DTC MET Tools Test ##################
echo "NCAR's DTC MET Tools Install"
echo "Would you like the script to install NCAR's DTC Model Evaluation Tools?"
echo "Not available for MacOS at this time - Select NO"
PS3="Enter your choice (1 for Yes, 2 for No): "
options=("Yes" "No")
select answer in "${options[@]}"; do
	case $answer in
	"Yes")
		export DTC_MET=1
		echo "DTC MET Tools installation selected."
		break
		;;
	"No")
		export DTC_MET=0
		echo "Skipping DTC MET Tools installation."
		break
		;;
	*)
		echo "Invalid selection. Please choose 1 or 2."
		;;
	esac
done

echo ""

################################# GEOG WPS Geographical Input Data Mandatory for Specific Applications ##################
echo "--------------------------------------------------"
echo "Would you like to download the WPS Geographical Input Data for Specific Applications? (Optional)"
echo ""
echo "Specific Applications files can be viewed here:"
echo ""
printf '\e]8;;https://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html\e\\Specific GEOG Applications Website (right click to open link)\e]8;;\e\\\n'
echo ""
PS3="Enter your choice (1 for Yes, 2 for No): "
options=("Yes" "No")
select answer in "${options[@]}"; do
	case $answer in
	"Yes")
		export WPS_Specific_Applications=1
		echo "Downloading Specific Applications GEOG Data."
		break
		;;
	"No")
		export WPS_Specific_Applications=0
		echo "Skipping download of Specific Applications GEOG Data."
		break
		;;
	*)
		echo "Invalid selection. Please choose 1 or 2."
		;;
	esac
done

echo ""

################################# GEOG Optional WPS Geographical Input Data ##################
echo "--------------------------------------------------"
echo "Would you like to download the GEOG Optional WPS Geographical Input Data? (Optional)"
echo ""
echo "Optional Geographical files can be viewed here:"
echo ""
printf '\e]8;;https://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html\e\\Optional GEOG File Applications Website (right click to open link)\e]8;;\e\\\n'
echo ""
PS3="Enter your choice (1 for Yes, 2 for No): "
options=("Yes" "No")
select answer in "${options[@]}"; do
	case $answer in
	"Yes")
		export Optional_GEOG=1
		echo "Downloading Optional GEOG Data."
		break
		;;
	"No")
		export Optional_GEOG=0
		echo "Skipping download of Optional GEOG Data."
		break
		;;
	*)
		echo "Invalid selection. Please choose 1 or 2."
		;;
	esac
done

echo ""

############################## Choice for which version of WRF to Install ############
# Define colored message for CMAQ
CMAQ_MESSAGE="(Not available on MacOS....GNU Only)"
SFIRE_MESSAGE="(Not available with Intel Compilers....GNU Only)"
COAWST_MESSAGE="(Not available on MacOS....GNU Only)"

echo -e "Which version of WRF would you like to install?
1) WRF-ARW
2) WRFCHEM
3) WRFHYDRO_COUPLED
4) WRFHYDRO_STANDALONE
5) WRF_SFIRE $SFIRE_MESSAGE
6) WRF_CMAQ $CMAQ_MESSAGE
7) COAWST $COAWST_MESSAGE
"

PS3="Please enter the number corresponding to your choice: "


options=("WRF-ARW" "WRFCHEM" "WRFHYDRO_COUPLED" "WRFHYDRO_STANDALONE" "WRF_SFIRE" "WRF_CMAQ" "COAWST")

PS3="Please enter the number corresponding to your choice: "

select opt in "${options[@]}"; do
    case $opt in
        "WRF-ARW")
            echo "WRF-ARW selected for installation"
            export WRF_PICK=1
            break
            ;;
        "WRFCHEM")
            echo "WRFCHEM selected for installation"
            export WRFCHEM_PICK=1
            break
            ;;
        "WRFHYDRO_COUPLED")
            echo "WRFHYDRO_COUPLED selected for installation"
            export WRFHYDRO_COUPLED_PICK=1
            break
            ;;
        "WRFHYDRO_STANDALONE")
            echo "WRFHYDRO_STANDALONE selected for installation"
            export WRFHYDRO_STANDALONE_PICK=1
            break
            ;;
        "WRF_SFIRE")
            echo "WRF_SFIRE selected for installation"
            export SFIRE_PICK=1
            break
            ;;
        "WRF_CMAQ")
            echo -e "WRF_CMAQ selected for installation \nWRF_CMAQ is only compatible with GNU Compilers"
            export CMAQ_PICK=1
            break
            ;;
        "COAWST")
            echo "COAWST selected for installation"
            export COAWST_PICK=1     # fixed typo
            break
            ;;
        *)
            echo "Invalid option. Please select a number between 1 and ${#options[@]}."
            ;;
    esac
done


################################# WRF-CHEM Tools Test ##################
if [ "$WRFCHEM_PICK" = "1" ]; then
	echo "NCAR's WRF-CHEM Tools Install"
	echo "Would you like the script to install NCAR's WRF-CHEM Tools?"
	PS3="Enter your choice (1 for Yes, 2 for No): "
	options=("Yes" "No")
	select answer in "${options[@]}"; do
		case $answer in
		"Yes")
			export WRFCHEM_TOOLS=1
			echo "WRF-CHEM Tools installation selected."
			break
			;;
		"No")
			export WRFCHEM_TOOLS=0
			echo "Skipping WRF-CHEM Tools installation."
			break
			;;
		*)
			echo "Invalid selection. Please choose 1 or 2."
			;;
		esac
	done
fi

echo ""
############################ DTC's MET & METPLUS ##################################################

###################################################################################################

if [ "$Ubuntu_64bit_Intel" = "1" ] && [ "$DTC_MET" = "1" ]; then

	echo $PASSWD | sudo -S apt install git
	echo "MET INSTALLING"
	echo $PASSWD | sudo -S apt -y update
	echo $PASSWD | sudo -S apt -y upgrade

	# download the key to system keyring; this and the following echo command are
	# needed in order to install the Intel compilers
	wget -O- https://apt.repos.intel.com/intel-gpg-keys/GPG-PUB-KEY-INTEL-SW-PRODUCTS.PUB |
		gpg --dearmor | sudo tee /usr/share/keyrings/oneapi-archive-keyring.gpg >/dev/null

	# add signed entry to apt sources and configure the APT client to use Intel repository:
	echo "deb [signed-by=/usr/share/keyrings/oneapi-archive-keyring.gpg] https://apt.repos.intel.com/oneapi all main" | sudo tee /etc/apt/sources.list.d/oneAPI.list

	# this update should get the Intel package info from the Intel repository
	echo $PASSWD | sudo -S apt -y update
	echo $PASSWD | sudo -S apt -y upgrade

	release_version=$(lsb_release -r -s)

	# Compare the release version
	if [ "$release_version" = "24.04" ]; then
		# Install Emacs without recommended packages
		echo $PASSWD | sudo -S apt install emacs --no-install-recommends -y
	else
		# Attempt to install Emacs if the release version is not 24.04
		echo "The release version is not 24.04, attempting to install Emacs."
		echo $PASSWD | sudo -S apt install emacs -y
	fi

	echo $PASSWD | sudo -S apt -y install -y bison build-essential cmake curl flex gfortran ghostscript git less libbz2-dev libc6-dev libcurl4-gnutls-dev libffi-dev libgdbm-dev libjpeg-dev libncursesw5-dev libopenblas-dev libpixman-1-dev libreadline-dev libssl-dev libtiff-dev m4 tk-dev unzip vim wget
	#
	# install the Intel compilers
	echo $PASSWD | sudo -S apt -y install intel-basekit
	echo $PASSWD | sudo -S apt -y install intel-hpckit
	echo $PASSWD | sudo -S apt -y install intel-oneapi-python
	/opt/intel/oneapi/intelpython/python3.12/bin/python3 -m pip install python-dateutil

	echo $PASSWD | sudo -S apt -y update

	# make sure some critical packages have been installed
	which cmake pkg-config make gcc g++ gfortran

	# add the Intel compiler file paths to various environment variables
	source /opt/intel/oneapi/setvars.sh --force

	# some of the libraries we install below need one or more of these variables
	export CC=icx
	export CXX=icpx
	export FC=ifx
	export F77=ifx
	export F90=ifx
	export MPIFC=mpiifx
	export MPIF77=mpiifx
	export MPIF90=mpiifx
	export MPICC=mpiicx
	export MPICXX=mpiicpx
	export CFLAGS="-fPIC -fPIE -O3 -Wno-implicit-function-declaration -Wno-incompatible-function-pointer-types -Wno-unused-command-line-argument"
	export FFLAGS="-m64"
	export FCFLAGS="-m64"
	export CXXFLAGS="-Wall -DHAVE_ISATTY"
	#########################

	#Downloading latest dateutil due to python3.8 running old version.
	pip3 install python-dateutil==2.8 --break-system-packages
	pip3 install python-dateutil

	# Set WRF_FOLDER based on selected option
	if [ "$WRFCHEM_PICK" = "1" ]; then
		export WRF_FOLDER="$HOME/WRFCHEM_Intel"
	elif [ "$WRFHYDRO_COUPLED_PICK" = "1" ]; then
		export WRF_FOLDER="$HOME/WRFHYDRO_COUPLED_Intel"
	elif [ "$WRF_PICK" = "1" ]; then
		export WRF_FOLDER="$HOME/WRF_Intel"
	elif [ "$SFIRE_PICK" = "1" ]; then
		export WRF_FOLDER="$HOME/WRF_SFIRE_Intel"
	else
		export WRF_FOLDER="$HOME/DTC_Intel"
	fi

	mkdir -p "$WRF_FOLDER"
	mkdir "${WRF_FOLDER}"/MET-$met_Version_number
	mkdir "${WRF_FOLDER}"/MET-$met_Version_number/Downloads
	mkdir "${WRF_FOLDER}"/METplus-$METPLUS_Version
	mkdir "${WRF_FOLDER}"/METplus-$METPLUS_Version/Downloads

	#Downloading MET and untarring files
	#Note weblinks change often update as needed.
	cd "${WRF_FOLDER}"/MET-$met_Version_number/Downloads
	wget -c https://raw.githubusercontent.com/dtcenter/MET/main_v$met_VERSION_number/internal/scripts/installation/compile_MET_all.sh

	wget -c https://dtcenter.ucar.edu/dfiles/code/METplus/MET/installation/tar_files.met-v$met_VERSION_number.tgz

	wget -c https://github.com/dtcenter/MET/archive/refs/tags/v$met_Version_number.tar.gz

	cp compile_MET_all.sh "${WRF_FOLDER}"/MET-$met_Version_number
	LD_LIBRARY_PATH= tar -xvzf tar_files.met-v$met_VERSION_number.tgz -C "${WRF_FOLDER}"/MET-$met_Version_number
	cp v$met_Version_number.tar.gz "${WRF_FOLDER}"/MET-$met_Version_number/tar_files
	cd "${WRF_FOLDER}"/MET-$met_Version_number

	cd "${WRF_FOLDER}"/MET-$met_Version_number

	export PYTHON_VERSION=$(/opt/intel/oneapi/intelpython/latest/bin/python3 -V 2>&1 | awk '{print $2}')
	export PYTHON_VERSION_MAJOR_VERSION=$(echo "$PYTHON_VERSION" | awk -F. '{print $1}')
	export PYTHON_VERSION_MINOR_VERSION=$(echo "$PYTHON_VERSION" | awk -F. '{print $2}')
	export PYTHON_VERSION_COMBINED="$PYTHON_VERSION_MAJOR_VERSION.$PYTHON_VERSION_MINOR_VERSION"

	echo "PYTHON_VERSION:               $PYTHON_VERSION"
	echo "PYTHON_VERSION_MAJOR_VERSION: $PYTHON_VERSION_MAJOR_VERSION"
	echo "PYTHON_VERSION_MINOR_VERSION: $PYTHON_VERSION_MINOR_VERSION"
	echo "PYTHON_VERSION_COMBINED:      $PYTHON_VERSION_COMBINED"

	# --- GCC/ICX version extraction ---
	export GCC_VERSION=$(icx -dumpversion)
	export GCC_VERSION_MAJOR_VERSION=$(echo "$GCC_VERSION" | awk -F. '{print $1}')
	export GCC_VERSION_MINOR_VERSION=$(echo "$GCC_VERSION" | awk -F. '{print $2}')
	export GCC_VERSION_SUB_VERSION=$(echo "$GCC_VERSION" | awk -F. '{print $3}' | sed 's/[^0-9]*//g')
	export GCC_VERSION_COMBINED="$GCC_VERSION_MAJOR_VERSION.$GCC_VERSION_MINOR_VERSION.$GCC_VERSION_SUB_VERSION"

	echo "GCC_VERSION:                  $GCC_VERSION"
	echo "GCC_VERSION_MAJOR_VERSION:    $GCC_VERSION_MAJOR_VERSION"
	echo "GCC_VERSION_MINOR_VERSION:    $GCC_VERSION_MINOR_VERSION"
	echo "GCC_VERSION_SUB_VERSION:      $GCC_VERSION_SUB_VERSION"
	echo "GCC_VERSION_COMBINED:         $GCC_VERSION_COMBINED"

	export CC=icx
	export CXX=icpx
	export FC=ifx
	export F77=ifx
	export F90=ifx
	export gcc_version=$GCC_VERSION
	export TEST_BASE="${WRF_FOLDER}"/MET-$met_Version_number
	export COMPILER=intel_$GCC_VERSION_COMBINED
	export MET_SUBDIR=${TEST_BASE}
	export MET_TARBALL=v$met_Version_number.tar.gz
	export USE_MODULES=FALSE
	export MET_PYTHON=/opt/intel/oneapi/intelpython/python${PYTHON_VERSION_COMBINED}
	export MET_PYTHON_CC="-I ${MET_PYTHON}/include/python${PYTHON_VERSION_COMBINED}"
	export MET_PYTHON_LD="-L${MET_PYTHON}/lib/python${PYTHON_VERSION_COMBINED}/config-${PYTHON_VERSION_COMBINED}-x86_64-linux-gnu -L${MET_PYTHON}/lib -lpython${PYTHON_VERSION_COMBINED} -lpthread -ldl -lutil -lm"
	export SET_D64BIT=FALSE

	export CPU_CORE=$(nproc) # number of available threads on system
	export CPU_6CORE="6"
	export CPU_QUARTER=$(($CPU_CORE / 4))                          #quarter of availble cores on system
	export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2))) #Forces CPU cores to even number to avoid partial core export. ie 7 cores would be 3.5 cores.

	if [ $CPU_CORE -le $CPU_6CORE ]; then #If statement for low core systems.  Forces computers to only use 1 core if there are 4 cores or less on the system.
		export CPU_QUARTER_EVEN="2"
	else
		export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))
	fi

	echo "##########################################"
	echo "Number of Threads being used $CPU_QUARTER_EVEN"
	echo "##########################################"

	echo " "

	export MAKE_ARGS="-j $CPU_QUARTER_EVEN"

	chmod 775 compile_MET_all.sh

	time ./compile_MET_all.sh 2>&1 | tee compile_MET_all.log

	export PATH="${WRF_FOLDER}"/MET-$met_Version_number/bin:$PATH #Add MET executables to path

	#Basic Package Management for Model Evaluation Tools (METplus)

	echo $PASSWD | sudo -S apt -y update
	echo $PASSWD | sudo -S apt -y upgrade

	#Directory Listings for Model Evaluation Tools (METplus

	mkdir "${WRF_FOLDER}"/METplus-$METPLUS_Version
	mkdir "${WRF_FOLDER}"/METplus-$METPLUS_Version/Sample_Data
	mkdir "${WRF_FOLDER}"/METplus-$METPLUS_Version/Output
	mkdir "${WRF_FOLDER}"/METplus-$METPLUS_Version/Downloads

	#Downloading METplus and untarring files

	cd "${WRF_FOLDER}"/METplus-$METPLUS_Version/Downloads
	wget -c https://github.com/dtcenter/METplus/archive/refs/tags/v$METPLUS_Version.tar.gz
	LD_LIBRARY_PATH= tar -xvzf v$METPLUS_Version.tar.gz -C "${WRF_FOLDER}"

	# Insatlllation of Model Evaluation Tools Plus
	cd "${WRF_FOLDER}"/METplus-$METPLUS_Version/parm/metplus_config

	sed -i "s|MET_INSTALL_DIR = /path/to|MET_INSTALL_DIR = "${WRF_FOLDER}"/MET-$met_Version_number|" defaults.conf
	sed -i "s|INPUT_BASE = /path/to|INPUT_BASE = "${WRF_FOLDER}"/METplus-$METPLUS_Version/Sample_Data|" defaults.conf
	sed -i "s|OUTPUT_BASE = /path/to|OUTPUT_BASE = "${WRF_FOLDER}"/METplus-$METPLUS_Version/Output|" defaults.conf

	# Downloading Sample Data

	cd "${WRF_FOLDER}"/METplus-$METPLUS_Version/Downloads
	wget -c https://dtcenter.ucar.edu/dfiles/code/METplus/METplus_Data/v$METPLUS_DATA/sample_data-met_tool_wrapper.tgz
	LD_LIBRARY_PATH= tar -xvzf sample_data-met_tool_wrapper.tgz -C "${WRF_FOLDER}"/METplus-$METPLUS_Version/Sample_Data

	# Testing if installation of MET & METPlus was sucessfull
	# If you see in terminal "METplus has successfully finished running."
	# Then MET & METPLUS is sucessfully installed

	echo 'Testing MET & METPLUS Installation.'
	$WRF_FOLDER/METplus-$METPLUS_Version/ush/run_metplus.py -c $WRF_FOLDER/METplus-$METPLUS_Version/parm/use_cases/met_tool_wrapper/GridStat/GridStat.conf

	# Check if the previous command was successful
	if [ $? -eq 0 ]; then
		echo " "
		echo "MET and METPLUS successfully installed with GNU compilers."
		echo " "
		export PATH=$WRF_FOLDER/METplus-$METPLUS_Version/ush:$PATH
	else
		echo " "
		echo "Error: MET and METPLUS installation failed."
		echo " "
		# Handle the error case, e.g., exit the script or retry installation
		exit 1
	fi
fi

if [ "$Ubuntu_64bit_GNU" = "1" ] && [ "$DTC_MET" = "1" ]; then

	echo $PASSWD | sudo -S apt install git
	echo "MET INSTALLING"
	export HOME=$(
		cd
		pwd
	)
	#Basic Package Management for Model Evaluation Tools (MET)

	#############################basic package managment############################
	echo $PASSWD | sudo -S apt -y update
	echo $PASSWD | sudo -S apt -y upgrade

	release_version=$(lsb_release -r -s)

	# Compare the release version
	if [ "$release_version" = "24.04" ]; then
		# Install Emacs without recommended packages
		echo $PASSWD | sudo -S apt install emacs --no-install-recommends -y
	else
		# Attempt to install Emacs if the release version is not 24.04
		echo "The release version is not 24.04, attempting to install Emacs."
		echo $PASSWD | sudo -S apt install emacs -y
	fi

	echo $PASSWD | sudo -S apt -y install -y bison build-essential cmake curl flex gfortran ghostscript git less libbz2-dev libc6-dev libcurl4-gnutls-dev libffi-dev libgdbm-dev libjpeg-dev libncursesw5-dev libopenblas-dev libpixman-1-dev libreadline-dev libssl-dev libtiff-dev m4 tk-dev unzip vim wget

	#Downloading latest dateutil due to python3.8 running old version.
	echo $PASSWD | sudo -S apt -y install python3-dateutil

	# Set WRF_FOLDER based on selected option
	if [ "$WRFCHEM_PICK" = "1" ]; then
		WRF_FOLDER="$HOME/WRFCHEM"
	elif [ "$WRFHYDRO_COUPLED_PICK" = "1" ]; then
		WRF_FOLDER="$HOME/WRFHYDRO_COUPLED"
	elif [ "$WRFHYDRO_STANDALONE_PICK" = "1" ]; then
		WRF_FOLDER="$HOME/WRFHYDRO_STANDALONE"
	elif [ "$WRF_PICK" = "1" ]; then
		WRF_FOLDER="$HOME/WRF"
	elif [ "$CMAQ_PICK" = "1" ]; then
		WRF_FOLDER="$HOME/WRF_CMAQ"
	elif [ "$SFIRE_PICK" = "1" ]; then
		WRF_FOLDER="$HOME/WRF_SFIRE"
	else
		WRF_FOLDER="$HOME/DTC"
	fi

	mkdir -p "$WRF_FOLDER"
	export WRF_FOLDER
	mkdir "${WRF_FOLDER}"/MET-$met_Version_number
	mkdir "${WRF_FOLDER}"/MET-$met_Version_number/Downloads
	mkdir "${WRF_FOLDER}"/METplus-$METPLUS_Version
	mkdir "${WRF_FOLDER}"/METplus-$METPLUS_Version/Downloads

	#Downloading MET and untarring files
	#Note weblinks change often update as needed.
	cd "${WRF_FOLDER}"/MET-$met_Version_number/Downloads

	wget -c https://raw.githubusercontent.com/dtcenter/MET/main_v$met_VERSION_number/internal/scripts/installation/compile_MET_all.sh

	wget -c https://dtcenter.ucar.edu/dfiles/code/METplus/MET/installation/tar_files.met-v$met_VERSION_number.tgz

	wget -c https://github.com/dtcenter/MET/archive/refs/tags/v$met_Version_number.tar.gz

	cp compile_MET_all.sh "${WRF_FOLDER}"/MET-$met_Version_number
	LD_LIBRARY_PATH= tar -xvzf tar_files.met-v$met_VERSION_number.tgz -C "${WRF_FOLDER}"/MET-$met_Version_number
	cp v$met_Version_number.tar.gz "${WRF_FOLDER}"/MET-$met_Version_number/tar_files
	cd "${WRF_FOLDER}"/MET-$met_Version_number

	# Installation of Model Evaluation Tools
	export CC=gcc
	export CXX=g++
	export FC=gfortran
	export F77=gfortran
	export CFLAGS="-fPIC -fPIE -O3"

	cd "${WRF_FOLDER}"/MET-$met_Version_number
	export GCC_VERSION=$(gcc -dumpfullversion | awk '{print$1}')
	export GFORTRAN_VERSION=$(gfortran -dumpfullversion | awk '{print$1}')
	export GPLUSPLUS_VERSION=$(g++ -dumpfullversion | awk '{print$1}')

	export GCC_VERSION_MAJOR_VERSION=$(echo $GCC_VERSION | awk -F. '{print $1}')
	export GFORTRAN_VERSION_MAJOR_VERSION=$(echo $GFORTRAN_VERSION | awk -F. '{print $1}')
	export GPLUSPLUS_VERSION_MAJOR_VERSION=$(echo $GPLUSPLUS_VERSION | awk -F. '{print $1}')

	export version_10="10"

	export PYTHON_VERSION=$(/usr/bin/python3 -V 2>&1 | awk '{print $2}')
	export PYTHON_VERSION_MAJOR_VERSION=$(echo $PYTHON_VERSION | awk -F. '{print $1}')
	export PYTHON_VERSION_MINOR_VERSION=$(echo $PYTHON_VERSION | awk -F. '{print $2}')
	export PYTHON_VERSION_COMBINED=$PYTHON_VERSION_MAJOR_VERSION.$PYTHON_VERSION_MINOR_VERSION

	echo "PYTHON_VERSION:               $PYTHON_VERSION"
	echo "PYTHON_VERSION_MAJOR_VERSION: $PYTHON_VERSION_MAJOR_VERSION"
	echo "PYTHON_VERSION_MINOR_VERSION: $PYTHON_VERSION_MINOR_VERSION"
	echo "PYTHON_VERSION_COMBINED:      $PYTHON_VERSION_COMBINED"

	# --- GCC/ version extraction ---
	export GCC_VERSION=$(gcc -dumpfullversion)
	export GCC_VERSION_MAJOR_VERSION=$(echo "$GCC_VERSION" | awk -F. '{print $1}')
	export GCC_VERSION_MINOR_VERSION=$(echo "$GCC_VERSION" | awk -F. '{print $2}')
	export GCC_VERSION_SUB_VERSION=$(echo "$GCC_VERSION" | awk -F. '{print $3}' | sed 's/[^0-9]*//g')
	export GCC_VERSION_COMBINED="$GCC_VERSION_MAJOR_VERSION.$GCC_VERSION_MINOR_VERSION.$GCC_VERSION_SUB_VERSION"

	echo "GCC_VERSION:                  $GCC_VERSION"
	echo "GCC_VERSION_MAJOR_VERSION:    $GCC_VERSION_MAJOR_VERSION"
	echo "GCC_VERSION_MINOR_VERSION:    $GCC_VERSION_MINOR_VERSION"
	echo "GCC_VERSION_SUB_VERSION:      $GCC_VERSION_SUB_VERSION"
	echo "GCC_VERSION_COMBINED:         $GCC_VERSION_COMBINED"

	export FC=/usr/bin/gfortran
	export F77=/usr/bin/gfortran
	export F90=/usr/bin/gfortran
	export gcc_version=$GCC_VERSION
	export TEST_BASE="${WRF_FOLDER}"/MET-$met_Version_number
	export COMPILER=gnu_$GCC_VERSION_COMBINED
	export MET_SUBDIR=${TEST_BASE}
	export MET_TARBALL=v$met_Version_number.tar.gz
	export USE_MODULES=FALSE
	export MET_PYTHON=/usr
	export MET_PYTHON_CC="-I${MET_PYTHON}/include/python${PYTHON_VERSION_COMBINED}"
	export MET_PYTHON_LD="$(python3-config --ldflags) -L${MET_PYTHON}/lib -lpython${PYTHON_VERSION_COMBINED}"
	export SET_D64BIT=FALSE

	export CPU_CORE=$(nproc) # number of available threads on system
	export CPU_6CORE="6"
	export CPU_QUARTER=$(($CPU_CORE / 4))                          #quarter of availble cores on system
	export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2))) #Forces CPU cores to even number to avoid partial core export. ie 7 cores would be 3.5 cores.

	if [ $CPU_CORE -le $CPU_6CORE ]; then #If statement for low core systems.  Forces computers to only use 1 core if there are 4 cores or less on the system.
		export CPU_QUARTER_EVEN="2"
	else
		export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))
	fi

	echo "##########################################"
	echo "Number of Threads being used $CPU_QUARTER_EVEN"
	echo "##########################################"

	echo " "

	export MAKE_ARGS="-j $CPU_QUARTER_EVEN"

	chmod 775 compile_MET_all.sh

	time ./compile_MET_all.sh 2>&1 | tee compile_MET_all.log

	export PATH="${WRF_FOLDER}"/MET-$met_Version_number/bin:$PATH

	#basic Package Management for Model Evaluation Tools (METplus)

	echo $PASSWD | sudo -S apt -y update
	echo $PASSWD | sudo -S apt -y upgrade

	#Directory Listings for Model Evaluation Tools (METplus

	mkdir "${WRF_FOLDER}"/METplus-$METPLUS_Version
	mkdir "${WRF_FOLDER}"/METplus-$METPLUS_Version/Sample_Data
	mkdir "${WRF_FOLDER}"/METplus-$METPLUS_Version/Output
	mkdir "${WRF_FOLDER}"/METplus-$METPLUS_Version/Downloads

	#Downloading METplus and untarring files

	cd "${WRF_FOLDER}"/METplus-$METPLUS_Version/Downloads
	wget -c https://github.com/dtcenter/METplus/archive/refs/tags/v$METPLUS_Version.tar.gz
	LD_LIBRARY_PATH= tar -xvzf v$METPLUS_Version.tar.gz -C "${WRF_FOLDER}"

	# Insatlllation of Model Evaluation Tools Plus
	cd "${WRF_FOLDER}"/METplus-$METPLUS_Version/parm/metplus_config

	sed -i "s|MET_INSTALL_DIR = /path/to|MET_INSTALL_DIR = "${WRF_FOLDER}"/MET-$met_Version_number|" defaults.conf
	sed -i "s|INPUT_BASE = /path/to|INPUT_BASE = "${WRF_FOLDER}"/METplus-$METPLUS_Version/Sample_Data|" defaults.conf
	sed -i "s|OUTPUT_BASE = /path/to|OUTPUT_BASE = "${WRF_FOLDER}"/METplus-$METPLUS_Version/Output|" defaults.conf

	# Downloading Sample Data

	cd "${WRF_FOLDER}"/METplus-$METPLUS_Version/Downloads
	wget -c https://dtcenter.ucar.edu/dfiles/code/METplus/METplus_Data/v$METPLUS_DATA/sample_data-met_tool_wrapper.tgz
	LD_LIBRARY_PATH= tar -xvzf sample_data-met_tool_wrapper.tgz -C "${WRF_FOLDER}"/METplus-$METPLUS_Version/Sample_Data

	# Testing if installation of MET & METPlus was sucessfull
	# If you see in terminal "METplus has successfully finished running."
	# Then MET & METPLUS is sucessfully installed

	echo 'Testing MET & METPLUS Installation.'
	$WRF_FOLDER/METplus-$METPLUS_Version/ush/run_metplus.py -c $WRF_FOLDER/METplus-$METPLUS_Version/parm/use_cases/met_tool_wrapper/GridStat/GridStat.conf

	# Check if the previous command was successful
	if [ $? -eq 0 ]; then
		echo " "
		echo "MET and METPLUS successfully installed with GNU compilers."
		echo " "
		export PATH=$WRF_FOLDER/METplus-$METPLUS_Version/ush:$PATH
	else
		echo " "
		echo "Error: MET and METPLUS installation failed."
		echo " "
		# Handle the error case, e.g., exit the script or retry installation
		exit 1
	fi
fi

if [ "$RHL_64bit_GNU" = "1" ] && [ "$DTC_MET" = "1" ]; then
	export HOME=$(
		cd
		pwd
	)

	echo $PASSWD | sudo -S dnf install git

	#Basic Package Management for Model Evaluation Tools (MET)
	echo $PASSWD | sudo -S yum install epel-release -y
	echo $PASSWD | sudo -S yum install dnf -y
	echo $PASSWD | sudo -S dnf install epel-release -y
	echo $PASSWD | sudo -S dnf -y update
	echo $PASSWD | sudo -S dnf -y upgrade
	echo $PASSWD | sudo -S dnf -y install bzip2 bzip2-devel byacc cairo-devel cmake cpp curl curl-devel flex fontconfig-devel fontconfig-devel gcc gcc-c++ gcc-gfortran git java-11-openjdk java-11-openjdk-devel ksh libX11-devel libX11-devel libXaw libXaw-devel libXext-devel libXext-devel libXmu-devel libXrender-devel libXrender-devel libstdc++ libstdc++-devel libxml2 libxml2-devel m4 nfs-utils perl "perl(XML::LibXML)" pkgconfig pixman-devel python3 python3-devel tcsh time unzip wget
	echo $PASSWD | sudo -S dnf -y install python3-dateutil
	echo $PASSWD | sudo -S dnf -y groupinstall "Development Tools"
	echo $PASSWD | sudo -S dnf -y update
	echo $PASSWD | sudo -S dnf -y upgrade
	echo " "

	# Set WRF_FOLDER based on selected option
	if [ "$WRFCHEM_PICK" = "1" ]; then
		WRF_FOLDER="$HOME/WRFCHEM"
	elif [ "$WRFHYDRO_COUPLED_PICK" = "1" ]; then
		WRF_FOLDER="$HOME/WRFHYDRO_COUPLED"
	elif [ "$WRFHYDRO_STANDALONE_PICK" = "1" ]; then
		WRF_FOLDER="$HOME/WRFHYDRO_STANDALONE"
	elif [ "$WRF_PICK" = "1" ]; then
		WRF_FOLDER="$HOME/WRF"
	elif [ "$CMAQ_PICK" = "1" ]; then
		WRF_FOLDER="$HOME/WRF_CMAQ"
	elif [ "$SFIRE_PICK" = "1" ]; then
		WRF_FOLDER="$HOME/WRF_SFIRE"
	else
		WRF_FOLDER="$HOME/DTC"
	fi

	mkdir -p "$WRF_FOLDER"
	export WRF_FOLDER

	mkdir "${WRF_FOLDER}"/MET-$met_Version_number
	mkdir "${WRF_FOLDER}"/MET-$met_Version_number/Downloads
	mkdir "${WRF_FOLDER}"/METplus-$METPLUS_Version
	mkdir "${WRF_FOLDER}"/METplus-$METPLUS_Version/Downloads

	#Downloading MET and untarring files
	#Note weblinks change often update as needed.
	cd "${WRF_FOLDER}"/MET-$met_Version_number/Downloads

	wget -c https://raw.githubusercontent.com/dtcenter/MET/main_v$met_VERSION_number/internal/scripts/installation/compile_MET_all.sh

	wget -c https://dtcenter.ucar.edu/dfiles/code/METplus/MET/installation/tar_files.met-v$met_VERSION_number.tgz

	wget -c https://github.com/dtcenter/MET/archive/refs/tags/v$met_Version_number.tar.gz

	cp compile_MET_all.sh "${WRF_FOLDER}"/MET-$met_Version_number
	LD_LIBRARY_PATH= tar -xvzf tar_files.met-v$met_VERSION_number.tgz -C "${WRF_FOLDER}"/MET-$met_Version_number
	cp v$met_Version_number.tar.gz "${WRF_FOLDER}"/MET-$met_Version_number/tar_files
	cd "${WRF_FOLDER}"/MET-$met_Version_number

	# Installation of Model Evaluation Tools

	cd "${WRF_FOLDER}"/MET-$met_Version_number

	export PYTHON_VERSION=$(/usr/bin/python3 -V 2>&1 | awk '{print $2}')
	export PYTHON_VERSION_MAJOR_VERSION=$(echo $PYTHON_VERSION | awk -F. '{print $1}')
	export PYTHON_VERSION_MINOR_VERSION=$(echo $PYTHON_VERSION | awk -F. '{print $2}')
	export PYTHON_VERSION_COMBINED=$PYTHON_VERSION_MAJOR_VERSION.$PYTHON_VERSION_MINOR_VERSION

	echo "PYTHON_VERSION:               $PYTHON_VERSION"
	echo "PYTHON_VERSION_MAJOR_VERSION: $PYTHON_VERSION_MAJOR_VERSION"
	echo "PYTHON_VERSION_MINOR_VERSION: $PYTHON_VERSION_MINOR_VERSION"
	echo "PYTHON_VERSION_COMBINED:      $PYTHON_VERSION_COMBINED"

	# --- GCC/ version extraction ---
	export GCC_VERSION=$(gcc -dumpfullversion)
	export GCC_VERSION_MAJOR_VERSION=$(echo "$GCC_VERSION" | awk -F. '{print $1}')
	export GCC_VERSION_MINOR_VERSION=$(echo "$GCC_VERSION" | awk -F. '{print $2}')
	export GCC_VERSION_SUB_VERSION=$(echo "$GCC_VERSION" | awk -F. '{print $3}' | sed 's/[^0-9]*//g')
	export GCC_VERSION_COMBINED="$GCC_VERSION_MAJOR_VERSION.$GCC_VERSION_MINOR_VERSION.$GCC_VERSION_SUB_VERSION"

	echo "GCC_VERSION:                  $GCC_VERSION"
	echo "GCC_VERSION_MAJOR_VERSION:    $GCC_VERSION_MAJOR_VERSION"
	echo "GCC_VERSION_MINOR_VERSION:    $GCC_VERSION_MINOR_VERSION"
	echo "GCC_VERSION_SUB_VERSION:      $GCC_VERSION_SUB_VERSION"
	echo "GCC_VERSION_COMBINED:         $GCC_VERSION_COMBINED"

	export CC=gcc
	export CXX=g++
	export CFLAGS="-fPIC -fPIE -O3"
	export FC=gfortran
	export F77=gfortran
	export F90=gfortran
	export gcc_version=$GCC_VERSION
	export TEST_BASE="${WRF_FOLDER}"/MET-$met_Version_number
	export COMPILER=gnu_$GCC_VERSION_COMBINED
	export MET_SUBDIR=${TEST_BASE}
	export MET_TARBALL=v$met_Version_number.tar.gz
	export USE_MODULES=FALSE
	export MET_PYTHON=/usr
	export MET_PYTHON_CC="-I${MET_PYTHON}/include/python${PYTHON_VERSION_COMBINED}"
	export MET_PYTHON_LD="$(python3-config --ldflags) -L${MET_PYTHON}/lib -lpython${PYTHON_VERSION_COMBINED}"
	export SET_D64BIT=FALSE

	echo "CC=$CC"
	echo "CXX=$CXX"
	echo "FC=$FC"
	echo "F77=$F77"
	echo "F90=$F90"
	echo "gcc_version=$gcc_version"
	echo "TEST_BASE=$TEST_BASE"
	echo "COMPILER=$COMPILER"
	echo "MET_SUBDIR=$MET_SUBDIR"
	echo "MET_TARBALL=$MET_TARBALL"
	echo "USE_MODULES=$USE_MODULES"
	echo "MET_PYTHON=$MET_PYTHON"
	echo "MET_PYTHON_CC=$MET_PYTHON_CC"
	echo "MET_PYTHON_LD=$MET_PYTHON_LD"
	echo "SET_D64BIT=$SET_D64BIT"

	export CPU_CORE=$(nproc) # number of available threads on system
	export CPU_6CORE="6"
	export CPU_QUARTER=$(($CPU_CORE / 4))                          #quarter of availble cores on system
	export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2))) #Forces CPU cores to even number to avoid partial core export. ie 7 cores would be 3.5 cores.

	if [ $CPU_CORE -le $CPU_6CORE ]; then #If statement for low core systems.  Forces computers to only use 1 core if there are 4 cores or less on the system.
		export CPU_QUARTER_EVEN="2"
	else
		export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))
	fi

	echo "##########################################"
	echo "Number of Threads being used $CPU_QUARTER_EVEN"
	echo "##########################################"

	echo " "

	export MAKE_ARGS="-j $CPU_QUARTER_EVEN"

	chmod 775 compile_MET_all.sh

	time ./compile_MET_all.sh 2>&1 | tee compile_MET_all.log

	export PATH="${WRF_FOLDER}"/MET-$met_Version_number/bin:$PATH

	#basic Package Management for Model Evaluation Tools (METplus)

	echo $PASSWD | sudo -S dnf -y update
	echo $PASSWD | sudo -S dnf -y upgrade

	#Directory Listings for Model Evaluation Tools (METplus

	mkdir "${WRF_FOLDER}"/METplus-$METPLUS_Version
	mkdir "${WRF_FOLDER}"/METplus-$METPLUS_Version/Sample_Data
	mkdir "${WRF_FOLDER}"/METplus-$METPLUS_Version/Output
	mkdir "${WRF_FOLDER}"/METplus-$METPLUS_Version/Downloads

	#Downloading METplus and untarring files

	cd "${WRF_FOLDER}"/METplus-$METPLUS_Version/Downloads
	wget -c https://github.com/dtcenter/METplus/archive/refs/tags/v$METPLUS_Version.tar.gz
	LD_LIBRARY_PATH= tar -xvzf v$METPLUS_Version.tar.gz -C "${WRF_FOLDER}"

	# Insatlllation of Model Evaluation Tools Plus
	cd "${WRF_FOLDER}"/METplus-$METPLUS_Version/parm/metplus_config

	sed -i "s|MET_INSTALL_DIR = /path/to|MET_INSTALL_DIR = "${WRF_FOLDER}"/MET-$met_Version_number|" defaults.conf
	sed -i "s|INPUT_BASE = /path/to|INPUT_BASE = "${WRF_FOLDER}"/METplus-$METPLUS_Version/Sample_Data|" defaults.conf
	sed -i "s|OUTPUT_BASE = /path/to|OUTPUT_BASE = "${WRF_FOLDER}"/METplus-$METPLUS_Version/Output|" defaults.conf

	# Downloading Sample Data

	cd "${WRF_FOLDER}"/METplus-$METPLUS_Version/Downloads
	wget -c https://dtcenter.ucar.edu/dfiles/code/METplus/METplus_Data/v$METPLUS_DATA/sample_data-met_tool_wrapper.tgz
	LD_LIBRARY_PATH= tar -xvzf sample_data-met_tool_wrapper.tgz -C "${WRF_FOLDER}"/METplus-$METPLUS_Version/Sample_Data

	# Testing if installation of MET & METPlus was sucessfull
	# If you see in terminal "METplus has successfully finished running."
	# Then MET & METPLUS is sucessfully installed

	echo 'Testing MET & METPLUS Installation.'
	$WRF_FOLDER/METplus-$METPLUS_Version/ush/run_metplus.py -c $WRF_FOLDER/METplus-$METPLUS_Version/parm/use_cases/met_tool_wrapper/GridStat/GridStat.conf

	# Check if the previous command was successful
	if [ $? -eq 0 ]; then
		echo " "
		echo "MET and METPLUS successfully installed with GNU compilers."
		echo " "
		export PATH=$WRF_FOLDER/METplus-$METPLUS_Version/ush:$PATH
	else
		echo " "
		echo "Error: MET and METPLUS installation failed."
		echo " "
		# Handle the error case, e.g., exit the script or retry installation
		exit 1
	fi
fi

if [ "$RHL_64bit_GNU" = "2" ] && [ "$DTC_MET" = "1" ]; then

	echo $PASSWD | sudo -S dnf install git

	echo "MET INSTALLING"
	export HOME=$(
		cd
		pwd
	)

	#Basic Package Management for Model Evaluation Tools (MET)

	echo $PASSWD | sudo -S yum install epel-release -y
	echo $PASSWD | sudo -S yum install dnf -y
	echo $PASSWD | sudo -S dnf install epel-release -y
	echo $PASSWD | sudo -S dnf -y update
	echo $PASSWD | sudo -S dnf -y upgrade
	echo $PASSWD | sudo -S dnf -y install bzip2 bzip2-devel byacc cairo-devel cmake cpp curl curl-devel flex fontconfig-devel fontconfig-devel gcc gcc-c++ gcc-gfortran git java-11-openjdk java-11-openjdk-devel ksh libX11-devel libX11-devel libXaw libXaw-devel libXext-devel libXext-devel libXmu-devel libXrender-devel libXrender-devel libstdc++ libstdc++-devel libxml2 libxml2-devel m4 nfs-utils perl "perl(XML::LibXML)" pkgconfig pixman-devel python3 python3-devel tcsh time unzip wget
	echo $PASSWD | sudo -S dnf -y install python3-dateutil
	echo $PASSWD | sudo -S dnf -y groupinstall "Development Tools"
	echo $PASSWD | sudo -S dnf -y update
	echo $PASSWD | sudo -S dnf -y upgrade
	echo " "

	echo "old version of GNU detected"
	echo $PASSWD | sudo -S yum install RHL-release-scl -y
	echo $PASSWD | sudo -S yum clean all
	echo $PASSWD | sudo -S yum remove devtoolset-11*
	echo $PASSWD | sudo -S yum install devtoolset-11
	echo $PASSWD | sudo -S yum install devtoolset-11-\* -y
	source /opt/rh/devtoolset-11/enable
	gcc --version
	echo $PASSWD | sudo -S yum install rh-python38* -y
	source /opt/rh/rh-python38/enable
	python3 -V
	echo $PASSWD | sudo -S ./opt/rh/rh-python38/root/bin/pip3.8 install python-dateutil --break-system-packages

	# Set WRF_FOLDER based on selected option
	if [ "$WRFCHEM_PICK" = "1" ]; then
		WRF_FOLDER="$HOME/WRFCHEM"
	elif [ "$WRFHYDRO_COUPLED_PICK" = "1" ]; then
		WRF_FOLDER="$HOME/WRFHYDRO_COUPLED"
	elif [ "$WRFHYDRO_STANDALONE_PICK" = "1" ]; then
		WRF_FOLDER="$HOME/WRFHYDRO_STANDALONE"
	elif [ "$WRF_PICK" = "1" ]; then
		WRF_FOLDER="$HOME/WRF"
	elif [ "$CMAQ_PICK" = "1" ]; then
		WRF_FOLDER="$HOME/WRF_CMAQ"
	elif [ "$SFIRE_PICK" = "1" ]; then
		WRF_FOLDER="$HOME/WRF_SFIRE"
	else
		WRF_FOLDER="$HOME/DTC"
	fi

	mkdir -p "$WRF_FOLDER"
	export WRF_FOLDER

	mkdir "${WRF_FOLDER}"/MET-$met_Version_number
	mkdir "${WRF_FOLDER}"/MET-$met_Version_number/Downloads
	mkdir "${WRF_FOLDER}"/METplus-$METPLUS_Version
	mkdir "${WRF_FOLDER}"/METplus-$METPLUS_Version/Downloads

	#Downloading MET and untarring files
	#Note weblinks change often update as needed.
	cd "${WRF_FOLDER}"/MET-$met_Version_number/Downloads

	wget -c https://raw.githubusercontent.com/dtcenter/MET/main_v$met_VERSION_number/internal/scripts/installation/compile_MET_all.sh

	wget -c https://dtcenter.ucar.edu/dfiles/code/METplus/MET/installation/tar_files.met-v$met_VERSION_number.tgz

	wget -c https://github.com/dtcenter/MET/archive/refs/tags/v$met_Version_number.tar.gz

	cp compile_MET_all.sh "${WRF_FOLDER}"/MET-$met_Version_number
	LD_LIBRARY_PATH= tar -xvzf tar_files.met-v$met_VERSION_number.tgz -C "${WRF_FOLDER}"/MET-$met_Version_number
	cp v$met_Version_number.tar.gz "${WRF_FOLDER}"/MET-$met_Version_number/tar_files
	cd "${WRF_FOLDER}"/MET-$met_Version_number

	# Installation of Model Evaluation Tools

	cd "${WRF_FOLDER}"/MET-$met_Version_number

	export PYTHON_VERSION=$(/opt/rh/rh-python38/root/usr/bin/python3 -V 2>&1 | awk '{print $2}')
	export PYTHON_VERSION_MAJOR_VERSION=$(echo $PYTHON_VERSION | awk -F. '{print $1}')
	export PYTHON_VERSION_MINOR_VERSION=$(echo $PYTHON_VERSION | awk -F. '{print $2}')
	export PYTHON_VERSION_COMBINED=$PYTHON_VERSION_MAJOR_VERSION.$PYTHON_VERSION_MINOR_VERSION

	echo "PYTHON_VERSION:               $PYTHON_VERSION"
	echo "PYTHON_VERSION_MAJOR_VERSION: $PYTHON_VERSION_MAJOR_VERSION"
	echo "PYTHON_VERSION_MINOR_VERSION: $PYTHON_VERSION_MINOR_VERSION"
	echo "PYTHON_VERSION_COMBINED:      $PYTHON_VERSION_COMBINED"

	# --- GCC/ version extraction ---
	export GCC_VERSION=$(gcc -dumpfullversion)
	export GCC_VERSION_MAJOR_VERSION=$(echo "$GCC_VERSION" | awk -F. '{print $1}')
	export GCC_VERSION_MINOR_VERSION=$(echo "$GCC_VERSION" | awk -F. '{print $2}')
	export GCC_VERSION_SUB_VERSION=$(echo "$GCC_VERSION" | awk -F. '{print $3}' | sed 's/[^0-9]*//g')
	export GCC_VERSION_COMBINED="$GCC_VERSION_MAJOR_VERSION.$GCC_VERSION_MINOR_VERSION.$GCC_VERSION_SUB_VERSION"

	echo "GCC_VERSION:                  $GCC_VERSION"
	echo "GCC_VERSION_MAJOR_VERSION:    $GCC_VERSION_MAJOR_VERSION"
	echo "GCC_VERSION_MINOR_VERSION:    $GCC_VERSION_MINOR_VERSION"
	echo "GCC_VERSION_SUB_VERSION:      $GCC_VERSION_SUB_VERSION"
	echo "GCC_VERSION_COMBINED:         $GCC_VERSION_COMBINED"

	export CC=gcc
	export CXX=g++
	export CFLAGS="-fPIC -fPIE -O3"
	export FC=gfortran
	export F77=gfortran
	export F90=gfortran
	export gcc_version=$GCC_VERSION
	export TEST_BASE="${WRF_FOLDER}"/MET-$met_Version_number
	export COMPILER=gnu_$GCC_VERSION_COMBINED
	export MET_SUBDIR=${TEST_BASE}
	export MET_TARBALL=v$met_Version_number.tar.gz
	export USE_MODULES=FALSE
	export MET_PYTHON=/opt/rh/rh-python38/root/usr/
	export MET_PYTHON_CC="-I${MET_PYTHON}/include/python${PYTHON_VERSION_COMBINED}"
	export MET_PYTHON_LD="$(python3-config --ldflags) -L${MET_PYTHON}/lib -lpython${PYTHON_VERSION_COMBINED}"
	export SET_D64BIT=FALSE

	export CPU_CORE=$(nproc) # number of available threads on system
	export CPU_6CORE="6"
	export CPU_QUARTER=$(($CPU_CORE / 4))                          #quarter of availble cores on system
	export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2))) #Forces CPU cores to even number to avoid partial core export. ie 7 cores would be 3.5 cores.

	if [ $CPU_CORE -le $CPU_6CORE ]; then #If statement for low core systems.  Forces computers to only use 1 core if there are 4 cores or less on the system.
		export CPU_QUARTER_EVEN="2"
	else
		export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))
	fi

	echo "##########################################"
	echo "Number of Threads being used $CPU_QUARTER_EVEN"
	echo "##########################################"

	echo " "

	export MAKE_ARGS="-j $CPU_QUARTER_EVEN"

	chmod 775 compile_MET_all.sh

	time ./compile_MET_all.sh 2>&1 | tee compile_MET_all.log

	export PATH="${WRF_FOLDER}"/MET-$met_Version_number/bin:$PATH

	#basic Package Management for Model Evaluation Tools (METplus)

	echo $PASSWD | sudo -S dnf -y update
	echo $PASSWD | sudo -S dnf -y upgrade

	#Directory Listings for Model Evaluation Tools (METplus

	mkdir "${WRF_FOLDER}"/METplus-$METPLUS_Version
	mkdir "${WRF_FOLDER}"/METplus-$METPLUS_Version/Sample_Data
	mkdir "${WRF_FOLDER}"/METplus-$METPLUS_Version/Output
	mkdir "${WRF_FOLDER}"/METplus-$METPLUS_Version/Downloads

	#Downloading METplus and untarring files

	cd "${WRF_FOLDER}"/METplus-$METPLUS_Version/Downloads
	wget -c https://github.com/dtcenter/METplus/archive/refs/tags/v$METPLUS_Version.tar.gz
	LD_LIBRARY_PATH= tar -xvzf v$METPLUS_Version.tar.gz -C "${WRF_FOLDER}"

	# Insatlllation of Model Evaluation Tools Plus
	cd "${WRF_FOLDER}"/METplus-$METPLUS_Version/parm/metplus_config

	sed -i "s|MET_INSTALL_DIR = /path/to|MET_INSTALL_DIR = "${WRF_FOLDER}"/MET-$met_Version_number|" defaults.conf
	sed -i "s|INPUT_BASE = /path/to|INPUT_BASE = "${WRF_FOLDER}"/METplus-$METPLUS_Version/Sample_Data|" defaults.conf
	sed -i "s|OUTPUT_BASE = /path/to|OUTPUT_BASE = "${WRF_FOLDER}"/METplus-$METPLUS_Version/Output|" defaults.conf

	# Downloading Sample Data

	cd "${WRF_FOLDER}"/METplus-$METPLUS_Version/Downloads
	wget -c https://dtcenter.ucar.edu/dfiles/code/METplus/METplus_Data/v$METPLUS_DATA/sample_data-met_tool_wrapper.tgz
	LD_LIBRARY_PATH= tar -xvzf sample_data-met_tool_wrapper.tgz -C "${WRF_FOLDER}"/METplus-$METPLUS_Version/Sample_Data

	# Testing if installation of MET & METPlus was sucessfull
	# If you see in terminal "METplus has successfully finished running."
	# Then MET & METPLUS is sucessfully installed

	echo 'Testing MET & METPLUS Installation.'
	$WRF_FOLDER/METplus-$METPLUS_Version/ush/run_metplus.py -c $WRF_FOLDER/METplus-$METPLUS_Version/parm/use_cases/met_tool_wrapper/GridStat/GridStat.conf

	# Check if the previous command was successful
	if [ $? -eq 0 ]; then
		echo " "
		echo "MET and METPLUS successfully installed with GNU compilers."
		echo " "
		export PATH=$WRF_FOLDER/METplus-$METPLUS_Version/ush:$PATH
	else
		echo " "
		echo "Error: MET and METPLUS installation failed."
		echo " "
		# Handle the error case, e.g., exit the script or retry installation
		exit 1
	fi
fi

if [ "$RHL_64bit_Intel" = "1"] && [ "$DTC_MET" = "1" ]; then

	#############################basic package managment############################
	echo $PASSWD | sudo -S yum install epel-release -y
	echo $PASSWD | sudo -S yum install dnf -y
	echo $PASSWD | sudo -S dnf install epel-release -y
	echo $PASSWD | sudo -S dnf install dnf -y
	echo $PASSWD | sudo -S dnf -y update
	echo $PASSWD | sudo -S dnf -y upgrade

	#############################basic package managment############################
	echo $PASSWD | sudo -S yum install epel-release -y
	echo $PASSWD | sudo -S yum install dnf -y
	echo $PASSWD | sudo -S dnf install epel-release -y
	echo $PASSWD | sudo -S dnf install dnf -y
	echo $PASSWD | sudo -S dnf -y update
	echo $PASSWD | sudo -S dnf -y upgrade
	echo $PASSWD | sudo -S dnf -y install -y bison cmake curl flex gcc-gfortran ghostscript git less bzip2-devel glibc-devel libffi-devel libcurl-devel libjpeg-turbo-devel ncurses-devel pixman-devel readline-devel libtiff-devel m4 tk-devel unzip vim wget make gcc gcc-c++ redhat-rpm-config
	echo $PASSWD | sudo -S dnf -y install python3-dateutil
	echo $PASSWD | sudo -S dnf -y groupinstall "Development Tools"

	# download the key to system keyring; this and the following echo command are
	# needed in order to install the Intel compilers

	echo $PASSWD | sudo bash -c 'printf "[oneAPI]\nname=Intel oneAPI repository\nbaseurl=https://yum.repos.intel.com/oneapi\nenabled=1\ngpgcheck=1\nrepo_gpgcheck=1\ngpgkey=https://yum.repos.intel.com/intel-gpg-keys/GPG-PUB-KEY-INTEL-SW-PRODUCTS.PUB\n" > /etc/yum.repos.d/oneAPI.repo'

	echo $PASSWD | sudo -S mv /tmp/oneAPI.repo /etc/yum.repos.d

	# install the Intel compilersls -y
	echo $PASSWD | sudo -S dnf install intel-oneapi-base-toolkit -y
	echo $PASSWD | sudo -S dnf install intel-oneapi-hpc-toolkit -y
	echo $PASSWD | sudo -S dnf install intel-oneapi-python -y
	/opt/intel/oneapi/intelpython/python3.12/bin/python3 -m pip install python-dateutil
	echo $PASSWD | sudo -S dnf install intel-cpp-essentials -y

	echo $PASSWD | sudo -S dnf update
	echo $PASSWD | sudo -S dnf -y install cmake pkgconfig
	echo $PASSWD | sudo -S dnf groupinstall "Development Tools" -y

	echo $PASSWD | sudo -S dnf -y update
	echo $PASSWD | sudo -S dnf -y upgrade

	# add the Intel compiler file paths to various environment variables
	source /opt/intel/oneapi/setvars.sh --force

	echo $PASSWD | sudo python3 -m pip install python-dateutil

	# Set WRF_FOLDER based on selected option
	if [ "$WRFCHEM_PICK" = "1" ]; then
		export WRF_FOLDER="$HOME/WRFCHEM_Intel"
	elif [ "$WRFHYDRO_COUPLED_PICK" = "1" ]; then
		export WRF_FOLDER="$HOME/WRFHYDRO_COUPLED_Intel"
	elif [ "$WRF_PICK" = "1" ]; then
		export WRF_FOLDER="$HOME/WRF_Intel"
	elif [ "$SFIRE_PICK" = "1" ]; then
		export WRF_FOLDER="$HOME/WRF_SFIRE_Intel"
	else
		export WRF_FOLDER="$HOME/DTC_Intel"
	fi

	mkdir $WRF_FOLDER

	mkdir "${WRF_FOLDER}"/MET-$met_Version_number
	mkdir "${WRF_FOLDER}"/MET-$met_Version_number/Downloads
	mkdir "${WRF_FOLDER}"/METplus-$METPLUS_Version
	mkdir "${WRF_FOLDER}"/METplus-$METPLUS_Version/Downloads

	#Downloading MET and untarring files
	#Note weblinks change often update as needed.
	cd "${WRF_FOLDER}"/MET-$met_Version_number/Downloads

	wget -c https://raw.githubusercontent.com/dtcenter/MET/main_v$met_VERSION_number/internal/scripts/installation/compile_MET_all.sh

	wget -c https://dtcenter.ucar.edu/dfiles/code/METplus/MET/installation/tar_files.met-v$met_VERSION_number.tgz

	wget -c https://github.com/dtcenter/MET/archive/refs/tags/v$met_Version_number.tar.gz

	cp compile_MET_all.sh "${WRF_FOLDER}"/MET-$met_Version_number
	LD_LIBRARY_PATH= LD_LIBRARY_PATH= tar -xvzf tar_files.met-v$met_VERSION_number.tgz -C "${WRF_FOLDER}"/MET-$met_Version_number
	cp v$met_Version_number.tar.gz "${WRF_FOLDER}"/MET-$met_Version_number/tar_files
	cd "${WRF_FOLDER}"/MET-$met_Version_number

	# Installation of Model Evaluation Tools

	cd "${WRF_FOLDER}"/MET-$met_Version_number

	export PYTHON_VERSION=$(/opt/intel/oneapi/intelpython/latest/bin/python3 -V 2>&1 | awk '{print $2}')
	export PYTHON_VERSION_MAJOR_VERSION=$(echo $PYTHON_VERSION | awk -F. '{print $1}')
	export PYTHON_VERSION_MINOR_VERSION=$(echo $PYTHON_VERSION | awk -F. '{print $2}')
	export PYTHON_VERSION_COMBINED=$PYTHON_VERSION_MAJOR_VERSION.$PYTHON_VERSION_MINOR_VERSION
	echo "PYTHON_VERSION_MAJOR_VERSION: $PYTHON_VERSION_MAJOR_VERSION"
	echo "PYTHON_VERSION_MINOR_VERSION: $PYTHON_VERSION_MINOR_VERSION"
	echo "PYTHON_VERSION_COMBINED: $PYTHON_VERSION_COMBINED"

	export GCC_VERSION=$(icx -dumpversion)
	export GCC_VERSION_MAJOR_VERSION=$(echo $GCC_VERSION | awk -F. '{print $1}')
	export GCC_VERSION_MINOR_VERSION=$(echo $GCC_VERSION | awk -F. '{print $2}')
	export GCC_VERSION_SUB_VERSION=$(echo $GCC_VERSION | awk -F. '{print $3}' | sed 's/[^0-9]*//g')
	export GCC_VERSION_COMBINED=$GCC_VERSION_MAJOR_VERSION.$GCC_VERSION_MINOR_VERSION.$GCC_VERSION_SUB_VERSION

	echo "GCC_VERSION:                  $GCC_VERSION"
	echo "GCC_VERSION_MAJOR_VERSION:    $GCC_VERSION_MAJOR_VERSION"
	echo "GCC_VERSION_MINOR_VERSION:    $GCC_VERSION_MINOR_VERSION"
	echo "GCC_VERSION_SUB_VERSION:      $GCC_VERSION_SUB_VERSION"
	echo "GCC_VERSION_COMBINED:         $GCC_VERSION_COMBINED"

	export CC=icx
	export CXX=icpx
	export CFLAGS="-fPIC -fPIE -O3"
	export FC=ifx
	export F77=ifx
	export F90=ifx
	export gcc_version=$GCC_VERSION
	export TEST_BASE="${WRF_FOLDER}"/MET-$met_Version_number
	export COMPILER=intel_$GCC_VERSION_COMBINED
	export MET_SUBDIR=${TEST_BASE}
	export MET_TARBALL=v$met_Version_number.tar.gz
	export USE_MODULES=FALSE
	export MET_PYTHON=/opt/intel/oneapi/intelpython/python${PYTHON_VERSION_COMBINED}
	export MET_PYTHON_CC="-I ${MET_PYTHON}/include/python${PYTHON_VERSION_COMBINED}"
	export MET_PYTHON_LD="-L${MET_PYTHON}/lib/python${PYTHON_VERSION_COMBINED}/config-${PYTHON_VERSION_COMBINED}-x86_64-linux-gnu -L${MET_PYTHON}/lib -lpython${PYTHON_VERSION_COMBINED} -lpthread -ldl -lutil -lm"
	export SET_D64BIT=FALSE
	export CXXFLAGS="-Wall -DHAVE_ISATTY"

	export CPU_CORE=$(nproc) # number of available threads on system
	export CPU_6CORE="6"
	export CPU_QUARTER=$(($CPU_CORE / 4))                          #quarter of availble cores on system
	export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2))) #Forces CPU cores to even number to avoid partial core export. ie 7 cores would be 3.5 cores.

	if [ $CPU_CORE -le $CPU_6CORE ]; then #If statement for low core systems.  Forces computers to only use 1 core if there are 4 cores or less on the system.
		export CPU_QUARTER_EVEN="2"
	else
		export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))
	fi

	echo "##########################################"
	echo "Number of Threads being used $CPU_QUARTER_EVEN"
	echo "##########################################"

	echo " "

	export MAKE_ARGS="-j $CPU_QUARTER_EVEN"

	chmod 775 compile_MET_all.sh

	time ./compile_MET_all.sh 2>&1 | tee compile_MET_all.log

	export PATH="${WRF_FOLDER}"/MET-$met_Version_number/bin:$PATH #Add MET executables to path

	#Basic Package Management for Model Evaluation Tools (METplus)

	echo $PASSWD | sudo -S apt -y update
	echo $PASSWD | sudo -S apt -y upgrade

	#Directory Listings for Model Evaluation Tools (METplus

	mkdir "${WRF_FOLDER}"/METplus-$METPLUS_Version
	mkdir "${WRF_FOLDER}"/METplus-$METPLUS_Version/Sample_Data
	mkdir "${WRF_FOLDER}"/METplus-$METPLUS_Version/Output
	mkdir "${WRF_FOLDER}"/METplus-$METPLUS_Version/Downloads

	#Downloading METplus and untarring files

	cd "${WRF_FOLDER}"/METplus-$METPLUS_Version/Downloads
	wget -c https://github.com/dtcenter/METplus/archive/refs/tags/v$METPLUS_Version.tar.gz
	LD_LIBRARY_PATH= LD_LIBRARY_PATH= tar -xvzf v$METPLUS_Version.tar.gz -C "${WRF_FOLDER}"

	# Insatlllation of Model Evaluation Tools Plus
	cd "${WRF_FOLDER}"/METplus-$METPLUS_Version/parm/metplus_config

	sed -i "s|MET_INSTALL_DIR = /path/to|MET_INSTALL_DIR = "${WRF_FOLDER}"/MET-$met_Version_number|" defaults.conf
	sed -i "s|INPUT_BASE = /path/to|INPUT_BASE = "${WRF_FOLDER}"/METplus-$METPLUS_Version/Sample_Data|" defaults.conf
	sed -i "s|OUTPUT_BASE = /path/to|OUTPUT_BASE = "${WRF_FOLDER}"/METplus-$METPLUS_Version/Output|" defaults.conf

	# Downloading Sample Data

	cd "${WRF_FOLDER}"/METplus-$METPLUS_Version/Downloads
	wget -c https://dtcenter.ucar.edu/dfiles/code/METplus/METplus_Data/v$METPLUS_DATA/sample_data-met_tool_wrapper.tgz
	LD_LIBRARY_PATH= LD_LIBRARY_PATH= tar -xvzf sample_data-met_tool_wrapper.tgz -C "${WRF_FOLDER}"/METplus-$METPLUS_Version/Sample_Data

	# Testing if installation of MET & METPlus was sucessfull
	# If you see in terminal "METplus has successfully finished running."
	# Then MET & METPLUS is sucessfully installed

	echo 'Testing MET & METPLUS Installation.'
	$WRF_FOLDER/METplus-$METPLUS_Version/ush/run_metplus.py -c $WRF_FOLDER/METplus-$METPLUS_Version/parm/use_cases/met_tool_wrapper/GridStat/GridStat.conf

	# Check if the previous command was successful
	if [ $? -eq 0 ]; then
		echo " "
		echo "MET and METPLUS successfully installed with Intel compilers."
		echo " "
		export PATH=$WRF_FOLDER/METplus-$METPLUS_Version/ush:$PATH
	else
		echo " "
		echo "Error: MET and METPLUS installation failed."
		echo " "
		# Handle the error case, e.g., exit the script or retry installation
		exit 1
	fi

fi


############################################# WRF CMAQ #################################
## WRF_CMAQ installation with parallel process.
# Download and install required library and data files for WRF_CMAQ.
# Tested in Ubuntu 22.04 & 24.04, Rocky Linux 9
# Built in 64-bit system
# Built with Intel or GNU compilers
# Tested with current available libraries on 03/01/2025
# If newer libraries exist edit script paths for changes
#Estimated Run Time ~ 30 - 60 Minutes with 10mb/s downloadspeed.
# Special thanks to:
# Youtube's meteoadriatic, GitHub user jamal919.
# University of Manchester's  Doug L
# University of Tunis El Manar's Hosni
# GSL's Jordan S.
# NCAR's Mary B., Christine W., & Carl D.
# DTC's Julie P., Tara J., George M., & John H.
# UCAR's Katelyn F., Jim B., Jordan P., Kevin M.,
# EPA's Fahim S.
##############################################################

if [ "$Ubuntu_64bit_GNU" = "1" ] && [ "$CMAQ_PICK" = "1" ]; then
	#############################basic package managment############################
	echo $PASSWD | sudo -S apt -y update
	echo $PASSWD | sudo -S apt -y upgrade

	release_version=$(lsb_release -r -s)

	# Compare the release version
	if [ "$release_version" = "24.04" ]; then
		# Install Emacs without recommended packages
		echo $PASSWD | sudo -S apt install emacs --no-install-recommends -y
	else
		# Attempt to install Emacs if the release version is not 24.04
		echo "The release version is not 24.04, attempting to install Emacs."
		echo $PASSWD | sudo -S apt install emacs -y
	fi

	echo $PASSWD | sudo -S apt -y install bison build-essential byacc cmake csh curl default-jdk default-jre flex libfl-dev g++ gawk gcc gettext gfortran git ksh libcurl4-gnutls-dev libjpeg-dev libncurses6 libpixman-1-dev libpng-dev libtool libxml2 libxml2-dev libxml-libxml-perl m4 make ncview pipenv pkg-config python3 python3-dev python3-pip python3-dateutil tcsh unzip xauth xorg time

	echo " "
	##############################Directory Listing############################
	export HOME=$(
		cd
		pwd
	)

	mkdir $HOME/WRF_CMAQ
	export WRF_FOLDER=$HOME/WRF_CMAQ
	cd "${WRF_FOLDER}"/
	mkdir Downloads
	mkdir Libs
	export DIR="${WRF_FOLDER}"/Libs
	mkdir Libs/grib2
	mkdir Libs/NETCDF
	mkdir Libs/MPICH
	mkdir -p Tests/Environment
	mkdir -p Tests/Compatibility

	echo " "
	#############################Core Management####################################

	export CPU_CORE=$(nproc) # number of available threads on system
	export CPU_6CORE="6"
	export CPU_QUARTER=$(($CPU_CORE / 4))                          #quarter of availble cores on system
	export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2))) #Forces CPU cores to even number to avoid partial core export. ie 7 cores would be 3.5 cores.

	if [ $CPU_CORE -le $CPU_6CORE ]; then #If statement for low core systems.  Forces computers to only use 1 core if there are 4 cores or less on the system.
		export CPU_QUARTER_EVEN="2"
	else
		export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))
	fi

	echo "##########################################"
	echo "Number of Threads being used $CPU_QUARTER_EVEN"
	echo "##########################################"

	echo " "
	##############################Downloading Libraries############################

	cd Downloads
	wget -c https://github.com/madler/zlib/releases/download/v$Zlib_Version/zlib-$Zlib_Version.tar.gz
	wget -c https://github.com/HDFGroup/hdf5/releases/download/hdf5_$HDF5_Version/hdf5-$HDF5_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-c/archive/refs/tags/v$Netcdf_C_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-fortran/archive/refs/tags/v$Netcdf_Fortran_Version.tar.gz
	wget -c https://download.sourceforge.net/libpng/libpng-$Libpng_Version.tar.gz
	wget -c https://www.ece.uvic.ca/~frodo/jasper/software/jasper-$Jasper_Version.zip
	wget -c https://github.com/pmodels/mpich/releases/download/v$Mpich_Version/mpich-$Mpich_Version.tar.gz
	wget -c https://parallel-netcdf.github.io/Release/pnetcdf-$Pnetcdf_Version.tar.gz
	wget -c https://www.cmascenter.org/ioapi/download/ioapi-3.2.tar.gz

	echo " "
	####################################Compilers#####################################
	export CC=gcc
	export CXX=g++
	export FC=gfortran
	export F77=gfortran
	export CFLAGS="-fPIC -fPIE -O3 "

	#IF statement for GNU compiler issue
	export GCC_VERSION=$(/usr/bin/gcc -dumpfullversion | awk '{print$1}')
	export GFORTRAN_VERSION=$(/usr/bin/gfortran -dumpfullversion | awk '{print$1}')
	export GPLUSPLUS_VERSION=$(/usr/bin/g++ -dumpfullversion | awk '{print$1}')

	export GCC_VERSION_MAJOR_VERSION=$(echo $GCC_VERSION | awk -F. '{print $1}')
	export GFORTRAN_VERSION_MAJOR_VERSION=$(echo $GFORTRAN_VERSION | awk -F. '{print $1}')
	export GPLUSPLUS_VERSION_MAJOR_VERSION=$(echo $GPLUSPLUS_VERSION | awk -F. '{print $1}')

	export version_10="10"

	if [ $GCC_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GFORTRAN_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GPLUSPLUS_VERSION_MAJOR_VERSION -ge $version_10 ]; then
		export fallow_argument=-fallow-argument-mismatch
		export boz_argument=-fallow-invalid-boz
	else
		export fallow_argument=
		export boz_argument=
	fi

	export FFLAGS="$fallow_argument -m64"
	export FCFLAGS="$fallow_argument -m64"

	echo "##########################################"
	echo "FFLAGS = $FFLAGS"
	echo "FCFLAGS = $FCFLAGS"
	echo "##########################################"

	echo " "
	############################# ZLib ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf zlib-$Zlib_Version.tar.gz
	cd zlib-$Zlib_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	export ZLIB_ROOT=$DIR/grib2
	export ZLIBLIB=$DIR/grib2/lib
	export ZLIBINC=$DIR/grib2/include

	echo " "
	############################## MPICH ############################
	#F90= due to compiler issues with mpich install
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf mpich-$Mpich_Version.tar.gz
	cd mpich-$Mpich_Version/
	F90= ./configure --prefix=$DIR/MPICH --with-device=ch3 FFLAGS=$fallow_argument FCFLAGS=$fallow_argument 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/MPICH/bin:$PATH

	export MPIFC=$DIR/MPICH/bin/mpifort
	export MPIF77=$DIR/MPICH/bin/mpifort
	export MPIF90=$DIR/MPICH/bin/mpifort
	export MPICC=$DIR/MPICH/bin/mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx

	echo " "
	############################# libpng ############################

	cd "${WRF_FOLDER}"/Downloads

	# other libraries below need these variables to be set
	export LDFLAGS=-L$DIR/grib2/lib
	export CPPFLAGS=-I$DIR/grib2/include

	LD_LIBRARY_PATH= tar -xvzf libpng-$Libpng_Version.tar.gz
	cd libpng-$Libpng_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNG_ROOT=$DIR/grib2

	echo " "
	#############################JasPer ############################
	cd "${WRF_FOLDER}"/Downloads
	unzip jasper-$Jasper_Version.zip
	cd jasper-$Jasper_Version/
	./configure --prefix=$DIR/grib2
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export JASPERLIB=$DIR/grib2/lib
	export JASPERINC=$DIR/grib2/include
	export JASPER_DIR=$DIR/grib2
	export Jasper_ROOT=$DIR/grib2/lib

	echo " "
	############################# hdf5 library for netcdf4 functionality ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf hdf5-$HDF5_Version.tar.gz
	cd hdf5-$HDF5_Version
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --with-zlib=$DIR/grib2 --enable-hl --enable-fortran --enable-parallel 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export HDF5=$DIR/grib2
	export PATH=$HDF5/bin:$PATH
	export PHDF5=$DIR/grib2
	export HDF5_ROOT=$DIR/grib2
	export PHDF5_ROOT=$DIR/grib2

	echo " "
	############################# Install Parallel-netCDF ##############################
	#Make file created with half of available cpu cores
	#Hard path for MPI added
	##################################################################################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf pnetcdf-$Pnetcdf_Version.tar.gz
	cd pnetcdf-$Pnetcdf_Version
	export MPIFC=$DIR/MPICH/bin/mpifort
	export MPIF77=$DIR/MPICH/bin/mpifort
	export MPIF90=$DIR/MPICH/bin/mpifort
	export MPICC=$DIR/MPICH/bin/mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --enable-static 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNETCDF=$DIR/grib2
	export PNETCDF_DIR=$DIR/grib2
	export PNETCDF_ROOT=$DIR/grib2

	############################## Install NETCDF C Library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_C_Version.tar.gz
	cd netcdf-c-$Netcdf_C_Version/
	export CPPFLAGS=-I$DIR/grib2/include
	export LDFLAGS="-L$DIR/grib2/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lhdf5_hl -lhdf5 -lz -lcurl -lgfortran -lgcc -lm -ldl -lpnetcdf"
	CC=$MPICC FC=$MPIFC CXX=$MPICXX F90=$MPIF90 F77=$MPIF77 CFLAGS=$CFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --disable-dap --enable-netcdf-4 --enable-netcdf4 --enable-pnetcdf --enable-cdf5 --enable-parallel-tests --enable-logging 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/NETCDF/bin:$PATH
	export NETCDF=$DIR/NETCDF
	export NETCDF_INC=$DIR/NETCDF/include
	export NETCDF_LIB=$DIR/NETCDF/lib
	export NETCDF_ROOT=$DIR/NETCDF
	export LD_LIBRARY_PATH=$DIR/grib2/lib:$DIR/NETCDF/lib:$LD_LIBRARY_PATH

	echo " "
	############################## NetCDF fortran library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_Fortran_Version.tar.gz
	cd netcdf-fortran-$Netcdf_Fortran_Version/
	export LD_LIBRARY_PATH=$DIR/NETCDF/lib:$LD_LIBRARY_PATH
	export CPPFLAGS="-I$DIR/NETCDF/include -I$DIR/grib2/include"
	export LDFLAGS="-L$DIR/NETCDF/lib -L$DIR/grib2/lib -Wl,-rpath,$DIR/NETCDF/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lnetcdf -lpnetcdf -lcurl -lhdf5_hl -lhdf5 -lz -lm -ldl -lgcc -lgfortran"
	CC=$MPICC FC=$MPIFC CXX=$MPICXX F90=$MPIF90 F77=$MPIF77 CFLAGS=$CFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --enable-netcdf-4 --enable-netcdf4 --enable-parallel-tests --enable-logging --enable-hdf5 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	echo " "

	###############################  I/O API  ###################################

	cd "${WRF_FOLDER}"/Downloads
	mkdir ioapi
	cd ioapi
	LD_LIBRARY_PATH= tar -xvzf "${WRF_FOLDER}"/Downloads/ioapi-3.2.tar.gz

	#set gnu version
	export BIN=Linux2_x86_64gfort10
	export CPLMODE=nocpl
	mkdir $BIN

	#Link netcdf and grib lib folders to ioapi
	ln -sf "${WRF_FOLDER}"/Libs/NETCDF/lib/* "${WRF_FOLDER}"/Downloads/ioapi/$BIN
	ln -sf "${WRF_FOLDER}"/Libs/grib2/lib/* "${WRF_FOLDER}"/Downloads/ioapi/$BIN

	#copy makefiles from ioapi directory to source makefile
	#cp "${WRF_FOLDER}"/Downloads/ioapi/ioapi/Makefile.nocpl "${WRF_FOLDER}"/Downloads/ioapi/ioapi/Makefile
	#cp "${WRF_FOLDER}"/Downloads/ioapi/m3tools/Makefile.nocpl "${WRF_FOLDER}"/Downloads/ioapi/m3tools/Makefile
	cp "${WRF_FOLDER}"/Downloads/ioapi/Makefile.template "${WRF_FOLDER}"/Downloads/ioapi/Makefile

	# Add proper sed statements needed for gfortran
	sed -i '193s|-lnetcdff -lnetcdf| -lnetcdff -lnetcdf -lhdf5hl_fortran -lhdf5_fortran -lhdf5_hl -lhdf5 -ljpeg -lm -lz -lcurl|g' "${WRF_FOLDER}"/Downloads/ioapi/Makefile
	sed -i '210s|${IODIR}/Makefile ${TOOLDIR}/Makefile| |g' "${WRF_FOLDER}"/Downloads/ioapi/Makefile

	#Remove openmnp flags from Makefile
	sed -i '30s/ -fopenmp//g' "${WRF_FOLDER}"/Downloads/ioapi/ioapi/Makeinclude.$BIN
	sed -i '31s/ -fopenmp//g' "${WRF_FOLDER}"/Downloads/ioapi/ioapi/Makeinclude.$BIN

	# Build IOAPI
	make configure 2>&1 | tee configure.log
	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log

	#If statement to check that libioapi.a & m3xtract exist

	cd "${WRF_FOLDER}"/Downloads/ioapi/$BIN
	n=$(ls -lrt libioapi.a | wc -l)
	m=$(ls -rlt m3xtract | wc -l)
	if ((($n == 1) && ($m == 1))); then
		echo "All expected files created."

	else
		echo "Missing one or more expected files. Exiting the script."
		read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
		exit
	fi
	echo " "

	echo " "

	mv "${WRF_FOLDER}"/Downloads/ioapi/$BIN "${WRF_FOLDER}"/Downloads/ioapi/Linux2_x86_64gfort
	export BIN=Linux2_x86_64gfort
	#################################### System Environment Tests ##############

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_NETCDF_MPI_tests.tar
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_tests.tar

	LD_LIBRARY_PATH= tar -xvf Fortran_C_tests.tar -C "${WRF_FOLDER}"/Tests/Environment
	LD_LIBRARY_PATH= tar -xvf Fortran_C_NETCDF_MPI_tests.tar -C "${WRF_FOLDER}"/Tests/Compatibility

	export one="1"
	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Environment

	cp ${NETCDF}/include/netcdf.inc .

	echo " "
	echo " "
	echo "Environment Testing "
	echo "Test 1"
	$FC TEST_1_fortran_only_fixed.f
	./a.out | tee env_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 1 Passed"
	else
		echo "Environment Compiler Test 1 Failed"
		exit
	fi
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 2"
	$FC TEST_2_fortran_only_free.f90
	./a.out | tee env_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 2 Passed"
	else
		echo "Environment Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 3"
	$CC TEST_3_c_only.c
	./a.out | tee env_test3.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test3.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 3 Passed"
	else
		echo "Environment Compiler Test 3 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 4"
	$CC -c -m64 TEST_4_fortran+c_c.c
	$FC -c -m64 TEST_4_fortran+c_f.f90
	$FC -m64 TEST_4_fortran+c_f.o TEST_4_fortran+c_c.o
	./a.out | tee env_test4.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test4.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 4 Passed"
	else
		echo "Environment Compiler Test 4 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Compatibility

	cp ${NETCDF}/include/netcdf.inc .

	echo " "
	echo " "
	echo "Library Compatibility Tests "
	echo "Test 1"
	$FC -c 01_fortran+c+netcdf_f.f
	$CC -c 01_fortran+c+netcdf_c.c
	$FC 01_fortran+c+netcdf_f.o 01_fortran+c+netcdf_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	./a.out | tee comp_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 1 Passed"
	else
		echo "Compatibility Compiler Test 1 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "

	echo "Test 2"
	$MPIFC -c 02_fortran+c+netcdf+mpi_f.f
	$MPICC -c 02_fortran+c+netcdf+mpi_c.c
	$MPIFC 02_fortran+c+netcdf+mpi_f.o \
		02_fortran+c+netcdf+mpi_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	$DIR/MPICH/bin/mpirun ./a.out | tee comp_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 2 Passed"
	else
		echo "Compatibility Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."
	echo " "

	echo " All tests completed and passed"
	echo " "

	############################ CMAQ Source Code #################################
	cd "${WRF_FOLDER}"/Downloads
	git clone -b main https://github.com/USEPA/CMAQ.git #clone CMAQ github to WRF_CMAQ Main Folder

	cd CMAQ
	cp bldit_project.csh bldit_project.csh.old # Create backup of build project script

	# Set path to where CMAQ will be built
	sed -i '19s|/home/username/path|"${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}|g' "${WRF_FOLDER}"/Downloads/CMAQ/bldit_project.csh
	# Build CMAQ Project
	./bldit_project.csh

	cd "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}

	cp config_cmaq.csh config_cmaq.csh.old # Create backup of configure script

	# Sed statements to configure the Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}
	sed -i '146s|netcdf_root_gcc|"${WRF_FOLDER}"/Libs/NETCDF|g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/config_cmaq.csh
	sed -i '147s|ioapi_root_gcc|"${WRF_FOLDER}"/Downloads/ioapi|g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/config_cmaq.csh
	sed -i '148s|WRF_ARCH|WRF_ARCH 34|g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/config_cmaq.csh

	# sed statements for paths in configure file
	sed -i '151s|ioapi_inc_gcc|"${WRF_FOLDER}"/Downloads/ioapi/ioapi/fixed_src|g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/config_cmaq.csh
	sed -i '152s|ioapi_lib_gcc|"${WRF_FOLDER}"/Downloads/ioapi/$BIN|g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/config_cmaq.csh
	sed -i '153s|netcdf_lib_gcc |"${WRF_FOLDER}"/Libs/NETCDF/lib|g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/config_cmaq.csh
	sed -i '154s|netcdf_inc_gcc|"${WRF_FOLDER}"/Libs/NETCDF/include|g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/config_cmaq.csh
	sed -i '155s|netcdff_lib_gcc|"${WRF_FOLDER}"/Libs/NETCDF/lib|g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/config_cmaq.csh
	sed -i '156s|netcdff_inc_gcc|"${WRF_FOLDER}"/Libs/NETCDF/include|g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/config_cmaq.csh
	sed -i '157s|mpi_incl_gcc|"${WRF_FOLDER}"/Libs/MPICH|g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/config_cmaq.csh
	sed -i '158s|mpi_lib_gcc|"${WRF_FOLDER}"/Libs/MPICH|g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/config_cmaq.csh

	# compile the Chemistry Transport Model (CCTM) preprocess

	cd "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/CCTM/scripts

	cp bldit_cctm.csh bldit_cctm.csh.old # make a back up copy of .csh script

	# Sed statements for configuration
	sed -i '74s|-j|-j $CPU_QUARTER_EVEN|g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/CCTM/scripts/bldit_cctm.csh # set multicore to half of available cpus
	sed -i '84s|#set|set|g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/CCTM/scripts/bldit_cctm.csh                # build two way
	sed -i '100s|v4.4|v4.5.1|g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/CCTM/scripts/bldit_cctm.csh            # change wrf version from 4.4 to ${WPS_VERSION}

	sed -i '440s| if ( $? != 0 ) then| |g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/CCTM/scripts/bldit_cctm.csh
	sed -i '441s|    set shaID   = "not_a_repo"| |g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/CCTM/scripts/bldit_cctm.csh
	sed -i '442s| endif| |g' "${WRF_FOLDER}"/Downloads/CMAQ//Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/CCTM/scripts/bldit_cctm.csh
	sed -i '792s|  if ($? == 0) then| |g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/CCTM/scripts/bldit_cctm.csh
	sed -i '794s|  endif| |g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/CCTM/scripts/bldit_cctm.csh
	sed -i '806s|--branch|--recurse-submodule --branch|g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/CCTM/scripts/bldit_cctm.csh
	sed -i '823s|compile em_real|compile -j $CPU_QUARTER_EVEN em_real|g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/CCTM/scripts/bldit_cctm.csh

	# Build WRF-CMAQ
	./bldit_cctm.csh gcc 2>&1 | tee bldit.cctm.twoway.gcc.log

	# Move built folder to top level directory
	mv "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/CCTM/scripts/BLD_WRFv4.5.1_CCTM_v55_gcc/* "${WRF_FOLDER}"/WRF-${WRF_VERSION}_CMAQv${CMAQ_VERSION}

	export WRF_DIR="${WRF_FOLDER}"/WRF-${WRF_VERSION}_CMAQv${CMAQ_VERSION}

	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}_CMAQv${CMAQ_VERSION}/main
	n=$(ls ./*.exe | wc -l)
	if (($n >= 3)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files. Exiting the script."
		read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
		exit
	fi
	echo " "

	############################WPS#####################################
	## WPS v${WPS_VERSION}
	## Downloaded from git tagged releases
	#Option 3 for gfortran and distributed memory
	########################################################################

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/wrf-model/WPS/archive/refs/tags/v${WPS_VERSION}.tar.gz -O WPS-${WPS_VERSION}.tar.gz
	LD_LIBRARY_PATH= tar -xvzf WPS-${WPS_VERSION}.tar.gz -C "${WRF_FOLDER}"/
	# Check if WPS directory exists
	if [ -d "${WRF_FOLDER}/WPS" ]; then
		mv -f "${WRF_FOLDER}/WPS" "${WRF_FOLDER}/WPS-${WPS_VERSION}"

	# Else, check for any folder matching WPSV* or WPS-*
	else
		for dir in "${WRF_FOLDER}"/WPSV* "${WRF_FOLDER}"/WPS-*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WPS-${WPS_VERSION}"
				break
			fi
		done
	fi
	cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
	LD_LIBRARY_PATH= ./clean -a

	if [ ${auto_config} -eq 1 ]; then
		echo 3 | ./configure 2>&1 | tee configure.log #Option 3 for gfortran and distributed memory
	else
		./configure 2>&1 | tee configure.log #Option 3 gfortran compiler with distributed memory
	fi
	LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.wps.log

	echo " "
	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
	n=$(ls ./*.exe | wc -l)
	if (($n == 3)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WPS. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files. Exiting the script."
		read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
		exit
	fi
	echo " "

	######################## Static Geography Data inc/ Optional ####################
	# http://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html
	# These files are large so if you only need certain ones comment the others off
	# All files downloaded and untarred is 200GB
	# https://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html
	#################################################################################
	cd "${WRF_FOLDER}"/Downloads
	mkdir "${WRF_FOLDER}"/GEOG
	mkdir "${WRF_FOLDER}"/GEOG/WPS_GEOG

	echo " "
	echo "Mandatory WRF Preprocessing System (WPS) Geographical Input Data Mandatory Fields Downloads"
	echo " "
	wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_high_res_mandatory.tar.gz
	LD_LIBRARY_PATH= tar -xvzf geog_high_res_mandatory.tar.gz -C "${WRF_FOLDER}"/GEOG/

	wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_low_res_mandatory.tar.gz
	LD_LIBRARY_PATH= tar -xvzf geog_low_res_mandatory.tar.gz -C "${WRF_FOLDER}"/GEOG/
	mv "${WRF_FOLDER}"/GEOG/WPS_GEOG_LOW_RES/ "${WRF_FOLDER}"/GEOG/WPS_GEOG

	if [ ${WPS_Specific_Applications} -eq 1 ]; then
		echo " "
		echo " WPS Geographical Input Data Mandatory for Specific Applications"
		echo " "

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_thompson28_chem.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_thompson28_chem.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_noahmp.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_noahmp.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/irrigation.tar.gz
		LD_LIBRARY_PATH= tar -xvzf irrigation.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_px.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_px.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_urban.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_urban.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_ssib.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_ssib.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/lake_depth.tar.bz2
		LD_LIBRARY_PATH= tar -xvf lake_depth.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/topobath_30s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf topobath_30s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/gsl_gwd.tar.bz2
		LD_LIBRARY_PATH= tar -xvf gsl_gwd.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/cglc_modis_lcz_global.tar.gz
		LD_LIBRARY_PATH= tar -xvf cglc_modis_lcz_global.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG
	fi

	if [ ${Optional_GEOG} -eq 1 ]; then
		echo " "
		echo "Optional WPS Geographical Input Data"
		echo " "

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_older_than_2000.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_older_than_2000.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/modis_landuse_20class_15s_with_lakes.tar.gz
		LD_LIBRARY_PATH= tar -xvzf modis_landuse_20class_15s_with_lakes.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_alt_lsm.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_alt_lsm.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/nlcd2006_ll_9s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf nlcd2006_ll_9s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/updated_Iceland_LU.tar.gz
		LD_LIBRARY_PATH= tar -xvf updated_Iceland_LU.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/modis_landuse_20class_15s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf modis_landuse_20class_15s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

	fi
fi

if [ "$RHL_64bit_GNU" = "1" ] && [ "$CMAQ_PICK" = "1" ]; then

	#############################basic package managment############################
	echo $PASSWD | sudo -S yum install epel-release -y
	echo $PASSWD | sudo -S yum install dnf -y
	echo $PASSWD | sudo -S dnf install epel-release -y
	echo $PASSWD | sudo -S dnf install dnf -y
	echo $PASSWD | sudo -S dnf -y update
	echo $PASSWD | sudo -S dnf -y upgrade
	echo $PASSWD | sudo -S dnf -y install bzip2 bzip2-devel byacc cairo-devel cmake cpp curl curl-devel flex fontconfig fontconfig-devel gcc gcc-c++ gcc-gfortran git java-11-openjdk java-11-openjdk-devel ksh libjpeg libjpeg-devel libX11 libX11-devel libXaw libXaw-devel libXext-devel libXmu libXmu-devel libXrender libXrender-devel libXt libXt-devel libxml2 libxml2-devel libXmu libXmu-devel libgeotiff libgeotiff-devel libtiff libtiff-devel m4 nfs-utils perl pkgconfig pixman pixman-devel python3 python3-devel tcsh time unzip wget
	echo $PASSWD | sudo -S dnf -y groupinstall "Development Tools"
	echo $PASSWD | sudo -S dnf -y update
	echo $PASSWD | sudo -S dnf -y upgrade

	echo " "
	##############################Directory Listing############################
	export HOME=$(
		cd
		pwd
	)

	mkdir $HOME/WRF_CMAQ
	export WRF_FOLDER=$HOME/WRF_CMAQ
	cd "${WRF_FOLDER}"/
	mkdir Downloads
	mkdir Libs
	export DIR="${WRF_FOLDER}"/Libs
	mkdir Libs/grib2
	mkdir Libs/NETCDF
	mkdir Libs/MPICH
	mkdir -p Tests/Environment
	mkdir -p Tests/Compatibility

	echo " "
	#############################Core Management####################################

	export CPU_CORE=$(nproc) # number of available threads on system
	export CPU_6CORE="6"
	export CPU_QUARTER=$(($CPU_CORE / 4))                          #quarter of availble cores on system
	export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2))) #Forces CPU cores to even number to avoid partial core export. ie 7 cores would be 3.5 cores.

	if [ $CPU_CORE -le $CPU_6CORE ]; then #If statement for low core systems.  Forces computers to only use 1 core if there are 4 cores or less on the system.
		export CPU_QUARTER_EVEN="2"
	else
		export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))
	fi

	echo "##########################################"
	echo "Number of Threads being used $CPU_QUARTER_EVEN"
	echo "##########################################"

	echo " "
	##############################Downloading Libraries############################

	cd Downloads
	wget -c https://github.com/madler/zlib/releases/download/v$Zlib_Version/zlib-$Zlib_Version.tar.gz
	wget -c https://github.com/HDFGroup/hdf5/releases/download/hdf5_$HDF5_Version/hdf5-$HDF5_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-c/archive/refs/tags/v$Netcdf_C_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-fortran/archive/refs/tags/v$Netcdf_Fortran_Version.tar.gz
	wget -c https://download.sourceforge.net/libpng/libpng-$Libpng_Version.tar.gz
	wget -c https://www.ece.uvic.ca/~frodo/jasper/software/jasper-$Jasper_Version.zip
	wget -c https://github.com/pmodels/mpich/releases/download/v$Mpich_Version/mpich-$Mpich_Version.tar.gz
	wget -c https://parallel-netcdf.github.io/Release/pnetcdf-$Pnetcdf_Version.tar.gz
	wget -c https://www.cmascenter.org/ioapi/download/ioapi-3.2.tar.gz

	echo " "
	####################################Compilers#####################################
	export CC=gcc
	export CXX=g++
	export FC=gfortran
	export F77=gfortran
	export CFLAGS="-fPIC -fPIE -O3"

	#IF statement for GNU compiler issue
	export GCC_VERSION=$(gcc -dumpfullversion | awk '{print$1}')
	export GFORTRAN_VERSION=$(gfortran -dumpfullversion | awk '{print$1}')
	export GPLUSPLUS_VERSION=$(g++ -dumpfullversion | awk '{print$1}')

	export GCC_VERSION_MAJOR_VERSION=$(echo $GCC_VERSION | awk -F. '{print $1}')
	export GFORTRAN_VERSION_MAJOR_VERSION=$(echo $GFORTRAN_VERSION | awk -F. '{print $1}')
	export GPLUSPLUS_VERSION_MAJOR_VERSION=$(echo $GPLUSPLUS_VERSION | awk -F. '{print $1}')

	export version_10="10"

	if [ $GCC_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GFORTRAN_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GPLUSPLUS_VERSION_MAJOR_VERSION -ge $version_10 ]; then
		export fallow_argument=-fallow-argument-mismatch
		export boz_argument=-fallow-invalid-boz
	else
		export fallow_argument=
		export boz_argument=
	fi

	export FFLAGS="$fallow_argument -m64"
	export FCFLAGS="$fallow_argument -m64"

	echo "##########################################"
	echo "FFLAGS = $FFLAGS"
	echo "FCFLAGS = $FCFLAGS"
	echo "CFLAGS = $CFLAGS"
	echo "##########################################"

	echo " "
	############################# ZLib ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf zlib-$Zlib_Version.tar.gz
	cd zlib-$Zlib_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	export ZLIB_ROOT=$DIR/grib2
	export ZLIBLIB=$DIR/grib2/lib
	export ZLIBINC=$DIR/grib2/include

	echo " "
	############################## MPICH ############################
	#F90= due to compiler issues with mpich install
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf mpich-$Mpich_Version.tar.gz
	cd mpich-$Mpich_Version/

	F90= ./configure --prefix=$DIR/MPICH --with-device=ch3 FFLAGS=$fallow_argument FCFLAGS=$fallow_argument 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/MPICH/bin:$PATH
	export MPIFC=$DIR/MPICH/bin/mpifort
	export MPIF77=$DIR/MPICH/bin/mpifort
	export MPIF90=$DIR/MPICH/bin/mpifort
	export MPICC=$DIR/MPICH/bin/mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx

	echo " "
	############################# libpng ############################

	cd "${WRF_FOLDER}"/Downloads

	# other libraries below need these variables to be set
	export LDFLAGS=-L$DIR/grib2/lib
	export CPPFLAGS=-I$DIR/grib2/include

	LD_LIBRARY_PATH= tar -xvzf libpng-$Libpng_Version.tar.gz
	cd libpng-$Libpng_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNG_ROOT=$DIR/grib2

	echo " "
	#############################JasPer ############################
	cd "${WRF_FOLDER}"/Downloads
	unzip jasper-$Jasper_Version.zip
	cd jasper-$Jasper_Version/

	./configure --prefix=$DIR/grib2
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	##make -j $CPU_QUARTER_EVEN check

	export JASPERLIB=$DIR/grib2/lib
	export JASPERINC=$DIR/grib2/include
	export JASPER_DIR=$DIR/grib2
	export Jasper_ROOT=$DIR/grib2/lib

	echo " "
	############################# hdf5 library for netcdf4 functionality ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf hdf5-$HDF5_Version.tar.gz
	cd hdf5-$HDF5_Version

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --with-zlib=$DIR/grib2 --enable-hl --enable-fortran --enable-parallel 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	##make -j $CPU_QUARTER_EVEN check

	export HDF5=$DIR/grib2
	export PATH=$HDF5/bin:$PATH
	export PHDF5=$DIR/grib2
	export HDF5_ROOT=$DIR/grib2
	export PHDF5_ROOT=$DIR/grib2

	echo " "
	############################# Install Parallel-netCDF ##############################
	#Make file created with half of available cpu cores
	#Hard path for MPI added
	##################################################################################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf pnetcdf-$Pnetcdf_Version.tar.gz
	cd pnetcdf-$Pnetcdf_Version
	export MPIFC=mpifort
	export MPIF77=mpifort
	export MPIF90=mpifort
	export MPICC=mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx
	CC=$MPICC FC=$MPIFC CXX=$MPICXX F90=$MPIF90 F77=$MPIF77 CFLAGS=$CFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --enable-static 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	##make -j $CPU_QUARTER_EVEN check

	export PNETCDF=$DIR/grib2
	export PNETCDF_DIR=$DIR/grib2
	export PNETCDF_ROOT=$DIR/grib2

	echo " "

	############################## Install NETCDF C Library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_C_Version.tar.gz
	cd netcdf-c-$Netcdf_C_Version/
	export CPPFLAGS=-I$DIR/grib2/include
	export LDFLAGS="-L$DIR/grib2/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lhdf5_hl -lhdf5 -lz -lcurl -lgfortran -lgcc -lm -ldl -lpnetcdf"
	echo $CFLAGS

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --disable-dap --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-pnetcdf --enable-cdf5 --enable-parallel-tests --enable-logging 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	##make -j $CPU_QUARTER_EVEN check

	export PATH=$DIR/NETCDF/bin:$PATH
	export NETCDF=$DIR/NETCDF
	export NETCDF_INC=$DIR/NETCDF/include
	export NETCDF_LIB=$DIR/NETCDF/lib
	export NETCDF_ROOT=$DIR/NETCDF
	export LD_LIBRARY_PATH=$DIR/grib2/lib:$DIR/NETCDF/lib:$LD_LIBRARY_PATH

	echo " "
	############################## NetCDF fortran library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_Fortran_Version.tar.gz
	cd netcdf-fortran-$Netcdf_Fortran_Version/
	export LD_LIBRARY_PATH=$DIR/NETCDF/lib:$LD_LIBRARY_PATH
	export CPPFLAGS="-I$DIR/NETCDF/include -I$DIR/grib2/include"
	export LDFLAGS="-L$DIR/NETCDF/lib -L$DIR/grib2/lib -Wl,-rpath,$DIR/NETCDF/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lnetcdf -lpnetcdf -lcurl -lhdf5_hl -lhdf5 -lz -lm -ldl -lgcc -lgfortran"
	echo $CFLAGS
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-parallel-tests --enable-logging --enable-hdf5 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	##make -j $CPU_QUARTER_EVEN check

	echo " "

	###############################  I/O API  ###################################

	cd "${WRF_FOLDER}"/Downloads
	mkdir ioapi
	cd ioapi
	LD_LIBRARY_PATH= tar -xvzf "${WRF_FOLDER}"/Downloads/ioapi-3.2.tar.gz

	#set gnu version
	export BIN=Linux2_x86_64gfort10
	export CPLMODE=nocpl
	mkdir $BIN

	#Link netcdf and grib lib folders to ioapi
	ln -sf "${WRF_FOLDER}"/Libs/NETCDF/lib/* "${WRF_FOLDER}"/Downloads/ioapi/$BIN
	ln -sf "${WRF_FOLDER}"/Libs/grib2/lib/* "${WRF_FOLDER}"/Downloads/ioapi/$BIN

	#copy makefiles from ioapi directory to source makefile
	#cp "${WRF_FOLDER}"/Downloads/ioapi/ioapi/Makefile.nocpl "${WRF_FOLDER}"/Downloads/ioapi/ioapi/Makefile
	#cp "${WRF_FOLDER}"/Downloads/ioapi/m3tools/Makefile.nocpl "${WRF_FOLDER}"/Downloads/ioapi/m3tools/Makefile
	cp "${WRF_FOLDER}"/Downloads/ioapi/Makefile.template "${WRF_FOLDER}"/Downloads/ioapi/Makefile

	# Add proper sed statements needed for gfortran
	sed -i '193s|-lnetcdff -lnetcdf| -lnetcdff -lnetcdf -lhdf5hl_fortran -lhdf5_fortran -lhdf5_hl -lhdf5 -ljpeg -lm -lz -lcurl|g' "${WRF_FOLDER}"/Downloads/ioapi/Makefile
	sed -i '210s|${IODIR}/Makefile ${TOOLDIR}/Makefile| |g' "${WRF_FOLDER}"/Downloads/ioapi/Makefile

	#Remove openmnp flags from Makefile
	sed -i '30s/ -fopenmp//g' "${WRF_FOLDER}"/Downloads/ioapi/ioapi/Makeinclude.$BIN
	sed -i '31s/ -fopenmp//g' "${WRF_FOLDER}"/Downloads/ioapi/ioapi/Makeinclude.$BIN

	# Build IOAPI
	make configure 2>&1 | tee configure.log
	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log

	#If statement to check that libioapi.a & m3xtract exist

	cd "${WRF_FOLDER}"/Downloads/ioapi/$BIN
	n=$(ls -lrt libioapi.a | wc -l)
	m=$(ls -rlt m3xtract | wc -l)
	if ((($n == 1) && ($m == 1))); then
		echo "All expected files created."

	else
		echo "Missing one or more expected files. Exiting the script."
		read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
		exit
	fi
	echo " "

	echo " "

	mv "${WRF_FOLDER}"/Downloads/ioapi/$BIN "${WRF_FOLDER}"/Downloads/ioapi/Linux2_x86_64gfort
	export BIN=Linux2_x86_64gfort
	#################################### System Environment Tests ##############

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_NETCDF_MPI_tests.tar
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_tests.tar

	LD_LIBRARY_PATH= tar -xvf Fortran_C_tests.tar -C "${WRF_FOLDER}"/Tests/Environment
	LD_LIBRARY_PATH= tar -xvf Fortran_C_NETCDF_MPI_tests.tar -C "${WRF_FOLDER}"/Tests/Compatibility

	export one="1"
	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Environment

	cp ${NETCDF}/include/netcdf.inc .

	echo " "
	echo " "
	echo "Environment Testing "
	echo "Test 1"
	$FC TEST_1_fortran_only_fixed.f
	./a.out | tee env_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 1 Passed"
	else
		echo "Environment Compiler Test 1 Failed"
		exit
	fi
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 2"
	$FC TEST_2_fortran_only_free.f90
	./a.out | tee env_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 2 Passed"
	else
		echo "Environment Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 3"
	$CC TEST_3_c_only.c
	./a.out | tee env_test3.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test3.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 3 Passed"
	else
		echo "Environment Compiler Test 3 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 4"
	$CC -c -m64 TEST_4_fortran+c_c.c
	$FC -c -m64 TEST_4_fortran+c_f.f90
	$FC -m64 TEST_4_fortran+c_f.o TEST_4_fortran+c_c.o
	./a.out | tee env_test4.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test4.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 4 Passed"
	else
		echo "Environment Compiler Test 4 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Compatibility

	cp ${NETCDF}/include/netcdf.inc .

	echo " "
	echo " "
	echo "Library Compatibility Tests "
	echo "Test 1"
	$FC -c 01_fortran+c+netcdf_f.f
	$CC -c 01_fortran+c+netcdf_c.c
	$FC 01_fortran+c+netcdf_f.o 01_fortran+c+netcdf_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	./a.out | tee comp_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 1 Passed"
	else
		echo "Compatibility Compiler Test 1 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "

	echo "Test 2"
	$MPIFC -c 02_fortran+c+netcdf+mpi_f.f
	$MPICC -c 02_fortran+c+netcdf+mpi_c.c
	$MPIFC 02_fortran+c+netcdf+mpi_f.o \
		02_fortran+c+netcdf+mpi_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	$DIR/MPICH/bin/mpirun ./a.out | tee comp_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 2 Passed"
	else
		echo "Compatibility Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."
	echo " "

	echo " All tests completed and passed"
	echo " "

	############################ CMAQ Source Code #################################
	cd "${WRF_FOLDER}"/Downloads
	git clone -b main https://github.com/USEPA/CMAQ.git #clone CMAQ github to WRF_CMAQ Main Folder

	cd CMAQ
	cp bldit_project.csh bldit_project.csh.old # Create backup of build project script

	# Set path to where CMAQ will be built
	sed -i '19s|/home/username/path|"${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}|g' "${WRF_FOLDER}"/Downloads/CMAQ/bldit_project.csh
	# Build CMAQ Project
	./bldit_project.csh

	cd "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}

	cp config_cmaq.csh config_cmaq.csh.old # Create backup of configure script

	# Sed statements to configure the Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}
	sed -i '146s|netcdf_root_gcc|"${WRF_FOLDER}"/Libs/NETCDF|g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/config_cmaq.csh
	sed -i '147s|ioapi_root_gcc|"${WRF_FOLDER}"/Downloads/ioapi|g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/config_cmaq.csh
	sed -i '148s|WRF_ARCH|WRF_ARCH 34|g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/config_cmaq.csh

	# sed statements for paths in configure file
	sed -i '151s|ioapi_inc_gcc|"${WRF_FOLDER}"/Downloads/ioapi/ioapi/fixed_src|g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/config_cmaq.csh
	sed -i '152s|ioapi_lib_gcc|"${WRF_FOLDER}"/Downloads/ioapi/$BIN|g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/config_cmaq.csh
	sed -i '153s|netcdf_lib_gcc |"${WRF_FOLDER}"/Libs/NETCDF/lib|g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/config_cmaq.csh
	sed -i '154s|netcdf_inc_gcc|"${WRF_FOLDER}"/Libs/NETCDF/include|g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/config_cmaq.csh
	sed -i '155s|netcdff_lib_gcc|"${WRF_FOLDER}"/Libs/NETCDF/lib|g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/config_cmaq.csh
	sed -i '156s|netcdff_inc_gcc|"${WRF_FOLDER}"/Libs/NETCDF/include|g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/config_cmaq.csh
	sed -i '157s|mpi_incl_gcc|"${WRF_FOLDER}"/Libs/MPICH|g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/config_cmaq.csh
	sed -i '158s|mpi_lib_gcc|"${WRF_FOLDER}"/Libs/MPICH|g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/config_cmaq.csh

	# compile the Chemistry Transport Model (CCTM) preprocess

	cd "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/CCTM/scripts

	cp bldit_cctm.csh bldit_cctm.csh.old # make a back up copy of .csh script

	# Sed statements for configuration
	sed -i '74s|-j|-j $CPU_QUARTER_EVEN|g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/CCTM/scripts/bldit_cctm.csh # set multicore to half of available cpus
	sed -i '84s|#set|set|g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/CCTM/scripts/bldit_cctm.csh                # build two way
	sed -i '100s|v4.4|v4.5.1|g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/CCTM/scripts/bldit_cctm.csh            # change wrf version from 4.4 to ${WPS_VERSION}

	sed -i '440s| if ( $? != 0 ) then| |g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/CCTM/scripts/bldit_cctm.csh
	sed -i '441s|    set shaID   = "not_a_repo"| |g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/CCTM/scripts/bldit_cctm.csh
	sed -i '442s| endif| |g' "${WRF_FOLDER}"/Downloads/CMAQ//Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/CCTM/scripts/bldit_cctm.csh
	sed -i '792s|  if ($? == 0) then| |g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/CCTM/scripts/bldit_cctm.csh
	sed -i '794s|  endif| |g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/CCTM/scripts/bldit_cctm.csh
	sed -i '806s|--branch|--recurse-submodule --branch|g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/CCTM/scripts/bldit_cctm.csh
	sed -i '823s|compile em_real|compile -j $CPU_QUARTER_EVEN em_real|g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/CCTM/scripts/bldit_cctm.csh
	# Build WRF-CMAQ
	./bldit_cctm.csh gcc 2>&1 | tee bldit.cctm.twoway.gcc.log

	# Move built folder to top level directory
	mv "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/CCTM/scripts/BLD_WRFv4.5.1_CCTM_v55_gcc/* "${WRF_FOLDER}"/WRF-${WRF_VERSION}_CMAQv${CMAQ_VERSION}

	export WRF_DIR="${WRF_FOLDER}"/WRF-${WRF_VERSION}_CMAQv${CMAQ_VERSION}

	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}_CMAQv${CMAQ_VERSION}/main
	n=$(ls ./*.exe | wc -l)
	if (($n >= 3)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files. Exiting the script."
		read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
		exit
	fi
	echo " "

	############################WPS#####################################
	## WPS v${WPS_VERSION}
	## Downloaded from git tagged releases
	#Option 3 for gfortran and distributed memory
	########################################################################

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/wrf-model/WPS/archive/refs/tags/v${WPS_VERSION}.tar.gz -O WPS-${WPS_VERSION}.tar.gz
	LD_LIBRARY_PATH= tar -xvzf WPS-${WPS_VERSION}.tar.gz -C "${WRF_FOLDER}"/
	# Check if WPS directory exists
	if [ -d "${WRF_FOLDER}/WPS" ]; then
		mv -f "${WRF_FOLDER}/WPS" "${WRF_FOLDER}/WPS-${WPS_VERSION}"

	# Else, check for any folder matching WPSV* or WPS-*
	else
		for dir in "${WRF_FOLDER}"/WPSV* "${WRF_FOLDER}"/WPS-*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WPS-${WPS_VERSION}"
				break
			fi
		done
	fi
	cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
	LD_LIBRARY_PATH= ./clean -a

	if [ ${auto_config} -eq 1 ]; then
		echo 3 | ./configure 2>&1 | tee configure.log #Option 3 for gfortran and distributed memory
	else
		./configure 2>&1 | tee configure.log #Option 3 gfortran compiler with distributed memory
	fi
	LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.wps.log

	echo " "
	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
	n=$(ls ./*.exe | wc -l)
	if (($n == 3)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WPS. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files. Exiting the script."
		read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
		exit
	fi
	echo " "

	######################## Static Geography Data inc/ Optional ####################
	# http://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html
	# These files are large so if you only need certain ones comment the others off
	# All files downloaded and untarred is 200GB
	# https://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html
	#################################################################################
	cd "${WRF_FOLDER}"/Downloads
	mkdir "${WRF_FOLDER}"/GEOG
	mkdir "${WRF_FOLDER}"/GEOG/WPS_GEOG

	echo " "
	echo "Mandatory WRF Preprocessing System (WPS) Geographical Input Data Mandatory Fields Downloads"
	echo " "
	wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_high_res_mandatory.tar.gz
	LD_LIBRARY_PATH= tar -xvzf geog_high_res_mandatory.tar.gz -C "${WRF_FOLDER}"/GEOG/

	wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_low_res_mandatory.tar.gz
	LD_LIBRARY_PATH= tar -xvzf geog_low_res_mandatory.tar.gz -C "${WRF_FOLDER}"/GEOG/
	mv "${WRF_FOLDER}"/GEOG/WPS_GEOG_LOW_RES/ "${WRF_FOLDER}"/GEOG/WPS_GEOG

	if [ ${WPS_Specific_Applications} -eq 1 ]; then
		echo " "
		echo " WPS Geographical Input Data Mandatory for Specific Applications"
		echo " "

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_thompson28_chem.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_thompson28_chem.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_noahmp.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_noahmp.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/irrigation.tar.gz
		LD_LIBRARY_PATH= tar -xvzf irrigation.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_px.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_px.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_urban.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_urban.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_ssib.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_ssib.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/lake_depth.tar.bz2
		LD_LIBRARY_PATH= tar -xvf lake_depth.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/topobath_30s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf topobath_30s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/gsl_gwd.tar.bz2
		LD_LIBRARY_PATH= tar -xvf gsl_gwd.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/cglc_modis_lcz_global.tar.gz
		LD_LIBRARY_PATH= tar -xvf cglc_modis_lcz_global.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

	fi

	if [ ${Optional_GEOG} -eq 1 ]; then
		echo " "
		echo "Optional WPS Geographical Input Data"
		echo " "

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_older_than_2000.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_older_than_2000.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/modis_landuse_20class_15s_with_lakes.tar.gz
		LD_LIBRARY_PATH= tar -xvzf modis_landuse_20class_15s_with_lakes.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_alt_lsm.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_alt_lsm.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/nlcd2006_ll_9s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf nlcd2006_ll_9s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/updated_Iceland_LU.tar.gz
		LD_LIBRARY_PATH= tar -xvf updated_Iceland_LU.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/modis_landuse_20class_15s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf modis_landuse_20class_15s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

	fi
fi

if [ "$RHL_64bit_GNU" = "2" ] && [ "$CMAQ_PICK" = "1" ]; then
	#############################basic package managment############################
	echo "old version of GNU detected"
	echo $PASSWD | sudo -S yum install epel-release -y
	echo $PASSWD | sudo -S yum install RHL-release-scl -y
	echo $PASSWD | sudo -S yum clean all
	echo $PASSWD | sudo -S yum remove devtoolset-11*
	echo $PASSWD | sudo -S yum install devtoolset-11
	echo $PASSWD | sudo -S yum install devtoolset-11-\* -y
	echo $PASSWD | sudo -S yum -y update
	echo $PASSWD | sudo -S yum -y upgrade

	source /opt/rh/devtoolset-11/enable
	gcc --version
	echo $PASSWD | sudo -S yum install epel-release -y
	echo $PASSWD | sudo -S yum install dnf -y
	echo $PASSWD | sudo -S dnf install epel-release -y
	echo $PASSWD | sudo -S dnf install dnf -y
	echo $PASSWD | sudo -S dnf -y update
	echo $PASSWD | sudo -S dnf -y upgrade
	echo $PASSWD | sudo -S dnf -y install bzip2 bzip2-devel byacc cairo-devel cmake cpp curl curl-devel flex fontconfig fontconfig-devel gcc gcc-c++ gcc-gfortran git java-11-openjdk java-11-openjdk-devel ksh libjpeg libjpeg-devel libX11 libX11-devel libXaw libXaw-devel libXext-devel libXmu libXmu-devel libXrender libXrender-devel libXt libXt-devel libxml2 libxml2-devel libXmu libXmu-devel libgeotiff libgeotiff-devel libtiff libtiff-devel m4 nfs-utils perl pkgconfig pixman pixman-devel python3 python3-devel tcsh time unzip wget
	echo $PASSWD | sudo -S dnf -y groupinstall "Development Tools"
	echo $PASSWD | sudo -S dnf -y update
	echo $PASSWD | sudo -S dnf -y upgrade
	source /opt/rh/devtoolset-11/enable
	echo " "
	##############################Directory Listing############################
	export HOME=$(
		cd
		pwd
	)

	mkdir $HOME/WRF_CMAQ
	export WRF_FOLDER=$HOME/WRF_CMAQ
	cd "${WRF_FOLDER}"/
	mkdir Downloads
	mkdir Libs
	export DIR="${WRF_FOLDER}"/Libs
	mkdir Libs/grib2
	mkdir Libs/NETCDF
	mkdir Libs/MPICH
	mkdir -p Tests/Environment
	mkdir -p Tests/Compatibility

	echo " "
	#############################Core Management####################################

	export CPU_CORE=$(nproc) # number of available threads on system
	export CPU_6CORE="6"
	export CPU_QUARTER=$(($CPU_CORE / 4))                          #quarter of availble cores on system
	export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2))) #Forces CPU cores to even number to avoid partial core export. ie 7 cores would be 3.5 cores.

	if [ $CPU_CORE -le $CPU_6CORE ]; then #If statement for low core systems.  Forces computers to only use 1 core if there are 4 cores or less on the system.
		export CPU_QUARTER_EVEN="2"
	else
		export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))
	fi

	echo "##########################################"
	echo "Number of Threads being used $CPU_QUARTER_EVEN"
	echo "##########################################"

	echo " "
	##############################Downloading Libraries############################

	cd Downloads
	wget -c https://github.com/madler/zlib/releases/download/v$Zlib_Version/zlib-$Zlib_Version.tar.gz
	wget -c https://github.com/HDFGroup/hdf5/releases/download/hdf5_$HDF5_Version/hdf5-$HDF5_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-c/archive/refs/tags/v$Netcdf_C_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-fortran/archive/refs/tags/v$Netcdf_Fortran_Version.tar.gz
	wget -c https://download.sourceforge.net/libpng/libpng-$Libpng_Version.tar.gz
	wget -c https://www.ece.uvic.ca/~frodo/jasper/software/jasper-$Jasper_Version.zip
	wget -c https://github.com/pmodels/mpich/releases/download/v$Mpich_Version/mpich-$Mpich_Version.tar.gz
	wget -c https://parallel-netcdf.github.io/Release/pnetcdf-$Pnetcdf_Version.tar.gz
	wget -c https://www.cmascenter.org/ioapi/download/ioapi-3.2.tar.gz

	echo " "
	####################################Compilers#####################################
	export CC=gcc
	export CXX=g++
	export FC=gfortran
	export F77=gfortran
	export CFLAGS="-fPIC -fPIE -O3"

	#IF statement for GNU compiler issue
	export GCC_VERSION=$(gcc -dumpfullversion | awk '{print$1}')
	export GFORTRAN_VERSION=$(gfortran -dumpfullversion | awk '{print$1}')
	export GPLUSPLUS_VERSION=$(g++ -dumpfullversion | awk '{print$1}')

	export GCC_VERSION_MAJOR_VERSION=$(echo $GCC_VERSION | awk -F. '{print $1}')
	export GFORTRAN_VERSION_MAJOR_VERSION=$(echo $GFORTRAN_VERSION | awk -F. '{print $1}')
	export GPLUSPLUS_VERSION_MAJOR_VERSION=$(echo $GPLUSPLUS_VERSION | awk -F. '{print $1}')

	export version_10="10"

	if [ $GCC_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GFORTRAN_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GPLUSPLUS_VERSION_MAJOR_VERSION -ge $version_10 ]; then
		export fallow_argument=-fallow-argument-mismatch
		export boz_argument=-fallow-invalid-boz
	else
		export fallow_argument=
		export boz_argument=
	fi

	export FFLAGS="$fallow_argument -m64"
	export FCFLAGS="$fallow_argument -m64"

	echo "##########################################"
	echo "FFLAGS = $FFLAGS"
	echo "FCFLAGS = $FCFLAGS"
	echo "CFLAGS = $CFLAGS"
	echo "##########################################"

	echo " "
	############################# ZLib ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf zlib-$Zlib_Version.tar.gz
	cd zlib-$Zlib_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	export ZLIB_ROOT=$DIR/grib2
	export ZLIBLIB=$DIR/grib2/lib
	export ZLIBINC=$DIR/grib2/include

	echo " "
	############################## MPICH ############################
	#F90= due to compiler issues with mpich install
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf mpich-$Mpich_Version.tar.gz
	cd mpich-$Mpich_Version/

	F90= ./configure --prefix=$DIR/MPICH --with-device=ch3 FFLAGS=$fallow_argument FCFLAGS=$fallow_argument 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/MPICH/bin:$PATH
	export MPIFC=$DIR/MPICH/bin/mpifort
	export MPIF77=$DIR/MPICH/bin/mpifort
	export MPIF90=$DIR/MPICH/bin/mpifort
	export MPICC=$DIR/MPICH/bin/mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx

	echo " "
	############################# libpng ############################

	cd "${WRF_FOLDER}"/Downloads

	# other libraries below need these variables to be set
	export LDFLAGS=-L$DIR/grib2/lib
	export CPPFLAGS=-I$DIR/grib2/include

	LD_LIBRARY_PATH= tar -xvzf libpng-$Libpng_Version.tar.gz
	cd libpng-$Libpng_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNG_ROOT=$DIR/grib2

	echo " "
	#############################JasPer ############################
	cd "${WRF_FOLDER}"/Downloads
	unzip jasper-$Jasper_Version.zip
	cd jasper-$Jasper_Version/

	./configure --prefix=$DIR/grib2
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	#make -j $CPU_QUARTER_EVEN check

	export JASPERLIB=$DIR/grib2/lib
	export JASPERINC=$DIR/grib2/include
	export JASPER_DIR=$DIR/grib2
	export Jasper_ROOT=$DIR/grib2/lib

	echo " "
	############################# hdf5 library for netcdf4 functionality ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf hdf5-$HDF5_Version.tar.gz
	cd hdf5-$HDF5_Version

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --with-zlib=$DIR/grib2 --enable-hl --enable-fortran --enable-parallel 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	##make -j $CPU_QUARTER_EVEN check

	export HDF5=$DIR/grib2
	export PATH=$HDF5/bin:$PATH
	export PHDF5=$DIR/grib2
	export HDF5_ROOT=$DIR/grib2
	export PHDF5_ROOT=$DIR/grib2

	echo " "
	############################# Install Parallel-netCDF ##############################
	#Make file created with half of available cpu cores
	#Hard path for MPI added
	##################################################################################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf pnetcdf-$Pnetcdf_Version.tar.gz
	cd pnetcdf-$Pnetcdf_Version
	export MPIFC=mpifort
	export MPIF77=mpifort
	export MPIF90=mpifort
	export MPICC=mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx
	CC=$MPICC FC=$MPIFC CXX=$MPICXX F90=$MPIF90 F77=$MPIF77 CFLAGS=$CFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --enable-static 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	##make -j $CPU_QUARTER_EVEN check

	export PNETCDF=$DIR/grib2
	export PNETCDF_DIR=$DIR/grib2
	export PNETCDF_ROOT=$DIR/grib2

	echo " "

	############################## Install NETCDF C Library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_C_Version.tar.gz
	cd netcdf-c-$Netcdf_C_Version/
	export CPPFLAGS=-I$DIR/grib2/include
	export LDFLAGS="-L$DIR/grib2/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lhdf5_hl -lhdf5 -lz -lcurl -lgfortran -lgcc -lm -ldl -lpnetcdf"
	echo $CFLAGS

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --disable-dap --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-pnetcdf --enable-cdf5 --enable-parallel-tests --enable-logging 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	#make -j $CPU_QUARTER_EVEN check

	export PATH=$DIR/NETCDF/bin:$PATH
	export NETCDF=$DIR/NETCDF
	export NETCDF_INC=$DIR/NETCDF/include
	export NETCDF_LIB=$DIR/NETCDF/lib
	export NETCDF_ROOT=$DIR/NETCDF
	export LD_LIBRARY_PATH=$DIR/grib2/lib:$DIR/NETCDF/lib:$LD_LIBRARY_PATH

	echo " "
	############################## NetCDF fortran library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_Fortran_Version.tar.gz
	cd netcdf-fortran-$Netcdf_Fortran_Version/
	export LD_LIBRARY_PATH=$DIR/NETCDF/lib:$LD_LIBRARY_PATH
	export CPPFLAGS="-I$DIR/NETCDF/include -I$DIR/grib2/include"
	export LDFLAGS="-L$DIR/NETCDF/lib -L$DIR/grib2/lib -Wl,-rpath,$DIR/NETCDF/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lnetcdf -lpnetcdf -lcurl -lhdf5_hl -lhdf5 -lz -lm -ldl -lgcc -lgfortran"
	echo $CFLAGS
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-parallel-tests --enable-logging --enable-hdf5 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	##make -j $CPU_QUARTER_EVEN check

	echo " "

	###############################  I/O API  ###################################

	cd "${WRF_FOLDER}"/Downloads
	mkdir ioapi
	cd ioapi
	LD_LIBRARY_PATH= tar -xvzf "${WRF_FOLDER}"/Downloads/ioapi-3.2.tar.gz

	#set gnu version
	export BIN=Linux2_x86_64gfort10
	export CPLMODE=nocpl
	mkdir $BIN

	#Link netcdf and grib lib folders to ioapi
	ln -sf "${WRF_FOLDER}"/Libs/NETCDF/lib/* "${WRF_FOLDER}"/Downloads/ioapi/$BIN
	ln -sf "${WRF_FOLDER}"/Libs/grib2/lib/* "${WRF_FOLDER}"/Downloads/ioapi/$BIN

	#copy makefiles from ioapi directory to source makefile
	#cp "${WRF_FOLDER}"/Downloads/ioapi/ioapi/Makefile.nocpl "${WRF_FOLDER}"/Downloads/ioapi/ioapi/Makefile
	#cp "${WRF_FOLDER}"/Downloads/ioapi/m3tools/Makefile.nocpl "${WRF_FOLDER}"/Downloads/ioapi/m3tools/Makefile
	cp "${WRF_FOLDER}"/Downloads/ioapi/Makefile.template "${WRF_FOLDER}"/Downloads/ioapi/Makefile

	# Add proper sed statements needed for gfortran
	sed -i '193s|-lnetcdff -lnetcdf| -lnetcdff -lnetcdf -lhdf5hl_fortran -lhdf5_fortran -lhdf5_hl -lhdf5 -ljpeg -lm -lz -lcurl|g' "${WRF_FOLDER}"/Downloads/ioapi/Makefile
	sed -i '210s|${IODIR}/Makefile ${TOOLDIR}/Makefile| |g' "${WRF_FOLDER}"/Downloads/ioapi/Makefile

	#Remove openmnp flags from Makefile
	sed -i '30s/ -fopenmp//g' "${WRF_FOLDER}"/Downloads/ioapi/ioapi/Makeinclude.$BIN
	sed -i '31s/ -fopenmp//g' "${WRF_FOLDER}"/Downloads/ioapi/ioapi/Makeinclude.$BIN

	# Build IOAPI
	make configure 2>&1 | tee configure.log
	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log

	#If statement to check that libioapi.a & m3xtract exist

	cd "${WRF_FOLDER}"/Downloads/ioapi/$BIN
	n=$(ls -lrt libioapi.a | wc -l)
	m=$(ls -rlt m3xtract | wc -l)
	if ((($n == 1) && ($m == 1))); then
		echo "All expected files created."

	else
		echo "Missing one or more expected files. Exiting the script."
		read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
		exit
	fi
	echo " "

	echo " "

	mv "${WRF_FOLDER}"/Downloads/ioapi/$BIN "${WRF_FOLDER}"/Downloads/ioapi/Linux2_x86_64gfort
	export BIN=Linux2_x86_64gfort
	#################################### System Environment Tests ##############

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_NETCDF_MPI_tests.tar
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_tests.tar

	LD_LIBRARY_PATH= tar -xvf Fortran_C_tests.tar -C "${WRF_FOLDER}"/Tests/Environment
	LD_LIBRARY_PATH= tar -xvf Fortran_C_NETCDF_MPI_tests.tar -C "${WRF_FOLDER}"/Tests/Compatibility

	export one="1"
	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Environment

	cp ${NETCDF}/include/netcdf.inc .

	echo " "
	echo " "
	echo "Environment Testing "
	echo "Test 1"
	$FC TEST_1_fortran_only_fixed.f
	./a.out | tee env_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 1 Passed"
	else
		echo "Environment Compiler Test 1 Failed"
		exit
	fi
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 2"
	$FC TEST_2_fortran_only_free.f90
	./a.out | tee env_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 2 Passed"
	else
		echo "Environment Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 3"
	$CC TEST_3_c_only.c
	./a.out | tee env_test3.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test3.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 3 Passed"
	else
		echo "Environment Compiler Test 3 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 4"
	$CC -c -m64 TEST_4_fortran+c_c.c
	$FC -c -m64 TEST_4_fortran+c_f.f90
	$FC -m64 TEST_4_fortran+c_f.o TEST_4_fortran+c_c.o
	./a.out | tee env_test4.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test4.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 4 Passed"
	else
		echo "Environment Compiler Test 4 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Compatibility

	cp ${NETCDF}/include/netcdf.inc .

	echo " "
	echo " "
	echo "Library Compatibility Tests "
	echo "Test 1"
	$FC -c 01_fortran+c+netcdf_f.f
	$CC -c 01_fortran+c+netcdf_c.c
	$FC 01_fortran+c+netcdf_f.o 01_fortran+c+netcdf_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	./a.out | tee comp_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 1 Passed"
	else
		echo "Compatibility Compiler Test 1 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "

	echo "Test 2"
	$MPIFC -c 02_fortran+c+netcdf+mpi_f.f
	$MPICC -c 02_fortran+c+netcdf+mpi_c.c
	$MPIFC 02_fortran+c+netcdf+mpi_f.o \
		02_fortran+c+netcdf+mpi_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	$DIR/MPICH/bin/mpirun ./a.out | tee comp_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 2 Passed"
	else
		echo "Compatibility Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."
	echo " "

	echo " All tests completed and passed"
	echo " "

	############################ CMAQ Source Code #################################
	cd "${WRF_FOLDER}"/Downloads
	git clone -b main https://github.com/USEPA/CMAQ.git #clone CMAQ github to WRF_CMAQ Main Folder

	cd CMAQ
	cp bldit_project.csh bldit_project.csh.old # Create backup of build project script

	# Set path to where CMAQ will be built
	sed -i '19s|/home/username/path|"${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}|g' "${WRF_FOLDER}"/Downloads/CMAQ/bldit_project.csh
	# Build CMAQ Project
	./bldit_project.csh

	cd "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}

	cp config_cmaq.csh config_cmaq.csh.old # Create backup of configure script

	# Sed statements to configure the Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}
	sed -i '146s|netcdf_root_gcc|"${WRF_FOLDER}"/Libs/NETCDF|g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/config_cmaq.csh
	sed -i '147s|ioapi_root_gcc|"${WRF_FOLDER}"/Downloads/ioapi|g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/config_cmaq.csh
	sed -i '148s|WRF_ARCH|WRF_ARCH 34|g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/config_cmaq.csh

	# sed statements for paths in configure file
	sed -i '151s|ioapi_inc_gcc|"${WRF_FOLDER}"/Downloads/ioapi/ioapi/fixed_src|g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/config_cmaq.csh
	sed -i '152s|ioapi_lib_gcc|"${WRF_FOLDER}"/Downloads/ioapi/$BIN|g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/config_cmaq.csh
	sed -i '153s|netcdf_lib_gcc |"${WRF_FOLDER}"/Libs/NETCDF/lib|g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/config_cmaq.csh
	sed -i '154s|netcdf_inc_gcc|"${WRF_FOLDER}"/Libs/NETCDF/include|g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/config_cmaq.csh
	sed -i '155s|netcdff_lib_gcc|"${WRF_FOLDER}"/Libs/NETCDF/lib|g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/config_cmaq.csh
	sed -i '156s|netcdff_inc_gcc|"${WRF_FOLDER}"/Libs/NETCDF/include|g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/config_cmaq.csh
	sed -i '157s|mpi_incl_gcc|"${WRF_FOLDER}"/Libs/MPICH|g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/config_cmaq.csh
	sed -i '158s|mpi_lib_gcc|"${WRF_FOLDER}"/Libs/MPICH|g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/config_cmaq.csh

	# compile the Chemistry Transport Model (CCTM) preprocess

	cd "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/CCTM/scripts

	cp bldit_cctm.csh bldit_cctm.csh.old # make a back up copy of .csh script

	# Sed statements for configuration
	sed -i '74s|-j|-j $CPU_QUARTER_EVEN|g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/CCTM/scripts/bldit_cctm.csh # set multicore to half of available cpus
	sed -i '84s|#set|set|g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/CCTM/scripts/bldit_cctm.csh                # build two way
	sed -i '100s|v4.4|v4.5.1|g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/CCTM/scripts/bldit_cctm.csh            # change wrf version from 4.4 to ${WPS_VERSION}

	sed -i '440s| if ( $? != 0 ) then| |g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/CCTM/scripts/bldit_cctm.csh
	sed -i '441s|    set shaID   = "not_a_repo"| |g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/CCTM/scripts/bldit_cctm.csh
	sed -i '442s| endif| |g' "${WRF_FOLDER}"/Downloads/CMAQ//Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/CCTM/scripts/bldit_cctm.csh
	sed -i '792s|  if ($? == 0) then| |g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/CCTM/scripts/bldit_cctm.csh
	sed -i '794s|  endif| |g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/CCTM/scripts/bldit_cctm.csh
	sed -i '806s|--branch|--recurse-submodule --branch|g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/CCTM/scripts/bldit_cctm.csh
	sed -i '823s|compile em_real|compile -j $CPU_QUARTER_EVEN em_real|g' "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/CCTM/scripts/bldit_cctm.csh

	# Build WRF-CMAQ
	./bldit_cctm.csh gcc 2>&1 | tee bldit.cctm.twoway.gcc.log

	# Move built folder to top level directory
	mv "${WRF_FOLDER}"/Downloads/CMAQ/Build_WRFv4.5.1-CMAQv${CMAQ_VERSION}/CCTM/scripts/BLD_WRFv4.5.1_CCTM_v55_gcc/* "${WRF_FOLDER}"/WRF-${WRF_VERSION}_CMAQv${CMAQ_VERSION}

	export WRF_DIR="${WRF_FOLDER}"/WRF-${WRF_VERSION}_CMAQv${CMAQ_VERSION}

	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}_CMAQv${CMAQ_VERSION}/main
	n=$(ls ./*.exe | wc -l)
	if (($n >= 3)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files. Exiting the script."
		read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
		exit
	fi
	echo " "

	############################WPS#####################################
	## WPS v${WPS_VERSION}
	## Downloaded from git tagged releases
	#Option 3 for gfortran and distributed memory
	########################################################################

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/wrf-model/WPS/archive/refs/tags/v${WPS_VERSION}.tar.gz -O WPS-${WPS_VERSION}.tar.gz
	LD_LIBRARY_PATH= tar -xvzf WPS-${WPS_VERSION}.tar.gz -C "${WRF_FOLDER}"/
	# Check if WPS directory exists
	if [ -d "${WRF_FOLDER}/WPS" ]; then
		mv -f "${WRF_FOLDER}/WPS" "${WRF_FOLDER}/WPS-${WPS_VERSION}"

	# Else, check for any folder matching WPSV* or WPS-*
	else
		for dir in "${WRF_FOLDER}"/WPSV* "${WRF_FOLDER}"/WPS-*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WPS-${WPS_VERSION}"
				break
			fi
		done
	fi
	cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
	LD_LIBRARY_PATH= ./clean -a

	if [ ${auto_config} -eq 1 ]; then
		echo 3 | ./configure 2>&1 | tee configure.log #Option 3 for gfortran and distributed memory
	else
		./configure 2>&1 | tee configure.log #Option 3 gfortran compiler with distributed memory
	fi
	LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.wps.log

	echo " "
	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
	n=$(ls ./*.exe | wc -l)
	if (($n == 3)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WPS. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files. Exiting the script."
		read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
		exit
	fi
	echo " "

	######################## Static Geography Data inc/ Optional ####################
	# http://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html
	# These files are large so if you only need certain ones comment the others off
	# All files downloaded and untarred is 200GB
	# https://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html
	#################################################################################
	cd "${WRF_FOLDER}"/Downloads
	mkdir "${WRF_FOLDER}"/GEOG
	mkdir "${WRF_FOLDER}"/GEOG/WPS_GEOG

	echo " "
	echo "Mandatory WRF Preprocessing System (WPS) Geographical Input Data Mandatory Fields Downloads"
	echo " "
	wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_high_res_mandatory.tar.gz
	LD_LIBRARY_PATH= tar -xvzf geog_high_res_mandatory.tar.gz -C "${WRF_FOLDER}"/GEOG/

	wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_low_res_mandatory.tar.gz
	LD_LIBRARY_PATH= tar -xvzf geog_low_res_mandatory.tar.gz -C "${WRF_FOLDER}"/GEOG/
	mv "${WRF_FOLDER}"/GEOG/WPS_GEOG_LOW_RES/ "${WRF_FOLDER}"/GEOG/WPS_GEOG

	if [ ${WPS_Specific_Applications} -eq 1 ]; then
		echo " "
		echo " WPS Geographical Input Data Mandatory for Specific Applications"
		echo " "

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_thompson28_chem.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_thompson28_chem.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_noahmp.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_noahmp.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/irrigation.tar.gz
		LD_LIBRARY_PATH= tar -xvzf irrigation.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_px.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_px.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_urban.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_urban.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_ssib.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_ssib.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/lake_depth.tar.bz2
		LD_LIBRARY_PATH= tar -xvf lake_depth.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/topobath_30s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf topobath_30s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/gsl_gwd.tar.bz2
		LD_LIBRARY_PATH= tar -xvf gsl_gwd.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/cglc_modis_lcz_global.tar.gz
		LD_LIBRARY_PATH= tar -xvf cglc_modis_lcz_global.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG
	fi

	if [ ${Optional_GEOG} -eq 1 ]; then
		echo " "
		echo "Optional WPS Geographical Input Data"
		echo " "

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_older_than_2000.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_older_than_2000.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/modis_landuse_20class_15s_with_lakes.tar.gz
		LD_LIBRARY_PATH= tar -xvzf modis_landuse_20class_15s_with_lakes.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_alt_lsm.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_alt_lsm.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/nlcd2006_ll_9s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf nlcd2006_ll_9s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/updated_Iceland_LU.tar.gz
		LD_LIBRARY_PATH= tar -xvf updated_Iceland_LU.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/modis_landuse_20class_15s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf modis_landuse_20class_15s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

	fi
fi

############################################# WRF SFIRE #################################
## WRF_SFIRE installation with parallel process.
# Download and install required library and data files for WRF_SFIRE.
# Tested in Ubuntu 22.04 & 24.04, Rocky Linux 9 & MacOS Ventura 64bit
# Built in 64-bit system
# Built with Intel or GNU compilers
# Tested with current available libraries on 03/01/2025
# If newer libraries exist edit script paths for changes
#Estimated Run Time ~ 30 - 60 Minutes with 10mb/s downloadspeed.
# Special thanks to:
# Youtube's meteoadriatic, GitHub user jamal919.
# University of Manchester's  Doug L
# University of Tunis El Manar's Hosni
# GSL's Jordan S.
# NCAR's Mary B., Christine W., & Carl D.
# DTC's Julie P., Tara J., George M., & John H.
# UCAR's Katelyn F., Jim B., Jordan P., Kevin M.,
# University of Colorado Denver's Jan M.
##############################################################

if [ "$Ubuntu_64bit_GNU" = "1" ] && [ "$SFIRE_PICK" = "1" ]; then
	#############################basic package managment############################
	echo $PASSWD | sudo -S apt -y update
	echo $PASSWD | sudo -S apt -y upgrade

	release_version=$(lsb_release -r -s)

	# Compare the release version
	if [ "$release_version" = "24.04" ]; then
		# Install Emacs without recommended packages
		echo $PASSWD | sudo -S apt install emacs --no-install-recommends -y
	else
		# Attempt to install Emacs if the release version is not 24.04
		echo "The release version is not 24.04, attempting to install Emacs."
		echo $PASSWD | sudo -S apt install emacs -y
	fi

	echo $PASSWD | sudo -S apt -y install bison build-essential byacc cmake csh curl default-jdk default-jre flex libfl-dev g++ gawk gcc gettext gfortran git ksh libcurl4-gnutls-dev libjpeg-dev libncurses6 libpixman-1-dev libpng-dev libtool libxml2 libxml2-dev m4 make ncview pipenv pkg-config python3 python3-dev python3-pip python3-dateutil tcsh unzip xauth xorg time libgeotiff-dev

	echo " "
	##############################Directory Listing############################
	export HOME=$(
		cd
		pwd
	)

	mkdir $HOME/WRF_SFIRE
	export WRF_FOLDER=$HOME/WRF_SFIRE
	cd "${WRF_FOLDER}"/
	mkdir Downloads
	mkdir Libs
	export DIR="${WRF_FOLDER}"/Libs
	mkdir Libs/grib2
	mkdir Libs/NETCDF
	mkdir Libs/MPICH
	mkdir -p Tests/Environment
	mkdir -p Tests/Compatibility

	echo " "
	#############################Core Management####################################

	export CPU_CORE=$(nproc) # number of available threads on system
	export CPU_6CORE="6"
	export CPU_QUARTER=$(($CPU_CORE / 4))                          #quarter of availble cores on system
	export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2))) #Forces CPU cores to even number to avoid partial core export. ie 7 cores would be 3.5 cores.

	if [ $CPU_CORE -le $CPU_6CORE ]; then #If statement for low core systems.  Forces computers to only use 1 core if there are 4 cores or less on the system.
		export CPU_QUARTER_EVEN="2"
	else
		export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))
	fi

	echo "##########################################"
	echo "Number of Threads being used $CPU_QUARTER_EVEN"
	echo "##########################################"

	echo " "
	##############################Downloading Libraries############################
	cd Downloads
	wget -c https://github.com/madler/zlib/releases/download/v$Zlib_Version/zlib-$Zlib_Version.tar.gz
	wget -c https://github.com/HDFGroup/hdf5/releases/download/hdf5_$HDF5_Version/hdf5-$HDF5_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-c/archive/refs/tags/v$Netcdf_C_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-fortran/archive/refs/tags/v$Netcdf_Fortran_Version.tar.gz
	wget -c https://download.sourceforge.net/libpng/libpng-$Libpng_Version.tar.gz
	wget -c https://www.ece.uvic.ca/~frodo/jasper/software/jasper-$Jasper_Version.zip
	wget -c https://github.com/pmodels/mpich/releases/download/v$Mpich_Version/mpich-$Mpich_Version.tar.gz
	wget -c https://parallel-netcdf.github.io/Release/pnetcdf-$Pnetcdf_Version.tar.gz
	wget -c https://github.com/openwfm/convert_geotiff/releases/download/v0.1/convert_geotiff-0.1.0.tar.gz

	echo " "
	####################################Compilers#####################################
	export CC=gcc
	export CXX=g++
	export FC=gfortran
	export F77=gfortran
	export CFLAGS="-fPIC -fPIE -O3"

	#IF statement for GNU compiler issue
	export GCC_VERSION=$(/usr/bin/gcc -dumpfullversion | awk '{print$1}')
	export GFORTRAN_VERSION=$(/usr/bin/gfortran -dumpfullversion | awk '{print$1}')
	export GPLUSPLUS_VERSION=$(/usr/bin/g++ -dumpfullversion | awk '{print$1}')

	export GCC_VERSION_MAJOR_VERSION=$(echo $GCC_VERSION | awk -F. '{print $1}')
	export GFORTRAN_VERSION_MAJOR_VERSION=$(echo $GFORTRAN_VERSION | awk -F. '{print $1}')
	export GPLUSPLUS_VERSION_MAJOR_VERSION=$(echo $GPLUSPLUS_VERSION | awk -F. '{print $1}')

	export version_10="10"

	if [ $GCC_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GFORTRAN_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GPLUSPLUS_VERSION_MAJOR_VERSION -ge $version_10 ]; then
		export fallow_argument=-fallow-argument-mismatch
		export boz_argument=-fallow-invalid-boz
	else
		export fallow_argument=
		export boz_argument=
	fi

	export FFLAGS="$fallow_argument -m64"
	export FCFLAGS="$fallow_argument -m64"

	echo "##########################################"
	echo "FFLAGS = $FFLAGS"
	echo "FCFLAGS = $FCFLAGS"
	echo "##########################################"

	echo " "
	############################# ZLib ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf zlib-$Zlib_Version.tar.gz
	cd zlib-$Zlib_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	export ZLIB_ROOT=$DIR/grib2
	export ZLIBLIB=$DIR/grib2/lib
	export ZLIBINC=$DIR/grib2/include

	echo " "
	############################## MPICH ############################
	#F90= due to compiler issues with mpich install
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf mpich-$Mpich_Version.tar.gz
	cd mpich-$Mpich_Version/
	F90= ./configure --prefix=$DIR/MPICH --with-device=ch3 FFLAGS=$fallow_argument FCFLAGS=$fallow_argument 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/MPICH/bin:$PATH

	export MPIFC=$DIR/MPICH/bin/mpifort
	export MPIF77=$DIR/MPICH/bin/mpifort
	export MPIF90=$DIR/MPICH/bin/mpifort
	export MPICC=$DIR/MPICH/bin/mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx

	echo " "
	############################# libpng ############################

	cd "${WRF_FOLDER}"/Downloads

	# other libraries below need these variables to be set
	export LDFLAGS=-L$DIR/grib2/lib
	export CPPFLAGS=-I$DIR/grib2/include

	LD_LIBRARY_PATH= tar -xvzf libpng-$Libpng_Version.tar.gz
	cd libpng-$Libpng_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNG_ROOT=$DIR/grib2

	echo " "
	#############################JasPer ############################
	cd "${WRF_FOLDER}"/Downloads
	unzip jasper-$Jasper_Version.zip
	cd jasper-$Jasper_Version/
	./configure --prefix=$DIR/grib2
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export JASPERLIB=$DIR/grib2/lib
	export JASPERINC=$DIR/grib2/include
	export JASPER_DIR=$DIR/grib2
	export Jasper_ROOT=$DIR/grib2/lib

	echo " "
	############################# hdf5 library for netcdf4 functionality ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf hdf5-$HDF5_Version.tar.gz
	cd hdf5-$HDF5_Version
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --with-zlib=$DIR/grib2 --enable-hl --enable-fortran --enable-parallel 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export HDF5=$DIR/grib2
	export PATH=$HDF5/bin:$PATH
	export PHDF5=$DIR/grib2
	export HDF5_ROOT=$DIR/grib2
	export PHDF5_ROOT=$DIR/grib2

	echo " "
	############################# Install Parallel-netCDF ##############################
	#Make file created with half of available cpu cores
	#Hard path for MPI added
	##################################################################################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf pnetcdf-$Pnetcdf_Version.tar.gz
	cd pnetcdf-$Pnetcdf_Version
	export MPIFC=$DIR/MPICH/bin/mpifort
	export MPIF77=$DIR/MPICH/bin/mpifort
	export MPIF90=$DIR/MPICH/bin/mpifort
	export MPICC=$DIR/MPICH/bin/mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --enable-static 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNETCDF=$DIR/grib2
	export PNETCDF_DIR=$DIR/grib2
	export PNETCDF_ROOT=$DIR/grib2

	############################## Install NETCDF C Library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_C_Version.tar.gz
	cd netcdf-c-$Netcdf_C_Version/
	export CPPFLAGS=-I$DIR/grib2/include
	export LDFLAGS="-L$DIR/grib2/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lhdf5_hl -lhdf5 -lz -lcurl -lgfortran -lgcc -lm -ldl -lpnetcdf"
	CC=$MPICC FC=$MPIFC CXX=$MPICXX F90=$MPIF90 F77=$MPIF77 CFLAGS=$CFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --disable-dap --enable-netcdf-4 --enable-netcdf4 --enable-pnetcdf --enable-cdf5 --enable-parallel-tests --enable-logging 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/NETCDF/bin:$PATH
	export NETCDF=$DIR/NETCDF
	export NETCDF_INC=$DIR/NETCDF/include
	export NETCDF_LIB=$DIR/NETCDF/lib
	export NETCDF_ROOT=$DIR/NETCDF
	export LD_LIBRARY_PATH=$DIR/grib2/lib:$DIR/NETCDF/lib:$LD_LIBRARY_PATH

	echo " "
	############################## NetCDF fortran library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_Fortran_Version.tar.gz
	cd netcdf-fortran-$Netcdf_Fortran_Version/
	export LD_LIBRARY_PATH=$DIR/NETCDF/lib:$LD_LIBRARY_PATH
	export CPPFLAGS="-I$DIR/NETCDF/include -I$DIR/grib2/include"
	export LDFLAGS="-L$DIR/NETCDF/lib -L$DIR/grib2/lib -Wl,-rpath,$DIR/NETCDF/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lnetcdf -lpnetcdf -lcurl -lhdf5_hl -lhdf5 -lz -lm -ldl -lgcc -lgfortran"
	CC=$MPICC FC=$MPIFC CXX=$MPICXX F90=$MPIF90 F77=$MPIF77 CFLAGS=$CFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --enable-netcdf-4 --enable-netcdf4 --enable-parallel-tests --enable-logging --enable-hdf5 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	echo " "

	############################# Convert Geo Tiff #################################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf convert_geotiff-0.1.0.tar.gz
	cd convert_geotiff-0.1.0
	CC=$MPICC FC=$MPIFC CXX=$MPICXX F90=$MPIF90 F77=$MPIF77 CFLAGS=$CFLAGS FCFLAGS=$FCFLAGS ./configure --exec-prefix=$DIR/grib2 --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	#################################### System Environment Tests ##############

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_NETCDF_MPI_tests.tar
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_tests.tar

	LD_LIBRARY_PATH= tar -xvf Fortran_C_tests.tar -C "${WRF_FOLDER}"/Tests/Environment
	LD_LIBRARY_PATH= tar -xvf Fortran_C_NETCDF_MPI_tests.tar -C "${WRF_FOLDER}"/Tests/Compatibility

	export one="1"
	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Environment

	cp ${NETCDF}/include/netcdf.inc .

	echo " "
	echo " "
	echo "Environment Testing "
	echo "Test 1"
	$FC TEST_1_fortran_only_fixed.f
	./a.out | tee env_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 1 Passed"
	else
		echo "Environment Compiler Test 1 Failed"
		exit
	fi
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 2"
	$FC TEST_2_fortran_only_free.f90
	./a.out | tee env_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 2 Passed"
	else
		echo "Environment Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 3"
	$CC TEST_3_c_only.c
	./a.out | tee env_test3.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test3.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 3 Passed"
	else
		echo "Environment Compiler Test 3 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 4"
	$CC -c -m64 TEST_4_fortran+c_c.c
	$FC -c -m64 TEST_4_fortran+c_f.f90
	$FC -m64 TEST_4_fortran+c_f.o TEST_4_fortran+c_c.o
	./a.out | tee env_test4.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test4.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 4 Passed"
	else
		echo "Environment Compiler Test 4 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Compatibility

	cp ${NETCDF}/include/netcdf.inc .

	echo " "
	echo " "
	echo "Library Compatibility Tests "
	echo "Test 1"
	$FC -c 01_fortran+c+netcdf_f.f
	$CC -c 01_fortran+c+netcdf_c.c
	$FC 01_fortran+c+netcdf_f.o 01_fortran+c+netcdf_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	./a.out | tee comp_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 1 Passed"
	else
		echo "Compatibility Compiler Test 1 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "

	echo "Test 2"
	$MPIFC -c 02_fortran+c+netcdf+mpi_f.f
	$MPICC -c 02_fortran+c+netcdf+mpi_c.c
	$MPIFC 02_fortran+c+netcdf+mpi_f.o \
		02_fortran+c+netcdf+mpi_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	$DIR/MPICH/bin/mpirun ./a.out | tee comp_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 2 Passed"
	else
		echo "Compatibility Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."
	echo " "

	echo " All tests completed and passed"
	echo " "

	################################ OpenGrADS ##################################
	#Verison 2.2.1 32bit of Linux
	#############################################################################
	if [[ $GRADS_PICK -eq 1 ]]; then
		cd "${WRF_FOLDER}"/Downloads
		LD_LIBRARY_PATH= tar -xvzf cd "${WRF_FOLDER}"/Downloads
		wget -c https://sourceforge.net/projects/opengrads/files/grads2/2.2.1.oga.1/Linux%20%2864%20Bits%29/opengrads-2.2.1.oga.1-bundle-x86_64-pc-linux-gnu-glibc_2.17.tar.gz
		LD_LIBRARY_PATH= tar -xvzf opengrads-2.2.1.oga.1-bundle-x86_64-pc-linux-gnu-glibc_2.17.tar.gz -C "${WRF_FOLDER}"/ -C "${WRF_FOLDER}"/
		cd "${WRF_FOLDER}"/
		mv "${WRF_FOLDER}"/opengrads-2.2.1.oga.1 "${WRF_FOLDER}"/GrADS
		cd GrADS/Contents
		wget -c https://github.com/regisgrundig/SIMOP/blob/master/g2ctl.pl
		chmod +x g2ctl.pl
		wget -c https://sourceforge.net/projects/opengrads/files/wgrib2/0.1.9.4/wgrib2-v0.1.9.4-bin-i686-glib2.5-linux-gnu.tar.gz
		LD_LIBRARY_PATH= tar -xvzf wgrib2-v0.1.9.4-bin-i686-glib2.5-linux-gnu.tar.gz
		cd wgrib2-v0.1.9.4/bin
		mv wgrib2 "${WRF_FOLDER}"/GrADS/Contents
		cd "${WRF_FOLDER}"/GrADS/Contents
		rm wgrib2-v0.1.9.4-bin-i686-glib2.5-linux-gnu.tar.gz
		rm -r wgrib2-v0.1.9.4

		export PATH="${WRF_FOLDER}"/GrADS/Contents:$PATH

		echo " "
	fi
	################################## GrADS ###############################
	# Version  2.2.1
	# Sublibs library instructions: http://cola.gmu.edu/grads/gadoc/supplibs2.html
	# GrADS instructions: http://cola.gmu.edu/grads/downloads.php
	########################################################################
	if [[ $GRADS_PICK -eq 2 ]]; then

		echo $PASSWD | sudo -S apt -y install grads

	fi

	##################### NCAR COMMAND LANGUAGE           ##################
	########### NCL compiled via Conda                    ##################
	########### This is the preferred method by NCAR      ##################
	########### https://www.ncl.ucar.edu/index.shtml      ##################
	#Installing Miniconda3 to WRF-Hydro directory and updating libraries

	export Miniconda_Install_DIR="${WRF_FOLDER}"/miniconda3

	mkdir -p $Miniconda_Install_DIR

	wget -c https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O $Miniconda_Install_DIR/miniconda.sh
	bash $Miniconda_Install_DIR/miniconda.sh -b -u -p $Miniconda_Install_DIR

	rm -rf $Miniconda_Install_DIR/miniconda.sh

	export PATH="${WRF_FOLDER}"/miniconda3/bin:$PATH

	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	$Miniconda_Install_DIR/bin/conda init bash

	conda tos accept
	conda config --add channels conda-forge
	conda config --set auto_activate_base false
	conda update -n root --all -y

	echo " "

	echo " "
	#Installing NCL via Conda
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	conda create -n ncl_stable -c conda-forge ncl -y
	conda activate ncl_stable

	conda deactivate
	conda deactivate
	conda deactivate

	echo " "

	##################### WRF Python           ##################
	########### WRf-Python compiled via Conda  ##################
	########### This is the preferred method by NCAR      ##################
	##### https://wrf-python.readthedocs.io/en/latest/installation.html  ##################
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh
	conda env create -f $HOME/WRF-MOSIT/wrf-python-stable.yml

	######################### Climate Data Operators ############
	######################### CDO compiled via Conda ###########
	####################### This is the preferred method #######
	################### https://bairdlangenbrunner.github.io/python-for-climate-scientists/conda/setting-up-conda-environments.html #######################

	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	conda create --name cdo_stable -y
	conda activate cdo_stable
	conda install -c conda-forge cdo -y
	conda update --all -y
	conda deactivate
	conda deactivate
	conda deactivate

	echo " "

	############################ WRF-SFIRE  #################################
	## WRF-SFIRE
	# Cloned from openwfm
	# option 34, option 1 for gfortran and distributed memory w/basic nesting
	# large file support enable with WRFiO_NCD_LARGE_FILE_SUPPORT=1
	########################################################################
	cd "${WRF_FOLDER}"
	git clone https://github.com/openwfm/WRF-SFIRE.git

	cd "${WRF_FOLDER}"/WRF-SFIRE/
	LD_LIBRARY_PATH= ./clean -a # Clean old configuration files

	if [ ${auto_config} -eq 1 ]; then
		(
			echo 34
			echo 1
		) | ./configure

	else
		./configure 2>&1 | tee configure.log #Option 34 gfortran compiler with distributed memory option 1 for basic nesting
	fi

	LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN em_real 2>&1 | tee compile.wrf1.log

	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WRF-SFIRE/main
	n=$(ls ./*.exe | wc -l)
	if (($n >= 3)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		cd "${WRF_FOLDER}"/WRF-SFIRE/
		LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN em_real 2>&1 | tee compile.wrf2.log
		cd "${WRF_FOLDER}"/WRF-SFIRE/main
		n=$(ls ./*.exe | wc -l)
		if (($n >= 3)); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	echo " "

	cd "${WRF_FOLDER}"/WRF-SFIRE
	LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN em_fire 2>&1 | tee compile.wrfsfire.log

	export WRF_DIR="${WRF_FOLDER}"/WRF-SFIRE

	############################WPSV4.2#####################################
	## WPS v4.2
	## Downloaded from git tagged releases
	# Cloned from openwfm
	#Option 3 for gfortran and distributed memory
	########################################################################
	cd "${WRF_FOLDER}"
	git clone https://github.com/openwfm/WPS.git

	cd "${WRF_FOLDER}"/WPS
	LD_LIBRARY_PATH= ./clean -a

	cd "${WRF_FOLDER}"/WPS
	if [ ${auto_config} -eq 1 ]; then
		FFLAGS=$FFLAGS echo 3 | ./configure 2>&1 | tee configure.log #Option 3 for gfortran and distributed memory
	else
		FFLAGS=$FFLAGS ./configure 2>&1 | tee configure.log #Option 3 gfortran compiler with distributed memory
	fi

	#sed statements for issue with GNUv10+

	if [ $GCC_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GFORTRAN_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GPLUSPLUS_VERSION_MAJOR_VERSION -ge $version_10 ]; then
		sed -i '70s/-frecord-marker=4/-frecord-marker=4 -m64 -fallow-argument-mismatch/g' "${WRF_FOLDER}"/WPS/configure.wps
		sed -i '71s/-frecord-marker=4/-frecord-marker=4 -m64 -fallow-argument-mismatch/g' "${WRF_FOLDER}"/WPS/configure.wps
	fi

	LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.wps.log

	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WPS
	n=$(ls ./*.exe | wc -l)
	if (($n == 3)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WPS. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"

		LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.wps2.log
		cd "${WRF_FOLDER}"/WPS
		n=$(ls ./*.exe | wc -l)
		if (($n == 3)); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WPS. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	echo " "

	######################## Static Geography Data inc/ Optional ####################
	# http://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html
	# These files are large so if you only need certain ones comment the others off
	# All files downloaded and untarred is 200GB
	# https://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html
	#################################################################################
	cd "${WRF_FOLDER}"/Downloads
	mkdir "${WRF_FOLDER}"/GEOG
	mkdir "${WRF_FOLDER}"/GEOG/WPS_GEOG

	echo " "
	echo "Mandatory WRF Preprocessing System (WPS) Geographical Input Data Mandatory Fields Downloads"
	echo " "
	wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_high_res_mandatory.tar.gz
	LD_LIBRARY_PATH= tar -xvzf geog_high_res_mandatory.tar.gz -C "${WRF_FOLDER}"/GEOG/

	wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_low_res_mandatory.tar.gz
	LD_LIBRARY_PATH= tar -xvzf geog_low_res_mandatory.tar.gz -C "${WRF_FOLDER}"/GEOG/
	mv "${WRF_FOLDER}"/GEOG/WPS_GEOG_LOW_RES/ "${WRF_FOLDER}"/GEOG/WPS_GEOG

	if [ ${WPS_Specific_Applications} -eq 1 ]; then
		echo " "
		echo " WPS Geographical Input Data Mandatory for Specific Applications"
		echo " "

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_thompson28_chem.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_thompson28_chem.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_noahmp.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_noahmp.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/irrigation.tar.gz
		LD_LIBRARY_PATH= tar -xvzf irrigation.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_px.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_px.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_urban.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_urban.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_ssib.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_ssib.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/lake_depth.tar.bz2
		LD_LIBRARY_PATH= tar -xvf lake_depth.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/topobath_30s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf topobath_30s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/gsl_gwd.tar.bz2
		LD_LIBRARY_PATH= tar -xvf gsl_gwd.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG
	fi

	if [ ${Optional_GEOG} -eq 1 ]; then
		echo " "
		echo "Optional WPS Geographical Input Data"
		echo " "

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_older_than_2000.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_older_than_2000.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/modis_landuse_20class_15s_with_lakes.tar.gz
		LD_LIBRARY_PATH= tar -xvzf modis_landuse_20class_15s_with_lakes.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_alt_lsm.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_alt_lsm.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/nlcd2006_ll_9s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf nlcd2006_ll_9s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/updated_Iceland_LU.tar.gz
		LD_LIBRARY_PATH= tar -xvf updated_Iceland_LU.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/modis_landuse_20class_15s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf modis_landuse_20class_15s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

	fi
fi

if [ "$RHL_64bit_GNU" = "1" ] && [ "$SFIRE_PICK" = "1" ]; then
	#############################basic package managment############################
	echo $PASSWD | sudo -S yum install epel-release -y
	echo $PASSWD | sudo -S yum install dnf -y
	echo $PASSWD | sudo -S dnf install epel-release -y
	echo $PASSWD | sudo -S dnf install dnf -y
	echo $PASSWD | sudo -S dnf -y update
	echo $PASSWD | sudo -S dnf -y upgrade
	echo $PASSWD | sudo -S dnf -y install bzip2 bzip2-devel byacc cairo-devel cmake cpp curl curl-devel flex fontconfig fontconfig-devel gcc gcc-c++ gcc-gfortran git java-11-openjdk java-11-openjdk-devel ksh libjpeg libjpeg-devel libX11 libX11-devel libXaw libXaw-devel libXext-devel libXmu libXmu-devel libXrender libXrender-devel libXt libXt-devel libxml2 libxml2-devel libXmu libXmu-devel libgeotiff libgeotiff-devel libtiff libtiff-devel m4 nfs-utils perl pkgconfig pixman pixman-devel python3 python3-devel tcsh time unzip wget
	echo $PASSWD | sudo -S dnf -y groupinstall "Development Tools"
	echo $PASSWD | sudo -S dnf -y update
	echo $PASSWD | sudo -S dnf -y upgrade

	echo " "

	##############################Directory Listing############################
	export HOME=$(
		cd
		pwd
	)

	mkdir $HOME/WRF_SFIRE
	export WRF_FOLDER=$HOME/WRF_SFIRE
	cd "${WRF_FOLDER}"/
	mkdir Downloads
	mkdir Libs
	export DIR="${WRF_FOLDER}"/Libs
	mkdir Libs/grib2
	mkdir Libs/NETCDF
	mkdir Libs/MPICH
	mkdir -p Tests/Environment
	mkdir -p Tests/Compatibility

	echo " "
	#############################Core Management####################################

	export CPU_CORE=$(nproc) # number of available threads on system
	export CPU_6CORE="6"
	export CPU_QUARTER=$(($CPU_CORE / 4))                          #quarter of availble cores on system
	export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2))) #Forces CPU cores to even number to avoid partial core export. ie 7 cores would be 3.5 cores.

	if [ $CPU_CORE -le $CPU_6CORE ]; then #If statement for low core systems.  Forces computers to only use 1 core if there are 4 cores or less on the system.
		export CPU_QUARTER_EVEN="2"
	else
		export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))
	fi

	echo "##########################################"
	echo "Number of Threads being used $CPU_QUARTER_EVEN"
	echo "##########################################"

	echo " "
	##############################Downloading Libraries############################
	cd Downloads
	wget -c https://github.com/madler/zlib/releases/download/v$Zlib_Version/zlib-$Zlib_Version.tar.gz
	wget -c https://github.com/HDFGroup/hdf5/releases/download/hdf5_$HDF5_Version/hdf5-$HDF5_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-c/archive/refs/tags/v$Netcdf_C_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-fortran/archive/refs/tags/v$Netcdf_Fortran_Version.tar.gz
	wget -c https://github.com/pmodels/mpich/releases/download/v$Mpich_Version/mpich-$Mpich_Version.tar.gz
	wget -c https://download.sourceforge.net/libpng/libpng-$Libpng_Version.tar.gz
	wget -c https://src.fedoraproject.org/repo/pkgs/jasper/jasper-$Jasper_Version.zip/a342b2b4495b3e1394e161eb5d85d754/jasper-$Jasper_Version.zip
	wget -c https://parallel-netcdf.github.io/Release/pnetcdf-$Pnetcdf_Version.tar.gz
	wget -c https://github.com/openwfm/convert_geotiff/releases/download/v0.1/convert_geotiff-0.1.0.tar.gz

	echo " "
	####################################Compilers#####################################
	export CC=gcc
	export CXX=g++
	export FC=gfortran
	export F77=gfortran
	export CFLAGS="-fPIC -fPIE -O3"

	#IF statement for GNU compiler issue
	export GCC_VERSION=$(gcc -dumpversion | awk '{print$1}')
	export GFORTRAN_VERSION=$(gfortran -dumpversion | awk '{print$1}')
	export GPLUSPLUS_VERSION=$(g++ -dumpversion | awk '{print$1}')

	export GCC_VERSION_MAJOR_VERSION=$(echo $GCC_VERSION | awk -F. '{print $1}')
	export GFORTRAN_VERSION_MAJOR_VERSION=$(echo $GFORTRAN_VERSION | awk -F. '{print $1}')
	export GPLUSPLUS_VERSION_MAJOR_VERSION=$(echo $GPLUSPLUS_VERSION | awk -F. '{print $1}')

	export version_10="10"

	if [ $GCC_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GFORTRAN_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GPLUSPLUS_VERSION_MAJOR_VERSION -ge $version_10 ]; then
		export fallow_argument=-fallow-argument-mismatch
		export boz_argument=-fallow-invalid-boz
	else
		export fallow_argument=
		export boz_argument=
	fi

	export FFLAGS="$fallow_argument -m64"
	export FCFLAGS="$fallow_argument -m64"

	echo "##########################################"
	echo "FFLAGS = $FFLAGS"
	echo "FCFLAGS = $FCFLAGS"
	echo "##########################################"

	echo " "
	############################# ZLib ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf zlib-$Zlib_Version.tar.gz
	cd zlib-$Zlib_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	export ZLIB_ROOT=$DIR/grib2
	export ZLIBLIB=$DIR/grib2/lib
	export ZLIBINC=$DIR/grib2/include

	echo " "
	############################## MPICH ############################
	#F90= due to compiler issues with mpich install
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf mpich-$Mpich_Version.tar.gz
	cd mpich-$Mpich_Version/
	F90= ./configure --prefix=$DIR/MPICH --with-device=ch3 FFLAGS=$fallow_argument FCFLAGS=$fallow_argument 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/MPICH/bin:$PATH

	export MPIFC=$DIR/MPICH/bin/mpifort
	export MPIF77=$DIR/MPICH/bin/mpifort
	export MPIF90=$DIR/MPICH/bin/mpifort
	export MPICC=$DIR/MPICH/bin/mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx

	echo " "
	############################# libpng ############################

	cd "${WRF_FOLDER}"/Downloads

	# other libraries below need these variables to be set
	export LDFLAGS=-L$DIR/grib2/lib
	export CPPFLAGS=-I$DIR/grib2/include

	LD_LIBRARY_PATH= tar -xvzf libpng-$Libpng_Version.tar.gz
	cd libpng-$Libpng_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNG_ROOT=$DIR/grib2

	echo " "
	#############################JasPer ############################
	cd "${WRF_FOLDER}"/Downloads
	unzip jasper-$Jasper_Version.zip
	cd jasper-$Jasper_Version/
	./configure --prefix=$DIR/grib2
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export JASPERLIB=$DIR/grib2/lib
	export JASPERINC=$DIR/grib2/include
	export JASPER_DIR=$DIR/grib2
	export Jasper_ROOT=$DIR/grib2/lib

	echo " "
	############################# hdf5 library for netcdf4 functionality ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf hdf5-$HDF5_Version.tar.gz
	cd hdf5-$HDF5_Version
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --with-zlib=$DIR/grib2 --enable-hl --enable-fortran --enable-parallel 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export HDF5=$DIR/grib2
	export PATH=$HDF5/bin:$PATH
	export PHDF5=$DIR/grib2
	export HDF5_ROOT=$DIR/grib2
	export PHDF5_ROOT=$DIR/grib2

	echo " "

	############################# Install Parallel-netCDF ##############################
	#Make file created with half of available cpu cores
	#Hard path for MPI added
	##################################################################################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf pnetcdf-$Pnetcdf_Version.tar.gz
	cd pnetcdf-$Pnetcdf_Version
	export MPIFC=$DIR/MPICH/bin/mpifort
	export MPIF77=$DIR/MPICH/bin/mpifort
	export MPIF90=$DIR/MPICH/bin/mpifort
	export MPICC=$DIR/MPICH/bin/mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --enable-static 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNETCDF=$DIR/grib2
	export PNETCDF_DIR=$DIR/grib2
	export PNETCDF_ROOT=$DIR/grib2

	############################## Install NETCDF C Library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_C_Version.tar.gz
	cd netcdf-c-$Netcdf_C_Version/
	export CPPFLAGS=-I$DIR/grib2/include
	export LDFLAGS="-L$DIR/grib2/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lhdf5_hl -lhdf5 -lz -lcurl -lgfortran -lgcc -lm -ldl -lpnetcdf"
	CC=$MPICC FC=$MPIFC CXX=$MPICXX F90=$MPIF90 F77=$MPIF77 CFLAGS=$CFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --disable-dap --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-pnetcdf --enable-cdf5 --enable-parallel-tests --enable-logging 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/NETCDF/bin:$PATH
	export NETCDF=$DIR/NETCDF
	export NETCDF_INC=$DIR/NETCDF/include
	export NETCDF_LIB=$DIR/NETCDF/lib
	export NETCDF_ROOT=$DIR/NETCDF
	export LD_LIBRARY_PATH=$DIR/grib2/lib:$DIR/NETCDF/lib:$LD_LIBRARY_PATH

	echo " "
	############################## NetCDF fortran library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_Fortran_Version.tar.gz
	cd netcdf-fortran-$Netcdf_Fortran_Version/
	export LD_LIBRARY_PATH=$DIR/NETCDF/lib:$LD_LIBRARY_PATH
	export CPPFLAGS="-I$DIR/NETCDF/include -I$DIR/grib2/include"
	export LDFLAGS="-L$DIR/NETCDF/lib -L$DIR/grib2/lib -Wl,-rpath,$DIR/NETCDF/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lnetcdf -lpnetcdf -lcurl -lhdf5_hl -lhdf5 -lz -lm -ldl -lgcc -lgfortran"
	CC=$MPICC FC=$MPIFC CXX=$MPICXX F90=$MPIF90 F77=$MPIF77 CFLAGS=$CFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-parallel-tests --enable-logging --enable-hdf5 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	echo " "

	############################# Convert Geo Tiff #################################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf convert_geotiff-0.1.0.tar.gz
	cd convert_geotiff-0.1.0
	export CPPFLAGS="-I$DIR/NETCDF/include -I$DIR/grib2/include -I/usr/include/libgeotiff"
	export LDFLAGS="-L$DIR/NETCDF/lib -L$DIR/grib2/lib -L/usr/lib/libgeotiff"
	CC=$MPICC FC=$MPIFC CXX=$MPICXX F90=$MPIF90 F77=$MPIF77 CFLAGS=$CFLAGS FCFLAGS=$FCFLAGS ./configure --exec-prefix=$DIR/grib2 --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export CPPFLAGS="-I$DIR/NETCDF/include -I$DIR/grib2/include"
	export LDFLAGS="-L$DIR/NETCDF/lib -L$DIR/grib2/lib -Wl,-rpath,$DIR/NETCDF/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lnetcdf -lpnetcdf -lcurl -lhdf5_hl -lhdf5 -lz -lm -ldl -lgcc -lgfortran"

	#################################### System Environment Tests ##############

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_NETCDF_MPI_tests.tar
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_tests.tar

	LD_LIBRARY_PATH= tar -xvf Fortran_C_tests.tar -C "${WRF_FOLDER}"/Tests/Environment
	LD_LIBRARY_PATH= tar -xvf Fortran_C_NETCDF_MPI_tests.tar -C "${WRF_FOLDER}"/Tests/Compatibility

	export one="1"
	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Environment

	cp ${NETCDF}/include/netcdf.inc .

	echo " "
	echo " "
	echo "Environment Testing "
	echo "Test 1"
	$FC TEST_1_fortran_only_fixed.f
	./a.out | tee env_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 1 Passed"
	else
		echo "Environment Compiler Test 1 Failed"
		exit
	fi
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 2"
	$FC TEST_2_fortran_only_free.f90
	./a.out | tee env_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 2 Passed"
	else
		echo "Environment Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 3"
	$CC TEST_3_c_only.c
	./a.out | tee env_test3.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test3.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 3 Passed"
	else
		echo "Environment Compiler Test 3 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 4"
	$CC -c -m64 TEST_4_fortran+c_c.c
	$FC -c -m64 TEST_4_fortran+c_f.f90
	$FC -m64 TEST_4_fortran+c_f.o TEST_4_fortran+c_c.o
	./a.out | tee env_test4.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test4.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 4 Passed"
	else
		echo "Environment Compiler Test 4 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Compatibility

	cp ${NETCDF}/include/netcdf.inc .

	echo " "
	echo " "
	echo "Library Compatibility Tests "
	echo "Test 1"
	$FC -c 01_fortran+c+netcdf_f.f
	$CC -c 01_fortran+c+netcdf_c.c
	$FC 01_fortran+c+netcdf_f.o 01_fortran+c+netcdf_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	./a.out | tee comp_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 1 Passed"
	else
		echo "Compatibility Compiler Test 1 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "

	echo "Test 2"
	$MPIFC -c 02_fortran+c+netcdf+mpi_f.f
	$MPICC -c 02_fortran+c+netcdf+mpi_c.c
	$MPIFC 02_fortran+c+netcdf+mpi_f.o \
		02_fortran+c+netcdf+mpi_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	$DIR/MPICH/bin/mpirun ./a.out | tee comp_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 2 Passed"
	else
		echo "Compatibility Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."
	echo " "

	echo " All tests completed and passed"
	echo " "

	################################ OpenGrADS ##################################
	#Verison 2.2.1 32bit of Linux
	#############################################################################
	if [[ $GRADS_PICK -eq 1 ]]; then
		cd "${WRF_FOLDER}"/Downloads
		LD_LIBRARY_PATH= tar -xvzf cd "${WRF_FOLDER}"/Downloads
		wget -c https://sourceforge.net/projects/opengrads/files/grads2/2.2.1.oga.1/Linux%20%2864%20Bits%29/opengrads-2.2.1.oga.1-bundle-x86_64-pc-linux-gnu-glibc_2.17.tar.gz
		LD_LIBRARY_PATH= tar -xvzf opengrads-2.2.1.oga.1-bundle-x86_64-pc-linux-gnu-glibc_2.17.tar.gz -C "${WRF_FOLDER}"/ -C "${WRF_FOLDER}"/
		cd "${WRF_FOLDER}"/
		mv "${WRF_FOLDER}"/opengrads-2.2.1.oga.1 "${WRF_FOLDER}"/GrADS
		cd GrADS/Contents
		wget -c https://github.com/regisgrundig/SIMOP/blob/master/g2ctl.pl
		chmod +x g2ctl.pl
		wget -c https://sourceforge.net/projects/opengrads/files/wgrib2/0.1.9.4/wgrib2-v0.1.9.4-bin-i686-glib2.5-linux-gnu.tar.gz
		LD_LIBRARY_PATH= tar -xvzf wgrib2-v0.1.9.4-bin-i686-glib2.5-linux-gnu.tar.gz
		cd wgrib2-v0.1.9.4/bin
		mv wgrib2 "${WRF_FOLDER}"/GrADS/Contents
		cd "${WRF_FOLDER}"/GrADS/Contents
		rm wgrib2-v0.1.9.4-bin-i686-glib2.5-linux-gnu.tar.gz
		rm -r wgrib2-v0.1.9.4

		export PATH="${WRF_FOLDER}"/GrADS/Contents:$PATH

		echo " "
	fi
	################################## GrADS ###############################
	# Version  2.2.1
	# Sublibs library instructions: http://cola.gmu.edu/grads/gadoc/supplibs2.html
	# GrADS instructions: http://cola.gmu.edu/grads/downloads.php
	########################################################################
	if [[ $GRADS_PICK -eq 2 ]]; then
		cd "${WRF_FOLDER}"/Downloads
		wget -c ftp://cola.gmu.edu/grads/2.2/grads-2.2.1-bin-RHL7.4-x86_64.tar.gz
		LD_LIBRARY_PATH= tar -xvzf grads-2.2.1-bin-RHL7.4-x86_64.tar.gz -C "${WRF_FOLDER}"
		cd "${WRF_FOLDER}"/grads-2.2.1/bin
		chmod 775 *

	fi

	##################### NCAR COMMAND LANGUAGE           ##################
	########### NCL compiled via Conda                    ##################
	########### This is the preferred method by NCAR      ##################
	########### https://www.ncl.ucar.edu/index.shtml      ##################
	#Installing Miniconda3 to WRF-Hydro directory and updating libraries

	export Miniconda_Install_DIR="${WRF_FOLDER}"/miniconda3

	mkdir -p $Miniconda_Install_DIR

	wget -c https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O $Miniconda_Install_DIR/miniconda.sh
	bash $Miniconda_Install_DIR/miniconda.sh -b -u -p $Miniconda_Install_DIR

	rm -rf $Miniconda_Install_DIR/miniconda.sh

	export PATH="${WRF_FOLDER}"/miniconda3/bin:$PATH

	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	$Miniconda_Install_DIR/bin/conda init bash

	conda tos accept
	conda config --add channels conda-forge
	conda config --set auto_activate_base false
	conda update -n root --all -y

	echo " "

	echo " "
	#Installing NCL via Conda
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	conda create -n ncl_stable -c conda-forge ncl -y
	conda activate ncl_stable

	conda deactivate
	conda deactivate
	conda deactivate

	##################### WRF Python           ##################
	########### WRf-Python compiled via Conda  ##################
	########### This is the preferred method by NCAR      ##################
	##### https://wrf-python.readthedocs.io/en/latest/installation.html  ##################
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh
	conda env create -f $HOME/WRF-MOSIT/wrf-python-stable.yml

	echo " "

	######################### Climate Data Operators ############
	######################### CDO compiled via Conda ###########
	####################### This is the preferred method #######
	################### https://bairdlangenbrunner.github.io/python-for-climate-scientists/conda/setting-up-conda-environments.html #######################

	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	conda create --name cdo_stable -y
	conda activate cdo_stable
	conda install -c conda-forge cdo -y
	conda update --all -y
	conda deactivate
	conda deactivate
	conda deactivate

	echo " "

	############################ WRF-SFIRE  #################################
	## WRF-SFIRE
	# Cloned from openwfm
	# option 34, option 1 for gfortran and distributed memory w/basic nesting
	# large file support enable with WRFiO_NCD_LARGE_FILE_SUPPORT=1
	########################################################################
	cd "${WRF_FOLDER}"
	git clone https://github.com/openwfm/WRF-SFIRE.git

	cd "${WRF_FOLDER}"/WRF-SFIRE/
	LD_LIBRARY_PATH= ./clean -a # Clean old configuration files

	if [ ${auto_config} -eq 1 ]; then
		(
			echo 34
			echo 1
		) | ./configure

	else
		./configure 2>&1 | tee configure.log #Option 34 gfortran compiler with distributed memory option 1 for basic nesting
	fi

	LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN em_real 2>&1 | tee compile.wrf1.log

	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WRF-SFIRE/main
	n=$(ls ./*.exe | wc -l)
	if (($n >= 3)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		cd "${WRF_FOLDER}"/WRF-SFIRE/
		LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN em_real 2>&1 | tee compile.wrf2.log
		cd "${WRF_FOLDER}"/WRF-SFIRE/main
		n=$(ls ./*.exe | wc -l)
		if (($n >= 3)); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	echo " "

	cd "${WRF_FOLDER}"/WRF-SFIRE
	LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN em_fire 2>&1 | tee compile.wrfsfire.log

	export WRF_DIR="${WRF_FOLDER}"/WRF-SFIRE

	############################WPSV4.2#####################################
	## WPS v4.2
	## Downloaded from git tagged releases
	# Cloned from openwfm
	#Option 3 for gfortran and distributed memory
	########################################################################
	cd "${WRF_FOLDER}"
	git clone https://github.com/openwfm/WPS.git

	cd "${WRF_FOLDER}"/WPS
	LD_LIBRARY_PATH= ./clean -a

	cd "${WRF_FOLDER}"/WPS
	if [ ${auto_config} -eq 1 ]; then
		FFLAGS=$FFLAGS echo 3 | ./configure 2>&1 | tee configure.log #Option 3 for gfortran and distributed memory
	else
		FFLAGS=$FFLAGS ./configure 2>&1 | tee configure.log #Option 3 gfortran compiler with distributed memory
	fi

	#sed statements for issue with GNUv10+

	if [ $GCC_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GFORTRAN_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GPLUSPLUS_VERSION_MAJOR_VERSION -ge $version_10 ]; then
		sed -i '70s/-frecord-marker=4/-frecord-marker=4 -m64 -fallow-argument-mismatch/g' "${WRF_FOLDER}"/WPS/configure.wps
		sed -i '71s/-frecord-marker=4/-frecord-marker=4 -m64 -fallow-argument-mismatch/g' "${WRF_FOLDER}"/WPS/configure.wps
	fi

	LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.wps.log

	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WPS
	n=$(ls ./*.exe | wc -l)
	if (($n == 3)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WPS. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"

		LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.wps2.log
		cd "${WRF_FOLDER}"/WPS
		n=$(ls ./*.exe | wc -l)
		if (($n == 3)); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WPS. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	echo " "

	######################## Static Geography Data inc/ Optional ####################
	# http://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html
	# These files are large so if you only need certain ones comment the others off
	# All files downloaded and untarred is 200GB
	# https://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html
	#################################################################################
	cd "${WRF_FOLDER}"/Downloads
	mkdir "${WRF_FOLDER}"/GEOG
	mkdir "${WRF_FOLDER}"/GEOG/WPS_GEOG

	echo " "
	echo "Mandatory WRF Preprocessing System (WPS) Geographical Input Data Mandatory Fields Downloads"
	echo " "
	wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_high_res_mandatory.tar.gz
	LD_LIBRARY_PATH= tar -xvzf geog_high_res_mandatory.tar.gz -C "${WRF_FOLDER}"/GEOG/

	wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_low_res_mandatory.tar.gz
	LD_LIBRARY_PATH= tar -xvzf geog_low_res_mandatory.tar.gz -C "${WRF_FOLDER}"/GEOG/
	mv "${WRF_FOLDER}"/GEOG/WPS_GEOG_LOW_RES/ "${WRF_FOLDER}"/GEOG/WPS_GEOG

	if [ ${WPS_Specific_Applications} -eq 1 ]; then
		echo " "
		echo " WPS Geographical Input Data Mandatory for Specific Applications"
		echo " "

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_thompson28_chem.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_thompson28_chem.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_noahmp.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_noahmp.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/irrigation.tar.gz
		LD_LIBRARY_PATH= tar -xvzf irrigation.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_px.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_px.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_urban.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_urban.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_ssib.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_ssib.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/lake_depth.tar.bz2
		LD_LIBRARY_PATH= tar -xvf lake_depth.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/topobath_30s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf topobath_30s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/gsl_gwd.tar.bz2
		LD_LIBRARY_PATH= tar -xvf gsl_gwd.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG
	fi

	if [ ${Optional_GEOG} -eq 1 ]; then
		echo " "
		echo "Optional WPS Geographical Input Data"
		echo " "

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_older_than_2000.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_older_than_2000.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/modis_landuse_20class_15s_with_lakes.tar.gz
		LD_LIBRARY_PATH= tar -xvzf modis_landuse_20class_15s_with_lakes.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_alt_lsm.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_alt_lsm.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/nlcd2006_ll_9s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf nlcd2006_ll_9s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/updated_Iceland_LU.tar.gz
		LD_LIBRARY_PATH= tar -xvf updated_Iceland_LU.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/modis_landuse_20class_15s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf modis_landuse_20class_15s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

	fi

fi

if [ "$RHL_64bit_GNU" = "2" ] && [ "$SFIRE_PICK" = "1" ]; then
	#############################basic package managment############################
	echo "old version of GNU detected"
	echo $PASSWD | sudo -S yum install epel-release -y
	echo $PASSWD | sudo -S yum install RHL-release-scl -y
	echo $PASSWD | sudo -S yum clean all
	echo $PASSWD | sudo -S yum remove devtoolset-11*
	echo $PASSWD | sudo -S yum install devtoolset-11
	echo $PASSWD | sudo -S yum install devtoolset-11-\* -y
	echo $PASSWD | sudo -S yum -y update
	echo $PASSWD | sudo -S yum -y upgrade

	source /opt/rh/devtoolset-11/enable
	gcc --version
	echo $PASSWD | sudo -S yum install epel-release -y
	echo $PASSWD | sudo -S yum install dnf -y
	echo $PASSWD | sudo -S dnf install epel-release -y
	echo $PASSWD | sudo -S dnf install dnf -y
	echo $PASSWD | sudo -S dnf -y update
	echo $PASSWD | sudo -S dnf -y upgrade
	echo $PASSWD | sudo -S dnf -y install bzip2 bzip2-devel byacc cairo-devel cmake cpp curl curl-devel flex fontconfig fontconfig-devel gcc gcc-c++ gcc-gfortran git java-11-openjdk java-11-openjdk-devel ksh libjpeg libjpeg-deve libX11 libX11-devel libXaw libXaw-devel libXext-devel libXmu libXmu-devel libXrender libXrender-devel libXt libXt-devel libxml2 libxml2-devel libXmu libXmu-devel libgeotiff libgeotiff-devel libtiff libtiff-devel m4 nfs-utils perl pkgconfig pixman pixman-devel python3 python3-devel tcsh time unzip wget
	echo $PASSWD | sudo -S dnf -y groupinstall "Development Tools"
	echo $PASSWD | sudo -S dnf -y update
	echo $PASSWD | sudo -S dnf -y upgrade
	source /opt/rh/devtoolset-11/enable
	echo " "

	##############################Directory Listing############################
	export HOME=$(
		cd
		pwd
	)

	mkdir $HOME/WRF_SFIRE
	export WRF_FOLDER=$HOME/WRF_SFIRE
	cd "${WRF_FOLDER}"/
	mkdir Downloads
	mkdir Libs
	export DIR="${WRF_FOLDER}"/Libs
	mkdir Libs/grib2
	mkdir Libs/NETCDF
	mkdir Libs/MPICH
	mkdir -p Tests/Environment
	mkdir -p Tests/Compatibility

	echo " "
	#############################Core Management####################################

	export CPU_CORE=$(nproc) # number of available threads on system
	export CPU_6CORE="6"
	export CPU_QUARTER=$(($CPU_CORE / 4))                          #quarter of availble cores on system
	export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2))) #Forces CPU cores to even number to avoid partial core export. ie 7 cores would be 3.5 cores.

	if [ $CPU_CORE -le $CPU_6CORE ]; then #If statement for low core systems.  Forces computers to only use 1 core if there are 4 cores or less on the system.
		export CPU_QUARTER_EVEN="2"
	else
		export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))
	fi

	echo "##########################################"
	echo "Number of Threads being used $CPU_QUARTER_EVEN"
	echo "##########################################"

	echo " "
	##############################Downloading Libraries############################
	cd Downloads
	wget -c https://github.com/madler/zlib/releases/download/v$Zlib_Version/zlib-$Zlib_Version.tar.gz
	wget -c https://github.com/HDFGroup/hdf5/releases/download/hdf5_$HDF5_Version/hdf5-$HDF5_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-c/archive/refs/tags/v$Netcdf_C_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-fortran/archive/refs/tags/v$Netcdf_Fortran_Version.tar.gz
	wget -c https://github.com/pmodels/mpich/releases/download/v$Mpich_Version/mpich-$Mpich_Version.tar.gz
	wget -c https://download.sourceforge.net/libpng/libpng-$Libpng_Version.tar.gz
	wget -c https://src.fedoraproject.org/repo/pkgs/jasper/jasper-$Jasper_Version.zip/a342b2b4495b3e1394e161eb5d85d754/jasper-$Jasper_Version.zip
	wget -c https://parallel-netcdf.github.io/Release/pnetcdf-$Pnetcdf_Version.tar.gz
	wget -c https://github.com/openwfm/convert_geotiff/releases/download/v0.1/convert_geotiff-0.1.0.tar.gz

	echo " "
	####################################Compilers#####################################
	export CC=gcc
	export CXX=g++
	export FC=gfortran
	export F77=gfortran
	export CFLAGS="-fPIC -fPIE -O3"

	#IF statement for GNU compiler issue
	export GCC_VERSION=$(gcc -dumpversion | awk '{print$1}')
	export GFORTRAN_VERSION=$(gfortran -dumpversion | awk '{print$1}')
	export GPLUSPLUS_VERSION=$(g++ -dumpversion | awk '{print$1}')

	export GCC_VERSION_MAJOR_VERSION=$(echo $GCC_VERSION | awk -F. '{print $1}')
	export GFORTRAN_VERSION_MAJOR_VERSION=$(echo $GFORTRAN_VERSION | awk -F. '{print $1}')
	export GPLUSPLUS_VERSION_MAJOR_VERSION=$(echo $GPLUSPLUS_VERSION | awk -F. '{print $1}')

	export version_10="10"

	if [ $GCC_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GFORTRAN_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GPLUSPLUS_VERSION_MAJOR_VERSION -ge $version_10 ]; then
		export fallow_argument=-fallow-argument-mismatch
		export boz_argument=-fallow-invalid-boz
	else
		export fallow_argument=
		export boz_argument=
	fi

	export FFLAGS="$fallow_argument -m64"
	export FCFLAGS="$fallow_argument -m64"

	echo "##########################################"
	echo "FFLAGS = $FFLAGS"
	echo "FCFLAGS = $FCFLAGS"
	echo "##########################################"

	echo " "
	############################# ZLib ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf zlib-$Zlib_Version.tar.gz
	cd zlib-$Zlib_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	export ZLIB_ROOT=$DIR/grib2
	export ZLIBLIB=$DIR/grib2/lib
	export ZLIBINC=$DIR/grib2/include

	echo " "
	############################## MPICH ############################
	#F90= due to compiler issues with mpich install
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf mpich-$Mpich_Version.tar.gz
	cd mpich-$Mpich_Version/
	F90= ./configure --prefix=$DIR/MPICH --with-device=ch3 FFLAGS=$fallow_argument FCFLAGS=$fallow_argument 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/MPICH/bin:$PATH

	export MPIFC=$DIR/MPICH/bin/mpifort
	export MPIF77=$DIR/MPICH/bin/mpifort
	export MPIF90=$DIR/MPICH/bin/mpifort
	export MPICC=$DIR/MPICH/bin/mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx

	echo " "
	############################# libpng ############################

	cd "${WRF_FOLDER}"/Downloads

	# other libraries below need these variables to be set
	export LDFLAGS=-L$DIR/grib2/lib
	export CPPFLAGS=-I$DIR/grib2/include

	LD_LIBRARY_PATH= tar -xvzf libpng-$Libpng_Version.tar.gz
	cd libpng-$Libpng_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNG_ROOT=$DIR/grib2

	echo " "

	#############################JasPer ############################
	cd "${WRF_FOLDER}"/Downloads
	unzip jasper-$Jasper_Version.zip
	cd jasper-$Jasper_Version/
	./configure --prefix=$DIR/grib2
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export JASPERLIB=$DIR/grib2/lib
	export JASPERINC=$DIR/grib2/include
	export JASPER_DIR=$DIR/grib2
	export Jasper_ROOT=$DIR/grib2/lib

	echo " "
	############################# hdf5 library for netcdf4 functionality ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf hdf5-$HDF5_Version.tar.gz
	cd hdf5-$HDF5_Version
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --with-zlib=$DIR/grib2 --enable-hl --enable-fortran --enable-parallel 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export HDF5=$DIR/grib2
	export PATH=$HDF5/bin:$PATH
	export PHDF5=$DIR/grib2
	export HDF5_ROOT=$DIR/grib2
	export PHDF5_ROOT=$DIR/grib2

	echo " "

	############################# Install Parallel-netCDF ##############################
	#Make file created with half of available cpu cores
	#Hard path for MPI added
	##################################################################################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf pnetcdf-$Pnetcdf_Version.tar.gz
	cd pnetcdf-$Pnetcdf_Version
	export MPIFC=$DIR/MPICH/bin/mpifort
	export MPIF77=$DIR/MPICH/bin/mpifort
	export MPIF90=$DIR/MPICH/bin/mpifort
	export MPICC=$DIR/MPICH/bin/mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --enable-static 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNETCDF=$DIR/grib2
	export PNETCDF_DIR=$DIR/grib2
	export PNETCDF_ROOT=$DIR/grib2

	############################## Install NETCDF C Library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_C_Version.tar.gz
	cd netcdf-c-$Netcdf_C_Version/
	export CPPFLAGS=-I$DIR/grib2/include
	export LDFLAGS="-L$DIR/grib2/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lhdf5_hl -lhdf5 -lz -lcurl -lgfortran -lgcc -lm -ldl -lpnetcdf"
	CC=$MPICC FC=$MPIFC CXX=$MPICXX F90=$MPIF90 F77=$MPIF77 CFLAGS=$CFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --disable-dap --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-pnetcdf --enable-cdf5 --enable-parallel-tests --enable-logging 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/NETCDF/bin:$PATH
	export NETCDF=$DIR/NETCDF
	export NETCDF_INC=$DIR/NETCDF/include
	export NETCDF_LIB=$DIR/NETCDF/lib
	export NETCDF_ROOT=$DIR/NETCDF
	export LD_LIBRARY_PATH=$DIR/grib2/lib:$DIR/NETCDF/lib:$LD_LIBRARY_PATH

	echo " "
	############################## NetCDF fortran library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_Fortran_Version.tar.gz
	cd netcdf-fortran-$Netcdf_Fortran_Version/
	export LD_LIBRARY_PATH=$DIR/NETCDF/lib:$LD_LIBRARY_PATH
	export CPPFLAGS="-I$DIR/NETCDF/include -I$DIR/grib2/include"
	export LDFLAGS="-L$DIR/NETCDF/lib -L$DIR/grib2/lib -Wl,-rpath,$DIR/NETCDF/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lnetcdf -lpnetcdf -lcurl -lhdf5_hl -lhdf5 -lz -lm -ldl -lgcc -lgfortran"
	CC=$MPICC FC=$MPIFC CXX=$MPICXX F90=$MPIF90 F77=$MPIF77 CFLAGS=$CFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-parallel-tests --enable-logging --enable-hdf5 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	echo " "

	############################# Convert Geo Tiff #################################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf convert_geotiff-0.1.0.tar.gz
	cd convert_geotiff-0.1.0
	export CPPFLAGS="-I$DIR/NETCDF/include -I$DIR/grib2/include -I/usr/include/libgeotiff"
	export LDFLAGS="-L$DIR/NETCDF/lib -L$DIR/grib2/lib -L/usr/lib/libgeotiff"
	CC=$MPICC FC=$MPIFC CXX=$MPICXX F90=$MPIF90 F77=$MPIF77 CFLAGS=$CFLAGS FCFLAGS=$FCFLAGS ./configure --exec-prefix=$DIR/grib2 --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export CPPFLAGS="-I$DIR/NETCDF/include -I$DIR/grib2/include"
	export LDFLAGS="-L$DIR/NETCDF/lib -L$DIR/grib2/lib -Wl,-rpath,$DIR/NETCDF/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lnetcdf -lpnetcdf -lcurl -lhdf5_hl -lhdf5 -lz -lm -ldl -lgcc -lgfortran"

	#################################### System Environment Tests ##############

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_NETCDF_MPI_tests.tar
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_tests.tar

	LD_LIBRARY_PATH= tar -xvf Fortran_C_tests.tar -C "${WRF_FOLDER}"/Tests/Environment
	LD_LIBRARY_PATH= tar -xvf Fortran_C_NETCDF_MPI_tests.tar -C "${WRF_FOLDER}"/Tests/Compatibility

	export one="1"
	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Environment

	cp ${NETCDF}/include/netcdf.inc .

	echo " "
	echo " "
	echo "Environment Testing "
	echo "Test 1"
	$FC TEST_1_fortran_only_fixed.f
	./a.out | tee env_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 1 Passed"
	else
		echo "Environment Compiler Test 1 Failed"
		exit
	fi
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 2"
	$FC TEST_2_fortran_only_free.f90
	./a.out | tee env_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 2 Passed"
	else
		echo "Environment Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 3"
	$CC TEST_3_c_only.c
	./a.out | tee env_test3.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test3.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 3 Passed"
	else
		echo "Environment Compiler Test 3 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 4"
	$CC -c -m64 TEST_4_fortran+c_c.c
	$FC -c -m64 TEST_4_fortran+c_f.f90
	$FC -m64 TEST_4_fortran+c_f.o TEST_4_fortran+c_c.o
	./a.out | tee env_test4.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test4.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 4 Passed"
	else
		echo "Environment Compiler Test 4 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Compatibility

	cp ${NETCDF}/include/netcdf.inc .

	echo " "
	echo " "
	echo "Library Compatibility Tests "
	echo "Test 1"
	$FC -c 01_fortran+c+netcdf_f.f
	$CC -c 01_fortran+c+netcdf_c.c
	$FC 01_fortran+c+netcdf_f.o 01_fortran+c+netcdf_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	./a.out | tee comp_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 1 Passed"
	else
		echo "Compatibility Compiler Test 1 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "

	echo "Test 2"
	$MPIFC -c 02_fortran+c+netcdf+mpi_f.f
	$MPICC -c 02_fortran+c+netcdf+mpi_c.c
	$MPIFC 02_fortran+c+netcdf+mpi_f.o \
		02_fortran+c+netcdf+mpi_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	$DIR/MPICH/bin/mpirun ./a.out | tee comp_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 2 Passed"
	else
		echo "Compatibility Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."
	echo " "

	echo " All tests completed and passed"
	echo " "

	################################ OpenGrADS ##################################
	#Verison 2.2.1 32bit of Linux
	#############################################################################
	if [[ $GRADS_PICK -eq 1 ]]; then
		cd "${WRF_FOLDER}"/Downloads
		LD_LIBRARY_PATH= tar -xvzf cd "${WRF_FOLDER}"/Downloads
		wget -c https://sourceforge.net/projects/opengrads/files/grads2/2.2.1.oga.1/Linux%20%2864%20Bits%29/opengrads-2.2.1.oga.1-bundle-x86_64-pc-linux-gnu-glibc_2.17.tar.gz
		LD_LIBRARY_PATH= tar -xvzf opengrads-2.2.1.oga.1-bundle-x86_64-pc-linux-gnu-glibc_2.17.tar.gz -C "${WRF_FOLDER}"/ -C "${WRF_FOLDER}"/
		cd "${WRF_FOLDER}"/
		mv "${WRF_FOLDER}"/opengrads-2.2.1.oga.1 "${WRF_FOLDER}"/GrADS
		cd GrADS/Contents
		wget -c https://github.com/regisgrundig/SIMOP/blob/master/g2ctl.pl
		chmod +x g2ctl.pl
		wget -c https://sourceforge.net/projects/opengrads/files/wgrib2/0.1.9.4/wgrib2-v0.1.9.4-bin-i686-glib2.5-linux-gnu.tar.gz
		LD_LIBRARY_PATH= tar -xvzf wgrib2-v0.1.9.4-bin-i686-glib2.5-linux-gnu.tar.gz
		cd wgrib2-v0.1.9.4/bin
		mv wgrib2 "${WRF_FOLDER}"/GrADS/Contents
		cd "${WRF_FOLDER}"/GrADS/Contents
		rm wgrib2-v0.1.9.4-bin-i686-glib2.5-linux-gnu.tar.gz
		rm -r wgrib2-v0.1.9.4

		export PATH="${WRF_FOLDER}"/GrADS/Contents:$PATH

		echo " "
	fi
	################################## GrADS ###############################
	# Version  2.2.1
	# Sublibs library instructions: http://cola.gmu.edu/grads/gadoc/supplibs2.html
	# GrADS instructions: http://cola.gmu.edu/grads/downloads.php
	########################################################################
	if [[ $GRADS_PICK -eq 2 ]]; then
		cd "${WRF_FOLDER}"/Downloads
		wget -c ftp://cola.gmu.edu/grads/2.2/grads-2.2.1-bin-RHL7.4-x86_64.tar.gz
		LD_LIBRARY_PATH= tar -xvzf grads-2.2.1-bin-RHL7.4-x86_64.tar.gz -C "${WRF_FOLDER}"
		cd "${WRF_FOLDER}"/grads-2.2.1/bin
		chmod 775 *

	fi

	##################### NCAR COMMAND LANGUAGE           ##################
	########### NCL compiled via Conda                    ##################
	########### This is the preferred method by NCAR      ##################
	########### https://www.ncl.ucar.edu/index.shtml      ##################
	#Installing Miniconda3 to WRF-Hydro directory and updating libraries

	export Miniconda_Install_DIR="${WRF_FOLDER}"/miniconda3

	mkdir -p $Miniconda_Install_DIR

	wget -c https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O $Miniconda_Install_DIR/miniconda.sh
	bash $Miniconda_Install_DIR/miniconda.sh -b -u -p $Miniconda_Install_DIR

	rm -rf $Miniconda_Install_DIR/miniconda.sh

	export PATH="${WRF_FOLDER}"/miniconda3/bin:$PATH

	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	$Miniconda_Install_DIR/bin/conda init bash

	conda tos accept
	conda config --add channels conda-forge
	conda config --set auto_activate_base false
	conda update -n root --all -y

	echo " "

	echo " "
	#Installing NCL via Conda
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	conda create -n ncl_stable -c conda-forge ncl -y
	conda activate ncl_stable

	conda deactivate
	conda deactivate
	conda deactivate

	echo " "

	##################### WRF Python           ##################
	########### WRf-Python compiled via Conda  ##################
	########### This is the preferred method by NCAR      ##################
	##### https://wrf-python.readthedocs.io/en/latest/installation.html  ##################
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh
	conda env create -f $HOME/WRF-MOSIT/wrf-python-stable.yml

	echo " "

	######################### Climate Data Operators ############
	######################### CDO compiled via Conda ###########
	####################### This is the preferred method #######
	################### https://bairdlangenbrunner.github.io/python-for-climate-scientists/conda/setting-up-conda-environments.html #######################

	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	conda create --name cdo_stable -y
	conda activate cdo_stable
	conda install -c conda-forge cdo -y
	conda update --all -y
	conda deactivate
	conda deactivate
	conda deactivate

	echo " "

	############################ WRF-SFIRE  #################################
	## WRF-SFIRE
	# Cloned from openwfm
	# option 34, option 1 for gfortran and distributed memory w/basic nesting
	# large file support enable with WRFiO_NCD_LARGE_FILE_SUPPORT=1
	########################################################################
	cd "${WRF_FOLDER}"
	git clone https://github.com/openwfm/WRF-SFIRE.git

	cd "${WRF_FOLDER}"/WRF-SFIRE/
	LD_LIBRARY_PATH= ./clean -a # Clean old configuration files

	if [ ${auto_config} -eq 1 ]; then
		(
			echo 34
			echo 1
		) | ./configure

	else
		./configure 2>&1 | tee configure.log #Option 34 gfortran compiler with distributed memory option 1 for basic nesting
	fi

	LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN em_real 2>&1 | tee compile.wrf1.log

	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WRF-SFIRE/main
	n=$(ls ./*.exe | wc -l)
	if (($n >= 3)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		cd "${WRF_FOLDER}"/WRF-SFIRE/
		LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN em_real 2>&1 | tee compile.wrf2.log
		cd "${WRF_FOLDER}"/WRF-SFIRE/main
		n=$(ls ./*.exe | wc -l)
		if (($n >= 3)); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	echo " "

	cd "${WRF_FOLDER}"/WRF-SFIRE

	export WRF_DIR="${WRF_FOLDER}"/WRF-SFIRE

	############################WPSV4.2#####################################
	## WPS v4.2
	## Downloaded from git tagged releases
	# Cloned from openwfm
	#Option 3 for gfortran and distributed memory
	########################################################################
	cd "${WRF_FOLDER}"
	git clone https://github.com/openwfm/WPS.git

	cd "${WRF_FOLDER}"/WPS
	LD_LIBRARY_PATH= ./clean -a

	cd "${WRF_FOLDER}"/WPS

	if [ ${auto_config} -eq 1 ]; then
		FFLAGS=$FFLAGS echo 3 | ./configure 2>&1 | tee configure.log #Option 3 for gfortran and distributed memory
	else
		FFLAGS=$FFLAGS ./configure 2>&1 | tee configure.log #Option 3 gfortran compiler with distributed memory
	fi

	#sed statements for issue with GNUv10+

	if [ $GCC_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GFORTRAN_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GPLUSPLUS_VERSION_MAJOR_VERSION -ge $version_10 ]; then
		sed -i '70s/-frecord-marker=4/-frecord-marker=4 -m64 -fallow-argument-mismatch/g' "${WRF_FOLDER}"/WPS/configure.wps
		sed -i '71s/-frecord-marker=4/-frecord-marker=4 -m64 -fallow-argument-mismatch/g' "${WRF_FOLDER}"/WPS/configure.wps
	fi

	LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.wps.log

	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WPS
	n=$(ls ./*.exe | wc -l)
	if (($n == 3)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WPS. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"

		LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.wps2.log
		cd "${WRF_FOLDER}"/WPS
		n=$(ls ./*.exe | wc -l)
		if (($n == 3)); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WPS. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	echo " "

	######################## Static Geography Data inc/ Optional ####################
	# http://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html
	# These files are large so if you only need certain ones comment the others off
	# All files downloaded and untarred is 200GB
	# https://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html
	#################################################################################
	cd "${WRF_FOLDER}"/Downloads
	mkdir "${WRF_FOLDER}"/GEOG
	mkdir "${WRF_FOLDER}"/GEOG/WPS_GEOG

	echo " "
	echo "Mandatory WRF Preprocessing System (WPS) Geographical Input Data Mandatory Fields Downloads"
	echo " "
	wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_high_res_mandatory.tar.gz
	LD_LIBRARY_PATH= tar -xvzf geog_high_res_mandatory.tar.gz -C "${WRF_FOLDER}"/GEOG/

	wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_low_res_mandatory.tar.gz
	LD_LIBRARY_PATH= tar -xvzf geog_low_res_mandatory.tar.gz -C "${WRF_FOLDER}"/GEOG/
	mv "${WRF_FOLDER}"/GEOG/WPS_GEOG_LOW_RES/ "${WRF_FOLDER}"/GEOG/WPS_GEOG

	if [ ${WPS_Specific_Applications} -eq 1 ]; then
		echo " "
		echo " WPS Geographical Input Data Mandatory for Specific Applications"
		echo " "

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_thompson28_chem.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_thompson28_chem.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_noahmp.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_noahmp.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/irrigation.tar.gz
		LD_LIBRARY_PATH= tar -xvzf irrigation.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_px.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_px.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_urban.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_urban.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_ssib.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_ssib.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/lake_depth.tar.bz2
		LD_LIBRARY_PATH= tar -xvf lake_depth.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/topobath_30s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf topobath_30s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/gsl_gwd.tar.bz2
		LD_LIBRARY_PATH= tar -xvf gsl_gwd.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/cglc_modis_lcz_global.tar.gz
		LD_LIBRARY_PATH= tar -xvf cglc_modis_lcz_global.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG
	fi

	if [ ${Optional_GEOG} -eq 1 ]; then
		echo " "
		echo "Optional WPS Geographical Input Data"
		echo " "

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_older_than_2000.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_older_than_2000.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/modis_landuse_20class_15s_with_lakes.tar.gz
		LD_LIBRARY_PATH= tar -xvzf modis_landuse_20class_15s_with_lakes.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_alt_lsm.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_alt_lsm.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/nlcd2006_ll_9s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf nlcd2006_ll_9s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/updated_Iceland_LU.tar.gz
		LD_LIBRARY_PATH= tar -xvf updated_Iceland_LU.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/modis_landuse_20class_15s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf modis_landuse_20class_15s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

	fi

fi

if [ "$macos_64bit_GNU" = "1" ] && [ "$SFIRE_PICK" = "1" ] && [ "$MAC_CHIP" = "Intel" ]; then

	## WRF installation with parallel process.
	# Download and install required library and data files for WRF.
	# Tested in macOS Ventura 13.4.1
	# Tested in 64-bit
	# Tested with current available libraries on 03/01/2025
	# If newer libraries exist edit script paths for changes
	#Estimated Run Time ~ 90 - 150 Minutes with 10mb/s downloadspeed.
	#Special thanks to  Youtube's meteoadriatic and GitHub user jamal919.

	#############################basic package managment############################

	brew cleanup -s
	brew update
	outdated_packages=$(brew outdated --quiet)

	# List of packages to check/install
	packages=(
		"autoconf" "automake" "bison" "byacc" "cmake" "curl" "flex" "gcc@13"
		"gedit" "git" "gnu-sed" "ksh"
		"libtool" "libxml2" "m4" "make" "python@3.12" "tcsh" "wget"
		"xauth" "xorgproto" "xorgrgb" "xquartz"
	)

	for pkg in "${packages[@]}"; do
		if brew list "$pkg" &>/dev/null; then
			echo "$pkg is already installed."
			if [[ $outdated_packages == *"$pkg"* ]]; then
				echo "$pkg has a newer version available. Upgrading..."
				brew upgrade "$pkg"
			fi
		else
			echo "$pkg is not installed. Installing..."
			brew install "$pkg"
		fi
		sleep 1
	done

	export LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH
	export PATH=/usr/local/bin:$PATH
	##############################Directory Listing############################

	export HOME=$(
		cd
		pwd
	)

	mkdir $HOME/WRF_SFIRE
	export WRF_FOLDER=$HOME/WRF_SFIRE
	cd "${WRF_FOLDER}"/
	mkdir Downloads
	mkdir Libs
	export DIR="${WRF_FOLDER}"/Libs
	mkdir Libs/grib2
	mkdir Libs/NETCDF

	echo " "
	#############################Core Management####################################
	export CPU_CORE=$(sysctl -n hw.ncpu) # number of available threads on system
	export CPU_6CORE="6"
	export CPU_QUARTER=$(($CPU_CORE / 4))
	#1/2 of availble cores on system
	export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))
	#Forces CPU cores to even number to avoid partial core export. ie 7 cores would be 3.5 cores.

	if [ $CPU_CORE -le $CPU_6CORE ]; then #If statement for low core systems.  Forces computers to only use 1 core if there are 4 cores or less on the system. then
		export CPU_QUARTER_EVEN="2"
	else
		export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))
	fi

	echo "##########################################"
	echo "Number of Threads being used $CPU_QUARTER_EVEN"
	echo "##########################################"
	echo " "

	##############################Downloading Libraries############################

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/madler/zlib/releases/download/v$Zlib_Version/zlib-$Zlib_Version.tar.gz
	wget -c https://github.com/HDFGroup/hdf5/releases/download/hdf5_$HDF5_Version/hdf5-$HDF5_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-c/archive/refs/tags/v$Netcdf_C_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-fortran/archive/refs/tags/v$Netcdf_Fortran_Version.tar.gz
	wget -c https://download.sourceforge.net/libpng/libpng-$Libpng_Version.tar.gz
	wget -c https://www.ece.uvic.ca/~frodo/jasper/software/jasper-$Jasper_Version.zip
	wget -c https://github.com/pmodels/mpich/releases/download/v$Mpich_Version/mpich-$Mpich_Version.tar.gz
	wget -c https://parallel-netcdf.github.io/Release/pnetcdf-$Pnetcdf_Version.tar.gz
	wget -c https://github.com/openwfm/convert_geotiff/releases/download/v0.1/convert_geotiff-0.1.0.tar.gz
	echo " "

	############################# Compilers #############################

	# Symlink to avoid clang conflicts with compilers
	# Default gcc path: /usr/bin/gcc
	# Default homebrew path: /usr/local/bin

	# Find the highest version of GCC, G++, and GFortran in /usr/local/bin
	latest_gcc=gcc-13
	latest_gpp=g++-13
	latest_gfortran=gfortran-13

	# Display the chosen versions
	echo "Selected gcc version: $latest_gcc"
	echo "Selected g++ version: $latest_gpp"
	echo "Selected gfortran version: $latest_gfortran"

	# Check if GCC was found

	# Create or update the symbolic links for GCC, G++, and GFortran
	echo "Linking the latest GCC version: $latest_gcc"
	echo $PASSWD | sudo -S ln -sf /usr/local/bin/$latest_gcc /usr/local/bin/gcc

	echo "Linking the latest G++ version: $latest_gpp"
	echo $PASSWD | sudo -S ln -sf /usr/local/bin/$latest_gpp /usr/local/bin/g++

	echo "Linking the latest GFortran version: $latest_gfortran"
	echo $PASSWD | sudo -S ln -sf /usr/local/bin/$latest_gfortran /usr/local/bin/gfortran

	echo "Updated symbolic links for GCC, G++, and GFortran."
	echo $PASSWD | sudo -S ln -sf /usr/local/bin/python3.12 /usr/local/bin/python3

	# Export compiler environment variables
	export CC=gcc
	export CXX=g++
	export FC=gfortran
	export F77=gfortran
	export CFLAGS="-fPIC -fPIE -Wno-implicit-function-declaration -Wno-incompatible-pointer-types -Wall"

	echo " "

	############################# End of Compiler Setup #############################

	#IF statement for GNU compiler issue
	export GCC_VERSION=$(/usr/local/bin/$latest_gcc -dumpfullversion | awk '{print$1}')
	export GFORTRAN_VERSION=$(/usr/local/bin/$latest_gfortran -dumpfullversion | awk '{print$1}')
	export GPLUSPLUS_VERSION=$(/usr/local/bin/$latest_gpp -dumpfullversion | awk '{print$1}')

	export GCC_VERSION_MAJOR_VERSION=$(echo $GCC_VERSION | awk -F. '{print $1}')
	export GFORTRAN_VERSION_MAJOR_VERSION=$(echo $GFORTRAN_VERSION | awk -F. '{print $1}')
	export GPLUSPLUS_VERSION_MAJOR_VERSION=$(echo $GPLUSPLUS_VERSION | awk -F. '{print $1}')

	export version_10="10"

	if [ $GCC_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GFORTRAN_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GPLUSPLUS_VERSION_MAJOR_VERSION -ge $version_10 ]; then
		export fallow_argument=-fallow-argument-mismatch
		export boz_argument=-fallow-invalid-boz
	else
		export fallow_argument=
		export boz_argument=
	fi

	export FFLAGS="$fallow_argument -m64"
	export FCFLAGS="$fallow_argument -m64"

	echo "##########################################"
	echo "FFLAGS = $FFLAGS"
	echo "FCFLAGS = $FCFLAGS"
	echo "CFLAGS = $CFLAGS"
	echo "##########################################"

	echo " "

	############################# ZLib ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf zlib-$Zlib_Version.tar.gz
	cd zlib-$Zlib_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	export ZLIB_ROOT=$DIR/grib2
	export ZLIBLIB=$DIR/grib2/lib
	export ZLIBINC=$DIR/grib2/include

	echo " "

	############################## MPICH ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf mpich-$Mpich_Version.tar.gz
	cd mpich-$Mpich_Version/

	F90= ./configure --prefix=$DIR/MPICH --with-device=ch3 FFLAGS="$fallow_argument -m64" FCFLAGS="$fallow_argument -m64" 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/MPICH/bin:$PATH

	export MPIFC=$DIR/MPICH/bin/mpifort
	export MPIF77=$DIR/MPICH/bin/mpifort
	export MPIF90=$DIR/MPICH/bin/mpifort
	export MPICC=$DIR/MPICH/bin/mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx

	echo " "

	############################# libpng ############################

	cd "${WRF_FOLDER}"/Downloads

	# other libraries below need these variables to be set
	export LDFLAGS=-L$DIR/grib2/lib
	export CPPFLAGS=-I$DIR/grib2/include

	LD_LIBRARY_PATH= tar -xvzf libpng-$Libpng_Version.tar.gz
	cd libpng-$Libpng_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNG_ROOT=$DIR/grib2

	echo " "
	#############################JasPer ############################

	cd "${WRF_FOLDER}"/Downloads
	unzip jasper-$Jasper_Version.zip
	cd jasper-$Jasper_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	export JASPERLIB=$DIR/grib2/lib
	export JASPERINC=$DIR/grib2/include
	export JASPER_DIR=$DIR/grib2
	export Jasper_ROOT=$DIR/grib2/lib

	echo " "
	############################# hdf5 library for netcdf4 functionality ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf hdf5-$HDF5_Version.tar.gz
	cd hdf5-$HDF5_Version

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --with-zlib=$DIR/grib2 --enable-hl --enable-fortran --enable-parallel 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export HDF5=$DIR/grib2
	export PATH=$HDF5/bin:$PATH
	export PHDF5=$DIR/grib2
	export HDF5_ROOT=$DIR/grib2
	export PHDF5_ROOT=$DIR/grib2

	echo " "

	############################# Install Parallel-netCDF ##############################
	#Make file created with half of available cpu cores
	#Hard path for MPI added
	##################################################################################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf pnetcdf-$Pnetcdf_Version.tar.gz
	cd pnetcdf-$Pnetcdf_Version

	export MPIFC=$DIR/MPICH/bin/mpifort
	export MPIF77=$DIR/MPICH/bin/mpifort
	export MPIF90=$DIR/MPICH/bin/mpifort
	export MPICC=$DIR/MPICH/bin/mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx

	# drop --disable-utils (not recognized)
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS="-std=gnu99 $CFLAGS" FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --enable-static 2>&1 | tee configure.log

	# build only libraries
	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log

	# install only libraries and headers
	make install 2>&1 | tee make.install.log

	export PNETCDF=$DIR/grib2
	export PNETCDF_DIR=$DIR/grib2
	export PNETCDF_ROOT=$DIR/grib2

	echo " "

	read -r -t 3 -p

	############################## Install NETCDF C Library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_C_Version.tar.gz
	cd netcdf-c-$Netcdf_C_Version/
	export CPPFLAGS=-I$DIR/grib2/include
	export LDFLAGS="-L$DIR/grib2/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lhdf5_hl -lhdf5 -lz -lcurl -lgfortran -lgcc -lm -ldl -lpnetcdf"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --disable-dap --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-pnetcdf --enable-cdf5 --enable-parallel-tests --enable-logging 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/NETCDF/bin:$PATH
	export NETCDF=$DIR/NETCDF
	export NETCDF_INC=$DIR/NETCDF/include
	export NETCDF_LIB=$DIR/NETCDF/lib
	export NETCDF_ROOT=$DIR/NETCDF
	export LD_LIBRARY_PATH=$DIR/grib2/lib:$DIR/NETCDF/lib:$LD_LIBRARY_PATH

	echo " "

	############################## NetCDF fortran library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_Fortran_Version.tar.gz
	cd netcdf-fortran-$Netcdf_Fortran_Version/
	export LD_LIBRARY_PATH=$DIR/NETCDF/lib:$LD_LIBRARY_PATH
	export CPPFLAGS="-I$DIR/NETCDF/include -I$DIR/grib2/include"
	export LDFLAGS="-L$DIR/NETCDF/lib -L$DIR/grib2/lib -Wl,-rpath,$DIR/NETCDF/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lnetcdf -lpnetcdf -lcurl -lhdf5_hl -lhdf5 -lz -lm -ldl -lgcc -lgfortran"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-parallel-tests --enable-logging --enable-hdf5 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	echo " "

	############################# Convert Geo Tiff #################################

	cd $WRF_FOLDER/Downloads
	LD_LIBRARY_PATH= tar -xzvf convert_geotiff-0.1.0.tar.gz
	cd convert_geotiff-0.1.0

	# Adjust CPP flags for Geo Tiff

	export TIFF_LIB=/usr/local/lib
	export TIFF_INC=/usr/local/include
	export GEOTIFF_LIB=/usr/local/lib
	export GEOTIFF_INC=/usr/local/include

	export CPPFLAGS="-I$DIR/NETCDF/include -I$DIR/grib2/include -I$GEOTIFF_INC -I$TIFF_INC"
	export LDFLAGS="-L$DIR/NETCDF/lib -L$DIR/grib2/lib -Wl,-rpath,$DIR/NETCDF/lib -Wl,-rpath,$DIR/grib2/lib -L$GEOTIFF_LIB -L$TIFF_LIB"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS="-std=c11 $CFLAGS" FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure -exec-prefix=$DIR/grib2 --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	# Changes flags back to netcdf only
	export CPPFLAGS="-I$DIR/NETCDF/include -I$DIR/grib2/include"
	export LDFLAGS="-L$DIR/NETCDF/lib -L$DIR/grib2/lib -Wl,-rpath,$DIR/NETCDF/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lnetcdf -lpnetcdf -lcurl -lhdf5_hl -lhdf5 -lz -lm -ldl -lgcc -lgfortran"

	#################################### System Environment Tests ##############
	mkdir -p "${WRF_FOLDER}"/Tests/Environment
	mkdir -p "${WRF_FOLDER}"/Tests/Compatibility

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_NETCDF_MPI_tests.tar
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_tests.tar

	LD_LIBRARY_PATH= tar -xvf Fortran_C_tests.tar -C "${WRF_FOLDER}"/Tests/Environment
	LD_LIBRARY_PATH= tar -xvf Fortran_C_NETCDF_MPI_tests.tar -C "${WRF_FOLDER}"/Tests/Compatibility
	export one="1"
	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Environment

	echo " "
	echo " "
	echo "Environment Testing "
	echo "Test 1"
	$FC TEST_1_fortran_only_fixed.f
	./a.out | tee env_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 1 Passed"
	else
		echo "Environment Compiler Test 1 Failed"
		exit
	fi
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 2"
	$FC TEST_2_fortran_only_free.f90
	./a.out | tee env_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 2 Passed"
	else
		echo "Environment Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 3"
	$CC TEST_3_c_only.c
	./a.out | tee env_test3.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test3.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 3 Passed"
	else
		echo "Environment Compiler Test 3 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 4"
	$CC -c -m64 TEST_4_fortran+c_c.c
	$FC -c -m64 TEST_4_fortran+c_f.f90
	$FC -m64 TEST_4_fortran+c_f.o TEST_4_fortran+c_c.o
	./a.out | tee env_test4.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test4.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 4 Passed"
	else
		echo "Environment Compiler Test 4 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Compatibility

	cp ${NETCDF}/include/netcdf.inc .

	echo " "
	echo " "
	echo "Library Compatibility Tests "
	echo "Test 1"
	$FC -c 01_fortran+c+netcdf_f.f
	$CC -c 01_fortran+c+netcdf_c.c
	$FC 01_fortran+c+netcdf_f.o 01_fortran+c+netcdf_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	./a.out | tee comp_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 1 Passed"
	else
		echo "Compatibility Compiler Test 1 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "

	echo "Test 2"
	$MPIFC -c 02_fortran+c+netcdf+mpi_f.f
	$MPICC -c 02_fortran+c+netcdf+mpi_c.c
	$MPIFC 02_fortran+c+netcdf+mpi_f.o \
		02_fortran+c+netcdf+mpi_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	$DIR/MPICH/bin/mpirun ./a.out | tee comp_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 2 Passed"
	else
		echo "Compatibility Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."
	echo " "

	echo " All tests completed and passed"
	echo " "

	echo " "

	################################OpenGrADS######################################
	#Verison 2.2.1 64bit of Linux
	#############################################################################
	if [[ $GRADS_PICK -eq 1 ]]; then
		cd "${WRF_FOLDER}"/Downloads
		wget -c https://sourceforge.net/projects/opengrads/files/grads2/2.2.1.oga.1/macOS/opengrads-2.2.1.oga.1-bundle-x86_64-apple-darwin20.5.0.pkg
		sudo -S installer -pkg opengrads-2.2.1.oga.1-bundle-x86_64-apple-darwin20.5.0.pkg -target /Applications/OpenGrads <<<"$PASSWD"

	fi
	################################## GrADS ###############################
	# Version  2.2.1
	# Sublibs library instructions: http://cola.gmu.edu/grads/gadoc/supplibs2.html
	# GrADS instructions: http://cola.gmu.edu/grads/downloads.php
	########################################################################
	if [[ $GRADS_PICK -eq 2 ]]; then

		brew install grads

	fi

	######################################################################
	#Installing Miniconda3 to WRF directory and updating libraries
	######################################################################
	echo $PASSWD | sudo -S apt -y install python3-zstandard python3-zstd

	export Miniconda_Install_DIR="${WRF_FOLDER}"/miniconda3

	mkdir -p $Miniconda_Install_DIR

	wget -c https://repo.anaconda.com/miniconda/Miniconda3-latest-MacOSX-x86_64.sh -O $Miniconda_Install_DIR/miniconda.sh
	bash $Miniconda_Install_DIR/miniconda.sh -b -u -p $Miniconda_Install_DIR

	rm -rf $Miniconda_Install_DIR/miniconda.sh

	export PATH="${WRF_FOLDER}"/miniconda3/bin:$PATH

	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	$Miniconda_Install_DIR/bin/conda init bash

	conda tos accept
	conda config --add channels conda-forge
	conda config --set auto_activate_base false
	conda update -n root --all -y

	echo " "

	#Installing NCL via Conda
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	conda create -n ncl_stable -c conda-forge ncl -y
	conda activate ncl_stable

	conda deactivate
	conda deactivate
	conda deactivate
	echo " "

	##################### WRF Python           ##################
	########### WRf-Python compiled via Conda  ##################
	########### This is the preferred method by NCAR      ##################
	##### https://wrf-python.readthedocs.io/en/latest/installation.html  ##################
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh
	conda env create -f $HOME/WRF-MOSIT/wrf-python-stable.yml

	######################### Climate Data Operators ############
	######################### CDO compiled via Conda ###########
	####################### This is the preferred method #######
	################### https://bairdlangenbrunner.github.io/python-for-climate-scientists/conda/setting-up-conda-environments.html #######################

	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	conda create --name cdo_stable -y
	conda activate cdo_stable
	conda install -c conda-forge cdo -y
	conda update --all -y
	conda deactivate
	conda deactivate
	conda deactivate

	echo " "

	############################ WRF-SFIRE  #################################
	## WRF-SFIRE
	# Cloned from openwfm
	# option 34, option 1 for gfortran and distributed memory w/basic nesting
	# large file support enable with WRFiO_NCD_LARGE_FILE_SUPPORT=1
	########################################################################
	cd $WRF_FOLDER
	git clone https://github.com/openwfm/WRF-SFIRE.git

	cd $WRF_FOLDER/WRF-SFIRE/
	./clean -a # Clean old configuration files

	if [ ${auto_config} -eq 1 ]; then
		(
			echo 17
			echo 1
		) | ./configure 2>&1 | tee configure.log
	else
		./configure 2>&1 | tee configure.log #Option 17 gfortran compiler with distributed memory option 1 for basic nesting
	fi

	sed -i'' -e '145s/-c/-c -fPIC -fPIE -Wno-implicit-function-declaration -Wno-incompatible-pointer-types -Wall/g' configure.wrf

	LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN em_real 2>&1 | tee compile.wrf1.log

	# IF statement to check that all files were created.
	cd $WRF_FOLDER/WRF-SFIRE/main
	n=$(ls ./*.exe | wc -l)
	if (($n >= 3)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		cd $WRF_FOLDER/WRF-SFIRE/
		LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN em_real 2>&1 | tee compile.wrf2.log
		cd $WRF_FOLDER/WRF-SFIRE/main
		n=$(ls ./*.exe | wc -l)
		if (($n >= 3)); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	echo " "

	read -r -t 3 -p
	cd $WRF_FOLDER/WRF-SFIRE
	LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN em_fire 2>&1 | tee compile.wrfsfire.log

	export WRF_DIR=$WRF_FOLDER/WRF-SFIRE

	read -r -t 3 -p

	############################WPS#####################################
	## WPS v${WPS_VERSION}
	## Downloaded from git tagged releases
	#Option 3 for gfortran and distributed memory
	########################################################################

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/wrf-model/WPS/archive/refs/tags/v${WPS_VERSION}.tar.gz -O WPS-${WPS_VERSION}.tar.gz
	LD_LIBRARY_PATH= tar -xvzf WPS-${WPS_VERSION}.tar.gz -C "${WRF_FOLDER}"/
	# Check if WPS directory exists
	if [ -d "${WRF_FOLDER}/WPS" ]; then
		mv -f "${WRF_FOLDER}/WPS" "${WRF_FOLDER}/WPS-${WPS_VERSION}"

	# Else, check for any folder matching WPSV* or WPS-*
	else
		for dir in "${WRF_FOLDER}"/WPSV* "${WRF_FOLDER}"/WPS-*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WPS-${WPS_VERSION}"
				break
			fi
		done
	fi
	cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
	LD_LIBRARY_PATH= ./clean -a

	if [ ${auto_config} -eq 1 ]; then
		echo 19 | ./configure 2>&1 | tee configure.log #Option 19 for gfortran and distributed memory
	else
		./configure 2>&1 | tee configure.log #Option 19 gfortran compiler with distributed memory
	fi
	LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.wps.log

	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
	n=$(ls ./*.exe | wc -l)
	if (($n == 3)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WPS. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.wps2.log
		cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
		n=$(ls ./*.exe | wc -l)
		if (($n == 3)); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WPS. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	echo " "

	######################## Static Geography Data inc/ Optional ####################
	# http://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html
	# These files are large so if you only need certain ones comment the others off
	# All files downloaded and untarred is 200GB
	# https://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html
	#################################################################################
	cd "${WRF_FOLDER}"/Downloads
	mkdir "${WRF_FOLDER}"/GEOG
	mkdir "${WRF_FOLDER}"/GEOG/WPS_GEOG

	echo " "
	echo "Mandatory WRF Preprocessing System (WPS) Geographical Input Data Mandatory Fields Downloads"
	echo " "
	wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_high_res_mandatory.tar.gz
	LD_LIBRARY_PATH= tar -xvzf geog_high_res_mandatory.tar.gz -C "${WRF_FOLDER}"/GEOG/

	wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_low_res_mandatory.tar.gz
	LD_LIBRARY_PATH= tar -xvzf geog_low_res_mandatory.tar.gz -C "${WRF_FOLDER}"/GEOG/
	mv "${WRF_FOLDER}"/GEOG/WPS_GEOG_LOW_RES/ "${WRF_FOLDER}"/GEOG/WPS_GEOG

	if [ ${WPS_Specific_Applications} -eq 1 ]; then
		echo " "
		echo " WPS Geographical Input Data Mandatory for Specific Applications"
		echo " "

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_thompson28_chem.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_thompson28_chem.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_noahmp.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_noahmp.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/irrigation.tar.gz
		LD_LIBRARY_PATH= tar -xvzf irrigation.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_px.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_px.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_urban.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_urban.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_ssib.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_ssib.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/lake_depth.tar.bz2
		LD_LIBRARY_PATH= tar -xvf lake_depth.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/topobath_30s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf topobath_30s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/gsl_gwd.tar.bz2
		LD_LIBRARY_PATH= tar -xvf gsl_gwd.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/cglc_modis_lcz_global.tar.gz
		LD_LIBRARY_PATH= tar -xvf cglc_modis_lcz_global.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG
	fi

	if [ ${Optional_GEOG} -eq 1 ]; then
		echo " "
		echo "Optional WPS Geographical Input Data"
		echo " "

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_older_than_2000.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_older_than_2000.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/modis_landuse_20class_15s_with_lakes.tar.gz
		LD_LIBRARY_PATH= tar -xvzf modis_landuse_20class_15s_with_lakes.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_alt_lsm.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_alt_lsm.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/nlcd2006_ll_9s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf nlcd2006_ll_9s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/updated_Iceland_LU.tar.gz
		LD_LIBRARY_PATH= tar -xvf updated_Iceland_LU.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/modis_landuse_20class_15s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf modis_landuse_20class_15s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG
	fi

fi

if [ "$macos_64bit_GNU" = "1" ] && [ "$SFIRE_PICK" = "1" ] && [ "$MAC_CHIP" = "ARM" ]; then

	## WRF installation with parallel process.
	# Download and install required library and data files for WRF.
	# Tested in macOS Ventura 13.4.1
	# Tested in 64-bit
	# Tested with current available libraries on 03/01/2025
	# If newer libraries exist edit script paths for changes
	#Estimated Run Time ~ 90 - 150 Minutes with 10mb/s downloadspeed.
	#Special thanks to  Youtube's meteoadriatic and GitHub user jamal919.

	#############################basic package managment############################

	brew cleanup -s
	brew update
	outdated_packages=$(brew outdated --quiet)

	# List of packages to check/install
	packages=(
		"autoconf" "automake" "bison" "byacc" "cmake" "curl" "flex" "gcc@13"
		"gedit" "git" "gnu-sed" "ksh"
		"libtool" "libxml2" "m4" "make" "python@3.12" "tcsh" "wget"
		"xauth" "xorgproto" "xorgrgb" "xquartz"
	)

	for pkg in "${packages[@]}"; do
		if brew list "$pkg" &>/dev/null; then
			echo "$pkg is already installed."
			if [[ $outdated_packages == *"$pkg"* ]]; then
				echo "$pkg has a newer version available. Upgrading..."
				brew upgrade "$pkg"
			fi
		else
			echo "$pkg is not installed. Installing..."
			brew install "$pkg"
		fi
		sleep 1
	done

	export LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH
	export PATH=/usr/local/bin:$PATH
	##############################Directory Listing############################

	export HOME=$(
		cd
		pwd
	)

	mkdir $HOME/WRF_SFIRE
	export WRF_FOLDER=$HOME/WRF_SFIRE
	cd "${WRF_FOLDER}"/
	mkdir Downloads
	mkdir Libs
	export DIR="${WRF_FOLDER}"/Libs
	mkdir Libs/grib2
	mkdir Libs/NETCDF

	echo " "
	#############################Core Management####################################
	export CPU_CORE=$(sysctl -n hw.ncpu) # number of available threads on system
	export CPU_6CORE="6"
	export CPU_QUARTER=$(($CPU_CORE / 4))
	#1/2 of availble cores on system
	export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))
	#Forces CPU cores to even number to avoid partial core export. ie 7 cores would be 3.5 cores.

	if [ $CPU_CORE -le $CPU_6CORE ]; then #If statement for low core systems.  Forces computers to only use 1 core if there are 4 cores or less on the system. then
		export CPU_QUARTER_EVEN="2"
	else
		export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))
	fi

	echo "##########################################"
	echo "Number of Threads being used $CPU_QUARTER_EVEN"
	echo "##########################################"
	echo " "

	##############################Downloading Libraries############################

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/madler/zlib/releases/download/v$Zlib_Version/zlib-$Zlib_Version.tar.gz
	wget -c https://github.com/HDFGroup/hdf5/releases/download/hdf5_$HDF5_Version/hdf5-$HDF5_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-c/archive/refs/tags/v$Netcdf_C_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-fortran/archive/refs/tags/v$Netcdf_Fortran_Version.tar.gz
	wget -c https://download.sourceforge.net/libpng/libpng-$Libpng_Version.tar.gz
	wget -c https://www.ece.uvic.ca/~frodo/jasper/software/jasper-$Jasper_Version.zip
	wget -c https://github.com/pmodels/mpich/releases/download/v$Mpich_Version/mpich-$Mpich_Version.tar.gz
	wget -c https://parallel-netcdf.github.io/Release/pnetcdf-$Pnetcdf_Version.tar.gz
	wget -c https://github.com/openwfm/convert_geotiff/releases/download/v0.1/convert_geotiff-0.1.0.tar.gz
	echo " "

	############################# Compilers #############################

	# Symlink to avoid clang conflicts with compilers
	# Default gcc path: /usr/bin/gcc
	# Default homebrew path: /usr/local/bin

	# Unlink any existing Homebrew compiler symlinks
	echo $PASSWD | sudo -S unlink /opt/homebrew/bin/gfortran
	echo $PASSWD | sudo -S unlink /opt/homebrew/bin/gcc
	echo $PASSWD | sudo -S unlink /opt/homebrew/bin/g++

	# Source the bashrc to ensure environment variables are loaded
	source ~/.bashrc

	# Check current versions of gcc, g++, and gfortran (these should show "command not found" if unlinked)
	gcc --version
	g++ --version
	gfortran --version

	# Navigate to the Homebrew binaries directory
	cd /opt/homebrew/bin

	# Find the latest version of GCC, G++, and GFortran
	latest_gcc=gcc-13
	latest_gpp=g++-13
	latest_gfortran=gfortran-13

	# Check if the latest versions were found and link them
	echo "Linking the latest GCC version: $latest_gcc"
	echo $PASSWD | sudo -S ln -sf $latest_gcc gcc
	echo "Linking the latest G++ version: $latest_gpp"
	echo $PASSWD | sudo -S ln -sf $latest_gpp g++
	echo "Linking the latest GFortran version: $latest_gfortran"
	echo $PASSWD | sudo -S ln -sf $latest_gfortran gfortran

	# Return to the home directory
	cd

	# Source bashrc and bash_profile to reload the environment settings
	source ~/.bashrc
	source ~/.bash_profile

	# Check if the versions were successfully updated
	gcc --version
	g++ --version
	gfortran --version

	# Export compiler environment variables
	export CC=gcc
	export CXX=g++
	export FC=gfortran
	export F77=gfortran
	export CFLAGS="-fPIC -fPIE -Wno-implicit-function-declaration -Wno-incompatible-pointer-types -Wall"

	echo " "

	############################# End of Compiler Setup #############################

	#IF statement for GNU compiler issue
	export GCC_VERSION=$(/usr/local/bin/$latest_gcc -dumpfullversion | awk '{print$1}')
	export GFORTRAN_VERSION=$(/usr/local/bin/$latest_gfortran -dumpfullversion | awk '{print$1}')
	export GPLUSPLUS_VERSION=$(/usr/local/bin/$latest_gpp -dumpfullversion | awk '{print$1}')

	export GCC_VERSION_MAJOR_VERSION=$(echo $GCC_VERSION | awk -F. '{print $1}')
	export GFORTRAN_VERSION_MAJOR_VERSION=$(echo $GFORTRAN_VERSION | awk -F. '{print $1}')
	export GPLUSPLUS_VERSION_MAJOR_VERSION=$(echo $GPLUSPLUS_VERSION | awk -F. '{print $1}')

	export version_10="10"

	if [ $GCC_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GFORTRAN_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GPLUSPLUS_VERSION_MAJOR_VERSION -ge $version_10 ]; then
		export fallow_argument=-fallow-argument-mismatch
		export boz_argument=-fallow-invalid-boz
	else
		export fallow_argument=
		export boz_argument=
	fi

	export FFLAGS="$fallow_argument -m64"
	export FCFLAGS="$fallow_argument -m64"

	echo "##########################################"
	echo "FFLAGS = $FFLAGS"
	echo "FCFLAGS = $FCFLAGS"
	echo "CFLAGS = $CFLAGS"
	echo "##########################################"

	echo " "

	############################# ZLib ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf zlib-$Zlib_Version.tar.gz
	cd zlib-$Zlib_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	export ZLIB_ROOT=$DIR/grib2
	export ZLIBLIB=$DIR/grib2/lib
	export ZLIBINC=$DIR/grib2/include

	echo " "

	############################## MPICH ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf mpich-$Mpich_Version.tar.gz
	cd mpich-$Mpich_Version/

	F90= ./configure --prefix=$DIR/MPICH --with-device=ch3 FFLAGS="$fallow_argument -m64" FCFLAGS="$fallow_argument -m64" 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/MPICH/bin:$PATH

	export MPIFC=$DIR/MPICH/bin/mpifort
	export MPIF77=$DIR/MPICH/bin/mpifort
	export MPIF90=$DIR/MPICH/bin/mpifort
	export MPICC=$DIR/MPICH/bin/mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx

	echo " "

	############################# libpng ############################

	cd "${WRF_FOLDER}"/Downloads

	# other libraries below need these variables to be set
	export LDFLAGS=-L$DIR/grib2/lib
	export CPPFLAGS=-I$DIR/grib2/include

	LD_LIBRARY_PATH= tar -xvzf libpng-$Libpng_Version.tar.gz
	cd libpng-$Libpng_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNG_ROOT=$DIR/grib2

	echo " "
	#############################JasPer ############################

	cd "${WRF_FOLDER}"/Downloads
	unzip jasper-$Jasper_Version.zip
	cd jasper-$Jasper_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	export JASPERLIB=$DIR/grib2/lib
	export JASPERINC=$DIR/grib2/include
	export JASPER_DIR=$DIR/grib2
	export Jasper_ROOT=$DIR/grib2/lib

	echo " "
	############################# hdf5 library for netcdf4 functionality ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf hdf5-$HDF5_Version.tar.gz
	cd hdf5-$HDF5_Version

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --with-zlib=$DIR/grib2 --enable-hl --enable-fortran --enable-parallel 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export HDF5=$DIR/grib2
	export PATH=$HDF5/bin:$PATH
	export PHDF5=$DIR/grib2
	export HDF5_ROOT=$DIR/grib2
	export PHDF5_ROOT=$DIR/grib2

	echo " "

	############################# Install Parallel-netCDF ##############################
	#Make file created with half of available cpu cores
	#Hard path for MPI added
	##################################################################################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf pnetcdf-$Pnetcdf_Version.tar.gz
	cd pnetcdf-$Pnetcdf_Version

	export MPIFC=$DIR/MPICH/bin/mpifort
	export MPIF77=$DIR/MPICH/bin/mpifort
	export MPIF90=$DIR/MPICH/bin/mpifort
	export MPICC=$DIR/MPICH/bin/mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx

	# drop --disable-utils (not recognized)
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS="-std=gnu99 $CFLAGS" FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --enable-static 2>&1 | tee configure.log

	# build only libraries
	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log

	# install only libraries and headers
	make install 2>&1 | tee make.install.log

	export PNETCDF=$DIR/grib2
	export PNETCDF_DIR=$DIR/grib2
	export PNETCDF_ROOT=$DIR/grib2

	echo " "

	read -r -t 3 -p

	############################## Install NETCDF C Library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_C_Version.tar.gz
	cd netcdf-c-$Netcdf_C_Version/
	export CPPFLAGS=-I$DIR/grib2/include
	export LDFLAGS="-L$DIR/grib2/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lhdf5_hl -lhdf5 -lz -lcurl -lgfortran -lgcc -lm -ldl -lpnetcdf"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --disable-dap --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-pnetcdf --enable-cdf5 --enable-parallel-tests --enable-logging 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/NETCDF/bin:$PATH
	export NETCDF=$DIR/NETCDF
	export NETCDF_INC=$DIR/NETCDF/include
	export NETCDF_LIB=$DIR/NETCDF/lib
	export NETCDF_ROOT=$DIR/NETCDF
	export LD_LIBRARY_PATH=$DIR/grib2/lib:$DIR/NETCDF/lib:$LD_LIBRARY_PATH

	echo " "

	############################## NetCDF fortran library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_Fortran_Version.tar.gz
	cd netcdf-fortran-$Netcdf_Fortran_Version/
	export LD_LIBRARY_PATH=$DIR/NETCDF/lib:$LD_LIBRARY_PATH
	export CPPFLAGS="-I$DIR/NETCDF/include -I$DIR/grib2/include"
	export LDFLAGS="-L$DIR/NETCDF/lib -L$DIR/grib2/lib -Wl,-rpath,$DIR/NETCDF/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lnetcdf -lpnetcdf -lcurl -lhdf5_hl -lhdf5 -lz -lm -ldl -lgcc -lgfortran"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-parallel-tests --enable-logging --enable-hdf5 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	echo " "

	############################# Convert Geo Tiff #################################

	cd $WRF_FOLDER/Downloads
	LD_LIBRARY_PATH= tar -xzvf convert_geotiff-0.1.0.tar.gz
	cd convert_geotiff-0.1.0

	# Adjust CPP flags for Geo Tiff

	export TIFF_LIB=/usr/local/lib
	export TIFF_INC=/usr/local/include
	export GEOTIFF_LIB=/usr/local/lib
	export GEOTIFF_INC=/usr/local/include

	export CPPFLAGS="-I$DIR/NETCDF/include -I$DIR/grib2/include -I$GEOTIFF_INC -I$TIFF_INC"
	export LDFLAGS="-L$DIR/NETCDF/lib -L$DIR/grib2/lib -Wl,-rpath,$DIR/NETCDF/lib -Wl,-rpath,$DIR/grib2/lib -L$GEOTIFF_LIB -L$TIFF_LIB"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS="-std=c11 $CFLAGS" FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure -exec-prefix=$DIR/grib2 --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	# Changes flags back to netcdf only
	export CPPFLAGS="-I$DIR/NETCDF/include -I$DIR/grib2/include"
	export LDFLAGS="-L$DIR/NETCDF/lib -L$DIR/grib2/lib -Wl,-rpath,$DIR/NETCDF/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lnetcdf -lpnetcdf -lcurl -lhdf5_hl -lhdf5 -lz -lm -ldl -lgcc -lgfortran"

	#################################### System Environment Tests ##############
	mkdir -p "${WRF_FOLDER}"/Tests/Environment
	mkdir -p "${WRF_FOLDER}"/Tests/Compatibility

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_NETCDF_MPI_tests.tar
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_tests.tar

	LD_LIBRARY_PATH= tar -xvf Fortran_C_tests.tar -C "${WRF_FOLDER}"/Tests/Environment
	LD_LIBRARY_PATH= tar -xvf Fortran_C_NETCDF_MPI_tests.tar -C "${WRF_FOLDER}"/Tests/Compatibility
	export one="1"
	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Environment

	echo " "
	echo " "
	echo "Environment Testing "
	echo "Test 1"
	$FC TEST_1_fortran_only_fixed.f
	./a.out | tee env_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 1 Passed"
	else
		echo "Environment Compiler Test 1 Failed"
		exit
	fi
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 2"
	$FC TEST_2_fortran_only_free.f90
	./a.out | tee env_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 2 Passed"
	else
		echo "Environment Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 3"
	$CC TEST_3_c_only.c
	./a.out | tee env_test3.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test3.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 3 Passed"
	else
		echo "Environment Compiler Test 3 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 4"
	$CC -c -m64 TEST_4_fortran+c_c.c
	$FC -c -m64 TEST_4_fortran+c_f.f90
	$FC -m64 TEST_4_fortran+c_f.o TEST_4_fortran+c_c.o
	./a.out | tee env_test4.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test4.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 4 Passed"
	else
		echo "Environment Compiler Test 4 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Compatibility

	cp ${NETCDF}/include/netcdf.inc .

	echo " "
	echo " "
	echo "Library Compatibility Tests "
	echo "Test 1"
	$FC -c 01_fortran+c+netcdf_f.f
	$CC -c 01_fortran+c+netcdf_c.c
	$FC 01_fortran+c+netcdf_f.o 01_fortran+c+netcdf_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	./a.out | tee comp_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 1 Passed"
	else
		echo "Compatibility Compiler Test 1 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "

	echo "Test 2"
	$MPIFC -c 02_fortran+c+netcdf+mpi_f.f
	$MPICC -c 02_fortran+c+netcdf+mpi_c.c
	$MPIFC 02_fortran+c+netcdf+mpi_f.o \
		02_fortran+c+netcdf+mpi_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	$DIR/MPICH/bin/mpirun ./a.out | tee comp_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 2 Passed"
	else
		echo "Compatibility Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."
	echo " "

	echo " All tests completed and passed"
	echo " "

	echo " "

	################################OpenGrADS######################################
	#Verison 2.2.1 64bit of Linux
	#############################################################################
	if [[ $GRADS_PICK -eq 1 ]]; then
		cd "${WRF_FOLDER}"/Downloads
		wget -c https://sourceforge.net/projects/opengrads/files/grads2/2.2.1.oga.1/macOS/opengrads-2.2.1.oga.1-bundle-x86_64-apple-darwin20.5.0.pkg
		sudo -S installer -pkg opengrads-2.2.1.oga.1-bundle-x86_64-apple-darwin20.5.0.pkg -target /Applications/OpenGrads <<<"$PASSWD"

	fi
	################################## GrADS ###############################
	# Version  2.2.1
	# Sublibs library instructions: http://cola.gmu.edu/grads/gadoc/supplibs2.html
	# GrADS instructions: http://cola.gmu.edu/grads/downloads.php
	########################################################################
	if [[ $GRADS_PICK -eq 2 ]]; then

		brew install grads

	fi

	######################################################################
	#Installing Miniconda3 to WRF directory and updating libraries
	######################################################################
	echo $PASSWD | sudo -S apt -y install python3-zstandard python3-zstd

	export Miniconda_Install_DIR="${WRF_FOLDER}"/miniconda3

	mkdir -p $Miniconda_Install_DIR

	wget -c https://repo.anaconda.com/miniconda/Miniconda3-latest-MacOSX-x86_64.sh -O $Miniconda_Install_DIR/miniconda.sh
	bash $Miniconda_Install_DIR/miniconda.sh -b -u -p $Miniconda_Install_DIR

	rm -rf $Miniconda_Install_DIR/miniconda.sh

	export PATH="${WRF_FOLDER}"/miniconda3/bin:$PATH

	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	$Miniconda_Install_DIR/bin/conda init bash

	conda tos accept
	conda config --add channels conda-forge
	conda config --set auto_activate_base false
	conda update -n root --all -y

	echo " "

	#Installing NCL via Conda
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	conda create -n ncl_stable -c conda-forge ncl -y
	conda activate ncl_stable

	conda deactivate
	conda deactivate
	conda deactivate
	echo " "

	##################### WRF Python           ##################
	########### WRf-Python compiled via Conda  ##################
	########### This is the preferred method by NCAR      ##################
	##### https://wrf-python.readthedocs.io/en/latest/installation.html  ##################
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh
	conda env create -f $HOME/WRF-MOSIT/wrf-python-stable.yml

	######################### Climate Data Operators ############
	######################### CDO compiled via Conda ###########
	####################### This is the preferred method #######
	################### https://bairdlangenbrunner.github.io/python-for-climate-scientists/conda/setting-up-conda-environments.html #######################

	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	conda create --name cdo_stable -y
	conda activate cdo_stable
	conda install -c conda-forge cdo -y
	conda update --all -y
	conda deactivate
	conda deactivate
	conda deactivate

	echo " "

	############################ WRF-SFIRE  #################################
	## WRF-SFIRE
	# Cloned from openwfm
	# option 34, option 1 for gfortran and distributed memory w/basic nesting
	# large file support enable with WRFiO_NCD_LARGE_FILE_SUPPORT=1
	########################################################################
	cd $WRF_FOLDER
	git clone https://github.com/openwfm/WRF-SFIRE.git

	cd $WRF_FOLDER/WRF-SFIRE/
	./clean -a # Clean old configuration files

	if [ ${auto_config} -eq 1 ]; then
		(
			echo 17
			echo 1
		) | ./configure 2>&1 | tee configure.log
	else
		./configure 2>&1 | tee configure.log #Option 17 gfortran compiler with distributed memory option 1 for basic nesting
	fi

	sed -i'' -e '145s/-c/-c -fPIC -fPIE -Wno-implicit-function-declaration -Wno-incompatible-pointer-types -Wall/g' configure.wrf

	LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN em_real 2>&1 | tee compile.wrf1.log

	# IF statement to check that all files were created.
	cd $WRF_FOLDER/WRF-SFIRE/main
	n=$(ls ./*.exe | wc -l)
	if (($n >= 3)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		cd $WRF_FOLDER/WRF-SFIRE/
		LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN em_real 2>&1 | tee compile.wrf2.log
		cd $WRF_FOLDER/WRF-SFIRE/main
		n=$(ls ./*.exe | wc -l)
		if (($n >= 3)); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	echo " "

	read -r -t 3 -p
	cd $WRF_FOLDER/WRF-SFIRE
	LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN em_fire 2>&1 | tee compile.wrfsfire.log

	export WRF_DIR=$WRF_FOLDER/WRF-SFIRE

	read -r -t 3 -p

	############################WPS#####################################
	## WPS v${WPS_VERSION}
	## Downloaded from git tagged releases
	#Option 3 for gfortran and distributed memory
	########################################################################

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/wrf-model/WPS/archive/refs/tags/v${WPS_VERSION}.tar.gz -O WPS-${WPS_VERSION}.tar.gz
	LD_LIBRARY_PATH= tar -xvzf WPS-${WPS_VERSION}.tar.gz -C "${WRF_FOLDER}"/
	# Check if WPS directory exists
	if [ -d "${WRF_FOLDER}/WPS" ]; then
		mv -f "${WRF_FOLDER}/WPS" "${WRF_FOLDER}/WPS-${WPS_VERSION}"

	# Else, check for any folder matching WPSV* or WPS-*
	else
		for dir in "${WRF_FOLDER}"/WPSV* "${WRF_FOLDER}"/WPS-*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WPS-${WPS_VERSION}"
				break
			fi
		done
	fi
	cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
	LD_LIBRARY_PATH= ./clean -a

	if [ ${auto_config} -eq 1 ]; then
		echo 19 | ./configure 2>&1 | tee configure.log #Option 19 for gfortran and distributed memory
	else
		./configure 2>&1 | tee configure.log #Option 19 gfortran compiler with distributed memory
	fi
	LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.wps.log

	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
	n=$(ls ./*.exe | wc -l)
	if (($n == 3)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WPS. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.wps2.log
		cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
		n=$(ls ./*.exe | wc -l)
		if (($n == 3)); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WPS. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	echo " "

	######################## Static Geography Data inc/ Optional ####################
	# http://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html
	# These files are large so if you only need certain ones comment the others off
	# All files downloaded and untarred is 200GB
	# https://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html
	#################################################################################
	cd "${WRF_FOLDER}"/Downloads
	mkdir "${WRF_FOLDER}"/GEOG
	mkdir "${WRF_FOLDER}"/GEOG/WPS_GEOG

	echo " "
	echo "Mandatory WRF Preprocessing System (WPS) Geographical Input Data Mandatory Fields Downloads"
	echo " "
	wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_high_res_mandatory.tar.gz
	LD_LIBRARY_PATH= tar -xvzf geog_high_res_mandatory.tar.gz -C "${WRF_FOLDER}"/GEOG/

	wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_low_res_mandatory.tar.gz
	LD_LIBRARY_PATH= tar -xvzf geog_low_res_mandatory.tar.gz -C "${WRF_FOLDER}"/GEOG/
	mv "${WRF_FOLDER}"/GEOG/WPS_GEOG_LOW_RES/ "${WRF_FOLDER}"/GEOG/WPS_GEOG

	if [ ${WPS_Specific_Applications} -eq 1 ]; then
		echo " "
		echo " WPS Geographical Input Data Mandatory for Specific Applications"
		echo " "

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_thompson28_chem.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_thompson28_chem.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_noahmp.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_noahmp.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/irrigation.tar.gz
		LD_LIBRARY_PATH= tar -xvzf irrigation.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_px.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_px.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_urban.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_urban.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_ssib.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_ssib.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/lake_depth.tar.bz2
		LD_LIBRARY_PATH= tar -xvf lake_depth.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/topobath_30s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf topobath_30s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/gsl_gwd.tar.bz2
		LD_LIBRARY_PATH= tar -xvf gsl_gwd.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/cglc_modis_lcz_global.tar.gz
		LD_LIBRARY_PATH= tar -xvf cglc_modis_lcz_global.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG
	fi

	if [ ${Optional_GEOG} -eq 1 ]; then
		echo " "
		echo "Optional WPS Geographical Input Data"
		echo " "

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_older_than_2000.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_older_than_2000.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/modis_landuse_20class_15s_with_lakes.tar.gz
		LD_LIBRARY_PATH= tar -xvzf modis_landuse_20class_15s_with_lakes.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_alt_lsm.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_alt_lsm.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/nlcd2006_ll_9s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf nlcd2006_ll_9s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/updated_Iceland_LU.tar.gz
		LD_LIBRARY_PATH= tar -xvf updated_Iceland_LU.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/modis_landuse_20class_15s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf modis_landuse_20class_15s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG
	fi

fi

############################################# WRF Hydro Standalone #################################
## WRFHYDRO Standalone installation with parallel process.
# Download and install required library and data files for WRFHYDRO.
# Tested in Ubuntu 22.04 & 24.04, Rocky Linux 9 & MacOS Ventura 64bit
# Built in 64-bit system
# Built with Intel or GNU compilers
# Tested with current available libraries on 03/01/2025
# If newer libraries exist edit script paths for changes
#Estimated Run Time ~ 30 - 60 Minutes with 10mb/s downloadspeed.
# Special thanks to:
# Youtube's meteoadriatic, GitHub user jamal919.
# University of Manchester's  Doug L
# University of Tunis El Manar's Hosni
# GSL's Jordan S.
# NCAR's Mary B., Christine W., & Carl D.
# DTC's Julie P., Tara J., George M., & John H.
# UCAR's Katelyn F., Jim B., Jordan P., Kevin M.,
##############################################################

if [ "$Ubuntu_64bit_GNU" = "1" ] && [ "$WRFHYDRO_STANDALONE_PICK" = "1" ]; then

	#############################basic package managment############################
	echo $PASSWD | sudo -S apt -y update
	echo $PASSWD | sudo -S apt -y upgrade

	release_version=$(lsb_release -r -s)

	# Compare the release version
	if [ "$release_version" = "24.04" ]; then
		# Install Emacs without recommended packages
		echo $PASSWD | sudo -S apt install emacs --no-install-recommends -y
	else
		# Attempt to install Emacs if the release version is not 24.04
		echo "The release version is not 24.04, attempting to install Emacs."
		echo $PASSWD | sudo -S apt install emacs -y
	fi

	echo $PASSWD | sudo -S apt -y install bison build-essential byacc cmake csh curl default-jdk default-jre flex libfl-dev g++ gawk gcc gettext gfortran git ksh libcurl4-gnutls-dev libjpeg-dev libncurses6 libpixman-1-dev libpng-dev libtool libxml2 libxml2-dev libxml-libxml-perl m4 make ncview pipenv pkg-config python3 python3-dev python3-pip python3-dateutil tcsh unzip xauth xorg time

	echo " "
	##############################Directory Listing############################
	export HOME=$(
		cd
		pwd
	)
	mkdir $HOME/WRFHYDRO_STANDALONE
	export WRF_FOLDER=$HOME/WRFHYDRO_STANDALONE
	export DIR="${WRF_FOLDER}"/Libs
	cd "${WRF_FOLDER}"/
	mkdir Downloads
	mkdir "${WRF_FOLDER}"/Hydro-Basecode
	mkdir Libs
	export DIR="${WRF_FOLDER}"/Libs
	mkdir Libs/grib2
	mkdir Libs/NETCDF
	mkdir Libs/MPICH
	mkdir -p Tests/Environment
	mkdir -p Tests/Compatibility

	echo " "
	#############################Core Management####################################

	export CPU_CORE=$(nproc) # number of available threads on system
	export CPU_6CORE="6"
	export CPU_QUARTER=$(($CPU_CORE / 4))                          #quarter of availble cores on system
	export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2))) #Forces CPU cores to even number to avoid partial core export. ie 7 cores would be 3.5 cores.

	if [ $CPU_CORE -le $CPU_6CORE ]; then #If statement for low core systems.  Forces computers to only use 1 core if there are 4 cores or less on the system. then
		export CPU_QUARTER_EVEN="2"
	else
		export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))
	fi

	echo "##########################################"
	echo "Number of Threads being used $CPU_QUARTER_EVEN"
	echo "##########################################"

	echo " "
	##############################Downloading Libraries############################
	cd Downloads
	wget -c https://github.com/madler/zlib/releases/download/v$Zlib_Version/zlib-$Zlib_Version.tar.gz
	wget -c https://github.com/HDFGroup/hdf5/releases/download/hdf5_$HDF5_Version/hdf5-$HDF5_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-c/archive/refs/tags/v$Netcdf_C_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-fortran/archive/refs/tags/v$Netcdf_Fortran_Version.tar.gz
	wget -c https://download.sourceforge.net/libpng/libpng-$Libpng_Version.tar.gz
	wget -c https://www.ece.uvic.ca/~frodo/jasper/software/jasper-$Jasper_Version.zip
	wget -c https://github.com/pmodels/mpich/releases/download/v$Mpich_Version/mpich-$Mpich_Version.tar.gz
	wget -c https://parallel-netcdf.github.io/Release/pnetcdf-$Pnetcdf_Version.tar.gz

	echo " "
	#############################Compilers############################
	export CC=gcc
	export CXX=g++
	export FC=gfortran
	export F77=gfortran
	export CFLAGS="-fPIC -fPIE -O3"

	#IF statement for GNU compiler issue
	export GCC_VERSION=$(/usr/bin/gcc -dumpfullversion | awk '{print$1}')
	export GFORTRAN_VERSION=$(/usr/bin/gfortran -dumpfullversion | awk '{print$1}')
	export GPLUSPLUS_VERSION=$(/usr/bin/g++ -dumpfullversion | awk '{print$1}')

	export GCC_VERSION_MAJOR_VERSION=$(echo $GCC_VERSION | awk -F. '{print $1}')
	export GFORTRAN_VERSION_MAJOR_VERSION=$(echo $GFORTRAN_VERSION | awk -F. '{print $1}')
	export GPLUSPLUS_VERSION_MAJOR_VERSION=$(echo $GPLUSPLUS_VERSION | awk -F. '{print $1}')

	export version_10="10"

	if [ $GCC_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GFORTRAN_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GPLUSPLUS_VERSION_MAJOR_VERSION -ge $version_10 ]; then
		export fallow_argument=-fallow-argument-mismatch
		export boz_argument=-fallow-invalid-boz
	else
		export fallow_argument=
		export boz_argument=
	fi

	export FFLAGS="$fallow_argument -m64"
	export FCFLAGS="$fallow_argument -m64"

	echo "##########################################"
	echo "FFLAGS = $FFLAGS"
	echo "FCFLAGS = $FCFLAGS"
	echo "CFLAGS = $CFLAGS"
	echo "##########################################"

	echo " "
	############################# ZLib ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf zlib-$Zlib_Version.tar.gz
	cd zlib-$Zlib_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	export ZLIB_ROOT=$DIR/grib2
	export ZLIBLIB=$DIR/grib2/lib
	export ZLIBINC=$DIR/grib2/include

	echo " "
	############################## MPICH ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf mpich-$Mpich_Version.tar.gz
	cd mpich-$Mpich_Version/

	F90= ./configure --prefix=$DIR/MPICH --with-device=ch3 FFLAGS="$fallow_argument -m64" FCFLAGS="$fallow_argument -m64" 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/MPICH/bin:$PATH
	export MPIFC=$DIR/MPICH/bin/mpifort
	export MPIF77=$DIR/MPICH/bin/mpifort
	export MPIF90=$DIR/MPICH/bin/mpifort
	export MPICC=$DIR/MPICH/bin/mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx

	echo " "
	############################# libpng ############################

	cd "${WRF_FOLDER}"/Downloads

	# other libraries below need these variables to be set
	export LDFLAGS=-L$DIR/grib2/lib
	export CPPFLAGS=-I$DIR/grib2/include

	LD_LIBRARY_PATH= tar -xvzf libpng-$Libpng_Version.tar.gz
	cd libpng-$Libpng_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNG_ROOT=$DIR/grib2

	echo " "
	#############################JasPer ############################
	cd "${WRF_FOLDER}"/Downloads
	unzip jasper-$Jasper_Version.zip
	cd jasper-$Jasper_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export JASPERLIB=$DIR/grib2/lib
	export JASPERINC=$DIR/grib2/include
	export JASPER_DIR=$DIR/grib2
	export Jasper_ROOT=$DIR/grib2/lib

	echo " "
	############################# hdf5 library for netcdf4 functionality ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf hdf5-$HDF5_Version.tar.gz
	cd hdf5-$HDF5_Version

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --with-zlib=$DIR/grib2 --enable-hl --enable-fortran --enable-parallel 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export HDF5=$DIR/grib2
	export PATH=$HDF5/bin:$PATH
	export PHDF5=$DIR/grib2
	export HDF5_ROOT=$DIR/grib2
	export PHDF5_ROOT=$DIR/grib2

	############################# Install Parallel-netCDF ##############################
	#Make file created with half of available cpu cores
	#Hard path for MPI added
	##################################################################################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf pnetcdf-$Pnetcdf_Version.tar.gz
	cd pnetcdf-$Pnetcdf_Version

	export MPIFC=$DIR/MPICH/bin/mpifort
	export MPIF77=$DIR/MPICH/bin/mpifort
	export MPIF90=$DIR/MPICH/bin/mpifort
	export MPICC=$DIR/MPICH/bin/mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --enable-static 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNETCDF=$DIR/grib2
	export PNETCDF_DIR=$DIR/grib2
	export PNETCDF_ROOT=$DIR/grib2

	echo " "

	############################## Install NETCDF C Library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_C_Version.tar.gz
	cd netcdf-c-$Netcdf_C_Version/
	export CPPFLAGS=-I$DIR/grib2/include
	export LDFLAGS="-L$DIR/grib2/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lhdf5_hl -lhdf5 -lz -lcurl -lgfortran -lgcc -lm -ldl -lpnetcdf"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --disable-dap --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-pnetcdf --enable-cdf5 --enable-parallel-tests --enable-logging 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/NETCDF/bin:$PATH
	export NETCDF=$DIR/NETCDF
	export NETCDF_INC=$DIR/NETCDF/include
	export NETCDF_LIB=$DIR/NETCDF/lib
	export NETCDF_ROOT=$DIR/NETCDF
	export LD_LIBRARY_PATH=$DIR/grib2/lib:$DIR/NETCDF/lib:$LD_LIBRARY_PATH

	echo " "
	############################## NetCDF fortran library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_Fortran_Version.tar.gz
	cd netcdf-fortran-$Netcdf_Fortran_Version/
	export LD_LIBRARY_PATH=$DIR/NETCDF/lib:$LD_LIBRARY_PATH
	export CPPFLAGS="-I$DIR/NETCDF/include -I$DIR/grib2/include"
	export LDFLAGS="-L$DIR/NETCDF/lib -L$DIR/grib2/lib -Wl,-rpath,$DIR/NETCDF/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lnetcdf -lpnetcdf -lcurl -lhdf5_hl -lhdf5 -lz -lm -ldl -lgcc -lgfortran"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-parallel-tests --enable-logging --enable-hdf5 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	echo " "

	#################################### System Environment Tests ##############
	mkdir -p "${WRF_FOLDER}"/Tests/Environment
	mkdir -p "${WRF_FOLDER}"/Tests/Compatibility

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_NETCDF_MPI_tests.tar
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_tests.tar

	LD_LIBRARY_PATH= tar -xvf Fortran_C_tests.tar -C "${WRF_FOLDER}"/Tests/Environment
	LD_LIBRARY_PATH= tar -xvf Fortran_C_NETCDF_MPI_tests.tar -C "${WRF_FOLDER}"/Tests/Compatibility
	export one="1"
	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Environment

	echo " "
	echo " "
	echo "Environment Testing "
	echo "Test 1"
	$FC TEST_1_fortran_only_fixed.f
	./a.out | tee env_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 1 Passed"
	else
		echo "Environment Compiler Test 1 Failed"
		exit
	fi
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 2"
	$FC TEST_2_fortran_only_free.f90
	./a.out | tee env_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 2 Passed"
	else
		echo "Environment Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 3"
	$CC TEST_3_c_only.c
	./a.out | tee env_test3.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test3.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 3 Passed"
	else
		echo "Environment Compiler Test 3 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 4"
	$CC -c -m64 TEST_4_fortran+c_c.c
	$FC -c -m64 TEST_4_fortran+c_f.f90
	$FC -m64 TEST_4_fortran+c_f.o TEST_4_fortran+c_c.o
	./a.out | tee env_test4.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test4.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 4 Passed"
	else
		echo "Environment Compiler Test 4 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Compatibility

	cp ${NETCDF}/include/netcdf.inc .

	echo " "
	echo " "
	echo "Library Compatibility Tests "
	echo "Test 1"
	$FC -c 01_fortran+c+netcdf_f.f
	$CC -c 01_fortran+c+netcdf_c.c
	$FC 01_fortran+c+netcdf_f.o 01_fortran+c+netcdf_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	./a.out | tee comp_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 1 Passed"
	else
		echo "Compatibility Compiler Test 1 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "

	echo "Test 2"
	$MPIFC -c 02_fortran+c+netcdf+mpi_f.f
	$MPICC -c 02_fortran+c+netcdf+mpi_c.c
	$MPIFC 02_fortran+c+netcdf+mpi_f.o \
		02_fortran+c+netcdf+mpi_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	$DIR/MPICH/bin/mpirun ./a.out | tee comp_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 2 Passed"
	else
		echo "Compatibility Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."
	echo " "

	echo " All tests completed and passed"
	echo " "

	############################# WRF HYDRO V5.4.0 #################################
	# Version 5.3.0
	# Standalone mode
	# GNU
	################################################################################

	# Set up NETCDF environment variables
	export NETCDF_INC="$DIR/NETCDF/include"
	export NETCDF_LIB="$DIR/NETCDF/lib"

	# Create directories for Hydro Basecode and navigate to it
	mkdir -p "${WRF_FOLDER}/Hydro-Basecode"
	cd "${WRF_FOLDER}/Hydro-Basecode"

	# Clone the WRF-Hydro repository and set up the build
	git clone https://github.com/NCAR/wrf_hydro_nwm_public.git
	cd wrf_hydro_nwm_public
	mkdir -p build
	cd build

	# Run CMake configuration for WRF-Hydro with specified options
	cmake .. \
		-DSPATIAL_SOIL=1 \
		-DWRF_HYDRO=1 \
		-DWRFIO_NCD_LARGE_FILE_SUPPORT=1 \
		-DCMAKE_Fortran_COMPILER=gfortran

	# Compile using specified CPU settings
	make -j "$CPU_QUARTER_EVEN" 2>&1 | tee make.log

	# Check if the necessary executable files were created
	# Check if the necessary executable files were created
	cd "${WRF_FOLDER}/Hydro-Basecode/wrf_hydro_nwm_public/build/Run"

	# List of expected executable files
	expected_execs=("wrf_hydro.exe" "wrf_hydro_NoahMP")

	# Function to check for missing executables
	check_missing_execs() {
		missing=0
		for exe in "${expected_execs[@]}"; do
			if [[ ! -f "$exe" ]]; then
				echo "Missing: $exe"
				missing=1
			fi
		done
		return $missing
	}

	# Function to rerun compilation
	rebuild_and_check() {
		echo "Missing one or more expected files. Running compiler again..."
		cd "${WRF_FOLDER}/Hydro-Basecode/wrf_hydro_nwm_public/build"
		make -j "$CPU_QUARTER_EVEN" 2>&1 | tee make2.log
		cd "${WRF_FOLDER}/Hydro-Basecode/wrf_hydro_nwm_public/build/Run"
	}

	# Initial check
	check_missing_execs
	if (($? == 0)); then
		echo "All expected executable files are present."
	else
		rebuild_and_check
		check_missing_execs
		if (($? != 0)); then
			echo "Missing one or more expected files even after recompilation."
			read -r -p "Please contact script authors for assistance. Press 'Enter' to exit the script."
			exit 1
		else
			echo "All expected files created after re-compiling."
		fi
	fi
	# Finish the script with a pause
	read -r -t 5 -p "Finished installing WRF Hydro Basecode. Waiting for 5 seconds..."
	######################### Testing WRF HYDRO Compliation #########################
	cd "${WRF_FOLDER}"/

	#Download test case for WRF HYDRO and move to NWM
	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/NCAR/wrf_hydro_nwm_public/releases/download/v${HYDRO_CROTON_TEST_CASE}/croton_NY_training_example_v${HYDRO_CROTON_TEST_CASE_MINOR}.tar.gz
	LD_LIBRARY_PATH= tar -xvzf croton_NY_training_example_v${HYDRO_CROTON_TEST_CASE_MINOR}.tar.gz
	mv example_case "${WRF_FOLDER}"/Hydro-Basecode

	#Copy the *.TBL files to the example configuration directory:
	cp "${WRF_FOLDER}"/Hydro-Basecode/wrf_hydro_nwm_public/build/Run/*.TBL "${WRF_FOLDER}"/Hydro-Basecode/example_case/NWM

	#Copy the wrf_hydro file:
	cp "${WRF_FOLDER}"/Hydro-Basecode/wrf_hydro_nwm_public/build/Run/wrf_hydro "${WRF_FOLDER}"/Hydro-Basecode/example_case/NWM

	#From the example_case/Gridded directory, create a symlink:
	ln -s "${WRF_FOLDER}"/Hydro-Basecode/example_case/FORCING "${WRF_FOLDER}"/Hydro-Basecode/example_case/NWM

	#Move to Gridded Folder
	cd "${WRF_FOLDER}"/Hydro-Basecode/example_case/NWM

	#Run Wrf hydro
	mpirun -np $CPU_QUARTER_EVEN ./wrf_hydro

	echo "Checking HYDRO_RST files..."
	ls -lah HYDRO_RST.*_DOMAIN1 2>/dev/null || echo "No HYDRO_RST files found."

	all_good=true
	for file in HYDRO_RST.*_DOMAIN1; do
		if [ ! -s "$file" ]; then
			echo "File $file is empty or missing!"
			all_good=false
		fi
	done

	if [ "$all_good" = true ]; then
		echo "HYDRO_RST files exist and have data  wrf_hydro.exe successful."
	else
		echo "One or more HYDRO_RST files are missing or empty."
		echo "Please check your model run."
		exit 1
	fi

	echo " "

	########################### Test script for output data  ###################################

	#Installing Miniconda3 to WRF directory and updating libraries
	echo $PASSWD | sudo -S apt -y install python3-zstandard python3-zstd

	export Miniconda_Install_DIR="${WRF_FOLDER}"/miniconda3

	mkdir -p $Miniconda_Install_DIR

	if [ "$Ubuntu_32bit_GNU" = "1" ]; then
		wget -c https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86.sh -O $Miniconda_Install_DIR/miniconda.sh
	else
		wget -c https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O $Miniconda_Install_DIR/miniconda.sh
	fi

	bash $Miniconda_Install_DIR/miniconda.sh -b -u -p $Miniconda_Install_DIR

	rm -rf $Miniconda_Install_DIR/miniconda.sh

	export PATH="${WRF_FOLDER}"/miniconda3/bin:$PATH

	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	$Miniconda_Install_DIR/bin/conda init bash

	conda tos accept
	conda config --add channels conda-forge
	conda config --set auto_activate_base false
	conda update -n root --all -y

	##################### WRF Python           ##################
	########### WRf-Python compiled via Conda  ##################
	########### This is the preferred method by NCAR      ##################
	##### https://wrf-python.readthedocs.io/en/latest/installation.html  ##################
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh
	conda env create -f $HOME/WRF-MOSIT/wrf-python-stable.yml

	######################### Climate Data Operators ############
	######################### CDO compiled via Conda ###########
	####################### This is the preferred method #######
	################### https://bairdlangenbrunner.github.io/python-for-climate-scientists/conda/setting-up-conda-environments.html #######################

	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	conda create --name cdo_stable -y
	conda activate cdo_stable
	conda install -c conda-forge cdo -y
	conda update --all -y
	conda deactivate
	conda deactivate
	conda deactivate

	echo " "

	################ NEEDS TO BE IN Master folder #######################
	cp $HOME/WRF-MOSIT/SurfaceRunoff.py "${WRF_FOLDER}"/Hydro-Basecode/example_case/NWM

	cd "${WRF_FOLDER}"/Hydro-Basecode/example_case/NWM

	conda activate wrf-python
	python3 SurfaceRunoff.py
	conda deactivate
	conda deactivate
	conda deactivate

	if [ -f "SurfaceRunoff.pdf" ]; then
		echo "SurfaceRunoff.pdf exists."
	else
		echo "SurfaceRunoff.pdf is missing."
		exit 1 # Uncomment if you want to stop the script
	fi

	echo " "
	#####################################BASH Script Finished##############################
	echo "WRF HYDRO Standalone sucessfully configured and compiled"
	read -r -t 5 -p "Congratulations! You've successfully installed all required files to run the Weather Research Forecast Model HYDRO verison 5.2."

	##########################  Export PATH and LD_LIBRARY_PATH ################################
	cd $HOME

fi

if [ "$Ubuntu_64bit_Intel" = "1" ] && [ "$WRFHYDRO_STANDALONE_PICK" = "1" ]; then

	############################# Basic package managment ############################

	echo $PASSWD | sudo -S apt -y update
	echo $PASSWD | sudo -S apt -y upgrade

	# download the key to system keyring; this and the following echo command are
	# needed in order to install the Intel compilers
	wget -O- https://apt.repos.intel.com/intel-gpg-keys/GPG-PUB-KEY-INTEL-SW-PRODUCTS.PUB |
		gpg --dearmor | sudo tee /usr/share/keyrings/oneapi-archive-keyring.gpg >/dev/null

	# add signed entry to apt sources and configure the APT client to use Intel repository:
	echo "deb [signed-by=/usr/share/keyrings/oneapi-archive-keyring.gpg] https://apt.repos.intel.com/oneapi all main" | sudo tee /etc/apt/sources.list.d/oneAPI.list

	# this update should get the Intel package info from the Intel repository
	echo $PASSWD | sudo -S apt -y update

	release_version=$(lsb_release -r -s)

	# Compare the release version
	if [ "$release_version" = "24.04" ]; then
		# Install Emacs without recommended packages
		echo $PASSWD | sudo -S apt install emacs --no-install-recommends -y
	else
		# Attempt to install Emacs if the release version is not 24.04
		echo "The release version is not 24.04, attempting to install Emacs."
		echo $PASSWD | sudo -S apt install emacs -y
	fi

	echo $PASSWD | sudo -S apt -y install bison build-essential byacc cmake csh curl default-jdk default-jre flex libfl-dev g++ gawk gcc gettext gfortran git ksh libcurl4-gnutls-dev libjpeg-dev libncurses6 libpixman-1-dev libpng-dev libtool libxml2 libxml2-dev libxml-libxml-perl m4 make ncview pipenv pkg-config python3 python3-dev python3-pip python3-dateutil tcsh unzip xauth xorg time

	# install the Intel compilers
	echo $PASSWD | sudo -S apt -y install intel-basekit
	echo $PASSWD | sudo -S apt -y install intel-hpckit
	echo $PASSWD | sudo -S apt -y install intel-oneapi-python
	/opt/intel/oneapi/intelpython/python3.12/bin/python3 -m pip install python-dateutil

	echo $PASSWD | sudo -S apt -y update

	#Fix any broken installations
	echo $PASSWD | sudo -S apt --fix-broken install

	# make sure some critical packages have been installed
	which cmake pkg-config make gcc g++ gfortran

	# add the Intel compiler file paths to various environment variables
	source /opt/intel/oneapi/setvars.sh --force

	# some of the libraries we install below need one or more of these variables
	export CC=icx
	export CXX=icpx
	export FC=ifx
	export F77=ifx
	export F90=ifx
	export MPIFC=mpiifx
	export MPIF77=mpiifx
	export MPIF90=mpiifx
	export MPICC=mpiicx
	export MPICXX=mpiicpx
	export CFLAGS="-fPIC -fPIE -O3 -Wno-implicit-function-declaration -Wno-incompatible-function-pointer-types -Wno-unused-command-line-argument"
	############################# CPU Core Management ####################################

	export CPU_CORE=$(nproc) # number of available threads on system
	export CPU_6CORE="6"
	export CPU_QUARTER=$(($CPU_CORE / 4)) # quarter of availble cores on system
	# Forces CPU cores to even number to avoid partial core export. ie 7 cores would be 3.5 cores.
	export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))

	# If statement for low core systems.  Forces computers to only use 1 core if there are 4 cores or less on the system.
	if [ $CPU_CORE -le $CPU_6CORE ]; then
		export CPU_QUARTER_EVEN="2"
	else
		export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))
	fi

	echo "##########################################"
	echo "Number of Threads being used $CPU_QUARTER_EVEN"
	echo "##########################################"

	echo " "
	##############################Directory Listing############################
	export HOME=$(
		cd
		pwd
	)

	mkdir $HOME/WRFHYDRO_STANDALONE_INTEL
	export WRF_FOLDER=$HOME/WRFHYDRO_STANDALONE_INTEL
	cd "${WRF_FOLDER}"/
	mkdir Downloads
	mkdir Libs
	export DIR="${WRF_FOLDER}"/Libs
	mkdir Libs/grib2
	mkdir Libs/NETCDF
	mkdir Libs/MPICH
	echo " "
	##############################Downloading Libraries############################
	cd Downloads
	wget -c https://github.com/madler/zlib/releases/download/v$Zlib_Version/zlib-$Zlib_Version.tar.gz
	wget -c https://github.com/HDFGroup/hdf5/releases/download/hdf5_$HDF5_Version/hdf5-$HDF5_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-c/archive/refs/tags/v$Netcdf_C_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-fortran/archive/refs/tags/v$Netcdf_Fortran_Version.tar.gz
	wget -c https://download.sourceforge.net/libpng/libpng-$Libpng_Version.tar.gz
	wget -c https://www.ece.uvic.ca/~frodo/jasper/software/jasper-$Jasper_Version.zip
	wget -c https://parallel-netcdf.github.io/Release/pnetcdf-$Pnetcdf_Version.tar.gz

	echo " "

	############################# ZLib ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf zlib-$Zlib_Version.tar.gz
	cd zlib-$Zlib_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	export ZLIB_ROOT=$DIR/grib2
	export ZLIBLIB=$DIR/grib2/lib
	export ZLIBINC=$DIR/grib2/include

	echo " "
	############################# libpng ############################

	cd "${WRF_FOLDER}"/Downloads

	# other libraries below need these variables to be set
	export LDFLAGS=-L$DIR/grib2/lib
	export CPPFLAGS=-I$DIR/grib2/include

	LD_LIBRARY_PATH= tar -xvzf libpng-$Libpng_Version.tar.gz
	cd libpng-$Libpng_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNG_ROOT=$DIR/grib2

	echo " "
	#############################JasPer ############################
	cd "${WRF_FOLDER}"/Downloads
	unzip jasper-$Jasper_Version.zip
	cd jasper-$Jasper_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export JASPERLIB=$DIR/grib2/lib
	export JASPERINC=$DIR/grib2/include
	export JASPER_DIR=$DIR/grib2
	export Jasper_ROOT=$DIR/grib2/lib

	echo " "

	############################# hdf5 library for netcdf4 functionality ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf hdf5-$HDF5_Version.tar.gz
	cd hdf5-$HDF5_Version

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --with-zlib=$DIR/grib2 --enable-hl --enable-fortran --enable-parallel 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export HDF5=$DIR/grib2
	export PATH=$HDF5/bin:$PATH
	export PHDF5=$DIR/grib2
	export HDF5_ROOT=$DIR/grib2
	export PHDF5_ROOT=$DIR/grib2
	echo " "

	############################# Install Parallel-netCDF ##############################
	#Make file created with half of available cpu cores
	#Hard path for MPI added
	##################################################################################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf pnetcdf-$Pnetcdf_Version.tar.gz
	cd pnetcdf-$Pnetcdf_Version
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --enable-static 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNETCDF=$DIR/grib2
	export PNETCDF_DIR=$DIR/grib2
	export PNETCDF_ROOT=$DIR/grib2

	echo " "

	############################## Install NETCDF C Library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_C_Version.tar.gz
	cd netcdf-c-$Netcdf_C_Version/
	export CPPFLAGS=-I$DIR/grib2/include
	export LDFLAGS="-L$DIR/grib2/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lhdf5_hl -lhdf5 -lz -lcurl -lgcc -lm -ldl -lpnetcdf"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --with-zlib=$DIR/grib2 --disable-dap --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-pnetcdf --enable-cdf5 --enable-parallel-tests --enable-logging 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/NETCDF/bin:$PATH
	export NETCDF=$DIR/NETCDF
	export NETCDF_INC=$DIR/NETCDF/include
	export NETCDF_LIB=$DIR/NETCDF/lib
	export NETCDF_ROOT=$DIR/NETCDF
	export LD_LIBRARY_PATH=$DIR/grib2/lib:$DIR/NETCDF/lib:$LD_LIBRARY_PATH

	echo " "
	############################## NetCDF fortran library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_Fortran_Version.tar.gz
	cd netcdf-fortran-$Netcdf_Fortran_Version/
	export LD_LIBRARY_PATH=$DIR/NETCDF/lib:$LD_LIBRARY_PATH
	export CPPFLAGS="-I$DIR/NETCDF/include -I$DIR/grib2/include"
	export LDFLAGS="-L$DIR/NETCDF/lib -L$DIR/grib2/lib -Wl,-rpath,$DIR/NETCDF/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lnetcdf -lpnetcdf -lm -lcurl -lhdf5_hl -lhdf5 -lz -ldl"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-parallel-tests --enable-logging --enable-hdf5 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	echo " "

	#################################### System Environment Tests ##############
	mkdir -p "${WRF_FOLDER}"/Tests/Environment
	mkdir -p "${WRF_FOLDER}"/Tests/Compatibility

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_NETCDF_MPI_tests.tar
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_tests.tar

	LD_LIBRARY_PATH= tar -xvf Fortran_C_tests.tar -C "${WRF_FOLDER}"/Tests/Environment
	LD_LIBRARY_PATH= tar -xvf Fortran_C_NETCDF_MPI_tests.tar -C "${WRF_FOLDER}"/Tests/Compatibility
	export one="1"
	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Environment

	echo " "
	echo " "
	echo "Environment Testing "
	echo "Test 1"
	$FC TEST_1_fortran_only_fixed.f
	./a.out | tee env_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 1 Passed"
	else
		echo "Environment Compiler Test 1 Failed"
		exit
	fi
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 2"
	$FC TEST_2_fortran_only_free.f90
	./a.out | tee env_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 2 Passed"
	else
		echo "Environment Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 3"
	$CC TEST_3_c_only.c
	./a.out | tee env_test3.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test3.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 3 Passed"
	else
		echo "Environment Compiler Test 3 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 4"
	$CC -c -m64 TEST_4_fortran+c_c.c
	$FC -c -m64 TEST_4_fortran+c_f.f90
	$FC -m64 TEST_4_fortran+c_f.o TEST_4_fortran+c_c.o
	./a.out | tee env_test4.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test4.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 4 Passed"
	else
		echo "Environment Compiler Test 4 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Compatibility

	cp ${NETCDF}/include/netcdf.inc .

	echo " "
	echo " "
	echo "Library Compatibility Tests "
	echo "Test 1"
	$FC -c 01_fortran+c+netcdf_f.f
	$CC -c 01_fortran+c+netcdf_c.c
	$FC 01_fortran+c+netcdf_f.o 01_fortran+c+netcdf_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	./a.out | tee comp_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 1 Passed"
	else
		echo "Compatibility Compiler Test 1 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "

	echo "Test 2"
	$MPIFC -c 02_fortran+c+netcdf+mpi_f.f
	$MPICC -c 02_fortran+c+netcdf+mpi_c.c
	$MPIFC 02_fortran+c+netcdf+mpi_f.o \
		02_fortran+c+netcdf+mpi_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	mpirun ./a.out | tee comp_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 2 Passed"
	else
		echo "Compatibility Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."
	echo " "

	echo " All tests completed and passed"
	echo " "

	############################# WRF HYDRO V5.4.0 #################################
	# Version 5.3.0
	# Standalone mode
	# GNU
	################################################################################

	# Source Intel oneAPI environment
	source /opt/intel/oneapi/setvars.sh --force

	# Set up NETCDF environment variables
	export NETCDF_INC="$DIR/NETCDF/include"
	export NETCDF_LIB="$DIR/NETCDF/lib"

	# Create directories for Hydro Basecode and navigate to it
	mkdir -p "${WRF_FOLDER}/Hydro-Basecode"
	cd "${WRF_FOLDER}/Hydro-Basecode"

	# Clone the WRF-Hydro repository and set up the build
	git clone https://github.com/NCAR/wrf_hydro_nwm_public.git
	cd wrf_hydro_nwm_public
	mkdir -p build
	cd build

	# Run CMake configuration for WRF-Hydro with specified options
	cmake .. \
		-DSPATIAL_SOIL=1 \
		-DWRF_HYDRO=1 \
		-DWRFIO_NCD_LARGE_FILE_SUPPORT=1 \
		-DCMAKE_Fortran_COMPILER=ifx

	# Compile using specified CPU settings
	make -j "$CPU_QUARTER_EVEN" 2>&1 | tee make.log

	# Check if the necessary executable files were created
	cd "${WRF_FOLDER}/Hydro-Basecode/wrf_hydro_nwm_public/build/Run"

	# List of expected executable files
	expected_execs=("wrf_hydro.exe" "wrf_hydro_NoahMP")

	# Function to check for missing executables
	check_missing_execs() {
		missing=0
		for exe in "${expected_execs[@]}"; do
			if [[ ! -f "$exe" ]]; then
				echo "Missing: $exe"
				missing=1
			fi
		done
		return $missing
	}

	# Function to rerun compilation
	rebuild_and_check() {
		echo "Missing one or more expected files. Running compiler again..."
		cd "${WRF_FOLDER}/Hydro-Basecode/wrf_hydro_nwm_public/build"
		make -j "$CPU_QUARTER_EVEN" 2>&1 | tee make2.log
		cd "${WRF_FOLDER}/Hydro-Basecode/wrf_hydro_nwm_public/build/Run"
	}

	# Initial check
	check_missing_execs
	if (($? == 0)); then
		echo "All expected executable files are present."
	else
		rebuild_and_check
		check_missing_execs
		if (($? != 0)); then
			echo "Missing one or more expected files even after recompilation."
			read -r -p "Please contact script authors for assistance. Press 'Enter' to exit the script."
			exit 1
		else
			echo "All expected files created after re-compiling."
		fi
	fi

	# Finish the script with a pause
	read -r -t 5 -p "Finished installing WRF Hydro Basecode. Waiting for 5 seconds..."
	######################### Testing WRF HYDRO Compliation #########################
	cd "${WRF_FOLDER}"/

	#Download test case for WRF HYDRO and move to NWM
	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/NCAR/wrf_hydro_nwm_public/releases/download/v${HYDRO_CROTON_TEST_CASE}/croton_NY_training_example_v${HYDRO_CROTON_TEST_CASE_MINOR}.tar.gz
	LD_LIBRARY_PATH= tar -xvzf croton_NY_training_example_v${HYDRO_CROTON_TEST_CASE_MINOR}.tar.gz
	mv example_case "${WRF_FOLDER}"/Hydro-Basecode

	#Copy the *.TBL files to the example configuration directory:
	cp "${WRF_FOLDER}"/Hydro-Basecode/wrf_hydro_nwm_public/build/Run/*.TBL "${WRF_FOLDER}"/Hydro-Basecode/example_case/NWM

	#Copy the wrf_hydro file:
	cp "${WRF_FOLDER}"/Hydro-Basecode/wrf_hydro_nwm_public/build/Run/wrf_hydro "${WRF_FOLDER}"/Hydro-Basecode/example_case/NWM

	#From the example_case/Gridded directory, create a symlink:
	ln -s "${WRF_FOLDER}"/Hydro-Basecode/example_case/FORCING "${WRF_FOLDER}"/Hydro-Basecode/example_case/NWM

	#Move to Gridded Folder
	cd "${WRF_FOLDER}"/Hydro-Basecode/example_case/NWM

	#Run Wrf hydro
	mpirun -np $CPU_QUARTER_EVEN ./wrf_hydro

	echo "Checking HYDRO_RST files..."
	ls -lah HYDRO_RST.*_DOMAIN1 2>/dev/null || echo "No HYDRO_RST files found."

	all_good=true
	for file in HYDRO_RST.*_DOMAIN1; do
		if [ ! -s "$file" ]; then
			echo "File $file is empty or missing!"
			all_good=false
		fi
	done

	if [ "$all_good" = true ]; then
		echo "HYDRO_RST files exist and have data  wrf_hydro.exe successful."
	else
		echo "One or more HYDRO_RST files are missing or empty."
		echo "Please check your model run."
		exit 1
	fi

	echo " "

	########################### Test script for output data  ###################################

	#Installing Miniconda3 to WRF directory and updating libraries
	echo $PASSWD | sudo -S apt -y install python3-zstandard python3-zstd

	export Miniconda_Install_DIR="${WRF_FOLDER}"/miniconda3

	mkdir -p $Miniconda_Install_DIR

	wget -c https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O $Miniconda_Install_DIR/miniconda.sh

	bash $Miniconda_Install_DIR/miniconda.sh -b -u -p $Miniconda_Install_DIR

	rm -rf $Miniconda_Install_DIR/miniconda.sh

	export PATH="${WRF_FOLDER}"/miniconda3/bin:$PATH

	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	$Miniconda_Install_DIR/bin/conda init bash

	conda tos accept
	conda config --add channels conda-forge
	conda config --set auto_activate_base false
	conda update -n root --all -y

	##################### WRF Python           ##################
	########### WRf-Python compiled via Conda  ##################
	########### This is the preferred method by NCAR      ##################
	##### https://wrf-python.readthedocs.io/en/latest/installation.html  ##################
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh
	conda env create -f $HOME/WRF-MOSIT/wrf-python-stable.yml
	echo " "

	################ NEEDS TO BE IN Master folder #######################
	cp $HOME/WRF-MOSIT/SurfaceRunoff.py "${WRF_FOLDER}"/Hydro-Basecode/example_case/NWM

	cd "${WRF_FOLDER}"/Hydro-Basecode/example_case/NWM

	conda activate wrf-python
	python3 SurfaceRunoff.py
	conda deactivate
	conda deactivate
	conda deactivate

	if [ -f "SurfaceRunoff.pdf" ]; then
		echo "SurfaceRunoff.pdf exists."
	else
		echo "SurfaceRunoff.pdf is missing."
		exit 1 # Uncomment if you want to stop the script
	fi

	echo " "
	#####################################BASH Script Finished##############################
	echo "WRF HYDRO Standalone sucessfully configured and compiled"
	read -r -t 5 -p "Congratulations! You've successfully installed all required files to run the Weather Research Forecast Model HYDRO verison 5.2."

	##########################  Export PATH and LD_LIBRARY_PATH ################################
	cd $HOME

fi

if [ "$macos_64bit_GNU" = "1" ] && [ "$WRFHYDRO_STANDALONE_PICK" = "1" ] && [ "$MAC_CHIP" = "Intel" ]; then

	## WRF installation with parallel process.
	# Download and install required library and data files for WRF.
	# Tested in macOS Ventura 13.4.1
	# Tested in 64-bit
	# Tested with current available libraries on 03/01/2025
	# If newer libraries exist edit script paths for changes
	#Estimated Run Time ~ 90 - 150 Minutes with 10mb/s downloadspeed.
	#Special thanks to  Youtube's meteoadriatic and GitHub user jamal919.

	#############################basic package managment############################

	brew cleanup -s
	brew update
	outdated_packages=$(brew outdated --quiet)

	# List of packages to check/install
	packages=(
		"autoconf" "automake" "bison" "byacc" "cmake" "curl" "flex" "gcc"
		"gedit" "git" "gnu-sed" "ksh"
		"libtool" "libxml2" "m4" "make" "python@3.12" "tcsh" "wget"
		"xauth" "xorgproto" "xorgrgb" "xquartz"
	)

	for pkg in "${packages[@]}"; do
		if brew list "$pkg" &>/dev/null; then
			echo "$pkg is already installed."
			if [[ $outdated_packages == *"$pkg"* ]]; then
				echo "$pkg has a newer version available. Upgrading..."
				brew upgrade "$pkg"
			fi
		else
			echo "$pkg is not installed. Installing..."
			brew install "$pkg"
		fi
		sleep 1
	done

	export LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH
	export PATH=/usr/local/bin:$PATH
	##############################Directory Listing############################

	export HOME=$(
		cd
		pwd
	)

	mkdir $HOME/WRFHYDRO_STANDALONE
	export WRF_FOLDER=$HOME/WRFHYDRO_STANDALONE
	cd "${WRF_FOLDER}"/
	mkdir Downloads
	mkdir Libs
	export DIR="${WRF_FOLDER}"/Libs
	mkdir Libs/grib2
	mkdir Libs/NETCDF

	echo " "
	#############################Core Management####################################
	export CPU_CORE=$(sysctl -n hw.ncpu) # number of available threads on system
	export CPU_6CORE="6"
	export CPU_QUARTER=$(($CPU_CORE / 4))
	#1/2 of availble cores on system
	export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))
	#Forces CPU cores to even number to avoid partial core export. ie 7 cores would be 3.5 cores.

	if [ $CPU_CORE -le $CPU_6CORE ]; then #If statement for low core systems.  Forces computers to only use 1 core if there are 4 cores or less on the system. then
		export CPU_QUARTER_EVEN="2"
	else
		export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))
	fi

	echo "##########################################"
	echo "Number of Threads being used $CPU_QUARTER_EVEN"
	echo "##########################################"
	echo " "

	##############################Downloading Libraries############################

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/madler/zlib/releases/download/v$Zlib_Version/zlib-$Zlib_Version.tar.gz
	wget -c https://github.com/HDFGroup/hdf5/releases/download/hdf5_$HDF5_Version/hdf5-$HDF5_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-c/archive/refs/tags/v$Netcdf_C_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-fortran/archive/refs/tags/v$Netcdf_Fortran_Version.tar.gz
	wget -c https://download.sourceforge.net/libpng/libpng-$Libpng_Version.tar.gz
	wget -c https://www.ece.uvic.ca/~frodo/jasper/software/jasper-$Jasper_Version.zip
	wget -c https://github.com/pmodels/mpich/releases/download/v$Mpich_Version/mpich-$Mpich_Version.tar.gz
	wget -c https://parallel-netcdf.github.io/Release/pnetcdf-$Pnetcdf_Version.tar.gz

	echo " "

	############################# Compilers #############################

	# Symlink to avoid clang conflicts with compilers
	# Default gcc path: /usr/bin/gcc
	# Default homebrew path: /usr/local/bin

	# Find the highest version of GCC, G++, and GFortran in /usr/local/bin
	latest_gcc=$(ls /usr/local/bin/gcc-* 2>/dev/null | grep -o 'gcc-[0-9]*' | sort -V | tail -n 1)
	latest_gpp=$(ls /usr/local/bin/g++-* 2>/dev/null | grep -o 'g++-[0-9]*' | sort -V | tail -n 1)
	latest_gfortran=$(ls /usr/local/bin/gfortran-* 2>/dev/null | grep -o 'gfortran-[0-9]*' | sort -V | tail -n 1)

	# Display the chosen versions
	echo "Selected gcc version: $latest_gcc"
	echo "Selected g++ version: $latest_gpp"
	echo "Selected gfortran version: $latest_gfortran"

	# Check if GCC was found

	# Create or update the symbolic links for GCC, G++, and GFortran
	echo "Linking the latest GCC version: $latest_gcc"
	echo $PASSWD | sudo -S ln -sf /usr/local/bin/$latest_gcc /usr/local/bin/gcc

	echo "Linking the latest G++ version: $latest_gpp"
	echo $PASSWD | sudo -S ln -sf /usr/local/bin/$latest_gpp /usr/local/bin/g++

	echo "Linking the latest GFortran version: $latest_gfortran"
	echo $PASSWD | sudo -S ln -sf /usr/local/bin/$latest_gfortran /usr/local/bin/gfortran

	echo "Updated symbolic links for GCC, G++, and GFortran."
	echo $PASSWD | sudo -S ln -sf /usr/local/bin/python3.12 /usr/local/bin/python3

	# Export compiler environment variables
	export CC=gcc
	export CXX=g++
	export FC=gfortran
	export F77=gfortran
	export CFLAGS="-fPIC -fPIE -Wno-implicit-function-declaration -Wno-incompatible-pointer-types -Wall"

	echo " "

	############################# End of Compiler Setup #############################

	#IF statement for GNU compiler issue
	export GCC_VERSION=$(/usr/local/bin/$latest_gcc -dumpfullversion | awk '{print$1}')
	export GFORTRAN_VERSION=$(/usr/local/bin/$latest_gfortran -dumpfullversion | awk '{print$1}')
	export GPLUSPLUS_VERSION=$(/usr/local/bin/$latest_gpp -dumpfullversion | awk '{print$1}')

	export GCC_VERSION_MAJOR_VERSION=$(echo $GCC_VERSION | awk -F. '{print $1}')
	export GFORTRAN_VERSION_MAJOR_VERSION=$(echo $GFORTRAN_VERSION | awk -F. '{print $1}')
	export GPLUSPLUS_VERSION_MAJOR_VERSION=$(echo $GPLUSPLUS_VERSION | awk -F. '{print $1}')

	export version_10="10"

	if [ $GCC_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GFORTRAN_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GPLUSPLUS_VERSION_MAJOR_VERSION -ge $version_10 ]; then
		export fallow_argument=-fallow-argument-mismatch
		export boz_argument=-fallow-invalid-boz
	else
		export fallow_argument=
		export boz_argument=
	fi

	export FFLAGS="$fallow_argument -m64"
	export FCFLAGS="$fallow_argument -m64"

	echo "##########################################"
	echo "FFLAGS = $FFLAGS"
	echo "FCFLAGS = $FCFLAGS"
	echo "CFLAGS = $CFLAGS"
	echo "##########################################"

	echo " "

	############################# ZLib ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf zlib-$Zlib_Version.tar.gz
	cd zlib-$Zlib_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	export ZLIB_ROOT=$DIR/grib2
	export ZLIBLIB=$DIR/grib2/lib
	export ZLIBINC=$DIR/grib2/include

	echo " "

	############################## MPICH ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf mpich-$Mpich_Version.tar.gz
	cd mpich-$Mpich_Version/

	F90= ./configure --prefix=$DIR/MPICH --with-device=ch3 FFLAGS="$fallow_argument -m64" FCFLAGS="$fallow_argument -m64" 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/MPICH/bin:$PATH

	export MPIFC=$DIR/MPICH/bin/mpifort
	export MPIF77=$DIR/MPICH/bin/mpifort
	export MPIF90=$DIR/MPICH/bin/mpifort
	export MPICC=$DIR/MPICH/bin/mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx

	echo " "

	############################# libpng ############################

	cd "${WRF_FOLDER}"/Downloads

	# other libraries below need these variables to be set
	export LDFLAGS=-L$DIR/grib2/lib
	export CPPFLAGS=-I$DIR/grib2/include

	LD_LIBRARY_PATH= tar -xvzf libpng-$Libpng_Version.tar.gz
	cd libpng-$Libpng_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNG_ROOT=$DIR/grib2

	echo " "
	#############################JasPer ############################

	cd "${WRF_FOLDER}"/Downloads
	unzip jasper-$Jasper_Version.zip
	cd jasper-$Jasper_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	export JASPERLIB=$DIR/grib2/lib
	export JASPERINC=$DIR/grib2/include
	export JASPER_DIR=$DIR/grib2
	export Jasper_ROOT=$DIR/grib2/lib

	echo " "
	############################# hdf5 library for netcdf4 functionality ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf hdf5-$HDF5_Version.tar.gz
	cd hdf5-$HDF5_Version

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --with-zlib=$DIR/grib2 --enable-hl --enable-fortran --enable-parallel 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export HDF5=$DIR/grib2
	export PATH=$HDF5/bin:$PATH
	export PHDF5=$DIR/grib2
	export HDF5_ROOT=$DIR/grib2
	export PHDF5_ROOT=$DIR/grib2

	echo " "

	############################# Install Parallel-netCDF ##############################
	#Make file created with half of available cpu cores
	#Hard path for MPI added
	##################################################################################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf pnetcdf-$Pnetcdf_Version.tar.gz
	cd pnetcdf-$Pnetcdf_Version

	export MPIFC=$DIR/MPICH/bin/mpifort
	export MPIF77=$DIR/MPICH/bin/mpifort
	export MPIF90=$DIR/MPICH/bin/mpifort
	export MPICC=$DIR/MPICH/bin/mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx

	# drop --disable-utils (not recognized)
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS="-std=gnu99 $CFLAGS" FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --enable-static 2>&1 | tee configure.log

	# build only libraries
	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log

	# install only libraries and headers
	make install 2>&1 | tee make.install.log

	export PNETCDF=$DIR/grib2
	export PNETCDF_DIR=$DIR/grib2
	export PNETCDF_ROOT=$DIR/grib2

	echo " "

	read -r -t 3 -p

	############################## Install NETCDF C Library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_C_Version.tar.gz
	cd netcdf-c-$Netcdf_C_Version/
	export CPPFLAGS=-I$DIR/grib2/include
	export LDFLAGS="-L$DIR/grib2/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lhdf5_hl -lhdf5 -lz -lcurl -lgfortran -lgcc -lm -ldl -lpnetcdf"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --disable-dap --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-pnetcdf --enable-cdf5 --enable-parallel-tests --enable-logging 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/NETCDF/bin:$PATH
	export NETCDF=$DIR/NETCDF
	export NETCDF_INC=$DIR/NETCDF/include
	export NETCDF_LIB=$DIR/NETCDF/lib
	export NETCDF_ROOT=$DIR/NETCDF
	export LD_LIBRARY_PATH=$DIR/grib2/lib:$DIR/NETCDF/lib:$LD_LIBRARY_PATH

	echo " "

	############################## NetCDF fortran library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_Fortran_Version.tar.gz
	cd netcdf-fortran-$Netcdf_Fortran_Version/
	export LD_LIBRARY_PATH=$DIR/NETCDF/lib:$LD_LIBRARY_PATH
	export CPPFLAGS="-I$DIR/NETCDF/include -I$DIR/grib2/include"
	export LDFLAGS="-L$DIR/NETCDF/lib -L$DIR/grib2/lib -Wl,-rpath,$DIR/NETCDF/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lnetcdf -lpnetcdf -lcurl -lhdf5_hl -lhdf5 -lz -lm -ldl -lgcc -lgfortran"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-parallel-tests --enable-logging --enable-hdf5 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	echo " "

	#################################### System Environment Tests ##############
	mkdir -p "${WRF_FOLDER}"/Tests/Environment
	mkdir -p "${WRF_FOLDER}"/Tests/Compatibility

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_NETCDF_MPI_tests.tar
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_tests.tar

	LD_LIBRARY_PATH= tar -xvf Fortran_C_tests.tar -C "${WRF_FOLDER}"/Tests/Environment
	LD_LIBRARY_PATH= tar -xvf Fortran_C_NETCDF_MPI_tests.tar -C "${WRF_FOLDER}"/Tests/Compatibility
	export one="1"
	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Environment

	echo " "
	echo " "
	echo "Environment Testing "
	echo "Test 1"
	$FC TEST_1_fortran_only_fixed.f
	./a.out | tee env_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 1 Passed"
	else
		echo "Environment Compiler Test 1 Failed"
		exit
	fi
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 2"
	$FC TEST_2_fortran_only_free.f90
	./a.out | tee env_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 2 Passed"
	else
		echo "Environment Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 3"
	$CC TEST_3_c_only.c
	./a.out | tee env_test3.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test3.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 3 Passed"
	else
		echo "Environment Compiler Test 3 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 4"
	$CC -c -m64 TEST_4_fortran+c_c.c
	$FC -c -m64 TEST_4_fortran+c_f.f90
	$FC -m64 TEST_4_fortran+c_f.o TEST_4_fortran+c_c.o
	./a.out | tee env_test4.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test4.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 4 Passed"
	else
		echo "Environment Compiler Test 4 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Compatibility

	cp ${NETCDF}/include/netcdf.inc .

	echo " "
	echo " "
	echo "Library Compatibility Tests "
	echo "Test 1"
	$FC -c 01_fortran+c+netcdf_f.f
	$CC -c 01_fortran+c+netcdf_c.c
	$FC 01_fortran+c+netcdf_f.o 01_fortran+c+netcdf_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	./a.out | tee comp_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 1 Passed"
	else
		echo "Compatibility Compiler Test 1 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "

	echo "Test 2"
	$MPIFC -c 02_fortran+c+netcdf+mpi_f.f
	$MPICC -c 02_fortran+c+netcdf+mpi_c.c
	$MPIFC 02_fortran+c+netcdf+mpi_f.o \
		02_fortran+c+netcdf+mpi_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	$DIR/MPICH/bin/mpirun ./a.out | tee comp_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 2 Passed"
	else
		echo "Compatibility Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."
	echo " "

	echo " All tests completed and passed"
	echo " "

	echo " "

	################################OpenGrADS######################################
	#Verison 2.2.1 64bit of Linux
	#############################################################################
	if [[ $GRADS_PICK -eq 1 ]]; then
		cd "${WRF_FOLDER}"/Downloads
		wget -c https://sourceforge.net/projects/opengrads/files/grads2/2.2.1.oga.1/macOS/opengrads-2.2.1.oga.1-bundle-x86_64-apple-darwin20.5.0.pkg
		sudo -S installer -pkg opengrads-2.2.1.oga.1-bundle-x86_64-apple-darwin20.5.0.pkg -target /Applications/OpenGrads <<<"$PASSWD"

	fi
	################################## GrADS ###############################
	# Version  2.2.1
	# Sublibs library instructions: http://cola.gmu.edu/grads/gadoc/supplibs2.html
	# GrADS instructions: http://cola.gmu.edu/grads/downloads.php
	########################################################################
	if [[ $GRADS_PICK -eq 2 ]]; then

		brew install grads

	fi

	############################# WRF HYDRO V5.4.0 #################################
	# Version 5.3.0
	# Standalone mode
	################################################################################
	# Set up NETCDF environment variables
	export NETCDF_INC="$DIR/NETCDF/include"
	export NETCDF_LIB="$DIR/NETCDF/lib"

	# Create directories for Hydro Basecode and navigate to it
	mkdir -p "${WRF_FOLDER}/Hydro-Basecode"
	cd "${WRF_FOLDER}/Hydro-Basecode"

	# Clone the WRF-Hydro repository and set up the build
	git clone https://github.com/NCAR/wrf_hydro_nwm_public.git
	cd wrf_hydro_nwm_public
	mkdir -p build
	cd build

	# Run CMake configuration for WRF-Hydro with specified options
	cmake .. \
		-DSPATIAL_SOIL=1 \
		-DWRF_HYDRO=1 \
		-DWRFIO_NCD_LARGE_FILE_SUPPORT=1 \
		-DCMAKE_Fortran_COMPILER=/usr/local/bin/$latest_gfortran \
		-DCMAKE_C_COMPILER=/usr/local/bin/$latest_gcc \
		-DNETCDF_MODULES=$DIR/NETCDF/include

	# Compile using specified CPU settings
	make -j "$CPU_QUARTER_EVEN" 2>&1 | tee make.log

	# Check if the necessary executable files were created
	# Check if the necessary executable files were created
	cd "${WRF_FOLDER}/Hydro-Basecode/wrf_hydro_nwm_public/build/Run"

	# List of expected executable files
	expected_execs=("wrf_hydro.exe" "wrf_hydro_NoahMP")

	# Function to check for missing executables
	check_missing_execs() {
		missing=0
		for exe in "${expected_execs[@]}"; do
			if [[ ! -f "$exe" ]]; then
				echo "Missing: $exe"
				missing=1
			fi
		done
		return $missing
	}

	# Function to rerun compilation
	rebuild_and_check() {
		echo "Missing one or more expected files. Running compiler again..."
		cd "${WRF_FOLDER}/Hydro-Basecode/wrf_hydro_nwm_public/build"
		make -j "$CPU_QUARTER_EVEN" 2>&1 | tee make2.log
		cd "${WRF_FOLDER}/Hydro-Basecode/wrf_hydro_nwm_public/build/Run"
	}

	# Initial check
	check_missing_execs
	if (($? == 0)); then
		echo "All expected executable files are present."
	else
		rebuild_and_check
		check_missing_execs
		if (($? != 0)); then
			echo "Missing one or more expected files even after recompilation."
			read -r -p "Please contact script authors for assistance. Press 'Enter' to exit the script."
			exit 1
		else
			echo "All expected files created after re-compiling."
		fi
	fi
	# Finish the script with a pause
	read -r -t 5 -p "Finished installing WRF Hydro Basecode. Waiting for 5 seconds..."
	######################### Testing WRF HYDRO Compliation #########################
	cd "${WRF_FOLDER}"/

	#Download test case for WRF HYDRO and move to NWM
	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/NCAR/wrf_hydro_nwm_public/releases/download/v${HYDRO_CROTON_TEST_CASE}/croton_NY_training_example_v${HYDRO_CROTON_TEST_CASE_MINOR}.tar.gz
	LD_LIBRARY_PATH= tar -xvzf croton_NY_training_example_v${HYDRO_CROTON_TEST_CASE_MINOR}.tar.gz
	mv example_case "${WRF_FOLDER}"/Hydro-Basecode

	#Copy the *.TBL files to the example configuration directory:
	cp "${WRF_FOLDER}"/Hydro-Basecode/wrf_hydro_nwm_public/build/Run/*.TBL "${WRF_FOLDER}"/Hydro-Basecode/example_case/NWM

	#Copy the wrf_hydro file:
	cp "${WRF_FOLDER}"/Hydro-Basecode/wrf_hydro_nwm_public/build/Run/wrf_hydro "${WRF_FOLDER}"/Hydro-Basecode/example_case/NWM

	#From the example_case/Gridded directory, create a symlink:
	ln -s "${WRF_FOLDER}"/Hydro-Basecode/example_case/FORCING "${WRF_FOLDER}"/Hydro-Basecode/example_case/NWM

	#Move to Gridded Folder
	cd "${WRF_FOLDER}"/Hydro-Basecode/example_case/NWM

	#Run Wrf hydro
	mpirun -np $CPU_QUARTER_EVEN ./wrf_hydro

	echo "Checking HYDRO_RST files..."
	ls -lah HYDRO_RST.*_DOMAIN1 2>/dev/null || echo "No HYDRO_RST files found."

	all_good=true
	for file in HYDRO_RST.*_DOMAIN1; do
		if [ ! -s "$file" ]; then
			echo "File $file is empty or missing!"
			all_good=false
		fi
	done

	if [ "$all_good" = true ]; then
		echo "HYDRO_RST files exist and have data  wrf_hydro.exe successful."
	else
		echo "One or more HYDRO_RST files are missing or empty."
		echo "Please check your model run."
		exit 1
	fi

	echo " "
	########################### Test script for output data  ###################################

	#Installing Miniconda3 to WRF directory and updating libraries
	echo $PASSWD | sudo -S apt -y install python3-zstandard python3-zstd

	export Miniconda_Install_DIR="${WRF_FOLDER}"/miniconda3

	mkdir -p $Miniconda_Install_DIR

	wget -c https://repo.anaconda.com/miniconda/Miniconda3-latest-MacOSX-x86_64.sh -O $Miniconda_Install_DIR/miniconda.sh
	bash $Miniconda_Install_DIR/miniconda.sh -b -u -p $Miniconda_Install_DIR

	rm -rf $Miniconda_Install_DIR/miniconda.sh

	export PATH="${WRF_FOLDER}"/miniconda3/bin:$PATH

	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	$Miniconda_Install_DIR/bin/conda init bash

	conda tos accept
	conda config --add channels conda-forge
	conda config --set auto_activate_base false
	conda update -n root --all -y

	##################### WRF Python           ##################
	########### WRf-Python compiled via Conda  ##################
	########### This is the preferred method by NCAR      ##################
	##### https://wrf-python.readthedocs.io/en/latest/installation.html  ##################
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh
	conda env create -f $HOME/WRF-MOSIT/wrf-python-stable.yml
	echo " "

	cp $HOME/WRF-MOSIT/SurfaceRunoff.py "${WRF_FOLDER}"/Hydro-Basecode/example_case/NWM

	cd "${WRF_FOLDER}"/Hydro-Basecode/example_case/NWM

	conda activate wrf-python
	python3 SurfaceRunoff.py
	conda deactivate
	conda deactivate
	conda deactivate

	if [ -f "SurfaceRunoff.pdf" ]; then
		echo "SurfaceRunoff.pdf exists."
	else
		echo "SurfaceRunoff.pdf is missing."
		exit 1 # Uncomment if you want to stop the script
	fi

	echo " "

	echo " "
	echo "WRF HYDRO Standalone sucessfully configured and compiled"
	echo "Thank you for using this script"

fi

if [ "$macos_64bit_GNU" = "1" ] && [ "$WRFHYDRO_STANDALONE_PICK" = "1" ] && [ "$MAC_CHIP" = "ARM" ]; then

	## WRF installation with parallel process.
	# Download and install required library and data files for WRF.
	# Tested in macOS Ventura 13.4.1
	# Tested in 64-bit
	# Tested with current available libraries on 03/01/2025
	# If newer libraries exist edit script paths for changes
	#Estimated Run Time ~ 90 - 150 Minutes with 10mb/s downloadspeed.
	#Special thanks to  Youtube's meteoadriatic and GitHub user jamal919.

	#############################basic package managment############################
	brew cleanup -s
	brew update
	outdated_packages=$(brew outdated --quiet)

	# List of packages to check/install
	packages=(
		"autoconf" "automake" "bison" "byacc" "cmake" "curl" "flex" "gcc"
		"gedit" "git" "gnu-sed" "ksh"
		"libtool" "libxml2" "m4" "make" "python@3.12" "tcsh" "wget"
		"xauth" "xorgproto" "xorgrgb" "xquartz"
	)

	for pkg in "${packages[@]}"; do
		if brew list "$pkg" &>/dev/null; then
			echo "$pkg is already installed."
			if [[ $outdated_packages == *"$pkg"* ]]; then
				echo "$pkg has a newer version available. Upgrading..."
				brew upgrade "$pkg"
			fi
		else
			echo "$pkg is not installed. Installing..."
			brew install "$pkg"
		fi
		sleep 1
	done

	export LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH
	export PATH=/usr/local/bin:$PATH

	##############################Directory Listing############################

	export HOME=$(
		cd
		pwd
	)

	mkdir $HOME/WRFHYDRO_STANDALONE
	export WRF_FOLDER=$HOME/WRFHYDRO_STANDALONE
	cd "${WRF_FOLDER}"/
	mkdir Downloads
	mkdir Libs
	export DIR="${WRF_FOLDER}"/Libs
	mkdir Libs/grib2
	mkdir Libs/NETCDF

	echo " "
	#############################Core Management####################################
	export CPU_CORE=$(sysctl -n hw.ncpu) # number of available threads on system
	export CPU_6CORE="6"
	export CPU_QUARTER=$(($CPU_CORE / 4))
	#1/2 of availble cores on system
	export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))
	#Forces CPU cores to even number to avoid partial core export. ie 7 cores would be 3.5 cores.

	if [ $CPU_CORE -le $CPU_6CORE ]; then #If statement for low core systems.  Forces computers to only use 1 core if there are 4 cores or less on the system. then
		export CPU_QUARTER_EVEN="2"
	else
		export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))
	fi

	echo "##########################################"
	echo "Number of Threads being used $CPU_QUARTER_EVEN"
	echo "##########################################"
	echo " "

	##############################Downloading Libraries############################

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/madler/zlib/releases/download/v$Zlib_Version/zlib-$Zlib_Version.tar.gz
	wget -c https://github.com/HDFGroup/hdf5/releases/download/hdf5_$HDF5_Version/hdf5-$HDF5_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-c/archive/refs/tags/v$Netcdf_C_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-fortran/archive/refs/tags/v$Netcdf_Fortran_Version.tar.gz
	wget -c https://download.sourceforge.net/libpng/libpng-$Libpng_Version.tar.gz
	wget -c https://www.ece.uvic.ca/~frodo/jasper/software/jasper-$Jasper_Version.zip
	wget -c https://github.com/pmodels/mpich/releases/download/v$Mpich_Version/mpich-$Mpich_Version.tar.gz
	wget -c https://parallel-netcdf.github.io/Release/pnetcdf-$Pnetcdf_Version.tar.gz

	echo " "

	############################# Compilers #############################

	# Unlink any existing Homebrew compiler symlinks
	echo $PASSWD | sudo -S unlink /opt/homebrew/bin/gfortran
	echo $PASSWD | sudo -S unlink /opt/homebrew/bin/gcc
	echo $PASSWD | sudo -S unlink /opt/homebrew/bin/g++

	# Source the bashrc to ensure environment variables are loaded
	source ~/.bashrc

	# Check current versions of gcc, g++, and gfortran (these should show "command not found" if unlinked)
	gcc --version
	g++ --version
	gfortran --version

	# Navigate to the Homebrew binaries directory
	cd /opt/homebrew/bin

	# Find the latest version of GCC, G++, and GFortran
	latest_gcc=$(ls gcc-* 2>/dev/null | grep -o 'gcc-[0-9]*' | sort -V | tail -n 1)
	latest_gpp=$(ls g++-* 2>/dev/null | grep -o 'g++-[0-9]*' | sort -V | tail -n 1)
	latest_gfortran=$(ls gfortran-* 2>/dev/null | grep -o 'gfortran-[0-9]*' | sort -V | tail -n 1)

	# Check if the latest versions were found and link them
	echo "Linking the latest GCC version: $latest_gcc"
	echo $PASSWD | sudo -S ln -sf $latest_gcc gcc
	echo "Linking the latest G++ version: $latest_gpp"
	echo $PASSWD | sudo -S ln -sf $latest_gpp g++
	echo "Linking the latest GFortran version: $latest_gfortran"
	echo $PASSWD | sudo -S ln -sf $latest_gfortran gfortran

	# Return to the home directory
	cd

	# Source bashrc and bash_profile to reload the environment settings
	source ~/.bashrc
	source ~/.bash_profile

	# Check if the versions were successfully updated
	gcc --version
	g++ --version
	gfortran --version

	# Export compiler environment variables
	export CC=gcc
	export CXX=g++
	export FC=gfortran
	export F77=gfortran
	export CFLAGS="-fPIC -fPIE -Wno-implicit-function-declaration -Wno-incompatible-pointer-types -Wall"

	echo " "

	############################# End of Compiler Setup #############################

	#IF statement for GNU compiler issue
	export GCC_VERSION=$(/opt/homebrew/bin/$latest_gcc -dumpfullversion | awk '{print$1}')
	export GFORTRAN_VERSION=$(/opt/homebrew/bin/$latest_gfortran -dumpfullversion | awk '{print$1}')
	export GPLUSPLUS_VERSION=$(/opt/homebrew/bin/$latest_gpp -dumpfullversion | awk '{print$1}')

	export GCC_VERSION_MAJOR_VERSION=$(echo $GCC_VERSION | awk -F. '{print $1}')
	export GFORTRAN_VERSION_MAJOR_VERSION=$(echo $GFORTRAN_VERSION | awk -F. '{print $1}')
	export GPLUSPLUS_VERSION_MAJOR_VERSION=$(echo $GPLUSPLUS_VERSION | awk -F. '{print $1}')

	export version_10="10"

	if [ $GCC_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GFORTRAN_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GPLUSPLUS_VERSION_MAJOR_VERSION -ge $version_10 ]; then
		export fallow_argument=-fallow-argument-mismatch
		export boz_argument=-fallow-invalid-boz
	else
		export fallow_argument=
		export boz_argument=
	fi

	export FFLAGS="$fallow_argument -m64"
	export FCFLAGS="$fallow_argument -m64"

	echo "##########################################"
	echo "FFLAGS = $FFLAGS"
	echo "FCFLAGS = $FCFLAGS"
	echo "CFLAGS = $CFLAGS"
	echo "##########################################"

	echo " "
	############################# ZLib ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf zlib-$Zlib_Version.tar.gz
	cd zlib-$Zlib_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	export ZLIB_ROOT=$DIR/grib2
	export ZLIBLIB=$DIR/grib2/lib
	export ZLIBINC=$DIR/grib2/include

	echo " "

	############################## MPICH ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf mpich-$Mpich_Version.tar.gz
	cd mpich-$Mpich_Version/

	F90= ./configure --prefix=$DIR/MPICH --with-device=ch3 FFLAGS="$fallow_argument -m64" FCFLAGS="$fallow_argument -m64" 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/MPICH/bin:$PATH

	export MPIFC=$DIR/MPICH/bin/mpifort
	export MPIF77=$DIR/MPICH/bin/mpifort
	export MPIF90=$DIR/MPICH/bin/mpifort
	export MPICC=$DIR/MPICH/bin/mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx

	echo " "

	############################# libpng ############################

	cd "${WRF_FOLDER}"/Downloads

	# other libraries below need these variables to be set
	export LDFLAGS=-L$DIR/grib2/lib
	export CPPFLAGS=-I$DIR/grib2/include

	LD_LIBRARY_PATH= tar -xvzf libpng-$Libpng_Version.tar.gz
	cd libpng-$Libpng_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNG_ROOT=$DIR/grib2

	echo " "
	#############################JasPer ############################

	cd "${WRF_FOLDER}"/Downloads
	unzip jasper-$Jasper_Version.zip
	cd jasper-$Jasper_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	export JASPERLIB=$DIR/grib2/lib
	export JASPERINC=$DIR/grib2/include
	export JASPER_DIR=$DIR/grib2
	export Jasper_ROOT=$DIR/grib2/lib

	echo " "
	############################# hdf5 library for netcdf4 functionality ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf hdf5-$HDF5_Version.tar.gz
	cd hdf5-$HDF5_Version

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --with-zlib=$DIR/grib2 --enable-hl --enable-fortran --enable-parallel 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export HDF5=$DIR/grib2
	export PATH=$HDF5/bin:$PATH
	export PHDF5=$DIR/grib2
	export HDF5_ROOT=$DIR/grib2
	export PHDF5_ROOT=$DIR/grib2

	echo " "

	############################# Install Parallel-netCDF ##############################
	#Make file created with half of available cpu cores
	#Hard path for MPI added
	##################################################################################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf pnetcdf-$Pnetcdf_Version.tar.gz
	cd pnetcdf-$Pnetcdf_Version

	export MPIFC=$DIR/MPICH/bin/mpifort
	export MPIF77=$DIR/MPICH/bin/mpifort
	export MPIF90=$DIR/MPICH/bin/mpifort
	export MPICC=$DIR/MPICH/bin/mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx

	# drop --disable-utils (not recognized)
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS="-std=gnu99 $CFLAGS" FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --enable-static 2>&1 | tee configure.log

	# build only libraries
	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log

	# install only libraries and headers
	make install 2>&1 | tee make.install.log

	export PNETCDF=$DIR/grib2
	export PNETCDF_DIR=$DIR/grib2
	export PNETCDF_ROOT=$DIR/grib2

	echo " "

	read -r -t 3 -p

	############################## Install NETCDF C Library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_C_Version.tar.gz
	cd netcdf-c-$Netcdf_C_Version/
	export CPPFLAGS=-I$DIR/grib2/include
	export LDFLAGS="-L$DIR/grib2/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lhdf5_hl -lhdf5 -lz -lcurl -lgfortran -lgcc -lm -ldl -lpnetcdf"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --disable-dap --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-pnetcdf --enable-cdf5 --enable-parallel-tests --enable-logging 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/NETCDF/bin:$PATH
	export NETCDF=$DIR/NETCDF
	export NETCDF_INC=$DIR/NETCDF/include
	export NETCDF_LIB=$DIR/NETCDF/lib
	export NETCDF_ROOT=$DIR/NETCDF
	export LD_LIBRARY_PATH=$DIR/grib2/lib:$DIR/NETCDF/lib:$LD_LIBRARY_PATH

	echo " "

	############################## NetCDF fortran library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_Fortran_Version.tar.gz
	cd netcdf-fortran-$Netcdf_Fortran_Version/
	export LD_LIBRARY_PATH=$DIR/NETCDF/lib:$LD_LIBRARY_PATH
	export CPPFLAGS="-I$DIR/NETCDF/include -I$DIR/grib2/include"
	export LDFLAGS="-L$DIR/NETCDF/lib -L$DIR/grib2/lib -Wl,-rpath,$DIR/NETCDF/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lnetcdf -lpnetcdf -lcurl -lhdf5_hl -lhdf5 -lz -lm -ldl -lgcc -lgfortran"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-parallel-tests --enable-logging --enable-hdf5 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	echo " "

	#################################### System Environment Tests ##############
	mkdir -p "${WRF_FOLDER}"/Tests/Environment
	mkdir -p "${WRF_FOLDER}"/Tests/Compatibility

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_NETCDF_MPI_tests.tar
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_tests.tar

	LD_LIBRARY_PATH= tar -xvf Fortran_C_tests.tar -C "${WRF_FOLDER}"/Tests/Environment
	LD_LIBRARY_PATH= tar -xvf Fortran_C_NETCDF_MPI_tests.tar -C "${WRF_FOLDER}"/Tests/Compatibility
	export one="1"
	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Environment

	echo " "
	echo " "
	echo "Environment Testing "
	echo "Test 1"
	$FC TEST_1_fortran_only_fixed.f
	./a.out | tee env_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 1 Passed"
	else
		echo "Environment Compiler Test 1 Failed"
		exit
	fi
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 2"
	$FC TEST_2_fortran_only_free.f90
	./a.out | tee env_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 2 Passed"
	else
		echo "Environment Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 3"
	$CC TEST_3_c_only.c
	./a.out | tee env_test3.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test3.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 3 Passed"
	else
		echo "Environment Compiler Test 3 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 4"
	$CC -c -m64 TEST_4_fortran+c_c.c
	$FC -c -m64 TEST_4_fortran+c_f.f90
	$FC -m64 TEST_4_fortran+c_f.o TEST_4_fortran+c_c.o
	./a.out | tee env_test4.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test4.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 4 Passed"
	else
		echo "Environment Compiler Test 4 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Compatibility

	cp ${NETCDF}/include/netcdf.inc .

	echo " "
	echo " "
	echo "Library Compatibility Tests "
	echo "Test 1"
	$FC -c 01_fortran+c+netcdf_f.f
	$CC -c 01_fortran+c+netcdf_c.c
	$FC 01_fortran+c+netcdf_f.o 01_fortran+c+netcdf_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	./a.out | tee comp_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 1 Passed"
	else
		echo "Compatibility Compiler Test 1 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "

	echo "Test 2"
	$MPIFC -c 02_fortran+c+netcdf+mpi_f.f
	$MPICC -c 02_fortran+c+netcdf+mpi_c.c
	$MPIFC 02_fortran+c+netcdf+mpi_f.o \
		02_fortran+c+netcdf+mpi_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	$DIR/MPICH/bin/mpirun ./a.out | tee comp_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 2 Passed"
	else
		echo "Compatibility Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."
	echo " "

	echo " All tests completed and passed"
	echo " "

	echo " "

	################################OpenGrADS######################################
	#Verison 2.2.1 64bit of Linux
	#############################################################################
	if [[ $GRADS_PICK -eq 1 ]]; then
		cd "${WRF_FOLDER}"/Downloads
		wget -c https://sourceforge.net/projects/opengrads/files/grads2/2.2.1.oga.1/macOS/opengrads-2.2.1.oga.1-bundle-x86_64-apple-darwin20.5.0.pkg
		sudo -S installer -pkg opengrads-2.2.1.oga.1-bundle-x86_64-apple-darwin20.5.0.pkg -target /Applications/OpenGrads <<<"$PASSWD"

	fi
	################################## GrADS ###############################
	# Version  2.2.1
	# Sublibs library instructions: http://cola.gmu.edu/grads/gadoc/supplibs2.html
	# GrADS instructions: http://cola.gmu.edu/grads/downloads.php
	########################################################################
	if [[ $GRADS_PICK -eq 2 ]]; then

		brew install grads

	fi

	############################# WRF HYDRO V5.4.0 #################################
	# Version 5.3.0
	# Standalone mode
	################################################################################

	# Set up NETCDF environment variables
	export NETCDF_INC="$DIR/NETCDF/include"
	export NETCDF_LIB="$DIR/NETCDF/lib"

	# Create directories for Hydro Basecode and navigate to it
	mkdir -p "${WRF_FOLDER}/Hydro-Basecode"
	cd "${WRF_FOLDER}/Hydro-Basecode"

	# Clone the WRF-Hydro repository and set up the build
	git clone https://github.com/NCAR/wrf_hydro_nwm_public.git
	cd wrf_hydro_nwm_public
	mkdir -p build
	cd build

	# Run CMake configuration for WRF-Hydro with specified options
	cmake .. \
		-DSPATIAL_SOIL=1 \
		-DWRF_HYDRO=1 \
		-DWRFIO_NCD_LARGE_FILE_SUPPORT=1 \
		-DCMAKE_Fortran_COMPILER=/opt/homebrew/bin/$latest_gfortran \
		-DCMAKE_C_COMPILER=/opt/homebrew/bin/$latest_gcc \
		-DNETCDF_MODULES=$DIR/NETCDF/include

	# Compile using specified CPU settings
	make -j "$CPU_QUARTER_EVEN" 2>&1 | tee make.log

	# Check if the necessary executable files were created
	# Check if the necessary executable files were created
	cd "${WRF_FOLDER}/Hydro-Basecode/wrf_hydro_nwm_public/build/Run"

	# List of expected executable files
	expected_execs=("wrf_hydro.exe" "wrf_hydro_NoahMP")

	# Function to check for missing executables
	check_missing_execs() {
		missing=0
		for exe in "${expected_execs[@]}"; do
			if [[ ! -f "$exe" ]]; then
				echo "Missing: $exe"
				missing=1
			fi
		done
		return $missing
	}

	# Function to rerun compilation
	rebuild_and_check() {
		echo "Missing one or more expected files. Running compiler again..."
		cd "${WRF_FOLDER}/Hydro-Basecode/wrf_hydro_nwm_public/build"
		make -j "$CPU_QUARTER_EVEN" 2>&1 | tee make2.log
		cd "${WRF_FOLDER}/Hydro-Basecode/wrf_hydro_nwm_public/build/Run"
	}

	# Initial check
	check_missing_execs
	if (($? == 0)); then
		echo "All expected executable files are present."
	else
		rebuild_and_check
		check_missing_execs
		if (($? != 0)); then
			echo "Missing one or more expected files even after recompilation."
			read -r -p "Please contact script authors for assistance. Press 'Enter' to exit the script."
			exit 1
		else
			echo "All expected files created after re-compiling."
		fi
	fi

	# Finish the script with a pause
	read -r -t 5 -p "Finished installing WRF Hydro Basecode. Waiting for 5 seconds..."
	echo " "
	######################### Testing WRF HYDRO Compliation #########################
	cd "${WRF_FOLDER}"/

	#Download test case for WRF HYDRO and move to NWM
	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/NCAR/wrf_hydro_nwm_public/releases/download/v${HYDRO_CROTON_TEST_CASE}/croton_NY_training_example_v${HYDRO_CROTON_TEST_CASE_MINOR}.tar.gz
	LD_LIBRARY_PATH= tar -xvzf croton_NY_training_example_v${HYDRO_CROTON_TEST_CASE_MINOR}.tar.gz
	mv example_case "${WRF_FOLDER}"/Hydro-Basecode

	#Copy the *.TBL files to the example configuration directory:
	cp "${WRF_FOLDER}"/Hydro-Basecode/wrf_hydro_nwm_public/build/Run/*.TBL "${WRF_FOLDER}"/Hydro-Basecode/example_case/NWM

	#Copy the wrf_hydro file:
	cp "${WRF_FOLDER}"/Hydro-Basecode/wrf_hydro_nwm_public/build/Run/wrf_hydro "${WRF_FOLDER}"/Hydro-Basecode/example_case/NWM

	#From the example_case/Gridded directory, create a symlink:
	ln -s "${WRF_FOLDER}"/Hydro-Basecode/example_case/FORCING "${WRF_FOLDER}"/Hydro-Basecode/example_case/NWM

	#Move to Gridded Folder
	cd "${WRF_FOLDER}"/Hydro-Basecode/example_case/NWM

	#Run Wrf hydro
	mpirun -np $CPU_QUARTER_EVEN ./wrf_hydro

	echo "Checking HYDRO_RST files..."
	ls -lah HYDRO_RST.*_DOMAIN1 2>/dev/null || echo "No HYDRO_RST files found."

	all_good=true
	for file in HYDRO_RST.*_DOMAIN1; do
		if [ ! -s "$file" ]; then
			echo "File $file is empty or missing!"
			all_good=false
		fi
	done

	if [ "$all_good" = true ]; then
		echo "HYDRO_RST files exist and have data  wrf_hydro.exe successful."
	else
		echo "One or more HYDRO_RST files are missing or empty."
		echo "Please check your model run."
		exit 1
	fi

	echo " "
	########################### Test script for output data  ###################################

	#Installing Miniconda3 to WRF directory and updating libraries
	echo $PASSWD | sudo -S apt -y install python3-zstandard python3-zstd

	export Miniconda_Install_DIR="${WRF_FOLDER}"/miniconda3

	mkdir -p $Miniconda_Install_DIR

	wget -c https://repo.anaconda.com/miniconda/Miniconda3-latest-MacOSX-x86_64.sh -O $Miniconda_Install_DIR/miniconda.sh
	bash $Miniconda_Install_DIR/miniconda.sh -b -u -p $Miniconda_Install_DIR

	rm -rf $Miniconda_Install_DIR/miniconda.sh

	export PATH="${WRF_FOLDER}"/miniconda3/bin:$PATH

	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	$Miniconda_Install_DIR/bin/conda init bash

	conda tos accept
	conda config --add channels conda-forge
	conda config --set auto_activate_base false
	conda update -n root --all -y

	##################### WRF Python           ##################
	########### WRf-Python compiled via Conda  ##################
	########### This is the preferred method by NCAR      ##################
	##### https://wrf-python.readthedocs.io/en/latest/installation.html  ##################
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh
	conda env create -f $HOME/WRF-MOSIT/wrf-python-stable.yml
	echo " "

	cp $HOME/WRF-MOSIT/SurfaceRunoff.py "${WRF_FOLDER}"/Hydro-Basecode/example_case/NWM

	cd "${WRF_FOLDER}"/Hydro-Basecode/example_case/NWM

	conda activate wrf-python
	python3 SurfaceRunoff.py
	conda deactivate
	conda deactivate
	conda deactivate

	if [ -f "SurfaceRunoff.pdf" ]; then
		echo "SurfaceRunoff.pdf exists."
	else
		echo "SurfaceRunoff.pdf is missing."
		exit 1 # Uncomment if you want to stop the script
	fi

	echo " "

	echo " "
	echo "WRF HYDRO Standalone sucessfully configured and compiled"
	echo "Congratulations! You've successfully installed all required files to run the Weather Research Forecast Model HYDRO verison 5.2."
	echo "Thank you for using this script"

fi

if [ "$RHL_64bit_GNU" = "1" ] && [ "$WRFHYDRO_STANDALONE_PICK" = "1" ]; then
	#############################basic package managment############################
	echo $PASSWD | sudo -S yum install epel-release -y
	echo $PASSWD | sudo -S yum install dnf -y
	echo $PASSWD | sudo -S dnf install epel-release -y
	echo $PASSWD | sudo -S dnf install dnf -y
	echo $PASSWD | sudo -S dnf -y update
	echo $PASSWD | sudo -S dnf -y upgrade
	echo $PASSWD | sudo -S dnf -y install bzip2 bzip2-devel byacc cairo-devel cmake cpp curl curl-devel flex fontconfig-devel fontconfig-devel gcc gcc-c++ gcc-gfortran git java-11-openjdk java-11-openjdk-devel ksh libX11-devel libX11-devel libXaw libXaw-devel libXext-devel libXext-devel libXmu-devel libXrender-devel libXrender-devel libstdc++ libstdc++-devel libxml2 libxml2-devel m4 nfs-utils perl "perl(XML::LibXML)" pkgconfig pixman-devel python3 python3-devel tcsh time unzip wget
	echo $PASSWD | sudo -S dnf -y groupinstall "Development Tools"
	echo $PASSWD | sudo -S dnf -y update
	echo $PASSWD | sudo -S dnf -y upgrade

	echo " "
	##############################Directory Listing############################
	export HOME=$(
		cd
		pwd
	)

	mkdir $HOME/WRFHYDRO_STANDALONE
	export WRF_FOLDER=$HOME/WRFHYDRO_STANDALONE
	cd "${WRF_FOLDER}"/
	mkdir Downloads

	mkdir Libs
	export DIR="${WRF_FOLDER}"/Libs
	mkdir Libs/grib2
	mkdir Libs/NETCDF
	mkdir Libs/MPICH
	mkdir -p Tests/Environment
	mkdir -p Tests/Compatibility

	echo " "
	#############################Core Management####################################

	export CPU_CORE=$(nproc) # number of available threads on system
	export CPU_6CORE="6"
	export CPU_QUARTER=$(($CPU_CORE / 4))                          #quarter of availble cores on system
	export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2))) #Forces CPU cores to even number to avoid partial core export. ie 7 cores would be 3.5 cores.

	if [ $CPU_CORE -le $CPU_6CORE ]; then #If statement for low core systems.  Forces computers to only use 1 core if there are 4 cores or less on the system. then
		export CPU_QUARTER_EVEN="2"
	else
		export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))
	fi

	echo "##########################################"
	echo "Number of Threads being used $CPU_QUARTER_EVEN"
	echo "##########################################"

	echo " "
	##############################Downloading Libraries############################
	cd Downloads
	wget -c https://github.com/madler/zlib/releases/download/v$Zlib_Version/zlib-$Zlib_Version.tar.gz
	wget -c https://github.com/HDFGroup/hdf5/releases/download/hdf5_$HDF5_Version/hdf5-$HDF5_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-c/archive/refs/tags/v$Netcdf_C_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-fortran/archive/refs/tags/v$Netcdf_Fortran_Version.tar.gz
	wget -c https://github.com/pmodels/mpich/releases/download/v$Mpich_Version/mpich-$Mpich_Version.tar.gz
	wget -c https://download.sourceforge.net/libpng/libpng-$Libpng_Version.tar.gz
	wget -c https://www.ece.uvic.ca/~frodo/jasper/software/jasper-$Jasper_Version.zip
	wget -c https://parallel-netcdf.github.io/Release/pnetcdf-$Pnetcdf_Version.tar.gz

	echo " "
	####################################Compilers#####################################
	export CC=gcc
	export CXX=g++
	export FC=gfortran
	export F77=gfortran
	export CFLAGS="-fPIC -fPIE -O3"

	#IF statement for GNU compiler issue
	export GCC_VERSION=$(gcc -dumpfullversion | awk '{print$1}')
	export GFORTRAN_VERSION=$(gfortran -dumpfullversion | awk '{print$1}')
	export GPLUSPLUS_VERSION=$(g++ -dumpfullversion | awk '{print$1}')

	export GCC_VERSION_MAJOR_VERSION=$(echo $GCC_VERSION | awk -F. '{print $1}')
	export GFORTRAN_VERSION_MAJOR_VERSION=$(echo $GFORTRAN_VERSION | awk -F. '{print $1}')
	export GPLUSPLUS_VERSION_MAJOR_VERSION=$(echo $GPLUSPLUS_VERSION | awk -F. '{print $1}')

	export version_10="10"

	if [ $GCC_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GFORTRAN_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GPLUSPLUS_VERSION_MAJOR_VERSION -ge $version_10 ]; then
		export fallow_argument=-fallow-argument-mismatch
		export boz_argument=-fallow-invalid-boz
	else
		export fallow_argument=
		export boz_argument=
	fi

	export FFLAGS="$fallow_argument -m64"
	export FCFLAGS="$fallow_argument -m64"

	echo "##########################################"
	echo "FFLAGS = $FFLAGS"
	echo "FCFLAGS = $FCFLAGS"
	echo "CFLAGS = $CFLAGS"
	echo "##########################################"

	echo " "
	############################# ZLib ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf zlib-$Zlib_Version.tar.gz
	cd zlib-$Zlib_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	export ZLIB_ROOT=$DIR/grib2
	export ZLIBLIB=$DIR/grib2/lib
	export ZLIBINC=$DIR/grib2/include

	echo " "
	############################## MPICH ############################
	#F90= due to compiler issues with mpich install
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf mpich-$Mpich_Version.tar.gz
	cd mpich-$Mpich_Version/

	F90= ./configure --prefix=$DIR/MPICH --with-device=ch3 FFLAGS=$fallow_argument FCFLAGS=$fallow_argument 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/MPICH/bin:$PATH
	export MPIFC=$DIR/MPICH/bin/mpifort
	export MPIF77=$DIR/MPICH/bin/mpifort
	export MPIF90=$DIR/MPICH/bin/mpifort
	export MPICC=$DIR/MPICH/bin/mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx

	echo " "
	############################# libpng ############################

	cd "${WRF_FOLDER}"/Downloads

	# other libraries below need these variables to be set
	export LDFLAGS=-L$DIR/grib2/lib
	export CPPFLAGS=-I$DIR/grib2/include

	LD_LIBRARY_PATH= tar -xvzf libpng-$Libpng_Version.tar.gz
	cd libpng-$Libpng_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNG_ROOT=$DIR/grib2

	echo " "
	#############################JasPer ############################
	cd "${WRF_FOLDER}"/Downloads
	unzip jasper-$Jasper_Version.zip
	cd jasper-$Jasper_Version/

	./configure --prefix=$DIR/grib2
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export JASPERLIB=$DIR/grib2/lib
	export JASPERINC=$DIR/grib2/include
	export JASPER_DIR=$DIR/grib2
	export Jasper_ROOT=$DIR/grib2/lib

	echo " "
	############################# hdf5 library for netcdf4 functionality ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf hdf5-$HDF5_Version.tar.gz
	cd hdf5-$HDF5_Version

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --with-zlib=$DIR/grib2 --enable-hl --enable-fortran --enable-parallel 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export HDF5=$DIR/grib2
	export PATH=$HDF5/bin:$PATH
	export PHDF5=$DIR/grib2
	export HDF5_ROOT=$DIR/grib2
	export PHDF5_ROOT=$DIR/grib2

	echo " "
	############################# Install Parallel-netCDF ##############################
	#Make file created with half of available cpu cores
	#Hard path for MPI added
	##################################################################################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf pnetcdf-$Pnetcdf_Version.tar.gz
	cd pnetcdf-$Pnetcdf_Version

	export MPIFC=$DIR/MPICH/bin/mpifort
	export MPIF77=$DIR/MPICH/bin/mpifort
	export MPIF90=$DIR/MPICH/bin/mpifort
	export MPICC=$DIR/MPICH/bin/mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --enable-static 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNETCDF=$DIR/grib2
	export PNETCDF_DIR=$DIR/grib2
	export PNETCDF_ROOT=$DIR/grib2

	echo " "

	############################## Install NETCDF C Library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_C_Version.tar.gz
	cd netcdf-c-$Netcdf_C_Version/
	export CPPFLAGS=-I$DIR/grib2/include
	export LDFLAGS="-L$DIR/grib2/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lhdf5_hl -lhdf5 -lz -lcurl -lgfortran -lgcc -lm -ldl -lpnetcdf"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --disable-dap --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-pnetcdf --enable-cdf5 --enable-parallel-tests --enable-logging 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/NETCDF/bin:$PATH
	export NETCDF=$DIR/NETCDF
	export NETCDF_INC=$DIR/NETCDF/include
	export NETCDF_LIB=$DIR/NETCDF/lib
	export NETCDF_ROOT=$DIR/NETCDF
	export LD_LIBRARY_PATH=$DIR/grib2/lib:$DIR/NETCDF/lib:$LD_LIBRARY_PATH

	echo " "
	############################## NetCDF fortran library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_Fortran_Version.tar.gz
	cd netcdf-fortran-$Netcdf_Fortran_Version/
	export LD_LIBRARY_PATH=$DIR/NETCDF/lib:$LD_LIBRARY_PATH
	export CPPFLAGS="-I$DIR/NETCDF/include -I$DIR/grib2/include"
	export LDFLAGS="-L$DIR/NETCDF/lib -L$DIR/grib2/lib -Wl,-rpath,$DIR/NETCDF/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lnetcdf -lpnetcdf -lcurl -lhdf5_hl -lhdf5 -lz -lm -ldl -lgcc -lgfortran"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-parallel-tests --enable-logging --enable-hdf5 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	echo " "
	#################################### System Environment Tests ##############

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_NETCDF_MPI_tests.tar
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_tests.tar

	LD_LIBRARY_PATH= tar -xvf Fortran_C_tests.tar -C "${WRF_FOLDER}"/Tests/Environment
	LD_LIBRARY_PATH= tar -xvf Fortran_C_NETCDF_MPI_tests.tar -C "${WRF_FOLDER}"/Tests/Compatibility

	export one="1"
	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Environment

	cp ${NETCDF}/include/netcdf.inc .

	echo " "
	echo " "
	echo "Environment Testing "
	echo "Test 1"
	$FC TEST_1_fortran_only_fixed.f
	./a.out | tee env_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 1 Passed"
	else
		echo "Environment Compiler Test 1 Failed"
		exit
	fi
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 2"
	$FC TEST_2_fortran_only_free.f90
	./a.out | tee env_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 2 Passed"
	else
		echo "Environment Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 3"
	$CC TEST_3_c_only.c
	./a.out | tee env_test3.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test3.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 3 Passed"
	else
		echo "Environment Compiler Test 3 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 4"
	$CC -c -m64 TEST_4_fortran+c_c.c
	$FC -c -m64 TEST_4_fortran+c_f.f90
	$FC -m64 TEST_4_fortran+c_f.o TEST_4_fortran+c_c.o
	./a.out | tee env_test4.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test4.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 4 Passed"
	else
		echo "Environment Compiler Test 4 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Compatibility

	cp ${NETCDF}/include/netcdf.inc .

	echo " "
	echo " "
	echo "Library Compatibility Tests "
	echo "Test 1"
	$FC -c 01_fortran+c+netcdf_f.f
	$CC -c 01_fortran+c+netcdf_c.c
	$FC 01_fortran+c+netcdf_f.o 01_fortran+c+netcdf_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	./a.out | tee comp_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 1 Passed"
	else
		echo "Compatibility Compiler Test 1 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "

	echo "Test 2"
	$MPIFC -c 02_fortran+c+netcdf+mpi_f.f
	$MPICC -c 02_fortran+c+netcdf+mpi_c.c
	$MPIFC 02_fortran+c+netcdf+mpi_f.o \
		02_fortran+c+netcdf+mpi_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	$DIR/MPICH/bin/mpirun ./a.out | tee comp_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 2 Passed"
	else
		echo "Compatibility Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."
	echo " "

	echo " All tests completed and passed"
	echo " "

	############################# WRF HYDRO V5.4.0 #################################
	# Version 5.3.0
	# Standalone mode
	# GNU
	################################################################################
	# Set up NETCDF environment variables
	export NETCDF_INC="$DIR/NETCDF/include"
	export NETCDF_LIB="$DIR/NETCDF/lib"

	# Create directories for Hydro Basecode and navigate to it
	mkdir -p "${WRF_FOLDER}/Hydro-Basecode"
	cd "${WRF_FOLDER}/Hydro-Basecode"

	# Clone the WRF-Hydro repository and set up the build
	git clone https://github.com/NCAR/wrf_hydro_nwm_public.git
	cd wrf_hydro_nwm_public
	mkdir -p build
	cd build

	# Run CMake configuration for WRF-Hydro with specified options
	cmake .. \
		-DSPATIAL_SOIL=1 \
		-DWRF_HYDRO=1 \
		-DWRFIO_NCD_LARGE_FILE_SUPPORT=1 \
		-DCMAKE_Fortran_COMPILER=gfortran

	# Compile using specified CPU settings
	make -j "$CPU_QUARTER_EVEN" 2>&1 | tee make.log

	# Check if the necessary executable files were created
	# Check if the necessary executable files were created
	cd "${WRF_FOLDER}/Hydro-Basecode/wrf_hydro_nwm_public/build/Run"

	# List of expected executable files
	expected_execs=("wrf_hydro.exe" "wrf_hydro_NoahMP")

	# Function to check for missing executables
	check_missing_execs() {
		missing=0
		for exe in "${expected_execs[@]}"; do
			if [[ ! -f "$exe" ]]; then
				echo "Missing: $exe"
				missing=1
			fi
		done
		return $missing
	}

	# Function to rerun compilation
	rebuild_and_check() {
		echo "Missing one or more expected files. Running compiler again..."
		cd "${WRF_FOLDER}/Hydro-Basecode/wrf_hydro_nwm_public/build"
		make -j "$CPU_QUARTER_EVEN" 2>&1 | tee make2.log
		cd "${WRF_FOLDER}/Hydro-Basecode/wrf_hydro_nwm_public/build/Run"
	}

	# Initial check
	check_missing_execs
	if (($? == 0)); then
		echo "All expected executable files are present."
	else
		rebuild_and_check
		check_missing_execs
		if (($? != 0)); then
			echo "Missing one or more expected files even after recompilation."
			read -r -p "Please contact script authors for assistance. Press 'Enter' to exit the script."
			exit 1
		else
			echo "All expected files created after re-compiling."
		fi
	fi

	# Finish the script with a pause
	read -r -t 5 -p "Finished installing WRF Hydro Basecode. Waiting for 5 seconds..."
	######################### Testing WRF HYDRO Compliation #########################
	cd "${WRF_FOLDER}"/
	mkdir -p "${WRF_FOLDER}"/domain/NWM

	cp "${WRF_FOLDER}"/Hydro-Basecode/wrf_hydro_nwm_public/build/Run/* "${WRF_FOLDER}"/domain/NWM
	#Copy the *.TBL files to the NWM directory.

	cp wrf_hydro_nwm_public*/trunk/NDHMS/Run/wrf_hydro.exe domain/NWM #Copy the wrf_hydro.exe file to the NWM directory.

	######################### Testing WRF HYDRO Compliation #########################
	cd "${WRF_FOLDER}"/

	#Download test case for WRF HYDRO and move to NWM
	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/NCAR/wrf_hydro_nwm_public/releases/download/v${HYDRO_CROTON_TEST_CASE}/croton_NY_training_example_v${HYDRO_CROTON_TEST_CASE_MINOR}.tar.gz
	LD_LIBRARY_PATH= tar -xvzf croton_NY_training_example_v${HYDRO_CROTON_TEST_CASE_MINOR}.tar.gz
	mv example_case "${WRF_FOLDER}"/Hydro-Basecode

	#Copy the *.TBL files to the example configuration directory:
	cp "${WRF_FOLDER}"/Hydro-Basecode/wrf_hydro_nwm_public/build/Run/*.TBL "${WRF_FOLDER}"/Hydro-Basecode/example_case/NWM

	#Copy the wrf_hydro file:
	cp "${WRF_FOLDER}"/Hydro-Basecode/wrf_hydro_nwm_public/build/Run/wrf_hydro "${WRF_FOLDER}"/Hydro-Basecode/example_case/NWM

	#From the example_case/Gridded directory, create a symlink:
	ln -s "${WRF_FOLDER}"/Hydro-Basecode/example_case/FORCING "${WRF_FOLDER}"/Hydro-Basecode/example_case/NWM

	#Move to Gridded Folder
	cd "${WRF_FOLDER}"/Hydro-Basecode/example_case/NWM

	#Run Wrf hydro
	mpirun -np $CPU_QUARTER_EVEN ./wrf_hydro

	echo "Checking HYDRO_RST files..."
	ls -lah HYDRO_RST.*_DOMAIN1 2>/dev/null || echo "No HYDRO_RST files found."

	all_good=true
	for file in HYDRO_RST.*_DOMAIN1; do
		if [ ! -s "$file" ]; then
			echo "File $file is empty or missing!"
			all_good=false
		fi
	done

	if [ "$all_good" = true ]; then
		echo "HYDRO_RST files exist and have data  wrf_hydro.exe successful."
	else
		echo "One or more HYDRO_RST files are missing or empty."
		echo "Please check your model run."
		exit 1
	fi

	echo " "

	###############################################################################

	#Installing Miniconda3 to WRF directory and updating libraries
	echo $PASSWD | sudo -S apt -y install python3-zstandard python3-zstd

	export Miniconda_Install_DIR="${WRF_FOLDER}"/miniconda3

	mkdir -p $Miniconda_Install_DIR

	wget -c https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O $Miniconda_Install_DIR/miniconda.sh

	bash $Miniconda_Install_DIR/miniconda.sh -b -u -p $Miniconda_Install_DIR

	rm -rf $Miniconda_Install_DIR/miniconda.sh

	export PATH="${WRF_FOLDER}"/miniconda3/bin:$PATH

	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	$Miniconda_Install_DIR/bin/conda init bash

	conda tos accept
	conda config --add channels conda-forge
	conda config --set auto_activate_base false
	conda update -n root --all -y

	##################### WRF Python           ##################
	########### WRf-Python compiled via Conda  ##################
	########### This is the preferred method by NCAR      ##################
	##### https://wrf-python.readthedocs.io/en/latest/installation.html  ##################
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh
	conda env create -f $HOME/WRF-MOSIT/wrf-python-stable.yml
	echo " "
	################ NEEDS TO BE IN Master folder #######################
	cp $HOME/WRF-MOSIT/SurfaceRunoff.py "${WRF_FOLDER}"/Hydro-Basecode/example_case/NWM

	cd "${WRF_FOLDER}"/Hydro-Basecode/example_case/NWM

	conda activate wrf-python
	python3 SurfaceRunoff.py
	conda deactivate
	conda deactivate
	conda deactivate

	if [ -f "SurfaceRunoff.pdf" ]; then
		echo "SurfaceRunoff.pdf exists."
	else
		echo "SurfaceRunoff.pdf is missing."
		exit 1 # Uncomment if you want to stop the script
	fi

	echo " "

	echo " "
	#####################################BASH Script Finished##############################
	echo "WRF HYDRO Standalone sucessfully configured and compiled"
	read -r -t 5 -p "Congratulations! You've successfully installed all required files to run the Weather Research Forecast Model HYDRO verison 5.2."

	##########################  Export PATH and LD_LIBRARY_PATH ################################
	cd $HOME
fi

if [ "$RHL_64bit_GNU" = "2" ] && [ "$WRFHYDRO_STANDALONE_PICK" = "1" ]; then
	#############################basic package managment############################
	echo "old version of GNU detected"
	echo $PASSWD | sudo -S yum install RHL-release-scl -y
	echo $PASSWD | sudo -S yum clean all
	echo $PASSWD | sudo -S yum remove devtoolset-11*
	echo $PASSWD | sudo -S yum install devtoolset-11
	echo $PASSWD | sudo -S yum install devtoolset-11-\* -y
	source /opt/rh/devtoolset-11/enable
	gcc --version
	echo $PASSWD | sudo -S yum install epel-release -y
	echo $PASSWD | sudo -S yum install dnf -y
	echo $PASSWD | sudo -S dnf install epel-release -y
	echo $PASSWD | sudo -S dnf install dnf -y
	echo $PASSWD | sudo -S dnf -y update
	echo $PASSWD | sudo -S dnf -y upgrade
	echo $PASSWD | sudo -S dnf -y install bzip2 bzip2-devel byacc cairo-devel cmake cpp curl curl-devel flex fontconfig-devel fontconfig-devel gcc gcc-c++ gcc-gfortran git java-11-openjdk java-11-openjdk-devel ksh libX11-devel libX11-devel libXaw libXaw-devel libXext-devel libXext-devel libXmu-devel libXrender-devel libXrender-devel libstdc++ libstdc++-devel libxml2 libxml2-devel m4 nfs-utils perl "perl(XML::LibXML)" pkgconfig pixman-devel python3 python3-devel tcsh time unzip wget
	echo $PASSWD | sudo -S dnf -y groupinstall "Development Tools"
	echo $PASSWD | sudo -S dnf -y update
	echo $PASSWD | sudo -S dnf -y upgrade

	echo " "
	##############################Directory Listing############################
	export HOME=$(
		cd
		pwd
	)

	mkdir $HOME/WRFHYDRO_STANDALONE
	export WRF_FOLDER=$HOME/WRFHYDRO_STANDALONE
	cd "${WRF_FOLDER}"/
	mkdir Downloads

	mkdir Libs
	export DIR="${WRF_FOLDER}"/Libs
	mkdir Libs/grib2
	mkdir Libs/NETCDF
	mkdir Libs/MPICH
	mkdir -p Tests/Environment
	mkdir -p Tests/Compatibility

	echo " "
	#############################Core Management####################################

	export CPU_CORE=$(nproc) # number of available threads on system
	export CPU_6CORE="6"
	export CPU_QUARTER=$(($CPU_CORE / 4))                          #quarter of availble cores on system
	export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2))) #Forces CPU cores to even number to avoid partial core export. ie 7 cores would be 3.5 cores.

	if [ $CPU_CORE -le $CPU_6CORE ]; then #If statement for low core systems.  Forces computers to only use 1 core if there are 4 cores or less on the system. then
		export CPU_QUARTER_EVEN="2"
	else
		export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))
	fi

	echo "##########################################"
	echo "Number of Threads being used $CPU_QUARTER_EVEN"
	echo "##########################################"

	echo " "
	##############################Downloading Libraries############################
	cd Downloads
	wget -c https://github.com/madler/zlib/releases/download/v$Zlib_Version/zlib-$Zlib_Version.tar.gz
	wget -c https://github.com/HDFGroup/hdf5/releases/download/hdf5_$HDF5_Version/hdf5-$HDF5_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-c/archive/refs/tags/v$Netcdf_C_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-fortran/archive/refs/tags/v$Netcdf_Fortran_Version.tar.gz
	wget -c https://github.com/pmodels/mpich/releases/download/v$Mpich_Version/mpich-$Mpich_Version.tar.gz
	wget -c https://download.sourceforge.net/libpng/libpng-$Libpng_Version.tar.gz
	wget -c https://www.ece.uvic.ca/~frodo/jasper/software/jasper-$Jasper_Version.zip
	wget -c https://parallel-netcdf.github.io/Release/pnetcdf-$Pnetcdf_Version.tar.gz

	echo " "
	####################################Compilers#####################################
	export CC=gcc
	export CXX=g++
	export FC=gfortran
	export F77=gfortran
	export CFLAGS="-fPIC -fPIE -O3"

	#IF statement for GNU compiler issue
	export GCC_VERSION=$(gcc -dumpfullversion | awk '{print$1}')
	export GFORTRAN_VERSION=$(gfortran -dumpfullversion | awk '{print$1}')
	export GPLUSPLUS_VERSION=$(g++ -dumpfullversion | awk '{print$1}')

	export GCC_VERSION_MAJOR_VERSION=$(echo $GCC_VERSION | awk -F. '{print $1}')
	export GFORTRAN_VERSION_MAJOR_VERSION=$(echo $GFORTRAN_VERSION | awk -F. '{print $1}')
	export GPLUSPLUS_VERSION_MAJOR_VERSION=$(echo $GPLUSPLUS_VERSION | awk -F. '{print $1}')

	export version_10="10"

	if [ $GCC_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GFORTRAN_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GPLUSPLUS_VERSION_MAJOR_VERSION -ge $version_10 ]; then
		export fallow_argument=-fallow-argument-mismatch
		export boz_argument=-fallow-invalid-boz
	else
		export fallow_argument=
		export boz_argument=
	fi

	export FFLAGS="$fallow_argument -m64"
	export FCFLAGS="$fallow_argument -m64"

	echo "##########################################"
	echo "FFLAGS = $FFLAGS"
	echo "FCFLAGS = $FCFLAGS"
	echo "CFLAGS = $CFLAGS"
	echo "##########################################"

	echo " "
	############################# ZLib ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf zlib-$Zlib_Version.tar.gz
	cd zlib-$Zlib_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	export ZLIB_ROOT=$DIR/grib2
	export ZLIBLIB=$DIR/grib2/lib
	export ZLIBINC=$DIR/grib2/include

	echo " "
	echo " "
	############################## MPICH ############################
	#F90= due to compiler issues with mpich install
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf mpich-$Mpich_Version.tar.gz
	cd mpich-$Mpich_Version/

	F90= ./configure --prefix=$DIR/MPICH --with-device=ch3 FFLAGS=$fallow_argument FCFLAGS=$fallow_argument 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/MPICH/bin:$PATH
	export MPIFC=$DIR/MPICH/bin/mpifort
	export MPIF77=$DIR/MPICH/bin/mpifort
	export MPIF90=$DIR/MPICH/bin/mpifort
	export MPICC=$DIR/MPICH/bin/mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx

	echo " "
	############################# libpng ############################

	cd "${WRF_FOLDER}"/Downloads

	# other libraries below need these variables to be set
	export LDFLAGS=-L$DIR/grib2/lib
	export CPPFLAGS=-I$DIR/grib2/include

	LD_LIBRARY_PATH= tar -xvzf libpng-$Libpng_Version.tar.gz
	cd libpng-$Libpng_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNG_ROOT=$DIR/grib2

	echo " "
	#############################JasPer ############################
	cd "${WRF_FOLDER}"/Downloads
	unzip jasper-$Jasper_Version.zip
	cd jasper-$Jasper_Version/

	./configure --prefix=$DIR/grib2
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export JASPERLIB=$DIR/grib2/lib
	export JASPERINC=$DIR/grib2/include
	export JASPER_DIR=$DIR/grib2
	export Jasper_ROOT=$DIR/grib2/lib

	echo " "
	############################# hdf5 library for netcdf4 functionality ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf hdf5-$HDF5_Version.tar.gz
	cd hdf5-$HDF5_Version

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --with-zlib=$DIR/grib2 --enable-hl --enable-fortran --enable-parallel 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export HDF5=$DIR/grib2
	export PATH=$HDF5/bin:$PATH
	export PHDF5=$DIR/grib2
	export HDF5_ROOT=$DIR/grib2
	export PHDF5_ROOT=$DIR/grib2

	echo " "
	############################# Install Parallel-netCDF ##############################
	#Make file created with half of available cpu cores
	#Hard path for MPI added
	##################################################################################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf pnetcdf-$Pnetcdf_Version.tar.gz
	cd pnetcdf-$Pnetcdf_Version

	export MPIFC=$DIR/MPICH/bin/mpifort
	export MPIF77=$DIR/MPICH/bin/mpifort
	export MPIF90=$DIR/MPICH/bin/mpifort
	export MPICC=$DIR/MPICH/bin/mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --enable-static 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNETCDF=$DIR/grib2
	export PNETCDF_DIR=$DIR/grib2
	export PNETCDF_ROOT=$DIR/grib2

	echo " "

	############################## Install NETCDF C Library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_C_Version.tar.gz
	cd netcdf-c-$Netcdf_C_Version/
	export CPPFLAGS=-I$DIR/grib2/include
	export LDFLAGS="-L$DIR/grib2/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lhdf5_hl -lhdf5 -lz -lcurl -lgfortran -lgcc -lm -ldl -lpnetcdf"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --disable-dap --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-pnetcdf --enable-cdf5 --enable-parallel-tests --enable-logging 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/NETCDF/bin:$PATH
	export NETCDF=$DIR/NETCDF
	export NETCDF_INC=$DIR/NETCDF/include
	export NETCDF_LIB=$DIR/NETCDF/lib
	export NETCDF_ROOT=$DIR/NETCDF
	export LD_LIBRARY_PATH=$DIR/grib2/lib:$DIR/NETCDF/lib:$LD_LIBRARY_PATH

	echo " "
	############################## NetCDF fortran library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_Fortran_Version.tar.gz
	cd netcdf-fortran-$Netcdf_Fortran_Version/
	export LD_LIBRARY_PATH=$DIR/NETCDF/lib:$LD_LIBRARY_PATH
	export CPPFLAGS="-I$DIR/NETCDF/include -I$DIR/grib2/include"
	export LDFLAGS="-L$DIR/NETCDF/lib -L$DIR/grib2/lib -Wl,-rpath,$DIR/NETCDF/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lnetcdf -lpnetcdf -lcurl -lhdf5_hl -lhdf5 -lz -lm -ldl -lgcc -lgfortran"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-parallel-tests --enable-logging --enable-hdf5 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	echo " "
	#################################### System Environment Tests ##############

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_NETCDF_MPI_tests.tar
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_tests.tar

	LD_LIBRARY_PATH= tar -xvf Fortran_C_tests.tar -C "${WRF_FOLDER}"/Tests/Environment
	LD_LIBRARY_PATH= tar -xvf Fortran_C_NETCDF_MPI_tests.tar -C "${WRF_FOLDER}"/Tests/Compatibility

	export one="1"
	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Environment

	cp ${NETCDF}/include/netcdf.inc .

	echo " "
	echo " "
	echo "Environment Testing "
	echo "Test 1"
	$FC TEST_1_fortran_only_fixed.f
	./a.out | tee env_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 1 Passed"
	else
		echo "Environment Compiler Test 1 Failed"
		exit
	fi
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 2"
	$FC TEST_2_fortran_only_free.f90
	./a.out | tee env_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 2 Passed"
	else
		echo "Environment Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 3"
	$CC TEST_3_c_only.c
	./a.out | tee env_test3.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test3.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 3 Passed"
	else
		echo "Environment Compiler Test 3 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 4"
	$CC -c -m64 TEST_4_fortran+c_c.c
	$FC -c -m64 TEST_4_fortran+c_f.f90
	$FC -m64 TEST_4_fortran+c_f.o TEST_4_fortran+c_c.o
	./a.out | tee env_test4.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test4.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 4 Passed"
	else
		echo "Environment Compiler Test 4 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Compatibility

	cp ${NETCDF}/include/netcdf.inc .

	echo " "
	echo " "
	echo "Library Compatibility Tests "
	echo "Test 1"
	$FC -c 01_fortran+c+netcdf_f.f
	$CC -c 01_fortran+c+netcdf_c.c
	$FC 01_fortran+c+netcdf_f.o 01_fortran+c+netcdf_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	./a.out | tee comp_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 1 Passed"
	else
		echo "Compatibility Compiler Test 1 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "

	echo "Test 2"
	$MPIFC -c 02_fortran+c+netcdf+mpi_f.f
	$MPICC -c 02_fortran+c+netcdf+mpi_c.c
	$MPIFC 02_fortran+c+netcdf+mpi_f.o \
		02_fortran+c+netcdf+mpi_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	$DIR/MPICH/bin/mpirun ./a.out | tee comp_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 2 Passed"
	else
		echo "Compatibility Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."
	echo " "

	echo " All tests completed and passed"
	echo " "

	############################# WRF HYDRO V5.4.0 #################################
	# Version 5.3.0
	# Standalone mode
	# GNU
	################################################################################

	# Set up NETCDF environment variables
	export NETCDF_INC="$DIR/NETCDF/include"
	export NETCDF_LIB="$DIR/NETCDF/lib"

	# Create directories for Hydro Basecode and navigate to it
	mkdir -p "${WRF_FOLDER}/Hydro-Basecode"
	cd "${WRF_FOLDER}/Hydro-Basecode"

	# Clone the WRF-Hydro repository and set up the build
	git clone https://github.com/NCAR/wrf_hydro_nwm_public.git
	cd wrf_hydro_nwm_public
	mkdir -p build
	cd build

	# Run CMake configuration for WRF-Hydro with specified options
	cmake .. \
		-DSPATIAL_SOIL=1 \
		-DWRF_HYDRO=1 \
		-DWRFIO_NCD_LARGE_FILE_SUPPORT=1 \
		-DCMAKE_Fortran_COMPILER=gfortran

	# Compile using specified CPU settings
	make -j "$CPU_QUARTER_EVEN" 2>&1 | tee make.log

	# Check if the necessary executable files were created
	# Check if the necessary executable files were created
	cd "${WRF_FOLDER}/Hydro-Basecode/wrf_hydro_nwm_public/build/Run"

	# List of expected executable files
	expected_execs=("wrf_hydro.exe" "wrf_hydro_NoahMP")

	# Function to check for missing executables
	check_missing_execs() {
		missing=0
		for exe in "${expected_execs[@]}"; do
			if [[ ! -f "$exe" ]]; then
				echo "Missing: $exe"
				missing=1
			fi
		done
		return $missing
	}

	# Function to rerun compilation
	rebuild_and_check() {
		echo "Missing one or more expected files. Running compiler again..."
		cd "${WRF_FOLDER}/Hydro-Basecode/wrf_hydro_nwm_public/build"
		make -j "$CPU_QUARTER_EVEN" 2>&1 | tee make2.log
		cd "${WRF_FOLDER}/Hydro-Basecode/wrf_hydro_nwm_public/build/Run"
	}

	# Initial check
	check_missing_execs
	if (($? == 0)); then
		echo "All expected executable files are present."
	else
		rebuild_and_check
		check_missing_execs
		if (($? != 0)); then
			echo "Missing one or more expected files even after recompilation."
			read -r -p "Please contact script authors for assistance. Press 'Enter' to exit the script."
			exit 1
		else
			echo "All expected files created after re-compiling."
		fi
	fi
	# Finish the script with a pause
	read -r -t 5 -p "Finished installing WRF Hydro Basecode. Waiting for 5 seconds..."
	######################### Testing WRF HYDRO Compliation #########################
	cd "${WRF_FOLDER}"/

	#Download test case for WRF HYDRO and move to NWM
	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/NCAR/wrf_hydro_nwm_public/releases/download/v${HYDRO_CROTON_TEST_CASE}/croton_NY_training_example_v${HYDRO_CROTON_TEST_CASE_MINOR}.tar.gz
	LD_LIBRARY_PATH= tar -xvzf croton_NY_training_example_v${HYDRO_CROTON_TEST_CASE_MINOR}.tar.gz
	mv example_case "${WRF_FOLDER}"/Hydro-Basecode

	#Copy the *.TBL files to the example configuration directory:
	cp "${WRF_FOLDER}"/Hydro-Basecode/wrf_hydro_nwm_public/build/Run/*.TBL "${WRF_FOLDER}"/Hydro-Basecode/example_case/NWM

	#Copy the wrf_hydro file:
	cp "${WRF_FOLDER}"/Hydro-Basecode/wrf_hydro_nwm_public/build/Run/wrf_hydro "${WRF_FOLDER}"/Hydro-Basecode/example_case/NWM

	#From the example_case/Gridded directory, create a symlink:
	ln -s "${WRF_FOLDER}"/Hydro-Basecode/example_case/FORCING "${WRF_FOLDER}"/Hydro-Basecode/example_case/NWM

	#Move to Gridded Folder
	cd "${WRF_FOLDER}"/Hydro-Basecode/example_case/NWM

	#Run Wrf hydro
	mpirun -np $CPU_QUARTER_EVEN ./wrf_hydro

	echo "Checking HYDRO_RST files..."
	ls -lah HYDRO_RST.*_DOMAIN1 2>/dev/null || echo "No HYDRO_RST files found."

	all_good=true
	for file in HYDRO_RST.*_DOMAIN1; do
		if [ ! -s "$file" ]; then
			echo "File $file is empty or missing!"
			all_good=false
		fi
	done

	if [ "$all_good" = true ]; then
		echo "HYDRO_RST files exist and have data  wrf_hydro.exe successful."
	else
		echo "One or more HYDRO_RST files are missing or empty."
		echo "Please check your model run."
		exit 1
	fi

	echo " "

	#Installing Miniconda3 to WRF directory and updating libraries
	echo $PASSWD | sudo -S apt -y install python3-zstandard python3-zstd

	export Miniconda_Install_DIR="${WRF_FOLDER}"/miniconda3

	mkdir -p $Miniconda_Install_DIR

	wget -c https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O $Miniconda_Install_DIR/miniconda.sh

	bash $Miniconda_Install_DIR/miniconda.sh -b -u -p $Miniconda_Install_DIR

	rm -rf $Miniconda_Install_DIR/miniconda.sh

	export PATH="${WRF_FOLDER}"/miniconda3/bin:$PATH

	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	$Miniconda_Install_DIR/bin/conda init bash

	conda tos accept
	conda config --add channels conda-forge
	conda config --set auto_activate_base false
	conda update -n root --all -y

	##################### WRF Python           ##################
	########### WRf-Python compiled via Conda  ##################
	########### This is the preferred method by NCAR      ##################
	##### https://wrf-python.readthedocs.io/en/latest/installation.html  ##################
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh
	conda env create -f $HOME/WRF-MOSIT/wrf-python-stable.yml
	echo " "
	################ NEEDS TO BE IN Master folder #######################
	cp $HOME/WRF-MOSIT/SurfaceRunoff.py "${WRF_FOLDER}"/Hydro-Basecode/example_case/NWM

	cd "${WRF_FOLDER}"/Hydro-Basecode/example_case/NWM

	conda activate wrf-python
	python3 SurfaceRunoff.py
	conda deactivate
	conda deactivate
	conda deactivate

	if [ -f "SurfaceRunoff.pdf" ]; then
		echo "SurfaceRunoff.pdf exists."
	else
		echo "SurfaceRunoff.pdf is missing."
		exit 1 # Uncomment if you want to stop the script
	fi

	echo " "

	echo " "
	#####################################BASH Script Finished##############################
	echo "WRF HYDRO Standalone sucessfully configured and compiled"
	read -r -t 5 -p "Congratulations! You've successfully installed all required files to run the Weather Research Forecast Model HYDRO verison 5.2."

	##########################  Export PATH and LD_LIBRARY_PATH ################################
	cd $HOME
fi

if [ "$RHL_64bit_Intel" = "1"] && [ "$WRFHYDRO_STANDALONE_PICK" ]; then

	#############################basic package managment############################
	echo $PASSWD | sudo -S yum install epel-release -y
	echo $PASSWD | sudo -S yum install dnf -y
	echo $PASSWD | sudo -S dnf install epel-release -y
	echo $PASSWD | sudo -S dnf install dnf -y
	echo $PASSWD | sudo -S dnf -y update
	echo $PASSWD | sudo -S dnf -y upgrade
	echo $PASSWD | sudo -S dnf -y install bzip2 bzip2-devel byacc cairo-devel cmake cpp curl curl-devel flex fontconfig-devel gcc-c++ gcc-gfortran git java-11-openjdk java-11-openjdk-devel ksh libX11-devel libXaw-devel libXext-devel libXrender-devel libstdc++-devel libxml2 libxml2-devel m4 nfs-utils perl "perl(XML::LibXML)" pkgconfig pixman-devel python3 python3-devel tcsh time unzip wget
	echo $PASSWD | sudo -S dnf -y groupinstall "Development Tools"

	# download the key to system keyring; this and the following echo command are
	# needed in order to install the Intel compilers

	echo $PASSWD | sudo bash -c 'printf "[oneAPI]\nname=Intel oneAPI repository\nbaseurl=https://yum.repos.intel.com/oneapi\nenabled=1\ngpgcheck=1\nrepo_gpgcheck=1\ngpgkey=https://yum.repos.intel.com/intel-gpg-keys/GPG-PUB-KEY-INTEL-SW-PRODUCTS.PUB\n" > /etc/yum.repos.d/oneAPI.repo'

	echo $PASSWD | sudo -S mv /tmp/oneAPI.repo /etc/yum.repos.d

	echo $PASSWD | sudo -S dnf install intel-cpp-essentials -y

	# install the Intel compilers
	echo $PASSWD | sudo -S dnf upgrade intel-cpp-essentials -y
	echo $PASSWD | sudo -S dnf install intel-oneapi-base-toolkit -y
	echo $PASSWD | sudo -S dnf install intel-oneapi-hpc-toolkit -y
	echo $PASSWD | sudo -S dnf install intel-oneapi-python -y

	echo $PASSWD | sudo -S dnf update
	echo $PASSWD | sudo -S dnf -y install cmake pkgconfig
	echo $PASSWD | sudo -S dnf groupinstall "Development Tools" -y

	echo $PASSWD | sudo -S dnf -y update
	echo $PASSWD | sudo -S dnf -y upgrade

	# add the Intel compiler file paths to various environment variables
	source /opt/intel/oneapi/setvars.sh --force

	# some of the libraries we install below need one or more of these variables

	export CC=icx
	export CXX=icpx
	export FC=ifx
	export F77=ifx
	export F90=ifx
	export MPIFC=mpiifx
	export MPIF77=mpiifx
	export MPIF90=mpiifx
	export MPICC=mpiicx
	export MPICXX=mpiicpx
	export CFLAGS="-fPIC -fPIE -O3 -Wno-implicit-function-declaration -Wno-incompatible-function-pointer-types -Wno-unused-command-line-argument"
	export FFLAGS="-m64"
	export FCFLAGS="-m64"

	############################# CPU Core Management ####################################

	export CPU_CORE=$(nproc) # number of available threads on system
	export CPU_6CORE="6"
	export CPU_QUARTER=$(($CPU_CORE / 4)) # quarter of availble cores on system
	# Forces CPU cores to even number to avoid partial core export. ie 7 cores would be 3.5 cores.
	export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))

	# If statement for low core systems.  Forces computers to only use 1 core if there are 4 cores or less on the system.
	if [ $CPU_CORE -le $CPU_6CORE ]; then
		export CPU_QUARTER_EVEN="2"
	else
		export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))
	fi

	echo "##########################################"
	echo "Number of Threads being used $CPU_QUARTER_EVEN"
	echo "##########################################"

	############################## Directory Listing ############################
	# makes necessary directories
	#
	############################################################################

	export HOME=$(
		cd
		pwd
	)
	export WRF_FOLDER=$HOME/WRFHYDRO_STANDALONE_INTEL
	export DIR="${WRF_FOLDER}"/Libs
	mkdir "${WRF_FOLDER}"
	cd "${WRF_FOLDER}"
	mkdir Downloads

	mkdir Libs
	mkdir Libs/grib2
	mkdir Libs/NETCDF
	mkdir Libs/MPICH
	mkdir -p Tests/Environment
	mkdir -p Tests/Compatibility

	echo " "
	############################## Downloading Libraries ############################

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/madler/zlib/releases/download/v$Zlib_Version/zlib-$Zlib_Version.tar.gz
	wget -c https://github.com/HDFGroup/hdf5/releases/download/hdf5_$HDF5_Version/hdf5-$HDF5_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-c/archive/refs/tags/v$Netcdf_C_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-fortran/archive/refs/tags/v$Netcdf_Fortran_Version.tar.gz
	wget -c https://download.sourceforge.net/libpng/libpng-$Libpng_Version.tar.gz
	wget -c https://www.ece.uvic.ca/~frodo/jasper/software/jasper-$Jasper_Version.zip
	wget -c https://parallel-netcdf.github.io/Release/pnetcdf-$Pnetcdf_Version.tar.gz

	echo " "

	############################# ZLib ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf zlib-$Zlib_Version.tar.gz
	cd zlib-$Zlib_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	export ZLIB_ROOT=$DIR/grib2
	export ZLIBLIB=$DIR/grib2/lib
	export ZLIBINC=$DIR/grib2/include

	echo " "
	############################# LibPNG ############################

	cd "${WRF_FOLDER}"/Downloads

	# other libraries below need these variables to be set
	export LDFLAGS=-L$DIR/grib2/lib
	export CPPFLAGS=-I$DIR/grib2/include

	LD_LIBRARY_PATH= tar -xvzf libpng-$Libpng_Version.tar.gz
	cd libpng-$Libpng_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNG_ROOT=$DIR/grib2

	echo " "
	############################# JasPer ############################

	cd "${WRF_FOLDER}"/Downloads
	unzip jasper-$Jasper_Version.zip
	cd jasper-$Jasper_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	# other libraries below need these variables to be set
	export JASPERLIB=$DIR/grib2/lib
	export JASPERINC=$DIR/grib2/include
	export JASPER_DIR=$DIR/grib2
	export Jasper_ROOT=$DIR/grib2/lib

	echo " "
	############################# HDF5 library for NetCDF4 & parallel functionality ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf hdf5-$HDF5_Version.tar.gz
	cd hdf5-$HDF5_Version

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --with-zlib=$DIR/grib2 --enable-hl --enable-fortran --enable-parallel 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	# other libraries below need these variables to be set
	export HDF5=$DIR/grib2
	export PATH=$HDF5/bin:$PATH
	export PHDF5=$DIR/grib2
	export HDF5_ROOT=$DIR/grib2
	export PHDF5_ROOT=$DIR/grib2

	echo " "

	############################# Install Parallel-netCDF ##############################
	#Make file created with half of available cpu cores
	#Hard path for MPI added
	##################################################################################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf pnetcdf-$Pnetcdf_Version.tar.gz
	cd pnetcdf-$Pnetcdf_Version
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --enable-static 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	#make check

	export PNETCDF=$DIR/grib2
	export PNETCDF_DIR=$DIR/grib2
	export PNETCDF_ROOT=$DIR/grib2

	echo " "

	############################## Install NETCDF-C Library ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_C_Version.tar.gz
	cd netcdf-c-$Netcdf_C_Version/

	# these variables need to be set for the NetCDF-C install to work
	export CPPFLAGS=-I$DIR/grib2/include
	export LDFLAGS="-L$DIR/grib2/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lhdf5_hl -lhdf5 -lz -lcurl -lgcc -lm -ldl -lpnetcdf"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --disable-dap --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-pnetcdf --enable-cdf5 --enable-parallel-tests --enable-logging 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	# other libraries below need these variables to be set
	export PATH=$DIR/NETCDF/bin:$PATH
	export NETCDF=$DIR/NETCDF
	export NETCDF_INC=$DIR/NETCDF/include
	export NETCDF_LIB=$DIR/NETCDF/lib
	export NETCDF_ROOT=$DIR/NETCDF
	export LD_LIBRARY_PATH=$DIR/grib2/lib:$DIR/NETCDF/lib:$LD_LIBRARY_PATH

	echo " "
	############################## NetCDF-Fortran library ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_Fortran_Version.tar.gz
	cd netcdf-fortran-$Netcdf_Fortran_Version/

	# these variables need to be set for the NetCDF-Fortran install to work
	export LD_LIBRARY_PATH=$DIR/NETCDF/lib:$LD_LIBRARY_PATH
	export CPPFLAGS="-I$DIR/NETCDF/include -I$DIR/grib2/include"
	export LDFLAGS="-L$DIR/NETCDF/lib -L$DIR/grib2/lib -Wl,-rpath,$DIR/NETCDF/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lnetcdf -lpnetcdf -lcurl -lhdf5_hl -lhdf5 -lz -lm -ldl -lgcc"
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --enable-netcdf-4 --enable-netcdf4 --enable-parallel-tests --enable-logging --enable-hdf5 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	echo " "
	#################################### System Environment Tests ##############

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_NETCDF_MPI_tests.tar
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_tests.tar

	LD_LIBRARY_PATH= tar -xvf Fortran_C_tests.tar -C "${WRF_FOLDER}/Tests/Environment"
	LD_LIBRARY_PATH= tar -xvf Fortran_C_NETCDF_MPI_tests.tar -C "${WRF_FOLDER}"/Tests/Compatibility

	export one="1"
	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Environment

	echo " "
	echo " "
	echo "Environment Testing "
	echo "Test 1"
	$FC TEST_1_fortran_only_fixed.f
	./a.out | tee env_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 1 Passed"
	else
		echo "Environment Compiler Test 1 Failed"
		exit
	fi
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 2"
	$FC TEST_2_fortran_only_free.f90
	./a.out | tee env_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 2 Passed"
	else
		echo "Environment Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 3"
	$CC TEST_3_c_only.c
	./a.out | tee env_test3.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test3.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 3 Passed"
	else
		echo "Environment Compiler Test 3 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 4"
	$CC -c -m64 TEST_4_fortran+c_c.c
	$FC -c -m64 TEST_4_fortran+c_f.f90
	$FC -m64 TEST_4_fortran+c_f.o TEST_4_fortran+c_c.o
	./a.out | tee env_test4.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test4.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 4 Passed"
	else
		echo "Environment Compiler Test 4 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Compatibility

	cp ${NETCDF}/include/netcdf.inc .

	echo " "
	echo " "
	echo "Library Compatibility Tests "
	echo "Test 1"
	$FC -c 01_fortran+c+netcdf_f.f
	$CC -c 01_fortran+c+netcdf_c.c
	$FC 01_fortran+c+netcdf_f.o 01_fortran+c+netcdf_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	./a.out | tee comp_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 1 Passed"
	else
		echo "Compatibility Compiler Test 1 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "

	echo "Test 2"
	$MPIFC -c 02_fortran+c+netcdf+mpi_f.f
	$MPICC -c 02_fortran+c+netcdf+mpi_c.c
	$MPIFC 02_fortran+c+netcdf+mpi_f.o \
		02_fortran+c+netcdf+mpi_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	mpirun ./a.out | tee comp_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 2 Passed"
	else
		echo "Compatibility Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."
	echo " "

	echo " All tests completed and passed"
	echo " "

	############################# WRF HYDRO V5.4.0 #################################
	# Version 5.3.0
	# Standalone mode
	# GNU
	################################################################################

	# Source Intel oneAPI environment
	source /opt/intel/oneapi/setvars.sh --force

	# Set up NETCDF environment variables
	export NETCDF_INC="$DIR/NETCDF/include"
	export NETCDF_LIB="$DIR/NETCDF/lib"

	# Create directories for Hydro Basecode and navigate to it
	mkdir -p "${WRF_FOLDER}/Hydro-Basecode"
	cd "${WRF_FOLDER}/Hydro-Basecode"

	# Clone the WRF-Hydro repository and set up the build
	git clone https://github.com/NCAR/wrf_hydro_nwm_public.git
	cd wrf_hydro_nwm_public
	mkdir -p build
	cd build

	# Run CMake configuration for WRF-Hydro with specified options
	cmake .. \
		-DSPATIAL_SOIL=1 \
		-DWRF_HYDRO=1 \
		-DWRFIO_NCD_LARGE_FILE_SUPPORT=1 \
		-DCMAKE_Fortran_COMPILER=ifx

	# Compile using specified CPU settings
	make -j "$CPU_QUARTER_EVEN" 2>&1 | tee make.log

	# Check if the necessary executable files were created
	cd "${WRF_FOLDER}/Hydro-Basecode/wrf_hydro_nwm_public/build/Run"

	# List of expected executable files
	expected_execs=("wrf_hydro.exe" "wrf_hydro_NoahMP")

	# Function to check for missing executables
	check_missing_execs() {
		missing=0
		for exe in "${expected_execs[@]}"; do
			if [[ ! -f "$exe" ]]; then
				echo "Missing: $exe"
				missing=1
			fi
		done
		return $missing
	}

	# Function to rerun compilation
	rebuild_and_check() {
		echo "Missing one or more expected files. Running compiler again..."
		cd "${WRF_FOLDER}/Hydro-Basecode/wrf_hydro_nwm_public/build"
		make -j "$CPU_QUARTER_EVEN" 2>&1 | tee make2.log
		cd "${WRF_FOLDER}/Hydro-Basecode/wrf_hydro_nwm_public/build/Run"
	}

	# Initial check
	check_missing_execs
	if (($? == 0)); then
		echo "All expected executable files are present."
	else
		rebuild_and_check
		check_missing_execs
		if (($? != 0)); then
			echo "Missing one or more expected files even after recompilation."
			read -r -p "Please contact script authors for assistance. Press 'Enter' to exit the script."
			exit 1
		else
			echo "All expected files created after re-compiling."
		fi
	fi

	# Finish the script with a pause
	read -r -t 5 -p "Finished installing WRF Hydro Basecode. Waiting for 5 seconds..."
	######################### Testing WRF HYDRO Compliation #########################
	cd "${WRF_FOLDER}"/

	#Download test case for WRF HYDRO and move to NWM
	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/NCAR/wrf_hydro_nwm_public/releases/download/v${HYDRO_CROTON_TEST_CASE}/croton_NY_training_example_v${HYDRO_CROTON_TEST_CASE_MINOR}.tar.gz
	LD_LIBRARY_PATH= tar -xvzf croton_NY_training_example_v${HYDRO_CROTON_TEST_CASE_MINOR}.tar.gz
	mv example_case "${WRF_FOLDER}"/Hydro-Basecode

	#Copy the *.TBL files to the example configuration directory:
	cp "${WRF_FOLDER}"/Hydro-Basecode/wrf_hydro_nwm_public/build/Run/*.TBL "${WRF_FOLDER}"/Hydro-Basecode/example_case/NWM

	#Copy the wrf_hydro file:
	cp "${WRF_FOLDER}"/Hydro-Basecode/wrf_hydro_nwm_public/build/Run/wrf_hydro "${WRF_FOLDER}"/Hydro-Basecode/example_case/NWM

	#From the example_case/Gridded directory, create a symlink:
	ln -s "${WRF_FOLDER}"/Hydro-Basecode/example_case/FORCING "${WRF_FOLDER}"/Hydro-Basecode/example_case/NWM

	#Move to Gridded Folder
	cd "${WRF_FOLDER}"/Hydro-Basecode/example_case/NWM

	#Run Wrf hydro
	mpirun -np $CPU_QUARTER_EVEN ./wrf_hydro

	echo "Checking HYDRO_RST files..."
	ls -lah HYDRO_RST.*_DOMAIN1 2>/dev/null || echo "No HYDRO_RST files found."

	all_good=true
	for file in HYDRO_RST.*_DOMAIN1; do
		if [ ! -s "$file" ]; then
			echo "File $file is empty or missing!"
			all_good=false
		fi
	done

	if [ "$all_good" = true ]; then
		echo "HYDRO_RST files exist and have data  wrf_hydro.exe successful."
	else
		echo "One or more HYDRO_RST files are missing or empty."
		echo "Please check your model run."
		exit 1
	fi

	echo " "

	########################### Test script for output data  ###################################

	#Installing Miniconda3 to WRF directory and updating libraries
	echo $PASSWD | sudo -S apt -y install python3-zstandard python3-zstd

	export Miniconda_Install_DIR="${WRF_FOLDER}"/miniconda3

	mkdir -p $Miniconda_Install_DIR

	wget -c https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O $Miniconda_Install_DIR/miniconda.sh

	bash $Miniconda_Install_DIR/miniconda.sh -b -u -p $Miniconda_Install_DIR

	rm -rf $Miniconda_Install_DIR/miniconda.sh

	export PATH="${WRF_FOLDER}"/miniconda3/bin:$PATH

	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	$Miniconda_Install_DIR/bin/conda init bash

	conda tos accept
	conda config --add channels conda-forge
	conda config --set auto_activate_base false
	conda update -n root --all -y

	##################### WRF Python           ##################
	########### WRf-Python compiled via Conda  ##################
	########### This is the preferred method by NCAR      ##################
	##### https://wrf-python.readthedocs.io/en/latest/installation.html  ##################
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh
	conda env create -f $HOME/WRF-MOSIT/wrf-python-stable.yml
	echo " "

	################ NEEDS TO BE IN Master folder #######################
	cp $HOME/WRF-MOSIT/SurfaceRunoff.py "${WRF_FOLDER}"/Hydro-Basecode/example_case/NWM

	cd "${WRF_FOLDER}"/Hydro-Basecode/example_case/NWM

	conda activate wrf-python
	python3 SurfaceRunoff.py
	conda deactivate
	conda deactivate
	conda deactivate

	if [ -f "SurfaceRunoff.pdf" ]; then
		echo "SurfaceRunoff.pdf exists."
	else
		echo "SurfaceRunoff.pdf is missing."
		exit 1 # Uncomment if you want to stop the script
	fi

	echo " "
	#####################################BASH Script Finished##############################
	echo "WRF HYDRO Standalone sucessfully configured and compiled"
	read -r -t 5 -p "Congratulations! You've successfully installed all required files to run the Weather Research Forecast Model HYDRO verison 5.2."

fi

################################### WRF Hydro Coupled ##############
## WRFHYDRO Coupled installation with parallel process.
# Download and install required library and data files for WRFHYDRO Coupled.
# Tested in Ubuntu 22.04 & 24.04, Rocky Linux 9 & MacOS Ventura 64bit
# Built in 64-bit system
# Built with Intel or GNU compilers
# Tested with current available libraries on 03/01/2025
# If newer libraries exist edit script paths for changes
#Estimated Run Time ~ 90 - 150 Minutes with 10mb/s downloadspeed.
# Special thanks to:
# Youtube's meteoadriatic, GitHub user jamal919.
# University of Manchester's  Doug L
# University of Tunis El Manar's Hosni
# GSL's Jordan S.
# NCAR's Mary B., Christine W., & Carl D.
# DTC's Julie P., Tara J., George M., & John H.
# UCAR's Katelyn F., Jim B., Jordan P., Kevin M.,
##############################################################
# Need to finish #
if [ "$Ubuntu_64bit_GNU" = "1" ] && [ "$WRFHYDRO_COUPLED_PICK" = "1" ]; then

	############################basic package managment############################
	echo $PASSWD | sudo -S apt -y update
	echo $PASSWD | sudo -S apt -y upgrade

	release_version=$(lsb_release -r -s)

	# Compare the release version
	if [ "$release_version" = "24.04" ]; then
		# Install Emacs without recommended packages
		echo $PASSWD | sudo -S apt install emacs --no-install-recommends -y
	else
		# Attempt to install Emacs if the release version is not 24.04
		echo "The release version is not 24.04, attempting to install Emacs."
		echo $PASSWD | sudo -S apt install emacs -y
	fi

	echo $PASSWD | sudo -S apt -y install bison build-essential byacc cmake csh curl default-jdk default-jre flex libfl-dev g++ gawk gcc gettext gfortran git ksh libcurl4-gnutls-dev libjpeg-dev libncurses6 libpixman-1-dev libpng-dev libtool libxml2 libxml2-dev libxml-libxml-perl m4 make ncview pipenv pkg-config python3 python3-dev python3-pip python3-dateutil tcsh unzip xauth xorg time

	echo " "
	##############################Directory Listing############################
	export HOME=$(
		cd
		pwd
	)
	mkdir $HOME/WRFHYDRO_COUPLED
	export WRF_FOLDER=$HOME/WRFHYDRO_COUPLED
	export DIR="${WRF_FOLDER}"/Libs
	cd "${WRF_FOLDER}"/
	mkdir Downloads
	mkdir "${WRF_FOLDER}"/Hydro-Basecode
	mkdir Libs
	export DIR="${WRF_FOLDER}"/Libs
	mkdir# Libs/grib2
	mkdir Libs/NETCDF
	mkdir Libs/MPICH
	mkdir -p Tests/Environment
	mkdir -p Tests/Compatibility

	echo " "
	#############################Core Management####################################

	export CPU_CORE=$(nproc) # number of available threads on system
	export CPU_6CORE="6"
	export CPU_QUARTER=$(($CPU_CORE / 4))                          #quarter of availble cores on system
	export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2))) #Forces CPU cores to even number to avoid partial core export. ie 7 cores would be 3.5 cores.

	if [ $CPU_CORE -le $CPU_6CORE ]; then #If statement for low core systems.  Forces computers to only use 1 core if there are 4 cores or less on the system. then
		export CPU_QUARTER_EVEN="2"
	else
		export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))
	fi

	echo "##########################################"
	echo "Number of Threads being used $CPU_QUARTER_EVEN"
	echo "##########################################"

	echo " "
	##############################Downloading Libraries############################
	cd Downloads
	wget -c https://github.com/madler/zlib/releases/download/v$Zlib_Version/zlib-$Zlib_Version.tar.gz
	wget -c https://github.com/HDFGroup/hdf5/releases/download/hdf5_$HDF5_Version/hdf5-$HDF5_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-c/archive/refs/tags/v$Netcdf_C_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-fortran/archive/refs/tags/v$Netcdf_Fortran_Version.tar.gz
	wget -c https://download.sourceforge.net/libpng/libpng-$Libpng_Version.tar.gz
	wget -c https://www.ece.uvic.ca/~frodo/jasper/software/jasper-$Jasper_Version.zip
	wget -c https://github.com/pmodels/mpich/releases/download/v$Mpich_Version/mpich-$Mpich_Version.tar.gz
	wget -c https://parallel-netcdf.github.io/Release/pnetcdf-$Pnetcdf_Version.tar.gz

	echo " "
	#############################Compilers############################
	export CC=gcc
	export CXX=g++
	export FC=gfortran
	export F77=gfortran
	export CFLAGS="-fPIC -fPIE -O3"

	#IF statement for GNU compiler issue
	export GCC_VERSION=$(/usr/bin/gcc -dumpfullversion | awk '{print$1}')
	export GFORTRAN_VERSION=$(/usr/bin/gfortran -dumpfullversion | awk '{print$1}')
	export GPLUSPLUS_VERSION=$(/usr/bin/g++ -dumpfullversion | awk '{print$1}')

	export GCC_VERSION_MAJOR_VERSION=$(echo $GCC_VERSION | awk -F. '{print $1}')
	export GFORTRAN_VERSION_MAJOR_VERSION=$(echo $GFORTRAN_VERSION | awk -F. '{print $1}')
	export GPLUSPLUS_VERSION_MAJOR_VERSION=$(echo $GPLUSPLUS_VERSION | awk -F. '{print $1}')

	export version_10="10"

	if [ $GCC_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GFORTRAN_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GPLUSPLUS_VERSION_MAJOR_VERSION -ge $version_10 ]; then
		export fallow_argument=-fallow-argument-mismatch
		export boz_argument=-fallow-invalid-boz
	else
		export fallow_argument=
		export boz_argument=
	fi

	export FFLAGS="$fallow_argument -m64"
	export FCFLAGS="$fallow_argument -m64"

	echo "##########################################"
	echo "FFLAGS = $FFLAGS"
	echo "FCFLAGS = $FCFLAGS"
	echo "CFLAGS = $CFLAGS"
	echo "##########################################"

	echo " "
	############################# ZLib ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf zlib-$Zlib_Version.tar.gz
	cd zlib-$Zlib_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	export ZLIB_ROOT=$DIR/grib2
	export ZLIBLIB=$DIR/grib2/lib
	export ZLIBINC=$DIR/grib2/include

	echo " "
	############################## MPICH ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf mpich-$Mpich_Version.tar.gz
	cd mpich-$Mpich_Version/

	F90= ./configure --prefix=$DIR/MPICH --with-device=ch3 FFLAGS="$fallow_argument -m64" FCFLAGS="$fallow_argument -m64" 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/MPICH/bin:$PATH
	export MPIFC=$DIR/MPICH/bin/mpifort
	export MPIF77=$DIR/MPICH/bin/mpifort
	export MPIF90=$DIR/MPICH/bin/mpifort
	export MPICC=$DIR/MPICH/bin/mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx

	echo " "
	############################# libpng ############################

	cd "${WRF_FOLDER}"/Downloads

	# other libraries below need these variables to be set
	export LDFLAGS=-L$DIR/grib2/lib
	export CPPFLAGS=-I$DIR/grib2/include

	LD_LIBRARY_PATH= tar -xvzf libpng-$Libpng_Version.tar.gz
	cd libpng-$Libpng_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNG_ROOT=$DIR/grib2

	echo " "
	#############################JasPer ############################
	cd "${WRF_FOLDER}"/Downloads
	unzip jasper-$Jasper_Version.zip
	cd jasper-$Jasper_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export JASPERLIB=$DIR/grib2/lib
	export JASPERINC=$DIR/grib2/include
	export JASPER_DIR=$DIR/grib2
	export Jasper_ROOT=$DIR/grib2/lib

	echo " "
	############################# hdf5 library for netcdf4 functionality ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf hdf5-$HDF5_Version.tar.gz
	cd hdf5-$HDF5_Version

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --with-zlib=$DIR/grib2 --enable-hl --enable-fortran --enable-parallel 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export HDF5=$DIR/grib2
	export PATH=$HDF5/bin:$PATH
	export PHDF5=$DIR/grib2
	export HDF5_ROOT=$DIR/grib2
	export PHDF5_ROOT=$DIR/grib2

	############################# Install Parallel-netCDF ##############################
	#Make file created with half of available cpu cores
	#Hard path for MPI added
	##################################################################################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf pnetcdf-$Pnetcdf_Version.tar.gz
	cd pnetcdf-$Pnetcdf_Version

	export MPIFC=$DIR/MPICH/bin/mpifort
	export MPIF77=$DIR/MPICH/bin/mpifort
	export MPIF90=$DIR/MPICH/bin/mpifort
	export MPICC=$DIR/MPICH/bin/mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --enable-static 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNETCDF=$DIR/grib2
	export PNETCDF_DIR=$DIR/grib2
	export PNETCDF_ROOT=$DIR/grib2

	echo " "

	############################## Install NETCDF C Library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_C_Version.tar.gz
	cd netcdf-c-$Netcdf_C_Version/
	export CPPFLAGS=-I$DIR/grib2/include
	export LDFLAGS="-L$DIR/grib2/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lhdf5_hl -lhdf5 -lz -lcurl -lgfortran -lgcc -lm -ldl -lpnetcdf"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --disable-dap --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-pnetcdf --enable-cdf5 --enable-parallel-tests --enable-logging 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/NETCDF/bin:$PATH
	export NETCDF=$DIR/NETCDF
	export NETCDF_INC=$DIR/NETCDF/include
	export NETCDF_LIB=$DIR/NETCDF/lib
	export NETCDF_ROOT=$DIR/NETCDF
	export LD_LIBRARY_PATH=$DIR/grib2/lib:$DIR/NETCDF/lib:$LD_LIBRARY_PATH

	echo " "
	############################## NetCDF fortran library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_Fortran_Version.tar.gz
	cd netcdf-fortran-$Netcdf_Fortran_Version/
	export LD_LIBRARY_PATH=$DIR/NETCDF/lib:$LD_LIBRARY_PATH
	export CPPFLAGS="-I$DIR/NETCDF/include -I$DIR/grib2/include"
	export LDFLAGS="-L$DIR/NETCDF/lib -L$DIR/grib2/lib -Wl,-rpath,$DIR/NETCDF/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lnetcdf -lpnetcdf -lcurl -lhdf5_hl -lhdf5 -lz -lm -ldl -lgcc -lgfortran"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-parallel-tests --enable-logging --enable-hdf5 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	echo " "

	#################################### System Environment Tests ##############

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_NETCDF_MPI_tests.tar
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_tests.tar

	LD_LIBRARY_PATH= tar -xvf Fortran_C_tests.tar -C "${WRF_FOLDER}"/Tests/Environment
	LD_LIBRARY_PATH= tar -xvf Fortran_C_NETCDF_MPI_tests.tar -C "${WRF_FOLDER}"/Tests/Compatibility
	export one="1"
	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Environment

	cp ${NETCDF}/include/netcdf.inc .

	echo " "
	echo " "
	echo "Environment Testing "
	echo "Test 1"
	$FC TEST_1_fortran_only_fixed.f
	./a.out | tee env_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 1 Passed"
	else
		echo "Environment Compiler Test 1 Failed"
		exit
	fi
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 2"
	$FC TEST_2_fortran_only_free.f90
	./a.out | tee env_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 2 Passed"
	else
		echo "Environment Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 3"
	$CC TEST_3_c_only.c
	./a.out | tee env_test3.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test3.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 3 Passed"
	else
		echo "Environment Compiler Test 3 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 4"
	$CC -c -m64 TEST_4_fortran+c_c.c
	$FC -c -m64 TEST_4_fortran+c_f.f90
	$FC -m64 TEST_4_fortran+c_f.o TEST_4_fortran+c_c.o
	./a.out | tee env_test4.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test4.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 4 Passed"
	else
		echo "Environment Compiler Test 4 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Compatibility

	cp ${NETCDF}/include/netcdf.inc .

	echo " "
	echo " "
	echo "Library Compatibility Tests "
	echo "Test 1"
	$FC -c 01_fortran+c+netcdf_f.f
	$CC -c 01_fortran+c+netcdf_c.c
	$FC 01_fortran+c+netcdf_f.o 01_fortran+c+netcdf_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	./a.out | tee comp_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 1 Passed"
	else
		echo "Compatibility Compiler Test 1 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "

	echo "Test 2"
	$MPIFC -c 02_fortran+c+netcdf+mpi_f.f
	$MPICC -c 02_fortran+c+netcdf+mpi_c.c
	$MPIFC 02_fortran+c+netcdf+mpi_f.o \
		02_fortran+c+netcdf+mpi_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	$DIR/MPICH/bin/mpirun ./a.out | tee comp_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 2 Passed"
	else
		echo "Compatibility Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."
	echo " "

	echo " All tests completed and passed"
	echo " "

	################################OpenGrADS######################################
	#Verison 2.2.1 64bit of Linux
	#############################################################################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf cd "${WRF_FOLDER}"/Downloads
	wget -c https://sourceforge.net/projects/opengrads/files/grads2/2.2.1.oga.1/Linux%20%2864%20Bits%29/opengrads-2.2.1.oga.1-bundle-x86_64-pc-linux-gnu-glibc_2.17.tar.gz
	LD_LIBRARY_PATH= tar -xvzf opengrads-2.2.1.oga.1-bundle-x86_64-pc-linux-gnu-glibc_2.17.tar.gz -C "${WRF_FOLDER}"/ -C "${WRF_FOLDER}"/
	cd "${WRF_FOLDER}"/
	mv "${WRF_FOLDER}"/opengrads-2.2.1.oga.1 "${WRF_FOLDER}"/GrADS
	cd GrADS/Contents
	wget -c https://github.com/regisgrundig/SIMOP/blob/master/g2ctl.pl
	chmod +x g2ctl.pl
	wget -c https://sourceforge.net/projects/opengrads/files/wgrib2/0.1.9.4/wgrib2-v0.1.9.4-bin-x86_64-glibc2.5-linux-gnu.tar.gz
	LD_LIBRARY_PATH= tar -xvzf wgrib2-v0.1.9.4-bin-x86_64-glibc2.5-linux-gnu.tar.gz
	cd wgrib2-v0.1.9.4/bin
	mv wgrib2 "${WRF_FOLDER}"/GrADS/Contents
	cd "${WRF_FOLDER}"/GrADS/Contents
	rm wgrib2-v0.1.9.4-bin-x86_64-glibc2.5-linux-gnu.tar.gz
	rm -r wgrib2-v0.1.9.4

	export PATH="${WRF_FOLDER}"/GrADS/Contents:$PATH

	echo " "
	##################### NCAR COMMAND LANGUAGE           ##################
	########### NCL compiled via Conda                    ##################
	########### This is the preferred method by NCAR      ##################
	########### https://www.ncl.ucar.edu/index.shtml      ##################

	#Installing Miniconda3 to WRF-Hydro dire
	echo $PASSWD | sudo -S apt -y install python3-zstandard python3-zstd

	export Miniconda_Install_DIR="${WRF_FOLDER}"/miniconda3

	mkdir -p $Miniconda_Install_DIR

	wget -c https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O $Miniconda_Install_DIR/miniconda.sh
	bash $Miniconda_Install_DIR/miniconda.sh -b -u -p $Miniconda_Install_DIR

	rm -rf $Miniconda_Install_DIR/miniconda.sh

	export PATH="${WRF_FOLDER}"/miniconda3/bin:$PATH

	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	$Miniconda_Install_DIR/bin/conda init bash

	conda tos accept
	conda config --add channels conda-forge
	conda config --set auto_activate_base false
	conda update -n root --all -y

	echo " "

	echo " "
	#Installing NCL via Conda
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	conda create -n ncl_stable -c conda-forge ncl -y
	conda activate ncl_stable

	conda deactivate
	conda deactivate
	conda deactivate

	echo " "

	############################OBSGRID###############################
	## OBSGRID
	## Downloaded from git tagged releases
	## Option #2
	########################################################################
	cd "${WRF_FOLDER}"/
	git clone https://github.com/wrf-model/OBSGRID.git
	cd "${WRF_FOLDER}"/OBSGRID

	LD_LIBRARY_PATH= ./clean -a
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh
	conda activate ncl_stable

	export HOME=$(
		cd
		pwd
	)
	export DIR="${WRF_FOLDER}"/Libs
	export NETCDF=$DIR/NETCDF

	if [ ${auto_config} -eq 1 ]; then
		echo 2 | ./configure 2>&1 | tee configure.log #Option 2 for gfortran/gcc and distribunted memory
	else
		./configure 2>&1 | tee configure.log #Option 2 for gfortran/gcc and distribunted memory
	fi

	sed -i '27s/-lnetcdf -lnetcdff/ -lnetcdff -lnetcdf/g' configure.oa

	sed -i '31s/-lncarg -lncarg_gks -lncarg_c -lX11 -lm -lcairo/-lncarg -lncarg_gks -lncarg_c -lX11 -lm -lcairo -lfontconfig -lpixman-1 -lfreetype -lhdf5 -lhdf5_hl /g' configure.oa

	sed -i '39s/-frecord-marker=4/-frecord-marker=4 ${fallow_argument} /g' configure.oa

	sed -i '44s/=	/=	${fallow_argument} /g' configure.oa

	sed -i '45s/-C -P -traditional/-P -traditional/g' configure.oa

	echo " "

	LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.obsgrid.log

	conda deactivate
	conda deactivate
	conda deactivate
	# IF statement to check that all files were created.
	if [[ -x ./obsgrid.exe ]]; then
		echo "obsgrid.exe found."
		read -r -t 5 -p "Finished installing OBSGRID. I am going to wait for 5 seconds only ..."
	else
		echo "obsgrid.exe is missing. Attempting to compile again..."

		LD_LIBRARY_PATH= ./clean -a
		LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.obsgrid.retry.log

		if [[ -x ./obsgrid.exe ]]; then
			echo "obsgrid.exe successfully created after recompilation."
			read -r -t 5 -p "Finished retrying OBSGRID compile. I am going to wait for 5 seconds only ..."
		else
			echo "Still missing obsgrid.exe after recompile. Exiting the script."
			read -r -p "Please contact script authors for assistance. Press 'Enter' to exit."
			exit 1
		fi
	fi

	echo " "

	##################### WRF Python           ##################
	########### WRf-Python compiled via Conda  ##################
	########### This is the preferred method by NCAR      ##################
	##### https://wrf-python.readthedocs.io/en/latest/installation.html  ##################
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh
	conda env create -f $HOME/WRF-MOSIT/wrf-python-stable.yml

	######################### Climate Data Operators ############
	######################### CDO compiled via Conda ###########
	####################### This is the preferred method #######
	################### https://bairdlangenbrunner.github.io/python-for-climate-scientists/conda/setting-up-conda-environments.html #######################

	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	conda create --name cdo_stable -y
	conda activate cdo_stable
	conda install -c conda-forge cdo -y
	conda update --all -y
	conda deactivate
	conda deactivate
	conda deactivate

	echo " "

	########################## WRF Hydro GIS PreProcessor ##############################
	#  Compiled with Conda
	#  https://github.com/NCAR/wrf_hydro_gis_preprocessor
	####################################################################################

	conda init bash
	conda activate base
	conda config --add channels conda-forge
	conda create -n wrfh_gis_env -c conda-forge python=3.12 gdal netCDF4 numpy pyproj whitebox=2.2.0 packaging shapely -y
	conda activate wrfh_gis_env
	conda update -n wrfh_gis_env --all -y
	conda deactivate
	conda deactivate
	conda deactivate
	cd "${WRF_FOLDER}"/
	git clone https://github.com/NCAR/wrf_hydro_gis_preprocessor.git "${WRF_FOLDER}"/WRF-Hydro-GIS-PreProcessor

	echo " "
	############################# WRF HYDRO V5.4.0 #################################
	# Version 5.3.0
	# Standalone mode
	################################################################################
	# Set up NETCDF environment variables
	export NETCDF_INC="$DIR/NETCDF/include"
	export NETCDF_LIB="$DIR/NETCDF/lib"

	# Create directories for Hydro Basecode and navigate to it
	mkdir -p "${WRF_FOLDER}/Hydro-Basecode"
	cd "${WRF_FOLDER}/Hydro-Basecode"

	# Clone the WRF-Hydro repository and set up the build
	git clone https://github.com/NCAR/wrf_hydro_nwm_public.git
	cd wrf_hydro_nwm_public
	mkdir -p build
	cd build

	# Run CMake configuration for WRF-Hydro with specified options
	cmake .. \
		-DSPATIAL_SOIL=1 \
		-DWRF_HYDRO=1 \
		-DWRFIO_NCD_LARGE_FILE_SUPPORT=1 \
		-DCMAKE_Fortran_COMPILER=gfortran

	# Compile using specified CPU settings
	make -j "$CPU_QUARTER_EVEN" 2>&1 | tee make.log

	# List of expected files (binary + symlinks)
	expected_files=("wrf_hydro" "wrf_hydro.exe" "wrf_hydro_NoahMP")

	# Count how many of them exist
	n=0
	for f in "${expected_files[@]}"; do
		[[ -e $f ]] && ((n++))
	done

	# Function to rerun compilation if files are missing
	rebuild_and_check() {
		echo "Missing one or more expected files. Running compiler again..."
		cd "${WRF_FOLDER}/Hydro-Basecode/wrf_hydro_nwm_public/build"
		make -j "$CPU_QUARTER_EVEN" 2>&1 | tee make2.log
		cd "${WRF_FOLDER}/Hydro-Basecode/wrf_hydro_nwm_public/build/Run"

		n=0
		for f in "${expected_files[@]}"; do
			[[ -e $f ]] && ((n++))
		done
	}

	# IF statement to check that all expected files were created
	if ((n == ${#expected_files[@]})); then
		echo "All expected files created."
	else
		rebuild_and_check
		if ((n != ${#expected_files[@]})); then
			echo "Missing one or more expected files. Exiting the script."
			read -r -p "Please contact script authors for assistance. Press 'Enter' to exit the script."
			exit 1
		else
			echo "All expected files created after re-compiling."
		fi
	fi

	# Finish the script with a pause
	read -r -t 5 -p "Finished installing WRF Hydro Basecode. Waiting for 5 seconds..."
	############################ WRF #################################
	## WRF v${WPS_VERSION}
	## Downloaded from git tagged releases
	# option 34, option 1 for gfortran and distributed memory w/basic nesting
	# large file support enable with WRFiO_NCD_LARGE_FILE_SUPPORT=1
	# In the namelist.input, the following settings support pNetCDF by setting value to 11:
	# io_form_boundary
	# io_form_history
	# io_form_auxinput2
	# io_form_auxhist2
	# Note that you need set nocolons = .true. in the section &time_control of namelist.input
	########################################################################
	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/wrf-model/WRF/releases/download/v${WRF_VERSION}/v${WRF_VERSION}.tar.gz -O WRF-${WRF_VERSION}.tar.gz
	LD_LIBRARY_PATH= tar -xvzf WRF-${WRF_VERSION}.tar.gz -C "${WRF_FOLDER}"/

	# If statment for changing folder name
	# Check if WRF directory exists
	if [ -d "${WRF_FOLDER}/WRF" ]; then
		mv -f "${WRF_FOLDER}/WRF" "${WRF_FOLDER}/WRF-${WRF_VERSION}"

	# Else, check for any folder matching WRFV*
	else
		for dir in "${WRF_FOLDER}"/WRFV*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WRF-${WRF_VERSION}"
				break
			fi
		done
	fi

	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}
	export WRFIO_NCD_LARGE_FILE_SUPPORT=1

	#Replace old version of WRF-Hydro distributed with WRF with updated WRF-Hydro source code
	rm -r "${WRF_FOLDER}"/WRF-${WRF_VERSION}/hydro/
	cp -r "${WRF_FOLDER}"/Hydro-Basecode/wrf_hydro_nwm_public/src "${WRF_FOLDER}"/WRF-${WRF_VERSION}/hydro

	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/hydro/template

	sed -i '12s|=0|=1|g' setEnvar.sh
	sed -i '$ a\# Large file support\nexport WRFIO_NCD_LARGE_FILE_SUPPORT=1' setEnvar.sh

	source setEnvar.sh
	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}

	LD_LIBRARY_PATH= ./clean -a

	if [ ${auto_config} -eq 1 ]; then
		(
			echo 34
			echo 1
		) | ./configure

	else
		./configure 2>&1 | tee configure.log #Option 34 gfortran compiler with distributed memory option 1 for basic nesting
	fi

	LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN em_real 2>&1 | tee compile.wrf1.log

	export WRF_DIR="${WRF_FOLDER}"/WRF-${WRF_VERSION}

	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/main
	n=$(ls ./*.exe | wc -l)
	if (($n >= 3)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}
		LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN em_real 2>&1 | tee compile.wrf2.log
		cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/main
		n=$(ls ./*.exe | wc -l)
		if (($n >= 3)); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	echo " "

	echo " "
	############################WPS#####################################
	## WPS v${WPS_VERSION}
	## Downloaded from git tagged releases
	#Option 3 for gfortran and distributed memory
	########################################################################

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/wrf-model/WPS/archive/refs/tags/v${WPS_VERSION}.tar.gz -O WPS-${WPS_VERSION}.tar.gz
	LD_LIBRARY_PATH= tar -xvzf WPS-${WPS_VERSION}.tar.gz -C "${WRF_FOLDER}"/
	# Check if WPS directory exists
	if [ -d "${WRF_FOLDER}/WPS" ]; then
		mv -f "${WRF_FOLDER}/WPS" "${WRF_FOLDER}/WPS-${WPS_VERSION}"

	# Else, check for any folder matching WPSV* or WPS-*
	else
		for dir in "${WRF_FOLDER}"/WPSV* "${WRF_FOLDER}"/WPS-*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WPS-${WPS_VERSION}"
				break
			fi
		done
	fi
	cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
	LD_LIBRARY_PATH= ./clean -a

	if [ ${auto_config} -eq 1 ]; then
		echo 3 | ./configure 2>&1 | tee configure.log #Option 3 for gfortran and distributed memory
	else
		./configure 2>&1 | tee configure.log #Option 3 gfortran compiler with distributed memory
	fi
	LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.wps.log

	echo " "
	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
	n=$(ls ./*.exe | wc -l)
	if (($n == 3)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WPS. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.wps2.log
		cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
		n=$(ls ./*.exe | wc -l)
		if (($n == 3)); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WPS. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	echo " "

	echo " "
	######################## Static Geography Data inc/ Optional ####################
	# http://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html
	# These files are large so if you only need certain ones comment the others off
	# All files downloaded and untarred is 200GB
	# https://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html
	#################################################################################
	cd "${WRF_FOLDER}"/Downloads
	mkdir "${WRF_FOLDER}"/GEOG
	mkdir "${WRF_FOLDER}"/GEOG/WPS_GEOG

	echo " "
	echo "Mandatory WRF Preprocessing System (WPS) Geographical Input Data Mandatory Fields Downloads"
	echo " "
	wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_high_res_mandatory.tar.gz
	LD_LIBRARY_PATH= tar -xvzf geog_high_res_mandatory.tar.gz -C "${WRF_FOLDER}"/GEOG/

	wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_low_res_mandatory.tar.gz
	LD_LIBRARY_PATH= tar -xvzf geog_low_res_mandatory.tar.gz -C "${WRF_FOLDER}"/GEOG/
	mv "${WRF_FOLDER}"/GEOG/WPS_GEOG_LOW_RES/ "${WRF_FOLDER}"/GEOG/WPS_GEOG

	if [ ${WPS_Specific_Applications} -eq 1 ]; then
		echo " "
		echo " WPS Geographical Input Data Mandatory for Specific Applications"
		echo " "
		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_thompson28_chem.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_thompson28_chem.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_noahmp.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_noahmp.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/irrigation.tar.gz
		LD_LIBRARY_PATH= tar -xvzf irrigation.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_px.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_px.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_urban.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_urban.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_ssib.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_ssib.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/lake_depth.tar.bz2
		LD_LIBRARY_PATH= tar -xvf lake_depth.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/topobath_30s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf topobath_30s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/gsl_gwd.tar.bz2
		LD_LIBRARY_PATH= tar -xvf gsl_gwd.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/cglc_modis_lcz_global.tar.gz
		LD_LIBRARY_PATH= tar -xvf cglc_modis_lcz_global.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG
	fi

	if [ ${Optional_GEOG} -eq 1 ]; then
		echo " "
		echo "Optional WPS Geographical Input Data"
		echo " "

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_older_than_2000.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_older_than_2000.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/modis_landuse_20class_15s_with_lakes.tar.gz
		LD_LIBRARY_PATH= tar -xvzf modis_landuse_20class_15s_with_lakes.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_alt_lsm.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_alt_lsm.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/nlcd2006_ll_9s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf nlcd2006_ll_9s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/updated_Iceland_LU.tar.gz
		LD_LIBRARY_PATH= tar -xvf updated_Iceland_LU.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/modis_landuse_20class_15s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf modis_landuse_20class_15s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

	fi

fi

if [ "$Ubuntu_64bit_Intel" = "1" ] && [ "$WRFHYDRO_COUPLED_PICK" = "1" ]; then

	############################# Basic package managment ############################

	echo $PASSWD | sudo -S apt -y update
	echo $PASSWD | sudo -S apt -y upgrade

	# download the key to system keyring; this and the following echo command are
	# needed in order to install the Intel compilers
	wget -O- https://apt.repos.intel.com/intel-gpg-keys/GPG-PUB-KEY-INTEL-SW-PRODUCTS.PUB |
		gpg --dearmor | sudo tee /usr/share/keyrings/oneapi-archive-keyring.gpg >/dev/null

	# add signed entry to apt sources and configure the APT client to use Intel repository:
	echo "deb [signed-by=/usr/share/keyrings/oneapi-archive-keyring.gpg] https://apt.repos.intel.com/oneapi all main" | sudo tee /etc/apt/sources.list.d/oneAPI.list

	# this update should get the Intel package info from the Intel repository
	echo $PASSWD | sudo -S apt -y update

	release_version=$(lsb_release -r -s)

	# Compare the release version
	if [ "$release_version" = "24.04" ]; then
		# Install Emacs without recommended packages
		echo $PASSWD | sudo -S apt install emacs --no-install-recommends -y
	else
		# Attempt to install Emacs if the release version is not 24.04
		echo "The release version is not 24.04, attempting to install Emacs."
		echo $PASSWD | sudo -S apt install emacs -y
	fi

	echo $PASSWD | sudo -S apt -y install bison build-essential byacc cmake csh curl default-jdk default-jre flex libfl-dev g++ gawk gcc gettext gfortran git ksh libcurl4-gnutls-dev libjpeg-dev libncurses6 libpixman-1-dev libpng-dev libtool libxml2 libxml2-dev libxml-libxml-perl m4 make ncview pipenv pkg-config python3 python3-dev python3-pip python3-dateutil tcsh unzip xauth xorg time

	# install the Intel compilers
	echo $PASSWD | sudo -S apt -y install intel-basekit
	echo $PASSWD | sudo -S apt -y install intel-hpckit
	echo $PASSWD | sudo -S apt -y install intel-oneapi-python
	/opt/intel/oneapi/intelpython/python3.12/bin/python3 -m pip install python-dateutil

	echo $PASSWD | sudo -S apt -y update

	#Fix any broken installations
	echo $PASSWD | sudo -S apt --fix-broken install

	# make sure some critical packages have been installed
	which cmake pkg-config make gcc g++ gfortran

	# add the Intel compiler file paths to various environment variables
	source /opt/intel/oneapi/setvars.sh --force

	# some of the libraries we install below need one or more of these variables
	export CC=icx
	export CXX=icpx
	export FC=ifx
	export F77=ifx
	export F90=ifx
	export MPIFC=mpiifx
	export MPIF77=mpiifx
	export MPIF90=mpiifx
	export MPICC=mpiicx
	export MPICXX=mpiicpx
	export CFLAGS="-fPIC -fPIE -O3 -Wno-implicit-function-declaration -Wno-incompatible-function-pointer-types -Wno-unused-command-line-argument"
	export FFLAGS="-m64"
	export FCFLAGS="-m64"
	############################# CPU Core Management ####################################

	export CPU_CORE=$(nproc) # number of available threads on system
	export CPU_6CORE="6"
	export CPU_QUARTER=$(($CPU_CORE / 4)) # quarter of availble cores on system
	# Forces CPU cores to even number to avoid partial core export. ie 7 cores would be 3.5 cores.
	export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))

	# If statement for low core systems.  Forces computers to only use 1 core if there are 4 cores or less on the system.
	if [ $CPU_CORE -le $CPU_6CORE ]; then
		export CPU_QUARTER_EVEN="2"
	else
		export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))
	fi

	echo "##########################################"
	echo "Number of Threads being used $CPU_QUARTER_EVEN"
	echo "##########################################"

	############################## Directory Listing ############################
	# makes necessary directories
	#
	############################################################################

	export HOME=$(
		cd
		pwd
	)
	export WRF_FOLDER=$HOME/WRFHYDRO_COUPLED_Intel
	export DIR="${WRF_FOLDER}"/Libs
	mkdir "${WRF_FOLDER}"
	cd "${WRF_FOLDER}"
	mkdir Downloads
	mkdir Libs
	mkdir Libs/grib2
	mkdir Libs/NETCDF
	mkdir Libs/MPICH

	mkdir -p Tests/Environment
	mkdir -p Tests/Compatibility

	echo " "
	############################## Downloading Libraries ############################

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/madler/zlib/releases/download/v$Zlib_Version/zlib-$Zlib_Version.tar.gz
	wget -c https://github.com/HDFGroup/hdf5/releases/download/hdf5_$HDF5_Version/hdf5-$HDF5_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-c/archive/refs/tags/v$Netcdf_C_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-fortran/archive/refs/tags/v$Netcdf_Fortran_Version.tar.gz
	wget -c https://download.sourceforge.net/libpng/libpng-$Libpng_Version.tar.gz
	wget -c https://www.ece.uvic.ca/~frodo/jasper/software/jasper-$Jasper_Version.zip
	wget -c https://parallel-netcdf.github.io/Release/pnetcdf-$Pnetcdf_Version.tar.gz

	echo " "
	############################# ZLib ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf zlib-$Zlib_Version.tar.gz
	cd zlib-$Zlib_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	export ZLIB_ROOT=$DIR/grib2
	export ZLIBLIB=$DIR/grib2/lib
	export ZLIBINC=$DIR/grib2/include

	echo " "
	############################# LibPNG ############################

	cd "${WRF_FOLDER}"/Downloads

	# other libraries below need these variables to be set
	export LDFLAGS=-L$DIR/grib2/lib
	export CPPFLAGS=-I$DIR/grib2/include

	LD_LIBRARY_PATH= tar -xvzf libpng-$Libpng_Version.tar.gz
	cd libpng-$Libpng_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNG_ROOT=$DIR/grib2

	echo " "
	############################# JasPer ############################

	cd "${WRF_FOLDER}"/Downloads
	unzip jasper-$Jasper_Version.zip
	cd jasper-$Jasper_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	# other libraries below need these variables to be set
	export JASPERLIB=$DIR/grib2/lib
	export JASPERINC=$DIR/grib2/include
	export JASPER_DIR=$DIR/grib2
	export Jasper_ROOT=$DIR/grib2/lib

	echo " "
	############################# HDF5 library for NetCDF4 & parallel functionality ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf hdf5-$HDF5_Version.tar.gz
	cd hdf5-$HDF5_Version

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --with-zlib=$DIR/grib2 --enable-hl --enable-fortran --enable-parallel 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	# other libraries below need these variables to be set
	export HDF5=$DIR/grib2
	export PATH=$HDF5/bin:$PATH
	export PHDF5=$DIR/grib2
	export HDF5_ROOT=$DIR/grib2
	export PHDF5_ROOT=$DIR/grib2

	echo " "

	############################# Install Parallel-netCDF ##############################
	#Make file created with half of available cpu cores
	#Hard path for MPI added
	##################################################################################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf pnetcdf-$Pnetcdf_Version.tar.gz
	cd pnetcdf-$Pnetcdf_Version
	export CC=icx
	export CXX=icpx
	export FC=ifx
	export F77=ifx
	export F90=ifx
	export MPIFC=mpiifx
	export MPIF77=mpiifx
	export MPIF90=mpiifx
	export MPICC=mpiicx
	export MPICXX=mpiicpx
	export CFLAGS="-fPIC -fPIE -O3 -Wno-implicit-function-declaration -Wno-incompatible-function-pointer-types -Wno-unused-command-line-argument"
	export FFLAGS="-m64"
	export FCFLAGS="-m64"
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --enable-static 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNETCDF=$DIR/grib2
	export PNETCDF_DIR=$DIR/grib2
	export PNETCDF_ROOT=$DIR/grib2

	echo " "

	############################## Install NETCDF-C Library ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_C_Version.tar.gz
	cd netcdf-c-$Netcdf_C_Version/

	# these variables need to be set for the NetCDF-C install to work
	export CPPFLAGS=-I$DIR/grib2/include
	export LDFLAGS="-L$DIR/grib2/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lhdf5_hl -lhdf5 -lz -lcurl -lm -ldl"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --disable-dap --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-pnetcdf --enable-cdf5 --enable-parallel-tests --enable-logging 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	# other libraries below need these variables to be set
	export PATH=$DIR/NETCDF/bin:$PATH
	export NETCDF=$DIR/NETCDF
	export NETCDF_INC=$DIR/NETCDF/include
	export NETCDF_LIB=$DIR/NETCDF/lib
	export NETCDF_ROOT=$DIR/NETCDF
	export LD_LIBRARY_PATH=$DIR/grib2/lib:$DIR/NETCDF/lib:$LD_LIBRARY_PATH

	echo " "
	############################## NetCDF-Fortran library ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_Fortran_Version.tar.gz
	cd netcdf-fortran-$Netcdf_Fortran_Version/

	# these variables need to be set for the NetCDF-Fortran install to work
	export LD_LIBRARY_PATH=$DIR/NETCDF/lib:$LD_LIBRARY_PATH
	export CPPFLAGS="-I$DIR/NETCDF/include -I$DIR/grib2/include"
	export LDFLAGS="-L$DIR/NETCDF/lib -L$DIR/grib2/lib -Wl,-rpath,$DIR/NETCDF/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lnetcdf -lpnetcdf -lcurl -lm -lcurl -lhdf5_hl -lhdf5 -lz -ldl"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --enable-netcdf-4 --enable-netcdf4 --enable-parallel-tests --enable-logging --enable-hdf5 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	echo " "
	#################################### System Environment Tests ##############

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_NETCDF_MPI_tests.tar
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_tests.tar

	LD_LIBRARY_PATH= tar -xvf Fortran_C_tests.tar -C "${WRF_FOLDER}"/Tests/Environment
	LD_LIBRARY_PATH= tar -xvf Fortran_C_NETCDF_MPI_tests.tar -C "${WRF_FOLDER}"/Tests/Compatibility

	export one="1"
	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Environment

	echo " "
	echo " "
	echo "Environment Testing "
	echo "Test 1"
	$FC TEST_1_fortran_only_fixed.f
	./a.out | tee env_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 1 Passed"
	else
		echo "Environment Compiler Test 1 Failed"
		exit
	fi
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 2"
	$FC TEST_2_fortran_only_free.f90
	./a.out | tee env_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 2 Passed"
	else
		echo "Environment Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 3"
	$CC TEST_3_c_only.c
	./a.out | tee env_test3.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test3.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 3 Passed"
	else
		echo "Environment Compiler Test 3 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 4"
	$CC -c -m64 TEST_4_fortran+c_c.c
	$FC -c -m64 TEST_4_fortran+c_f.f90
	$FC -m64 TEST_4_fortran+c_f.o TEST_4_fortran+c_c.o
	./a.out | tee env_test4.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test4.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 4 Passed"
	else
		echo "Environment Compiler Test 4 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Compatibility

	cp ${NETCDF}/include/netcdf.inc .

	echo " "
	echo " "
	echo "Library Compatibility Tests "
	echo "Test 1"
	$FC -c 01_fortran+c+netcdf_f.f
	$CC -c 01_fortran+c+netcdf_c.c
	$FC 01_fortran+c+netcdf_f.o 01_fortran+c+netcdf_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	./a.out | tee comp_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 1 Passed"
	else
		echo "Compatibility Compiler Test 1 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "

	echo "Test 2"
	$MPIFC -c 02_fortran+c+netcdf+mpi_f.f
	$MPICC -c 02_fortran+c+netcdf+mpi_c.c
	$MPIFC 02_fortran+c+netcdf+mpi_f.o \
		02_fortran+c+netcdf+mpi_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	mpirun ./a.out | tee comp_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 2 Passed"
	else
		echo "Compatibility Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."
	echo " "

	echo " All tests completed and passed"
	echo " "

	################################OpenGrADS######################################
	#Verison 2.2.1 64bit of Linux
	#############################################################################
	if [[ $GRADS_PICK -eq 1 ]]; then

		cd "${WRF_FOLDER}"/Downloads
		LD_LIBRARY_PATH= tar -xvzf cd "${WRF_FOLDER}"/Downloads
		wget -c https://sourceforge.net/projects/opengrads/files/grads2/2.2.1.oga.1/Linux%20%2864%20Bits%29/opengrads-2.2.1.oga.1-bundle-x86_64-pc-linux-gnu-glibc_2.17.tar.gz
		LD_LIBRARY_PATH= tar -xvzf opengrads-2.2.1.oga.1-bundle-x86_64-pc-linux-gnu-glibc_2.17.tar.gz -C "${WRF_FOLDER}"/ -C "${WRF_FOLDER}"/
		cd "${WRF_FOLDER}"/
		mv "${WRF_FOLDER}"/opengrads-2.2.1.oga.1 "${WRF_FOLDER}"/GrADS
		cd GrADS/Contents
		wget -c https://github.com/regisgrundig/SIMOP/blob/master/g2ctl.pl
		chmod +x g2ctl.pl
		wget -c https://sourceforge.net/projects/opengrads/files/wgrib2/0.1.9.4/wgrib2-v0.1.9.4-bin-x86_64-glibc2.5-linux-gnu.tar.gz
		LD_LIBRARY_PATH= tar -xvzf wgrib2-v0.1.9.4-bin-x86_64-glibc2.5-linux-gnu.tar.gz
		cd wgrib2-v0.1.9.4/bin
		mv wgrib2 "${WRF_FOLDER}"/GrADS/Contents
		cd "${WRF_FOLDER}"/GrADS/Contents
		rm wgrib2-v0.1.9.4-bin-x86_64-glibc2.5-linux-gnu.tar.gz
		rm -r wgrib2-v0.1.9.4

		export PATH="${WRF_FOLDER}"/GrADS/Contents:$PATH

	fi

	################################## GrADS ###############################
	# Version  2.2.1
	# Sublibs library instructions: http://cola.gmu.edu/grads/gadoc/supplibs2.html
	# GrADS instructions: http://cola.gmu.edu/grads/downloads.php
	########################################################################
	if [[ $GRADS_PICK -eq 2 ]]; then

		echo $PASSWD | sudo -S apt -y install grads

	fi

	##################### NCAR COMMAND LANGUAGE           ##################
	########### NCL compiled via Conda                    ##################
	########### This is the preferred method by NCAR      ##################
	########### https://www.ncl.ucar.edu/index.shtml      ##################
	echo " "
	#Installing Miniconda3 to WRF directory and updating libraries
	echo $PASSWD | sudo -S apt -y install python3-zstandard python3-zstd

	export Miniconda_Install_DIR="${WRF_FOLDER}"/miniconda3

	mkdir -p $Miniconda_Install_DIR

	wget -c https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O $Miniconda_Install_DIR/miniconda.sh
	bash $Miniconda_Install_DIR/miniconda.sh -b -u -p $Miniconda_Install_DIR

	rm -rf $Miniconda_Install_DIR/miniconda.sh

	export PATH="${WRF_FOLDER}"/miniconda3/bin:$PATH

	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	$Miniconda_Install_DIR/bin/conda init bash

	conda tos accept
	conda config --add channels conda-forge
	conda config --set auto_activate_base false
	conda update -n root --all -y

	#Special Thanks to @_WaylonWalker for code development

	echo " "
	#Installing NCL via Conda
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	conda create -n ncl_stable -c conda-forge ncl -y
	conda activate ncl_stable

	conda deactivate
	conda deactivate
	conda deactivate
	echo " "

	############################OBSGRID###############################
	## OBSGRID
	## Downloaded from git tagged releases
	## Option #3
	########################################################################
	cd "${WRF_FOLDER}"/
	git clone https://github.com/wrf-model/OBSGRID.git
	cd "${WRF_FOLDER}"/OBSGRID

	LD_LIBRARY_PATH= ./clean -a
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh
	conda activate ncl_stable

	export HOME=$(
		cd
		pwd
	)
	export DIR="${WRF_FOLDER}"/Libs
	export NETCDF=$DIR/NETCDF

	if [ ${auto_config} -eq 1 ]; then
		echo 3 | ./configure 2>&1 | tee configure.log #Option 3 for itnel and distribunted memory
	else
		./configure 2>&1 | tee configure.log #Option 3 for intel and distribunted memory
	fi

	sed -i '27s/-lnetcdf -lnetcdff/ -lnetcdff -lnetcdf/g' configure.oa

	sed -i '31s/-lncarg -lncarg_gks -lncarg_c -lX11 -lm -lcairo/-lncarg -lncarg_gks -lncarg_c -lX11 -lm -lcairo -lfontconfig -lpixman-1 -lfreetype -lhdf5 -lhdf5_hl /g' configure.oa

	sed -i '38s/ifort/ifx/g' configure.oa
	sed -i '43s/gcc/icx/g' configure.oa
	sed -i '45s|/lib/cpp|ifx|g' configure.oa
	sed -i '46s|-I. -C -P -DDEC -traditional|-fpp -DDEC -I.|g' configure.oa

	# Patch .F90.o rule to use direct compile with Intel Fortran + fpp
	sed -i '/^\.F90\.o:/,/^\t\$(RM) \$\*\.f/ c\.F90.o:\n\t$(RM) $@ $*.mod\n\t$(FC) $(FFLAGS) -fpp $(CPPFLAGS) ${NETCDF_INC} -c $<' configure.oa

	echo " "
	LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.obsgrid.log

	conda deactivate
	conda deactivate
	conda deactivate

	echo " "
	# IF statement to check that all files were created.
	if [[ -x ./obsgrid.exe ]]; then
		echo "obsgrid.exe found."
		read -r -t 5 -p "Finished installing OBSGRID. I am going to wait for 5 seconds only ..."
	else
		echo "obsgrid.exe is missing. Attempting to compile again..."

		LD_LIBRARY_PATH= ./clean -a
		LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.obsgrid.retry.log

		if [[ -x ./obsgrid.exe ]]; then
			echo "obsgrid.exe successfully created after recompilation."
			read -r -t 5 -p "Finished retrying OBSGRID compile. I am going to wait for 5 seconds only ..."
		else
			echo "Still missing obsgrid.exe after recompile. Exiting the script."
			read -r -p "Please contact script authors for assistance. Press 'Enter' to exit."
			exit 1
		fi
	fi

	echo " "

	##################### WRF Python           ##################
	########### WRf-Python compiled via Conda  ##################
	########### This is the preferred method by NCAR      ##################
	##### https://wrf-python.readthedocs.io/en/latest/installation.html  ##################
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh
	conda env create -f $HOME/WRF-MOSIT/wrf-python-stable.yml

	######################### Climate Data Operators ############
	######################### CDO compiled via Conda ###########
	####################### This is the preferred method #######
	################### https://bairdlangenbrunner.github.io/python-for-climate-scientists/conda/setting-up-conda-environments.html #######################

	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	conda create --name cdo_stable -y
	conda activate cdo_stable
	conda install -c conda-forge cdo -y
	conda update --all -y
	conda deactivate
	conda deactivate
	conda deactivate

	echo " "

	########################## WRF Hydro GIS PreProcessor ##############################
	#  Compiled with Conda
	#  https://github.com/NCAR/wrf_hydro_gis_preprocessor
	####################################################################################

	conda init bash
	conda activate base
	conda create -n wrfh_gis_env -c conda-forge python=3.12 gdal netCDF4 numpy pyproj whitebox=2.2.0 packaging shapely -y
	conda activate wrfh_gis_env
	conda update -n wrfh_gis_env --all -y
	conda deactivate
	conda deactivate
	conda deactivate
	cd "${WRF_FOLDER}"
	git clone https://github.com/NCAR/wrf_hydro_gis_preprocessor.git "${WRF_FOLDER}"/WRF-Hydro-GIS-PreProcessor

	echo " "

	############################# WRF HYDRO V5.4.0 #################################
	# Version 5.3.0
	# Standalone mode
	################################################################################

	# Source Intel oneAPI environment
	source /opt/intel/oneapi/setvars.sh --force

	# Set up NETCDF environment variables
	export NETCDF_INC="$DIR/NETCDF/include"
	export NETCDF_LIB="$DIR/NETCDF/lib"

	# Create directories for Hydro Basecode and navigate to it
	mkdir -p "${WRF_FOLDER}/Hydro-Basecode"
	cd "${WRF_FOLDER}/Hydro-Basecode"

	# Clone the WRF-Hydro repository and set up the build
	git clone https://github.com/NCAR/wrf_hydro_nwm_public.git
	cd wrf_hydro_nwm_public
	mkdir -p build
	cd build

	# Run CMake configuration for WRF-Hydro with specified options
	cmake .. \
		-DSPATIAL_SOIL=1 \
		-DWRF_HYDRO=1 \
		-DWRFIO_NCD_LARGE_FILE_SUPPORT=1 \
		-DCMAKE_Fortran_COMPILER=ifx

	# Compile using specified CPU settings
	make -j "$CPU_QUARTER_EVEN" 2>&1 | tee make.log

	# List of expected files (binary + symlinks)
	expected_files=("wrf_hydro" "wrf_hydro.exe" "wrf_hydro_NoahMP")

	# Count how many of them exist
	n=0
	for f in "${expected_files[@]}"; do
		[[ -e $f ]] && ((n++))
	done

	# Function to rerun compilation if files are missing
	rebuild_and_check() {
		echo "Missing one or more expected files. Running compiler again..."
		cd "${WRF_FOLDER}/Hydro-Basecode/wrf_hydro_nwm_public/build"
		make -j "$CPU_QUARTER_EVEN" 2>&1 | tee make2.log
		cd "${WRF_FOLDER}/Hydro-Basecode/wrf_hydro_nwm_public/build/Run"

		n=0
		for f in "${expected_files[@]}"; do
			[[ -e $f ]] && ((n++))
		done
	}

	# IF statement to check that all expected files were created
	if ((n == ${#expected_files[@]})); then
		echo "All expected files created."
	else
		rebuild_and_check
		if ((n != ${#expected_files[@]})); then
			echo "Missing one or more expected files. Exiting the script."
			read -r -p "Please contact script authors for assistance. Press 'Enter' to exit the script."
			exit 1
		else
			echo "All expected files created after re-compiling."
		fi
	fi

	# Finish the script with a pause
	read -r -t 5 -p "Finished installing WRF Hydro Basecode. Waiting for 5 seconds..."
	############################ WRF #################################
	## WRF v${WPS_VERSION}
	## Downloaded from git tagged releases
	# option 78, option 1 for intel and distributed memory w/basic nesting
	# large file support enable with WRFiO_NCD_LARGE_FILE_SUPPORT=1
	# In the namelist.input, the following settings support pNetCDF by setting  value to 11:
	# io_form_boundary
	# io_form_history
	# io_form_auxinput2
	# io_form_auxhist2
	# Note that you need set nocolons = .true. in the section &time_control of namelist.input
	########################################################################

	cd "${WRF_FOLDER}"/Downloads

	wget -c https://github.com/wrf-model/WRF/releases/download/v${WRF_VERSION}/v${WRF_VERSION}.tar.gz -O WRF-${WRF_VERSION}.tar.gz
	LD_LIBRARY_PATH= tar -xvzf WRF-${WRF_VERSION}.tar.gz -C "${WRF_FOLDER}"/

	# If statment for changing folder name
	# Check if WRF directory exists
	if [ -d "${WRF_FOLDER}/WRF" ]; then
		mv -f "${WRF_FOLDER}/WRF" "${WRF_FOLDER}/WRF-${WRF_VERSION}"

	# Else, check for any folder matching WRFV*
	else
		for dir in "${WRF_FOLDER}"/WRFV*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WRF-${WRF_VERSION}"
				break
			fi
		done
	fi

	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}

	export WRFIO_NCD_LARGE_FILE_SUPPORT=1

	#Replace old version of WRF-Hydro distributed with WRF with updated WRF-Hydro source code
	rm -r "${WRF_FOLDER}"/WRF-${WRF_VERSION}/hydro/
	cp -r "${WRF_FOLDER}"/Hydro-Basecode/wrf_hydro_nwm_public/src "${WRF_FOLDER}"/WRF-${WRF_VERSION}/hydro

	############# Intel LLVM Patch for Hydro ##############

	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/hydro/template

	sed -i '12s|=0|=1|g' setEnvar.sh
	sed -i '$ a\# Large file support\nexport WRFIO_NCD_LARGE_FILE_SUPPORT=1' setEnvar.sh

	source setEnvar.sh
	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}

	LD_LIBRARY_PATH= ./clean -a


    ############################################################ NEEDS REVIEW IN FUTURE ##################################
    sed -i '34s\($x =~ "ifort")\($x =~ /ifort|intel/)\g' "${WRF_FOLDER}"/WRF-${WRF_VERSION}/hydro/wrf_hydro_config
    ######################################################################################################################


	if [ ${auto_config} -eq 1 ]; then
		(
			echo 78
			echo 1
		) | ./configure

	else
		./configure 2>&1 | tee configure.log #option 78 intel compiler with distributed memory option 1 for basic nesting
	fi

	#Need to remove mpich/GNU config calls to Intel config calls
	sed -i '136s|mpif90 -f90=$(SFC)|mpiifx|g' "${WRF_FOLDER}"/WRF-${WRF_VERSION}/configure.wrf
	sed -i '137s|mpicc -cc=$(SCC)|mpiicx|g' "${WRF_FOLDER}"/WRF-${WRF_VERSION}/configure.wrf
	sed -i '63s|mpif90|mpiifx|g' "${WRF_FOLDER}"/WRF-${WRF_VERSION}/hydro/macros
	sed -i '64s|mpicc|mpiicx|g' "${WRF_FOLDER}"/WRF-${WRF_VERSION}/hydro/macros

	LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN em_real 2>&1 | tee compile.wrf1.log

	export WRF_DIR="${WRF_FOLDER}"/WRF-${WRF_VERSION}

	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/main
	n=$(ls ./*.exe | wc -l)
	if (($n >= 3)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}
		LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN em_real 2>&1 | tee compile.wrf2.log
		cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/main
		n=$(ls ./*.exe | wc -l)
		if (($n >= 3)); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	echo " "

	echo " "

	############################WPS#####################################
	## WPS v${WPS_VERSION}
	## Downloaded from git tagged releases
	#Option 3 for gfortran and distributed memory
	########################################################################

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/wrf-model/WPS/archive/refs/tags/v${WPS_VERSION}.tar.gz -O WPS-${WPS_VERSION}.tar.gz
	LD_LIBRARY_PATH= tar -xvzf WPS-${WPS_VERSION}.tar.gz -C "${WRF_FOLDER}"/
	# Check if WPS directory exists
	if [ -d "${WRF_FOLDER}/WPS" ]; then
		mv -f "${WRF_FOLDER}/WPS" "${WRF_FOLDER}/WPS-${WPS_VERSION}"

	# Else, check for any folder matching WPSV* or WPS-*
	else
		for dir in "${WRF_FOLDER}"/WPSV* "${WRF_FOLDER}"/WPS-*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WPS-${WPS_VERSION}"
				break
			fi
		done
	fi
	cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
	LD_LIBRARY_PATH= ./clean -a

	sed -i '77s|real ::|integer ::|g' $"${WRF_FOLDER}"/WPS-${WPS_VERSION}/ungrib/src/rd_grib2.F

	if [ ${auto_config} -eq 1 ]; then
		echo 19 | ./configure 2>&1 | tee configure.log #Option 19 for intel and distributed memory
	else
		./configure 2>&1 | tee configure.log #Option 19 intel compiler with distributed memory
	fi

	sed -i '67s|mpif90|mpiifx|g' "${WRF_FOLDER}"/WPS-${WPS_VERSION}/configure.wps
	sed -i '68s|mpicc|mpiicx|g' "${WRF_FOLDER}"/WPS-${WPS_VERSION}/configure.wps

	LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.wps.log

	echo " "
	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
	n=$(ls ./*.exe | wc -l)
	if (($n == 3)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WPS. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.wps2.log
		cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
		n=$(ls ./*.exe | wc -l)
		if (($n == 3)); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WPS. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	echo " "

	######################## Static Geography Data inc/ Optional ####################
	# http://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html
	# These files are large so if you only need certain ones comment the others off
	# All files downloaded and untarred is 200GB
	# https://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html
	#################################################################################
	cd "${WRF_FOLDER}"/Downloads
	mkdir "${WRF_FOLDER}"/GEOG
	mkdir "${WRF_FOLDER}"/GEOG/WPS_GEOG

	echo " "
	echo "Mandatory WRF Preprocessing System (WPS) Geographical Input Data Mandatory Fields Downloads"
	echo " "
	wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_high_res_mandatory.tar.gz
	LD_LIBRARY_PATH= tar -xvzf geog_high_res_mandatory.tar.gz -C "${WRF_FOLDER}"/GEOG/

	wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_low_res_mandatory.tar.gz
	LD_LIBRARY_PATH= tar -xvzf geog_low_res_mandatory.tar.gz -C "${WRF_FOLDER}"/GEOG/
	mv "${WRF_FOLDER}"/GEOG/WPS_GEOG_LOW_RES/ "${WRF_FOLDER}"/GEOG/WPS_GEOG

	if [ ${WPS_Specific_Applications} -eq 1 ]; then
		echo " "
		echo " WPS Geographical Input Data Mandatory for Specific Applications"
		echo " "

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_thompson28_chem.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_thompson28_chem.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_noahmp.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_noahmp.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/irrigation.tar.gz
		LD_LIBRARY_PATH= tar -xvzf irrigation.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_px.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_px.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_urban.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_urban.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_ssib.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_ssib.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/lake_depth.tar.bz2
		LD_LIBRARY_PATH= tar -xvf lake_depth.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/topobath_30s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf topobath_30s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/gsl_gwd.tar.bz2
		LD_LIBRARY_PATH= tar -xvf gsl_gwd.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/cglc_modis_lcz_global.tar.gz
		LD_LIBRARY_PATH= tar -xvf cglc_modis_lcz_global.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG
	fi

	if [ ${Optional_GEOG} -eq 1 ]; then
		echo " "
		echo "Optional WPS Geographical Input Data"
		echo " "

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_older_than_2000.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_older_than_2000.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/modis_landuse_20class_15s_with_lakes.tar.gz
		LD_LIBRARY_PATH= tar -xvzf modis_landuse_20class_15s_with_lakes.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_alt_lsm.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_alt_lsm.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/nlcd2006_ll_9s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf nlcd2006_ll_9s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/updated_Iceland_LU.tar.gz
		LD_LIBRARY_PATH= tar -xvf updated_Iceland_LU.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/modis_landuse_20class_15s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf modis_landuse_20class_15s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG
	fi

fi

if [ "$macos_64bit_GNU" = "1" ] && [ "$WRFHYDRO_COUPLED_PICK" = "1" ] && [ "$MAC_CHIP" = "Intel" ]; then

	#############################basic package managment############################

	brew cleanup -s
	brew update
	outdated_packages=$(brew outdated --quiet)

	# List of packages to check/install
	packages=(
		"autoconf" "automake" "bison" "byacc" "cmake" "curl" "flex" "gcc"
		"gedit" "git" "gnu-sed" "ksh"
		"libtool" "libxml2" "m4" "make" "python@3.12" "tcsh" "wget"
		"xauth" "xorgproto" "xorgrgb" "xquartz"
	)

	for pkg in "${packages[@]}"; do
		if brew list "$pkg" &>/dev/null; then
			echo "$pkg is already installed."
			if [[ $outdated_packages == *"$pkg"* ]]; then
				echo "$pkg has a newer version available. Upgrading..."
				brew upgrade "$pkg"
			fi
		else
			echo "$pkg is not installed. Installing..."
			brew install "$pkg"
		fi
		sleep 1
	done

	export LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH
	export PATH=/usr/local/bin:$PATH

	##############################Directory Listing############################

	export HOME=$(
		cd
		pwd
	)
	mkdir $HOME/WRFHYDRO_COUPLED
	export WRF_FOLDER=$HOME/WRFHYDRO_COUPLED
	cd "${WRF_FOLDER}"/
	mkdir Downloads
	mkdir "${WRF_FOLDER}"/Hydro-Basecode
	mkdir Libs
	export DIR="${WRF_FOLDER}"/Libs
	mkdir Libs/grib2
	mkdir Libs/NETCDF
	mkdir Libs/MPICH
	mkdir -p Tests/Environment
	mkdir -p Tests/Compatibility

	echo " "

	#############################Core Management####################################
	export CPU_CORE=$(sysctl -n hw.ncpu) # number of available threads on system
	export CPU_6CORE="6"
	export CPU_QUARTER=$(($CPU_CORE / 4))
	#1/2 of availble cores on system
	export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))
	#Forces CPU cores to even number to avoid partial core export. ie 7 cores would be 3.5 cores.

	if [ $CPU_CORE -le $CPU_6CORE ]; then #If statement for low core systems.  Forces computers to only use 1 core if there are 4 cores or less on the system. then
		export CPU_QUARTER_EVEN="2"
	else
		export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))
	fi

	echo "##########################################"
	echo "Number of Threads being used $CPU_QUARTER_EVEN"
	echo "##########################################"
	echo " "

	##############################Downloading Libraries############################

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/madler/zlib/releases/download/v$Zlib_Version/zlib-$Zlib_Version.tar.gz
	wget -c https://github.com/HDFGroup/hdf5/releases/download/hdf5_$HDF5_Version/hdf5-$HDF5_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-c/archive/refs/tags/v$Netcdf_C_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-fortran/archive/refs/tags/v$Netcdf_Fortran_Version.tar.gz
	wget -c https://download.sourceforge.net/libpng/libpng-$Libpng_Version.tar.gz
	wget -c https://www.ece.uvic.ca/~frodo/jasper/software/jasper-$Jasper_Version.zip
	wget -c https://github.com/pmodels/mpich/releases/download/v$Mpich_Version/mpich-$Mpich_Version.tar.gz
	wget -c https://parallel-netcdf.github.io/Release/pnetcdf-$Pnetcdf_Version.tar.gz

	echo " "

	############################# Compilers #############################

	# Symlink to avoid clang conflicts with compilers
	# Default gcc path: /usr/bin/gcc
	# Default homebrew path: /usr/local/bin

	# Find the highest version of GCC, G++, and GFortran in /usr/local/bin
	latest_gcc=$(ls /usr/local/bin/gcc-* 2>/dev/null | grep -o 'gcc-[0-9]*' | sort -V | tail -n 1)
	latest_gpp=$(ls /usr/local/bin/g++-* 2>/dev/null | grep -o 'g++-[0-9]*' | sort -V | tail -n 1)
	latest_gfortran=$(ls /usr/local/bin/gfortran-* 2>/dev/null | grep -o 'gfortran-[0-9]*' | sort -V | tail -n 1)

	# Display the chosen versions
	echo "Selected gcc version: $latest_gcc"
	echo "Selected g++ version: $latest_gpp"
	echo "Selected gfortran version: $latest_gfortran"

	# Check if GCC was found

	# Create or update the symbolic links for GCC, G++, and GFortran
	echo "Linking the latest GCC version: $latest_gcc"
	echo $PASSWD | sudo -S ln -sf /usr/local/bin/$latest_gcc /usr/local/bin/gcc

	echo "Linking the latest G++ version: $latest_gpp"
	echo $PASSWD | sudo -S ln -sf /usr/local/bin/$latest_gpp /usr/local/bin/g++

	echo "Linking the latest GFortran version: $latest_gfortran"
	echo $PASSWD | sudo -S ln -sf /usr/local/bin/$latest_gfortran /usr/local/bin/gfortran

	echo "Updated symbolic links for GCC, G++, and GFortran."
	echo $PASSWD | sudo -S ln -sf /usr/local/bin/python3.12 /usr/local/bin/python3

	# Export compiler environment variables
	export CC=gcc
	export CXX=g++
	export FC=gfortran
	export F77=gfortran
	export CFLAGS="-fPIC -fPIE -Wno-implicit-function-declaration -Wno-incompatible-pointer-types -Wall"

	echo " "

	############################# End of Compiler Setup #############################

	#IF statement for GNU compiler issue
	export GCC_VERSION=$(/usr/local/bin/$latest_gcc -dumpfullversion | awk '{print$1}')
	export GFORTRAN_VERSION=$(/usr/local/bin/$latest_gfortran -dumpfullversion | awk '{print$1}')
	export GPLUSPLUS_VERSION=$(/usr/local/bin/$latest_gpp -dumpfullversion | awk '{print$1}')

	export GCC_VERSION_MAJOR_VERSION=$(echo $GCC_VERSION | awk -F. '{print $1}')
	export GFORTRAN_VERSION_MAJOR_VERSION=$(echo $GFORTRAN_VERSION | awk -F. '{print $1}')
	export GPLUSPLUS_VERSION_MAJOR_VERSION=$(echo $GPLUSPLUS_VERSION | awk -F. '{print $1}')

	export version_10="10"

	if [ $GCC_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GFORTRAN_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GPLUSPLUS_VERSION_MAJOR_VERSION -ge $version_10 ]; then
		export fallow_argument=-fallow-argument-mismatch
		export boz_argument=-fallow-invalid-boz
	else
		export fallow_argument=
		export boz_argument=
	fi

	export FFLAGS="$fallow_argument -m64"
	export FCFLAGS="$fallow_argument -m64"

	echo "##########################################"
	echo "FFLAGS = $FFLAGS"
	echo "FCFLAGS = $FCFLAGS"
	echo "CFLAGS = $CFLAGS"
	echo "##########################################"

	echo " "

	############################# ZLib ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf zlib-$Zlib_Version.tar.gz
	cd zlib-$Zlib_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	export ZLIB_ROOT=$DIR/grib2
	export ZLIBLIB=$DIR/grib2/lib
	export ZLIBINC=$DIR/grib2/include

	echo " "

	############################## MPICH ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf mpich-$Mpich_Version.tar.gz
	cd mpich-$Mpich_Version/

	F90= ./configure --prefix=$DIR/MPICH --with-device=ch3 FFLAGS="$fallow_argument -m64" FCFLAGS="$fallow_argument -m64" 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/MPICH/bin:$PATH
	export MPIFC=$DIR/MPICH/bin/mpifort
	export MPIF77=$DIR/MPICH/bin/mpifort
	export MPIF90=$DIR/MPICH/bin/mpifort
	export MPICC=$DIR/MPICH/bin/mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx

	echo " "

	############################# libpng ############################

	cd "${WRF_FOLDER}"/Downloads

	# other libraries below need these variables to be set
	export LDFLAGS=-L$DIR/grib2/lib
	export CPPFLAGS=-I$DIR/grib2/include

	LD_LIBRARY_PATH= tar -xvzf libpng-$Libpng_Version.tar.gz
	cd libpng-$Libpng_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNG_ROOT=$DIR/grib2

	echo " "
	#############################JasPer ############################

	cd "${WRF_FOLDER}"/Downloads
	unzip jasper-$Jasper_Version.zip
	cd jasper-$Jasper_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	export JASPERLIB=$DIR/grib2/lib
	export JASPERINC=$DIR/grib2/include
	export JASPER_DIR=$DIR/grib2
	export Jasper_ROOT=$DIR/grib2/lib

	echo " "
	############################# hdf5 library for netcdf4 functionality ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf hdf5-$HDF5_Version.tar.gz
	cd hdf5-$HDF5_Version

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --with-zlib=$DIR/grib2 --enable-hl --enable-fortran --enable-parallel 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export HDF5=$DIR/grib2
	export PATH=$HDF5/bin:$PATH
	export PHDF5=$DIR/grib2
	export HDF5_ROOT=$DIR/grib2
	export PHDF5_ROOT=$DIR/grib2

	echo " "

	############################# Install Parallel-netCDF ##############################
	#Make file created with half of available cpu cores
	#Hard path for MPI added
	##################################################################################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf pnetcdf-$Pnetcdf_Version.tar.gz
	cd pnetcdf-$Pnetcdf_Version

	export MPIFC=$DIR/MPICH/bin/mpifort
	export MPIF77=$DIR/MPICH/bin/mpifort
	export MPIF90=$DIR/MPICH/bin/mpifort
	export MPICC=$DIR/MPICH/bin/mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx

	# drop --disable-utils (not recognized)
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS="-std=gnu99 $CFLAGS" FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --enable-static 2>&1 | tee configure.log

	# build only libraries
	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log

	# install only libraries and headers
	make install 2>&1 | tee make.install.log

	export PNETCDF=$DIR/grib2
	export PNETCDF_DIR=$DIR/grib2
	export PNETCDF_ROOT=$DIR/grib2

	echo " "

	read -r -t 3 -p

	############################## Install NETCDF C Library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_C_Version.tar.gz
	cd netcdf-c-$Netcdf_C_Version/
	export CPPFLAGS=-I$DIR/grib2/include
	export LDFLAGS="-L$DIR/grib2/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lhdf5_hl -lhdf5 -lz -lcurl -lgcc -lm -ldl -lpnetcdf"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --disable-dap --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-pnetcdf --enable-cdf5 --enable-parallel-tests --enable-logging 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/NETCDF/bin:$PATH
	export NETCDF=$DIR/NETCDF
	export NETCDF_INC=$DIR/NETCDF/include
	export NETCDF_LIB=$DIR/NETCDF/lib
	export NETCDF_ROOT=$DIR/NETCDF
	export LD_LIBRARY_PATH=$DIR/grib2/lib:$DIR/NETCDF/lib:$LD_LIBRARY_PATH

	echo " "

	############################## NetCDF fortran library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_Fortran_Version.tar.gz
	cd netcdf-fortran-$Netcdf_Fortran_Version/
	export LD_LIBRARY_PATH=$DIR/NETCDF/lib:$LD_LIBRARY_PATH
	export CPPFLAGS="-I$DIR/NETCDF/include -I$DIR/grib2/include"
	export LDFLAGS="-L$DIR/NETCDF/lib -L$DIR/grib2/lib -Wl,-rpath,$DIR/NETCDF/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lnetcdf -lpnetcdf -lcurl -lhdf5_hl -lhdf5 -lz -lm -ldl -lgcc"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-parallel-tests --enable-logging --enable-hdf5 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	echo " "
	#################################### System Environment Tests ##############
	mkdir -p "${WRF_FOLDER}"/Tests/Environment
	mkdir -p "${WRF_FOLDER}"/Tests/Compatibility

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_NETCDF_MPI_tests.tar
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_tests.tar

	LD_LIBRARY_PATH= tar -xvf Fortran_C_tests.tar -C "${WRF_FOLDER}"/Tests/Environment
	LD_LIBRARY_PATH= tar -xvf Fortran_C_NETCDF_MPI_tests.tar -C "${WRF_FOLDER}"/Tests/Compatibility
	export one="1"
	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Environment

	echo " "
	echo " "
	echo "Environment Testing "
	echo "Test 1"
	$FC TEST_1_fortran_only_fixed.f
	./a.out | tee env_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 1 Passed"
	else
		echo "Environment Compiler Test 1 Failed"
		exit
	fi
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 2"
	$FC TEST_2_fortran_only_free.f90
	./a.out | tee env_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 2 Passed"
	else
		echo "Environment Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 3"
	$CC TEST_3_c_only.c
	./a.out | tee env_test3.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test3.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 3 Passed"
	else
		echo "Environment Compiler Test 3 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 4"
	$CC -c -m64 TEST_4_fortran+c_c.c
	$FC -c -m64 TEST_4_fortran+c_f.f90
	$FC -m64 TEST_4_fortran+c_f.o TEST_4_fortran+c_c.o
	./a.out | tee env_test4.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test4.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 4 Passed"
	else
		echo "Environment Compiler Test 4 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Compatibility

	cp ${NETCDF}/include/netcdf.inc .

	echo " "
	echo " "
	echo "Library Compatibility Tests "
	echo "Test 1"
	$FC -c 01_fortran+c+netcdf_f.f
	$CC -c 01_fortran+c+netcdf_c.c
	$FC 01_fortran+c+netcdf_f.o 01_fortran+c+netcdf_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	./a.out | tee comp_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 1 Passed"
	else
		echo "Compatibility Compiler Test 1 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "

	echo "Test 2"
	$MPIFC -c 02_fortran+c+netcdf+mpi_f.f
	$MPICC -c 02_fortran+c+netcdf+mpi_c.c
	$MPIFC 02_fortran+c+netcdf+mpi_f.o \
		02_fortran+c+netcdf+mpi_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	$DIR/MPICH/bin/mpirun ./a.out | tee comp_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 2 Passed"
	else
		echo "Compatibility Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."
	echo " "

	echo " All tests completed and passed"
	echo " "

	################################OpenGrADS######################################
	#Verison 2.2.1 64bit of Linux
	#############################################################################
	if [[ $GRADS_PICK -eq 1 ]]; then
		cd "${WRF_FOLDER}"/Downloads
		wget -c https://sourceforge.net/projects/opengrads/files/grads2/2.2.1.oga.1/macOS/opengrads-2.2.1.oga.1-bundle-x86_64-apple-darwin20.5.0.pkg
		sudo -S installer -pkg opengrads-2.2.1.oga.1-bundle-x86_64-apple-darwin20.5.0.pkg -target /Applications/OpenGrads <<<"$PASSWD"

	fi
	################################## GrADS ###############################
	# Version  2.2.1
	# Sublibs library instructions: http://cola.gmu.edu/grads/gadoc/supplibs2.html
	# GrADS instructions: http://cola.gmu.edu/grads/downloads.php
	########################################################################
	if [[ $GRADS_PICK -eq 2 ]]; then

		brew install grads

	fi

	######################################################################
	#Installing Miniconda3 to WRF directory and updating libraries
	######################################################################
	echo $PASSWD | sudo -S apt -y install python3-zstandard python3-zstd

	export Miniconda_Install_DIR="${WRF_FOLDER}"/miniconda3

	mkdir -p $Miniconda_Install_DIR

	wget -c https://repo.anaconda.com/miniconda/Miniconda3-latest-MacOSX-x86_64.sh -O $Miniconda_Install_DIR/miniconda.sh
	bash $Miniconda_Install_DIR/miniconda.sh -b -u -p $Miniconda_Install_DIR

	rm -rf $Miniconda_Install_DIR/miniconda.sh

	export PATH="${WRF_FOLDER}"/miniconda3/bin:$PATH

	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	$Miniconda_Install_DIR/bin/conda init bash

	conda tos accept
	conda config --add channels conda-forge
	conda config --set auto_activate_base false
	conda update -n root --all -y

	echo " "

	#Installing NCL via Conda
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	conda create -n ncl_stable -c conda-forge ncl -y
	conda activate ncl_stable

	conda deactivate
	conda deactivate
	conda deactivate
	echo " "

	##################### WRF Python           ##################
	########### WRf-Python compiled via Conda  ##################
	########### This is the preferred method by NCAR      ##################
	##### https://wrf-python.readthedocs.io/en/latest/installation.html  ##################
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh
	conda env create -f $HOME/WRF-MOSIT/wrf-python-stable.yml

	######################### Climate Data Operators ############
	######################### CDO compiled via Conda ###########
	####################### This is the preferred method #######
	################### https://bairdlangenbrunner.github.io/python-for-climate-scientists/conda/setting-up-conda-environments.html #######################

	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	conda create --name cdo_stable -y
	conda activate cdo_stable
	conda install -c conda-forge cdo -y
	conda update --all -y
	conda deactivate
	conda deactivate
	conda deactivate

	echo " "

	########################## WRF Hydro GIS PreProcessor ##############################
	#  Compiled with Conda
	#  https://github.com/NCAR/wrf_hydro_gis_preprocessor
	####################################################################################

	conda init bash
	conda activate base
	conda config --add channels conda-forge
	conda create -n wrfh_gis_env -c conda-forge python=3.12 gdal netCDF4 numpy pyproj whitebox=2.2.0 packaging shapely -y
	conda activate wrfh_gis_env
	conda update -n wrfh_gis_env --all -y
	conda deactivate
	conda deactivate
	conda deactivate

	cd "${WRF_FOLDER}"/
	git clone https://github.com/NCAR/wrf_hydro_gis_preprocessor.git "${WRF_FOLDER}"/WRF-Hydro-GIS-PreProcessor
	echo " "

	############################# WRF HYDRO V5.4.0 #################################
	# Version 5.3.0
	# Standalone mode
	################################################################################
	# Set up NETCDF environment variables
	export NETCDF_INC="$DIR/NETCDF/include"
	export NETCDF_LIB="$DIR/NETCDF/lib"

	# Create directories for Hydro Basecode and navigate to it
	mkdir -p "${WRF_FOLDER}/Hydro-Basecode"
	cd "${WRF_FOLDER}/Hydro-Basecode"

	# Clone the WRF-Hydro repository and set up the build
	git clone https://github.com/NCAR/wrf_hydro_nwm_public.git
	cd wrf_hydro_nwm_public
	mkdir -p build
	cd build

	# Run CMake configuration for WRF-Hydro with specified options
	cmake .. \
		-DSPATIAL_SOIL=1 \
		-DWRF_HYDRO=1 \
		-DWRFIO_NCD_LARGE_FILE_SUPPORT=1 \
		-DCMAKE_Fortran_COMPILER=/usr/local/bin/$latest_gfortran \
		-DCMAKE_C_COMPILER=/usr/local/bin/$latest_gcc \
		-DNETCDF_MODULES=$DIR/NETCDF/include

	# Compile using specified CPU settings
	make -j "$CPU_QUARTER_EVEN" 2>&1 | tee make.log

	# List of expected files (binary + symlinks)
	expected_files=("wrf_hydro" "wrf_hydro.exe" "wrf_hydro_NoahMP")

	# Count how many of them exist
	n=0
	for f in "${expected_files[@]}"; do
		[[ -e $f ]] && ((n++))
	done

	# Function to rerun compilation if files are missing
	rebuild_and_check() {
		echo "Missing one or more expected files. Running compiler again..."
		cd "${WRF_FOLDER}/Hydro-Basecode/wrf_hydro_nwm_public/build"
		make -j "$CPU_QUARTER_EVEN" 2>&1 | tee make2.log
		cd "${WRF_FOLDER}/Hydro-Basecode/wrf_hydro_nwm_public/build/Run"

		n=0
		for f in "${expected_files[@]}"; do
			[[ -e $f ]] && ((n++))
		done
	}

	# IF statement to check that all expected files were created
	if ((n == ${#expected_files[@]})); then
		echo "All expected files created."
	else
		rebuild_and_check
		if ((n != ${#expected_files[@]})); then
			echo "Missing one or more expected files. Exiting the script."
			read -r -p "Please contact script authors for assistance. Press 'Enter' to exit the script."
			exit 1
		else
			echo "All expected files created after re-compiling."
		fi
	fi

	# Finish the script with a pause
	read -r -t 5 -p "Finished installing WRF Hydro Basecode. Waiting for 5 seconds..."
	############################ WRF #################################
	## WRF v${WPS_VERSION}
	## Downloaded from git tagged releases
	# option 21, option 1 for gfortran and distributed memory w/basic nesting
	# large file support enable with WRFiO_NCD_LARGE_FILE_SUPPORT=1
	########################################################################

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/wrf-model/WRF/releases/download/v${WRF_VERSION}/v${WRF_VERSION}.tar.gz -O WRF-${WRF_VERSION}.tar.gz
	LD_LIBRARY_PATH= tar -xvzf WRF-${WRF_VERSION}.tar.gz -C "${WRF_FOLDER}"/

	# If statment for changing folder name
	# Check if WRF directory exists
	if [ -d "${WRF_FOLDER}/WRF" ]; then
		mv -f "${WRF_FOLDER}/WRF" "${WRF_FOLDER}/WRF-${WRF_VERSION}"

	# Else, check for any folder matching WRFV*
	else
		for dir in "${WRF_FOLDER}"/WRFV*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WRF-${WRF_VERSION}"
				break
			fi
		done
	fi

	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}
	export WRFIO_NCD_LARGE_FILE_SUPPORT=1

	#Replace old version of WRF-Hydro distributed with WRF with updated WRF-Hydro source code
	rm -r "${WRF_FOLDER}"/WRF-${WRF_VERSION}/hydro/
	cp -r "${WRF_FOLDER}"/Hydro-Basecode/wrf_hydro_nwm_public/src "${WRF_FOLDER}"/WRF-${WRF_VERSION}/hydro

	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/hydro/template

	sed -i'' -e '12s|=0|=1|g' setEnvar.sh
	sed -i'' -e '$ a\# Large file support\nexport WRFIO_NCD_LARGE_FILE_SUPPORT=1' setEnvar.sh

	source setEnvar.sh
	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}

	LD_LIBRARY_PATH= ./clean -a

	if [ ${auto_config} -eq 1 ]; then
		(echo 17 echo 1) | ./configure

	else
		./configure 2>&1 | tee configure.log #Option 17 gfortran compiler with distributed memory option 1 for basic nesting
	fi

	sed -i'' -e '145s/-c/-c -fPIC -fPIE -O3  -Wno-error=implicit-function-declaration/g' configure.wrf

	./compile em_real 2>&1 | tee compile.wrf.log

	export WRF_DIR="${WRF_FOLDER}"/WRF-${WRF_VERSION}

	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/main
	n=$(ls ./*.exe | wc -l)
	if (($n >= 3)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}
		LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN em_real 2>&1 | tee compile.wrf2.log
		cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/main
		n=$(ls ./*.exe | wc -l)
		if (($n >= 3)); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	echo " "

	echo " "

	############################WPS#####################################
	## WPS v${WPS_VERSION}
	## Downloaded from git tagged releases
	#Option 3 for gfortran and distributed memory
	########################################################################

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/wrf-model/WPS/archive/refs/tags/v${WPS_VERSION}.tar.gz -O WPS-${WPS_VERSION}.tar.gz
	LD_LIBRARY_PATH= tar -xvzf WPS-${WPS_VERSION}.tar.gz -C "${WRF_FOLDER}"/
	# Check if WPS directory exists
	if [ -d "${WRF_FOLDER}/WPS" ]; then
		mv -f "${WRF_FOLDER}/WPS" "${WRF_FOLDER}/WPS-${WPS_VERSION}"

	# Else, check for any folder matching WPSV* or WPS-*
	else
		for dir in "${WRF_FOLDER}"/WPSV* "${WRF_FOLDER}"/WPS-*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WPS-${WPS_VERSION}"
				break
			fi
		done
	fi
	cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
	LD_LIBRARY_PATH= ./clean -a

	if [ ${auto_config} -eq 1 ]; then
		echo 19 | ./configure 2>&1 | tee configure.log #Option 19 for gfortran and distributed memory
	else
		./configure 2>&1 | tee configure.log #Option 19 gfortran compiler with distributed memory
	fi
	LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.wps.log

	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
	n=$(ls ./*.exe | wc -l)
	if (($n == 3)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WPS. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.wps2.log
		cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
		n=$(ls ./*.exe | wc -l)
		if (($n == 3)); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WPS. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	echo " "

	######################## Static Geography Data inc/ Optional ####################
	# http://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html
	# These files are large so if you only need certain ones comment the others off
	# All files downloaded and untarred is 200GB
	# https://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html
	#################################################################################
	cd "${WRF_FOLDER}"/Downloads
	mkdir "${WRF_FOLDER}"/GEOG
	mkdir "${WRF_FOLDER}"/GEOG/WPS_GEOG

	echo " "
	echo "Mandatory WRF Preprocessing System (WPS) Geographical Input Data Mandatory Fields Downloads"
	echo " "
	wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_high_res_mandatory.tar.gz
	LD_LIBRARY_PATH= tar -xvzf geog_high_res_mandatory.tar.gz -C "${WRF_FOLDER}"/GEOG/

	wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_low_res_mandatory.tar.gz
	LD_LIBRARY_PATH= tar -xvzf geog_low_res_mandatory.tar.gz -C "${WRF_FOLDER}"/GEOG/
	mv "${WRF_FOLDER}"/GEOG/WPS_GEOG_LOW_RES/ "${WRF_FOLDER}"/GEOG/WPS_GEOG

	if [ ${WPS_Specific_Applications} -eq 1 ]; then
		echo " "
		echo " WPS Geographical Input Data Mandatory for Specific Applications"
		echo " "

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_thompson28_chem.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_thompson28_chem.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_noahmp.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_noahmp.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/irrigation.tar.gz
		LD_LIBRARY_PATH= tar -xvzf irrigation.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_px.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_px.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_urban.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_urban.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_ssib.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_ssib.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/lake_depth.tar.bz2
		LD_LIBRARY_PATH= tar -xvf lake_depth.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/topobath_30s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf topobath_30s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/gsl_gwd.tar.bz2
		LD_LIBRARY_PATH= tar -xvf gsl_gwd.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/cglc_modis_lcz_global.tar.gz
		LD_LIBRARY_PATH= tar -xvf cglc_modis_lcz_global.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG
	fi

	if [ ${Optional_GEOG} -eq 1 ]; then
		echo " "
		echo "Optional WPS Geographical Input Data"
		echo " "

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_older_than_2000.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_older_than_2000.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/modis_landuse_20class_15s_with_lakes.tar.gz
		LD_LIBRARY_PATH= tar -xvzf modis_landuse_20class_15s_with_lakes.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_alt_lsm.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_alt_lsm.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/nlcd2006_ll_9s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf nlcd2006_ll_9s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/updated_Iceland_LU.tar.gz
		LD_LIBRARY_PATH= tar -xvf updated_Iceland_LU.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/modis_landuse_20class_15s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf modis_landuse_20class_15s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG
	fi

fi

if [ "$macos_64bit_GNU" = "1" ] && [ "$WRFHYDRO_COUPLED_PICK" = "1" ] && [ "$MAC_CHIP" = "ARM" ]; then

	#############################basic package managment############################

	brew cleanup -s
	brew update
	outdated_packages=$(brew outdated --quiet)

	# List of packages to check/install
	packages=(
		"autoconf" "automake" "bison" "byacc" "cmake" "curl" "flex" "gcc"
		"gedit" "git" "gnu-sed" "ksh"
		"libtool" "libxml2" "m4" "make" "python@3.12" "tcsh" "wget"
		"xauth" "xorgproto" "xorgrgb" "xquartz"
	)

	for pkg in "${packages[@]}"; do
		if brew list "$pkg" &>/dev/null; then
			echo "$pkg is already installed."
			if [[ $outdated_packages == *"$pkg"* ]]; then
				echo "$pkg has a newer version available. Upgrading..."
				brew upgrade "$pkg"
			fi
		else
			echo "$pkg is not installed. Installing..."
			brew install "$pkg"
		fi
		sleep 1
	done

	export LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH
	export PATH=/usr/local/bin:$PATH

	##############################Directory Listing############################

	export HOME=$(
		cd
		pwd
	)
	mkdir $HOME/WRFHYDRO_COUPLED
	export WRF_FOLDER=$HOME/WRFHYDRO_COUPLED
	cd "${WRF_FOLDER}"/
	mkdir Downloads
	mkdir "${WRF_FOLDER}"/Hydro-Basecode
	mkdir Libs
	export DIR="${WRF_FOLDER}"/Libs
	mkdir Libs/grib2
	mkdir Libs/NETCDF
	mkdir Libs/MPICH
	mkdir -p Tests/Environment
	mkdir -p Tests/Compatibility

	echo " "

	#############################Core Management####################################
	export CPU_CORE=$(sysctl -n hw.ncpu) # number of available threads on system
	export CPU_6CORE="6"
	export CPU_QUARTER=$(($CPU_CORE / 4))
	#1/2 of availble cores on system
	export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))
	#Forces CPU cores to even number to avoid partial core export. ie 7 cores would be 3.5 cores.

	if [ $CPU_CORE -le $CPU_6CORE ]; then #If statement for low core systems.  Forces computers to only use 1 core if there are 4 cores or less on the system. then
		export CPU_QUARTER_EVEN="2"
	else
		export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))
	fi

	echo "##########################################"
	echo "Number of Threads being used $CPU_QUARTER_EVEN"
	echo "##########################################"
	echo " "

	##############################Downloading Libraries############################

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/madler/zlib/releases/download/v$Zlib_Version/zlib-$Zlib_Version.tar.gz
	wget -c https://github.com/HDFGroup/hdf5/releases/download/hdf5_$HDF5_Version/hdf5-$HDF5_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-c/archive/refs/tags/v$Netcdf_C_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-fortran/archive/refs/tags/v$Netcdf_Fortran_Version.tar.gz
	wget -c https://download.sourceforge.net/libpng/libpng-$Libpng_Version.tar.gz
	wget -c https://www.ece.uvic.ca/~frodo/jasper/software/jasper-$Jasper_Version.zip
	wget -c https://github.com/pmodels/mpich/releases/download/v$Mpich_Version/mpich-$Mpich_Version.tar.gz
	wget -c https://parallel-netcdf.github.io/Release/pnetcdf-$Pnetcdf_Version.tar.gz

	echo " "

	############################# Compilers #############################

	# Unlink any existing Homebrew compiler symlinks
	echo $PASSWD | sudo -S unlink /opt/homebrew/bin/gfortran
	echo $PASSWD | sudo -S unlink /opt/homebrew/bin/gcc
	echo $PASSWD | sudo -S unlink /opt/homebrew/bin/g++

	# Source the bashrc to ensure environment variables are loaded
	source ~/.bashrc

	# Check current versions of gcc, g++, and gfortran (these should show "command not found" if unlinked)
	gcc --version
	g++ --version
	gfortran --version

	# Navigate to the Homebrew binaries directory
	cd /opt/homebrew/bin

	# Find the latest version of GCC, G++, and GFortran
	latest_gcc=$(ls gcc-* 2>/dev/null | grep -o 'gcc-[0-9]*' | sort -V | tail -n 1)
	latest_gpp=$(ls g++-* 2>/dev/null | grep -o 'g++-[0-9]*' | sort -V | tail -n 1)
	latest_gfortran=$(ls gfortran-* 2>/dev/null | grep -o 'gfortran-[0-9]*' | sort -V | tail -n 1)

	# Check if the latest versions were found and link them
	echo "Linking the latest GCC version: $latest_gcc"
	echo $PASSWD | sudo -S ln -sf $latest_gcc gcc
	echo "Linking the latest G++ version: $latest_gpp"
	echo $PASSWD | sudo -S ln -sf $latest_gpp g++
	echo "Linking the latest GFortran version: $latest_gfortran"
	echo $PASSWD | sudo -S ln -sf $latest_gfortran gfortran

	# Return to the home directory
	cd

	# Source bashrc and bash_profile to reload the environment settings
	source ~/.bashrc
	source ~/.bash_profile

	# Check if the versions were successfully updated
	gcc --version
	g++ --version
	gfortran --version

	# Export compiler environment variables
	export CC=gcc
	export CXX=g++
	export FC=gfortran
	export F77=gfortran
	export CFLAGS="-fPIC -fPIE -Wno-implicit-function-declaration -Wno-incompatible-pointer-types -Wall"

	echo " "

	############################# End of Compiler Setup #############################

	#IF statement for GNU compiler issue
	export GCC_VERSION=$(/opt/homebrew/bin/$latest_gcc -dumpfullversion | awk '{print$1}')
	export GFORTRAN_VERSION=$(/opt/homebrew/bin/$latest_gfortran -dumpfullversion | awk '{print$1}')
	export GPLUSPLUS_VERSION=$(/opt/homebrew/bin/$latest_gpp -dumpfullversion | awk '{print$1}')

	export GCC_VERSION_MAJOR_VERSION=$(echo $GCC_VERSION | awk -F. '{print $1}')
	export GFORTRAN_VERSION_MAJOR_VERSION=$(echo $GFORTRAN_VERSION | awk -F. '{print $1}')
	export GPLUSPLUS_VERSION_MAJOR_VERSION=$(echo $GPLUSPLUS_VERSION | awk -F. '{print $1}')

	export version_10="10"

	if [ $GCC_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GFORTRAN_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GPLUSPLUS_VERSION_MAJOR_VERSION -ge $version_10 ]; then
		export fallow_argument=-fallow-argument-mismatch
		export boz_argument=-fallow-invalid-boz
	else
		export fallow_argument=
		export boz_argument=
	fi

	export FFLAGS="$fallow_argument -m64"
	export FCFLAGS="$fallow_argument -m64"

	echo "##########################################"
	echo "FFLAGS = $FFLAGS"
	echo "FCFLAGS = $FCFLAGS"
	echo "CFLAGS = $CFLAGS"
	echo "##########################################"

	echo " "

	############################# ZLib ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf zlib-$Zlib_Version.tar.gz
	cd zlib-$Zlib_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	export ZLIB_ROOT=$DIR/grib2
	export ZLIBLIB=$DIR/grib2/lib
	export ZLIBINC=$DIR/grib2/include

	echo " "
	############################## MPICH ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf mpich-$Mpich_Version.tar.gz
	cd mpich-$Mpich_Version/

	F90= ./configure --prefix=$DIR/MPICH --with-device=ch3 FFLAGS="$fallow_argument -m64" FCFLAGS="$fallow_argument -m64" 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/MPICH/bin:$PATH
	export MPIFC=$DIR/MPICH/bin/mpifort
	export MPIF77=$DIR/MPICH/bin/mpifort
	export MPIF90=$DIR/MPICH/bin/mpifort
	export MPICC=$DIR/MPICH/bin/mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx

	echo " "

	############################# libpng ############################

	cd "${WRF_FOLDER}"/Downloads

	# other libraries below need these variables to be set
	export LDFLAGS=-L$DIR/grib2/lib
	export CPPFLAGS=-I$DIR/grib2/include

	LD_LIBRARY_PATH= tar -xvzf libpng-$Libpng_Version.tar.gz
	cd libpng-$Libpng_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNG_ROOT=$DIR/grib2

	echo " "
	#############################JasPer ############################

	cd "${WRF_FOLDER}"/Downloads
	unzip jasper-$Jasper_Version.zip
	cd jasper-$Jasper_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	export JASPERLIB=$DIR/grib2/lib
	export JASPERINC=$DIR/grib2/include
	export JASPER_DIR=$DIR/grib2
	export Jasper_ROOT=$DIR/grib2/lib

	echo " "
	############################# hdf5 library for netcdf4 functionality ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf hdf5-$HDF5_Version.tar.gz
	cd hdf5-$HDF5_Version

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --with-zlib=$DIR/grib2 --enable-hl --enable-fortran --enable-parallel 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export HDF5=$DIR/grib2
	export PATH=$HDF5/bin:$PATH
	export PHDF5=$DIR/grib2
	export HDF5_ROOT=$DIR/grib2
	export PHDF5_ROOT=$DIR/grib2

	echo " "

	############################# Install Parallel-netCDF ##############################
	#Make file created with half of available cpu cores
	#Hard path for MPI added
	##################################################################################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf pnetcdf-$Pnetcdf_Version.tar.gz
	cd pnetcdf-$Pnetcdf_Version

	export MPIFC=$DIR/MPICH/bin/mpifort
	export MPIF77=$DIR/MPICH/bin/mpifort
	export MPIF90=$DIR/MPICH/bin/mpifort
	export MPICC=$DIR/MPICH/bin/mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx

	# drop --disable-utils (not recognized)
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS="-std=gnu99 $CFLAGS" FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --enable-static 2>&1 | tee configure.log

	# build only libraries
	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log

	# install only libraries and headers
	make install 2>&1 | tee make.install.log

	export PNETCDF=$DIR/grib2
	export PNETCDF_DIR=$DIR/grib2
	export PNETCDF_ROOT=$DIR/grib2

	echo " "

	read -r -t 3 -p

	############################## Install NETCDF C Library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_C_Version.tar.gz
	cd netcdf-c-$Netcdf_C_Version/
	export CPPFLAGS=-I$DIR/grib2/include
	export LDFLAGS="-L$DIR/grib2/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lhdf5_hl -lhdf5 -lz -lcurl -lgfortran -lgcc -lm -ldl -lpnetcdf"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --disable-dap --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-pnetcdf --enable-cdf5 --enable-parallel-tests --enable-logging 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/NETCDF/bin:$PATH
	export NETCDF=$DIR/NETCDF
	export NETCDF_INC=$DIR/NETCDF/include
	export NETCDF_LIB=$DIR/NETCDF/lib
	export NETCDF_ROOT=$DIR/NETCDF
	export LD_LIBRARY_PATH=$DIR/grib2/lib:$DIR/NETCDF/lib:$LD_LIBRARY_PATH

	echo " "

	############################## NetCDF fortran library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_Fortran_Version.tar.gz
	cd netcdf-fortran-$Netcdf_Fortran_Version/
	export LD_LIBRARY_PATH=$DIR/NETCDF/lib:$LD_LIBRARY_PATH
	export CPPFLAGS="-I$DIR/NETCDF/include -I$DIR/grib2/include"
	export LDFLAGS="-L$DIR/NETCDF/lib -L$DIR/grib2/lib -Wl,-rpath,$DIR/NETCDF/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lnetcdf -lpnetcdf -lcurl -lhdf5_hl -lhdf5 -lz -lm -ldl -lgcc -lgfortran"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-parallel-tests --enable-logging --enable-hdf5 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	echo " "
	#################################### System Environment Tests ##############
	mkdir -p "${WRF_FOLDER}"/Tests/Environment
	mkdir -p "${WRF_FOLDER}"/Tests/Compatibility

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_NETCDF_MPI_tests.tar
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_tests.tar

	LD_LIBRARY_PATH= tar -xvf Fortran_C_tests.tar -C "${WRF_FOLDER}"/Tests/Environment
	LD_LIBRARY_PATH= tar -xvf Fortran_C_NETCDF_MPI_tests.tar -C "${WRF_FOLDER}"/Tests/Compatibility
	export one="1"
	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Environment

	echo " "
	echo " "
	echo "Environment Testing "
	echo "Test 1"
	$FC TEST_1_fortran_only_fixed.f
	./a.out | tee env_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 1 Passed"
	else
		echo "Environment Compiler Test 1 Failed"
		exit
	fi
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 2"
	$FC TEST_2_fortran_only_free.f90
	./a.out | tee env_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 2 Passed"
	else
		echo "Environment Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 3"
	$CC TEST_3_c_only.c
	./a.out | tee env_test3.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test3.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 3 Passed"
	else
		echo "Environment Compiler Test 3 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 4"
	$CC -c -m64 TEST_4_fortran+c_c.c
	$FC -c -m64 TEST_4_fortran+c_f.f90
	$FC -m64 TEST_4_fortran+c_f.o TEST_4_fortran+c_c.o
	./a.out | tee env_test4.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test4.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 4 Passed"
	else
		echo "Environment Compiler Test 4 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Compatibility

	cp ${NETCDF}/include/netcdf.inc .

	echo " "
	echo " "
	echo "Library Compatibility Tests "
	echo "Test 1"
	$FC -c 01_fortran+c+netcdf_f.f
	$CC -c 01_fortran+c+netcdf_c.c
	$FC 01_fortran+c+netcdf_f.o 01_fortran+c+netcdf_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	./a.out | tee comp_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 1 Passed"
	else
		echo "Compatibility Compiler Test 1 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "

	echo "Test 2"
	$MPIFC -c 02_fortran+c+netcdf+mpi_f.f
	$MPICC -c 02_fortran+c+netcdf+mpi_c.c
	$MPIFC 02_fortran+c+netcdf+mpi_f.o \
		02_fortran+c+netcdf+mpi_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	$DIR/MPICH/bin/mpirun ./a.out | tee comp_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 2 Passed"
	else
		echo "Compatibility Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."
	echo " "

	echo " All tests completed and passed"
	echo " "

	################################OpenGrADS######################################
	#Verison 2.2.1 64bit of Linux
	#############################################################################
	if [[ $GRADS_PICK -eq 1 ]]; then
		cd "${WRF_FOLDER}"/Downloads
		wget -c https://sourceforge.net/projects/opengrads/files/grads2/2.2.1.oga.1/macOS/opengrads-2.2.1.oga.1-bundle-x86_64-apple-darwin20.5.0.pkg
		sudo -S installer -pkg opengrads-2.2.1.oga.1-bundle-x86_64-apple-darwin20.5.0.pkg -target /Applications/OpenGrads <<<"$PASSWD"
		export PATH="${WRF_FOLDER}"/GrADS/Contents:$PATH
	fi
	################################## GrADS ###############################
	# Version  2.2.1
	# Sublibs library instructions: http://cola.gmu.edu/grads/gadoc/supplibs2.html
	# GrADS instructions: http://cola.gmu.edu/grads/downloads.php
	########################################################################
	if [[ $GRADS_PICK -eq 2 ]]; then

		brew install grads

	fi

	##################################################################
	#Installing Miniconda3 to WRF directory and updating libraries
	##################################################################
	echo $PASSWD | sudo -S apt -y install python3-zstandard python3-zstd

	export Miniconda_Install_DIR="${WRF_FOLDER}"/miniconda3

	mkdir -p $Miniconda_Install_DIR

	wget -c https://repo.anaconda.com/miniconda/Miniconda3-latest-MacOSX-x86_64.sh -O $Miniconda_Install_DIR/miniconda.sh
	bash $Miniconda_Install_DIR/miniconda.sh -b -u -p $Miniconda_Install_DIR

	rm -rf $Miniconda_Install_DIR/miniconda.sh

	export PATH="${WRF_FOLDER}"/miniconda3/bin:$PATH

	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	$Miniconda_Install_DIR/bin/conda init bash

	conda tos accept
	conda config --add channels conda-forge
	conda config --set auto_activate_base false
	conda update -n root --all -y

	echo " "

	#Installing NCL via Conda
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	conda create -n ncl_stable -c conda-forge ncl -y
	conda activate ncl_stable

	conda deactivate
	conda deactivate
	conda deactivate
	echo " "

	##################### WRF Python           ##################
	########### WRf-Python compiled via Conda  ##################
	########### This is the preferred method by NCAR      ##################
	##### https://wrf-python.readthedocs.io/en/latest/installation.html  ##################
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh
	conda env create -f $HOME/WRF-MOSIT/wrf-python-stable.yml

	######################### Climate Data Operators ############
	######################### CDO compiled via Conda ###########
	####################### This is the preferred method #######
	################### https://bairdlangenbrunner.github.io/python-for-climate-scientists/conda/setting-up-conda-environments.html #######################

	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	conda create --name cdo_stable -y
	conda activate cdo_stable
	conda install -c conda-forge cdo -y
	conda update --all -y
	conda deactivate
	conda deactivate
	conda deactivate

	echo " "

	########################## WRF Hydro GIS PreProcessor ##############################
	#  Compiled with Conda
	#  https://github.com/NCAR/wrf_hydro_gis_preprocessor
	####################################################################################

	conda init bash
	conda activate base
	conda config --add channels conda-forge
	conda create -n wrfh_gis_env -c conda-forge python=3.12 gdal netCDF4 numpy pyproj whitebox=2.2.0 packaging shapely -y
	conda activate wrfh_gis_env
	conda update -n wrfh_gis_env --all -y
	conda deactivate
	conda deactivate
	conda deactivate

	cd "${WRF_FOLDER}"/
	git clone https://github.com/NCAR/wrf_hydro_gis_preprocessor.git "${WRF_FOLDER}"/WRF-Hydro-GIS-PreProcessor
	echo " "

	############################# WRF HYDRO V5.4.0 #################################
	# Version 5.3.0
	# Standalone mode
	################################################################################
	# Set up NETCDF environment variables
	export NETCDF_INC="$DIR/NETCDF/include"
	export NETCDF_LIB="$DIR/NETCDF/lib"

	# Create directories for Hydro Basecode and navigate to it
	mkdir -p "${WRF_FOLDER}/Hydro-Basecode"
	cd "${WRF_FOLDER}/Hydro-Basecode"

	# Clone the WRF-Hydro repository and set up the build
	git clone https://github.com/NCAR/wrf_hydro_nwm_public.git
	cd wrf_hydro_nwm_public
	mkdir -p build
	cd build

	# Run CMake configuration for WRF-Hydro with specified options
	cmake .. \
		-DSPATIAL_SOIL=1 \
		-DWRF_HYDRO=1 \
		-DWRFIO_NCD_LARGE_FILE_SUPPORT=1 \
		-DCMAKE_Fortran_COMPILER=/opt/homebrew/bin/$latest_gfortran \
		-DCMAKE_C_COMPILER=/opt/homebrew/bin/$latest_gcc \
		-DNETCDF_MODULES=$DIR/NETCDF/include

	# Compile using specified CPU settings
	make -j "$CPU_QUARTER_EVEN" 2>&1 | tee make.log

	# List of expected files (binary + symlinks)
	expected_files=("wrf_hydro" "wrf_hydro.exe" "wrf_hydro_NoahMP")

	# Count how many of them exist
	n=0
	for f in "${expected_files[@]}"; do
		[[ -e $f ]] && ((n++))
	done

	# Function to rerun compilation if files are missing
	rebuild_and_check() {
		echo "Missing one or more expected files. Running compiler again..."
		cd "${WRF_FOLDER}/Hydro-Basecode/wrf_hydro_nwm_public/build"
		make -j "$CPU_QUARTER_EVEN" 2>&1 | tee make2.log
		cd "${WRF_FOLDER}/Hydro-Basecode/wrf_hydro_nwm_public/build/Run"

		n=0
		for f in "${expected_files[@]}"; do
			[[ -e $f ]] && ((n++))
		done
	}

	# IF statement to check that all expected files were created
	if ((n == ${#expected_files[@]})); then
		echo "All expected files created."
	else
		rebuild_and_check
		if ((n != ${#expected_files[@]})); then
			echo "Missing one or more expected files. Exiting the script."
			read -r -p "Please contact script authors for assistance. Press 'Enter' to exit the script."
			exit 1
		else
			echo "All expected files created after re-compiling."
		fi
	fi

	# Finish the script with a pause
	read -r -t 5 -p "Finished installing WRF Hydro Basecode. Waiting for 5 seconds..."
	############################ WRF #################################
	## WRF v${WPS_VERSION}
	## Downloaded from git tagged releases
	# option 21, option 1 for gfortran and distributed memory w/basic nesting
	# large file support enable with WRFiO_NCD_LARGE_FILE_SUPPORT=1
	########################################################################

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/wrf-model/WRF/releases/download/v${WRF_VERSION}/v${WRF_VERSION}.tar.gz -O WRF-${WRF_VERSION}.tar.gz
	LD_LIBRARY_PATH= tar -xvzf WRF-${WRF_VERSION}.tar.gz -C "${WRF_FOLDER}"/

	# If statment for changing folder name
	# Check if WRF directory exists
	if [ -d "${WRF_FOLDER}/WRF" ]; then
		mv -f "${WRF_FOLDER}/WRF" "${WRF_FOLDER}/WRF-${WRF_VERSION}"

	# Else, check for any folder matching WRFV*
	else
		for dir in "${WRF_FOLDER}"/WRFV*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WRF-${WRF_VERSION}"
				break
			fi
		done
	fi

	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}
	export WRFIO_NCD_LARGE_FILE_SUPPORT=1

	#Replace old version of WRF-Hydro distributed with WRF with updated WRF-Hydro source code
	rm -r "${WRF_FOLDER}"/WRF-${WRF_VERSION}/hydro/
	cp -r "${WRF_FOLDER}"/Hydro-Basecode/wrf_hydro_nwm_public/src "${WRF_FOLDER}"/WRF-${WRF_VERSION}/hydro

	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/hydro/template

	sed -i '12s|=0|=1|g' setEnvar.sh
	sed -i '$ a\# Large file support\nexport WRFIO_NCD_LARGE_FILE_SUPPORT=1' setEnvar.sh

	source setEnvar.sh
	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}

	LD_LIBRARY_PATH= ./clean -a

	if [ ${auto_config} -eq 1 ]; then
		(echo 17 echo 1) | ./configure

	else
		./configure 2>&1 | tee configure.log #Option 17 gfortran compiler with distributed memory option 1 for basic nesting
	fi

	sed -i'' -e '145s/-c/-c -fPIC -fPIE -O3  -Wno-error=implicit-function-declaration/g' configure.wrf

	./compile em_real 2>&1 | tee compile.wrf.log

	export WRF_DIR="${WRF_FOLDER}"/WRF-${WRF_VERSION}

	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/main
	n=$(ls ./*.exe | wc -l)
	if (($n >= 3)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}
		LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN em_real 2>&1 | tee compile.wrf2.log
		cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/main
		n=$(ls ./*.exe | wc -l)
		if (($n >= 3)); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	echo " "
	############################WPS#####################################
	## WPS v${WPS_VERSION}
	## Downloaded from git tagged releases
	#Option 3 for gfortran and distributed memory
	########################################################################

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/wrf-model/WPS/archive/refs/tags/v${WPS_VERSION}.tar.gz -O WPS-${WPS_VERSION}.tar.gz
	LD_LIBRARY_PATH= tar -xvzf WPS-${WPS_VERSION}.tar.gz -C "${WRF_FOLDER}"/
	# Check if WPS directory exists
	if [ -d "${WRF_FOLDER}/WPS" ]; then
		mv -f "${WRF_FOLDER}/WPS" "${WRF_FOLDER}/WPS-${WPS_VERSION}"

	# Else, check for any folder matching WPSV* or WPS-*
	else
		for dir in "${WRF_FOLDER}"/WPSV* "${WRF_FOLDER}"/WPS-*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WPS-${WPS_VERSION}"
				break
			fi
		done
	fi
	cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
	LD_LIBRARY_PATH= ./clean -a

	if [ ${auto_config} -eq 1 ]; then
		echo 19 | ./configure 2>&1 | tee configure.log #Option 19 for gfortran and distributed memory
	else
		./configure 2>&1 | tee configure.log #Option 19 gfortran compiler with distributed memory
	fi
	LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.wps.log

	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
	n=$(ls ./*.exe | wc -l)
	if (($n == 3)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WPS. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.wps2.log
		cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
		n=$(ls ./*.exe | wc -l)
		if (($n == 3)); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WPS. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	echo " "

	######################## Static Geography Data inc/ Optional ####################
	# http://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html
	# These files are large so if you only need certain ones comment the others off
	# All files downloaded and untarred is 200GB
	# https://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html
	#################################################################################
	cd "${WRF_FOLDER}"/Downloads
	mkdir "${WRF_FOLDER}"/GEOG
	mkdir "${WRF_FOLDER}"/GEOG/WPS_GEOG

	echo " "
	echo "Mandatory WRF Preprocessing System (WPS) Geographical Input Data Mandatory Fields Downloads"
	echo " "
	wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_high_res_mandatory.tar.gz
	LD_LIBRARY_PATH= tar -xvzf geog_high_res_mandatory.tar.gz -C "${WRF_FOLDER}"/GEOG/

	wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_low_res_mandatory.tar.gz
	LD_LIBRARY_PATH= tar -xvzf geog_low_res_mandatory.tar.gz -C "${WRF_FOLDER}"/GEOG/
	mv "${WRF_FOLDER}"/GEOG/WPS_GEOG_LOW_RES/ "${WRF_FOLDER}"/GEOG/WPS_GEOG

	if [ ${WPS_Specific_Applications} -eq 1 ]; then
		echo " "
		echo " WPS Geographical Input Data Mandatory for Specific Applications"
		echo " "

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_thompson28_chem.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_thompson28_chem.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_noahmp.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_noahmp.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/irrigation.tar.gz
		LD_LIBRARY_PATH= tar -xvzf irrigation.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_px.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_px.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_urban.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_urban.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_ssib.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_ssib.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/lake_depth.tar.bz2
		LD_LIBRARY_PATH= tar -xvf lake_depth.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/topobath_30s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf topobath_30s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/gsl_gwd.tar.bz2
		LD_LIBRARY_PATH= tar -xvf gsl_gwd.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/cglc_modis_lcz_global.tar.gz
		LD_LIBRARY_PATH= tar -xvf cglc_modis_lcz_global.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG
	fi

	if [ ${Optional_GEOG} -eq 1 ]; then
		echo " "
		echo "Optional WPS Geographical Input Data"
		echo " "

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_older_than_2000.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_older_than_2000.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/modis_landuse_20class_15s_with_lakes.tar.gz
		LD_LIBRARY_PATH= tar -xvzf modis_landuse_20class_15s_with_lakes.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_alt_lsm.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_alt_lsm.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/nlcd2006_ll_9s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf nlcd2006_ll_9s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/updated_Iceland_LU.tar.gz
		LD_LIBRARY_PATH= tar -xvf updated_Iceland_LU.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/modis_landuse_20class_15s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf modis_landuse_20class_15s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG
	fi

fi

if [ "$RHL_64bit_GNU" = "1" ] && [ "$WRFHYDRO_COUPLED_PICK" = "1" ]; then

	#############################basic package managment############################
	echo $PASSWD | sudo -S yum install epel-release -y
	echo $PASSWD | sudo -S yum install dnf -y
	echo $PASSWD | sudo -S dnf install epel-release -y
	echo $PASSWD | sudo -S dnf install dnf -y
	echo $PASSWD | sudo -S dnf -y update
	echo $PASSWD | sudo -S dnf -y upgrade
	echo $PASSWD | sudo -S dnf -y install bzip2 bzip2-devel byacc cairo-devel cmake cpp curl curl-devel flex fontconfig-devel fontconfig-devel gcc gcc-c++ gcc-gfortran git java-11-openjdk java-11-openjdk-devel ksh libX11-devel libX11-devel libXaw libXaw-devel libXext-devel libXext-devel libXmu-devel libXrender-devel libXrender-devel libstdc++ libstdc++-devel libxml2 libxml2-devel m4 nfs-utils perl "perl(XML::LibXML)" pkgconfig pixman-devel python3 python3-devel tcsh time unzip wget
	echo $PASSWD | sudo -S dnf -y groupinstall "Development Tools"
	echo $PASSWD | sudo -S dnf -y update
	echo $PASSWD | sudo -S dnf -y upgrade

	echo " "

	echo " "
	##############################Directory Listing############################
	export HOME=$(
		cd
		pwd
	)

	mkdir $HOME/WRFHYDRO_COUPLED
	export WRF_FOLDER=$HOME/WRFHYDRO_COUPLED
	cd "${WRF_FOLDER}"/
	mkdir Downloads

	mkdir Libs
	export DIR="${WRF_FOLDER}"/Libs
	mkdir Libs/grib2
	mkdir Libs/NETCDF
	mkdir Libs/MPICH
	mkdir -p Tests/Environment
	mkdir -p Tests/Compatibility

	echo " "
	#############################Core Management####################################

	export CPU_CORE=$(nproc) # number of available threads on system
	export CPU_6CORE="6"
	export CPU_QUARTER=$(($CPU_CORE / 4))                          #quarter of availble cores on system
	export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2))) #Forces CPU cores to even number to avoid partial core export. ie 7 cores would be 3.5 cores.

	if [ $CPU_CORE -le $CPU_6CORE ]; then #If statement for low core systems.  Forces computers to only use 1 core if there are 4 cores or less on the system. then
		export CPU_QUARTER_EVEN="2"
	else
		export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))
	fi

	echo "##########################################"
	echo "Number of Threads being used $CPU_QUARTER_EVEN"
	echo "##########################################"

	echo " "
	##############################Downloading Libraries############################
	cd Downloads
	wget -c https://github.com/madler/zlib/releases/download/v$Zlib_Version/zlib-$Zlib_Version.tar.gz
	wget -c https://github.com/HDFGroup/hdf5/releases/download/hdf5_$HDF5_Version/hdf5-$HDF5_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-c/archive/refs/tags/v$Netcdf_C_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-fortran/archive/refs/tags/v$Netcdf_Fortran_Version.tar.gz
	wget -c https://github.com/pmodels/mpich/releases/download/v$Mpich_Version/mpich-$Mpich_Version.tar.gz
	wget -c https://download.sourceforge.net/libpng/libpng-$Libpng_Version.tar.gz
	wget -c https://www.ece.uvic.ca/~frodo/jasper/software/jasper-$Jasper_Version.zip
	wget -c https://parallel-netcdf.github.io/Release/pnetcdf-$Pnetcdf_Version.tar.gz

	echo " "
	####################################Compilers#####################################
	export CC=gcc
	export CXX=g++
	export FC=gfortran
	export F77=gfortran
	export CFLAGS="-fPIC -fPIE -O3"

	#IF statement for GNU compiler issue
	export GCC_VERSION=$(gcc -dumpfullversion | awk '{print$1}')
	export GFORTRAN_VERSION=$(gfortran -dumpfullversion | awk '{print$1}')
	export GPLUSPLUS_VERSION=$(g++ -dumpfullversion | awk '{print$1}')

	export GCC_VERSION_MAJOR_VERSION=$(echo $GCC_VERSION | awk -F. '{print $1}')
	export GFORTRAN_VERSION_MAJOR_VERSION=$(echo $GFORTRAN_VERSION | awk -F. '{print $1}')
	export GPLUSPLUS_VERSION_MAJOR_VERSION=$(echo $GPLUSPLUS_VERSION | awk -F. '{print $1}')

	export version_10="10"

	if [ $GCC_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GFORTRAN_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GPLUSPLUS_VERSION_MAJOR_VERSION -ge $version_10 ]; then
		export fallow_argument=-fallow-argument-mismatch
		export boz_argument=-fallow-invalid-boz
	else
		export fallow_argument=
		export boz_argument=
	fi

	export FFLAGS="$fallow_argument -m64"
	export FCFLAGS="$fallow_argument -m64"

	echo "##########################################"
	echo "FFLAGS = $FFLAGS"
	echo "FCFLAGS = $FCFLAGS"
	echo "CFLAGS = $CFLAGS"
	echo "##########################################"

	echo " "
	############################# ZLib ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf zlib-$Zlib_Version.tar.gz
	cd zlib-$Zlib_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	export ZLIB_ROOT=$DIR/grib2
	export ZLIBLIB=$DIR/grib2/lib
	export ZLIBINC=$DIR/grib2/include

	echo " "
	############################## MPICH ############################
	#F90= due to compiler issues with mpich install
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf mpich-$Mpich_Version.tar.gz
	cd mpich-$Mpich_Version/

	F90= ./configure --prefix=$DIR/MPICH --with-device=ch3 FFLAGS=$fallow_argument FCFLAGS=$fallow_argument 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/MPICH/bin:$PATH
	export MPIFC=$DIR/MPICH/bin/mpifort
	export MPIF77=$DIR/MPICH/bin/mpifort
	export MPIF90=$DIR/MPICH/bin/mpifort
	export MPICC=$DIR/MPICH/bin/mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx

	echo " "
	############################# libpng ############################

	cd "${WRF_FOLDER}"/Downloads

	# other libraries below need these variables to be set
	export LDFLAGS=-L$DIR/grib2/lib
	export CPPFLAGS=-I$DIR/grib2/include

	LD_LIBRARY_PATH= tar -xvzf libpng-$Libpng_Version.tar.gz
	cd libpng-$Libpng_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNG_ROOT=$DIR/grib2

	echo " "
	#############################JasPer ############################
	cd "${WRF_FOLDER}"/Downloads
	unzip jasper-$Jasper_Version.zip
	cd jasper-$Jasper_Version/

	./configure --prefix=$DIR/grib2
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export JASPERLIB=$DIR/grib2/lib
	export JASPERINC=$DIR/grib2/include
	export JASPER_DIR=$DIR/grib2
	export Jasper_ROOT=$DIR/grib2/lib

	echo " "
	############################# hdf5 library for netcdf4 functionality ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf hdf5-$HDF5_Version.tar.gz
	cd hdf5-$HDF5_Version

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --with-zlib=$DIR/grib2 --enable-hl --enable-fortran --enable-parallel 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export HDF5=$DIR/grib2
	export PATH=$HDF5/bin:$PATH
	export PHDF5=$DIR/grib2
	export HDF5_ROOT=$DIR/grib2
	export PHDF5_ROOT=$DIR/grib2

	echo " "
	############################# Install Parallel-netCDF ##############################
	#Make file created with half of available cpu cores
	#Hard path for MPI added
	##################################################################################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf pnetcdf-$Pnetcdf_Version.tar.gz
	cd pnetcdf-$Pnetcdf_Version
	export MPIFC=$DIR/MPICH/bin/mpifort
	export MPIF77=$DIR/MPICH/bin/mpifort
	export MPIF90=$DIR/MPICH/bin/mpifort
	export MPICC=$DIR/MPICH/bin/mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --enable-static 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNETCDF=$DIR/grib2
	export PNETCDF_DIR=$DIR/grib2
	export PNETCDF_ROOT=$DIR/grib2

	echo " "

	############################## Install NETCDF C Library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_C_Version.tar.gz
	cd netcdf-c-$Netcdf_C_Version/
	export CPPFLAGS=-I$DIR/grib2/include
	export LDFLAGS="-L$DIR/grib2/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lhdf5_hl -lhdf5 -lz -lcurl -lgfortran -lgcc -lm -ldl -lpnetcdf"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --disable-dap --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-pnetcdf --enable-cdf5 --enable-parallel-tests --enable-logging 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/NETCDF/bin:$PATH
	export NETCDF=$DIR/NETCDF
	export NETCDF_INC=$DIR/NETCDF/include
	export NETCDF_LIB=$DIR/NETCDF/lib
	export NETCDF_ROOT=$DIR/NETCDF
	export LD_LIBRARY_PATH=$DIR/grib2/lib:$DIR/NETCDF/lib:$LD_LIBRARY_PATH

	echo " "
	############################## NetCDF fortran library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_Fortran_Version.tar.gz
	cd netcdf-fortran-$Netcdf_Fortran_Version/
	export LD_LIBRARY_PATH=$DIR/NETCDF/lib:$LD_LIBRARY_PATH
	export CPPFLAGS="-I$DIR/NETCDF/include -I$DIR/grib2/include"
	export LDFLAGS="-L$DIR/NETCDF/lib -L$DIR/grib2/lib -Wl,-rpath,$DIR/NETCDF/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lnetcdf -lpnetcdf -lcurl -lhdf5_hl -lhdf5 -lz -lm -ldl -lgcc -lgfortran"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-parallel-tests --enable-logging --enable-hdf5 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	echo " "
	#################################### System Environment Tests ##############

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_NETCDF_MPI_tests.tar
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_tests.tar

	LD_LIBRARY_PATH= tar -xvf Fortran_C_tests.tar -C "${WRF_FOLDER}"/Tests/Environment
	LD_LIBRARY_PATH= tar -xvf Fortran_C_NETCDF_MPI_tests.tar -C "${WRF_FOLDER}"/Tests/Compatibility

	export one="1"
	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Environment

	cp ${NETCDF}/include/netcdf.inc .

	echo " "
	echo " "
	echo "Environment Testing "
	echo "Test 1"
	$FC TEST_1_fortran_only_fixed.f
	./a.out | tee env_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 1 Passed"
	else
		echo "Environment Compiler Test 1 Failed"
		exit
	fi
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 2"
	$FC TEST_2_fortran_only_free.f90
	./a.out | tee env_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 2 Passed"
	else
		echo "Environment Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 3"
	$CC TEST_3_c_only.c
	./a.out | tee env_test3.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test3.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 3 Passed"
	else
		echo "Environment Compiler Test 3 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 4"
	$CC -c -m64 TEST_4_fortran+c_c.c
	$FC -c -m64 TEST_4_fortran+c_f.f90
	$FC -m64 TEST_4_fortran+c_f.o TEST_4_fortran+c_c.o
	./a.out | tee env_test4.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test4.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 4 Passed"
	else
		echo "Environment Compiler Test 4 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Compatibility

	cp ${NETCDF}/include/netcdf.inc .

	echo " "
	echo " "
	echo "Library Compatibility Tests "
	echo "Test 1"
	$FC -c 01_fortran+c+netcdf_f.f
	$CC -c 01_fortran+c+netcdf_c.c
	$FC 01_fortran+c+netcdf_f.o 01_fortran+c+netcdf_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	./a.out | tee comp_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 1 Passed"
	else
		echo "Compatibility Compiler Test 1 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "

	echo "Test 2"
	$MPIFC -c 02_fortran+c+netcdf+mpi_f.f
	$MPICC -c 02_fortran+c+netcdf+mpi_c.c
	$MPIFC 02_fortran+c+netcdf+mpi_f.o \
		02_fortran+c+netcdf+mpi_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	$DIR/MPICH/bin/mpirun ./a.out | tee comp_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 2 Passed"
	else
		echo "Compatibility Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."
	echo " "

	echo " All tests completed and passed"
	echo " "

	################################ OpenGrADS ##################################
	#Verison 2.2.1 32bit of Linux
	#############################################################################
	if [[ $GRADS_PICK -eq 1 ]]; then
		cd "${WRF_FOLDER}"/Downloads
		LD_LIBRARY_PATH= tar -xvzf cd "${WRF_FOLDER}"/Downloads
		wget -c https://sourceforge.net/projects/opengrads/files/grads2/2.2.1.oga.1/Linux%20%2864%20Bits%29/opengrads-2.2.1.oga.1-bundle-x86_64-pc-linux-gnu-glibc_2.17.tar.gz
		LD_LIBRARY_PATH= tar -xvzf opengrads-2.2.1.oga.1-bundle-x86_64-pc-linux-gnu-glibc_2.17.tar.gz -C "${WRF_FOLDER}"/ -C "${WRF_FOLDER}"/
		cd "${WRF_FOLDER}"/
		mv "${WRF_FOLDER}"/opengrads-2.2.1.oga.1 "${WRF_FOLDER}"/GrADS
		cd GrADS/Contents
		wget -c https://github.com/regisgrundig/SIMOP/blob/master/g2ctl.pl
		chmod +x g2ctl.pl
		wget -c https://sourceforge.net/projects/opengrads/files/wgrib2/0.1.9.4/wgrib2-v0.1.9.4-bin-i686-glib2.5-linux-gnu.tar.gz
		LD_LIBRARY_PATH= tar -xvzf wgrib2-v0.1.9.4-bin-i686-glib2.5-linux-gnu.tar.gz
		cd wgrib2-v0.1.9.4/bin
		mv wgrib2 "${WRF_FOLDER}"/GrADS/Contents
		cd "${WRF_FOLDER}"/GrADS/Contents
		rm wgrib2-v0.1.9.4-bin-i686-glib2.5-linux-gnu.tar.gz
		rm -r wgrib2-v0.1.9.4

		export PATH="${WRF_FOLDER}"/GrADS/Contents:$PATH

		echo " "
	fi
	################################## GrADS ###############################
	# Version  2.2.1
	# Sublibs library instructions: http://cola.gmu.edu/grads/gadoc/supplibs2.html
	# GrADS instructions: http://cola.gmu.edu/grads/downloads.php
	########################################################################
	if [[ $GRADS_PICK -eq 2 ]]; then
		cd "${WRF_FOLDER}"/Downloads
		wget -c ftp://cola.gmu.edu/grads/2.2/grads-2.2.1-bin-RHL7.4-x86_64.tar.gz
		LD_LIBRARY_PATH= tar -xvzf grads-2.2.1-bin-RHL7.4-x86_64.tar.gz -C "${WRF_FOLDER}"
		cd "${WRF_FOLDER}"/grads-2.2.1/bin
		chmod 775 *

	fi

	echo " "
	##################### NCAR COMMAND LANGUAGE           ##################
	########### NCL compiled via Conda                    ##################
	########### This is the preferred method by NCAR      ##################
	########### https://www.ncl.ucar.edu/index.shtml      ##################

	#Installing Miniconda3 to WRF-Hydro directory and updating libraries
	echo $PASSWD | sudo -S apt -y install python3-zstandard python3-zstd

	export Miniconda_Install_DIR="${WRF_FOLDER}"/miniconda3

	mkdir -p $Miniconda_Install_DIR

	wget -c https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O $Miniconda_Install_DIR/miniconda.sh
	bash $Miniconda_Install_DIR/miniconda.sh -b -u -p $Miniconda_Install_DIR

	rm -rf $Miniconda_Install_DIR/miniconda.sh

	export PATH="${WRF_FOLDER}"/miniconda3/bin:$PATH

	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	$Miniconda_Install_DIR/bin/conda init bash

	conda tos accept
	conda config --add channels conda-forge
	conda config --set auto_activate_base false
	conda update -n root --all -y

	echo " "

	echo " "
	#Installing NCL via Conda
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	conda create -n ncl_stable -c conda-forge ncl -y
	conda activate ncl_stable

	conda deactivate
	conda deactivate
	conda deactivate

	echo " "

	############################OBSGRID###############################
	## OBSGRID
	## Downloaded from git tagged releases
	## Option #2
	########################################################################
	cd "${WRF_FOLDER}"/
	git clone https://github.com/wrf-model/OBSGRID.git
	cd "${WRF_FOLDER}"/OBSGRID

	LD_LIBRARY_PATH= ./clean -a
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh
	conda activate ncl_stable

	export HOME=$(
		cd
		pwd
	)
	export DIR="${WRF_FOLDER}"/Libs
	export NETCDF=$DIR/NETCDF

	if [ ${auto_config} -eq 1 ]; then
		echo 2 | ./configure 2>&1 | tee configure.log #Option 2 for gfortran/gcc and distribunted memory
	else
		./configure 2>&1 | tee configure.log #Option 2 for gfortran/gcc and distribunted memory
	fi

	sed -i '27s/-lnetcdf -lnetcdff/ -lnetcdff -lnetcdf/g' configure.oa

	sed -i '31s/-lncarg -lncarg_gks -lncarg_c -lX11 -lm -lcairo/-lncarg -lncarg_gks -lncarg_c -lX11 -lm -lcairo -lfontconfig -lpixman-1 -lfreetype -lhdf5 -lhdf5_hl /g' configure.oa

	sed -i '39s/-frecord-marker=4/-frecord-marker=4 ${fallow_argument} /g' configure.oa

	sed -i '44s/=	/=	${fallow_argument} /g' configure.oa

	sed -i '45s/-C -P -traditional/-P -traditional/g' configure.oa

	echo " "
	LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.obsgrid.log

	conda deactivate
	conda deactivate
	conda deactivate

	echo " "
	# IF statement to check that all files were created.
	if [[ -x ./obsgrid.exe ]]; then
		echo "obsgrid.exe found."
		read -r -t 5 -p "Finished installing OBSGRID. I am going to wait for 5 seconds only ..."
	else
		echo "obsgrid.exe is missing. Attempting to compile again..."

		LD_LIBRARY_PATH= ./clean -a
		LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.obsgrid.retry.log

		if [[ -x ./obsgrid.exe ]]; then
			echo "obsgrid.exe successfully created after recompilation."
			read -r -t 5 -p "Finished retrying OBSGRID compile. I am going to wait for 5 seconds only ..."
		else
			echo "Still missing obsgrid.exe after recompile. Exiting the script."
			read -r -p "Please contact script authors for assistance. Press 'Enter' to exit."
			exit 1
		fi
	fi

	echo " "

	##################### WRF Python           ##################
	########### WRf-Python compiled via Conda  ##################
	########### This is the preferred method by NCAR      ##################
	##### https://wrf-python.readthedocs.io/en/latest/installation.html  ##################
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh
	conda env create -f $HOME/WRF-MOSIT/wrf-python-stable.yml

	echo " "

	########################## WRF Hydro GIS PreProcessor ##############################
	#  Compiled with Conda
	#  https://github.com/NCAR/wrf_hydro_gis_preprocessor
	####################################################################################

	conda init bash
	conda activate base
	conda config --add channels conda-forge
	conda create -n wrfh_gis_env -c conda-forge python=3.12 gdal netCDF4 numpy pyproj whitebox=2.2.0 packaging shapely -y
	conda activate wrfh_gis_env
	conda update -n wrfh_gis_env --all -y
	conda deactivate
	conda deactivate
	conda deactivate
	cd "${WRF_FOLDER}"/
	git clone https://github.com/NCAR/wrf_hydro_gis_preprocessor.git "${WRF_FOLDER}"/WRF-Hydro-GIS-PreProcessor

	echo " "

	############################# WRF HYDRO V5.4.0 #################################
	# Version 5.3.0
	# Standalone mode
	################################################################################
	# Set up NETCDF environment variables
	export NETCDF_INC="$DIR/NETCDF/include"
	export NETCDF_LIB="$DIR/NETCDF/lib"

	# Create directories for Hydro Basecode and navigate to it
	mkdir -p "${WRF_FOLDER}/Hydro-Basecode"
	cd "${WRF_FOLDER}/Hydro-Basecode"

	# Clone the WRF-Hydro repository and set up the build
	git clone https://github.com/NCAR/wrf_hydro_nwm_public.git
	cd wrf_hydro_nwm_public
	mkdir -p build
	cd build

	# Run CMake configuration for WRF-Hydro with specified options
	cmake .. \
		-DSPATIAL_SOIL=1 \
		-DWRF_HYDRO=1 \
		-DWRFIO_NCD_LARGE_FILE_SUPPORT=1 \
		-DCMAKE_Fortran_COMPILER=gfortran

	# Compile using specified CPU settings
	make -j "$CPU_QUARTER_EVEN" 2>&1 | tee make.log

	# List of expected files (binary + symlinks)
	expected_files=("wrf_hydro" "wrf_hydro.exe" "wrf_hydro_NoahMP")

	# Count how many of them exist
	n=0
	for f in "${expected_files[@]}"; do
		[[ -e $f ]] && ((n++))
	done

	# Function to rerun compilation if files are missing
	rebuild_and_check() {
		echo "Missing one or more expected files. Running compiler again..."
		cd "${WRF_FOLDER}/Hydro-Basecode/wrf_hydro_nwm_public/build"
		make -j "$CPU_QUARTER_EVEN" 2>&1 | tee make2.log
		cd "${WRF_FOLDER}/Hydro-Basecode/wrf_hydro_nwm_public/build/Run"

		n=0
		for f in "${expected_files[@]}"; do
			[[ -e $f ]] && ((n++))
		done
	}

	# IF statement to check that all expected files were created
	if ((n == ${#expected_files[@]})); then
		echo "All expected files created."
	else
		rebuild_and_check
		if ((n != ${#expected_files[@]})); then
			echo "Missing one or more expected files. Exiting the script."
			read -r -p "Please contact script authors for assistance. Press 'Enter' to exit the script."
			exit 1
		else
			echo "All expected files created after re-compiling."
		fi
	fi

	# Finish the script with a pause
	read -r -t 5 -p "Finished installing WRF Hydro Basecode. Waiting for 5 seconds..."
	############################ WRF #################################
	## WRF v${WPS_VERSION}
	## Downloaded from git tagged releases
	# option 34, option 1 for gfortran and distributed memory w/basic nesting
	# large file support enable with WRFiO_NCD_LARGE_FILE_SUPPORT=1
	# In the namelist.input, the following settings support pNetCDF by setting value to 11:
	# io_form_boundary
	# io_form_history
	# io_form_auxinput2
	# io_form_auxhist2
	# Note that you need set nocolons = .true. in the section &time_control of namelist.input
	########################################################################
	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/wrf-model/WRF/releases/download/v${WRF_VERSION}/v${WRF_VERSION}.tar.gz -O WRF-${WRF_VERSION}.tar.gz
	LD_LIBRARY_PATH= tar -xvzf WRF-${WRF_VERSION}.tar.gz -C "${WRF_FOLDER}"/

	# If statment for changing folder name
	# Check if WRF directory exists
	if [ -d "${WRF_FOLDER}/WRF" ]; then
		mv -f "${WRF_FOLDER}/WRF" "${WRF_FOLDER}/WRF-${WRF_VERSION}"

	# Else, check for any folder matching WRFV*
	else
		for dir in "${WRF_FOLDER}"/WRFV*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WRF-${WRF_VERSION}"
				break
			fi
		done
	fi

	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}
	export WRFIO_NCD_LARGE_FILE_SUPPORT=1

	#Replace old version of WRF-Hydro distributed with WRF with updated WRF-Hydro source code
	rm -r "${WRF_FOLDER}"/WRF-${WRF_VERSION}/hydro/
	cp -r "${WRF_FOLDER}"/Hydro-Basecode/wrf_hydro_nwm_public/src "${WRF_FOLDER}"/WRF-${WRF_VERSION}/hydro

	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/hydro/template

	sed -i '12s|=0|=1|g' setEnvar.sh
	sed -i '$ a\# Large file support\nexport WRFIO_NCD_LARGE_FILE_SUPPORT=1' setEnvar.sh

	source setEnvar.sh
	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}

	LD_LIBRARY_PATH= ./clean -a

	if [ ${auto_config} -eq 1 ]; then
		(
			echo 34
			echo 1
		) | ./configure

	else
		./configure 2>&1 | tee configure.log #Option 34 gfortran compiler with distributed memory option 1 for basic nesting
	fi

	LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN em_real 2>&1 | tee compile.wrf1.log

	export WRF_DIR="${WRF_FOLDER}"/WRF-${WRF_VERSION}

	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/main
	n=$(ls ./*.exe | wc -l)
	if (($n >= 3)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}
		LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN em_real 2>&1 | tee compile.wrf2.log
		cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/main
		n=$(ls ./*.exe | wc -l)
		if (($n >= 3)); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	echo " "
	############################WPS#####################################
	## WPS v${WPS_VERSION}
	## Downloaded from git tagged releases
	#Option 3 for gfortran and distributed memory
	########################################################################

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/wrf-model/WPS/archive/refs/tags/v${WPS_VERSION}.tar.gz -O WPS-${WPS_VERSION}.tar.gz
	LD_LIBRARY_PATH= tar -xvzf WPS-${WPS_VERSION}.tar.gz -C "${WRF_FOLDER}"/
	# Check if WPS directory exists
	if [ -d "${WRF_FOLDER}/WPS" ]; then
		mv -f "${WRF_FOLDER}/WPS" "${WRF_FOLDER}/WPS-${WPS_VERSION}"

	# Else, check for any folder matching WPSV* or WPS-*
	else
		for dir in "${WRF_FOLDER}"/WPSV* "${WRF_FOLDER}"/WPS-*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WPS-${WPS_VERSION}"
				break
			fi
		done
	fi
	cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
	LD_LIBRARY_PATH= ./clean -a

	if [ ${auto_config} -eq 1 ]; then
		echo 3 | ./configure 2>&1 | tee configure.log #Option 3 for gfortran and distributed memory
	else
		./configure 2>&1 | tee configure.log #Option 3 gfortran compiler with distributed memory
	fi
	LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.wps.log

	echo " "
	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
	n=$(ls ./*.exe | wc -l)
	if (($n == 3)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WPS. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.wps2.log
		cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
		n=$(ls ./*.exe | wc -l)
		if (($n == 3)); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WPS. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	echo " "

	######################## Static Geography Data inc/ Optional ####################
	# http://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html
	# These files are large so if you only need certain ones comment the others off
	# All files downloaded and untarred is 200GB
	# https://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html
	#################################################################################
	cd "${WRF_FOLDER}"/Downloads
	mkdir "${WRF_FOLDER}"/GEOG
	mkdir "${WRF_FOLDER}"/GEOG/WPS_GEOG

	echo " "
	echo "Mandatory WRF Preprocessing System (WPS) Geographical Input Data Mandatory Fields Downloads"
	echo " "
	wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_high_res_mandatory.tar.gz
	LD_LIBRARY_PATH= tar -xvzf geog_high_res_mandatory.tar.gz -C "${WRF_FOLDER}"/GEOG/

	wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_low_res_mandatory.tar.gz
	LD_LIBRARY_PATH= tar -xvzf geog_low_res_mandatory.tar.gz -C "${WRF_FOLDER}"/GEOG/
	mv "${WRF_FOLDER}"/GEOG/WPS_GEOG_LOW_RES/ "${WRF_FOLDER}"/GEOG/WPS_GEOG

	if [ ${WPS_Specific_Applications} -eq 1 ]; then
		echo " "
		echo " WPS Geographical Input Data Mandatory for Specific Applications"
		echo " "

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_thompson28_chem.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_thompson28_chem.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_noahmp.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_noahmp.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/irrigation.tar.gz
		LD_LIBRARY_PATH= tar -xvzf irrigation.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG
		mkdir "${WRF_FOLDER}"/GEOG/WPS_GEOG/irrigation
		mv $WRFHYDRDO_FOLDER/GEOG/WPS_GEOG/fao "${WRF_FOLDER}"/GEOG/WPS_GEOG/irrigation

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_px.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_px.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_urban.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_urban.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_ssib.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_ssib.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/lake_depth.tar.bz2
		LD_LIBRARY_PATH= tar -xvf lake_depth.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/topobath_30s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf topobath_30s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/gsl_gwd.tar.bz2
		LD_LIBRARY_PATH= tar -xvf gsl_gwd.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/cglc_modis_lcz_global.tar.gz
		LD_LIBRARY_PATH= tar -xvf cglc_modis_lcz_global.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG
	fi

	if [ ${Optional_GEOG} -eq 1 ]; then
		echo " "
		echo "Optional WPS Geographical Input Data"
		echo " "

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_older_than_2000.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_older_than_2000.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/modis_landuse_20class_15s_with_lakes.tar.gz
		LD_LIBRARY_PATH= tar -xvzf modis_landuse_20class_15s_with_lakes.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_alt_lsm.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_alt_lsm.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/nlcd2006_ll_9s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf nlcd2006_ll_9s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/updated_Iceland_LU.tar.gz
		LD_LIBRARY_PATH= tar -xvf updated_Iceland_LU.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/modis_landuse_20class_15s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf modis_landuse_20class_15s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG
	fi
fi

if [ "$RHL_64bit_GNU" = "2" ] && [ "$WRFHYDRO_COUPLED_PICK" = "1" ]; then

	#############################basic package managment############################
	#############################basic package managment############################
	echo "old version of GNU detected"
	echo $PASSWD | sudo -S yum install RHL-release-scl -y
	echo $PASSWD | sudo -S yum clean all
	echo $PASSWD | sudo -S yum remove devtoolset-11*
	echo $PASSWD | sudo -S yum install devtoolset-11
	echo $PASSWD | sudo -S yum install devtoolset-11-\* -y
	source /opt/rh/devtoolset-11/enable
	gcc --version
	echo $PASSWD | sudo -S yum install epel-release -y
	echo $PASSWD | sudo -S yum install dnf -y
	echo $PASSWD | sudo -S dnf install epel-release -y
	echo $PASSWD | sudo -S dnf install dnf -y
	echo $PASSWD | sudo -S dnf -y update
	echo $PASSWD | sudo -S dnf -y upgrade
	echo $PASSWD | sudo -S dnf -y install bzip2 bzip2-devel byacc cairo-devel cmake cpp curl curl-devel flex fontconfig-devel fontconfig-devel gcc gcc-c++ gcc-gfortran git java-11-openjdk java-11-openjdk-devel ksh libX11-devel libX11-devel libXaw libXaw-devel libXext-devel libXext-devel libXmu-devel libXrender-devel libXrender-devel libstdc++ libstdc++-devel libxml2 libxml2-devel m4 nfs-utils perl "perl(XML::LibXML)" pkgconfig pixman-devel python3 python3-devel tcsh time unzip wget
	echo $PASSWD | sudo -S dnf -y groupinstall "Development Tools"
	echo $PASSWD | sudo -S dnf -y update
	echo $PASSWD | sudo -S dnf -y upgrade

	echo " "
	##############################Directory Listing############################
	export HOME=$(
		cd
		pwd
	)

	mkdir $HOME/WRFHYDRO_COUPLED
	export WRF_FOLDER=$HOME/WRFHYDRO_COUPLED
	cd "${WRF_FOLDER}"/
	mkdir Downloads

	mkdir Libs
	export DIR="${WRF_FOLDER}"/Libs
	mkdir Libs/grib2
	mkdir Libs/NETCDF
	mkdir Libs/MPICH
	mkdir -p Tests/Environment
	mkdir -p Tests/Compatibility

	echo " "
	#############################Core Management####################################

	export CPU_CORE=$(nproc) # number of available threads on system
	export CPU_6CORE="6"
	export CPU_QUARTER=$(($CPU_CORE / 4))                          #quarter of availble cores on system
	export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2))) #Forces CPU cores to even number to avoid partial core export. ie 7 cores would be 3.5 cores.

	if [ $CPU_CORE -le $CPU_6CORE ]; then #If statement for low core systems.  Forces computers to only use 1 core if there are 4 cores or less on the system. then
		export CPU_QUARTER_EVEN="2"
	else
		export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))
	fi

	echo "##########################################"
	echo "Number of Threads being used $CPU_QUARTER_EVEN"
	echo "##########################################"

	echo " "
	##############################Downloading Libraries############################
	cd Downloads
	wget -c https://github.com/madler/zlib/releases/download/v$Zlib_Version/zlib-$Zlib_Version.tar.gz
	wget -c https://github.com/HDFGroup/hdf5/releases/download/hdf5_$HDF5_Version/hdf5-$HDF5_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-c/archive/refs/tags/v$Netcdf_C_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-fortran/archive/refs/tags/v$Netcdf_Fortran_Version.tar.gz
	wget -c https://github.com/pmodels/mpich/releases/download/v$Mpich_Version/mpich-$Mpich_Version.tar.gz
	wget -c https://download.sourceforge.net/libpng/libpng-$Libpng_Version.tar.gz
	wget -c https://www.ece.uvic.ca/~frodo/jasper/software/jasper-$Jasper_Version.zip
	wget -c https://parallel-netcdf.github.io/Release/pnetcdf-$Pnetcdf_Version.tar.gz

	echo " "
	####################################Compilers#####################################
	export CC=gcc
	export CXX=g++
	export FC=gfortran
	export F77=gfortran
	export CFLAGS="-fPIC -fPIE -O3"

	#IF statement for GNU compiler issue
	export GCC_VERSION=$(gcc -dumpfullversion | awk '{print$1}')
	export GFORTRAN_VERSION=$(gfortran -dumpfullversion | awk '{print$1}')
	export GPLUSPLUS_VERSION=$(g++ -dumpfullversion | awk '{print$1}')

	export GCC_VERSION_MAJOR_VERSION=$(echo $GCC_VERSION | awk -F. '{print $1}')
	export GFORTRAN_VERSION_MAJOR_VERSION=$(echo $GFORTRAN_VERSION | awk -F. '{print $1}')
	export GPLUSPLUS_VERSION_MAJOR_VERSION=$(echo $GPLUSPLUS_VERSION | awk -F. '{print $1}')

	export version_10="10"

	if [ $GCC_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GFORTRAN_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GPLUSPLUS_VERSION_MAJOR_VERSION -ge $version_10 ]; then
		export fallow_argument=-fallow-argument-mismatch
		export boz_argument=-fallow-invalid-boz
	else
		export fallow_argument=
		export boz_argument=
	fi

	export FFLAGS="$fallow_argument -m64"
	export FCFLAGS="$fallow_argument -m64"

	echo "##########################################"
	echo "FFLAGS = $FFLAGS"
	echo "FCFLAGS = $FCFLAGS"
	echo "CFLAGS = $CFLAGS"
	echo "##########################################"

	echo " "
	############################# ZLib ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf zlib-$Zlib_Version.tar.gz
	cd zlib-$Zlib_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	export ZLIB_ROOT=$DIR/grib2
	export ZLIBLIB=$DIR/grib2/lib
	export ZLIBINC=$DIR/grib2/include

	echo " "
	############################## MPICH ############################
	#F90= due to compiler issues with mpich install
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf mpich-$Mpich_Version.tar.gz
	cd mpich-$Mpich_Version/

	F90= ./configure --prefix=$DIR/MPICH --with-device=ch3 FFLAGS=$fallow_argument FCFLAGS=$fallow_argument 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/MPICH/bin:$PATH
	export MPIFC=$DIR/MPICH/bin/mpifort
	export MPIF77=$DIR/MPICH/bin/mpifort
	export MPIF90=$DIR/MPICH/bin/mpifort
	export MPICC=$DIR/MPICH/bin/mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx

	echo " "
	############################# libpng ############################

	cd "${WRF_FOLDER}"/Downloads

	# other libraries below need these variables to be set
	export LDFLAGS=-L$DIR/grib2/lib
	export CPPFLAGS=-I$DIR/grib2/include

	LD_LIBRARY_PATH= tar -xvzf libpng-$Libpng_Version.tar.gz
	cd libpng-$Libpng_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNG_ROOT=$DIR/grib2

	echo " "
	#############################JasPer ############################
	cd "${WRF_FOLDER}"/Downloads
	unzip jasper-$Jasper_Version.zip
	cd jasper-$Jasper_Version/

	./configure --prefix=$DIR/grib2
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export JASPERLIB=$DIR/grib2/lib
	export JASPERINC=$DIR/grib2/include
	export JASPER_DIR=$DIR/grib2
	export Jasper_ROOT=$DIR/grib2/lib

	echo " "
	############################# hdf5 library for netcdf4 functionality ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf hdf5-$HDF5_Version.tar.gz
	cd hdf5-$HDF5_Version
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --with-zlib=$DIR/grib2 --enable-hl --enable-fortran --enable-parallel 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export HDF5=$DIR/grib2
	export PATH=$HDF5/bin:$PATH
	export PHDF5=$DIR/grib2
	export HDF5_ROOT=$DIR/grib2
	export PHDF5_ROOT=$DIR/grib2

	echo " "
	############################# Install Parallel-netCDF ##############################
	#Make file created with half of available cpu cores
	#Hard path for MPI added
	##################################################################################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf pnetcdf-$Pnetcdf_Version.tar.gz
	cd pnetcdf-$Pnetcdf_Version
	export MPIFC=$DIR/MPICH/bin/mpifort
	export MPIF77=$DIR/MPICH/bin/mpifort
	export MPIF90=$DIR/MPICH/bin/mpifort
	export MPICC=$DIR/MPICH/bin/mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --enable-static 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNETCDF=$DIR/grib2
	export PNETCDF_DIR=$DIR/grib2
	export PNETCDF_ROOT=$DIR/grib2

	echo " "

	############################## Install NETCDF C Library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_C_Version.tar.gz
	cd netcdf-c-$Netcdf_C_Version/
	export CPPFLAGS=-I$DIR/grib2/include
	export LDFLAGS="-L$DIR/grib2/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lhdf5_hl -lhdf5 -lz -lcurl -lgfortran -lgcc -lm -ldl -lpnetcdf"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --disable-dap --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-pnetcdf --enable-cdf5 --enable-parallel-tests --enable-logging 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/NETCDF/bin:$PATH
	export NETCDF=$DIR/NETCDF
	export NETCDF_INC=$DIR/NETCDF/include
	export NETCDF_LIB=$DIR/NETCDF/lib
	export NETCDF_ROOT=$DIR/NETCDF
	export LD_LIBRARY_PATH=$DIR/grib2/lib:$DIR/NETCDF/lib:$LD_LIBRARY_PATH

	echo " "
	############################## NetCDF fortran library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_Fortran_Version.tar.gz
	cd netcdf-fortran-$Netcdf_Fortran_Version/
	export LD_LIBRARY_PATH=$DIR/NETCDF/lib:$LD_LIBRARY_PATH
	export CPPFLAGS="-I$DIR/NETCDF/include -I$DIR/grib2/include"
	export LDFLAGS="-L$DIR/NETCDF/lib -L$DIR/grib2/lib -Wl,-rpath,$DIR/NETCDF/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lnetcdf -lpnetcdf -lcurl -lhdf5_hl -lhdf5 -lz -lm -ldl -lgcc -lgfortran"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-parallel-tests --enable-logging --enable-hdf5 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	echo " "
	#################################### System Environment Tests ##############

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_NETCDF_MPI_tests.tar
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_tests.tar

	LD_LIBRARY_PATH= tar -xvf Fortran_C_tests.tar -C "${WRF_FOLDER}"/Tests/Environment
	LD_LIBRARY_PATH= tar -xvf Fortran_C_NETCDF_MPI_tests.tar -C "${WRF_FOLDER}"/Tests/Compatibility

	export one="1"
	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Environment

	cp ${NETCDF}/include/netcdf.inc .

	echo " "
	echo " "
	echo "Environment Testing "
	echo "Test 1"
	$FC TEST_1_fortran_only_fixed.f
	./a.out | tee env_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 1 Passed"
	else
		echo "Environment Compiler Test 1 Failed"
		exit
	fi
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 2"
	$FC TEST_2_fortran_only_free.f90
	./a.out | tee env_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 2 Passed"
	else
		echo "Environment Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 3"
	$CC TEST_3_c_only.c
	./a.out | tee env_test3.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test3.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 3 Passed"
	else
		echo "Environment Compiler Test 3 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 4"
	$CC -c -m64 TEST_4_fortran+c_c.c
	$FC -c -m64 TEST_4_fortran+c_f.f90
	$FC -m64 TEST_4_fortran+c_f.o TEST_4_fortran+c_c.o
	./a.out | tee env_test4.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test4.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 4 Passed"
	else
		echo "Environment Compiler Test 4 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Compatibility

	cp ${NETCDF}/include/netcdf.inc .

	echo " "
	echo " "
	echo "Library Compatibility Tests "
	echo "Test 1"
	$FC -c 01_fortran+c+netcdf_f.f
	$CC -c 01_fortran+c+netcdf_c.c
	$FC 01_fortran+c+netcdf_f.o 01_fortran+c+netcdf_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	./a.out | tee comp_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 1 Passed"
	else
		echo "Compatibility Compiler Test 1 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "

	echo "Test 2"
	$MPIFC -c 02_fortran+c+netcdf+mpi_f.f
	$MPICC -c 02_fortran+c+netcdf+mpi_c.c
	$MPIFC 02_fortran+c+netcdf+mpi_f.o \
		02_fortran+c+netcdf+mpi_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	$DIR/MPICH/bin/mpirun ./a.out | tee comp_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 2 Passed"
	else
		echo "Compatibility Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."
	echo " "

	echo " All tests completed and passed"
	echo " "

	################################ OpenGrADS ##################################
	#Verison 2.2.1 32bit of Linux
	#############################################################################
	if [[ $GRADS_PICK -eq 1 ]]; then
		cd "${WRF_FOLDER}"/Downloads
		LD_LIBRARY_PATH= tar -xvzf cd "${WRF_FOLDER}"/Downloads
		wget -c https://sourceforge.net/projects/opengrads/files/grads2/2.2.1.oga.1/Linux%20%2864%20Bits%29/opengrads-2.2.1.oga.1-bundle-x86_64-pc-linux-gnu-glibc_2.17.tar.gz
		LD_LIBRARY_PATH= tar -xvzf opengrads-2.2.1.oga.1-bundle-x86_64-pc-linux-gnu-glibc_2.17.tar.gz -C "${WRF_FOLDER}"/ -C "${WRF_FOLDER}"/
		cd "${WRF_FOLDER}"/
		mv "${WRF_FOLDER}"/opengrads-2.2.1.oga.1 "${WRF_FOLDER}"/GrADS
		cd GrADS/Contents
		wget -c https://github.com/regisgrundig/SIMOP/blob/master/g2ctl.pl
		chmod +x g2ctl.pl
		wget -c https://sourceforge.net/projects/opengrads/files/wgrib2/0.1.9.4/wgrib2-v0.1.9.4-bin-i686-glib2.5-linux-gnu.tar.gz
		LD_LIBRARY_PATH= tar -xvzf wgrib2-v0.1.9.4-bin-i686-glib2.5-linux-gnu.tar.gz
		cd wgrib2-v0.1.9.4/bin
		mv wgrib2 "${WRF_FOLDER}"/GrADS/Contents
		cd "${WRF_FOLDER}"/GrADS/Contents
		rm wgrib2-v0.1.9.4-bin-i686-glib2.5-linux-gnu.tar.gz
		rm -r wgrib2-v0.1.9.4

		export PATH="${WRF_FOLDER}"/GrADS/Contents:$PATH

		echo " "
	fi
	################################## GrADS ###############################
	# Version  2.2.1
	# Sublibs library instructions: http://cola.gmu.edu/grads/gadoc/supplibs2.html
	# GrADS instructions: http://cola.gmu.edu/grads/downloads.php
	########################################################################
	if [[ $GRADS_PICK -eq 2 ]]; then
		cd "${WRF_FOLDER}"/Downloads
		wget -c ftp://cola.gmu.edu/grads/2.2/grads-2.2.1-bin-RHL7.4-x86_64.tar.gz
		LD_LIBRARY_PATH= tar -xvzf grads-2.2.1-bin-RHL7.4-x86_64.tar.gz -C "${WRF_FOLDER}"
		cd "${WRF_FOLDER}"/grads-2.2.1/bin
		chmod 775 *

	fi

	echo " "
	##################### NCAR COMMAND LANGUAGE           ##################
	########### NCL compiled via Conda                    ##################
	########### This is the preferred method by NCAR      ##################
	########### https://www.ncl.ucar.edu/index.shtml      ##################

	#Installing Miniconda3 to WRF-Hydro directory and updating libraries
	echo $PASSWD | sudo -S apt -y install python3-zstandard python3-zstd

	export Miniconda_Install_DIR="${WRF_FOLDER}"/miniconda3

	mkdir -p $Miniconda_Install_DIR

	wget -c https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O $Miniconda_Install_DIR/miniconda.sh
	bash $Miniconda_Install_DIR/miniconda.sh -b -u -p $Miniconda_Install_DIR

	rm -rf $Miniconda_Install_DIR/miniconda.sh

	export PATH="${WRF_FOLDER}"/miniconda3/bin:$PATH

	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	$Miniconda_Install_DIR/bin/conda init bash

	conda tos accept
	conda config --add channels conda-forge
	conda config --set auto_activate_base false
	conda update -n root --all -y

	echo " "

	echo " "
	#Installing NCL via Conda
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	conda create -n ncl_stable -c conda-forge ncl -y
	conda activate ncl_stable

	conda deactivate
	conda deactivate
	conda deactivate

	echo " "

	##################### WRF Python           ##################
	########### WRf-Python compiled via Conda  ##################
	########### This is the preferred method by NCAR      ##################
	##### https://wrf-python.readthedocs.io/en/latest/installation.html  ##################
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh
	conda env create -f $HOME/WRF-MOSIT/wrf-python-stable.yml
	echo " "

	########################## WRF Hydro GIS PreProcessor ##############################
	#  Compiled with Conda
	#  https://github.com/NCAR/wrf_hydro_gis_preprocessor
	####################################################################################

	conda init bash
	conda activate base
	conda config --add channels conda-forge
	conda create -n wrfh_gis_env -c conda-forge python=3.12 gdal netCDF4 numpy pyproj whitebox=2.2.0 packaging shapely -y
	conda activate wrfh_gis_env
	conda update -n wrfh_gis_env --all -y
	conda deactivate
	conda deactivate
	conda deactivate
	cd "${WRF_FOLDER}"/
	git clone https://github.com/NCAR/wrf_hydro_gis_preprocessor.git "${WRF_FOLDER}"/WRF-Hydro-GIS-PreProcessor

	echo " "

	#reexporting compilers after conda installed to fix conda leak
	export CC=gcc
	export CXX=g++
	export FC=gfortran
	export F77=gfortran
	export CFLAGS="-fPIC -fPIE -O3"
	export MPIFC=$DIR/MPICH/bin/mpifort
	export MPIF77=$DIR/MPICH/bin/mpifort
	export MPIF90=$DIR/MPICH/bin/mpifort
	export MPICC=$DIR/MPICH/bin/mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx

	############################# WRF HYDRO V5.4.0 #################################
	# Version 5.3.0
	# Standalone mode
	################################################################################
	# Set up NETCDF environment variables
	export NETCDF_INC="$DIR/NETCDF/include"
	export NETCDF_LIB="$DIR/NETCDF/lib"

	# Create directories for Hydro Basecode and navigate to it
	mkdir -p "${WRF_FOLDER}/Hydro-Basecode"
	cd "${WRF_FOLDER}/Hydro-Basecode"

	# Clone the WRF-Hydro repository and set up the build
	git clone https://github.com/NCAR/wrf_hydro_nwm_public.git
	cd wrf_hydro_nwm_public
	mkdir -p build
	cd build

	# Run CMake configuration for WRF-Hydro with specified options
	cmake .. \
		-DSPATIAL_SOIL=1 \
		-DWRF_HYDRO=1 \
		-DWRFIO_NCD_LARGE_FILE_SUPPORT=1 \
		-DCMAKE_Fortran_COMPILER=gfortran

	# Compile using specified CPU settings
	make -j "$CPU_QUARTER_EVEN" 2>&1 | tee make.log

	# List of expected files (binary + symlinks)
	expected_files=("wrf_hydro" "wrf_hydro.exe" "wrf_hydro_NoahMP")

	# Count how many of them exist
	n=0
	for f in "${expected_files[@]}"; do
		[[ -e $f ]] && ((n++))
	done

	# Function to rerun compilation if files are missing
	rebuild_and_check() {
		echo "Missing one or more expected files. Running compiler again..."
		cd "${WRF_FOLDER}/Hydro-Basecode/wrf_hydro_nwm_public/build"
		make -j "$CPU_QUARTER_EVEN" 2>&1 | tee make2.log
		cd "${WRF_FOLDER}/Hydro-Basecode/wrf_hydro_nwm_public/build/Run"

		n=0
		for f in "${expected_files[@]}"; do
			[[ -e $f ]] && ((n++))
		done
	}

	# IF statement to check that all expected files were created
	if ((n == ${#expected_files[@]})); then
		echo "All expected files created."
	else
		rebuild_and_check
		if ((n != ${#expected_files[@]})); then
			echo "Missing one or more expected files. Exiting the script."
			read -r -p "Please contact script authors for assistance. Press 'Enter' to exit the script."
			exit 1
		else
			echo "All expected files created after re-compiling."
		fi
	fi

	# Finish the script with a pause
	read -r -t 5 -p "Finished installing WRF Hydro Basecode. Waiting for 5 seconds..."
	############################ WRF #################################
	## WRF v${WPS_VERSION}
	## Downloaded from git tagged releases
	# option 34, option 1 for gfortran and distributed memory w/basic nesting
	# large file support enable with WRFiO_NCD_LARGE_FILE_SUPPORT=1
	# In the namelist.input, the following settings support pNetCDF by setting value to 11:
	# io_form_boundary
	# io_form_history
	# io_form_auxinput2
	# io_form_auxhist2
	# Note that you need set nocolons = .true. in the section &time_control of namelist.input
	########################################################################
	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/wrf-model/WRF/releases/download/v${WRF_VERSION}/v${WRF_VERSION}.tar.gz -O WRF-${WRF_VERSION}.tar.gz
	LD_LIBRARY_PATH= tar -xvzf WRF-${WRF_VERSION}.tar.gz -C "${WRF_FOLDER}"/

	# If statment for changing folder name
	# Check if WRF directory exists
	if [ -d "${WRF_FOLDER}/WRF" ]; then
		mv -f "${WRF_FOLDER}/WRF" "${WRF_FOLDER}/WRF-${WRF_VERSION}"

	# Else, check for any folder matching WRFV*
	else
		for dir in "${WRF_FOLDER}"/WRFV*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WRF-${WRF_VERSION}"
				break
			fi
		done
	fi

	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}
	export WRFIO_NCD_LARGE_FILE_SUPPORT=1

	#Replace old version of WRF-Hydro distributed with WRF with updated WRF-Hydro source code
	rm -r "${WRF_FOLDER}"/WRF-${WRF_VERSION}/hydro/
	cp -r "${WRF_FOLDER}"/Hydro-Basecode/wrf_hydro_nwm_public/src "${WRF_FOLDER}"/WRF-${WRF_VERSION}/hydro

	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/hydro/template

	sed -i '12s|=0|=1|g' setEnvar.sh
	sed -i '$ a\# Large file support\nexport WRFIO_NCD_LARGE_FILE_SUPPORT=1' setEnvar.sh

	source setEnvar.sh
	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}

	LD_LIBRARY_PATH= ./clean -a

	if [ ${auto_config} -eq 1 ]; then
		(
			echo 34
			echo 1
		) | ./configure

	else
		./configure 2>&1 | tee configure.log #Option 34 gfortran compiler with distributed memory option 1 for basic nesting
	fi

	LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN em_real 2>&1 | tee compile.wrf1.log

	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/main
	n=$(ls ./*.exe | wc -l)
	if (($n >= 3)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}
		LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN em_real 2>&1 | tee compile.wrf2.log
		cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/main
		n=$(ls ./*.exe | wc -l)
		if (($n >= 3)); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	echo " "
	############################WPS#####################################
	## WPS v${WPS_VERSION}
	## Downloaded from git tagged releases
	#Option 3 for gfortran and distributed memory
	########################################################################

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/wrf-model/WPS/archive/refs/tags/v${WPS_VERSION}.tar.gz -O WPS-${WPS_VERSION}.tar.gz
	LD_LIBRARY_PATH= tar -xvzf WPS-${WPS_VERSION}.tar.gz -C "${WRF_FOLDER}"/
	# Check if WPS directory exists
	if [ -d "${WRF_FOLDER}/WPS" ]; then
		mv -f "${WRF_FOLDER}/WPS" "${WRF_FOLDER}/WPS-${WPS_VERSION}"

	# Else, check for any folder matching WPSV* or WPS-*
	else
		for dir in "${WRF_FOLDER}"/WPSV* "${WRF_FOLDER}"/WPS-*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WPS-${WPS_VERSION}"
				break
			fi
		done
	fi
	cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
	LD_LIBRARY_PATH= ./clean -a

	if [ ${auto_config} -eq 1 ]; then
		echo 3 | ./configure 2>&1 | tee configure.log #Option 3 for gfortran and distributed memory
	else
		./configure 2>&1 | tee configure.log #Option 3 gfortran compiler with distributed memory
	fi
	LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.wps.log

	echo " "
	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
	n=$(ls ./*.exe | wc -l)
	if (($n == 3)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WPS. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.wps2.log
		cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
		n=$(ls ./*.exe | wc -l)
		if (($n == 3)); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WPS. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	echo " "

	######################## Static Geography Data inc/ Optional ####################
	# http://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html
	# These files are large so if you only need certain ones comment the others off
	# All files downloaded and untarred is 200GB
	# https://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html
	#################################################################################
	cd "${WRF_FOLDER}"/Downloads
	mkdir "${WRF_FOLDER}"/GEOG
	mkdir "${WRF_FOLDER}"/GEOG/WPS_GEOG

	echo " "
	echo "Mandatory WRF Preprocessing System (WPS) Geographical Input Data Mandatory Fields Downloads"
	echo " "
	wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_high_res_mandatory.tar.gz
	LD_LIBRARY_PATH= tar -xvzf geog_high_res_mandatory.tar.gz -C "${WRF_FOLDER}"/GEOG/

	wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_low_res_mandatory.tar.gz
	LD_LIBRARY_PATH= tar -xvzf geog_low_res_mandatory.tar.gz -C "${WRF_FOLDER}"/GEOG/
	mv "${WRF_FOLDER}"/GEOG/WPS_GEOG_LOW_RES/ "${WRF_FOLDER}"/GEOG/WPS_GEOG

	if [ ${WPS_Specific_Applications} -eq 1 ]; then
		echo " "
		echo " WPS Geographical Input Data Mandatory for Specific Applications"
		echo " "

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_thompson28_chem.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_thompson28_chem.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_noahmp.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_noahmp.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/irrigation.tar.gz
		LD_LIBRARY_PATH= tar -xvzf irrigation.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG
		mkdir "${WRF_FOLDER}"/GEOG/WPS_GEOG/irrigation
		mv $WRFHYDRDO_FOLDER/GEOG/WPS_GEOG/fao "${WRF_FOLDER}"/GEOG/WPS_GEOG/irrigation

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_px.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_px.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_urban.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_urban.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_ssib.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_ssib.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/lake_depth.tar.bz2
		LD_LIBRARY_PATH= tar -xvf lake_depth.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/topobath_30s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf topobath_30s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/gsl_gwd.tar.bz2
		LD_LIBRARY_PATH= tar -xvf gsl_gwd.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/cglc_modis_lcz_global.tar.gz
		LD_LIBRARY_PATH= tar -xvf cglc_modis_lcz_global.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG
	fi

	if [ ${Optional_GEOG} -eq 1 ]; then
		echo " "
		echo "Optional WPS Geographical Input Data"
		echo " "

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_older_than_2000.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_older_than_2000.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/modis_landuse_20class_15s_with_lakes.tar.gz
		LD_LIBRARY_PATH= tar -xvzf modis_landuse_20class_15s_with_lakes.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_alt_lsm.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_alt_lsm.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/nlcd2006_ll_9s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf nlcd2006_ll_9s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/updated_Iceland_LU.tar.gz
		LD_LIBRARY_PATH= tar -xvf updated_Iceland_LU.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/modis_landuse_20class_15s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf modis_landuse_20class_15s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG
	fi
fi

if [ "$RHL_64bit_Intel" = "1"] && [ "$WRFHYDRO_COUPLED_PICK" = "1" ]; then

	#############################basic package managment############################
	echo $PASSWD | sudo -S yum install epel-release -y
	echo $PASSWD | sudo -S yum install dnf -y
	echo $PASSWD | sudo -S dnf install epel-release -y
	echo $PASSWD | sudo -S dnf install dnf -y
	echo $PASSWD | sudo -S dnf -y update
	echo $PASSWD | sudo -S dnf -y upgrade
	echo $PASSWD | sudo -S dnf -y install bzip2 bzip2-devel byacc cairo-devel cmake cpp curl curl-devel flex fontconfig-devel gcc-c++ gcc-gfortran git java-11-openjdk java-11-openjdk-devel ksh libX11-devel libXaw-devel libXext-devel libXrender-devel libstdc++-devel libxml2 libxml2-devel m4 nfs-utils perl "perl(XML::LibXML)" pkgconfig pixman-devel python3 python3-devel tcsh time unzip wget
	echo $PASSWD | sudo -S dnf -y groupinstall "Development Tools"

	# download the key to system keyring; this and the following echo command are
	# needed in order to install the Intel compilers

	echo $PASSWD | sudo bash -c 'printf "[oneAPI]\nname=Intel oneAPI repository\nbaseurl=https://yum.repos.intel.com/oneapi\nenabled=1\ngpgcheck=1\nrepo_gpgcheck=1\ngpgkey=https://yum.repos.intel.com/intel-gpg-keys/GPG-PUB-KEY-INTEL-SW-PRODUCTS.PUB\n" > /etc/yum.repos.d/oneAPI.repo'

	echo $PASSWD | sudo -S mv /tmp/oneAPI.repo /etc/yum.repos.d

	echo $PASSWD | sudo -S dnf install intel-cpp-essentials -y

	# install the Intel compilers
	echo $PASSWD | sudo -S dnf upgrade intel-cpp-essentials -y
	echo $PASSWD | sudo -S dnf install intel-oneapi-base-toolkit -y
	echo $PASSWD | sudo -S dnf install intel-oneapi-hpc-toolkit -y
	echo $PASSWD | sudo -S dnf install intel-oneapi-python -y

	echo $PASSWD | sudo -S dnf update
	echo $PASSWD | sudo -S dnf -y install cmake pkgconfig
	echo $PASSWD | sudo -S dnf groupinstall "Development Tools" -y

	echo $PASSWD | sudo -S dnf -y update
	echo $PASSWD | sudo -S dnf -y upgrade

	# add the Intel compiler file paths to various environment variables
	source /opt/intel/oneapi/setvars.sh --force

	# some of the libraries we install below need one or more of these variables

	export CC=icx
	export CXX=icpx
	export FC=ifx
	export F77=ifx
	export F90=ifx
	export MPIFC=mpiifx
	export MPIF77=mpiifx
	export MPIF90=mpiifx
	export MPICC=mpiicx
	export MPICXX=mpiicpx
	export CFLAGS="-fPIC -fPIE -O3 -Wno-implicit-function-declaration -Wno-incompatible-function-pointer-types -Wno-unused-command-line-argument"
	export FFLAGS="-m64"
	export FCFLAGS="-m64"

	############################# CPU Core Management ####################################

	export CPU_CORE=$(nproc) # number of available threads on system
	export CPU_6CORE="6"
	export CPU_QUARTER=$(($CPU_CORE / 4)) # quarter of availble cores on system
	# Forces CPU cores to even number to avoid partial core export. ie 7 cores would be 3.5 cores.
	export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))

	# If statement for low core systems.  Forces computers to only use 1 core if there are 4 cores or less on the system.
	if [ $CPU_CORE -le $CPU_6CORE ]; then
		export CPU_QUARTER_EVEN="2"
	else
		export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))
	fi

	echo "##########################################"
	echo "Number of Threads being used $CPU_QUARTER_EVEN"
	echo "##########################################"

	############################## Directory Listing ############################
	# makes necessary directories
	#
	############################################################################

	export HOME=$(
		cd
		pwd
	)
	export WRF_FOLDER=$HOME/WRFHYDRO_COUPLED_INTEL
	export DIR="${WRF_FOLDER}"/Libs
	mkdir "${WRF_FOLDER}"
	cd "${WRF_FOLDER}"
	mkdir Downloads

	mkdir Libs
	mkdir Libs/grib2
	mkdir Libs/NETCDF
	mkdir Libs/MPICH
	mkdir -p Tests/Environment
	mkdir -p Tests/Compatibility

	echo " "
	############################## Downloading Libraries ############################

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/madler/zlib/releases/download/v$Zlib_Version/zlib-$Zlib_Version.tar.gz
	wget -c https://github.com/HDFGroup/hdf5/releases/download/hdf5_$HDF5_Version/hdf5-$HDF5_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-c/archive/refs/tags/v$Netcdf_C_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-fortran/archive/refs/tags/v$Netcdf_Fortran_Version.tar.gz
	wget -c https://download.sourceforge.net/libpng/libpng-$Libpng_Version.tar.gz
	wget -c https://www.ece.uvic.ca/~frodo/jasper/software/jasper-$Jasper_Version.zip
	wget -c https://parallel-netcdf.github.io/Release/pnetcdf-$Pnetcdf_Version.tar.gz

	echo " "

	############################# ZLib ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf zlib-$Zlib_Version.tar.gz
	cd zlib-$Zlib_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	export ZLIB_ROOT=$DIR/grib2
	export ZLIBLIB=$DIR/grib2/lib
	export ZLIBINC=$DIR/grib2/include

	echo " "
	############################# LibPNG ############################

	cd "${WRF_FOLDER}"/Downloads

	# other libraries below need these variables to be set
	export LDFLAGS=-L$DIR/grib2/lib
	export CPPFLAGS=-I$DIR/grib2/include

	LD_LIBRARY_PATH= tar -xvzf libpng-$Libpng_Version.tar.gz
	cd libpng-$Libpng_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNG_ROOT=$DIR/grib2

	echo " "
	############################# JasPer ############################

	cd "${WRF_FOLDER}"/Downloads
	unzip jasper-$Jasper_Version.zip
	cd jasper-$Jasper_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	# other libraries below need these variables to be set
	export JASPERLIB=$DIR/grib2/lib
	export JASPERINC=$DIR/grib2/include
	export JASPER_DIR=$DIR/grib2
	export Jasper_ROOT=$DIR/grib2/lib

	echo " "
	############################# HDF5 library for NetCDF4 & parallel functionality ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf hdf5-$HDF5_Version.tar.gz
	cd hdf5-$HDF5_Version

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --with-zlib=$DIR/grib2 --enable-hl --enable-fortran --enable-parallel 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	# other libraries below need these variables to be set
	export HDF5=$DIR/grib2
	export PATH=$HDF5/bin:$PATH
	export PHDF5=$DIR/grib2
	export HDF5_ROOT=$DIR/grib2
	export PHDF5_ROOT=$DIR/grib2

	echo " "

	############################# Install Parallel-netCDF ##############################
	#Make file created with half of available cpu cores
	#Hard path for MPI added
	##################################################################################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf pnetcdf-$Pnetcdf_Version.tar.gz
	cd pnetcdf-$Pnetcdf_Version
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --enable-static 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	#make check

	export PNETCDF=$DIR/grib2
	export PNETCDF_DIR=$DIR/grib2
	export PNETCDF_ROOT=$DIR/grib2

	echo " "

	############################## Install NETCDF-C Library ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_C_Version.tar.gz
	cd netcdf-c-$Netcdf_C_Version/

	# these variables need to be set for the NetCDF-C install to work
	export CPPFLAGS=-I$DIR/grib2/include
	export LDFLAGS="-L$DIR/grib2/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lhdf5_hl -lhdf5 -lz -lcurl -lgcc -lm -ldl -lpnetcdf"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --disable-dap --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-pnetcdf --enable-cdf5 --enable-parallel-tests --enable-logging 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	# other libraries below need these variables to be set
	export PATH=$DIR/NETCDF/bin:$PATH
	export NETCDF=$DIR/NETCDF
	export NETCDF_INC=$DIR/NETCDF/include
	export NETCDF_LIB=$DIR/NETCDF/lib
	export NETCDF_ROOT=$DIR/NETCDF
	export LD_LIBRARY_PATH=$DIR/grib2/lib:$DIR/NETCDF/lib:$LD_LIBRARY_PATH

	echo " "
	############################## NetCDF-Fortran library ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_Fortran_Version.tar.gz
	cd netcdf-fortran-$Netcdf_Fortran_Version/

	# these variables need to be set for the NetCDF-Fortran install to work
	export LD_LIBRARY_PATH=$DIR/NETCDF/lib:$LD_LIBRARY_PATH
	export CPPFLAGS="-I$DIR/NETCDF/include -I$DIR/grib2/include"
	export LDFLAGS="-L$DIR/NETCDF/lib -L$DIR/grib2/lib -Wl,-rpath,$DIR/NETCDF/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lnetcdf -lpnetcdf -lcurl -lhdf5_hl -lhdf5 -lz -lm -ldl -lgcc"
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --enable-netcdf-4 --enable-netcdf4 --enable-parallel-tests --enable-logging --enable-hdf5 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	echo " "
	#################################### System Environment Tests ##############

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_NETCDF_MPI_tests.tar
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_tests.tar

	LD_LIBRARY_PATH= tar -xvf Fortran_C_tests.tar -C "${WRF_FOLDER}/Tests/Environment"
	LD_LIBRARY_PATH= tar -xvf Fortran_C_NETCDF_MPI_tests.tar -C "${WRF_FOLDER}"/Tests/Compatibility

	export one="1"
	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Environment

	echo " "
	echo " "
	echo "Environment Testing "
	echo "Test 1"
	$FC TEST_1_fortran_only_fixed.f
	./a.out | tee env_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 1 Passed"
	else
		echo "Environment Compiler Test 1 Failed"
		exit
	fi
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 2"
	$FC TEST_2_fortran_only_free.f90
	./a.out | tee env_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 2 Passed"
	else
		echo "Environment Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 3"
	$CC TEST_3_c_only.c
	./a.out | tee env_test3.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test3.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 3 Passed"
	else
		echo "Environment Compiler Test 3 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 4"
	$CC -c -m64 TEST_4_fortran+c_c.c
	$FC -c -m64 TEST_4_fortran+c_f.f90
	$FC -m64 TEST_4_fortran+c_f.o TEST_4_fortran+c_c.o
	./a.out | tee env_test4.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test4.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 4 Passed"
	else
		echo "Environment Compiler Test 4 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Compatibility

	cp ${NETCDF}/include/netcdf.inc .

	echo " "
	echo " "
	echo "Library Compatibility Tests "
	echo "Test 1"
	$FC -c 01_fortran+c+netcdf_f.f
	$CC -c 01_fortran+c+netcdf_c.c
	$FC 01_fortran+c+netcdf_f.o 01_fortran+c+netcdf_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	./a.out | tee comp_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 1 Passed"
	else
		echo "Compatibility Compiler Test 1 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "

	echo "Test 2"
	$MPIFC -c 02_fortran+c+netcdf+mpi_f.f
	$MPICC -c 02_fortran+c+netcdf+mpi_c.c
	$MPIFC 02_fortran+c+netcdf+mpi_f.o \
		02_fortran+c+netcdf+mpi_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	mpirun ./a.out | tee comp_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 2 Passed"
	else
		echo "Compatibility Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."
	echo " "

	echo " All tests completed and passed"
	echo " "

	################################OpenGrADS######################################
	#Verison 2.2.1 64bit of Linux
	#############################################################################
	if [[ $GRADS_PICK -eq 1 ]]; then

		cd "${WRF_FOLDER}"/Downloads
		LD_LIBRARY_PATH= tar -xvzf cd "${WRF_FOLDER}"/Downloads
		wget -c https://sourceforge.net/projects/opengrads/files/grads2/2.2.1.oga.1/Linux%20%2864%20Bits%29/opengrads-2.2.1.oga.1-bundle-x86_64-pc-linux-gnu-glibc_2.17.tar.gz
		LD_LIBRARY_PATH= tar -xvzf opengrads-2.2.1.oga.1-bundle-x86_64-pc-linux-gnu-glibc_2.17.tar.gz -C "${WRF_FOLDER}"/ -C "${WRF_FOLDER}"/
		cd "${WRF_FOLDER}"/
		mv "${WRF_FOLDER}"/opengrads-2.2.1.oga.1 "${WRF_FOLDER}"/GrADS
		cd GrADS/Contents
		wget -c https://github.com/regisgrundig/SIMOP/blob/master/g2ctl.pl
		chmod +x g2ctl.pl
		wget -c https://sourceforge.net/projects/opengrads/files/wgrib2/0.1.9.4/wgrib2-v0.1.9.4-bin-x86_64-glibc2.5-linux-gnu.tar.gz
		LD_LIBRARY_PATH= tar -xvzf wgrib2-v0.1.9.4-bin-x86_64-glibc2.5-linux-gnu.tar.gz
		cd wgrib2-v0.1.9.4/bin
		mv wgrib2 "${WRF_FOLDER}"/GrADS/Contents
		cd "${WRF_FOLDER}"/GrADS/Contents
		rm wgrib2-v0.1.9.4-bin-x86_64-glibc2.5-linux-gnu.tar.gz
		rm -r wgrib2-v0.1.9.4

		export PATH="${WRF_FOLDER}"/GrADS/Contents:$PATH

	fi

	################################## GrADS ###############################
	# Version  2.2.1
	# Sublibs library instructions: http://cola.gmu.edu/grads/gadoc/supplibs2.html
	# GrADS instructions: http://cola.gmu.edu/grads/downloads.php
	########################################################################
	if [[ $GRADS_PICK -eq 2 ]]; then

		echo $PASSWD | sudo -S apt -y install grads

	fi

	##################### NCAR COMMAND LANGUAGE           ##################
	########### NCL compiled via Conda                    ##################
	########### This is the preferred method by NCAR      ##################
	########### https://www.ncl.ucar.edu/index.shtml      ##################
	echo " "
	#Installing Miniconda3 to WRF directory and updating libraries
	echo $PASSWD | sudo -S apt -y install python3-zstandard python3-zstd

	export Miniconda_Install_DIR="${WRF_FOLDER}"/miniconda3

	mkdir -p $Miniconda_Install_DIR

	wget -c https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O $Miniconda_Install_DIR/miniconda.sh
	bash $Miniconda_Install_DIR/miniconda.sh -b -u -p $Miniconda_Install_DIR

	rm -rf $Miniconda_Install_DIR/miniconda.sh

	export PATH="${WRF_FOLDER}"/miniconda3/bin:$PATH

	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	$Miniconda_Install_DIR/bin/conda init bash

	conda tos accept
	conda config --add channels conda-forge
	conda config --set auto_activate_base false
	conda update -n root --all -y

	#Special Thanks to @_WaylonWalker for code development

	echo " "
	#Installing NCL via Conda
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	conda create -n ncl_stable -c conda-forge ncl -y
	conda activate ncl_stable

	conda deactivate
	conda deactivate
	conda deactivate
	echo " "

	##################### WRF Python           ##################
	########### WRf-Python compiled via Conda  ##################
	########### This is the preferred method by NCAR      ##################
	##### https://wrf-python.readthedocs.io/en/latest/installation.html  ##################
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh
	conda env create -f $HOME/WRF-MOSIT/wrf-python-stable.yml

	######################### Climate Data Operators ############
	######################### CDO compiled via Conda ###########
	####################### This is the preferred method #######
	################### https://bairdlangenbrunner.github.io/python-for-climate-scientists/conda/setting-up-conda-environments.html #######################

	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	conda create --name cdo_stable -y
	conda activate cdo_stable
	conda install -c conda-forge cdo -y
	conda update --all -y
	conda deactivate
	conda deactivate
	conda deactivate

	echo " "

	########################## WRF Hydro GIS PreProcessor ##############################
	#  Compiled with Conda
	#  https://github.com/NCAR/wrf_hydro_gis_preprocessor
	####################################################################################

	conda init bash
	conda activate base
	conda create -n wrfh_gis_env -c conda-forge python=3.12 gdal netCDF4 numpy pyproj whitebox=2.2.0 packaging shapely -y
	conda activate wrfh_gis_env
	conda update -n wrfh_gis_env --all -y
	conda deactivate
	conda deactivate
	conda deactivate
	cd "${WRF_FOLDER}"
	git clone https://github.com/NCAR/wrf_hydro_gis_preprocessor.git "${WRF_FOLDER}"/WRF-Hydro-GIS-PreProcessor

	echo " "

	############################# WRF HYDRO V5.4.0 #################################
	# Version 5.3.0
	# Standalone mode
	################################################################################

	# Source Intel oneAPI environment
	source /opt/intel/oneapi/setvars.sh --force

	# Set up NETCDF environment variables
	export NETCDF_INC="$DIR/NETCDF/include"
	export NETCDF_LIB="$DIR/NETCDF/lib"

	# Create directories for Hydro Basecode and navigate to it
	mkdir -p "${WRF_FOLDER}/Hydro-Basecode"
	cd "${WRF_FOLDER}/Hydro-Basecode"

	# Clone the WRF-Hydro repository and set up the build
	git clone https://github.com/NCAR/wrf_hydro_nwm_public.git
	cd wrf_hydro_nwm_public
	mkdir -p build
	cd build

	# Run CMake configuration for WRF-Hydro with specified options
	cmake .. \
		-DSPATIAL_SOIL=1 \
		-DWRF_HYDRO=1 \
		-DWRFIO_NCD_LARGE_FILE_SUPPORT=1 \
		-DCMAKE_Fortran_COMPILER=ifx

	# Compile using specified CPU settings
	make -j "$CPU_QUARTER_EVEN" 2>&1 | tee make.log

	# List of expected files (binary + symlinks)
	expected_files=("wrf_hydro" "wrf_hydro.exe" "wrf_hydro_NoahMP")

	# Count how many of them exist
	n=0
	for f in "${expected_files[@]}"; do
		[[ -e $f ]] && ((n++))
	done

	# Function to rerun compilation if files are missing
	rebuild_and_check() {
		echo "Missing one or more expected files. Running compiler again..."
		cd "${WRF_FOLDER}/Hydro-Basecode/wrf_hydro_nwm_public/build"
		make -j "$CPU_QUARTER_EVEN" 2>&1 | tee make2.log
		cd "${WRF_FOLDER}/Hydro-Basecode/wrf_hydro_nwm_public/build/Run"

		n=0
		for f in "${expected_files[@]}"; do
			[[ -e $f ]] && ((n++))
		done
	}

	# IF statement to check that all expected files were created
	if ((n == ${#expected_files[@]})); then
		echo "All expected files created."
	else
		rebuild_and_check
		if ((n != ${#expected_files[@]})); then
			echo "Missing one or more expected files. Exiting the script."
			read -r -p "Please contact script authors for assistance. Press 'Enter' to exit the script."
			exit 1
		else
			echo "All expected files created after re-compiling."
		fi
	fi

	# Finish the script with a pause
	read -r -t 5 -p "Finished installing WRF Hydro Basecode. Waiting for 5 seconds..."
	############################ WRF #################################
	## WRF v${WPS_VERSION}
	## Downloaded from git tagged releases
	# option 78, option 1 for intel and distributed memory w/basic nesting
	# large file support enable with WRFiO_NCD_LARGE_FILE_SUPPORT=1
	# In the namelist.input, the following settings support pNetCDF by setting  value to 11:
	# io_form_boundary
	# io_form_history
	# io_form_auxinput2
	# io_form_auxhist2
	# Note that you need set nocolons = .true. in the section &time_control of namelist.input
	########################################################################

	cd "${WRF_FOLDER}"/Downloads

	wget -c https://github.com/wrf-model/WRF/releases/download/v${WRF_VERSION}/v${WRF_VERSION}.tar.gz -O WRF-${WRF_VERSION}.tar.gz
	LD_LIBRARY_PATH= tar -xvzf WRF-${WRF_VERSION}.tar.gz -C "${WRF_FOLDER}"/

	# If statment for changing folder name
	# Check if WRF directory exists
	if [ -d "${WRF_FOLDER}/WRF" ]; then
		mv -f "${WRF_FOLDER}/WRF" "${WRF_FOLDER}/WRF-${WRF_VERSION}"

	# Else, check for any folder matching WRFV*
	else
		for dir in "${WRF_FOLDER}"/WRFV*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WRF-${WRF_VERSION}"
				break
			fi
		done
	fi

	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}

	export WRFIO_NCD_LARGE_FILE_SUPPORT=1

	#Replace old version of WRF-Hydro distributed with WRF with updated WRF-Hydro source code
	rm -r "${WRF_FOLDER}"/WRF-${WRF_VERSION}/hydro/
	cp -r "${WRF_FOLDER}"/Hydro-Basecode/wrf_hydro_nwm_public/src "${WRF_FOLDER}"/WRF-${WRF_VERSION}/hydro

	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/hydro/template

	sed -i '12s|=0|=1|g' setEnvar.sh
	sed -i '$ a\# Large file support\nexport WRFIO_NCD_LARGE_FILE_SUPPORT=1' setEnvar.sh

	source setEnvar.sh
	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}

	LD_LIBRARY_PATH= ./clean -a

    ############################################################ NEEDS REVIEW IN FUTURE ##################################
    sed -i '34s\($x =~ "ifort")\($x =~ /ifort|intel/)\g' "${WRF_FOLDER}"/WRF-${WRF_VERSION}/hydro/wrf_hydro_config
    ######################################################################################################################


	if [ ${auto_config} -eq 1 ]; then
		(
			echo 78
			echo 1
		) | ./configure

	else
		./configure 2>&1 | tee configure.log #option 78 intel compiler with distributed memory option 1 for basic nesting
	fi

	#Need to remove mpich/GNU config calls to Intel config calls
	sed -i '136s|mpif90 -f90=$(SFC)|mpiifx|g' "${WRF_FOLDER}"/WRF-${WRF_VERSION}/configure.wrf
	sed -i '137s|mpicc -cc=$(SCC)|mpiicx|g' "${WRF_FOLDER}"/WRF-${WRF_VERSION}/configure.wrf
	sed -i '63s|mpif90|mpiifx|g' "${WRF_FOLDER}"/WRF-${WRF_VERSION}/hydro/macros
	sed -i '64s|mpicc|mpiicx|g' "${WRF_FOLDER}"/WRF-${WRF_VERSION}/hydro/macros

	LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN em_real 2>&1 | tee compile.wrf1.log

	export WRF_DIR="${WRF_FOLDER}"/WRF-${WRF_VERSION}

	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/main
	n=$(ls ./*.exe | wc -l)
	if (($n >= 3)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}
		LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN em_real 2>&1 | tee compile.wrf2.log
		cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/main
		n=$(ls ./*.exe | wc -l)
		if (($n >= 3)); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	echo " "

	echo " "

	############################WPS#####################################
	## WPS v${WPS_VERSION}
	## Downloaded from git tagged releases
	#Option 3 for gfortran and distributed memory
	########################################################################

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/wrf-model/WPS/archive/refs/tags/v${WPS_VERSION}.tar.gz -O WPS-${WPS_VERSION}.tar.gz
	LD_LIBRARY_PATH= tar -xvzf WPS-${WPS_VERSION}.tar.gz -C "${WRF_FOLDER}"/
	# Check if WPS directory exists
	if [ -d "${WRF_FOLDER}/WPS" ]; then
		mv -f "${WRF_FOLDER}/WPS" "${WRF_FOLDER}/WPS-${WPS_VERSION}"

	# Else, check for any folder matching WPSV* or WPS-*
	else
		for dir in "${WRF_FOLDER}"/WPSV* "${WRF_FOLDER}"/WPS-*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WPS-${WPS_VERSION}"
				break
			fi
		done
	fi
	cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
	LD_LIBRARY_PATH= ./clean -a

	if [ ${auto_config} -eq 1 ]; then
		echo 19 | ./configure 2>&1 | tee configure.log #Option 19 for intel and distributed memory
	else
		./configure 2>&1 | tee configure.log #Option 19 intel compiler with distributed memory
	fi

	sed -i '67s|mpif90|mpiifx|g' "${WRF_FOLDER}"/WPS-${WPS_VERSION}/configure.wps
	sed -i '68s|mpicc|mpiicx|g' "${WRF_FOLDER}"/WPS-${WPS_VERSION}/configure.wps

	LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.wps.log

	echo " "
	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
	n=$(ls ./*.exe | wc -l)
	if (($n == 3)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WPS. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.wps2.log
		cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
		n=$(ls ./*.exe | wc -l)
		if (($n == 3)); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WPS. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	echo " "

	######################## Static Geography Data inc/ Optional ####################
	# http://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html
	# These files are large so if you only need certain ones comment the others off
	# All files downloaded and untarred is 200GB
	# https://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html
	#################################################################################
	cd "${WRF_FOLDER}"/Downloads
	mkdir "${WRF_FOLDER}"/GEOG
	mkdir "${WRF_FOLDER}"/GEOG/WPS_GEOG

	echo " "
	echo "Mandatory WRF Preprocessing System (WPS) Geographical Input Data Mandatory Fields Downloads"
	echo " "
	wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_high_res_mandatory.tar.gz
	LD_LIBRARY_PATH= tar -xvzf geog_high_res_mandatory.tar.gz -C "${WRF_FOLDER}"/GEOG/

	wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_low_res_mandatory.tar.gz
	LD_LIBRARY_PATH= tar -xvzf geog_low_res_mandatory.tar.gz -C "${WRF_FOLDER}"/GEOG/
	mv "${WRF_FOLDER}"/GEOG/WPS_GEOG_LOW_RES/ "${WRF_FOLDER}"/GEOG/WPS_GEOG

	if [ ${WPS_Specific_Applications} -eq 1 ]; then
		echo " "
		echo " WPS Geographical Input Data Mandatory for Specific Applications"
		echo " "

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_thompson28_chem.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_thompson28_chem.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_noahmp.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_noahmp.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/irrigation.tar.gz
		LD_LIBRARY_PATH= tar -xvzf irrigation.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_px.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_px.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_urban.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_urban.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_ssib.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_ssib.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/lake_depth.tar.bz2
		LD_LIBRARY_PATH= tar -xvf lake_depth.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/topobath_30s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf topobath_30s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/gsl_gwd.tar.bz2
		LD_LIBRARY_PATH= tar -xvf gsl_gwd.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/cglc_modis_lcz_global.tar.gz
		LD_LIBRARY_PATH= tar -xvf cglc_modis_lcz_global.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG
	fi

	if [ ${Optional_GEOG} -eq 1 ]; then
		echo " "
		echo "Optional WPS Geographical Input Data"
		echo " "

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_older_than_2000.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_older_than_2000.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/modis_landuse_20class_15s_with_lakes.tar.gz
		LD_LIBRARY_PATH= tar -xvzf modis_landuse_20class_15s_with_lakes.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_alt_lsm.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_alt_lsm.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/nlcd2006_ll_9s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf nlcd2006_ll_9s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/updated_Iceland_LU.tar.gz
		LD_LIBRARY_PATH= tar -xvf updated_Iceland_LU.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/modis_landuse_20class_15s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf modis_landuse_20class_15s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG
	fi

fi

########################### WRF CHEM ##########################
## WRFCHEM installation with parallel process.
# Download and install required library and data files for WRFCHEM/KPP $ WRF 3DVAR for Chemistry.
# Tested in Ubuntu 22.04 & 24.04, Rocky Linux 9 & MacOS Ventura 64bit
# Built in 64-bit system
# Built with Intel or GNU compilers
# Tested with current available libraries on 03/01/2025
# If newer libraries exist edit script paths for changes
#Estimated Run Time ~ 90 - 150 Minutes with 10mb/s downloadspeed.
# Special thanks to:
# Youtube's meteoadriatic, GitHub user jamal919.
# University of Manchester's  Doug L
# University of Tunis El Manar's Hosni
# GSL's Jordan S.
# NCAR's Mary B., Christine W., & Carl D.
# DTC's Julie P., Tara J., George M., & John H.
# UCAR's Katelyn F., Jim B., Jordan P., Kevin M.,
##############################################################

if [ "$Ubuntu_64bit_GNU" = "1" ] && [ "$WRFCHEM_PICK" = "1" ]; then

	#############################basic package managment############################
	echo $PASSWD | sudo -S apt -y update
	echo $PASSWD | sudo -S apt -y upgrade

	release_version=$(lsb_release -r -s)

	# Compare the release version
	if [ "$release_version" = "24.04" ]; then
		# Install Emacs without recommended packages
		echo $PASSWD | sudo -S apt install emacs --no-install-recommends -y
	else
		# Attempt to install Emacs if the release version is not 24.04
		echo "The release version is not 24.04, attempting to install Emacs."
		echo $PASSWD | sudo -S apt install emacs -y
	fi

	echo $PASSWD | sudo -S apt -y install bison build-essential byacc cmake csh curl default-jdk default-jre flex libfl-dev g++ gawk gcc gettext gfortran git ksh libcurl4-gnutls-dev libjpeg-dev libncurses6 libpixman-1-dev libpng-dev libtool libxml2 libxml2-dev libxml-libxml-perl m4 make ncview pipenv pkg-config python3 python3-dev python3-pip python3-dateutil tcsh unzip xauth xorg time

	echo " "
	##############################Directory Listing############################
	export HOME=$(
		cd
		pwd
	)

	mkdir $HOME/WRFCHEM
	export WRF_FOLDER=$HOME/WRFCHEM
	cd "${WRF_FOLDER}"/
	mkdir Downloads
	mkdir Libs
	export DIR="${WRF_FOLDER}"/Libs
	mkdir Libs/grib2
	mkdir Libs/NETCDF
	mkdir Libs/MPICH
	mkdir -p Tests/Environment
	mkdir -p Tests/Compatibility
	echo " "
	#############################Core Management####################################
	export CPU_CORE=$(nproc) # number of available threads on system
	export CPU_6CORE="6"
	export CPU_QUARTER=$(($CPU_CORE / 4))                          #quarter of availble cores on system
	export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2))) #Forces CPU cores to even number to avoid partial core export. ie 7 cores would be 3.5 cores.

	if [ $CPU_CORE -le $CPU_6CORE ]; then #If statement for low core systems.  Forces computers to only use 1 core if there are 4 cores or less on the system. then
		export CPU_QUARTER_EVEN="2"
	else
		export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))
	fi

	echo "##########################################"
	echo "Number of Threads being used $CPU_QUARTER_EVEN"
	echo "##########################################"
	echo " "
	##############################Downloading Libraries############################
	cd Downloads
	wget -c https://github.com/madler/zlib/releases/download/v$Zlib_Version/zlib-$Zlib_Version.tar.gz
	wget -c https://github.com/HDFGroup/hdf5/releases/download/hdf5_$HDF5_Version/hdf5-$HDF5_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-c/archive/refs/tags/v$Netcdf_C_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-fortran/archive/refs/tags/v$Netcdf_Fortran_Version.tar.gz
	wget -c https://download.sourceforge.net/libpng/libpng-$Libpng_Version.tar.gz
	wget -c https://www.ece.uvic.ca/~frodo/jasper/software/jasper-$Jasper_Version.zip
	wget -c https://github.com/pmodels/mpich/releases/download/v$Mpich_Version/mpich-$Mpich_Version.tar.gz
	wget -c https://parallel-netcdf.github.io/Release/pnetcdf-$Pnetcdf_Version.tar.gz

	echo " "
	#############################Compilers############################
	export CC=gcc
	export CXX=g++
	export FC=gfortran
	export F77=gfortran
	export CFLAGS="-fPIC -fPIE -O3 "

	#IF statement for GNU compiler issue
	export GCC_VERSION=$(/usr/bin/gcc -dumpfullversion | awk '{print$1}')
	export GFORTRAN_VERSION=$(/usr/bin/gfortran -dumpfullversion | awk '{print$1}')
	export GPLUSPLUS_VERSION=$(/usr/bin/g++ -dumpfullversion | awk '{print$1}')

	export GCC_VERSION_MAJOR_VERSION=$(echo $GCC_VERSION | awk -F. '{print $1}')
	export GFORTRAN_VERSION_MAJOR_VERSION=$(echo $GFORTRAN_VERSION | awk -F. '{print $1}')
	export GPLUSPLUS_VERSION_MAJOR_VERSION=$(echo $GPLUSPLUS_VERSION | awk -F. '{print $1}')

	export version_10="10"

	if [ $GCC_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GFORTRAN_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GPLUSPLUS_VERSION_MAJOR_VERSION -ge $version_10 ]; then
		export fallow_argument=-fallow-argument-mismatch
		export boz_argument=-fallow-invalid-boz
	else
		export fallow_argument=
		export boz_argument=
	fi

	export FFLAGS="$fallow_argument -m64"
	export FCFLAGS="$fallow_argument -m64"

	echo "##########################################"
	echo "FFLAGS = $FFLAGS"
	echo "FCFLAGS = $FCFLAGS"
	echo "CFLAGS = $CFLAGS"
	echo "##########################################"

	echo " "
	############################# ZLib ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf zlib-$Zlib_Version.tar.gz
	cd zlib-$Zlib_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	export ZLIB_ROOT=$DIR/grib2
	export ZLIBLIB=$DIR/grib2/lib
	export ZLIBINC=$DIR/grib2/include

	echo " "
	############################## MPICH ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf mpich-$Mpich_Version.tar.gz
	cd mpich-$Mpich_Version/

	F90= ./configure --prefix=$DIR/MPICH --with-device=ch3 FFLAGS="$fallow_argument -m64" FCFLAGS="$fallow_argument -m64" 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/MPICH/bin:$PATH
	export MPIFC=$DIR/MPICH/bin/mpifort
	export MPIF77=$DIR/MPICH/bin/mpifort
	export MPIF90=$DIR/MPICH/bin/mpifort
	export MPICC=$DIR/MPICH/bin/mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx

	echo " "
	############################# libpng ############################

	cd "${WRF_FOLDER}"/Downloads

	# other libraries below need these variables to be set
	export LDFLAGS=-L$DIR/grib2/lib
	export CPPFLAGS=-I$DIR/grib2/include

	LD_LIBRARY_PATH= tar -xvzf libpng-$Libpng_Version.tar.gz
	cd libpng-$Libpng_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNG_ROOT=$DIR/grib2

	echo " "
	#############################JasPer ############################
	cd "${WRF_FOLDER}"/Downloads
	unzip jasper-$Jasper_Version.zip
	cd jasper-$Jasper_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export JASPERLIB=$DIR/grib2/lib
	export JASPERINC=$DIR/grib2/include
	export JASPER_DIR=$DIR/grib2
	export Jasper_ROOT=$DIR/grib2/lib

	echo " "
	############################# hdf5 library for netcdf4 functionality ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf hdf5-$HDF5_Version.tar.gz
	cd hdf5-$HDF5_Version

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --with-zlib=$DIR/grib2 --enable-hl --enable-fortran --enable-parallel 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export HDF5=$DIR/grib2
	export PATH=$HDF5/bin:$PATH
	export PHDF5=$DIR/grib2
	export HDF5_ROOT=$DIR/grib2
	export PHDF5_ROOT=$DIR/grib2

	echo " "

	############################# Install Parallel-netCDF ##############################
	#Make file created with half of available cpu cores
	#Hard path for MPI added
	##################################################################################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf pnetcdf-$Pnetcdf_Version.tar.gz
	cd pnetcdf-$Pnetcdf_Version
	export MPIFC=$DIR/MPICH/bin/mpifort
	export MPIF77=$DIR/MPICH/bin/mpifort
	export MPIF90=$DIR/MPICH/bin/mpifort
	export MPICC=$DIR/MPICH/bin/mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --enable-static 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNETCDF=$DIR/grib2
	export PNETCDF_DIR=$DIR/grib2
	export PNETCDF_ROOT=$DIR/grib2

	echo " "

	############################## Install NETCDF C Library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_C_Version.tar.gz
	cd netcdf-c-$Netcdf_C_Version/
	export CPPFLAGS=-I$DIR/grib2/include
	export LDFLAGS="-L$DIR/grib2/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lhdf5_hl -lhdf5 -lz -lcurl -lgfortran -lgcc -lm -ldl -lpnetcdf"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --disable-dap --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-pnetcdf --enable-cdf5 --enable-parallel-tests --enable-logging 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/NETCDF/bin:$PATH
	export NETCDF=$DIR/NETCDF
	export NETCDF_INC=$DIR/NETCDF/include
	export NETCDF_LIB=$DIR/NETCDF/lib
	export NETCDF_ROOT=$DIR/NETCDF
	export LD_LIBRARY_PATH=$DIR/grib2/lib:$DIR/NETCDF/lib:$LD_LIBRARY_PATH

	echo " "
	############################## NetCDF fortran library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_Fortran_Version.tar.gz
	cd netcdf-fortran-$Netcdf_Fortran_Version/
	export LD_LIBRARY_PATH=$DIR/NETCDF/lib:$LD_LIBRARY_PATH
	export CPPFLAGS="-I$DIR/NETCDF/include -I$DIR/grib2/include"
	export LDFLAGS="-L$DIR/NETCDF/lib -L$DIR/grib2/lib -Wl,-rpath,$DIR/NETCDF/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lnetcdf -lpnetcdf -lcurl -lhdf5_hl -lhdf5 -lz -lm -ldl -lgcc -lgfortran"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-parallel-tests --enable-logging --enable-hdf5 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	echo " "
	#################################### System Environment Tests ##############

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_NETCDF_MPI_tests.tar
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_tests.tar

	LD_LIBRARY_PATH= tar -xvf Fortran_C_tests.tar -C "${WRF_FOLDER}"/Tests/Environment
	LD_LIBRARY_PATH= tar -xvf Fortran_C_NETCDF_MPI_tests.tar -C "${WRF_FOLDER}"/Tests/Compatibility
	export one="1"
	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Environment
	cp ${NETCDF}/include/netcdf.inc .

	echo " "
	echo " "
	echo "Environment Testing "
	echo "Test 1"
	$FC TEST_1_fortran_only_fixed.f
	./a.out | tee env_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 1 Passed"
	else
		echo "Environment Compiler Test 1 Failed"
		exit
	fi
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 2"
	$FC TEST_2_fortran_only_free.f90
	./a.out | tee env_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 2 Passed"
	else
		echo "Environment Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 3"
	$CC TEST_3_c_only.c
	./a.out | tee env_test3.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test3.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 3 Passed"
	else
		echo "Environment Compiler Test 3 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 4"
	$CC -c -m64 TEST_4_fortran+c_c.c
	$FC -c -m64 TEST_4_fortran+c_f.f90
	$FC -m64 TEST_4_fortran+c_f.o TEST_4_fortran+c_c.o
	./a.out | tee env_test4.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test4.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 4 Passed"
	else
		echo "Environment Compiler Test 4 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Compatibility

	cp ${NETCDF}/include/netcdf.inc .

	echo " "
	echo " "
	echo "Library Compatibility Tests "
	echo "Test 1"
	$FC -c 01_fortran+c+netcdf_f.f
	$CC -c 01_fortran+c+netcdf_c.c
	$FC 01_fortran+c+netcdf_f.o 01_fortran+c+netcdf_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	./a.out | tee comp_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 1 Passed"
	else
		echo "Compatibility Compiler Test 1 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "

	echo "Test 2"
	$MPIFC -c 02_fortran+c+netcdf+mpi_f.f
	$MPICC -c 02_fortran+c+netcdf+mpi_c.c
	$MPIFC 02_fortran+c+netcdf+mpi_f.o \
		02_fortran+c+netcdf+mpi_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	$DIR/MPICH/bin/mpirun ./a.out | tee comp_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 2 Passed"
	else
		echo "Compatibility Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."
	echo " "

	echo " All tests completed and passed"
	echo " "

	################################ OpenGrADS ##################################
	#Verison 2.2.1 32bit of Linux
	#############################################################################
	if [[ $GRADS_PICK -eq 1 ]]; then

		cd "${WRF_FOLDER}"/Downloads
		LD_LIBRARY_PATH= tar -xvzf cd "${WRF_FOLDER}"/Downloads
		wget -c https://sourceforge.net/projects/opengrads/files/grads2/2.2.1.oga.1/Linux%20%2864%20Bits%29/opengrads-2.2.1.oga.1-bundle-x86_64-pc-linux-gnu-glibc_2.17.tar.gz
		LD_LIBRARY_PATH= tar -xvzf opengrads-2.2.1.oga.1-bundle-x86_64-pc-linux-gnu-glibc_2.17.tar.gz -C "${WRF_FOLDER}"/ -C "${WRF_FOLDER}"/
		cd "${WRF_FOLDER}"/
		mv "${WRF_FOLDER}"/opengrads-2.2.1.oga.1 "${WRF_FOLDER}"/GrADS
		cd GrADS/Contents
		wget -c https://github.com/regisgrundig/SIMOP/blob/master/g2ctl.pl
		chmod +x g2ctl.pl
		wget -c https://sourceforge.net/projects/opengrads/files/wgrib2/0.1.9.4/wgrib2-v0.1.9.4-bin-i686-glib2.5-linux-gnu.tar.gz
		LD_LIBRARY_PATH= tar -xvzf wgrib2-v0.1.9.4-bin-i686-glib2.5-linux-gnu.tar.gz
		cd wgrib2-v0.1.9.4/bin
		mv wgrib2 "${WRF_FOLDER}"/GrADS/Contents
		cd "${WRF_FOLDER}"/GrADS/Contents
		rm wgrib2-v0.1.9.4-bin-i686-glib2.5-linux-gnu.tar.gz
		rm -r wgrib2-v0.1.9.4

		export PATH="${WRF_FOLDER}"/GrADS/Contents:$PATH

	fi

	echo " "

	################################## GrADS ###############################
	# Version  2.2.1
	# Sublibs library instructions: http://cola.gmu.edu/grads/gadoc/supplibs2.html
	# GrADS instructions: http://cola.gmu.edu/grads/downloads.php
	########################################################################
	if [[ $GRADS_PICK -eq 2 ]]; then

		echo $PASSWD | sudo -S apt -y install grads

	fi

	##################### NCAR COMMAND LANGUAGE           ##################
	########### NCL compiled via Conda                    ##################
	########### This is the preferred method by NCAR      ##################
	########### https://www.ncl.ucar.edu/index.shtml      ##################
	echo " "
	#Installing Miniconda3 to WRF directory and updating libraries
	echo $PASSWD | sudo -S apt -y install python3-zstandard python3-zstd

	export Miniconda_Install_DIR="${WRF_FOLDER}"/miniconda3

	mkdir -p $Miniconda_Install_DIR

	wget -c https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O $Miniconda_Install_DIR/miniconda.sh
	bash $Miniconda_Install_DIR/miniconda.sh -b -u -p $Miniconda_Install_DIR

	rm -rf $Miniconda_Install_DIR/miniconda.sh

	export PATH="${WRF_FOLDER}"/miniconda3/bin:$PATH

	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	$Miniconda_Install_DIR/bin/conda init bash

	conda tos accept
	conda config --add channels conda-forge
	conda config --set auto_activate_base false
	conda update -n root --all -y

	echo " "

	echo " "
	#Installing NCL via Conda
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	conda create -n ncl_stable -c conda-forge ncl -y
	conda activate ncl_stable

	conda deactivate
	conda deactivate
	conda deactivate

	echo " "

	############################OBSGRID###############################
	## OBSGRID
	## Downloaded from git tagged releases
	## Option #2
	########################################################################
	cd "${WRF_FOLDER}"/
	git clone https://github.com/wrf-model/OBSGRID.git
	cd "${WRF_FOLDER}"/OBSGRID

	LD_LIBRARY_PATH= ./clean -a
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh
	conda activate ncl_stable

	export HOME=$(
		cd
		pwd
	)
	export DIR="${WRF_FOLDER}"/Libs
	export NETCDF=$DIR/NETCDF

	if [ ${auto_config} -eq 1 ]; then
		echo 2 | ./configure 2>&1 | tee configure.log #Option 2 for gfortran/gcc and distribunted memory
	else
		./configure 2>&1 | tee configure.log #Option 2 for gfortran/gcc and distribunted memory
	fi

	sed -i '27s/-lnetcdf -lnetcdff/ -lnetcdff -lnetcdf/g' configure.oa

	sed -i '31s/-lncarg -lncarg_gks -lncarg_c -lX11 -lm -lcairo/-lncarg -lncarg_gks -lncarg_c -lX11 -lm -lcairo -lfontconfig -lpixman-1 -lfreetype -lhdf5 -lhdf5_hl /g' configure.oa

	sed -i '39s/-frecord-marker=4/-frecord-marker=4 ${fallow_argument} /g' configure.oa

	sed -i '44s/=	/=	${fallow_argument} /g' configure.oa

	sed -i '45s/-C -P -traditional/-P -traditional/g' configure.oa

	echo " "

	LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.obsgrid.log

	conda deactivate
	conda deactivate
	conda deactivate

	# IF statement to check that all files were created.
	if [[ -x ./obsgrid.exe ]]; then
		echo "obsgrid.exe found."
		read -r -t 5 -p "Finished installing OBSGRID. I am going to wait for 5 seconds only ..."
	else
		echo "obsgrid.exe is missing. Attempting to compile again..."

		LD_LIBRARY_PATH= ./clean -a
		LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.obsgrid.retry.log

		if [[ -x ./obsgrid.exe ]]; then
			echo "obsgrid.exe successfully created after recompilation."
			read -r -t 5 -p "Finished retrying OBSGRID compile. I am going to wait for 5 seconds only ..."
		else
			echo "Still missing obsgrid.exe after recompile. Exiting the script."
			read -r -p "Please contact script authors for assistance. Press 'Enter' to exit."
			exit 1
		fi
	fi

	echo " "

	##################### WRF Python           ##################
	########### WRf-Python compiled via Conda  ##################
	########### This is the preferred method by NCAR      ##################
	##### https://wrf-python.readthedocs.io/en/latest/installation.html  ##################
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh
	conda env create -f $HOME/WRF-MOSIT/wrf-python-stable.yml

	echo " "

	######################### Climate Data Operators ############
	######################### CDO compiled via Conda ###########
	####################### This is the preferred method #######
	################### https://bairdlangenbrunner.github.io/python-for-climate-scientists/conda/setting-up-conda-environments.html #######################

	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	conda create --name cdo_stable -y
	conda activate cdo_stable
	conda install -c conda-forge cdo -y
	conda update --all -y
	conda deactivate
	conda deactivate
	conda deactivate

	############################WRFDA 3DVAR###############################
	## WRFDA v${WPS_VERSION} 3DVAR
	## Downloaded from git tagged releases
	## Does not include RTTOV Libarary for radiation data.  If wanted will need to install library then reconfigure
	##Note: if you intend to run both 3DVAR and 4DVAR experiments, it is not necessary to compile the code twice.
	#Option 34 for gfortran/gcc and distribunted memory
	########################################################################
	cd "${WRF_FOLDER}"/Downloads
	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/wrf-model/WRF/releases/download/v${WRF_VERSION}/v${WRF_VERSION}.tar.gz -O WRF-${WRF_VERSION}.tar.gz
	mkdir -p "${WRF_FOLDER}"/WRFDA
	LD_LIBRARY_PATH= tar -xvzf WRF-${WRF_VERSION}.tar.gz -C "${WRF_FOLDER}"/WRFDA

	# If statement for changing folder name inside WRFDA
	if [ -d "${WRF_FOLDER}/WRFDA/WRF" ]; then
		mv -f "${WRF_FOLDER}/WRFDA/WRF" "${WRF_FOLDER}/WRFDA/WRF-${WRF_VERSION}"

	else
		for dir in "${WRF_FOLDER}/WRFDA"/WRFV*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WRFDA/WRF-${WRF_VERSION}"
				break
			fi
		done
	fi
	cd "${WRF_FOLDER}"/WRFDA/WRF-${WRF_VERSION}

	mv * "${WRF_FOLDER}"/WRFDA
	cd "${WRF_FOLDER}"/WRFDA
	rm -rf WRF-${WRF_VERSION}/
	cd "${WRF_FOLDER}"/WRFDA

	ulimit -s unlimited
	export WRF_CHEM=1
	export WRFIO_NCD_LARGE_FILE_SUPPORT=1

	LD_LIBRARY_PATH= ./clean -a

	if [ ${auto_config} -eq 1 ]; then
		echo 34 | ./configure wrfda 2>&1 | tee configure.log #Option 34 for gfortran/gcc and distribunted memory
	else
		./configure wrfda 2>&1 | tee configure.log #Option 18 for gfortran/gcc and distribunted memory
	fi
	echo " "
	LD_LIBRARY_PATH= ./compile -j 4 all_wrfvar 2>&1 | tee compile.chem.wrfvar.log
	echo " "

	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WRFDA/var/da
	n=$(ls ./*.exe | wc -l)
	cd "${WRF_FOLDER}"/WRFDA/var/obsproc/src
	m=$(ls ./*.exe | wc -l)
	if ((($n == 43) && ($m == 1))); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WRFDA. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		cd "${WRF_FOLDER}"/WRFDA
		LD_LIBRARY_PATH= ./compile -j 2 all_wrfvar 2>&1 | tee compile.chem.wrfvar2.log
		cd "${WRF_FOLDER}"/WRFDA/var/da
		n=$(ls ./*.exe | wc -l)
		cd "${WRF_FOLDER}"/WRFDA/var/obsproc/src
		m=$(ls ./*.exe | wc -l)
		if ((($n == 43) && ($m == 1))); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WRFDA. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	echo " "

	############################ WRFCHEM #################################
	## WRF CHEM v${WPS_VERSION}
	## Downloaded from git tagged releases
	# option 34, option 1 for gfortran and distributed memory w/basic nesting
	# If the script comes back asking to locate a file (libfl.a)
	# Use locate command to find file. in a new terminal and then copy that location
	#locate *name of file*
	#Optimization set to 0 due to buffer overflow dump
	#sed -i -e 's/="-O"/="-O0/' configure_kpp
	# io_form_boundary
	# io_form_history
	# io_form_auxinput2
	# io_form_auxhist2
	# Note that you need set nocolons = .true. in the section &time_control of namelist.input
	########################################################################
	#Setting up WRF-CHEM/KPP
	cd /tmp

	# Download the flex 2.6.4 source tarball
	wget https://github.com/westes/flex/releases/download/v2.6.4/flex-2.6.4.tar.gz

	# Extract it
	tar -xzf flex-2.6.4.tar.gz
	cd flex-2.6.4

	# Configure to install into /usr (so libs go to /usr/lib64)
	./configure --prefix=/usr/ 2>&1 | tee "${WRF_FOLDER}"/Downloads/flex.configure.log

	# Build
	make 2>&1 | tee "${WRF_FOLDER}"/Downloads/flex.make.log

	# Install (will prompt for sudo password)
	echo $PASSWD | sudo -S make install

	# --------------------------------------------------------
	# Detect Flex library location automatically
	# --------------------------------------------------------
	FLEX_LIB_PATH=$(find /usr /usr/local -type f \( -name "libfl.a" -o -name "libfl.so" \) 2>/dev/null | head -n 1)
	# Extract the directory name only
	FLEX_LIB_DIR=$(dirname "$FLEX_LIB_PATH")

	# Export it for WRF configure
	export FLEX_LIB_DIR
	echo "FLEX_LIB_DIR set to $FLEX_LIB_DIR"

	# --------------------------------------------------------
	# Setting up WRF-CHEM/KPP environment
	# --------------------------------------------------------
	cd "${WRF_FOLDER}"/Downloads

	ulimit -s unlimited
	export WRF_EM_CORE=1
	export WRF_NMM_CORE=0
	export WRF_CHEM=1
	export WRF_KPP=1

	export YACC='/usr/bin/yacc -d'
	export FLEX=/usr/bin/flex

	# FLEX_LIB_DIR is already set above, no need to hardcode

	export KPP_HOME="${WRF_FOLDER}"/WRF-${WRF_VERSION}/chem/KPP/kpp/kpp-2.1
	export WRF_SRC_ROOT_DIR="${WRF_FOLDER}"/WRF-${WRF_VERSION}
	export PATH=$KPP_HOME/bin:$PATH
	export SED=/usr/bin/sed
	export WRFIO_NCD_LARGE_FILE_SUPPORT=1

	#Downloading WRF code

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/wrf-model/WRF/releases/download/v${WRF_VERSION}/v${WRF_VERSION}.tar.gz -O WRF-${WRF_VERSION}.tar.gz
	LD_LIBRARY_PATH= tar -xvzf WRF-${WRF_VERSION}.tar.gz -C "${WRF_FOLDER}"/

	# If statment for changing folder name
	# Check if WRF directory exists
	if [ -d "${WRF_FOLDER}/WRF" ]; then
		mv -f "${WRF_FOLDER}/WRF" "${WRF_FOLDER}/WRF-${WRF_VERSION}"

	# Else, check for any folder matching WRFV*
	else
		for dir in "${WRF_FOLDER}"/WRFV*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WRF-${WRF_VERSION}"
				break
			fi
		done
	fi
	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}

	LD_LIBRARY_PATH= ./clean -a

	sed -i '121s|$WKC_HOME/util/wkc/tuv_kpp FIRST ../../inc/|$WKC_HOME/util/wkc/tuv_kpp FIRST ../../../../inc/|g' "${WRF_FOLDER}"/WRF-${WRF_VERSION}/chem/KPP/compile_wkc

	if [ ${auto_config} -eq 1 ]; then
		(
			echo 34
			echo 1
		) | ./configure

	else
		./configure 2>&1 | tee configure.log #Option 34 gfortran compiler with distributed memory option 1 for basic nesting
	fi

	LD_LIBRARY_PATH= ./compile -j 2 em_real 2>&1 | tee compile.wrf1.log

	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/main
	n=$(ls ./*.exe | wc -l)
	if (($n >= 3)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}
		LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN em_real 2>&1 | tee compile.wrf2.log
		cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/main
		n=$(ls ./*.exe | wc -l)
		if (($n >= 3)); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}
	LD_LIBRARY_PATH= ./compile -j 2 emi_conv 2>&1 | tee compile.emis.log

	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/chem

	if [[ -f convert_emiss.exe ]]; then
		echo "All expected files created."

		# Create symbolic link in the main directory
		ln -sf "${WRF_FOLDER}/WRF-${WRF_VERSION}/chem/convert_emiss.exe" "${WRF_FOLDER}/WRF-${WRF_VERSION}/main/convert_emiss.exe"

		echo "Symbolic link created in main/"
		read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}
		LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN emi_conv 2>&1 | tee compile.emis2.log

		cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/chem
		if [[ -f convert_emiss.exe ]]; then
			echo "All expected files created after recompilation."

			# Create symbolic link in the main directory
			ln -sf "${WRF_FOLDER}/WRF-${WRF_VERSION}/chem/convert_emiss.exe" "${WRF_FOLDER}/WRF-${WRF_VERSION}/main/convert_emiss.exe"

			echo "Symbolic link created in main/"
			read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	export WRF_DIR="${WRF_FOLDER}"/WRF-${WRF_VERSION}

	############################WPS#####################################
	## WPS v${WPS_VERSION}
	## Downloaded from git tagged releases
	#Option 3 for gfortran and distributed memory
	########################################################################

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/wrf-model/WPS/archive/refs/tags/v${WPS_VERSION}.tar.gz -O WPS-${WPS_VERSION}.tar.gz
	LD_LIBRARY_PATH= tar -xvzf WPS-${WPS_VERSION}.tar.gz -C "${WRF_FOLDER}"/
	cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}

	LD_LIBRARY_PATH= ./clean -a

	if [ ${auto_config} -eq 1 ]; then
		echo 3 | ./configure 2>&1 | tee configure.log #Option 3 for gfortran and distributed memory
	else
		./configure 2>&1 | tee configure.log #Option 3 gfortran compiler with distributed memory
	fi
	LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.wps.log

	echo " "

	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
	n=$(ls ./*.exe | wc -l)
	if (($n == 3)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WPS. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.wps2.log
		cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
		n=$(ls ./*.exe | wc -l)
		if (($n == 3)); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WPS. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	echo " "

	######################## Static Geography Data inc/ Optional ####################
	# http://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html
	# These files are large so if you only need certain ones comment the others off
	# All files downloaded and untarred is 200GB
	# https://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html
	#################################################################################
	cd "${WRF_FOLDER}"/Downloads
	mkdir "${WRF_FOLDER}"/GEOG
	mkdir "${WRF_FOLDER}"/GEOG/WPS_GEOG

	echo " "
	echo "Mandatory WRF Preprocessing System (WPS) Geographical Input Data Mandatory Fields Downloads"
	echo " "
	wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_high_res_mandatory.tar.gz
	LD_LIBRARY_PATH= tar -xvzf geog_high_res_mandatory.tar.gz -C "${WRF_FOLDER}"/GEOG/

	wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_low_res_mandatory.tar.gz
	LD_LIBRARY_PATH= tar -xvzf geog_low_res_mandatory.tar.gz -C "${WRF_FOLDER}"/GEOG/
	mv "${WRF_FOLDER}"/GEOG/WPS_GEOG_LOW_RES/ "${WRF_FOLDER}"/GEOG/WPS_GEOG

	if [ ${WPS_Specific_Applications} -eq 1 ]; then
		echo " "
		echo " WPS Geographical Input Data Mandatory for Specific Applications"
		echo " "
		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_thompson28_chem.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_thompson28_chem.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_noahmp.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_noahmp.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/irrigation.tar.gz
		LD_LIBRARY_PATH= tar -xvzf irrigation.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_px.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_px.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_urban.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_urban.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_ssib.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_ssib.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/lake_depth.tar.bz2
		LD_LIBRARY_PATH= tar -xvf lake_depth.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/topobath_30s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf topobath_30s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/gsl_gwd.tar.bz2
		LD_LIBRARY_PATH= tar -xvf gsl_gwd.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/cglc_modis_lcz_global.tar.gz
		LD_LIBRARY_PATH= tar -xvf cglc_modis_lcz_global.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG
	fi

	if [ ${Optional_GEOG} -eq 1 ]; then

		echo " "
		echo "Optional WPS Geographical Input Data"
		echo " "

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_older_than_2000.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_older_than_2000.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/modis_landuse_20class_15s_with_lakes.tar.gz
		LD_LIBRARY_PATH= tar -xvzf modis_landuse_20class_15s_with_lakes.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_alt_lsm.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_alt_lsm.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/nlcd2006_ll_9s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf nlcd2006_ll_9s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/updated_Iceland_LU.tar.gz
		LD_LIBRARY_PATH= tar -xvf updated_Iceland_LU.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/modis_landuse_20class_15s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf modis_landuse_20class_15s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

	fi

fi

if [ "$Ubuntu_64bit_Intel" = "1" ] && [ "$WRFCHEM_PICK" = "1" ]; then

	############################# Basic package managment ############################

	echo $PASSWD | sudo -S apt -y update
	echo $PASSWD | sudo -S apt -y upgrade

	# download the key to system keyring; this and the following echo command are
	# needed in order to install the Intel compilers
	wget -O- https://apt.repos.intel.com/intel-gpg-keys/GPG-PUB-KEY-INTEL-SW-PRODUCTS.PUB |
		gpg --dearmor | sudo tee /usr/share/keyrings/oneapi-archive-keyring.gpg >/dev/null

	# add signed entry to apt sources and configure the APT client to use Intel repository:
	echo "deb [signed-by=/usr/share/keyrings/oneapi-archive-keyring.gpg] https://apt.repos.intel.com/oneapi all main" | sudo tee /etc/apt/sources.list.d/oneAPI.list

	# this update should get the Intel package info from the Intel repository
	echo $PASSWD | sudo -S apt -y update

	release_version=$(lsb_release -r -s)

	# Compare the release version
	if [ "$release_version" = "24.04" ]; then
		# Install Emacs without recommended packages
		echo $PASSWD | sudo -S apt install emacs --no-install-recommends -y
	else
		# Attempt to install Emacs if the release version is not 24.04
		echo "The release version is not 24.04, attempting to install Emacs."
		echo $PASSWD | sudo -S apt install emacs -y
	fi

	echo $PASSWD | sudo -S apt -y install bison build-essential byacc cmake csh curl default-jdk default-jre flex libfl-dev g++ gawk gcc gettext gfortran git ksh libcurl4-gnutls-dev libjpeg-dev libncurses6 libpixman-1-dev libpng-dev libtool libxml2 libxml2-dev libxml-libxml-perl m4 make ncview pipenv pkg-config python3 python3-dev python3-pip python3-dateutil tcsh unzip xauth xorg time

	# install the Intel compilers
	echo $PASSWD | sudo -S apt -y install intel-basekit
	echo $PASSWD | sudo -S apt -y install intel-hpckit
	echo $PASSWD | sudo -S apt -y install intel-oneapi-python
	/opt/intel/oneapi/intelpython/python3.12/bin/python3 -m pip install python-dateutil

	echo $PASSWD | sudo -S apt -y update

	#Fix any broken installations
	echo $PASSWD | sudo -S apt --fix-broken install

	# make sure some critical packages have been installed
	which cmake pkg-config make gcc g++ gfortran

	# add the Intel compiler file paths to various environment variables
	source /opt/intel/oneapi/setvars.sh --force

	# some of the libraries we install below need one or more of these variables
	export CC=icx
	export CXX=icpx
	export FC=ifx
	export F77=ifx
	export F90=ifx
	export MPIFC=mpiifx
	export MPIF77=mpiifx
	export MPIF90=mpiifx
	export MPICC=mpiicx
	export MPICXX=mpiicpx
	export CFLAGS="-fPIC -fPIE -O3 -Wno-implicit-function-declaration -Wno-incompatible-function-pointer-types -Wno-unused-command-line-argument"
	export FFLAGS="-m64"
	export FCFLAGS="-m64"
	############################# CPU Core Management ####################################

	export CPU_CORE=$(nproc) # number of available threads on system
	export CPU_6CORE="6"
	export CPU_QUARTER=$(($CPU_CORE / 4)) # quarter of availble cores on system
	# Forces CPU cores to even number to avoid partial core export. ie 7 cores would be 3.5 cores.
	export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))

	# If statement for low core systems.  Forces computers to only use 1 core if there are 4 cores or less on the system.
	if [ $CPU_CORE -le $CPU_6CORE ]; then
		export CPU_QUARTER_EVEN="2"
	else
		export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))
	fi

	echo "##########################################"
	echo "Number of Threads being used $CPU_QUARTER_EVEN"
	echo "##########################################"

	############################## Directory Listing ############################
	# makes necessary directories
	#
	############################################################################

	export HOME=$(
		cd
		pwd
	)
	export WRF_FOLDER=$HOME/WRFCHEM_Intel
	export DIR="${WRF_FOLDER}"/Libs
	mkdir "${WRF_FOLDER}"
	cd "${WRF_FOLDER}"
	mkdir Downloads
	mkdir WRFDA
	mkdir Libs
	mkdir Libs/grib2
	mkdir Libs/NETCDF
	mkdir Libs/MPICH

	mkdir -p Tests/Environment
	mkdir -p Tests/Compatibility

	echo " "
	############################## Downloading Libraries ############################

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/madler/zlib/releases/download/v$Zlib_Version/zlib-$Zlib_Version.tar.gz
	wget -c https://github.com/HDFGroup/hdf5/releases/download/hdf5_$HDF5_Version/hdf5-$HDF5_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-c/archive/refs/tags/v$Netcdf_C_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-fortran/archive/refs/tags/v$Netcdf_Fortran_Version.tar.gz
	wget -c https://download.sourceforge.net/libpng/libpng-$Libpng_Version.tar.gz
	wget -c https://www.ece.uvic.ca/~frodo/jasper/software/jasper-$Jasper_Version.zip
	wget -c https://parallel-netcdf.github.io/Release/pnetcdf-$Pnetcdf_Version.tar.gz

	echo " "
	############################# ZLib ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf zlib-$Zlib_Version.tar.gz
	cd zlib-$Zlib_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	export ZLIB_ROOT=$DIR/grib2
	export ZLIBLIB=$DIR/grib2/lib
	export ZLIBINC=$DIR/grib2/include

	echo " "
	############################# LibPNG ############################

	cd "${WRF_FOLDER}"/Downloads

	# other libraries below need these variables to be set
	export LDFLAGS=-L$DIR/grib2/lib
	export CPPFLAGS=-I$DIR/grib2/include

	LD_LIBRARY_PATH= tar -xvzf libpng-$Libpng_Version.tar.gz
	cd libpng-$Libpng_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNG_ROOT=$DIR/grib2

	echo " "
	############################# JasPer ############################

	cd "${WRF_FOLDER}"/Downloads
	unzip jasper-$Jasper_Version.zip
	cd jasper-$Jasper_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	# other libraries below need these variables to be set
	export JASPERLIB=$DIR/grib2/lib
	export JASPERINC=$DIR/grib2/include
	export JASPER_DIR=$DIR/grib2
	export Jasper_ROOT=$DIR/grib2/lib

	echo " "
	############################# HDF5 library for NetCDF4 & parallel functionality ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf hdf5-$HDF5_Version.tar.gz
	cd hdf5-$HDF5_Version

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --with-zlib=$DIR/grib2 --enable-hl --enable-fortran --enable-parallel 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	# other libraries below need these variables to be set
	export HDF5=$DIR/grib2
	export PATH=$HDF5/bin:$PATH
	export PHDF5=$DIR/grib2
	export HDF5_ROOT=$DIR/grib2
	export PHDF5_ROOT=$DIR/grib2

	echo " "

	############################# Install Parallel-netCDF ##############################
	#Make file created with half of available cpu cores
	#Hard path for MPI added
	##################################################################################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf pnetcdf-$Pnetcdf_Version.tar.gz
	cd pnetcdf-$Pnetcdf_Version
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --enable-static 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNETCDF=$DIR/grib2
	export PNETCDF_DIR=$DIR/grib2
	export PNETCDF_ROOT=$DIR/grib2

	echo " "

	############################## Install NETCDF-C Library ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_C_Version.tar.gz
	cd netcdf-c-$Netcdf_C_Version/

	# these variables need to be set for the NetCDF-C install to work
	export CPPFLAGS=-I$DIR/grib2/include
	export LDFLAGS="-L$DIR/grib2/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lhdf5_hl -lhdf5 -lz -lcurl -lgcc -lm -ldl -lpnetcdf"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --disable-dap --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-pnetcdf --enable-cdf5 --enable-parallel-tests --enable-logging 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	# other libraries below need these variables to be set
	export PATH=$DIR/NETCDF/bin:$PATH
	export NETCDF=$DIR/NETCDF
	export NETCDF_INC=$DIR/NETCDF/include
	export NETCDF_LIB=$DIR/NETCDF/lib
	export NETCDF_ROOT=$DIR/NETCDF
	export LD_LIBRARY_PATH=$DIR/grib2/lib:$DIR/NETCDF/lib:$LD_LIBRARY_PATH

	echo " "
	############################## NetCDF-Fortran library ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_Fortran_Version.tar.gz
	cd netcdf-fortran-$Netcdf_Fortran_Version/

	# these variables need to be set for the NetCDF-Fortran install to work
	export LD_LIBRARY_PATH=$DIR/NETCDF/lib:$LD_LIBRARY_PATH
	export CPPFLAGS="-I$DIR/NETCDF/include -I$DIR/grib2/include"
	export LDFLAGS="-L$DIR/NETCDF/lib -L$DIR/grib2/lib -Wl,-rpath,$DIR/NETCDF/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lnetcdf -lpnetcdf -lcurl -lhdf5_hl -lhdf5 -lz -lm -ldl -lgcc"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-parallel-tests --enable-logging --enable-hdf5 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	echo " "
	#################################### System Environment Tests ##############

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_NETCDF_MPI_tests.tar
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_tests.tar

	LD_LIBRARY_PATH= tar -xvf Fortran_C_tests.tar -C "${WRF_FOLDER}"/Tests/Environment
	LD_LIBRARY_PATH= tar -xvf Fortran_C_NETCDF_MPI_tests.tar -C "${WRF_FOLDER}"/Tests/Compatibility

	export one="1"
	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Environment

	echo " "
	echo " "
	echo "Environment Testing "
	echo "Test 1"
	$FC TEST_1_fortran_only_fixed.f
	./a.out | tee env_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 1 Passed"
	else
		echo "Environment Compiler Test 1 Failed"
		exit
	fi
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 2"
	$FC TEST_2_fortran_only_free.f90
	./a.out | tee env_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 2 Passed"
	else
		echo "Environment Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 3"
	$CC TEST_3_c_only.c
	./a.out | tee env_test3.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test3.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 3 Passed"
	else
		echo "Environment Compiler Test 3 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 4"
	$CC -c -m64 TEST_4_fortran+c_c.c
	$FC -c -m64 TEST_4_fortran+c_f.f90
	$FC -m64 TEST_4_fortran+c_f.o TEST_4_fortran+c_c.o
	./a.out | tee env_test4.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test4.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 4 Passed"
	else
		echo "Environment Compiler Test 4 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Compatibility

	cp ${NETCDF}/include/netcdf.inc .

	echo " "
	echo " "
	echo "Library Compatibility Tests "
	echo "Test 1"
	$FC -c 01_fortran+c+netcdf_f.f
	$CC -c 01_fortran+c+netcdf_c.c
	$FC 01_fortran+c+netcdf_f.o 01_fortran+c+netcdf_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	./a.out | tee comp_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 1 Passed"
	else
		echo "Compatibility Compiler Test 1 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "

	echo "Test 2"
	$MPIFC -c 02_fortran+c+netcdf+mpi_f.f
	$MPICC -c 02_fortran+c+netcdf+mpi_c.c
	$MPIFC 02_fortran+c+netcdf+mpi_f.o \
		02_fortran+c+netcdf+mpi_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	mpirun ./a.out | tee comp_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 2 Passed"
	else
		echo "Compatibility Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."
	echo " "

	echo " All tests completed and passed"
	echo " "

	################################OpenGrADS######################################
	#Verison 2.2.1 64bit of Linux
	#############################################################################
	if [[ $GRADS_PICK -eq 1 ]]; then
		cd "${WRF_FOLDER}"/Downloads
		LD_LIBRARY_PATH= tar -xvzf cd "${WRF_FOLDER}"/Downloads
		wget -c https://sourceforge.net/projects/opengrads/files/grads2/2.2.1.oga.1/Linux%20%2864%20Bits%29/opengrads-2.2.1.oga.1-bundle-x86_64-pc-linux-gnu-glibc_2.17.tar.gz
		LD_LIBRARY_PATH= tar -xvzf opengrads-2.2.1.oga.1-bundle-x86_64-pc-linux-gnu-glibc_2.17.tar.gz -C "${WRF_FOLDER}"/ -C "${WRF_FOLDER}"/
		cd "${WRF_FOLDER}"/
		mv "${WRF_FOLDER}"/opengrads-2.2.1.oga.1 "${WRF_FOLDER}"/GrADS
		cd GrADS/Contents
		wget -c https://github.com/regisgrundig/SIMOP/blob/master/g2ctl.pl
		chmod +x g2ctl.pl
		wget -c https://sourceforge.net/projects/opengrads/files/wgrib2/0.1.9.4/wgrib2-v0.1.9.4-bin-x86_64-glibc2.5-linux-gnu.tar.gz
		LD_LIBRARY_PATH= tar -xvzf wgrib2-v0.1.9.4-bin-x86_64-glibc2.5-linux-gnu.tar.gz
		cd wgrib2-v0.1.9.4/bin
		mv wgrib2 "${WRF_FOLDER}"/GrADS/Contents
		cd "${WRF_FOLDER}"/GrADS/Contents
		rm wgrib2-v0.1.9.4-bin-x86_64-glibc2.5-linux-gnu.tar.gz
		rm -r wgrib2-v0.1.9.4

		export PATH="${WRF_FOLDER}"/GrADS/Contents:$PATH
	fi
	################################## GrADS ###############################
	# Version  2.2.1
	# Sublibs library instructions: http://cola.gmu.edu/grads/gadoc/supplibs2.html
	# GrADS instructions: http://cola.gmu.edu/grads/downloads.php
	########################################################################
	if [[ $GRADS_PICK -eq 2 ]]; then

		echo $PASSWD | sudo -S apt -y install grads

	fi

	##################### NCAR COMMAND LANGUAGE           ##################
	########### NCL compiled via Conda                    ##################
	########### This is the preferred method by NCAR      ##################
	########### https://www.ncl.ucar.edu/index.shtml      ##################
	echo " "
	#Installing Miniconda3 to WRF directory and updating libraries
	echo $PASSWD | sudo -S apt -y install python3-zstandard python3-zstd

	export Miniconda_Install_DIR="${WRF_FOLDER}"/miniconda3

	mkdir -p $Miniconda_Install_DIR

	wget -c https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O $Miniconda_Install_DIR/miniconda.sh
	bash $Miniconda_Install_DIR/miniconda.sh -b -u -p $Miniconda_Install_DIR

	rm -rf $Miniconda_Install_DIR/miniconda.sh

	export PATH="${WRF_FOLDER}"/miniconda3/bin:$PATH

	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	$Miniconda_Install_DIR/bin/conda init bash

	conda tos accept
	conda config --add channels conda-forge
	conda config --set auto_activate_base false
	conda update -n root --all -y

	#Special Thanks to @_WaylonWalker for code development

	#Installing NCL via Conda
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	conda create -n ncl_stable -c conda-forge ncl -y
	conda activate ncl_stable

	conda deactivate
	conda deactivate
	conda deactivate

	echo " "

	############################OBSGRID###############################
	## OBSGRID
	## Downloaded from git tagged releases
	## Option #3
	########################################################################
	cd "${WRF_FOLDER}"/
	git clone https://github.com/wrf-model/OBSGRID.git
	cd "${WRF_FOLDER}"/OBSGRID

	LD_LIBRARY_PATH= ./clean -a
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh
	conda activate ncl_stable

	export HOME=$(
		cd
		pwd
	)
	export DIR="${WRF_FOLDER}"/Libs
	export NETCDF=$DIR/NETCDF

	if [ ${auto_config} -eq 1 ]; then
		echo 3 | ./configure 2>&1 | tee configure.log #Option 3 for itnel and distribunted memory
	else
		./configure 2>&1 | tee configure.log #Option 3 for intel and distribunted memory
	fi

	sed -i '27s/-lnetcdf -lnetcdff/ -lnetcdff -lnetcdf/g' configure.oa

	sed -i '31s/-lncarg -lncarg_gks -lncarg_c -lX11 -lm -lcairo/-lncarg -lncarg_gks -lncarg_c -lX11 -lm -lcairo -lfontconfig -lpixman-1 -lfreetype -lhdf5 -lhdf5_hl /g' configure.oa

	sed -i '38s/ifort/ifx/g' configure.oa
	sed -i '43s/gcc/icx/g' configure.oa
	sed -i '45s|/lib/cpp|ifx|g' configure.oa
	sed -i '46s|-I. -C -P -DDEC -traditional|-fpp -DDEC -I.|g' configure.oa

	# Patch .F90.o rule to use direct compile with Intel Fortran + fpp
	sed -i '/^\.F90\.o:/,/^\t\$(RM) \$\*\.f/ c\.F90.o:\n\t$(RM) $@ $*.mod\n\t$(FC) $(FFLAGS) -fpp $(CPPFLAGS) ${NETCDF_INC} -c $<' configure.oa

	echo " "
	LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.obsgrid.log

	conda deactivate
	conda deactivate
	conda deactivate

	echo " "
	# IF statement to check that all files were created.
	if [[ -x ./obsgrid.exe ]]; then
		echo "obsgrid.exe found."
		read -r -t 5 -p "Finished installing OBSGRID. I am going to wait for 5 seconds only ..."
	else
		echo "obsgrid.exe is missing. Attempting to compile again..."

		LD_LIBRARY_PATH= ./clean -a
		LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.obsgrid.retry.log

		if [[ -x ./obsgrid.exe ]]; then
			echo "obsgrid.exe successfully created after recompilation."
			read -r -t 5 -p "Finished retrying OBSGRID compile. I am going to wait for 5 seconds only ..."
		else
			echo "Still missing obsgrid.exe after recompile. Exiting the script."
			read -r -p "Please contact script authors for assistance. Press 'Enter' to exit."
			exit 1
		fi
	fi

	echo " "

	##################### WRF Python           ##################
	########### WRf-Python compiled via Conda  ##################
	########### This is the preferred method by NCAR      ##################
	##### https://wrf-python.readthedocs.io/en/latest/installation.html  ##################
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh
	conda env create -f $HOME/WRF-MOSIT/wrf-python-stable.yml

	######################### Climate Data Operators ############
	######################### CDO compiled via Conda ###########
	####################### This is the preferred method #######
	################### https://bairdlangenbrunner.github.io/python-for-climate-scientists/conda/setting-up-conda-environments.html #######################

	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	conda create --name cdo_stable -y
	conda activate cdo_stable
	conda install -c conda-forge cdo -y
	conda update --all -y
	conda deactivate
	conda deactivate
	conda deactivate

	echo " "

	############################WRFDA 3DVAR###############################
	## WRFDA v${WPS_VERSION} 3DVAR
	## Downloaded from git tagged releases
	## Does not include RTTOV Libarary for radiation data.  If wanted will need to install library then reconfigure
	##Note: if you intend to run both 3DVAR and 4DVAR experiments, it is not necessary to compile the code twice.
	#Option 34 for gfortran/gcc and distribunted memory
	########################################################################
	source /opt/intel/oneapi/setvars.sh --force

	cd "${WRF_FOLDER}"/Downloads
	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/wrf-model/WRF/releases/download/v${WRF_VERSION}/v${WRF_VERSION}.tar.gz -O WRF-${WRF_VERSION}.tar.gz
	mkdir -p "${WRF_FOLDER}"/WRFDA
	LD_LIBRARY_PATH= tar -xvzf WRF-${WRF_VERSION}.tar.gz -C "${WRF_FOLDER}"/WRFDA
	# If statement for changing folder name inside WRFDA
	if [ -d "${WRF_FOLDER}/WRFDA/WRF" ]; then
		mv -f "${WRF_FOLDER}/WRFDA/WRF" "${WRF_FOLDER}/WRFDA/WRF-${WRF_VERSION}"

	else
		for dir in "${WRF_FOLDER}/WRFDA"/WRFV*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WRFDA/WRF-${WRF_VERSION}"
				break
			fi
		done
	fi
	cd "${WRF_FOLDER}"/WRFDA/WRF-${WRF_VERSION}
	mv * "${WRF_FOLDER}"/WRFDA
	cd "${WRF_FOLDER}"/WRFDA
	rm -rf WRF-${WRF_VERSION}/
	cd "${WRF_FOLDER}"/WRFDA

	ulimit -s unlimited
	export WRF_CHEM=1
	export WRFIO_NCD_LARGE_FILE_SUPPORT=1

	LD_LIBRARY_PATH= ./clean -a

	if [ ${auto_config} -eq 1 ]; then
		echo 78 | ./configure wrfda 2>&1 | tee configure.log #option 78 for intel and distribunted memory
	else
		./configure wrfda 2>&1 | tee configure.log #option 78 for intel and distribunted memory
	fi
	echo " "

	#Need to remove mpich/GNU config calls to Intel config calls
	sed -i '136s|mpif90 -f90=$(SFC)|mpiifx|g' "${WRF_FOLDER}"/WRFDA/configure.wrf
	sed -i '137s|mpicc -cc=$(SCC)|mpiicx|g' "${WRF_FOLDER}"/WRFDA/configure.wrf

	LD_LIBRARY_PATH= ./compile -j 4 all_wrfvar 2>&1 | tee compile.chem.wrfvar.log
	echo " "

	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WRFDA/var/da
	n=$(ls ./*.exe | wc -l)
	cd "${WRF_FOLDER}"/WRFDA/var/obsproc/src
	m=$(ls ./*.exe | wc -l)
	if ((($n == 43) && ($m == 1))); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WRFDA. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		cd "${WRF_FOLDER}"/WRFDA
		LD_LIBRARY_PATH= ./compile -j 2 all_wrfvar 2>&1 | tee compile.chem.wrfvar2.log
		cd "${WRF_FOLDER}"/WRFDA/var/da
		n=$(ls ./*.exe | wc -l)
		cd "${WRF_FOLDER}"/WRFDA/var/obsproc/src
		m=$(ls ./*.exe | wc -l)
		if ((($n == 43) && ($m == 1))); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WRFDA. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi
	echo " "

	############################ WRF #################################
	## WRF v${WPS_VERSION}
	## Downloaded from git tagged releases
	# option 78, option 1 for intel and distributed memory w/basic nesting
	# large file support enable with WRFiO_NCD_LARGE_FILE_SUPPORT=1
	########################################################################

	cd /tmp

	# Download the flex 2.6.4 source tarball
	wget https://github.com/westes/flex/releases/download/v2.6.4/flex-2.6.4.tar.gz

	# Extract it
	tar -xzf flex-2.6.4.tar.gz
	cd flex-2.6.4

	# Configure to install into /usr (so libs go to /usr/lib64)
	./configure --prefix=/usr/ 2>&1 | tee "${WRF_FOLDER}"/Downloads/flex.configure.log

	# Build
	make 2>&1 | tee "${WRF_FOLDER}"/Downloads/flex.make.log

	# Install (will prompt for sudo password)
	echo $PASSWD | sudo -S make install

	# --------------------------------------------------------
	# Detect Flex library location automatically
	# --------------------------------------------------------
	FLEX_LIB_PATH=$(find /usr /usr/local -type f \( -name "libfl.a" -o -name "libfl.so" \) 2>/dev/null | head -n 1)
	# Extract the directory name only
	FLEX_LIB_DIR=$(dirname "$FLEX_LIB_PATH")

	# Export it for WRF configure
	export FLEX_LIB_DIR
	echo "FLEX_LIB_DIR set to $FLEX_LIB_DIR"

	# --------------------------------------------------------
	# Setting up WRF-CHEM/KPP environment
	# --------------------------------------------------------
	cd "${WRF_FOLDER}"/Downloads

	ulimit -s unlimited
	export WRF_EM_CORE=1
	export WRF_NMM_CORE=0
	export WRF_CHEM=1
	export WRF_KPP=1

	export YACC='/usr/bin/yacc -d'
	export FLEX=/usr/bin/flex

	# FLEX_LIB_DIR is already set above, no need to hardcode

	export KPP_HOME="${WRF_FOLDER}"/WRF-${WRF_VERSION}/chem/KPP/kpp/kpp-2.1
	export WRF_SRC_ROOT_DIR="${WRF_FOLDER}"/WRF-${WRF_VERSION}
	export PATH=$KPP_HOME/bin:$PATH
	export SED=/usr/bin/sed
	export WRFIO_NCD_LARGE_FILE_SUPPORT=1

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/wrf-model/WRF/releases/download/v${WRF_VERSION}/v${WRF_VERSION}.tar.gz -O WRF-${WRF_VERSION}.tar.gz
	LD_LIBRARY_PATH= tar -xvzf WRF-${WRF_VERSION}.tar.gz -C "${WRF_FOLDER}"/
	# If statment for changing folder name
	# Check if WRF directory exists
	if [ -d "${WRF_FOLDER}/WRF" ]; then
		mv -f "${WRF_FOLDER}/WRF" "${WRF_FOLDER}/WRF-${WRF_VERSION}"

	# Else, check for any folder matching WRFV*
	else
		for dir in "${WRF_FOLDER}"/WRFV*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WRF-${WRF_VERSION}"
				break
			fi
		done
	fi
	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}

	export WRFIO_NCD_LARGE_FILE_SUPPORT=1
	LD_LIBRARY_PATH= ./clean -a

	sed -i '121s|$WKC_HOME/util/wkc/tuv_kpp FIRST ../../inc/|$WKC_HOME/util/wkc/tuv_kpp FIRST ../../../../inc/|g' "${WRF_FOLDER}"/WRF-${WRF_VERSION}/chem/KPP/compile_wkc

	if [ ${auto_config} -eq 1 ]; then
		(
			echo 78
			echo 1
		) | ./configure

	else
		./configure 2>&1 | tee configure.log #option 78 intel compiler with distributed memory option 1 for basic nesting
	fi

	#Need to remove mpich/GNU config calls to Intel config calls
	sed -i '136s|mpif90 -f90=$(SFC)|mpiifx|g' "${WRF_FOLDER}"/WRF-${WRF_VERSION}/configure.wrf
	sed -i '137s|mpicc -cc=$(SCC)|mpiicx|g' "${WRF_FOLDER}"/WRF-${WRF_VERSION}/configure.wrf

	LD_LIBRARY_PATH= ./compile -j 2 em_real 2>&1 | tee compile.wrf1.log

	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/main
	n=$(ls ./*.exe | wc -l)
	if (($n >= 3)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}
		LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN em_real 2>&1 | tee compile.wrf2.log
		cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/main
		n=$(ls ./*.exe | wc -l)
		if (($n >= 3)); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}
	LD_LIBRARY_PATH= ./compile -j 2 emi_conv 2>&1 | tee compile.emis.log

	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/chem

	if [[ -f convert_emiss.exe ]]; then
		echo "All expected files created."

		# Create symbolic link in the main directory
		ln -sf "${WRF_FOLDER}/WRF-${WRF_VERSION}/chem/convert_emiss.exe" "${WRF_FOLDER}/WRF-${WRF_VERSION}/main/convert_emiss.exe"

		echo "Symbolic link created in main/"
		read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}
		LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN emi_conv 2>&1 | tee compile.emis2.log

		cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/chem
		if [[ -f convert_emiss.exe ]]; then
			echo "All expected files created after recompilation."

			# Create symbolic link in the main directory
			ln -sf "${WRF_FOLDER}/WRF-${WRF_VERSION}/chem/convert_emiss.exe" "${WRF_FOLDER}/WRF-${WRF_VERSION}/main/convert_emiss.exe"

			echo "Symbolic link created in main/"
			read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	export WRF_DIR="${WRF_FOLDER}"/WRF-${WRF_VERSION}

	############################WPS#####################################
	## WPS v${WPS_VERSION}
	## Downloaded from git tagged releases
	#Option 3 for gfortran and distributed memory
	########################################################################

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/wrf-model/WPS/archive/refs/tags/v${WPS_VERSION}.tar.gz -O WPS-${WPS_VERSION}.tar.gz
	LD_LIBRARY_PATH= tar -xvzf WPS-${WPS_VERSION}.tar.gz -C "${WRF_FOLDER}"/
	# Check if WPS directory exists
	if [ -d "${WRF_FOLDER}/WPS" ]; then
		mv -f "${WRF_FOLDER}/WPS" "${WRF_FOLDER}/WPS-${WPS_VERSION}"

	# Else, check for any folder matching WPSV* or WPS-*
	else
		for dir in "${WRF_FOLDER}"/WPSV* "${WRF_FOLDER}"/WPS-*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WPS-${WPS_VERSION}"
				break
			fi
		done
	fi
	cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
	LD_LIBRARY_PATH= ./clean -a

	sed -i '77s|real ::|integer ::|g' $"${WRF_FOLDER}"/WPS-${WPS_VERSION}/ungrib/src/rd_grib2.F

	if [ ${auto_config} -eq 1 ]; then
		echo 19 | ./configure 2>&1 | tee configure.log #Option 19 for intel and distributed memory
	else
		./configure 2>&1 | tee configure.log #Option 19 intel compiler with distributed memory
	fi

	sed -i '67s|mpif90|mpiifx|g' "${WRF_FOLDER}"/WPS-${WPS_VERSION}/configure.wps
	sed -i '68s|mpicc|mpiicx|g' "${WRF_FOLDER}"/WPS-${WPS_VERSION}/configure.wps

	LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.wps.log

	echo " "
	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
	n=$(ls ./*.exe | wc -l)
	if (($n == 3)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WPS. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.wps2.log
		cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
		n=$(ls ./*.exe | wc -l)
		if (($n == 3)); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WPS. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	echo " "

	######################## Static Geography Data inc/ Optional ####################
	# http://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html
	# These files are large so if you only need certain ones comment the others off
	# All files downloaded and untarred is 200GB
	# https://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html
	#################################################################################
	cd "${WRF_FOLDER}"/Downloads
	mkdir "${WRF_FOLDER}"/GEOG
	mkdir "${WRF_FOLDER}"/GEOG/WPS_GEOG

	echo " "
	echo "Mandatory WRF Preprocessing System (WPS) Geographical Input Data Mandatory Fields Downloads"
	echo " "
	wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_high_res_mandatory.tar.gz
	LD_LIBRARY_PATH= tar -xvzf geog_high_res_mandatory.tar.gz -C "${WRF_FOLDER}"/GEOG/

	wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_low_res_mandatory.tar.gz
	LD_LIBRARY_PATH= tar -xvzf geog_low_res_mandatory.tar.gz -C "${WRF_FOLDER}"/GEOG/
	mv "${WRF_FOLDER}"/GEOG/WPS_GEOG_LOW_RES/ "${WRF_FOLDER}"/GEOG/WPS_GEOG

	if [ ${WPS_Specific_Applications} -eq 1 ]; then
		echo " "
		echo " WPS Geographical Input Data Mandatory for Specific Applications"
		echo " "

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_thompson28_chem.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_thompson28_chem.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_noahmp.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_noahmp.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/irrigation.tar.gz
		LD_LIBRARY_PATH= tar -xvzf irrigation.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_px.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_px.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_urban.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_urban.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_ssib.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_ssib.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/lake_depth.tar.bz2
		LD_LIBRARY_PATH= tar -xvf lake_depth.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/topobath_30s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf topobath_30s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/gsl_gwd.tar.bz2
		LD_LIBRARY_PATH= tar -xvf gsl_gwd.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/cglc_modis_lcz_global.tar.gz
		LD_LIBRARY_PATH= tar -xvf cglc_modis_lcz_global.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG
	fi

	if [ ${Optional_GEOG} -eq 1 ]; then
		echo " "
		echo "Optional WPS Geographical Input Data"
		echo " "

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_older_than_2000.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_older_than_2000.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/modis_landuse_20class_15s_with_lakes.tar.gz
		LD_LIBRARY_PATH= tar -xvzf modis_landuse_20class_15s_with_lakes.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_alt_lsm.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_alt_lsm.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/nlcd2006_ll_9s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf nlcd2006_ll_9s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/updated_Iceland_LU.tar.gz
		LD_LIBRARY_PATH= tar -xvf updated_Iceland_LU.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/modis_landuse_20class_15s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf modis_landuse_20class_15s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG
	fi

fi

if [ "$macos_64bit_GNU" = "1" ] && [ "$WRFCHEM_PICK" = "1" ] && [ "$MAC_CHIP" = "Intel" ]; then

	#############################basic package managment############################
	brew cleanup -s
	brew update
	outdated_packages=$(brew outdated --quiet)

	# List of packages to check/install
	packages=(
		"autoconf" "automake" "bison" "byacc" "cmake" "curl" "flex" "gcc"
		"gedit" "git" "gnu-sed" "ksh"
		"libtool" "libxml2" "m4" "make" "python@3.12" "tcsh" "wget"
		"xauth" "xorgproto" "xorgrgb" "xquartz"
	)

	for pkg in "${packages[@]}"; do
		if brew list "$pkg" &>/dev/null; then
			echo "$pkg is already installed."
			if [[ $outdated_packages == *"$pkg"* ]]; then
				echo "$pkg has a newer version available. Upgrading..."
				brew upgrade "$pkg"
			fi
		else
			echo "$pkg is not installed. Installing..."
			brew install "$pkg"
		fi
		sleep 1
	done

	export LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH
	export PATH=/usr/local/bin:$PATH

	##############################Directory Listing############################

	export HOME=$(
		cd
		pwd
	)
	mkdir $HOME/WRFCHEM
	export WRF_FOLDER=$HOME/WRFCHEM
	cd "${WRF_FOLDER}"/
	mkdir Downloads
	mkdir WRFDA
	mkdir Libs
	export DIR="${WRF_FOLDER}"/Libs
	mkdir -p Libs/grib2
	mkdir -p Libs/NETCDF
	mkdir -p Tests/Environment
	mkdir -p Tests/Compatibility

	#############################Core Management####################################
	export CPU_CORE=$(sysctl -n hw.ncpu) # number of available threads on system
	export CPU_6CORE="6"
	export CPU_QUARTER=$(($CPU_CORE / 4))
	#1/2 of availble cores on system
	export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))
	#Forces CPU cores to even number to avoid partial core export. ie 7 cores would be 3.5 cores.

	if [ $CPU_CORE -le $CPU_6CORE ]; then #If statement for low core systems.  Forces computers to only use 1 core if there are 4 cores or less on the system. then
		export CPU_QUARTER_EVEN="2"
	else
		export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))
	fi

	echo "##########################################"
	echo "Number of Threads being used $CPU_QUARTER_EVEN"
	echo "##########################################"
	echo " "

	##############################Downloading Libraries############################

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/madler/zlib/releases/download/v$Zlib_Version/zlib-$Zlib_Version.tar.gz
	wget -c https://github.com/HDFGroup/hdf5/releases/download/hdf5_$HDF5_Version/hdf5-$HDF5_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-c/archive/refs/tags/v$Netcdf_C_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-fortran/archive/refs/tags/v$Netcdf_Fortran_Version.tar.gz
	wget -c https://download.sourceforge.net/libpng/libpng-$Libpng_Version.tar.gz
	wget -c https://www.ece.uvic.ca/~frodo/jasper/software/jasper-$Jasper_Version.zip
	wget -c https://github.com/pmodels/mpich/releases/download/v$Mpich_Version/mpich-$Mpich_Version.tar.gz
	wget -c https://parallel-netcdf.github.io/Release/pnetcdf-$Pnetcdf_Version.tar.gz

	echo " "

	############################# Compilers #############################

	# Symlink to avoid clang conflicts with compilers
	# Default gcc path: /usr/bin/gcc
	# Default homebrew path: /usr/local/bin

	# Find the highest version of GCC, G++, and GFortran in /usr/local/bin
	latest_gcc=$(ls /usr/local/bin/gcc-* 2>/dev/null | grep -o 'gcc-[0-9]*' | sort -V | tail -n 1)
	latest_gpp=$(ls /usr/local/bin/g++-* 2>/dev/null | grep -o 'g++-[0-9]*' | sort -V | tail -n 1)
	latest_gfortran=$(ls /usr/local/bin/gfortran-* 2>/dev/null | grep -o 'gfortran-[0-9]*' | sort -V | tail -n 1)

	# Display the chosen versions
	echo "Selected gcc version: $latest_gcc"
	echo "Selected g++ version: $latest_gpp"
	echo "Selected gfortran version: $latest_gfortran"

	# Check if GCC was found

	# Create or update the symbolic links for GCC, G++, and GFortran
	echo "Linking the latest GCC version: $latest_gcc"
	echo $PASSWD | sudo -S ln -sf /usr/local/bin/$latest_gcc /usr/local/bin/gcc

	echo "Linking the latest G++ version: $latest_gpp"
	echo $PASSWD | sudo -S ln -sf /usr/local/bin/$latest_gpp /usr/local/bin/g++

	echo "Linking the latest GFortran version: $latest_gfortran"
	echo $PASSWD | sudo -S ln -sf /usr/local/bin/$latest_gfortran /usr/local/bin/gfortran

	echo "Updated symbolic links for GCC, G++, and GFortran."
	echo $PASSWD | sudo -S ln -sf /usr/local/bin/python3.12 /usr/local/bin/python3

	# Export compiler environment variables
	export CC=gcc
	export CXX=g++
	export FC=gfortran
	export F77=gfortran
	export CFLAGS="-fPIC -fPIE -Wno-implicit-function-declaration -Wno-incompatible-pointer-types -Wall"

	echo " "

	############################# End of Compiler Setup #############################

	echo " "

	#IF statement for GNU compiler issue
	export GCC_VERSION=$(/usr/local/bin/$latest_gcc -dumpfullversion | awk '{print$1}')
	export GFORTRAN_VERSION=$(/usr/local/bin/$latest_gfortran -dumpfullversion | awk '{print$1}')
	export GPLUSPLUS_VERSION=$(/usr/local/bin/$latest_gpp -dumpfullversion | awk '{print$1}')

	export GCC_VERSION_MAJOR_VERSION=$(echo $GCC_VERSION | awk -F. '{print $1}')
	export GFORTRAN_VERSION_MAJOR_VERSION=$(echo $GFORTRAN_VERSION | awk -F. '{print $1}')
	export GPLUSPLUS_VERSION_MAJOR_VERSION=$(echo $GPLUSPLUS_VERSION | awk -F. '{print $1}')

	export version_10="10"

	if [ $GCC_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GFORTRAN_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GPLUSPLUS_VERSION_MAJOR_VERSION -ge $version_10 ]; then
		export fallow_argument=-fallow-argument-mismatch
		export boz_argument=-fallow-invalid-boz
	else
		export fallow_argument=
		export boz_argument=
	fi

	export FFLAGS="$fallow_argument -m64"
	export FCFLAGS="$fallow_argument -m64"

	echo "##########################################"
	echo "FFLAGS = $FFLAGS"
	echo "FCFLAGS = $FCFLAGS"
	echo "CFLAGS = $CFLAGS"
	echo "##########################################"

	echo " "

	############################# ZLib ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf zlib-$Zlib_Version.tar.gz
	cd zlib-$Zlib_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	export ZLIB_ROOT=$DIR/grib2
	export ZLIBLIB=$DIR/grib2/lib
	export ZLIBINC=$DIR/grib2/include

	echo " "
	############################## MPICH ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf mpich-$Mpich_Version.tar.gz
	cd mpich-$Mpich_Version/

	F90= ./configure --prefix=$DIR/MPICH --with-device=ch3 FFLAGS="$fallow_argument -m64" FCFLAGS="$fallow_argument -m64" 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee install.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/MPICH/bin:$PATH
	export MPIFC=$DIR/MPICH/bin/mpifort
	export MPIF77=$DIR/MPICH/bin/mpifort
	export MPIF90=$DIR/MPICH/bin/mpifort
	export MPICC=$DIR/MPICH/bin/mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx

	echo " "

	############################# libpng ############################

	cd "${WRF_FOLDER}"/Downloads

	# other libraries below need these variables to be set
	export LDFLAGS=-L$DIR/grib2/lib
	export CPPFLAGS=-I$DIR/grib2/include

	LD_LIBRARY_PATH= tar -xvzf libpng-$Libpng_Version.tar.gz
	cd libpng-$Libpng_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNG_ROOT=$DIR/grib2

	echo " "
	#############################JasPer ############################

	cd "${WRF_FOLDER}"/Downloads
	unzip jasper-$Jasper_Version.zip
	cd jasper-$Jasper_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee install.log
	export JASPERLIB=$DIR/grib2/lib
	export JASPERINC=$DIR/grib2/include
	export JASPER_DIR=$DIR/grib2
	export Jasper_ROOT=$DIR/grib2/lib

	echo " "
	############################# hdf5 library for netcdf4 functionality ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf hdf5-$HDF5_Version.tar.gz
	cd hdf5-$HDF5_Version

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --with-zlib=$DIR/grib2 --enable-hl --enable-fortran --enable-parallel 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export HDF5=$DIR/grib2
	export PATH=$HDF5/bin:$PATH
	export PHDF5=$DIR/grib2
	export HDF5_ROOT=$DIR/grib2
	export PHDF5_ROOT=$DIR/grib2

	echo " "

	############################# Install Parallel-netCDF ##############################
	#Make file created with half of available cpu cores
	#Hard path for MPI added
	##################################################################################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf pnetcdf-$Pnetcdf_Version.tar.gz
	cd pnetcdf-$Pnetcdf_Version

	export MPIFC=$DIR/MPICH/bin/mpifort
	export MPIF77=$DIR/MPICH/bin/mpifort
	export MPIF90=$DIR/MPICH/bin/mpifort
	export MPICC=$DIR/MPICH/bin/mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx

	# drop --disable-utils (not recognized)
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS="-std=gnu99 $CFLAGS" FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --enable-static 2>&1 | tee configure.log

	# build only libraries
	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log

	# install only libraries and headers
	make install 2>&1 | tee make.install.log

	export PNETCDF=$DIR/grib2
	export PNETCDF_DIR=$DIR/grib2
	export PNETCDF_ROOT=$DIR/grib2

	echo " "

	read -r -t 3 -p

	############################## Install NETCDF C Library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_C_Version.tar.gz
	cd netcdf-c-$Netcdf_C_Version/
	export CPPFLAGS=-I$DIR/grib2/include
	export LDFLAGS="-L$DIR/grib2/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lhdf5_hl -lhdf5 -lz -lcurl -lgfortran -lgcc -lm -ldl -lpnetcdf"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --disable-dap --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-pnetcdf --enable-cdf5 --enable-parallel-tests --enable-logging 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/NETCDF/bin:$PATH
	export NETCDF=$DIR/NETCDF
	export NETCDF_INC=$DIR/NETCDF/include
	export NETCDF_LIB=$DIR/NETCDF/lib
	export NETCDF_ROOT=$DIR/NETCDF
	export LD_LIBRARY_PATH=$DIR/grib2/lib:$DIR/NETCDF/lib:$LD_LIBRARY_PATH

	echo " "

	############################## NetCDF fortran library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_Fortran_Version.tar.gz
	cd netcdf-fortran-$Netcdf_Fortran_Version/
	export LD_LIBRARY_PATH=$DIR/NETCDF/lib:$LD_LIBRARY_PATH
	export CPPFLAGS="-I$DIR/NETCDF/include -I$DIR/grib2/include"
	export LDFLAGS="-L$DIR/NETCDF/lib -L$DIR/grib2/lib -Wl,-rpath,$DIR/NETCDF/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lnetcdf -lpnetcdf -lcurl -lhdf5_hl -lhdf5 -lz -lm -ldl -lgcc -lgfortran"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-parallel-tests --enable-logging --enable-hdf5 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	echo " "

	#################################### System Environment Tests ##############
	mkdir -p "${WRF_FOLDER}"/Tests/Environment
	mkdir -p "${WRF_FOLDER}"/Tests/Compatibility

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_NETCDF_MPI_tests.tar
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_tests.tar

	LD_LIBRARY_PATH= tar -xvf Fortran_C_tests.tar -C "${WRF_FOLDER}"/Tests/Environment
	LD_LIBRARY_PATH= tar -xvf Fortran_C_NETCDF_MPI_tests.tar -C "${WRF_FOLDER}"/Tests/Compatibility
	export one="1"
	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Environment

	echo " "
	echo " "
	echo "Environment Testing "
	echo "Test 1"
	$FC TEST_1_fortran_only_fixed.f
	./a.out | tee env_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 1 Passed"
	else
		echo "Environment Compiler Test 1 Failed"
		exit
	fi
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 2"
	$FC TEST_2_fortran_only_free.f90
	./a.out | tee env_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 2 Passed"
	else
		echo "Environment Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 3"
	$CC TEST_3_c_only.c
	./a.out | tee env_test3.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test3.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 3 Passed"
	else
		echo "Environment Compiler Test 3 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 4"
	$CC -c -m64 TEST_4_fortran+c_c.c
	$FC -c -m64 TEST_4_fortran+c_f.f90
	$FC -m64 TEST_4_fortran+c_f.o TEST_4_fortran+c_c.o
	./a.out | tee env_test4.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test4.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 4 Passed"
	else
		echo "Environment Compiler Test 4 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Compatibility

	cp ${NETCDF}/include/netcdf.inc .

	echo " "
	echo " "
	echo "Library Compatibility Tests "
	echo "Test 1"
	$FC -c 01_fortran+c+netcdf_f.f
	$CC -c 01_fortran+c+netcdf_c.c
	$FC 01_fortran+c+netcdf_f.o 01_fortran+c+netcdf_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	./a.out | tee comp_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 1 Passed"
	else
		echo "Compatibility Compiler Test 1 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "

	echo "Test 2"
	$MPIFC -c 02_fortran+c+netcdf+mpi_f.f
	$MPICC -c 02_fortran+c+netcdf+mpi_c.c
	$MPIFC 02_fortran+c+netcdf+mpi_f.o \
		02_fortran+c+netcdf+mpi_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	$DIR/MPICH/bin/mpirun ./a.out | tee comp_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 2 Passed"
	else
		echo "Compatibility Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."
	echo " "

	echo " All tests completed and passed"
	echo " "

	################################OpenGrADS######################################
	#Verison 2.2.1 64bit of Linux
	#############################################################################
	if [[ $GRADS_PICK -eq 1 ]]; then
		cd "${WRF_FOLDER}"/Downloads
		wget -c https://sourceforge.net/projects/opengrads/files/grads2/2.2.1.oga.1/macOS/opengrads-2.2.1.oga.1-bundle-x86_64-apple-darwin20.5.0.pkg
		sudo -S installer -pkg opengrads-2.2.1.oga.1-bundle-x86_64-apple-darwin20.5.0.pkg -target /Applications/OpenGrads <<<"$PASSWD"

	fi
	################################## GrADS ###############################
	# Version  2.2.1
	# Sublibs library instructions: http://cola.gmu.edu/grads/gadoc/supplibs2.html
	# GrADS instructions: http://cola.gmu.edu/grads/downloads.php
	########################################################################
	if [[ $GRADS_PICK -eq 2 ]]; then

		brew install grads

	fi

	#####################################################################
	#Installing Miniconda3 to WRF directory and updating libraries
	#####################################################################
	echo $PASSWD | sudo -S apt -y install python3-zstandard python3-zstd

	export Miniconda_Install_DIR="${WRF_FOLDER}"/miniconda3

	mkdir -p $Miniconda_Install_DIR

	wget -c https://repo.anaconda.com/miniconda/Miniconda3-latest-MacOSX-x86_64.sh -O $Miniconda_Install_DIR/miniconda.sh
	bash $Miniconda_Install_DIR/miniconda.sh -b -u -p $Miniconda_Install_DIR

	rm -rf $Miniconda_Install_DIR/miniconda.sh

	export PATH="${WRF_FOLDER}"/miniconda3/bin:$PATH

	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	$Miniconda_Install_DIR/bin/conda init bash

	conda tos accept
	conda config --add channels conda-forge
	conda config --set auto_activate_base false
	conda update -n root --all -y

	echo " "

	#Installing NCL via Conda
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	conda create -n ncl_stable -c conda-forge ncl -y
	conda activate ncl_stable

	conda deactivate
	conda deactivate
	conda deactivate
	echo " "

	##################### WRF Python           ##################
	########### WRf-Python compiled via Conda  ##################
	########### This is the preferred method by NCAR      ##################
	##### https://wrf-python.readthedocs.io/en/latest/installation.html  ##################
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh
	conda env create -f $HOME/WRF-MOSIT/wrf-python-stable.yml

	######################### Climate Data Operators ############
	######################### CDO compiled via Conda ###########
	####################### This is the preferred method #######
	################### https://bairdlangenbrunner.github.io/python-for-climate-scientists/conda/setting-up-conda-environments.html #######################

	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	conda create --name cdo_stable -y
	conda activate cdo_stable
	conda install -c conda-forge cdo -y
	conda update --all -y
	conda deactivate
	conda deactivate
	conda deactivate

	echo " "

	############################ WRFCHEM #################################
	## WRF CHEM v${WPS_VERSION}
	## Downloaded from git tagged releases
	# option 17, option 1 for gfortran and distributed memory w/basic nesting
	# If the script comes back asking to locate a file (libfl.a)
	# Use locate command to find file. in a new terminal and then copy that location
	#locate *name of file*
	#Optimization set to 0 due to buffer overflow dump
	#sed -i -e 's/="-O"/="-O0/' configure_kpp
	########################################################################
	#Setting up WRF-CHEM/KPP
	cd "${WRF_FOLDER}"/Downloads

	ulimit -s unlimited
	export MALLOC_CHECK_=0
	export WRF_EM_CORE=1
	export WRF_NMM_CORE=0
	export WRF_CHEM=1

	export WRFIO_NCD_LARGE_FILE_SUPPORT=1

	#Downloading WRF code
	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/wrf-model/WRF/releases/download/v${WRF_VERSION}/v${WRF_VERSION}.tar.gz -O WRF-${WRF_VERSION}.tar.gz
	LD_LIBRARY_PATH= tar -xvzf WRF-${WRF_VERSION}.tar.gz -C "${WRF_FOLDER}"/

	# If statment for changing folder name
	# Check if WRF directory exists
	if [ -d "${WRF_FOLDER}/WRF" ]; then
		mv -f "${WRF_FOLDER}/WRF" "${WRF_FOLDER}/WRF-${WRF_VERSION}"

	# Else, check for any folder matching WRFV*
	else
		for dir in "${WRF_FOLDER}"/WRFV*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WRF-${WRF_VERSION}"
				break
			fi
		done
	fi
	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}

	LD_LIBRARY_PATH= ./clean -a

	if [ ${auto_config} -eq 1 ]; then
		(echo 17 echo 1) | ./configure

	else
		./configure 2>&1 | tee configure.log #Option 17 gfortran compiler with distributed memory option 1 for basic nesting
	fi

	sed -i'' -e 's/-w  -c/-w  -c -fPIC -fPIE -O3 -Wno-implicit-function-declaration/g' "${WRF_FOLDER}"/WRF-${WRF_VERSION}/configure.wrf

	LD_LIBRARY_PATH= ./compile -j 2 em_real 2>&1 | tee compile.wrf1.log

	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/main
	n=$(ls ./*.exe | wc -l)
	if (($n >= 3)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}
		LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN em_real 2>&1 | tee compile.wrf2.log
		cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/main
		n=$(ls ./*.exe | wc -l)
		if (($n >= 3)); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}
	LD_LIBRARY_PATH= ./compile -j 2 emi_conv 2>&1 | tee compile.emis.log

	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/chem

	if [[ -f convert_emiss.exe ]]; then
		echo "All expected files created."

		# Create symbolic link in the main directory
		ln -sf "${WRF_FOLDER}/WRF-${WRF_VERSION}/chem/convert_emiss.exe" "${WRF_FOLDER}/WRF-${WRF_VERSION}/main/convert_emiss.exe"

		echo "Symbolic link created in main/"
		read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}
		LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN emi_conv 2>&1 | tee compile.emis2.log

		cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/chem
		if [[ -f convert_emiss.exe ]]; then
			echo "All expected files created after recompilation."

			# Create symbolic link in the main directory
			ln -sf "${WRF_FOLDER}/WRF-${WRF_VERSION}/chem/convert_emiss.exe" "${WRF_FOLDER}/WRF-${WRF_VERSION}/main/convert_emiss.exe"

			echo "Symbolic link created in main/"
			read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	export WRF_DIR="${WRF_FOLDER}"/WRF-${WRF_VERSION}

	############################WPS#####################################
	## WPS v${WPS_VERSION}
	## Downloaded from git tagged releases
	#Option 3 for gfortran and distributed memory
	########################################################################

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/wrf-model/WPS/archive/refs/tags/v${WPS_VERSION}.tar.gz -O WPS-${WPS_VERSION}.tar.gz
	LD_LIBRARY_PATH= tar -xvzf WPS-${WPS_VERSION}.tar.gz -C "${WRF_FOLDER}"/
	# Check if WPS directory exists
	if [ -d "${WRF_FOLDER}/WPS" ]; then
		mv -f "${WRF_FOLDER}/WPS" "${WRF_FOLDER}/WPS-${WPS_VERSION}"

	# Else, check for any folder matching WPSV* or WPS-*
	else
		for dir in "${WRF_FOLDER}"/WPSV* "${WRF_FOLDER}"/WPS-*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WPS-${WPS_VERSION}"
				break
			fi
		done
	fi
	cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
	LD_LIBRARY_PATH= ./clean -a

	if [ ${auto_config} -eq 1 ]; then
		echo 19 | ./configure 2>&1 | tee configure.log #Option 19 for gfortran and distributed memory
	else
		./configure 2>&1 | tee configure.log #Option 19 gfortran compiler with distributed memory
	fi

	LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.wps.log

	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
	n=$(ls ./*.exe | wc -l)
	if (($n == 3)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WPS. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.wps2.log
		cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
		n=$(ls ./*.exe | wc -l)
		if (($n == 3)); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WPS. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	echo " "

	############################WRFDA 3DVAR###############################
	## WRFDA v${WPS_VERSION} 3DVAR
	## Downloaded from git tagged releases
	## Does not include RTTOV Libarary for radiation data.  If wanted will need to install library then reconfigure
	##Note: if you intend to run both 3DVAR and 4DVAR experiments, it is not necessary to compile the code twice.
	#Option 34 for gfortran/gcc and distribunted memory
	########################################################################
	cd "${WRF_FOLDER}"/Downloads
	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/wrf-model/WRF/releases/download/v${WRF_VERSION}/v${WRF_VERSION}.tar.gz -O WRF-${WRF_VERSION}.tar.gz
	mkdir -p "${WRF_FOLDER}"/WRFDA
	LD_LIBRARY_PATH= tar -xvzf WRF-${WRF_VERSION}.tar.gz -C "${WRF_FOLDER}"/WRFDA
	# If statement for changing folder name inside WRFDA
	if [ -d "${WRF_FOLDER}/WRFDA/WRF" ]; then
		mv -f "${WRF_FOLDER}/WRFDA/WRF" "${WRF_FOLDER}/WRFDA/WRF-${WRF_VERSION}"

	else
		for dir in "${WRF_FOLDER}/WRFDA"/WRFV*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WRFDA/WRF-${WRF_VERSION}"
				break
			fi
		done
	fi
	cd "${WRF_FOLDER}"/WRFDA/WRF-${WRF_VERSION}
	mv * "${WRF_FOLDER}"/WRFDA
	cd "${WRF_FOLDER}"/WRFDA
	rm -rf WRF-${WRF_VERSION}/
	cd "${WRF_FOLDER}"/WRFDA

	ulimit -s unlimited
	export WRF_CHEM=1
	export WRFIO_NCD_LARGE_FILE_SUPPORT=1

	LD_LIBRARY_PATH= ./clean -a

	if [ ${auto_config} -eq 1 ]; then
		echo 17 | ./configure wrfda 2>&1 | tee configure.log #Option 17 for gfortran/gcc and distribunted memory
	else
		./configure wrfda 2>&1 | tee configure.log #Option 17 for gfortran/gcc and distribunted memory
	fi
	echo " "
	LD_LIBRARY_PATH= ./compile -j 4 all_wrfvar 2>&1 | tee compile.chem.wrfvar.log
	echo " "

	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WRFDA/var/da
	n=$(ls ./*.exe | wc -l)
	cd "${WRF_FOLDER}"/WRFDA/var/obsproc/src
	m=$(ls ./*.exe | wc -l)
	if ((($n == 43) && ($m == 1))); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WRFDA. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		cd "${WRF_FOLDER}"/WRFDA
		LD_LIBRARY_PATH= ./compile -j 2 all_wrfvar 2>&1 | tee compile.chem.wrfvar2.log
		cd "${WRF_FOLDER}"/WRFDA/var/da
		n=$(ls ./*.exe | wc -l)
		cd "${WRF_FOLDER}"/WRFDA/var/obsproc/src
		m=$(ls ./*.exe | wc -l)
		if ((($n == 43) && ($m == 1))); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WRFDA. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi
	echo " "

	######################## Static Geography Data inc/ Optional ####################
	# http://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html
	# These files are large so if you only need certain ones comment the others off
	# All files downloaded and untarred is 200GB
	# https://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html
	#################################################################################
	cd "${WRF_FOLDER}"/Downloads
	mkdir "${WRF_FOLDER}"/GEOG
	mkdir "${WRF_FOLDER}"/GEOG/WPS_GEOG

	echo " "
	echo "Mandatory WRF Preprocessing System (WPS) Geographical Input Data Mandatory Fields Downloads"
	echo " "
	wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_high_res_mandatory.tar.gz
	LD_LIBRARY_PATH= tar -xvzf geog_high_res_mandatory.tar.gz -C "${WRF_FOLDER}"/GEOG/

	wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_low_res_mandatory.tar.gz
	LD_LIBRARY_PATH= tar -xvzf geog_low_res_mandatory.tar.gz -C "${WRF_FOLDER}"/GEOG/
	mv "${WRF_FOLDER}"/GEOG/WPS_GEOG_LOW_RES/ "${WRF_FOLDER}"/GEOG/WPS_GEOG

	if [ ${WPS_Specific_Applications} -eq 1 ]; then
		echo " "
		echo " WPS Geographical Input Data Mandatory for Specific Applications"
		echo " "

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_thompson28_chem.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_thompson28_chem.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_noahmp.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_noahmp.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/irrigation.tar.gz
		LD_LIBRARY_PATH= tar -xvzf irrigation.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_px.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_px.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_urban.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_urban.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_ssib.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_ssib.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/lake_depth.tar.bz2
		LD_LIBRARY_PATH= tar -xvf lake_depth.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/topobath_30s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf topobath_30s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/gsl_gwd.tar.bz2
		LD_LIBRARY_PATH= tar -xvf gsl_gwd.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/cglc_modis_lcz_global.tar.gz
		LD_LIBRARY_PATH= tar -xvf cglc_modis_lcz_global.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

	fi

	if [ ${Optional_GEOG} -eq 1 ]; then

		echo " "
		echo "Optional WPS Geographical Input Data"
		echo " "

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_older_than_2000.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_older_than_2000.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/modis_landuse_20class_15s_with_lakes.tar.gz
		LD_LIBRARY_PATH= tar -xvzf modis_landuse_20class_15s_with_lakes.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_alt_lsm.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_alt_lsm.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/nlcd2006_ll_9s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf nlcd2006_ll_9s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/updated_Iceland_LU.tar.gz
		LD_LIBRARY_PATH= tar -xvf updated_Iceland_LU.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/modis_landuse_20class_15s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf modis_landuse_20class_15s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

	fi

fi

if [ "$macos_64bit_GNU" = "1" ] && [ "$WRFCHEM_PICK" = "1" ] && [ "$MAC_CHIP" = "ARM" ]; then

	#############################basic package managment############################
	brew cleanup -s
	brew update
	outdated_packages=$(brew outdated --quiet)

	# List of packages to check/install
	packages=(
		"autoconf" "automake" "bison" "byacc" "cmake" "curl" "flex" "gcc"
		"gedit" "git" "gnu-sed" "ksh"
		"libtool" "libxml2" "m4" "make" "python@3.12" "tcsh" "wget"
		"xauth" "xorgproto" "xorgrgb" "xquartz"
	)

	for pkg in "${packages[@]}"; do
		if brew list "$pkg" &>/dev/null; then
			echo "$pkg is already installed."
			if [[ $outdated_packages == *"$pkg"* ]]; then
				echo "$pkg has a newer version available. Upgrading..."
				brew upgrade "$pkg"
			fi
		else
			echo "$pkg is not installed. Installing..."
			brew install "$pkg"
		fi
		sleep 1
	done

	export LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH
	export PATH=/usr/local/bin:$PATH

	##############################Directory Listing############################

	export HOME=$(
		cd
		pwd
	)
	mkdir $HOME/WRFCHEM
	export WRF_FOLDER=$HOME/WRFCHEM
	cd "${WRF_FOLDER}"/
	mkdir Downloads
	mkdir WRFDA
	mkdir Libs
	export DIR="${WRF_FOLDER}"/Libs
	mkdir -p Libs/grib2
	mkdir -p Libs/NETCDF
	mkdir -p Tests/Environment
	mkdir -p Tests/Compatibility

	#############################Core Management####################################
	export CPU_CORE=$(sysctl -n hw.ncpu) # number of available threads on system
	export CPU_6CORE="6"
	export CPU_QUARTER=$(($CPU_CORE / 4))
	#1/2 of availble cores on system
	export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))
	#Forces CPU cores to even number to avoid partial core export. ie 7 cores would be 3.5 cores.

	if [ $CPU_CORE -le $CPU_6CORE ]; then #If statement for low core systems.  Forces computers to only use 1 core if there are 4 cores or less on the system. then
		export CPU_QUARTER_EVEN="2"
	else
		export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))
	fi

	echo "##########################################"
	echo "Number of Threads being used $CPU_QUARTER_EVEN"
	echo "##########################################"
	echo " "

	##############################Downloading Libraries############################

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/madler/zlib/releases/download/v$Zlib_Version/zlib-$Zlib_Version.tar.gz
	wget -c https://github.com/HDFGroup/hdf5/releases/download/hdf5_$HDF5_Version/hdf5-$HDF5_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-c/archive/refs/tags/v$Netcdf_C_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-fortran/archive/refs/tags/v$Netcdf_Fortran_Version.tar.gz
	wget -c https://download.sourceforge.net/libpng/libpng-$Libpng_Version.tar.gz
	wget -c https://www.ece.uvic.ca/~frodo/jasper/software/jasper-$Jasper_Version.zip
	wget -c https://github.com/pmodels/mpich/releases/download/v$Mpich_Version/mpich-$Mpich_Version.tar.gz
	wget -c https://parallel-netcdf.github.io/Release/pnetcdf-$Pnetcdf_Version.tar.gz

	echo " "

	############################# Compilers #############################

	# Unlink any existing Homebrew compiler symlinks
	echo $PASSWD | sudo -S unlink /opt/homebrew/bin/gfortran
	echo $PASSWD | sudo -S unlink /opt/homebrew/bin/gcc
	echo $PASSWD | sudo -S unlink /opt/homebrew/bin/g++

	# Source the bashrc to ensure environment variables are loaded
	source ~/.bashrc

	# Check current versions of gcc, g++, and gfortran (these should show "command not found" if unlinked)
	gcc --version
	g++ --version
	gfortran --version

	# Navigate to the Homebrew binaries directory
	cd /opt/homebrew/bin

	# Find the latest version of GCC, G++, and GFortran
	latest_gcc=$(ls gcc-* 2>/dev/null | grep -o 'gcc-[0-9]*' | sort -V | tail -n 1)
	latest_gpp=$(ls g++-* 2>/dev/null | grep -o 'g++-[0-9]*' | sort -V | tail -n 1)
	latest_gfortran=$(ls gfortran-* 2>/dev/null | grep -o 'gfortran-[0-9]*' | sort -V | tail -n 1)

	# Check if the latest versions were found and link them
	echo "Linking the latest GCC version: $latest_gcc"
	echo $PASSWD | sudo -S ln -sf $latest_gcc gcc
	echo "Linking the latest G++ version: $latest_gpp"
	echo $PASSWD | sudo -S ln -sf $latest_gpp g++
	echo "Linking the latest GFortran version: $latest_gfortran"
	echo $PASSWD | sudo -S ln -sf $latest_gfortran gfortran

	# Return to the home directory
	cd

	# Source bashrc and bash_profile to reload the environment settings
	source ~/.bashrc
	source ~/.bash_profile

	# Check if the versions were successfully updated
	gcc --version
	g++ --version
	gfortran --version

	# Export compiler environment variables
	export CC=gcc
	export CXX=g++
	export FC=gfortran
	export F77=gfortran
	export CFLAGS="-fPIC -fPIE -Wno-implicit-function-declaration -Wno-incompatible-pointer-types -Wall"

	echo " "

	############################# End of Compiler Setup #############################

	#IF statement for GNU compiler issue
	export GCC_VERSION=$(/opt/homebrew/bin/$latest_gcc -dumpfullversion | awk '{print$1}')
	export GFORTRAN_VERSION=$(/opt/homebrew/bin/$latest_gfortran -dumpfullversion | awk '{print$1}')
	export GPLUSPLUS_VERSION=$(/opt/homebrew/bin/$latest_gpp -dumpfullversion | awk '{print$1}')

	export GCC_VERSION_MAJOR_VERSION=$(echo $GCC_VERSION | awk -F. '{print $1}')
	export GFORTRAN_VERSION_MAJOR_VERSION=$(echo $GFORTRAN_VERSION | awk -F. '{print $1}')
	export GPLUSPLUS_VERSION_MAJOR_VERSION=$(echo $GPLUSPLUS_VERSION | awk -F. '{print $1}')

	export version_10="10"

	if [ $GCC_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GFORTRAN_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GPLUSPLUS_VERSION_MAJOR_VERSION -ge $version_10 ]; then
		export fallow_argument=-fallow-argument-mismatch
		export boz_argument=-fallow-invalid-boz
	else
		export fallow_argument=
		export boz_argument=
	fi

	export FFLAGS="$fallow_argument -m64"
	export FCFLAGS="$fallow_argument -m64"

	echo "##########################################"
	echo "FFLAGS = $FFLAGS"
	echo "FCFLAGS = $FCFLAGS"
	echo "CFLAGS = $CFLAGS"
	echo "##########################################"

	echo " "

	############################# ZLib ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf zlib-$Zlib_Version.tar.gz
	cd zlib-$Zlib_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	export ZLIB_ROOT=$DIR/grib2
	export ZLIBLIB=$DIR/grib2/lib
	export ZLIBINC=$DIR/grib2/include

	echo " "

	############################## MPICH ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf mpich-$Mpich_Version.tar.gz
	cd mpich-$Mpich_Version/

	F90= ./configure --prefix=$DIR/MPICH --with-device=ch3 FFLAGS="$fallow_argument -m64" FCFLAGS="$fallow_argument -m64" 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee install.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/MPICH/bin:$PATH
	export MPIFC=$DIR/MPICH/bin/mpifort
	export MPIF77=$DIR/MPICH/bin/mpifort
	export MPIF90=$DIR/MPICH/bin/mpifort
	export MPICC=$DIR/MPICH/bin/mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx

	echo " "

	############################# libpng ############################

	cd "${WRF_FOLDER}"/Downloads

	# other libraries below need these variables to be set
	export LDFLAGS=-L$DIR/grib2/lib
	export CPPFLAGS=-I$DIR/grib2/include

	LD_LIBRARY_PATH= tar -xvzf libpng-$Libpng_Version.tar.gz
	cd libpng-$Libpng_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNG_ROOT=$DIR/grib2

	echo " "
	#############################JasPer ############################

	cd "${WRF_FOLDER}"/Downloads
	unzip jasper-$Jasper_Version.zip
	cd jasper-$Jasper_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee install.log
	export JASPERLIB=$DIR/grib2/lib
	export JASPERINC=$DIR/grib2/include
	export JASPER_DIR=$DIR/grib2
	export Jasper_ROOT=$DIR/grib2/lib

	echo " "
	############################# hdf5 library for netcdf4 functionality ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf hdf5-$HDF5_Version.tar.gz
	cd hdf5-$HDF5_Version

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --with-zlib=$DIR/grib2 --enable-hl --enable-fortran --enable-parallel 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export HDF5=$DIR/grib2
	export PATH=$HDF5/bin:$PATH
	export PHDF5=$DIR/grib2
	export HDF5_ROOT=$DIR/grib2
	export PHDF5_ROOT=$DIR/grib2

	echo " "

	############################# Install Parallel-netCDF ##############################
	#Make file created with half of available cpu cores
	#Hard path for MPI added
	##################################################################################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf pnetcdf-$Pnetcdf_Version.tar.gz
	cd pnetcdf-$Pnetcdf_Version

	export MPIFC=$DIR/MPICH/bin/mpifort
	export MPIF77=$DIR/MPICH/bin/mpifort
	export MPIF90=$DIR/MPICH/bin/mpifort
	export MPICC=$DIR/MPICH/bin/mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx

	# drop --disable-utils (not recognized)
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS="-std=gnu99 $CFLAGS" FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --enable-static 2>&1 | tee configure.log

	# build only libraries
	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log

	# install only libraries and headers
	make install 2>&1 | tee make.install.log

	export PNETCDF=$DIR/grib2
	export PNETCDF_DIR=$DIR/grib2
	export PNETCDF_ROOT=$DIR/grib2

	echo " "

	read -r -t 3 -p

	############################## Install NETCDF C Library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_C_Version.tar.gz
	cd netcdf-c-$Netcdf_C_Version/
	export CPPFLAGS=-I$DIR/grib2/include
	export LDFLAGS="-L$DIR/grib2/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lhdf5_hl -lhdf5 -lz -lcurl -lgfortran -lgcc -lm -ldl -lpnetcdf"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --disable-dap --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-pnetcdf --enable-cdf5 --enable-parallel-tests --enable-logging 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/NETCDF/bin:$PATH
	export NETCDF=$DIR/NETCDF
	export NETCDF_INC=$DIR/NETCDF/include
	export NETCDF_LIB=$DIR/NETCDF/lib
	export NETCDF_ROOT=$DIR/NETCDF
	export LD_LIBRARY_PATH=$DIR/grib2/lib:$DIR/NETCDF/lib:$LD_LIBRARY_PATH

	echo " "

	############################## NetCDF fortran library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_Fortran_Version.tar.gz
	cd netcdf-fortran-$Netcdf_Fortran_Version/
	export LD_LIBRARY_PATH=$DIR/NETCDF/lib:$LD_LIBRARY_PATH
	export CPPFLAGS="-I$DIR/NETCDF/include -I$DIR/grib2/include"
	export LDFLAGS="-L$DIR/NETCDF/lib -L$DIR/grib2/lib -Wl,-rpath,$DIR/NETCDF/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lnetcdf -lpnetcdf -lcurl -lhdf5_hl -lhdf5 -lz -lm -ldl -lgcc -lgfortran"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-parallel-tests --enable-logging --enable-hdf5 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	echo " "

	#################################### System Environment Tests ##############
	mkdir -p "${WRF_FOLDER}"/Tests/Environment
	mkdir -p "${WRF_FOLDER}"/Tests/Compatibility

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_NETCDF_MPI_tests.tar
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_tests.tar

	LD_LIBRARY_PATH= tar -xvf Fortran_C_tests.tar -C "${WRF_FOLDER}"/Tests/Environment
	LD_LIBRARY_PATH= tar -xvf Fortran_C_NETCDF_MPI_tests.tar -C "${WRF_FOLDER}"/Tests/Compatibility
	export one="1"
	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Environment

	echo " "
	echo " "
	echo "Environment Testing "
	echo "Test 1"
	$FC TEST_1_fortran_only_fixed.f
	./a.out | tee env_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 1 Passed"
	else
		echo "Environment Compiler Test 1 Failed"
		exit
	fi
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 2"
	$FC TEST_2_fortran_only_free.f90
	./a.out | tee env_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 2 Passed"
	else
		echo "Environment Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 3"
	$CC TEST_3_c_only.c
	./a.out | tee env_test3.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test3.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 3 Passed"
	else
		echo "Environment Compiler Test 3 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 4"
	$CC -c -m64 TEST_4_fortran+c_c.c
	$FC -c -m64 TEST_4_fortran+c_f.f90
	$FC -m64 TEST_4_fortran+c_f.o TEST_4_fortran+c_c.o
	./a.out | tee env_test4.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test4.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 4 Passed"
	else
		echo "Environment Compiler Test 4 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Compatibility

	cp ${NETCDF}/include/netcdf.inc .

	echo " "
	echo " "
	echo "Library Compatibility Tests "
	echo "Test 1"
	$FC -c 01_fortran+c+netcdf_f.f
	$CC -c 01_fortran+c+netcdf_c.c
	$FC 01_fortran+c+netcdf_f.o 01_fortran+c+netcdf_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	./a.out | tee comp_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 1 Passed"
	else
		echo "Compatibility Compiler Test 1 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "

	echo "Test 2"
	$MPIFC -c 02_fortran+c+netcdf+mpi_f.f
	$MPICC -c 02_fortran+c+netcdf+mpi_c.c
	$MPIFC 02_fortran+c+netcdf+mpi_f.o \
		02_fortran+c+netcdf+mpi_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	$DIR/MPICH/bin/mpirun ./a.out | tee comp_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 2 Passed"
	else
		echo "Compatibility Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."
	echo " "

	echo " All tests completed and passed"
	echo " "

	################################OpenGrADS######################################
	#Verison 2.2.1 64bit of Linux
	#############################################################################
	if [[ $GRADS_PICK -eq 1 ]]; then
		cd "${WRF_FOLDER}"/Downloads
		wget -c https://sourceforge.net/projects/opengrads/files/grads2/2.2.1.oga.1/macOS/opengrads-2.2.1.oga.1-bundle-x86_64-apple-darwin20.5.0.pkg
		sudo -S installer -pkg opengrads-2.2.1.oga.1-bundle-x86_64-apple-darwin20.5.0.pkg -target /Applications/OpenGrads <<<"$PASSWD"

	fi
	################################## GrADS ###############################
	# Version  2.2.1
	# Sublibs library instructions: http://cola.gmu.edu/grads/gadoc/supplibs2.html
	# GrADS instructions: http://cola.gmu.edu/grads/downloads.php
	########################################################################
	if [[ $GRADS_PICK -eq 2 ]]; then

		brew install grads

	fi

	#####################################################################
	#Installing Miniconda3 to WRF directory and updating libraries
	#####################################################################
	echo $PASSWD | sudo -S apt -y install python3-zstandard python3-zstd

	export Miniconda_Install_DIR="${WRF_FOLDER}"/miniconda3

	mkdir -p $Miniconda_Install_DIR

	wget -c https://repo.anaconda.com/miniconda/Miniconda3-latest-MacOSX-x86_64.sh -O $Miniconda_Install_DIR/miniconda.sh
	bash $Miniconda_Install_DIR/miniconda.sh -b -u -p $Miniconda_Install_DIR

	rm -rf $Miniconda_Install_DIR/miniconda.sh

	export PATH="${WRF_FOLDER}"/miniconda3/bin:$PATH

	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	$Miniconda_Install_DIR/bin/conda init bash

	conda tos accept
	conda config --add channels conda-forge
	conda config --set auto_activate_base false
	conda update -n root --all -y

	echo " "

	#Installing NCL via Conda
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	conda create -n ncl_stable -c conda-forge ncl -y
	conda activate ncl_stable

	conda deactivate
	conda deactivate
	conda deactivate
	echo " "

	##################### WRF Python           ##################
	########### WRf-Python compiled via Conda  ##################
	########### This is the preferred method by NCAR      ##################
	##### https://wrf-python.readthedocs.io/en/latest/installation.html  ##################
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh
	conda env create -f $HOME/WRF-MOSIT/wrf-python-stable.yml

	######################### Climate Data Operators ############
	######################### CDO compiled via Conda ###########
	####################### This is the preferred method #######
	################### https://bairdlangenbrunner.github.io/python-for-climate-scientists/conda/setting-up-conda-environments.html #######################

	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	conda create --name cdo_stable -y
	conda activate cdo_stable
	conda install -c conda-forge cdo -y
	conda update --all -y
	conda deactivate
	conda deactivate
	conda deactivate

	echo " "

	############################ WRFCHEM #################################
	## WRF CHEM v${WPS_VERSION}
	## Downloaded from git tagged releases
	# option 17, option 1 for gfortran and distributed memory w/basic nesting
	# If the script comes back asking to locate a file (libfl.a)
	# Use locate command to find file. in a new terminal and then copy that location
	#locate *name of file*
	#Optimization set to 0 due to buffer overflow dump
	#sed -i -e 's/="-O"/="-O0/' configure_kpp
	########################################################################
	#Setting up WRF-CHEM/KPP
	cd "${WRF_FOLDER}"/Downloads

	ulimit -s unlimited
	export MALLOC_CHECK_=0
	export WRF_EM_CORE=1
	export WRF_NMM_CORE=0
	export WRF_CHEM=1

	export WRFIO_NCD_LARGE_FILE_SUPPORT=1

	#Downloading WRF code
	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/wrf-model/WRF/releases/download/v${WRF_VERSION}/v${WRF_VERSION}.tar.gz -O WRF-${WRF_VERSION}.tar.gz
	LD_LIBRARY_PATH= tar -xvzf WRF-${WRF_VERSION}.tar.gz -C "${WRF_FOLDER}"/

	# If statment for changing folder name
	# Check if WRF directory exists
	if [ -d "${WRF_FOLDER}/WRF" ]; then
		mv -f "${WRF_FOLDER}/WRF" "${WRF_FOLDER}/WRF-${WRF_VERSION}"

	# Else, check for any folder matching WRFV*
	else
		for dir in "${WRF_FOLDER}"/WRFV*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WRF-${WRF_VERSION}"
				break
			fi
		done
	fi
	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}

	LD_LIBRARY_PATH= ./clean -a

	if [ ${auto_config} -eq 1 ]; then
		(echo 17 echo 1) | ./configure

	else
		./configure 2>&1 | tee configure.log #Option 17 gfortran compiler with distributed memory option 1 for basic nesting
	fi

	sed -i'' -e 's/-w  -c/-w  -c -fPIC -fPIE -O3 -Wno-implicit-function-declaration/g' "${WRF_FOLDER}"/WRF-${WRF_VERSION}/configure.wrf

	LD_LIBRARY_PATH= ./compile -j 2 em_real 2>&1 | tee compile.wrf1.log

	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/main
	n=$(ls ./*.exe | wc -l)
	if (($n >= 3)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}
		LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN em_real 2>&1 | tee compile.wrf2.log
		cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/main
		n=$(ls ./*.exe | wc -l)
		if (($n >= 3)); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}
	LD_LIBRARY_PATH= ./compile -j 2 emi_conv 2>&1 | tee compile.emis.log

	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/chem

	if [[ -f convert_emiss.exe ]]; then
		echo "All expected files created."

		# Create symbolic link in the main directory
		ln -sf "${WRF_FOLDER}/WRF-${WRF_VERSION}/chem/convert_emiss.exe" "${WRF_FOLDER}/WRF-${WRF_VERSION}/main/convert_emiss.exe"

		echo "Symbolic link created in main/"
		read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}
		LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN emi_conv 2>&1 | tee compile.emis2.log

		cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/chem
		if [[ -f convert_emiss.exe ]]; then
			echo "All expected files created after recompilation."

			# Create symbolic link in the main directory
			ln -sf "${WRF_FOLDER}/WRF-${WRF_VERSION}/chem/convert_emiss.exe" "${WRF_FOLDER}/WRF-${WRF_VERSION}/main/convert_emiss.exe"

			echo "Symbolic link created in main/"
			read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	export WRF_DIR="${WRF_FOLDER}"/WRF-${WRF_VERSION}

	############################WPS#####################################
	## WPS v${WPS_VERSION}
	## Downloaded from git tagged releases
	#Option 3 for gfortran and distributed memory
	########################################################################

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/wrf-model/WPS/archive/refs/tags/v${WPS_VERSION}.tar.gz -O WPS-${WPS_VERSION}.tar.gz
	LD_LIBRARY_PATH= tar -xvzf WPS-${WPS_VERSION}.tar.gz -C "${WRF_FOLDER}"/
	# Check if WPS directory exists
	if [ -d "${WRF_FOLDER}/WPS" ]; then
		mv -f "${WRF_FOLDER}/WPS" "${WRF_FOLDER}/WPS-${WPS_VERSION}"

	# Else, check for any folder matching WPSV* or WPS-*
	else
		for dir in "${WRF_FOLDER}"/WPSV* "${WRF_FOLDER}"/WPS-*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WPS-${WPS_VERSION}"
				break
			fi
		done
	fi
	cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
	LD_LIBRARY_PATH= ./clean -a

	if [ ${auto_config} -eq 1 ]; then
		echo 19 | ./configure 2>&1 | tee configure.log #Option 19 for gfortran and distributed memory
	else
		./configure 2>&1 | tee configure.log #Option 19 gfortran compiler with distributed memory
	fi

	LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.wps.log

	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
	n=$(ls ./*.exe | wc -l)
	if (($n == 3)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WPS. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.wps2.log
		cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
		n=$(ls ./*.exe | wc -l)
		if (($n == 3)); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WPS. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	echo " "

	############################WRFDA 3DVAR###############################
	## WRFDA v${WPS_VERSION} 3DVAR
	## Downloaded from git tagged releases
	## Does not include RTTOV Libarary for radiation data.  If wanted will need to install library then reconfigure
	##Note: if you intend to run both 3DVAR and 4DVAR experiments, it is not necessary to compile the code twice.
	#Option 34 for gfortran/gcc and distribunted memory
	########################################################################
	cd "${WRF_FOLDER}"/Downloads
	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/wrf-model/WRF/releases/download/v${WRF_VERSION}/v${WRF_VERSION}.tar.gz -O WRF-${WRF_VERSION}.tar.gz
	mkdir -p "${WRF_FOLDER}"/WRFDA
	LD_LIBRARY_PATH= tar -xvzf WRF-${WRF_VERSION}.tar.gz -C "${WRF_FOLDER}"/WRFDA
	# If statement for changing folder name inside WRFDA
	if [ -d "${WRF_FOLDER}/WRFDA/WRF" ]; then
		mv -f "${WRF_FOLDER}/WRFDA/WRF" "${WRF_FOLDER}/WRFDA/WRF-${WRF_VERSION}"

	else
		for dir in "${WRF_FOLDER}/WRFDA"/WRFV*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WRFDA/WRF-${WRF_VERSION}"
				break
			fi
		done
	fi
	cd "${WRF_FOLDER}"/WRFDA/WRF-${WRF_VERSION}
	mv * "${WRF_FOLDER}"/WRFDA
	cd "${WRF_FOLDER}"/WRFDA
	rm -rf WRF-${WRF_VERSION}/
	cd "${WRF_FOLDER}"/WRFDA

	ulimit -s unlimited
	export WRF_CHEM=1
	export WRFIO_NCD_LARGE_FILE_SUPPORT=1

	LD_LIBRARY_PATH= ./clean -a

	if [ ${auto_config} -eq 1 ]; then
		echo 17 | ./configure wrfda 2>&1 | tee configure.log #Option 17 for gfortran/gcc and distribunted memory
	else
		./configure wrfda 2>&1 | tee configure.log #Option 17 for gfortran/gcc and distribunted memory
	fi
	echo " "
	LD_LIBRARY_PATH= ./compile -j 4 all_wrfvar 2>&1 | tee compile.chem.wrfvar.log
	echo " "

	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WRFDA/var/da
	n=$(ls ./*.exe | wc -l)
	cd "${WRF_FOLDER}"/WRFDA/var/obsproc/src
	m=$(ls ./*.exe | wc -l)
	if ((($n == 43) && ($m == 1))); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WRFDA. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		cd "${WRF_FOLDER}"/WRFDA
		LD_LIBRARY_PATH= ./compile -j 2 all_wrfvar 2>&1 | tee compile.chem.wrfvar2.log
		cd "${WRF_FOLDER}"/WRFDA/var/da
		n=$(ls ./*.exe | wc -l)
		cd "${WRF_FOLDER}"/WRFDA/var/obsproc/src
		m=$(ls ./*.exe | wc -l)
		if ((($n == 43) && ($m == 1))); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WRFDA. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi
	echo " "

	######################## Static Geography Data inc/ Optional ####################
	# http://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html
	# These files are large so if you only need certain ones comment the others off
	# All files downloaded and untarred is 200GB
	# https://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html
	#################################################################################
	cd "${WRF_FOLDER}"/Downloads
	mkdir "${WRF_FOLDER}"/GEOG
	mkdir "${WRF_FOLDER}"/GEOG/WPS_GEOG

	echo " "
	echo "Mandatory WRF Preprocessing System (WPS) Geographical Input Data Mandatory Fields Downloads"
	echo " "
	wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_high_res_mandatory.tar.gz
	LD_LIBRARY_PATH= tar -xvzf geog_high_res_mandatory.tar.gz -C "${WRF_FOLDER}"/GEOG/

	wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_low_res_mandatory.tar.gz
	LD_LIBRARY_PATH= tar -xvzf geog_low_res_mandatory.tar.gz -C "${WRF_FOLDER}"/GEOG/
	mv "${WRF_FOLDER}"/GEOG/WPS_GEOG_LOW_RES/ "${WRF_FOLDER}"/GEOG/WPS_GEOG

	if [ ${WPS_Specific_Applications} -eq 1 ]; then
		echo " "
		echo " WPS Geographical Input Data Mandatory for Specific Applications"
		echo " "

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_thompson28_chem.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_thompson28_chem.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_noahmp.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_noahmp.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/irrigation.tar.gz
		LD_LIBRARY_PATH= tar -xvzf irrigation.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_px.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_px.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_urban.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_urban.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_ssib.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_ssib.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/lake_depth.tar.bz2
		LD_LIBRARY_PATH= tar -xvf lake_depth.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/topobath_30s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf topobath_30s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/gsl_gwd.tar.bz2
		LD_LIBRARY_PATH= tar -xvf gsl_gwd.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/cglc_modis_lcz_global.tar.gz
		LD_LIBRARY_PATH= tar -xvf cglc_modis_lcz_global.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

	fi

	if [ ${Optional_GEOG} -eq 1 ]; then

		echo " "
		echo "Optional WPS Geographical Input Data"
		echo " "

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_older_than_2000.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_older_than_2000.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/modis_landuse_20class_15s_with_lakes.tar.gz
		LD_LIBRARY_PATH= tar -xvzf modis_landuse_20class_15s_with_lakes.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_alt_lsm.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_alt_lsm.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/nlcd2006_ll_9s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf nlcd2006_ll_9s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/updated_Iceland_LU.tar.gz
		LD_LIBRARY_PATH= tar -xvf updated_Iceland_LU.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/modis_landuse_20class_15s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf modis_landuse_20class_15s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

	fi

fi

if [ "$RHL_64bit_GNU" = "1" ] && [ "$WRFCHEM_PICK" = "1" ]; then

	#############################basic package managment############################
	echo $PASSWD | sudo -S yum install epel-release -y
	echo $PASSWD | sudo -S yum install dnf -y
	echo $PASSWD | sudo -S dnf install epel-release -y
	echo $PASSWD | sudo -S dnf install dnf -y
	echo $PASSWD | sudo -S dnf -y update
	echo $PASSWD | sudo -S dnf -y upgrade
	echo $PASSWD | sudo -S dnf -y install bzip2 bzip2-devel byacc cairo-devel cmake cpp curl curl-devel flex fontconfig-devel fontconfig-devel gcc gcc-c++ gcc-gfortran git java-11-openjdk java-11-openjdk-devel ksh libX11-devel libX11-devel libXaw libXaw-devel libXext-devel libXext-devel libXmu-devel libXrender-devel libXrender-devel libstdc++ libstdc++-devel libxml2 libxml2-devel m4 nfs-utils perl "perl(XML::LibXML)" pkgconfig pixman-devel python3 python3-devel tcsh time unzip wget
	echo $PASSWD | sudo -S dnf -y groupinstall "Development Tools"
	echo $PASSWD | sudo -S dnf -y update
	echo $PASSWD | sudo -S dnf -y upgrade
	echo " "

	##############################Directory Listing############################
	export HOME=$(
		cd
		pwd
	)

	mkdir $HOME/WRFCHEM
	export WRF_FOLDER=$HOME/WRFCHEM
	cd "${WRF_FOLDER}"/
	mkdir Downloads

	mkdir Libs
	export DIR="${WRF_FOLDER}"/Libs
	mkdir Libs/grib2
	mkdir Libs/NETCDF
	mkdir Libs/MPICH
	mkdir -p Tests/Environment
	mkdir -p Tests/Compatibility

	echo " "
	#############################Core Management####################################

	export CPU_CORE=$(nproc) # number of available threads on system
	export CPU_6CORE="6"
	export CPU_QUARTER=$(($CPU_CORE / 4))                          #quarter of availble cores on system
	export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2))) #Forces CPU cores to even number to avoid partial core export. ie 7 cores would be 3.5 cores.

	if [ $CPU_CORE -le $CPU_6CORE ]; then #If statement for low core systems.  Forces computers to only use 1 core if there are 4 cores or less on the system. then
		export CPU_QUARTER_EVEN="2"
	else
		export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))
	fi

	echo "##########################################"
	echo "Number of Threads being used $CPU_QUARTER_EVEN"
	echo "##########################################"

	echo " "
	##############################Downloading Libraries############################
	cd Downloads
	wget -c https://github.com/madler/zlib/releases/download/v$Zlib_Version/zlib-$Zlib_Version.tar.gz
	wget -c https://github.com/HDFGroup/hdf5/releases/download/hdf5_$HDF5_Version/hdf5-$HDF5_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-c/archive/refs/tags/v$Netcdf_C_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-fortran/archive/refs/tags/v$Netcdf_Fortran_Version.tar.gz
	wget -c https://github.com/pmodels/mpich/releases/download/v$Mpich_Version/mpich-$Mpich_Version.tar.gz
	wget -c https://download.sourceforge.net/libpng/libpng-$Libpng_Version.tar.gz
	wget -c https://www.ece.uvic.ca/~frodo/jasper/software/jasper-$Jasper_Version.zip
	wget -c https://parallel-netcdf.github.io/Release/pnetcdf-$Pnetcdf_Version.tar.gz

	echo " "
	####################################Compilers#####################################
	export CC=gcc
	export CXX=g++
	export FC=gfortran
	export F77=gfortran
	export CFLAGS="-fPIC -fPIE -O3"

	#IF statement for GNU compiler issue
	export GCC_VERSION=$(gcc -dumpfullversion | awk '{print$1}')
	export GFORTRAN_VERSION=$(gfortran -dumpfullversion | awk '{print$1}')
	export GPLUSPLUS_VERSION=$(g++ -dumpfullversion | awk '{print$1}')

	export GCC_VERSION_MAJOR_VERSION=$(echo $GCC_VERSION | awk -F. '{print $1}')
	export GFORTRAN_VERSION_MAJOR_VERSION=$(echo $GFORTRAN_VERSION | awk -F. '{print $1}')
	export GPLUSPLUS_VERSION_MAJOR_VERSION=$(echo $GPLUSPLUS_VERSION | awk -F. '{print $1}')

	export version_10="10"

	if [ $GCC_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GFORTRAN_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GPLUSPLUS_VERSION_MAJOR_VERSION -ge $version_10 ]; then
		export fallow_argument=-fallow-argument-mismatch
		export boz_argument=-fallow-invalid-boz
	else
		export fallow_argument=
		export boz_argument=
	fi

	export FFLAGS="$fallow_argument -m64"
	export FCFLAGS="$fallow_argument -m64"

	echo "##########################################"
	echo "FFLAGS = $FFLAGS"
	echo "FCFLAGS = $FCFLAGS"
	echo "CFLAGS = $CFLAGS"
	echo "##########################################"

	echo " "
	############################# ZLib ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf zlib-$Zlib_Version.tar.gz
	cd zlib-$Zlib_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	export ZLIB_ROOT=$DIR/grib2
	export ZLIBLIB=$DIR/grib2/lib
	export ZLIBINC=$DIR/grib2/include

	echo " "

	############################## MPICH ############################
	#F90= due to compiler issues with mpich install
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf mpich-$Mpich_Version.tar.gz
	cd mpich-$Mpich_Version/

	F90= ./configure --prefix=$DIR/MPICH --with-device=ch3 FFLAGS=$fallow_argument FCFLAGS=$fallow_argument 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/MPICH/bin:$PATH
	export MPIFC=$DIR/MPICH/bin/mpifort
	export MPIF77=$DIR/MPICH/bin/mpifort
	export MPIF90=$DIR/MPICH/bin/mpifort
	export MPICC=$DIR/MPICH/bin/mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx

	echo " "
	############################# libpng ############################

	cd "${WRF_FOLDER}"/Downloads

	# other libraries below need these variables to be set
	export LDFLAGS=-L$DIR/grib2/lib
	export CPPFLAGS=-I$DIR/grib2/include

	LD_LIBRARY_PATH= tar -xvzf libpng-$Libpng_Version.tar.gz
	cd libpng-$Libpng_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNG_ROOT=$DIR/grib2

	echo " "
	#############################JasPer ############################
	cd "${WRF_FOLDER}"/Downloads
	unzip jasper-$Jasper_Version.zip
	cd jasper-$Jasper_Version/

	./configure --prefix=$DIR/grib2
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export JASPERLIB=$DIR/grib2/lib
	export JASPERINC=$DIR/grib2/include
	export JASPER_DIR=$DIR/grib2
	export Jasper_ROOT=$DIR/grib2/lib

	echo " "
	############################# hdf5 library for netcdf4 functionality ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf hdf5-$HDF5_Version.tar.gz
	cd hdf5-$HDF5_Version

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --with-zlib=$DIR/grib2 --enable-hl --enable-fortran --enable-parallel 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export HDF5=$DIR/grib2
	export PATH=$HDF5/bin:$PATH
	export PHDF5=$DIR/grib2
	export HDF5_ROOT=$DIR/grib2
	export PHDF5_ROOT=$DIR/grib2

	echo " "
	############################# Install Parallel-netCDF ##############################
	#Make file created with half of available cpu cores
	#Hard path for MPI added
	##################################################################################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf pnetcdf-$Pnetcdf_Version.tar.gz
	cd pnetcdf-$Pnetcdf_Version
	export MPIFC=$DIR/MPICH/bin/mpifort
	export MPIF77=$DIR/MPICH/bin/mpifort
	export MPIF90=$DIR/MPICH/bin/mpifort
	export MPICC=$DIR/MPICH/bin/mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --enable-static 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNETCDF=$DIR/grib2
	export PNETCDF_DIR=$DIR/grib2
	export PNETCDF_ROOT=$DIR/grib2

	echo " "

	############################## Install NETCDF C Library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_C_Version.tar.gz
	cd netcdf-c-$Netcdf_C_Version/
	export CPPFLAGS=-I$DIR/grib2/include
	export LDFLAGS="-L$DIR/grib2/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lhdf5_hl -lhdf5 -lz -lcurl -lgfortran -lgcc -lm -ldl -lpnetcdf"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --disable-dap --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-pnetcdf --enable-cdf5 --enable-parallel-tests --enable-logging 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/NETCDF/bin:$PATH
	export NETCDF=$DIR/NETCDF
	export NETCDF_INC=$DIR/NETCDF/include
	export NETCDF_LIB=$DIR/NETCDF/lib
	export NETCDF_ROOT=$DIR/NETCDF
	export LD_LIBRARY_PATH=$DIR/grib2/lib:$DIR/NETCDF/lib:$LD_LIBRARY_PATH

	echo " "
	############################## NetCDF fortran library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_Fortran_Version.tar.gz
	cd netcdf-fortran-$Netcdf_Fortran_Version/
	export LD_LIBRARY_PATH=$DIR/NETCDF/lib:$LD_LIBRARY_PATH
	export CPPFLAGS="-I$DIR/NETCDF/include -I$DIR/grib2/include"
	export LDFLAGS="-L$DIR/NETCDF/lib -L$DIR/grib2/lib -Wl,-rpath,$DIR/NETCDF/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lnetcdf -lpnetcdf -lcurl -lhdf5_hl -lhdf5 -lz -lm -ldl -lgcc -lgfortran"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-parallel-tests --enable-logging --enable-hdf5 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	echo " "
	#################################### System Environment Tests ##############

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_NETCDF_MPI_tests.tar
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_tests.tar

	LD_LIBRARY_PATH= tar -xvf Fortran_C_tests.tar -C "${WRF_FOLDER}"/Tests/Environment
	LD_LIBRARY_PATH= tar -xvf Fortran_C_NETCDF_MPI_tests.tar -C "${WRF_FOLDER}"/Tests/Compatibility

	export one="1"
	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Environment

	cp ${NETCDF}/include/netcdf.inc .

	echo " "
	echo " "
	echo "Environment Testing "
	echo "Test 1"
	$FC TEST_1_fortran_only_fixed.f
	./a.out | tee env_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 1 Passed"
	else
		echo "Environment Compiler Test 1 Failed"
		exit
	fi
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 2"
	$FC TEST_2_fortran_only_free.f90
	./a.out | tee env_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 2 Passed"
	else
		echo "Environment Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 3"
	$CC TEST_3_c_only.c
	./a.out | tee env_test3.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test3.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 3 Passed"
	else
		echo "Environment Compiler Test 3 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 4"
	$CC -c -m64 TEST_4_fortran+c_c.c
	$FC -c -m64 TEST_4_fortran+c_f.f90
	$FC -m64 TEST_4_fortran+c_f.o TEST_4_fortran+c_c.o
	./a.out | tee env_test4.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test4.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 4 Passed"
	else
		echo "Environment Compiler Test 4 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Compatibility

	cp ${NETCDF}/include/netcdf.inc .

	echo " "
	echo " "
	echo "Library Compatibility Tests "
	echo "Test 1"
	$FC -c 01_fortran+c+netcdf_f.f
	$CC -c 01_fortran+c+netcdf_c.c
	$FC 01_fortran+c+netcdf_f.o 01_fortran+c+netcdf_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	./a.out | tee comp_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 1 Passed"
	else
		echo "Compatibility Compiler Test 1 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "

	echo "Test 2"
	$MPIFC -c 02_fortran+c+netcdf+mpi_f.f
	$MPICC -c 02_fortran+c+netcdf+mpi_c.c
	$MPIFC 02_fortran+c+netcdf+mpi_f.o \
		02_fortran+c+netcdf+mpi_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	$DIR/MPICH/bin/mpirun ./a.out | tee comp_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 2 Passed"
	else
		echo "Compatibility Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."
	echo " "

	echo " All tests completed and passed"
	echo " "

	################################ OpenGrADS ##################################
	#Verison 2.2.1 32bit of Linux
	#############################################################################
	if [[ $GRADS_PICK -eq 1 ]]; then
		cd "${WRF_FOLDER}"/Downloads
		LD_LIBRARY_PATH= tar -xvzf cd "${WRF_FOLDER}"/Downloads
		wget -c https://sourceforge.net/projects/opengrads/files/grads2/2.2.1.oga.1/Linux%20%2864%20Bits%29/opengrads-2.2.1.oga.1-bundle-x86_64-pc-linux-gnu-glibc_2.17.tar.gz
		LD_LIBRARY_PATH= tar -xvzf opengrads-2.2.1.oga.1-bundle-x86_64-pc-linux-gnu-glibc_2.17.tar.gz -C "${WRF_FOLDER}"/ -C "${WRF_FOLDER}"/
		cd "${WRF_FOLDER}"/
		mv "${WRF_FOLDER}"/opengrads-2.2.1.oga.1 "${WRF_FOLDER}"/GrADS
		cd GrADS/Contents
		wget -c https://github.com/regisgrundig/SIMOP/blob/master/g2ctl.pl
		chmod +x g2ctl.pl
		wget -c https://sourceforge.net/projects/opengrads/files/wgrib2/0.1.9.4/wgrib2-v0.1.9.4-bin-i686-glib2.5-linux-gnu.tar.gz
		LD_LIBRARY_PATH= tar -xvzf wgrib2-v0.1.9.4-bin-i686-glib2.5-linux-gnu.tar.gz
		cd wgrib2-v0.1.9.4/bin
		mv wgrib2 "${WRF_FOLDER}"/GrADS/Contents
		cd "${WRF_FOLDER}"/GrADS/Contents
		rm wgrib2-v0.1.9.4-bin-i686-glib2.5-linux-gnu.tar.gz
		rm -r wgrib2-v0.1.9.4

		export PATH="${WRF_FOLDER}"/GrADS/Contents:$PATH

		echo " "
	fi
	################################## GrADS ###############################
	# Version  2.2.1
	# Sublibs library instructions: http://cola.gmu.edu/grads/gadoc/supplibs2.html
	# GrADS instructions: http://cola.gmu.edu/grads/downloads.php
	########################################################################
	if [[ $GRADS_PICK -eq 2 ]]; then
		cd "${WRF_FOLDER}"/Downloads
		wget -c ftp://cola.gmu.edu/grads/2.2/grads-2.2.1-bin-RHL7.4-x86_64.tar.gz
		LD_LIBRARY_PATH= tar -xvzf grads-2.2.1-bin-RHL7.4-x86_64.tar.gz -C "${WRF_FOLDER}"
		cd "${WRF_FOLDER}"/grads-2.2.1/bin
		chmod 775 *

	fi

	##################### NCAR COMMAND LANGUAGE           ##################
	########### NCL compiled via Conda                    ##################
	########### This is the preferred method by NCAR      ##################
	########### https://www.ncl.ucar.edu/index.shtml      ##################
	echo " "
	#Installing Miniconda3 to WRF directory and updating libraries
	echo $PASSWD | sudo -S dnf -y install python3-zstandard python3-zstd

	export Miniconda_Install_DIR="${WRF_FOLDER}"/miniconda3

	mkdir -p $Miniconda_Install_DIR

	wget -c https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O $Miniconda_Install_DIR/miniconda.sh
	bash $Miniconda_Install_DIR/miniconda.sh -b -u -p $Miniconda_Install_DIR

	rm -rf $Miniconda_Install_DIR/miniconda.sh

	export PATH="${WRF_FOLDER}"/miniconda3/bin:$PATH

	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	$Miniconda_Install_DIR/bin/conda init bash

	conda tos accept
	conda config --add channels conda-forge
	conda config --set auto_activate_base false
	conda update -n root --all -y

	echo " "

	echo " "
	#Installing NCL via Conda
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	conda create -n ncl_stable -c conda-forge ncl -y
	conda activate ncl_stable

	conda deactivate
	conda deactivate
	conda deactivate

	echo " "

	############################OBSGRID###############################
	## OBSGRID
	## Downloaded from git tagged releases
	## Option #2
	########################################################################
	cd "${WRF_FOLDER}"/
	git clone https://github.com/wrf-model/OBSGRID.git
	cd "${WRF_FOLDER}"/OBSGRID

	LD_LIBRARY_PATH= ./clean -a
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh
	conda activate ncl_stable

	export HOME=$(
		cd
		pwd
	)
	export DIR="${WRF_FOLDER}"/Libs
	export NETCDF=$DIR/NETCDF

	if [ ${auto_config} -eq 1 ]; then
		echo 2 | ./configure 2>&1 | tee configure.log #Option 2 for gfortran/gcc and distribunted memory
	else
		./configure 2>&1 | tee configure.log #Option 2 for gfortran/gcc and distribunted memory
	fi

	sed -i '27s/-lnetcdf -lnetcdff/ -lnetcdff -lnetcdf/g' configure.oa

	sed -i '31s/-lncarg -lncarg_gks -lncarg_c -lX11 -lm -lcairo/-lncarg -lncarg_gks -lncarg_c -lX11 -lm -lcairo -lfontconfig -lpixman-1 -lfreetype -lhdf5 -lhdf5_hl /g' configure.oa

	sed -i '39s/-frecord-marker=4/-frecord-marker=4 ${fallow_argument} /g' configure.oa

	sed -i '44s/=	/=	${fallow_argument} /g' configure.oa

	sed -i '45s/-C -P -traditional/-P -traditional/g' configure.oa

	echo " "
	LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.obsgrid.log

	conda deactivate
	conda deactivate
	conda deactivate

	echo " "
	# IF statement to check that all files were created.
	if [[ -x ./obsgrid.exe ]]; then
		echo "obsgrid.exe found."
		read -r -t 5 -p "Finished installing OBSGRID. I am going to wait for 5 seconds only ..."
	else
		echo "obsgrid.exe is missing. Attempting to compile again..."

		LD_LIBRARY_PATH= ./clean -a
		LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.obsgrid.retry.log

		if [[ -x ./obsgrid.exe ]]; then
			echo "obsgrid.exe successfully created after recompilation."
			read -r -t 5 -p "Finished retrying OBSGRID compile. I am going to wait for 5 seconds only ..."
		else
			echo "Still missing obsgrid.exe after recompile. Exiting the script."
			read -r -p "Please contact script authors for assistance. Press 'Enter' to exit."
			exit 1
		fi
	fi

	echo " "

	##################### WRF Python           ##################
	########### WRf-Python compiled via Conda  ##################
	########### This is the preferred method by NCAR      ##################
	##### https://wrf-python.readthedocs.io/en/latest/installation.html  ##################
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh
	conda env create -f $HOME/WRF-MOSIT/wrf-python-stable.yml

	echo " "

	############################WRFDA 3DVAR###############################
	## WRFDA v${WPS_VERSION} 3DVAR
	## Downloaded from git tagged releases
	## Does not include RTTOV Libarary for radiation data.  If wanted will need to install library then reconfigure
	##Note: if you intend to run both 3DVAR and 4DVAR experiments, it is not necessary to compile the code twice.
	#Option 34 for gfortran/gcc and distribunted memory
	########################################################################
	cd "${WRF_FOLDER}"/Downloads
	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/wrf-model/WRF/releases/download/v${WRF_VERSION}/v${WRF_VERSION}.tar.gz -O WRF-${WRF_VERSION}.tar.gz
	mkdir -p "${WRF_FOLDER}"/WRFDA
	LD_LIBRARY_PATH= tar -xvzf WRF-${WRF_VERSION}.tar.gz -C "${WRF_FOLDER}"/WRFDA
	# If statement for changing folder name inside WRFDA
	if [ -d "${WRF_FOLDER}/WRFDA/WRF" ]; then
		mv -f "${WRF_FOLDER}/WRFDA/WRF" "${WRF_FOLDER}/WRFDA/WRF-${WRF_VERSION}"

	else
		for dir in "${WRF_FOLDER}/WRFDA"/WRFV*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WRFDA/WRF-${WRF_VERSION}"
				break
			fi
		done
	fi
	cd "${WRF_FOLDER}"/WRFDA/WRF-${WRF_VERSION}
	mv * "${WRF_FOLDER}"/WRFDA
	cd "${WRF_FOLDER}"/WRFDA
	rm -rf WRF-${WRF_VERSION}/
	cd "${WRF_FOLDER}"/WRFDA

	ulimit -s unlimited
	export WRF_CHEM=1
	export WRFIO_NCD_LARGE_FILE_SUPPORT=1

	LD_LIBRARY_PATH= ./clean -a

	if [ ${auto_config} -eq 1 ]; then
		echo 34 | ./configure wrfda 2>&1 | tee configure.log #Option 34 for gfortran/gcc and distribunted memory
	else
		./configure wrfda 2>&1 | tee configure.log #Option 18 for gfortran/gcc and distribunted memory
	fi
	echo " "
	LD_LIBRARY_PATH= ./compile -j 4 all_wrfvar 2>&1 | tee compile.chem.wrfvar.log
	echo " "

	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WRFDA/var/da
	n=$(ls ./*.exe | wc -l)
	cd "${WRF_FOLDER}"/WRFDA/var/obsproc/src
	m=$(ls ./*.exe | wc -l)
	if ((($n == 43) && ($m == 1))); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WRFDA. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		cd "${WRF_FOLDER}"/WRFDA
		LD_LIBRARY_PATH= ./compile -j 2 all_wrfvar 2>&1 | tee compile.chem.wrfvar2.log
		cd "${WRF_FOLDER}"/WRFDA/var/da
		n=$(ls ./*.exe | wc -l)
		cd "${WRF_FOLDER}"/WRFDA/var/obsproc/src
		m=$(ls ./*.exe | wc -l)
		if ((($n == 43) && ($m == 1))); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WRFDA. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi
	echo " "

	############################ WRFCHEM #################################
	## WRF CHEM v${WPS_VERSION}
	## Downloaded from git tagged releases
	# option 34, option 1 for gfortran and distributed memory w/basic nesting
	# If the script comes back asking to locate a file (libfl.a)
	# Use locate command to find file. in a new terminal and then copy that location
	#locate *name of file*
	#Optimization set to 0 due to buffer overflow dump
	#sed -i -e 's/="-O"/="-O0/' configure_kpp
	# io_form_boundary
	# io_form_history
	# io_form_auxinput2
	# io_form_auxhist2
	# Note that you need set nocolons = .true. in the section &time_control of namelist.input
	########################################################################
	cd /tmp

	# Download the flex 2.6.4 source tarball
	wget https://github.com/westes/flex/releases/download/v2.6.4/flex-2.6.4.tar.gz

	# Extract it
	tar -xzf flex-2.6.4.tar.gz
	cd flex-2.6.4

	# Configure to install into /usr (so libs go to /usr/lib64)
	./configure --prefix=/usr/ 2>&1 | tee "${WRF_FOLDER}"/Downloads/flex.configure.log

	# Build
	make 2>&1 | tee "${WRF_FOLDER}"/Downloads/flex.make.log

	# Install (will prompt for sudo password)
	echo $PASSWD | sudo -S make install

	# --------------------------------------------------------
	# Detect Flex library location automatically
	# --------------------------------------------------------
	FLEX_LIB_PATH=$(find /usr /usr/local -type f \( -name "libfl.a" -o -name "libfl.so" \) 2>/dev/null | head -n 1)
	# Extract the directory name only
	FLEX_LIB_DIR=$(dirname "$FLEX_LIB_PATH")

	# Export it for WRF configure
	export FLEX_LIB_DIR
	echo "FLEX_LIB_DIR set to $FLEX_LIB_DIR"

	# --------------------------------------------------------
	# Setting up WRF-CHEM/KPP environment
	# --------------------------------------------------------
	cd "${WRF_FOLDER}"/Downloads

	ulimit -s unlimited
	export WRF_EM_CORE=1
	export WRF_NMM_CORE=0
	export WRF_CHEM=1
	export WRF_KPP=1

	export YACC='/usr/bin/yacc -d'
	export FLEX=/usr/bin/flex

	# FLEX_LIB_DIR is already set above, no need to hardcode

	export KPP_HOME="${WRF_FOLDER}"/WRF-${WRF_VERSION}/chem/KPP/kpp/kpp-2.1
	export WRF_SRC_ROOT_DIR="${WRF_FOLDER}"/WRF-${WRF_VERSION}
	export PATH=$KPP_HOME/bin:$PATH
	export SED=/usr/bin/sed
	export WRFIO_NCD_LARGE_FILE_SUPPORT=1

	#Downloading WRF code

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/wrf-model/WRF/releases/download/v${WRF_VERSION}/v${WRF_VERSION}.tar.gz -O WRF-${WRF_VERSION}.tar.gz
	LD_LIBRARY_PATH= tar -xvzf WRF-${WRF_VERSION}.tar.gz -C "${WRF_FOLDER}"/
	# If statment for changing folder name
	# Check if WRF directory exists
	if [ -d "${WRF_FOLDER}/WRF" ]; then
		mv -f "${WRF_FOLDER}/WRF" "${WRF_FOLDER}/WRF-${WRF_VERSION}"

	# Else, check for any folder matching WRFV*
	else
		for dir in "${WRF_FOLDER}"/WRFV*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WRF-${WRF_VERSION}"
				break
			fi
		done
	fi
	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}

	LD_LIBRARY_PATH= ./clean -a

	sed -i '121s|$WKC_HOME/util/wkc/tuv_kpp FIRST ../../inc/|$WKC_HOME/util/wkc/tuv_kpp FIRST ../../../../inc/|g' "${WRF_FOLDER}"/WRF-${WRF_VERSION}/chem/KPP/compile_wkc

	if [ ${auto_config} -eq 1 ]; then
		(
			echo 34
			echo 1
		) | ./configure

	else
		./configure 2>&1 | tee configure.log #Option 34 gfortran compiler with distributed memory option 1 for basic nesting
	fi

	LD_LIBRARY_PATH= ./compile -j 2 em_real 2>&1 | tee compile.wrf1.log

	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/main
	n=$(ls ./*.exe | wc -l)
	if (($n >= 3)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}
		LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN em_real 2>&1 | tee compile.wrf2.log
		cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/main
		n=$(ls ./*.exe | wc -l)
		if (($n >= 3)); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}
	LD_LIBRARY_PATH= ./compile -j 2 emi_conv 2>&1 | tee compile.emis.log

	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/chem

	if [[ -f convert_emiss.exe ]]; then
		echo "All expected files created."

		# Create symbolic link in the main directory
		ln -sf "${WRF_FOLDER}/WRF-${WRF_VERSION}/chem/convert_emiss.exe" "${WRF_FOLDER}/WRF-${WRF_VERSION}/main/convert_emiss.exe"

		echo "Symbolic link created in main/"
		read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}
		LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN emi_conv 2>&1 | tee compile.emis2.log

		cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/chem
		if [[ -f convert_emiss.exe ]]; then
			echo "All expected files created after recompilation."

			# Create symbolic link in the main directory
			ln -sf "${WRF_FOLDER}/WRF-${WRF_VERSION}/chem/convert_emiss.exe" "${WRF_FOLDER}/WRF-${WRF_VERSION}/main/convert_emiss.exe"

			echo "Symbolic link created in main/"
			read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	export WRF_DIR="${WRF_FOLDER}"/WRF-${WRF_VERSION}

	############################WPS#####################################
	## WPS v${WPS_VERSION}
	## Downloaded from git tagged releases
	#Option 3 for gfortran and distributed memory
	########################################################################

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/wrf-model/WPS/archive/refs/tags/v${WPS_VERSION}.tar.gz -O WPS-${WPS_VERSION}.tar.gz
	LD_LIBRARY_PATH= tar -xvzf WPS-${WPS_VERSION}.tar.gz -C "${WRF_FOLDER}"/
	cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}

	LD_LIBRARY_PATH= ./clean -a

	if [ ${auto_config} -eq 1 ]; then
		echo 3 | ./configure 2>&1 | tee configure.log #Option 3 for gfortran and distributed memory
	else
		./configure 2>&1 | tee configure.log #Option 3 gfortran compiler with distributed memory
	fi
	LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.wps.log

	echo " "

	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
	n=$(ls ./*.exe | wc -l)
	if (($n == 3)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WPS. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.wps2.log
		cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
		n=$(ls ./*.exe | wc -l)
		if (($n == 3)); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WPS. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	echo " "

	######################## Static Geography Data inc/ Optional ####################
	# http://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html
	# These files are large so if you only need certain ones comment the others off
	# All files downloaded and untarred is 200GB
	# https://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html
	#################################################################################
	cd "${WRF_FOLDER}"/Downloads
	mkdir "${WRF_FOLDER}"/GEOG
	mkdir "${WRF_FOLDER}"/GEOG/WPS_GEOG

	echo " "
	echo "Mandatory WRF Preprocessing System (WPS) Geographical Input Data Mandatory Fields Downloads"
	echo " "
	wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_high_res_mandatory.tar.gz
	LD_LIBRARY_PATH= tar -xvzf geog_high_res_mandatory.tar.gz -C "${WRF_FOLDER}"/GEOG/

	wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_low_res_mandatory.tar.gz
	LD_LIBRARY_PATH= tar -xvzf geog_low_res_mandatory.tar.gz -C "${WRF_FOLDER}"/GEOG/
	mv "${WRF_FOLDER}"/GEOG/WPS_GEOG_LOW_RES/ "${WRF_FOLDER}"/GEOG/WPS_GEOG

	if [ ${WPS_Specific_Applications} -eq 1 ]; then
		echo " "
		echo " WPS Geographical Input Data Mandatory for Specific Applications"
		echo " "

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_thompson28_chem.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_thompson28_chem.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_noahmp.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_noahmp.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/irrigation.tar.gz
		LD_LIBRARY_PATH= tar -xvzf irrigation.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG
		mkdir "${WRF_FOLDER}"/GEOG/WPS_GEOG/irrigation
		mv "${WRF_FOLDER}"/GEOG/WPS_GEOG/fao "${WRF_FOLDER}"/GEOG/WPS_GEOG/irrigation

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_px.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_px.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_urban.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_urban.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_ssib.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_ssib.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/lake_depth.tar.bz2
		LD_LIBRARY_PATH= tar -xvf lake_depth.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/topobath_30s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf topobath_30s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/gsl_gwd.tar.bz2
		LD_LIBRARY_PATH= tar -xvf gsl_gwd.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/cglc_modis_lcz_global.tar.gz
		LD_LIBRARY_PATH= tar -xvf cglc_modis_lcz_global.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG
	fi

	if [ ${Optional_GEOG} -eq 1 ]; then
		echo " "
		echo "Optional WPS Geographical Input Data"
		echo " "

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_older_than_2000.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_older_than_2000.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/modis_landuse_20class_15s_with_lakes.tar.gz
		LD_LIBRARY_PATH= tar -xvzf modis_landuse_20class_15s_with_lakes.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_alt_lsm.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_alt_lsm.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/nlcd2006_ll_9s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf nlcd2006_ll_9s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/updated_Iceland_LU.tar.gz
		LD_LIBRARY_PATH= tar -xvf updated_Iceland_LU.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/modis_landuse_20class_15s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf modis_landuse_20class_15s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG
	fi
fi

if [ "$RHL_64bit_GNU" = "2" ] && [ "$WRFCHEM_PICK" = "1" ]; then

	#############################basic package managment############################
	echo "old version of GNU detected"
	echo $PASSWD | sudo -S yum install RHL-release-scl -y
	echo $PASSWD | sudo -S yum clean all
	echo $PASSWD | sudo -S yum remove devtoolset-11*
	echo $PASSWD | sudo -S yum install devtoolset-11
	echo $PASSWD | sudo -S yum install devtoolset-11-\* -y
	source /opt/rh/devtoolset-11/enable
	gcc --version
	echo $PASSWD | sudo -S yum install epel-release -y
	echo $PASSWD | sudo -S yum install dnf -y
	echo $PASSWD | sudo -S dnf install epel-release -y
	echo $PASSWD | sudo -S dnf install dnf -y
	echo $PASSWD | sudo -S dnf -y update
	echo $PASSWD | sudo -S dnf -y upgrade
	echo $PASSWD | sudo -S dnf -y install bzip2 bzip2-devel byacc cairo-devel cmake cpp curl curl-devel flex fontconfig-devel fontconfig-devel gcc gcc-c++ gcc-gfortran git java-11-openjdk java-11-openjdk-devel ksh libX11-devel libX11-devel libXaw libXaw-devel libXext-devel libXext-devel libXmu-devel libXrender-devel libXrender-devel libstdc++ libstdc++-devel libxml2 libxml2-devel m4 nfs-utils perl "perl(XML::LibXML)" pkgconfig pixman-devel python3 python3-devel tcsh time unzip wget
	echo $PASSWD | sudo -S dnf -y groupinstall "Development Tools"
	echo $PASSWD | sudo -S dnf -y update
	echo $PASSWD | sudo -S dnf -y upgrade

	echo " "

	##############################Directory Listing############################
	export HOME=$(
		cd
		pwd
	)

	mkdir $HOME/WRFCHEM
	export WRF_FOLDER=$HOME/WRFCHEM
	cd "${WRF_FOLDER}"/
	mkdir Downloads

	mkdir Libs
	export DIR="${WRF_FOLDER}"/Libs
	mkdir Libs/grib2
	mkdir Libs/NETCDF
	mkdir Libs/MPICH
	mkdir -p Tests/Environment
	mkdir -p Tests/Compatibility

	echo " "
	#############################Core Management####################################

	export CPU_CORE=$(nproc) # number of available threads on system
	export CPU_6CORE="6"
	export CPU_QUARTER=$(($CPU_CORE / 4))                          #quarter of availble cores on system
	export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2))) #Forces CPU cores to even number to avoid partial core export. ie 7 cores would be 3.5 cores.

	if [ $CPU_CORE -le $CPU_6CORE ]; then #If statement for low core systems.  Forces computers to only use 1 core if there are 4 cores or less on the system. then
		export CPU_QUARTER_EVEN="2"
	else
		export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))
	fi

	echo "##########################################"
	echo "Number of Threads being used $CPU_QUARTER_EVEN"
	echo "##########################################"

	echo " "
	##############################Downloading Libraries############################
	cd Downloads
	wget -c https://github.com/madler/zlib/releases/download/v$Zlib_Version/zlib-$Zlib_Version.tar.gz
	wget -c https://github.com/HDFGroup/hdf5/releases/download/hdf5_$HDF5_Version/hdf5-$HDF5_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-c/archive/refs/tags/v$Netcdf_C_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-fortran/archive/refs/tags/v$Netcdf_Fortran_Version.tar.gz
	wget -c https://github.com/pmodels/mpich/releases/download/v$Mpich_Version/mpich-$Mpich_Version.tar.gz
	wget -c https://download.sourceforge.net/libpng/libpng-$Libpng_Version.tar.gz
	wget -c https://www.ece.uvic.ca/~frodo/jasper/software/jasper-$Jasper_Version.zip
	wget -c https://parallel-netcdf.github.io/Release/pnetcdf-$Pnetcdf_Version.tar.gz

	echo " "
	####################################Compilers#####################################
	export CC=gcc
	export CXX=g++
	export FC=gfortran
	export F77=gfortran
	export CFLAGS="-fPIC -fPIE -O3"

	#IF statement for GNU compiler issue
	export GCC_VERSION=$(gcc -dumpfullversion | awk '{print$1}')
	export GFORTRAN_VERSION=$(gfortran -dumpfullversion | awk '{print$1}')
	export GPLUSPLUS_VERSION=$(g++ -dumpfullversion | awk '{print$1}')

	export GCC_VERSION_MAJOR_VERSION=$(echo $GCC_VERSION | awk -F. '{print $1}')
	export GFORTRAN_VERSION_MAJOR_VERSION=$(echo $GFORTRAN_VERSION | awk -F. '{print $1}')
	export GPLUSPLUS_VERSION_MAJOR_VERSION=$(echo $GPLUSPLUS_VERSION | awk -F. '{print $1}')

	export version_10="10"

	if [ $GCC_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GFORTRAN_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GPLUSPLUS_VERSION_MAJOR_VERSION -ge $version_10 ]; then
		export fallow_argument=-fallow-argument-mismatch
		export boz_argument=-fallow-invalid-boz
	else
		export fallow_argument=
		export boz_argument=
	fi

	export FFLAGS="$fallow_argument -m64"
	export FCFLAGS="$fallow_argument -m64"

	echo "##########################################"
	echo "FFLAGS = $FFLAGS"
	echo "FCFLAGS = $FCFLAGS"
	echo "CFLAGS = $CFLAGS"
	echo "##########################################"

	echo " "
	############################# ZLib ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf zlib-$Zlib_Version.tar.gz
	cd zlib-$Zlib_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	export ZLIB_ROOT=$DIR/grib2
	export ZLIBLIB=$DIR/grib2/lib
	export ZLIBINC=$DIR/grib2/include

	echo " "
	############################## MPICH ############################
	#F90= due to compiler issues with mpich install
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf mpich-$Mpich_Version.tar.gz
	cd mpich-$Mpich_Version/

	F90= ./configure --prefix=$DIR/MPICH --with-device=ch3 FFLAGS=$fallow_argument FCFLAGS=$fallow_argument 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/MPICH/bin:$PATH
	export MPIFC=$DIR/MPICH/bin/mpifort
	export MPIF77=$DIR/MPICH/bin/mpifort
	export MPIF90=$DIR/MPICH/bin/mpifort
	export MPICC=$DIR/MPICH/bin/mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx

	echo " "
	############################# libpng ############################

	cd "${WRF_FOLDER}"/Downloads

	# other libraries below need these variables to be set
	export LDFLAGS=-L$DIR/grib2/lib
	export CPPFLAGS=-I$DIR/grib2/include

	LD_LIBRARY_PATH= tar -xvzf libpng-$Libpng_Version.tar.gz
	cd libpng-$Libpng_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNG_ROOT=$DIR/grib2

	echo " "
	#############################JasPer ############################
	cd "${WRF_FOLDER}"/Downloads
	unzip jasper-$Jasper_Version.zip
	cd jasper-$Jasper_Version/

	./configure --prefix=$DIR/grib2
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export JASPERLIB=$DIR/grib2/lib
	export JASPERINC=$DIR/grib2/include
	export JASPER_DIR=$DIR/grib2
	export Jasper_ROOT=$DIR/grib2/lib

	echo " "
	############################# hdf5 library for netcdf4 functionality ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf hdf5-$HDF5_Version.tar.gz
	cd hdf5-$HDF5_Version

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --with-zlib=$DIR/grib2 --enable-hl --enable-fortran --enable-parallel 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export HDF5=$DIR/grib2
	export PATH=$HDF5/bin:$PATH
	export PHDF5=$DIR/grib2
	export HDF5_ROOT=$DIR/grib2
	export PHDF5_ROOT=$DIR/grib2

	echo " "
	############################# Install Parallel-netCDF ##############################
	#Make file created with half of available cpu cores
	#Hard path for MPI added
	##################################################################################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf pnetcdf-$Pnetcdf_Version.tar.gz
	cd pnetcdf-$Pnetcdf_Version
	export MPIFC=$DIR/MPICH/bin/mpifort
	export MPIF77=$DIR/MPICH/bin/mpifort
	export MPIF90=$DIR/MPICH/bin/mpifort
	export MPICC=$DIR/MPICH/bin/mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --enable-static 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNETCDF=$DIR/grib2
	export PNETCDF_DIR=$DIR/grib2
	export PNETCDF_ROOT=$DIR/grib2

	echo " "

	############################## Install NETCDF C Library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_C_Version.tar.gz
	cd netcdf-c-$Netcdf_C_Version/
	export CPPFLAGS=-I$DIR/grib2/include
	export LDFLAGS="-L$DIR/grib2/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lhdf5_hl -lhdf5 -lz -lcurl -lgfortran -lgcc -lm -ldl -lpnetcdf"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --disable-dap --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-pnetcdf --enable-cdf5 --enable-parallel-tests --enable-logging 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/NETCDF/bin:$PATH
	export NETCDF=$DIR/NETCDF
	export NETCDF_INC=$DIR/NETCDF/include
	export NETCDF_LIB=$DIR/NETCDF/lib
	export NETCDF_ROOT=$DIR/NETCDF
	export LD_LIBRARY_PATH=$DIR/grib2/lib:$DIR/NETCDF/lib:$LD_LIBRARY_PATH

	echo " "
	############################## NetCDF fortran library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_Fortran_Version.tar.gz
	cd netcdf-fortran-$Netcdf_Fortran_Version/

	export LD_LIBRARY_PATH=$DIR/NETCDF/lib:$LD_LIBRARY_PATH
	export CPPFLAGS="-I$DIR/NETCDF/include -I$DIR/grib2/include"
	export LDFLAGS="-L$DIR/NETCDF/lib -L$DIR/grib2/lib -Wl,-rpath,$DIR/NETCDF/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lnetcdf -lpnetcdf -lcurl -lhdf5_hl -lhdf5 -lz -lm -ldl -lgcc -lgfortran"
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-parallel-tests --enable-logging --enable-hdf5 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	echo " "
	#################################### System Environment Tests ##############

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_NETCDF_MPI_tests.tar
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_tests.tar

	LD_LIBRARY_PATH= tar -xvf Fortran_C_tests.tar -C "${WRF_FOLDER}"/Tests/Environment
	LD_LIBRARY_PATH= tar -xvf Fortran_C_NETCDF_MPI_tests.tar -C "${WRF_FOLDER}"/Tests/Compatibility

	export one="1"
	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Environment

	cp ${NETCDF}/include/netcdf.inc .

	echo " "
	echo " "
	echo "Environment Testing "
	echo "Test 1"
	$FC TEST_1_fortran_only_fixed.f
	./a.out | tee env_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 1 Passed"
	else
		echo "Environment Compiler Test 1 Failed"
		exit
	fi
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 2"
	$FC TEST_2_fortran_only_free.f90
	./a.out | tee env_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 2 Passed"
	else
		echo "Environment Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 3"
	$CC TEST_3_c_only.c
	./a.out | tee env_test3.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test3.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 3 Passed"
	else
		echo "Environment Compiler Test 3 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 4"
	$CC -c -m64 TEST_4_fortran+c_c.c
	$FC -c -m64 TEST_4_fortran+c_f.f90
	$FC -m64 TEST_4_fortran+c_f.o TEST_4_fortran+c_c.o
	./a.out | tee env_test4.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test4.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 4 Passed"
	else
		echo "Environment Compiler Test 4 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Compatibility

	cp ${NETCDF}/include/netcdf.inc .

	echo " "
	echo " "
	echo "Library Compatibility Tests "
	echo "Test 1"
	$FC -c 01_fortran+c+netcdf_f.f
	$CC -c 01_fortran+c+netcdf_c.c
	$FC 01_fortran+c+netcdf_f.o 01_fortran+c+netcdf_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	./a.out | tee comp_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 1 Passed"
	else
		echo "Compatibility Compiler Test 1 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "

	echo "Test 2"
	$MPIFC -c 02_fortran+c+netcdf+mpi_f.f
	$MPICC -c 02_fortran+c+netcdf+mpi_c.c
	$MPIFC 02_fortran+c+netcdf+mpi_f.o \
		02_fortran+c+netcdf+mpi_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	$DIR/MPICH/bin/mpirun ./a.out | tee comp_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 2 Passed"
	else
		echo "Compatibility Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."
	echo " "

	echo " All tests completed and passed"
	echo " "

	################################## GrADS ###############################
	# Version  2.2.1
	# Sublibs library instructions: http://cola.gmu.edu/grads/gadoc/supplibs2.html
	# GrADS instructions: http://cola.gmu.edu/grads/downloads.php
	########################################################################
	if [[ $GRADS_PICK -eq 2 ]]; then
		cd "${WRF_FOLDER}"/Downloads
		wget -c ftp://cola.gmu.edu/grads/2.2/grads-2.2.1-bin-RHL7.4-x86_64.tar.gz
		LD_LIBRARY_PATH= tar -xvzf grads-2.2.1-bin-RHL7.4-x86_64.tar.gz -C "${WRF_FOLDER}"
		cd "${WRF_FOLDER}"/grads-2.2.1/bin
		chmod 775 *

	fi

	##################### NCAR COMMAND LANGUAGE           ##################
	########### NCL compiled via Conda                    ##################
	########### This is the preferred method by NCAR      ##################
	########### https://www.ncl.ucar.edu/index.shtml      ##################
	echo " "
	#Installing Miniconda3 to WRF directory and updating libraries
	echo $PASSWD | sudo -S dnf -y install python3-zstandard python3-zstd

	export Miniconda_Install_DIR="${WRF_FOLDER}"/miniconda3

	mkdir -p $Miniconda_Install_DIR

	wget -c https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O $Miniconda_Install_DIR/miniconda.sh
	bash $Miniconda_Install_DIR/miniconda.sh -b -u -p $Miniconda_Install_DIR

	rm -rf $Miniconda_Install_DIR/miniconda.sh

	export PATH="${WRF_FOLDER}"/miniconda3/bin:$PATH

	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	$Miniconda_Install_DIR/bin/conda init bash

	conda tos accept
	conda config --add channels conda-forge
	conda config --set auto_activate_base false
	conda update -n root --all -y

	echo " "

	echo " "
	#Installing NCL via Conda
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	conda create -n ncl_stable -c conda-forge ncl -y
	conda activate ncl_stable

	conda deactivate
	conda deactivate
	conda deactivate

	echo " "

	############################OBSGRID###############################
	## OBSGRID
	## Downloaded from git tagged releases
	## Option #2
	########################################################################
	cd "${WRF_FOLDER}"/
	git clone https://github.com/wrf-model/OBSGRID.git
	cd "${WRF_FOLDER}"/OBSGRID

	LD_LIBRARY_PATH= ./clean -a
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh
	conda activate ncl_stable

	export HOME=$(
		cd
		pwd
	)
	export DIR="${WRF_FOLDER}"/Libs
	export NETCDF=$DIR/NETCDF

	if [ ${auto_config} -eq 1 ]; then
		echo 2 | ./configure 2>&1 | tee configure.log #Option 2 for gfortran/gcc and distribunted memory
	else
		./configure 2>&1 | tee configure.log #Option 2 for gfortran/gcc and distribunted memory
	fi

	sed -i '27s/-lnetcdf -lnetcdff/ -lnetcdff -lnetcdf/g' configure.oa

	sed -i '31s/-lncarg -lncarg_gks -lncarg_c -lX11 -lm -lcairo/-lncarg -lncarg_gks -lncarg_c -lX11 -lm -lcairo -lfontconfig -lpixman-1 -lfreetype -lhdf5 -lhdf5_hl /g' configure.oa

	sed -i '39s/-frecord-marker=4/-frecord-marker=4 ${fallow_argument} /g' configure.oa

	sed -i '44s/=	/=	${fallow_argument} /g' configure.oa

	sed -i '45s/-C -P -traditional/-P -traditional/g' configure.oa

	echo " "
	LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.obsgrid.log

	conda deactivate
	conda deactivate
	conda deactivate

	echo " "
	# IF statement to check that all files were created.
	if [[ -x ./obsgrid.exe ]]; then
		echo "obsgrid.exe found."
		read -r -t 5 -p "Finished installing OBSGRID. I am going to wait for 5 seconds only ..."
	else
		echo "obsgrid.exe is missing. Attempting to compile again..."

		LD_LIBRARY_PATH= ./clean -a
		LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.obsgrid.retry.log

		if [[ -x ./obsgrid.exe ]]; then
			echo "obsgrid.exe successfully created after recompilation."
			read -r -t 5 -p "Finished retrying OBSGRID compile. I am going to wait for 5 seconds only ..."
		else
			echo "Still missing obsgrid.exe after recompile. Exiting the script."
			read -r -p "Please contact script authors for assistance. Press 'Enter' to exit."
			exit 1
		fi
	fi

	echo " "

	##################### WRF Python           ##################
	########### WRf-Python compiled via Conda  ##################
	########### This is the preferred method by NCAR      ##################
	##### https://wrf-python.readthedocs.io/en/latest/installation.html  ##################
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh
	conda env create -f $HOME/WRF-MOSIT/wrf-python-stable.yml

	############################WRFDA 3DVAR###############################
	## WRFDA v${WPS_VERSION} 3DVAR
	## Downloaded from git tagged releases
	## Does not include RTTOV Libarary for radiation data.  If wanted will need to install library then reconfigure
	##Note: if you intend to run both 3DVAR and 4DVAR experiments, it is not necessary to compile the code twice.
	#Option 34 for gfortran/gcc and distribunted memory
	########################################################################
	cd "${WRF_FOLDER}"/Downloads
	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/wrf-model/WRF/releases/download/v${WRF_VERSION}/v${WRF_VERSION}.tar.gz -O WRF-${WRF_VERSION}.tar.gz
	mkdir -p "${WRF_FOLDER}"/WRFDA
	LD_LIBRARY_PATH= tar -xvzf WRF-${WRF_VERSION}.tar.gz -C "${WRF_FOLDER}"/WRFDA
	# If statement for changing folder name inside WRFDA
	if [ -d "${WRF_FOLDER}/WRFDA/WRF" ]; then
		mv -f "${WRF_FOLDER}/WRFDA/WRF" "${WRF_FOLDER}/WRFDA/WRF-${WRF_VERSION}"

	else
		for dir in "${WRF_FOLDER}/WRFDA"/WRFV*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WRFDA/WRF-${WRF_VERSION}"
				break
			fi
		done
	fi
	cd "${WRF_FOLDER}"/WRFDA/WRF-${WRF_VERSION}
	mv * "${WRF_FOLDER}"/WRFDA
	cd "${WRF_FOLDER}"/WRFDA
	rm -rf WRF-${WRF_VERSION}/
	cd "${WRF_FOLDER}"/WRFDA

	ulimit -s unlimited
	export WRF_CHEM=1
	export WRFIO_NCD_LARGE_FILE_SUPPORT=1

	LD_LIBRARY_PATH= ./clean -a

	if [ ${auto_config} -eq 1 ]; then
		echo 34 | ./configure wrfda 2>&1 | tee configure.log #Option 34 for gfortran/gcc and distribunted memory
	else
		./configure wrfda 2>&1 | tee configure.log #Option 18 for gfortran/gcc and distribunted memory
	fi
	echo " "
	LD_LIBRARY_PATH= ./compile -j 4 all_wrfvar 2>&1 | tee compile.chem.wrfvar.log
	echo " "

	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WRFDA/var/da
	n=$(ls ./*.exe | wc -l)
	cd "${WRF_FOLDER}"/WRFDA/var/obsproc/src
	m=$(ls ./*.exe | wc -l)
	if ((($n == 43) && ($m == 1))); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WRFDA. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		cd "${WRF_FOLDER}"/WRFDA
		LD_LIBRARY_PATH= ./compile -j 2 all_wrfvar 2>&1 | tee compile.chem.wrfvar2.log
		cd "${WRF_FOLDER}"/WRFDA/var/da
		n=$(ls ./*.exe | wc -l)
		cd "${WRF_FOLDER}"/WRFDA/var/obsproc/src
		m=$(ls ./*.exe | wc -l)
		if ((($n == 43) && ($m == 1))); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WRFDA. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi
	echo " "

	############################ WRFCHEM #################################
	## WRF CHEM v${WPS_VERSION}
	## Downloaded from git tagged releases
	# option 34, option 1 for gfortran and distributed memory w/basic nesting
	# If the script comes back asking to locate a file (libfl.a)
	# Use locate command to find file. in a new terminal and then copy that location
	#locate *name of file*
	#Optimization set to 0 due to buffer overflow dump
	#sed -i -e 's/="-O"/="-O0/' configure_kpp
	# io_form_boundary
	# io_form_history
	# io_form_auxinput2
	# io_form_auxhist2
	# Note that you need set nocolons = .true. in the section &time_control of namelist.input
	########################################################################
	cd /tmp

	# Download the flex 2.6.4 source tarball
	wget https://github.com/westes/flex/releases/download/v2.6.4/flex-2.6.4.tar.gz

	# Extract it
	tar -xzf flex-2.6.4.tar.gz
	cd flex-2.6.4

	# Configure to install into /usr (so libs go to /usr/lib64)
	./configure --prefix=/usr/ 2>&1 | tee "${WRF_FOLDER}"/Downloads/flex.configure.log

	# Build
	make 2>&1 | tee "${WRF_FOLDER}"/Downloads/flex.make.log

	# Install (will prompt for sudo password)
	echo $PASSWD | sudo -S make install

	# --------------------------------------------------------
	# Detect Flex library location automatically
	# --------------------------------------------------------
	FLEX_LIB_PATH=$(find /usr /usr/local -type f \( -name "libfl.a" -o -name "libfl.so" \) 2>/dev/null | head -n 1)
	# Extract the directory name only
	FLEX_LIB_DIR=$(dirname "$FLEX_LIB_PATH")

	# Export it for WRF configure
	export FLEX_LIB_DIR
	echo "FLEX_LIB_DIR set to $FLEX_LIB_DIR"

	# --------------------------------------------------------
	# Setting up WRF-CHEM/KPP environment
	# --------------------------------------------------------
	cd "${WRF_FOLDER}"/Downloads

	ulimit -s unlimited
	export WRF_EM_CORE=1
	export WRF_NMM_CORE=0
	export WRF_CHEM=1
	export WRF_KPP=1

	export YACC='/usr/bin/yacc -d'
	export FLEX=/usr/bin/flex

	# FLEX_LIB_DIR is already set above, no need to hardcode

	export KPP_HOME="${WRF_FOLDER}"/WRF-${WRF_VERSION}/chem/KPP/kpp/kpp-2.1
	export WRF_SRC_ROOT_DIR="${WRF_FOLDER}"/WRF-${WRF_VERSION}
	export PATH=$KPP_HOME/bin:$PATH
	export SED=/usr/bin/sed
	export WRFIO_NCD_LARGE_FILE_SUPPORT=1

	#Downloading WRF code

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/wrf-model/WRF/releases/download/v${WRF_VERSION}/v${WRF_VERSION}.tar.gz -O WRF-${WRF_VERSION}.tar.gz
	LD_LIBRARY_PATH= tar -xvzf WRF-${WRF_VERSION}.tar.gz -C "${WRF_FOLDER}"/
	# If statment for changing folder name
	# Check if WRF directory exists
	if [ -d "${WRF_FOLDER}/WRF" ]; then
		mv -f "${WRF_FOLDER}/WRF" "${WRF_FOLDER}/WRF-${WRF_VERSION}"

	# Else, check for any folder matching WRFV*
	else
		for dir in "${WRF_FOLDER}"/WRFV*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WRF-${WRF_VERSION}"
				break
			fi
		done
	fi
	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}

	LD_LIBRARY_PATH= ./clean -a

	sed -i '121s|$WKC_HOME/util/wkc/tuv_kpp FIRST ../../inc/|$WKC_HOME/util/wkc/tuv_kpp FIRST ../../../../inc/|g' "${WRF_FOLDER}"/WRF-${WRF_VERSION}/chem/KPP/compile_wkc

	if [ ${auto_config} -eq 1 ]; then
		(
			echo 34
			echo 1
		) | ./configure

	else
		./configure 2>&1 | tee configure.log #Option 34 gfortran compiler with distributed memory option 1 for basic nesting
	fi

	LD_LIBRARY_PATH= ./compile -j 2 em_real 2>&1 | tee compile.wrf1.log

	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/main
	n=$(ls ./*.exe | wc -l)
	if (($n >= 3)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}
		LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN em_real 2>&1 | tee compile.wrf2.log
		cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/main
		n=$(ls ./*.exe | wc -l)
		if (($n >= 3)); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}
	LD_LIBRARY_PATH= ./compile -j 2 emi_conv 2>&1 | tee compile.emis.log

	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/chem

	if [[ -f convert_emiss.exe ]]; then
		echo "All expected files created."

		# Create symbolic link in the main directory
		ln -sf "${WRF_FOLDER}/WRF-${WRF_VERSION}/chem/convert_emiss.exe" "${WRF_FOLDER}/WRF-${WRF_VERSION}/main/convert_emiss.exe"

		echo "Symbolic link created in main/"
		read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}
		LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN emi_conv 2>&1 | tee compile.emis2.log

		cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/chem
		if [[ -f convert_emiss.exe ]]; then
			echo "All expected files created after recompilation."

			# Create symbolic link in the main directory
			ln -sf "${WRF_FOLDER}/WRF-${WRF_VERSION}/chem/convert_emiss.exe" "${WRF_FOLDER}/WRF-${WRF_VERSION}/main/convert_emiss.exe"

			echo "Symbolic link created in main/"
			read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	export WRF_DIR="${WRF_FOLDER}"/WRF-${WRF_VERSION}

	############################WPS#####################################
	## WPS v${WPS_VERSION}
	## Downloaded from git tagged releases
	#Option 3 for gfortran and distributed memory
	########################################################################

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/wrf-model/WPS/archive/refs/tags/v${WPS_VERSION}.tar.gz -O WPS-${WPS_VERSION}.tar.gz
	LD_LIBRARY_PATH= tar -xvzf WPS-${WPS_VERSION}.tar.gz -C "${WRF_FOLDER}"/
	cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}

	LD_LIBRARY_PATH= ./clean -a

	if [ ${auto_config} -eq 1 ]; then
		echo 3 | ./configure 2>&1 | tee configure.log #Option 3 for gfortran and distributed memory
	else
		./configure 2>&1 | tee configure.log #Option 3 gfortran compiler with distributed memory
	fi
	./compile

	echo " "

	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
	n=$(ls ./*.exe | wc -l)
	if (($n == 3)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WPS. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.wps2.log
		cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
		n=$(ls ./*.exe | wc -l)
		if (($n == 3)); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WPS. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	echo " "

	######################## Static Geography Data inc/ Optional ####################
	# http://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html
	# These files are large so if you only need certain ones comment the others off
	# All files downloaded and untarred is 200GB
	# https://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html
	#################################################################################
	cd "${WRF_FOLDER}"/Downloads
	mkdir "${WRF_FOLDER}"/GEOG
	mkdir "${WRF_FOLDER}"/GEOG/WPS_GEOG

	echo " "
	echo "Mandatory WRF Preprocessing System (WPS) Geographical Input Data Mandatory Fields Downloads"
	echo " "
	wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_high_res_mandatory.tar.gz
	LD_LIBRARY_PATH= tar -xvzf geog_high_res_mandatory.tar.gz -C "${WRF_FOLDER}"/GEOG/

	wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_low_res_mandatory.tar.gz
	LD_LIBRARY_PATH= tar -xvzf geog_low_res_mandatory.tar.gz -C "${WRF_FOLDER}"/GEOG/
	mv "${WRF_FOLDER}"/GEOG/WPS_GEOG_LOW_RES/ "${WRF_FOLDER}"/GEOG/WPS_GEOG

	if [ ${WPS_Specific_Applications} -eq 1 ]; then
		echo " "
		echo " WPS Geographical Input Data Mandatory for Specific Applications"
		echo " "

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_thompson28_chem.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_thompson28_chem.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_noahmp.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_noahmp.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/irrigation.tar.gz
		LD_LIBRARY_PATH= tar -xvzf irrigation.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG
		mkdir "${WRF_FOLDER}"/GEOG/WPS_GEOG/irrigation
		mv "${WRF_FOLDER}"/GEOG/WPS_GEOG/fao "${WRF_FOLDER}"/GEOG/WPS_GEOG/irrigation

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_px.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_px.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_urban.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_urban.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_ssib.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_ssib.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/lake_depth.tar.bz2
		LD_LIBRARY_PATH= tar -xvf lake_depth.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/topobath_30s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf topobath_30s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/gsl_gwd.tar.bz2
		LD_LIBRARY_PATH= tar -xvf gsl_gwd.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/cglc_modis_lcz_global.tar.gz
		LD_LIBRARY_PATH= tar -xvf cglc_modis_lcz_global.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG
	fi

	if [ ${Optional_GEOG} -eq 1 ]; then
		echo " "
		echo "Optional WPS Geographical Input Data"
		echo " "

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_older_than_2000.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_older_than_2000.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/modis_landuse_20class_15s_with_lakes.tar.gz
		LD_LIBRARY_PATH= tar -xvzf modis_landuse_20class_15s_with_lakes.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_alt_lsm.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_alt_lsm.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/nlcd2006_ll_9s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf nlcd2006_ll_9s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/updated_Iceland_LU.tar.gz
		LD_LIBRARY_PATH= tar -xvf updated_Iceland_LU.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/modis_landuse_20class_15s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf modis_landuse_20class_15s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG
	fi
fi

if [ "$RHL_64bit_Intel" = "1"] && [ "$WRFCHEM_PICK" ]; then

	#############################basic package managment############################
	echo $PASSWD | sudo -S yum install epel-release -y
	echo $PASSWD | sudo -S yum install dnf -y
	echo $PASSWD | sudo -S dnf install epel-release -y
	echo $PASSWD | sudo -S dnf install dnf -y
	echo $PASSWD | sudo -S dnf -y update
	echo $PASSWD | sudo -S dnf -y upgrade
	echo $PASSWD | sudo -S dnf -y install bzip2 bzip2-devel byacc cairo-devel cmake cpp curl curl-devel flex fontconfig-devel gcc-c++ gcc-gfortran git java-11-openjdk java-11-openjdk-devel ksh libX11-devel libXaw-devel libXext-devel libXrender-devel libstdc++-devel libxml2 libxml2-devel m4 nfs-utils perl "perl(XML::LibXML)" pkgconfig pixman-devel python3 python3-devel tcsh time unzip wget
	echo $PASSWD | sudo -S dnf -y groupinstall "Development Tools"

	# download the key to system keyring; this and the following echo command are
	# needed in order to install the Intel compilers

	echo $PASSWD | sudo bash -c 'printf "[oneAPI]\nname=Intel oneAPI repository\nbaseurl=https://yum.repos.intel.com/oneapi\nenabled=1\ngpgcheck=1\nrepo_gpgcheck=1\ngpgkey=https://yum.repos.intel.com/intel-gpg-keys/GPG-PUB-KEY-INTEL-SW-PRODUCTS.PUB\n" > /etc/yum.repos.d/oneAPI.repo'

	echo $PASSWD | sudo -S mv /tmp/oneAPI.repo /etc/yum.repos.d

	echo $PASSWD | sudo -S dnf install intel-cpp-essentials -y

	# install the Intel compilers
	echo $PASSWD | sudo -S dnf upgrade intel-cpp-essentials -y
	echo $PASSWD | sudo -S dnf install intel-oneapi-base-toolkit -y
	echo $PASSWD | sudo -S dnf install intel-oneapi-hpc-toolkit -y
	echo $PASSWD | sudo -S dnf install intel-oneapi-python -y

	echo $PASSWD | sudo -S dnf update
	echo $PASSWD | sudo -S dnf -y install cmake pkgconfig
	echo $PASSWD | sudo -S dnf groupinstall "Development Tools" -y

	echo $PASSWD | sudo -S dnf -y update
	echo $PASSWD | sudo -S dnf -y upgrade

	# add the Intel compiler file paths to various environment variables
	source /opt/intel/oneapi/setvars.sh --force

	# some of the libraries we install below need one or more of these variables

	export CC=icx
	export CXX=icpx
	export FC=ifx
	export F77=ifx
	export F90=ifx
	export MPIFC=mpiifx
	export MPIF77=mpiifx
	export MPIF90=mpiifx
	export MPICC=mpiicx
	export MPICXX=mpiicpx
	export CFLAGS="-fPIC -fPIE -O3 -Wno-implicit-function-declaration -Wno-incompatible-function-pointer-types -Wno-unused-command-line-argument"
	export FFLAGS="-m64"
	export FCFLAGS="-m64"

	############################# CPU Core Management ####################################

	export CPU_CORE=$(nproc) # number of available threads on system
	export CPU_6CORE="6"
	export CPU_QUARTER=$(($CPU_CORE / 4)) # quarter of availble cores on system
	# Forces CPU cores to even number to avoid partial core export. ie 7 cores would be 3.5 cores.
	export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))

	# If statement for low core systems.  Forces computers to only use 1 core if there are 4 cores or less on the system.
	if [ $CPU_CORE -le $CPU_6CORE ]; then
		export CPU_QUARTER_EVEN="2"
	else
		export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))
	fi

	echo "##########################################"
	echo "Number of Threads being used $CPU_QUARTER_EVEN"
	echo "##########################################"

	############################## Directory Listing ############################
	# makes necessary directories
	#
	############################################################################

	export HOME=$(
		cd
		pwd
	)
	export WRF_FOLDER=$HOME/WRFCHEM_INTEL
	export DIR="${WRF_FOLDER}"/Libs
	mkdir "${WRF_FOLDER}"
	cd "${WRF_FOLDER}"
	mkdir Downloads

	mkdir Libs
	mkdir Libs/grib2
	mkdir Libs/NETCDF
	mkdir Libs/MPICH
	mkdir -p Tests/Environment
	mkdir -p Tests/Compatibility

	echo " "
	############################## Downloading Libraries ############################

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/madler/zlib/releases/download/v$Zlib_Version/zlib-$Zlib_Version.tar.gz
	wget -c https://github.com/HDFGroup/hdf5/releases/download/hdf5_$HDF5_Version/hdf5-$HDF5_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-c/archive/refs/tags/v$Netcdf_C_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-fortran/archive/refs/tags/v$Netcdf_Fortran_Version.tar.gz
	wget -c https://download.sourceforge.net/libpng/libpng-$Libpng_Version.tar.gz
	wget -c https://www.ece.uvic.ca/~frodo/jasper/software/jasper-$Jasper_Version.zip
	wget -c https://parallel-netcdf.github.io/Release/pnetcdf-$Pnetcdf_Version.tar.gz

	echo " "

	############################# ZLib ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf zlib-$Zlib_Version.tar.gz
	cd zlib-$Zlib_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	export ZLIB_ROOT=$DIR/grib2
	export ZLIBLIB=$DIR/grib2/lib
	export ZLIBINC=$DIR/grib2/include

	echo " "
	############################# LibPNG ############################

	cd "${WRF_FOLDER}"/Downloads

	# other libraries below need these variables to be set
	export LDFLAGS=-L$DIR/grib2/lib
	export CPPFLAGS=-I$DIR/grib2/include

	LD_LIBRARY_PATH= tar -xvzf libpng-$Libpng_Version.tar.gz
	cd libpng-$Libpng_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNG_ROOT=$DIR/grib2

	echo " "
	############################# JasPer ############################

	cd "${WRF_FOLDER}"/Downloads
	unzip jasper-$Jasper_Version.zip
	cd jasper-$Jasper_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	# other libraries below need these variables to be set
	export JASPERLIB=$DIR/grib2/lib
	export JASPERINC=$DIR/grib2/include
	export JASPER_DIR=$DIR/grib2
	export Jasper_ROOT=$DIR/grib2/lib

	echo " "
	############################# HDF5 library for NetCDF4 & parallel functionality ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf hdf5-$HDF5_Version.tar.gz
	cd hdf5-$HDF5_Version

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --with-zlib=$DIR/grib2 --enable-hl --enable-fortran --enable-parallel 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	# other libraries below need these variables to be set
	export HDF5=$DIR/grib2
	export PATH=$HDF5/bin:$PATH
	export PHDF5=$DIR/grib2
	export HDF5_ROOT=$DIR/grib2
	export PHDF5_ROOT=$DIR/grib2

	echo " "

	############################# Install Parallel-netCDF ##############################
	#Make file created with half of available cpu cores
	#Hard path for MPI added
	##################################################################################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf pnetcdf-$Pnetcdf_Version.tar.gz
	cd pnetcdf-$Pnetcdf_Version
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --enable-static 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	#make check

	export PNETCDF=$DIR/grib2
	export PNETCDF_DIR=$DIR/grib2
	export PNETCDF_ROOT=$DIR/grib2

	echo " "

	############################## Install NETCDF-C Library ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_C_Version.tar.gz
	cd netcdf-c-$Netcdf_C_Version/

	# these variables need to be set for the NetCDF-C install to work
	export CPPFLAGS=-I$DIR/grib2/include
	export LDFLAGS="-L$DIR/grib2/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lhdf5_hl -lhdf5 -lz -lcurl -lgcc -lm -ldl -lpnetcdf"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --disable-dap --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-pnetcdf --enable-cdf5 --enable-parallel-tests --enable-logging 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	# other libraries below need these variables to be set
	export PATH=$DIR/NETCDF/bin:$PATH
	export NETCDF=$DIR/NETCDF
	export NETCDF_INC=$DIR/NETCDF/include
	export NETCDF_LIB=$DIR/NETCDF/lib
	export NETCDF_ROOT=$DIR/NETCDF
	export LD_LIBRARY_PATH=$DIR/grib2/lib:$DIR/NETCDF/lib:$LD_LIBRARY_PATH

	echo " "
	############################## NetCDF-Fortran library ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_Fortran_Version.tar.gz
	cd netcdf-fortran-$Netcdf_Fortran_Version/

	# these variables need to be set for the NetCDF-Fortran install to work
	export LD_LIBRARY_PATH=$DIR/NETCDF/lib:$LD_LIBRARY_PATH
	export CPPFLAGS="-I$DIR/NETCDF/include -I$DIR/grib2/include"
	export LDFLAGS="-L$DIR/NETCDF/lib -L$DIR/grib2/lib -Wl,-rpath,$DIR/NETCDF/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lnetcdf -lpnetcdf -lcurl -lhdf5_hl -lhdf5 -lz -lm -ldl -lgcc"
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --enable-netcdf-4 --enable-netcdf4 --enable-parallel-tests --enable-logging --enable-hdf5 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	echo " "
	#################################### System Environment Tests ##############

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_NETCDF_MPI_tests.tar
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_tests.tar

	LD_LIBRARY_PATH= tar -xvf Fortran_C_tests.tar -C "${WRF_FOLDER}/Tests/Environment"
	LD_LIBRARY_PATH= tar -xvf Fortran_C_NETCDF_MPI_tests.tar -C "${WRF_FOLDER}"/Tests/Compatibility

	export one="1"
	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Environment

	echo " "
	echo " "
	echo "Environment Testing "
	echo "Test 1"
	$FC TEST_1_fortran_only_fixed.f
	./a.out | tee env_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 1 Passed"
	else
		echo "Environment Compiler Test 1 Failed"
		exit
	fi
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 2"
	$FC TEST_2_fortran_only_free.f90
	./a.out | tee env_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 2 Passed"
	else
		echo "Environment Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 3"
	$CC TEST_3_c_only.c
	./a.out | tee env_test3.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test3.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 3 Passed"
	else
		echo "Environment Compiler Test 3 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 4"
	$CC -c -m64 TEST_4_fortran+c_c.c
	$FC -c -m64 TEST_4_fortran+c_f.f90
	$FC -m64 TEST_4_fortran+c_f.o TEST_4_fortran+c_c.o
	./a.out | tee env_test4.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test4.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 4 Passed"
	else
		echo "Environment Compiler Test 4 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Compatibility

	cp ${NETCDF}/include/netcdf.inc .

	echo " "
	echo " "
	echo "Library Compatibility Tests "
	echo "Test 1"
	$FC -c 01_fortran+c+netcdf_f.f
	$CC -c 01_fortran+c+netcdf_c.c
	$FC 01_fortran+c+netcdf_f.o 01_fortran+c+netcdf_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	./a.out | tee comp_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 1 Passed"
	else
		echo "Compatibility Compiler Test 1 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "

	echo "Test 2"
	$MPIFC -c 02_fortran+c+netcdf+mpi_f.f
	$MPICC -c 02_fortran+c+netcdf+mpi_c.c
	$MPIFC 02_fortran+c+netcdf+mpi_f.o \
		02_fortran+c+netcdf+mpi_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	mpirun ./a.out | tee comp_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 2 Passed"
	else
		echo "Compatibility Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."
	echo " "

	echo " All tests completed and passed"
	echo " "

	################################OpenGrADS######################################
	#Verison 2.2.1 64bit of Linux
	#############################################################################
	if [[ $GRADS_PICK -eq 1 ]]; then
		cd "${WRF_FOLDER}"/Downloads
		LD_LIBRARY_PATH= tar -xvzf cd "${WRF_FOLDER}"/Downloads
		wget -c https://sourceforge.net/projects/opengrads/files/grads2/2.2.1.oga.1/Linux%20%2864%20Bits%29/opengrads-2.2.1.oga.1-bundle-x86_64-pc-linux-gnu-glibc_2.17.tar.gz
		LD_LIBRARY_PATH= tar -xvzf opengrads-2.2.1.oga.1-bundle-x86_64-pc-linux-gnu-glibc_2.17.tar.gz -C "${WRF_FOLDER}"/ -C "${WRF_FOLDER}"/
		cd "${WRF_FOLDER}"/
		mv "${WRF_FOLDER}"/opengrads-2.2.1.oga.1 "${WRF_FOLDER}"/GrADS
		cd GrADS/Contents
		wget -c https://github.com/regisgrundig/SIMOP/blob/master/g2ctl.pl
		chmod +x g2ctl.pl
		wget -c https://sourceforge.net/projects/opengrads/files/wgrib2/0.1.9.4/wgrib2-v0.1.9.4-bin-x86_64-glibc2.5-linux-gnu.tar.gz
		LD_LIBRARY_PATH= tar -xvzf wgrib2-v0.1.9.4-bin-x86_64-glibc2.5-linux-gnu.tar.gz
		cd wgrib2-v0.1.9.4/bin
		mv wgrib2 "${WRF_FOLDER}"/GrADS/Contents
		cd "${WRF_FOLDER}"/GrADS/Contents
		rm wgrib2-v0.1.9.4-bin-x86_64-glibc2.5-linux-gnu.tar.gz
		rm -r wgrib2-v0.1.9.4

		export PATH="${WRF_FOLDER}"/GrADS/Contents:$PATH
	fi
	################################## GrADS ###############################
	# Version  2.2.1
	# Sublibs library instructions: http://cola.gmu.edu/grads/gadoc/supplibs2.html
	# GrADS instructions: http://cola.gmu.edu/grads/downloads.php
	########################################################################
	if [[ $GRADS_PICK -eq 2 ]]; then

		echo $PASSWD | sudo -S apt -y install grads

	fi

	##################### NCAR COMMAND LANGUAGE           ##################
	########### NCL compiled via Conda                    ##################
	########### This is the preferred method by NCAR      ##################
	########### https://www.ncl.ucar.edu/index.shtml      ##################
	echo " "
	#Installing Miniconda3 to WRF directory and updating libraries
	echo $PASSWD | sudo -S apt -y install python3-zstandard python3-zstd

	export Miniconda_Install_DIR="${WRF_FOLDER}"/miniconda3

	mkdir -p $Miniconda_Install_DIR

	wget -c https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O $Miniconda_Install_DIR/miniconda.sh
	bash $Miniconda_Install_DIR/miniconda.sh -b -u -p $Miniconda_Install_DIR

	rm -rf $Miniconda_Install_DIR/miniconda.sh

	export PATH="${WRF_FOLDER}"/miniconda3/bin:$PATH

	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	$Miniconda_Install_DIR/bin/conda init bash

	conda tos accept
	conda config --add channels conda-forge
	conda config --set auto_activate_base false
	conda update -n root --all -y

	#Special Thanks to @_WaylonWalker for code development

	#Installing NCL via Conda
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	conda create -n ncl_stable -c conda-forge ncl -y
	conda activate ncl_stable

	conda deactivate
	conda deactivate
	conda deactivate

	echo " "

	conda deactivate
	conda deactivate

	echo " "

	############################OBSGRID###############################
	## OBSGRID
	## Downloaded from git tagged releases
	## Option #3
	########################################################################
	cd "${WRF_FOLDER}"/
	git clone https://github.com/wrf-model/OBSGRID.git
	cd "${WRF_FOLDER}"/OBSGRID

	LD_LIBRARY_PATH= ./clean -a
	conda activate ncl_stable

	export HOME=$(
		cd
		pwd
	)
	export DIR="${WRF_FOLDER}"/Libs
	export NETCDF=$DIR/NETCDF

	if [ ${auto_config} -eq 1 ]; then
		echo 3 | ./configure 2>&1 | tee configure.log #Option 3 for itnel and distribunted memory
	else
		./configure 2>&1 | tee configure.log #Option 3 for intel and distribunted memory
	fi

	sed -i '27s/-lnetcdf -lnetcdff/ -lnetcdff -lnetcdf/g' configure.oa

	sed -i '31s/-lncarg -lncarg_gks -lncarg_c -lX11 -lm -lcairo/-lncarg -lncarg_gks -lncarg_c -lX11 -lm -lcairo -lfontconfig -lpixman-1 -lfreetype -lhdf5 -lhdf5_hl /g' configure.oa

	sed -i '38s/ifort/ifx/g' configure.oa
	sed -i '43s/gcc/icx/g' configure.oa
	sed -i '45s|/lib/cpp|ifx|g' configure.oa
	sed -i '46s|-I. -C -P -DDEC -traditional|-fpp -DDEC -I.|g' configure.oa

	# Patch .F90.o rule to use direct compile with Intel Fortran + fpp
	sed -i '/^\.F90\.o:/,/^\t\$(RM) \$\*\.f/ c\.F90.o:\n\t$(RM) $@ $*.mod\n\t$(FC) $(FFLAGS) -fpp $(CPPFLAGS) ${NETCDF_INC} -c $<' configure.oa

	echo " "
	LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.obsgrid.log

	conda deactivate
	conda deactivate
	conda deactivate

	echo " "
	# IF statement to check that all files were created.
	if [[ -x ./obsgrid.exe ]]; then
		echo "obsgrid.exe found."
		read -r -t 5 -p "Finished installing OBSGRID. I am going to wait for 5 seconds only ..."
	else
		echo "obsgrid.exe is missing. Attempting to compile again..."

		LD_LIBRARY_PATH= ./clean -a
		LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.obsgrid.retry.log

		if [[ -x ./obsgrid.exe ]]; then
			echo "obsgrid.exe successfully created after recompilation."
			read -r -t 5 -p "Finished retrying OBSGRID compile. I am going to wait for 5 seconds only ..."
		else
			echo "Still missing obsgrid.exe after recompile. Exiting the script."
			read -r -p "Please contact script authors for assistance. Press 'Enter' to exit."
			exit 1
		fi
	fi

	echo " "

	##################### WRF Python           ##################
	########### WRf-Python compiled via Conda  ##################
	########### This is the preferred method by NCAR      ##################
	##### https://wrf-python.readthedocs.io/en/latest/installation.html  ##################
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh
	conda env create -f $HOME/WRF-MOSIT/wrf-python-stable.yml

	######################### Climate Data Operators ############
	######################### CDO compiled via Conda ###########
	####################### This is the preferred method #######
	################### https://bairdlangenbrunner.github.io/python-for-climate-scientists/conda/setting-up-conda-environments.html #######################

	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	conda create --name cdo_stable -y
	conda activate cdo_stable
	conda install -c conda-forge cdo -y
	conda update --all -y
	conda deactivate
	conda deactivate
	conda deactivate

	echo " "

	############################WRFDA 3DVAR###############################
	## WRFDA v${WPS_VERSION} 3DVAR
	## Downloaded from git tagged releases
	## Does not include RTTOV Libarary for radiation data.  If wanted will need to install library then reconfigure
	##Note: if you intend to run both 3DVAR and 4DVAR experiments, it is not necessary to compile the code twice.
	#Option 34 for gfortran/gcc and distribunted memory
	########################################################################
	source /opt/intel/oneapi/setvars.sh --force

	cd "${WRF_FOLDER}"/Downloads
	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/wrf-model/WRF/releases/download/v${WRF_VERSION}/v${WRF_VERSION}.tar.gz -O WRF-${WRF_VERSION}.tar.gz
	mkdir -p "${WRF_FOLDER}"/WRFDA
	LD_LIBRARY_PATH= tar -xvzf WRF-${WRF_VERSION}.tar.gz -C "${WRF_FOLDER}"/WRFDA
	# If statement for changing folder name inside WRFDA
	if [ -d "${WRF_FOLDER}/WRFDA/WRF" ]; then
		mv -f "${WRF_FOLDER}/WRFDA/WRF" "${WRF_FOLDER}/WRFDA/WRF-${WRF_VERSION}"

	else
		for dir in "${WRF_FOLDER}/WRFDA"/WRFV*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WRFDA/WRF-${WRF_VERSION}"
				break
			fi
		done
	fi
	cd "${WRF_FOLDER}"/WRFDA/WRF-${WRF_VERSION}
	mv * "${WRF_FOLDER}"/WRFDA
	cd "${WRF_FOLDER}"/WRFDA
	rm -rf WRF-${WRF_VERSION}/
	cd "${WRF_FOLDER}"/WRFDA

	ulimit -s unlimited
	export WRF_CHEM=1
	export WRFIO_NCD_LARGE_FILE_SUPPORT=1

	LD_LIBRARY_PATH= ./clean -a

	if [ ${auto_config} -eq 1 ]; then
		echo 78 | ./configure wrfda 2>&1 | tee configure.log #option 78 for intel and distribunted memory
	else
		./configure wrfda 2>&1 | tee configure.log #option 78 for intel and distribunted memory
	fi
	echo " "

	#Need to remove mpich/GNU config calls to Intel config calls
	sed -i '136s|mpif90 -f90=$(SFC)|mpiifx|g' "${WRF_FOLDER}"/WRFDA/configure.wrf
	sed -i '137s|mpicc -cc=$(SCC)|mpiicx|g' "${WRF_FOLDER}"/WRFDA/configure.wrf

	LD_LIBRARY_PATH= ./compile -j 4 all_wrfvar 2>&1 | tee compile.chem.wrfvar.log
	echo " "

	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WRFDA/var/da
	n=$(ls ./*.exe | wc -l)
	cd "${WRF_FOLDER}"/WRFDA/var/obsproc/src
	m=$(ls ./*.exe | wc -l)
	if ((($n == 43) && ($m == 1))); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WRFDA. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		cd "${WRF_FOLDER}"/WRFDA
		LD_LIBRARY_PATH= ./compile -j 2 all_wrfvar 2>&1 | tee compile.chem.wrfvar2.log
		cd "${WRF_FOLDER}"/WRFDA/var/da
		n=$(ls ./*.exe | wc -l)
		cd "${WRF_FOLDER}"/WRFDA/var/obsproc/src
		m=$(ls ./*.exe | wc -l)
		if ((($n == 43) && ($m == 1))); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WRFDA. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi
	echo " "

	############################ WRF #################################
	## WRF v${WPS_VERSION}
	## Downloaded from git tagged releases
	# option 78, option 1 for intel and distributed memory w/basic nesting
	# large file support enable with WRFiO_NCD_LARGE_FILE_SUPPORT=1
	########################################################################

	cd /tmp

	# Download the flex 2.6.4 source tarball
	wget https://github.com/westes/flex/releases/download/v2.6.4/flex-2.6.4.tar.gz

	# Extract it
	tar -xzf flex-2.6.4.tar.gz
	cd flex-2.6.4

	# Configure to install into /usr (so libs go to /usr/lib64)
	./configure --prefix=/usr/ 2>&1 | tee "${WRF_FOLDER}"/Downloads/flex.configure.log

	# Build
	make 2>&1 | tee "${WRF_FOLDER}"/Downloads/flex.make.log

	# Install (will prompt for sudo password)
	echo $PASSWD | sudo -S make install

	# --------------------------------------------------------
	# Detect Flex library location automatically
	# --------------------------------------------------------
	FLEX_LIB_PATH=$(find /usr /usr/local -type f \( -name "libfl.a" -o -name "libfl.so" \) 2>/dev/null | head -n 1)
	# Extract the directory name only
	FLEX_LIB_DIR=$(dirname "$FLEX_LIB_PATH")

	# Export it for WRF configure
	export FLEX_LIB_DIR
	echo "FLEX_LIB_DIR set to $FLEX_LIB_DIR"

	# --------------------------------------------------------
	# Setting up WRF-CHEM/KPP environment
	# --------------------------------------------------------
	cd "${WRF_FOLDER}"/Downloads

	ulimit -s unlimited
	export WRF_EM_CORE=1
	export WRF_NMM_CORE=0
	export WRF_CHEM=1
	export WRF_KPP=1

	export YACC='/usr/bin/yacc -d'
	export FLEX=/usr/bin/flex

	# FLEX_LIB_DIR is already set above, no need to hardcode

	export KPP_HOME="${WRF_FOLDER}"/WRF-${WRF_VERSION}/chem/KPP/kpp/kpp-2.1
	export WRF_SRC_ROOT_DIR="${WRF_FOLDER}"/WRF-${WRF_VERSION}
	export PATH=$KPP_HOME/bin:$PATH
	export SED=/usr/bin/sed
	export WRFIO_NCD_LARGE_FILE_SUPPORT=1

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/wrf-model/WRF/releases/download/v${WRF_VERSION}/v${WRF_VERSION}.tar.gz -O WRF-${WRF_VERSION}.tar.gz
	LD_LIBRARY_PATH= tar -xvzf WRF-${WRF_VERSION}.tar.gz -C "${WRF_FOLDER}"/
	# If statment for changing folder name
	# Check if WRF directory exists
	if [ -d "${WRF_FOLDER}/WRF" ]; then
		mv -f "${WRF_FOLDER}/WRF" "${WRF_FOLDER}/WRF-${WRF_VERSION}"

	# Else, check for any folder matching WRFV*
	else
		for dir in "${WRF_FOLDER}"/WRFV*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WRF-${WRF_VERSION}"
				break
			fi
		done
	fi
	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}

	export WRFIO_NCD_LARGE_FILE_SUPPORT=1

	LD_LIBRARY_PATH= ./clean -a

	sed -i '121s|$WKC_HOME/util/wkc/tuv_kpp FIRST ../../inc/|$WKC_HOME/util/wkc/tuv_kpp FIRST ../../../../inc/|g' "${WRF_FOLDER}"/WRF-${WRF_VERSION}/chem/KPP/compile_wkc

	if [ ${auto_config} -eq 1 ]; then
		(
			echo 78
			echo 1
		) | ./configure

	else
		./configure 2>&1 | tee configure.log #option 78 intel compiler with distributed memory option 1 for basic nesting
	fi

	#Need to remove mpich/GNU config calls to Intel config calls
	sed -i '136s|mpif90 -f90=$(SFC)|mpiifx|g' "${WRF_FOLDER}"/WRF-${WRF_VERSION}/configure.wrf
	sed -i '137s|mpicc -cc=$(SCC)|mpiicx|g' "${WRF_FOLDER}"/WRF-${WRF_VERSION}/configure.wrf

	LD_LIBRARY_PATH= ./compile -j 2 em_real 2>&1 | tee compile.wrf1.log

	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/main
	n=$(ls ./*.exe | wc -l)
	if (($n >= 3)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}
		LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN em_real 2>&1 | tee compile.wrf2.log
		cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/main
		n=$(ls ./*.exe | wc -l)
		if (($n >= 3)); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}
	LD_LIBRARY_PATH= ./compile -j 2 emi_conv 2>&1 | tee compile.emis.log

	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/chem

	if [[ -f convert_emiss.exe ]]; then
		echo "All expected files created."

		# Create symbolic link in the main directory
		ln -sf "${WRF_FOLDER}/WRF-${WRF_VERSION}/chem/convert_emiss.exe" "${WRF_FOLDER}/WRF-${WRF_VERSION}/main/convert_emiss.exe"

		echo "Symbolic link created in main/"
		read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}
		LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN emi_conv 2>&1 | tee compile.emis2.log

		cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/chem
		if [[ -f convert_emiss.exe ]]; then
			echo "All expected files created after recompilation."

			# Create symbolic link in the main directory
			ln -sf "${WRF_FOLDER}/WRF-${WRF_VERSION}/chem/convert_emiss.exe" "${WRF_FOLDER}/WRF-${WRF_VERSION}/main/convert_emiss.exe"

			echo "Symbolic link created in main/"
			read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	export WRF_DIR="${WRF_FOLDER}"/WRF-${WRF_VERSION}

	############################WPS#####################################
	## WPS v${WPS_VERSION}
	## Downloaded from git tagged releases
	#Option 3 for gfortran and distributed memory
	########################################################################

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/wrf-model/WPS/archive/refs/tags/v${WPS_VERSION}.tar.gz -O WPS-${WPS_VERSION}.tar.gz
	LD_LIBRARY_PATH= tar -xvzf WPS-${WPS_VERSION}.tar.gz -C "${WRF_FOLDER}"/
	# Check if WPS directory exists
	if [ -d "${WRF_FOLDER}/WPS" ]; then
		mv -f "${WRF_FOLDER}/WPS" "${WRF_FOLDER}/WPS-${WPS_VERSION}"

	# Else, check for any folder matching WPSV* or WPS-*
	else
		for dir in "${WRF_FOLDER}"/WPSV* "${WRF_FOLDER}"/WPS-*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WPS-${WPS_VERSION}"
				break
			fi
		done
	fi
	cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
	LD_LIBRARY_PATH= ./clean -a

	if [ ${auto_config} -eq 1 ]; then
		echo 19 | ./configure 2>&1 | tee configure.log #Option 19 for intel and distributed memory
	else
		./configure 2>&1 | tee configure.log #Option 19 intel compiler with distributed memory
	fi

	sed -i '67s|mpif90|mpiifx|g' "${WRF_FOLDER}"/WPS-${WPS_VERSION}/configure.wps
	sed -i '68s|mpicc|mpiicx|g' "${WRF_FOLDER}"/WPS-${WPS_VERSION}/configure.wps

	LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.wps.log

	echo " "
	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
	n=$(ls ./*.exe | wc -l)
	if (($n == 3)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WPS. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.wps2.log
		cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
		n=$(ls ./*.exe | wc -l)
		if (($n == 3)); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WPS. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	echo " "

	######################## Static Geography Data inc/ Optional ####################
	# http://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html
	# These files are large so if you only need certain ones comment the others off
	# All files downloaded and untarred is 200GB
	# https://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html
	#################################################################################
	cd "${WRF_FOLDER}"/Downloads
	mkdir "${WRF_FOLDER}"/GEOG
	mkdir "${WRF_FOLDER}"/GEOG/WPS_GEOG

	echo " "
	echo "Mandatory WRF Preprocessing System (WPS) Geographical Input Data Mandatory Fields Downloads"
	echo " "
	wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_high_res_mandatory.tar.gz
	LD_LIBRARY_PATH= tar -xvzf geog_high_res_mandatory.tar.gz -C "${WRF_FOLDER}"/GEOG/

	wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_low_res_mandatory.tar.gz
	LD_LIBRARY_PATH= tar -xvzf geog_low_res_mandatory.tar.gz -C "${WRF_FOLDER}"/GEOG/
	mv "${WRF_FOLDER}"/GEOG/WPS_GEOG_LOW_RES/ "${WRF_FOLDER}"/GEOG/WPS_GEOG

	if [ ${WPS_Specific_Applications} -eq 1 ]; then
		echo " "
		echo " WPS Geographical Input Data Mandatory for Specific Applications"
		echo " "

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_thompson28_chem.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_thompson28_chem.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_noahmp.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_noahmp.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/irrigation.tar.gz
		LD_LIBRARY_PATH= tar -xvzf irrigation.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_px.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_px.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_urban.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_urban.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_ssib.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_ssib.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/lake_depth.tar.bz2
		LD_LIBRARY_PATH= tar -xvf lake_depth.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/topobath_30s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf topobath_30s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/gsl_gwd.tar.bz2
		LD_LIBRARY_PATH= tar -xvf gsl_gwd.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/cglc_modis_lcz_global.tar.gz
		LD_LIBRARY_PATH= tar -xvf cglc_modis_lcz_global.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG
	fi

	if [ ${Optional_GEOG} -eq 1 ]; then
		echo " "
		echo "Optional WPS Geographical Input Data"
		echo " "

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_older_than_2000.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_older_than_2000.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/modis_landuse_20class_15s_with_lakes.tar.gz
		LD_LIBRARY_PATH= tar -xvzf modis_landuse_20class_15s_with_lakes.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_alt_lsm.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_alt_lsm.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/nlcd2006_ll_9s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf nlcd2006_ll_9s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/updated_Iceland_LU.tar.gz
		LD_LIBRARY_PATH= tar -xvf updated_Iceland_LU.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/modis_landuse_20class_15s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf modis_landuse_20class_15s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG
	fi

fi

########################### WRF  ##########################
# WRF installation with parallel process.
# Download and install required library and data files for WRF, WRFPLUS, WRFDA 4DVAR, WPS.
# Tested in Ubuntu 22.04 & 24.04, Rocky Linux 9 & MacOS Ventura 64bit
# Built in 64-bit system
# Built with Intel or GNU compilers
# Tested with current available libraries on 03/01/2025
# If newer libraries exist edit script paths for changes
#Estimated Run Time ~ 90 - 150 Minutes with 10mb/s downloadspeed.
# Special thanks to:
# Youtube's meteoadriatic, GitHub user jamal919.
# University of Manchester's  Doug L
# University of Tunis El Manar's Hosni
# GSL's Jordan S.
# NCAR's Mary B., Christine W., & Carl D.
# DTC's Julie P., Tara J., George M., & John H.
# UCAR's Katelyn F., Jim B., Jordan P., Kevin M.,
############################################################

if [ "$Ubuntu_64bit_GNU" = "1" ] && [ "$WRF_PICK" = "1" ]; then

	#############################basic package managment############################
	echo $PASSWD | sudo -S apt -y update
	echo $PASSWD | sudo -S apt -y upgrade

	release_version=$(lsb_release -r -s)

	# Compare the release version
	if [ "$release_version" = "24.04" ]; then
		# Install Emacs without recommended packages
		echo $PASSWD | sudo -S apt install emacs --no-install-recommends -y
	else
		# Attempt to install Emacs if the release version is not 24.04
		echo "The release version is not 24.04, attempting to install Emacs."
		echo $PASSWD | sudo -S apt install emacs -y
	fi

	echo $PASSWD | sudo -S apt -y install bison build-essential byacc cmake csh curl default-jdk default-jre flex libfl-dev g++ gawk gcc gettext gfortran git ksh libcurl4-gnutls-dev libjpeg-dev libncurses6 libpixman-1-dev libpng-dev libtool libxml2 libxml2-dev libxml-libxml-perl m4 make ncview pipenv pkg-config python3 python3-dev python3-pip python3-dateutil tcsh unzip xauth xorg time

	echo " "
	##############################Directory Listing############################
	export HOME=$(
		cd
		pwd
	)

	mkdir $HOME/WRF
	export WRF_FOLDER=$HOME/WRF
	cd "${WRF_FOLDER}"/
	mkdir Downloads

	mkdir Libs
	export DIR="${WRF_FOLDER}"/Libs
	mkdir Libs/grib2
	mkdir Libs/NETCDF
	mkdir Libs/MPICH
	mkdir -p Tests/Environment
	mkdir -p Tests/Compatibility

	echo " "
	#############################Core Management####################################

	export CPU_CORE=$(nproc) # number of available threads on system
	export CPU_6CORE="6"
	export CPU_QUARTER=$(($CPU_CORE / 4))                          #quarter of availble cores on system
	export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2))) #Forces CPU cores to even number to avoid partial core export. ie 7 cores would be 3.5 cores.

	if [ $CPU_CORE -le $CPU_6CORE ]; then #If statement for low core systems.  Forces computers to only use 1 core if there are 4 cores or less on the system. then
		export CPU_QUARTER_EVEN="2"
	else
		export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))
	fi

	echo "##########################################"
	echo "Number of Threads being used $CPU_QUARTER_EVEN"
	echo "##########################################"

	echo " "
	##############################Downloading Libraries############################
	cd Downloads
	wget -c https://github.com/madler/zlib/releases/download/v$Zlib_Version/zlib-$Zlib_Version.tar.gz
	wget -c https://github.com/HDFGroup/hdf5/releases/download/hdf5_$HDF5_Version/hdf5-$HDF5_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-c/archive/refs/tags/v$Netcdf_C_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-fortran/archive/refs/tags/v$Netcdf_Fortran_Version.tar.gz
	wget -c https://download.sourceforge.net/libpng/libpng-$Libpng_Version.tar.gz
	wget -c https://www.ece.uvic.ca/~frodo/jasper/software/jasper-$Jasper_Version.zip
	wget -c https://github.com/pmodels/mpich/releases/download/v$Mpich_Version/mpich-$Mpich_Version.tar.gz
	wget -c https://parallel-netcdf.github.io/Release/pnetcdf-$Pnetcdf_Version.tar.gz

	echo " "
	####################################Compilers#####################################
	export CC=gcc
	export CXX=g++
	export FC=gfortran
	export F77=gfortran
	export CFLAGS="-fPIC -fPIE -O3"

	#IF statement for GNU compiler issue
	export GCC_VERSION=$(/usr/bin/gcc -dumpfullversion | awk '{print$1}')
	export GFORTRAN_VERSION=$(/usr/bin/gfortran -dumpfullversion | awk '{print$1}')
	export GPLUSPLUS_VERSION=$(/usr/bin/g++ -dumpfullversion | awk '{print$1}')

	export GCC_VERSION_MAJOR_VERSION=$(echo $GCC_VERSION | awk -F. '{print $1}')
	export GFORTRAN_VERSION_MAJOR_VERSION=$(echo $GFORTRAN_VERSION | awk -F. '{print $1}')
	export GPLUSPLUS_VERSION_MAJOR_VERSION=$(echo $GPLUSPLUS_VERSION | awk -F. '{print $1}')

	export version_10="10"

	if [ $GCC_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GFORTRAN_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GPLUSPLUS_VERSION_MAJOR_VERSION -ge $version_10 ]; then
		export fallow_argument=-fallow-argument-mismatch
		export boz_argument=-fallow-invalid-boz
	else
		export fallow_argument=
		export boz_argument=
	fi

	export FFLAGS="$fallow_argument -m64"
	export FCFLAGS="$fallow_argument -m64"

	echo "##########################################"
	echo "FFLAGS = $FFLAGS"
	echo "FCFLAGS = $FCFLAGS"
	echo "CFLAGS = $CFLAGS"
	echo "##########################################"

	echo " "
	############################# ZLib ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf zlib-$Zlib_Version.tar.gz
	cd zlib-$Zlib_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	export ZLIB_ROOT=$DIR/grib2
	export ZLIBLIB=$DIR/grib2/lib
	export ZLIBINC=$DIR/grib2/include

	echo " "
	############################## MPICH ############################
	#F90= due to compiler issues with mpich install
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf mpich-$Mpich_Version.tar.gz
	cd mpich-$Mpich_Version/

	F90= ./configure --prefix=$DIR/MPICH --with-device=ch3 FFLAGS=$fallow_argument FCFLAGS=$fallow_argument 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/MPICH/bin:$PATH

	export MPIFC=$DIR/MPICH/bin/mpifort
	export MPIF77=$DIR/MPICH/bin/mpifort
	export MPIF90=$DIR/MPICH/bin/mpifort
	export MPICC=$DIR/MPICH/bin/mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx

	echo " "
	############################# libpng ############################

	cd "${WRF_FOLDER}"/Downloads

	# other libraries below need these variables to be set
	export LDFLAGS=-L$DIR/grib2/lib
	export CPPFLAGS=-I$DIR/grib2/include

	LD_LIBRARY_PATH= tar -xvzf libpng-$Libpng_Version.tar.gz
	cd libpng-$Libpng_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNG_ROOT=$DIR/grib2

	echo " "
	#############################JasPer ############################
	cd "${WRF_FOLDER}"/Downloads
	unzip jasper-$Jasper_Version.zip
	cd jasper-$Jasper_Version/

	./configure --prefix=$DIR/grib2
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export JASPERLIB=$DIR/grib2/lib
	export JASPERINC=$DIR/grib2/include
	export JASPER_DIR=$DIR/grib2
	export Jasper_ROOT=$DIR/grib2/lib

	echo " "
	############################# hdf5 library for netcdf4 functionality ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf hdf5-$HDF5_Version.tar.gz
	cd hdf5-$HDF5_Version

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --with-zlib=$DIR/grib2 --enable-hl --enable-fortran --enable-parallel 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export HDF5=$DIR/grib2
	export PATH=$HDF5/bin:$PATH
	export PHDF5=$DIR/grib2
	export HDF5_ROOT=$DIR/grib2
	export PHDF5_ROOT=$DIR/grib2

	echo " "
	############################# Install Parallel-netCDF ##############################
	#Make file created with half of available cpu cores
	#Hard path for MPI added
	##################################################################################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf pnetcdf-$Pnetcdf_Version.tar.gz
	cd pnetcdf-$Pnetcdf_Version
	export MPIFC=$DIR/MPICH/bin/mpifort
	export MPIF77=$DIR/MPICH/bin/mpifort
	export MPIF90=$DIR/MPICH/bin/mpifort
	export MPICC=$DIR/MPICH/bin/mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --enable-static 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNETCDF=$DIR/grib2
	export PNETCDF_DIR=$DIR/grib2
	export PNETCDF_ROOT=$DIR/grib2

	echo " "

	############################## Install NETCDF C Library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_C_Version.tar.gz
	cd netcdf-c-$Netcdf_C_Version/
	export CPPFLAGS=-I$DIR/grib2/include
	export LDFLAGS="-L$DIR/grib2/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lhdf5_hl -lhdf5 -lz -lcurl -lgfortran -lgcc -lm -ldl -lpnetcdf"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --disable-dap --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-pnetcdf --enable-cdf5 --enable-parallel-tests --enable-logging 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/NETCDF/bin:$PATH
	export NETCDF=$DIR/NETCDF
	export NETCDF_INC=$DIR/NETCDF/include
	export NETCDF_LIB=$DIR/NETCDF/lib
	export NETCDF_ROOT=$DIR/NETCDF
	export LD_LIBRARY_PATH=$DIR/grib2/lib:$DIR/NETCDF/lib:$LD_LIBRARY_PATH

	echo " "
	############################## NetCDF fortran library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_Fortran_Version.tar.gz
	cd netcdf-fortran-$Netcdf_Fortran_Version/
	export LD_LIBRARY_PATH=$DIR/NETCDF/lib:$LD_LIBRARY_PATH
	export CPPFLAGS="-I$DIR/NETCDF/include -I$DIR/grib2/include"
	export LDFLAGS="-L$DIR/NETCDF/lib -L$DIR/grib2/lib -Wl,-rpath,$DIR/NETCDF/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lnetcdf -lpnetcdf -lcurl -lhdf5_hl -lhdf5 -lz -lm -ldl -lgcc -lgfortran"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-parallel-tests --enable-logging --enable-hdf5 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	echo " "
	#################################### System Environment Tests ##############

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_NETCDF_MPI_tests.tar
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_tests.tar

	LD_LIBRARY_PATH= tar -xvf Fortran_C_tests.tar -C "${WRF_FOLDER}"/Tests/Environment
	LD_LIBRARY_PATH= tar -xvf Fortran_C_NETCDF_MPI_tests.tar -C "${WRF_FOLDER}"/Tests/Compatibility

	export one="1"
	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Environment

	cp ${NETCDF}/include/netcdf.inc .

	echo " "
	echo " "
	echo "Environment Testing "
	echo "Test 1"
	$FC TEST_1_fortran_only_fixed.f
	./a.out | tee env_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 1 Passed"
	else
		echo "Environment Compiler Test 1 Failed"
		exit
	fi
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 2"
	$FC TEST_2_fortran_only_free.f90
	./a.out | tee env_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 2 Passed"
	else
		echo "Environment Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 3"
	$CC TEST_3_c_only.c
	./a.out | tee env_test3.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test3.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 3 Passed"
	else
		echo "Environment Compiler Test 3 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 4"
	$CC -c -m64 TEST_4_fortran+c_c.c
	$FC -c -m64 TEST_4_fortran+c_f.f90
	$FC -m64 TEST_4_fortran+c_f.o TEST_4_fortran+c_c.o
	./a.out | tee env_test4.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test4.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 4 Passed"
	else
		echo "Environment Compiler Test 4 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Compatibility

	cp ${NETCDF}/include/netcdf.inc .

	echo " "
	echo " "
	echo "Library Compatibility Tests "
	echo "Test 1"
	$FC -c 01_fortran+c+netcdf_f.f
	$CC -c 01_fortran+c+netcdf_c.c
	$FC 01_fortran+c+netcdf_f.o 01_fortran+c+netcdf_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	./a.out | tee comp_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 1 Passed"
	else
		echo "Compatibility Compiler Test 1 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "

	echo "Test 2"
	$MPIFC -c 02_fortran+c+netcdf+mpi_f.f
	$MPICC -c 02_fortran+c+netcdf+mpi_c.c
	$MPIFC 02_fortran+c+netcdf+mpi_f.o \
		02_fortran+c+netcdf+mpi_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	$DIR/MPICH/bin/mpirun ./a.out | tee comp_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 2 Passed"
	else
		echo "Compatibility Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."
	echo " "

	echo " All tests completed and passed"
	echo " "

	################################ OpenGrADS ##################################
	#Verison 2.2.1 32bit of Linux
	#############################################################################
	if [[ $GRADS_PICK -eq 1 ]]; then
		cd "${WRF_FOLDER}"/Downloads
		LD_LIBRARY_PATH= tar -xvzf cd "${WRF_FOLDER}"/Downloads
		wget -c https://sourceforge.net/projects/opengrads/files/grads2/2.2.1.oga.1/Linux%20%2864%20Bits%29/opengrads-2.2.1.oga.1-bundle-x86_64-pc-linux-gnu-glibc_2.17.tar.gz
		LD_LIBRARY_PATH= tar -xvzf opengrads-2.2.1.oga.1-bundle-x86_64-pc-linux-gnu-glibc_2.17.tar.gz -C "${WRF_FOLDER}"/ -C "${WRF_FOLDER}"/
		cd "${WRF_FOLDER}"/
		mv "${WRF_FOLDER}"/opengrads-2.2.1.oga.1 "${WRF_FOLDER}"/GrADS
		cd GrADS/Contents
		wget -c https://github.com/regisgrundig/SIMOP/blob/master/g2ctl.pl
		chmod +x g2ctl.pl
		wget -c https://sourceforge.net/projects/opengrads/files/wgrib2/0.1.9.4/wgrib2-v0.1.9.4-bin-i686-glib2.5-linux-gnu.tar.gz
		LD_LIBRARY_PATH= tar -xvzf wgrib2-v0.1.9.4-bin-i686-glib2.5-linux-gnu.tar.gz
		cd wgrib2-v0.1.9.4/bin
		mv wgrib2 "${WRF_FOLDER}"/GrADS/Contents
		cd "${WRF_FOLDER}"/GrADS/Contents
		rm wgrib2-v0.1.9.4-bin-i686-glib2.5-linux-gnu.tar.gz
		rm -r wgrib2-v0.1.9.4

		export PATH="${WRF_FOLDER}"/GrADS/Contents:$PATH

		echo " "
	fi
	################################## GrADS ###############################
	# Version  2.2.1
	# Sublibs library instructions: http://cola.gmu.edu/grads/gadoc/supplibs2.html
	# GrADS instructions: http://cola.gmu.edu/grads/downloads.php
	########################################################################
	if [[ $GRADS_PICK -eq 2 ]]; then

		echo $PASSWD | sudo -S apt -y install grads

	fi

	##################### NCAR COMMAND LANGUAGE           ##################
	########### NCL compiled via Conda                    ##################
	########### This is the preferred method by NCAR      ##################
	########### https://www.ncl.ucar.edu/index.shtml      ##################
	#Installing Miniconda3 to WRF-Hydro directory and updating libraries

	echo $PASSWD | sudo -S apt -y install python3-zstandard python3-zstd

	export Miniconda_Install_DIR="${WRF_FOLDER}"/miniconda3

	mkdir -p $Miniconda_Install_DIR

	wget -c https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O $Miniconda_Install_DIR/miniconda.sh
	bash $Miniconda_Install_DIR/miniconda.sh -b -u -p $Miniconda_Install_DIR

	rm -rf $Miniconda_Install_DIR/miniconda.sh

	export PATH="${WRF_FOLDER}"/miniconda3/bin:$PATH

	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	$Miniconda_Install_DIR/bin/conda init bash

	conda tos accept
	conda config --add channels conda-forge
	conda config --set auto_activate_base false
	conda update -n root --all -y

	echo " "

	echo " "
	#Installing NCL via Conda
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	conda create -n ncl_stable -c conda-forge ncl -y
	conda activate ncl_stable

	conda deactivate
	conda deactivate
	conda deactivate

	echo " "

	############################OBSGRID###############################
	## OBSGRID
	## Downloaded from git tagged releases
	## Option #2
	########################################################################
	cd "${WRF_FOLDER}"/
	git clone https://github.com/wrf-model/OBSGRID.git
	cd "${WRF_FOLDER}"/OBSGRID

	LD_LIBRARY_PATH= ./clean -a
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh
	conda activate ncl_stable

	export HOME=$(
		cd
		pwd
	)
	export DIR="${WRF_FOLDER}"/Libs
	export NETCDF=$DIR/NETCDF

	if [ ${auto_config} -eq 1 ]; then
		echo 2 | ./configure 2>&1 | tee configure.log #Option 2 for gfortran/gcc and distribunted memory
	else
		./configure 2>&1 | tee configure.log #Option 2 for gfortran/gcc and distribunted memory
	fi

	sed -i '27s/-lnetcdf -lnetcdff/ -lnetcdff -lnetcdf/g' configure.oa

	sed -i '31s/-lncarg -lncarg_gks -lncarg_c -lX11 -lm -lcairo/-lncarg -lncarg_gks -lncarg_c -lX11 -lm -lcairo -lfontconfig -lpixman-1 -lfreetype -lhdf5 -lhdf5_hl /g' configure.oa

	sed -i '39s/-frecord-marker=4/-frecord-marker=4 ${fallow_argument} /g' configure.oa

	sed -i '44s/=	/=	${fallow_argument} /g' configure.oa

	sed -i '45s/-C -P -traditional/-P -traditional/g' configure.oa

	echo " "
	LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.obsgrid.log

	conda deactivate
	conda deactivate
	conda deactivate

	echo " "
	# IF statement to check that all files were created.
	if [[ -x ./obsgrid.exe ]]; then
		echo "obsgrid.exe found."
		read -r -t 5 -p "Finished installing OBSGRID. I am going to wait for 5 seconds only ..."
	else
		echo "obsgrid.exe is missing. Attempting to compile again..."

		LD_LIBRARY_PATH= ./clean -a
		LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.obsgrid.retry.log

		if [[ -x ./obsgrid.exe ]]; then
			echo "obsgrid.exe successfully created after recompilation."
			read -r -t 5 -p "Finished retrying OBSGRID compile. I am going to wait for 5 seconds only ..."
		else
			echo "Still missing obsgrid.exe after recompile. Exiting the script."
			read -r -p "Please contact script authors for assistance. Press 'Enter' to exit."
			exit 1
		fi
	fi

	echo " "

	##################### WRF Python           ##################
	########### WRf-Python compiled via Conda  ##################
	########### This is the preferred method by NCAR      ##################
	##### https://wrf-python.readthedocs.io/en/latest/installation.html  ##################
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh
	conda env create -f $HOME/WRF-MOSIT/wrf-python-stable.yml

	######################### Climate Data Operators ############
	######################### CDO compiled via Conda ###########
	####################### This is the preferred method #######
	################### https://bairdlangenbrunner.github.io/python-for-climate-scientists/conda/setting-up-conda-environments.html #######################

	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	conda create --name cdo_stable -y
	conda activate cdo_stable
	conda install -c conda-forge cdo -y
	conda update --all -y
	conda deactivate
	conda deactivate
	conda deactivate

	echo " "

	############################ WRF #################################
	## WRF v${WPS_VERSION}
	## Downloaded from git tagged releases
	# option 34, option 1 for gfortran and distributed memory w/basic nesting
	# large file support enable with WRFiO_NCD_LARGE_FILE_SUPPORT=1
	# In the namelist.input, the following settings support pNetCDF by setting value to 11:
	# io_form_boundary
	# io_form_history
	# io_form_auxinput2
	# io_form_auxhist2
	# Note that you need set nocolons = .true. in the section &time_control of namelist.input
	########################################################################
	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/wrf-model/WRF/releases/download/v${WRF_VERSION}/v${WRF_VERSION}.tar.gz -O WRF-${WRF_VERSION}.tar.gz
	LD_LIBRARY_PATH= tar -xvzf WRF-${WRF_VERSION}.tar.gz -C "${WRF_FOLDER}"/

	# If statment for changing folder name
	# Check if WRF directory exists
	if [ -d "${WRF_FOLDER}/WRF" ]; then
		mv -f "${WRF_FOLDER}/WRF" "${WRF_FOLDER}/WRF-${WRF_VERSION}"

	# Else, check for any folder matching WRFV*
	else
		for dir in "${WRF_FOLDER}"/WRFV*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WRF-${WRF_VERSION}"
				break
			fi
		done
	fi

	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}
	export WRFIO_NCD_LARGE_FILE_SUPPORT=1
	LD_LIBRARY_PATH= ./clean -a

	if [ ${auto_config} -eq 1 ]; then
		(
			echo 34
			echo 1
		) | ./configure

	else
		./configure 2>&1 | tee configure.log #Option 34 gfortran compiler with distributed memory option 1 for basic nesting
	fi

	LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN em_real 2>&1 | tee compile.wrf1.log

	export WRF_DIR="${WRF_FOLDER}"/WRF-${WRF_VERSION}

	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/main
	n=$(ls ./*.exe | wc -l)
	if (($n >= 3)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}
		LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN em_real 2>&1 | tee compile.wrf2.log
		cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/main
		n=$(ls ./*.exe | wc -l)
		if (($n >= 3)); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	echo " "
	############################WPS#####################################
	## WPS v${WPS_VERSION}
	## Downloaded from git tagged releases
	#Option 3 for gfortran and distributed memory
	########################################################################

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/wrf-model/WPS/archive/refs/tags/v${WPS_VERSION}.tar.gz -O WPS-${WPS_VERSION}.tar.gz
	LD_LIBRARY_PATH= tar -xvzf WPS-${WPS_VERSION}.tar.gz -C "${WRF_FOLDER}"/
	# Check if WPS directory exists
	if [ -d "${WRF_FOLDER}/WPS" ]; then
		mv -f "${WRF_FOLDER}/WPS" "${WRF_FOLDER}/WPS-${WPS_VERSION}"

	# Else, check for any folder matching WPSV* or WPS-*
	else
		for dir in "${WRF_FOLDER}"/WPSV* "${WRF_FOLDER}"/WPS-*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WPS-${WPS_VERSION}"
				break
			fi
		done
	fi
	cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
	LD_LIBRARY_PATH= ./clean -a

	if [ ${auto_config} -eq 1 ]; then
		echo 3 | ./configure 2>&1 | tee configure.log #Option 3 for gfortran and distributed memory
	else
		./configure 2>&1 | tee configure.log #Option 3 gfortran compiler with distributed memory
	fi
	LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.wps.log

	echo " "
	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
	n=$(ls ./*.exe | wc -l)
	if (($n == 3)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WPS. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.wps2.log
		cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
		n=$(ls ./*.exe | wc -l)
		if (($n == 3)); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WPS. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	echo " "
	############################WRFPLUS 4DVAR###############################
	## WRFPLUS v${WPS_VERSION} 4DVAR
	## Downloaded from git tagged releases
	## WRFPLUS is built within the WRF git folder
	## Does not include RTTOV Libarary for radiation data.  If wanted will need to install library then reconfigure
	##Note: if you intend to run both 3DVAR and 4DVAR experiments, it is not necessary to compile the code twice.
	#Option 18 for gfortran/gcc and distribunted memory
	########################################################################
	cd "${WRF_FOLDER}"/Downloads
	mkdir "${WRF_FOLDER}"/WRFPLUS
	LD_LIBRARY_PATH= tar -xvzf WRF-${WRF_VERSION}.tar.gz -C "${WRF_FOLDER}"/WRFPLUS

	# If statement for changing folder name inside WRFPLUS
	if [ -d "${WRF_FOLDER}/WRFPLUS/WRF" ]; then
		mv -f "${WRF_FOLDER}/WRFPLUS/WRF" "${WRF_FOLDER}/WRFPLUS/WRF-${WRF_VERSION}"

	else
		for dir in "${WRF_FOLDER}/WRFPLUS"/WRFV*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WRFPLUS/WRF-${WRF_VERSION}"
				break
			fi
		done
	fi

	cd "${WRF_FOLDER}"/WRFPLUS/WRF-${WRF_VERSION}
	mv * "${WRF_FOLDER}"/WRFPLUS
	cd "${WRF_FOLDER}"/WRFPLUS
	rm -rf WRF-${WRF_VERSION}/
	export NETCDF=$DIR/NETCDF
	export HDF5=$DIR/grib2
	LD_LIBRARY_PATH= ./clean -a

	if [ ${auto_config} -eq 1 ]; then
		echo 18 | ./configure wrfplus 2>&1 | tee configure.log #Option 18 for gfortran/gcc and distribunted memory
	else
		./configure wrfplus 2>&1 | tee configure.log #Option 18 for gfortran/gcc and distribunted memory
	fi
	echo " "
	LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN wrfplus 2>&1 | tee compile.wrfplus.log
	export WRFPLUS_DIR="${WRF_FOLDER}"/WRFPLUS

	echo " "

	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WRFPLUS/main
	n=$(ls ./wrfplus.exe | wc -l)
	if (($n == 1)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WRF Plus 4DVAR. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		cd "${WRF_FOLDER}"/WRFPLUS/
		LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN wrfplus 2>&1 | tee compile.wrfplus.log
		cd "${WRF_FOLDER}"/WRFPLUS/main
		n=$(ls ./wrfplus.exe | wc -l)
		if (($n == 1)); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WRF Plus 4DVAR. I am going to wait for 5 seconds only ..."
		else
			echo "Missing one or more expected files."
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	echo " "

	############################WRFDA 4DVAR###############################
	## WRFDA v${WPS_VERSION} 4DVAR
	## Downloaded from git tagged releases
	## WRFDA is built within the WRFPLUS folder
	## Does not include RTTOV Libarary for radiation data.  If wanted will need to install library then reconfigure
	##Note: if you intend to run both 3DVAR and 4DVAR experiments, it is not necessary to compile the code twice.
	#Option 18 for gfortran/gcc and distribunted memory
	########################################################################
	cd "${WRF_FOLDER}"/Downloads
	mkdir "${WRF_FOLDER}"/WRFDA
	LD_LIBRARY_PATH= tar -xvzf WRF-${WRF_VERSION}.tar.gz -C "${WRF_FOLDER}"/WRFDA

	# If statement for changing folder name inside WRFDA
	if [ -d "${WRF_FOLDER}/WRFDA/WRF" ]; then
		mv -f "${WRF_FOLDER}/WRFDA/WRF" "${WRF_FOLDER}/WRFDA/WRF-${WRF_VERSION}"

	else
		for dir in "${WRF_FOLDER}/WRFDA"/WRFV*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WRFDA/WRF-${WRF_VERSION}"
				break
			fi
		done
	fi

	cd "${WRF_FOLDER}"/WRFDA/WRF-${WRF_VERSION}
	mv * "${WRF_FOLDER}"/WRFDA
	cd "${WRF_FOLDER}"/WRFDA
	rm -rf WRF-${WRF_VERSION}/
	export NETCDF=$DIR/NETCDF
	export HDF5=$DIR/grib2
	export WRFPLUS_DIR="${WRF_FOLDER}"/WRFPLUS
	LD_LIBRARY_PATH= ./clean -a

	if [ ${auto_config} -eq 1 ]; then
		echo 18 | ./configure 4dvar 2>&1 | tee configure.log #Option 18 for gfortran/gcc and distribunted memory
	else
		./configure 4dvar 2>&1 | tee configure.log #Option 18 for gfortran/gcc and distribunted memory
	fi
	echo " "
	LD_LIBRARY_PATH= ./compile -j 2 all_wrfvar 2>&1 | tee compile.wrf4dvar.log
	echo " "

	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WRFDA/var/da
	n=$(ls ./*.exe | wc -l)
	cd "${WRF_FOLDER}"/WRFDA/var/obsproc/src
	m=$(ls ./*.exe | wc -l)
	if ((($n == 43) && ($m == 1))); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WRFDA. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		cd "${WRF_FOLDER}"/WRFDA
		LD_LIBRARY_PATH= ./compile -j 2 all_wrfvar 2>&1 | tee compile.chem.wrfvar2.log
		cd "${WRF_FOLDER}"/WRFDA/var/da
		n=$(ls ./*.exe | wc -l)
		cd "${WRF_FOLDER}"/WRFDA/var/obsproc/src
		m=$(ls ./*.exe | wc -l)
		if ((($n == 43) && ($m == 1))); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WRFDA. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi
	echo " "

	######################## Static Geography Data inc/ Optional ####################
	# http://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html
	# These files are large so if you only need certain ones comment the others off
	# All files downloaded and untarred is 200GB
	# https://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html
	#################################################################################
	cd "${WRF_FOLDER}"/Downloads
	mkdir "${WRF_FOLDER}"/GEOG
	mkdir "${WRF_FOLDER}"/GEOG/WPS_GEOG

	echo " "
	echo "Mandatory WRF Preprocessing System (WPS) Geographical Input Data Mandatory Fields Downloads"
	echo " "
	wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_high_res_mandatory.tar.gz
	LD_LIBRARY_PATH= tar -xvzf geog_high_res_mandatory.tar.gz -C "${WRF_FOLDER}"/GEOG/

	wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_low_res_mandatory.tar.gz
	LD_LIBRARY_PATH= tar -xvzf geog_low_res_mandatory.tar.gz -C "${WRF_FOLDER}"/GEOG/
	mv "${WRF_FOLDER}"/GEOG/WPS_GEOG_LOW_RES/ "${WRF_FOLDER}"/GEOG/WPS_GEOG

	if [ ${WPS_Specific_Applications} -eq 1 ]; then
		echo " "
		echo " WPS Geographical Input Data Mandatory for Specific Applications"
		echo " "

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_thompson28_chem.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_thompson28_chem.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_noahmp.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_noahmp.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/irrigation.tar.gz
		LD_LIBRARY_PATH= tar -xvzf irrigation.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_px.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_px.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_urban.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_urban.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_ssib.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_ssib.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/lake_depth.tar.bz2
		LD_LIBRARY_PATH= tar -xvf lake_depth.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/topobath_30s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf topobath_30s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/gsl_gwd.tar.bz2
		LD_LIBRARY_PATH= tar -xvf gsl_gwd.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/cglc_modis_lcz_global.tar.gz
		LD_LIBRARY_PATH= tar -xvf cglc_modis_lcz_global.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG
	fi

	if [ ${Optional_GEOG} -eq 1 ]; then
		echo " "
		echo "Optional WPS Geographical Input Data"
		echo " "

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_older_than_2000.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_older_than_2000.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/modis_landuse_20class_15s_with_lakes.tar.gz
		LD_LIBRARY_PATH= tar -xvzf modis_landuse_20class_15s_with_lakes.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_alt_lsm.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_alt_lsm.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/nlcd2006_ll_9s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf nlcd2006_ll_9s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/updated_Iceland_LU.tar.gz
		LD_LIBRARY_PATH= tar -xvf updated_Iceland_LU.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/modis_landuse_20class_15s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf modis_landuse_20class_15s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

	fi

fi

if [ "$Ubuntu_64bit_Intel" = "1" ] && [ "$WRF_PICK" = "1" ]; then

	############################# Basic package managment ############################

	echo $PASSWD | sudo -S apt -y update
	echo $PASSWD | sudo -S apt -y upgrade

	# download the key to system keyring; this and the following echo command are
	# needed in order to install the Intel compilers
	wget -O- https://apt.repos.intel.com/intel-gpg-keys/GPG-PUB-KEY-INTEL-SW-PRODUCTS.PUB |
		gpg --dearmor | sudo tee /usr/share/keyrings/oneapi-archive-keyring.gpg >/dev/null

	# add signed entry to apt sources and configure the APT client to use Intel repository:
	echo "deb [signed-by=/usr/share/keyrings/oneapi-archive-keyring.gpg] https://apt.repos.intel.com/oneapi all main" | sudo tee /etc/apt/sources.list.d/oneAPI.list

	# this update should get the Intel package info from the Intel repository
	echo $PASSWD | sudo -S apt -y update

	release_version=$(lsb_release -r -s)

	# Compare the release version
	if [ "$release_version" = "24.04" ]; then
		# Install Emacs without recommended packages
		echo $PASSWD | sudo -S apt install emacs --no-install-recommends -y
	else
		# Attempt to install Emacs if the release version is not 24.04
		echo "The release version is not 24.04, attempting to install Emacs."
		echo $PASSWD | sudo -S apt install emacs -y
	fi

	echo $PASSWD | sudo -S apt -y install bison build-essential byacc cmake csh curl default-jdk default-jre flex libfl-dev g++ gawk gcc gettext gfortran git ksh libcurl4-gnutls-dev libjpeg-dev libncurses6 libpixman-1-dev libpng-dev libtool libxml2 libxml2-dev libxml-libxml-perl m4 make ncview pipenv pkg-config python3 python3-dev python3-pip python3-dateutil tcsh unzip xauth xorg time

	# install the Intel compilers
	echo $PASSWD | sudo -S apt -y install intel-basekit
	echo $PASSWD | sudo -S apt -y install intel-hpckit
	echo $PASSWD | sudo -S apt -y install intel-oneapi-python
	/opt/intel/oneapi/intelpython/python3.12/bin/python3 -m pip install python-dateutil

	echo $PASSWD | sudo -S apt -y update

	#Fix any broken installations
	echo $PASSWD | sudo -S apt --fix-broken install

	# make sure some critical packages have been installed
	which cmake pkg-config make gcc g++ gfortran

	# add the Intel compiler file paths to various environment variables
	source /opt/intel/oneapi/setvars.sh --force

	# some of the libraries we install below need one or more of these variables

	export CC=icx
	export CXX=icpx
	export FC=ifx
	export F77=ifx
	export F90=ifx
	export MPIFC=mpiifx
	export MPIF77=mpiifx
	export MPIF90=mpiifx
	export MPICC=mpiicx
	export MPICXX=mpiicpx
	export CFLAGS="-fPIC -fPIE -O3 -Wno-implicit-function-declaration -Wno-incompatible-function-pointer-types -Wno-unused-command-line-argument"
	export FFLAGS="-m64"
	export FCFLAGS="-m64"
	############################# CPU Core Management ####################################

	export CPU_CORE=$(nproc) # number of available threads on system
	export CPU_6CORE="6"
	export CPU_QUARTER=$(($CPU_CORE / 4)) # quarter of availble cores on system
	# Forces CPU cores to even number to avoid partial core export. ie 7 cores would be 3.5 cores.
	export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))

	# If statement for low core systems.  Forces computers to only use 1 core if there are 4 cores or less on the system.
	if [ $CPU_CORE -le $CPU_6CORE ]; then
		export CPU_QUARTER_EVEN="2"
	else
		export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))
	fi

	echo "##########################################"
	echo "Number of Threads being used $CPU_QUARTER_EVEN"
	echo "##########################################"

	############################## Directory Listing ############################
	# makes necessary directories
	#
	############################################################################

	export HOME=$(
		cd
		pwd
	)
	export WRF_FOLDER=$HOME/WRF_Intel
	export DIR="${WRF_FOLDER}"/Libs
	mkdir "${WRF_FOLDER}"
	cd "${WRF_FOLDER}"
	mkdir Downloads

	mkdir Libs
	mkdir Libs/grib2
	mkdir Libs/NETCDF
	mkdir Libs/MPICH
	mkdir -p Tests/Environment
	mkdir -p Tests/Compatibility

	echo " "
	############################## Downloading Libraries ############################

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/madler/zlib/releases/download/v$Zlib_Version/zlib-$Zlib_Version.tar.gz
	wget -c https://github.com/HDFGroup/hdf5/releases/download/hdf5_$HDF5_Version/hdf5-$HDF5_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-c/archive/refs/tags/v$Netcdf_C_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-fortran/archive/refs/tags/v$Netcdf_Fortran_Version.tar.gz
	wget -c https://download.sourceforge.net/libpng/libpng-$Libpng_Version.tar.gz
	wget -c https://www.ece.uvic.ca/~frodo/jasper/software/jasper-$Jasper_Version.zip
	wget -c https://parallel-netcdf.github.io/Release/pnetcdf-$Pnetcdf_Version.tar.gz

	echo " "
	############################# ZLib ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf zlib-$Zlib_Version.tar.gz
	cd zlib-$Zlib_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	export ZLIB_ROOT=$DIR/grib2
	export ZLIBLIB=$DIR/grib2/lib
	export ZLIBINC=$DIR/grib2/include

	echo " "
	############################# LibPNG ############################

	cd "${WRF_FOLDER}"/Downloads

	# other libraries below need these variables to be set
	export LDFLAGS=-L$DIR/grib2/lib
	export CPPFLAGS=-I$DIR/grib2/include

	LD_LIBRARY_PATH= tar -xvzf libpng-$Libpng_Version.tar.gz
	cd libpng-$Libpng_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNG_ROOT=$DIR/grib2

	echo " "
	############################# JasPer ############################

	cd "${WRF_FOLDER}"/Downloads
	unzip jasper-$Jasper_Version.zip
	cd jasper-$Jasper_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	# other libraries below need these variables to be set
	export JASPERLIB=$DIR/grib2/lib
	export JASPERINC=$DIR/grib2/include
	export JASPER_DIR=$DIR/grib2
	export Jasper_ROOT=$DIR/grib2/lib

	echo " "
	############################# HDF5 library for NetCDF4 & parallel functionality ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf hdf5-$HDF5_Version.tar.gz
	cd hdf5-$HDF5_Version

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --with-zlib=$DIR/grib2 --enable-hl --enable-fortran --enable-parallel 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	# other libraries below need these variables to be set
	export HDF5=$DIR/grib2
	export PATH=$HDF5/bin:$PATH
	export PHDF5=$DIR/grib2
	export HDF5_ROOT=$DIR/grib2
	export PHDF5_ROOT=$DIR/grib2

	echo " "

	############################# Install Parallel-netCDF ##############################
	#Make file created with half of available cpu cores
	#Hard path for MPI added
	##################################################################################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf pnetcdf-$Pnetcdf_Version.tar.gz
	cd pnetcdf-$Pnetcdf_Version
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --enable-static 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNETCDF=$DIR/grib2
	export PNETCDF_DIR=$DIR/grib2
	export PNETCDF_ROOT=$DIR/grib2

	echo " "

	############################## Install NETCDF-C Library ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_C_Version.tar.gz
	cd netcdf-c-$Netcdf_C_Version/

	# these variables need to be set for the NetCDF-C install to work
	export CPPFLAGS=-I$DIR/grib2/include
	export LDFLAGS="-L$DIR/grib2/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lhdf5_hl -lhdf5 -lz -lcurl -lgcc -lm -ldl -lpnetcdf"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --disable-dap --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-pnetcdf --enable-cdf5 --enable-parallel-tests --enable-logging 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	# other libraries below need these variables to be set
	export PATH=$DIR/NETCDF/bin:$PATH
	export NETCDF=$DIR/NETCDF
	export NETCDF_INC=$DIR/NETCDF/include
	export NETCDF_LIB=$DIR/NETCDF/lib
	export NETCDF_ROOT=$DIR/NETCDF
	export LD_LIBRARY_PATH=$DIR/grib2/lib:$DIR/NETCDF/lib:$LD_LIBRARY_PATH

	echo " "
	############################## NetCDF-Fortran library ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_Fortran_Version.tar.gz
	cd netcdf-fortran-$Netcdf_Fortran_Version/

	# these variables need to be set for the NetCDF-Fortran install to work
	export LD_LIBRARY_PATH=$DIR/NETCDF/lib:$LD_LIBRARY_PATH
	export CPPFLAGS="-I$DIR/NETCDF/include -I$DIR/grib2/include"
	export LDFLAGS="-L$DIR/NETCDF/lib -L$DIR/grib2/lib -Wl,-rpath,$DIR/NETCDF/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lnetcdf -lpnetcdf -lcurl -lhdf5_hl -lhdf5 -lz -lm -ldl -lgcc"
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --enable-netcdf-4 --enable-netcdf4 --enable-parallel-tests --enable-logging --enable-hdf5 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	echo " "
	#################################### System Environment Tests ##############

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_NETCDF_MPI_tests.tar
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_tests.tar

	LD_LIBRARY_PATH= tar -xvf Fortran_C_tests.tar -C "${WRF_FOLDER}"/Tests/Environment
	LD_LIBRARY_PATH= tar -xvf Fortran_C_NETCDF_MPI_tests.tar -C "${WRF_FOLDER}"/Tests/Compatibility

	export one="1"
	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Environment

	echo " "
	echo " "
	echo "Environment Testing "
	echo "Test 1"
	$FC TEST_1_fortran_only_fixed.f
	./a.out | tee env_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 1 Passed"
	else
		echo "Environment Compiler Test 1 Failed"
		exit
	fi
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 2"
	$FC TEST_2_fortran_only_free.f90
	./a.out | tee env_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 2 Passed"
	else
		echo "Environment Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 3"
	$CC TEST_3_c_only.c
	./a.out | tee env_test3.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test3.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 3 Passed"
	else
		echo "Environment Compiler Test 3 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 4"
	$CC -c -m64 TEST_4_fortran+c_c.c
	$FC -c -m64 TEST_4_fortran+c_f.f90
	$FC -m64 TEST_4_fortran+c_f.o TEST_4_fortran+c_c.o
	./a.out | tee env_test4.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test4.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 4 Passed"
	else
		echo "Environment Compiler Test 4 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Compatibility

	cp ${NETCDF}/include/netcdf.inc .

	echo " "
	echo " "
	echo "Library Compatibility Tests "
	echo "Test 1"
	$FC -c 01_fortran+c+netcdf_f.f
	$CC -c 01_fortran+c+netcdf_c.c
	$FC 01_fortran+c+netcdf_f.o 01_fortran+c+netcdf_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	./a.out | tee comp_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 1 Passed"
	else
		echo "Compatibility Compiler Test 1 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "

	echo "Test 2"
	$MPIFC -c 02_fortran+c+netcdf+mpi_f.f
	$MPICC -c 02_fortran+c+netcdf+mpi_c.c
	$MPIFC 02_fortran+c+netcdf+mpi_f.o \
		02_fortran+c+netcdf+mpi_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	mpirun ./a.out | tee comp_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 2 Passed"
	else
		echo "Compatibility Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."
	echo " "

	echo " All tests completed and passed"
	echo " "

	################################OpenGrADS######################################
	#Verison 2.2.1 64bit of Linux
	#############################################################################
	if [[ $GRADS_PICK -eq 1 ]]; then
		cd "${WRF_FOLDER}"/Downloads
		LD_LIBRARY_PATH= tar -xvzf cd "${WRF_FOLDER}"/Downloads
		wget -c https://sourceforge.net/projects/opengrads/files/grads2/2.2.1.oga.1/Linux%20%2864%20Bits%29/opengrads-2.2.1.oga.1-bundle-x86_64-pc-linux-gnu-glibc_2.17.tar.gz
		LD_LIBRARY_PATH= tar -xvzf opengrads-2.2.1.oga.1-bundle-x86_64-pc-linux-gnu-glibc_2.17.tar.gz -C "${WRF_FOLDER}"/ -C "${WRF_FOLDER}"/
		cd "${WRF_FOLDER}"/
		mv "${WRF_FOLDER}"/opengrads-2.2.1.oga.1 "${WRF_FOLDER}"/GrADS
		cd GrADS/Contents
		wget -c https://github.com/regisgrundig/SIMOP/blob/master/g2ctl.pl
		chmod +x g2ctl.pl
		wget -c https://sourceforge.net/projects/opengrads/files/wgrib2/0.1.9.4/wgrib2-v0.1.9.4-bin-x86_64-glibc2.5-linux-gnu.tar.gz
		LD_LIBRARY_PATH= tar -xvzf wgrib2-v0.1.9.4-bin-x86_64-glibc2.5-linux-gnu.tar.gz
		cd wgrib2-v0.1.9.4/bin
		mv wgrib2 "${WRF_FOLDER}"/GrADS/Contents
		cd "${WRF_FOLDER}"/GrADS/Contents
		rm wgrib2-v0.1.9.4-bin-x86_64-glibc2.5-linux-gnu.tar.gz
		rm -r wgrib2-v0.1.9.4

		export PATH="${WRF_FOLDER}"/GrADS/Contents:$PATH
	fi
	################################## GrADS ###############################
	# Version  2.2.1
	# Sublibs library instructions: http://cola.gmu.edu/grads/gadoc/supplibs2.html
	# GrADS instructions: http://cola.gmu.edu/grads/downloads.php
	########################################################################
	if [[ $GRADS_PICK -eq 2 ]]; then

		echo $PASSWD | sudo -S apt -y install grads

	fi

	##################### NCAR COMMAND LANGUAGE           ##################
	########### NCL compiled via Conda                    ##################
	########### This is the preferred method by NCAR      ##################
	########### https://www.ncl.ucar.edu/index.shtml      ##################
	echo " "
	echo " "
	#Installing Miniconda3 to WRF directory and updating libraries

	echo $PASSWD | sudo -S apt -y install python3-zstandard python3-zstd

	export Miniconda_Install_DIR="${WRF_FOLDER}"/miniconda3

	mkdir -p $Miniconda_Install_DIR

	wget -c https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O $Miniconda_Install_DIR/miniconda.sh
	bash $Miniconda_Install_DIR/miniconda.sh -b -u -p $Miniconda_Install_DIR

	rm -rf $Miniconda_Install_DIR/miniconda.sh

	export PATH="${WRF_FOLDER}"/miniconda3/bin:$PATH

	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	$Miniconda_Install_DIR/bin/conda init bash

	conda tos accept
	conda config --add channels conda-forge
	conda config --set auto_activate_base false
	conda update -n root --all -y

	#Special Thanks to @_WaylonWalker for code development
	echo " "
	#Installing NCL via Conda
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	conda create -n ncl_stable -c conda-forge ncl -y
	conda activate ncl_stable

	conda deactivate
	conda deactivate
	conda deactivate

	echo " "

	############################OBSGRID###############################
	## OBSGRID
	## Downloaded from git tagged releases
	## Option #3
	########################################################################
	cd "${WRF_FOLDER}"/
	git clone https://github.com/wrf-model/OBSGRID.git
	cd "${WRF_FOLDER}"/OBSGRID

	LD_LIBRARY_PATH= ./clean -a
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh
	conda activate ncl_stable

	export HOME=$(
		cd
		pwd
	)
	export DIR="${WRF_FOLDER}"/Libs
	export NETCDF=$DIR/NETCDF

	if [ ${auto_config} -eq 1 ]; then
		echo 3 | ./configure 2>&1 | tee configure.log #Option 3 for itnel and distribunted memory
	else
		./configure 2>&1 | tee configure.log #Option 3 for intel and distribunted memory
	fi

	sed -i '27s/-lnetcdf -lnetcdff/ -lnetcdff -lnetcdf/g' configure.oa

	sed -i '31s/-lncarg -lncarg_gks -lncarg_c -lX11 -lm -lcairo/-lncarg -lncarg_gks -lncarg_c -lX11 -lm -lcairo -lfontconfig -lpixman-1 -lfreetype -lhdf5 -lhdf5_hl /g' configure.oa

	sed -i '38s/ifort/ifx/g' configure.oa
	sed -i '43s/gcc/icx/g' configure.oa
	sed -i '45s|/lib/cpp|ifx|g' configure.oa
	sed -i '46s|-I. -C -P -DDEC -traditional|-fpp -DDEC -I.|g' configure.oa

	# Patch .F90.o rule to use direct compile with Intel Fortran + fpp
	sed -i '/^\.F90\.o:/,/^\t\$(RM) \$\*\.f/ c\.F90.o:\n\t$(RM) $@ $*.mod\n\t$(FC) $(FFLAGS) -fpp $(CPPFLAGS) ${NETCDF_INC} -c $<' configure.oa

	echo " "
	LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.obsgrid.log

	conda deactivate
	conda deactivate
	conda deactivate

	echo " "
	# IF statement to check that all files were created.
	if [[ -x ./obsgrid.exe ]]; then
		echo "obsgrid.exe found."
		read -r -t 5 -p "Finished installing OBSGRID. I am going to wait for 5 seconds only ..."
	else
		echo "obsgrid.exe is missing. Attempting to compile again..."

		LD_LIBRARY_PATH= ./clean -a
		LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.obsgrid.retry.log

		if [[ -x ./obsgrid.exe ]]; then
			echo "obsgrid.exe successfully created after recompilation."
			read -r -t 5 -p "Finished retrying OBSGRID compile. I am going to wait for 5 seconds only ..."
		else
			echo "Still missing obsgrid.exe after recompile. Exiting the script."
			read -r -p "Please contact script authors for assistance. Press 'Enter' to exit."
			exit 1
		fi
	fi

	echo " "

	##################### WRF Python           ##################
	########### WRf-Python compiled via Conda  ##################
	########### This is the preferred method by NCAR      ##################
	##### https://wrf-python.readthedocs.io/en/latest/installation.html  ##################
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh
	conda env create -f $HOME/WRF-MOSIT/wrf-python-stable.yml

	######################### Climate Data Operators ############
	######################### CDO compiled via Conda ###########
	####################### This is the preferred method #######
	################### https://bairdlangenbrunner.github.io/python-for-climate-scientists/conda/setting-up-conda-environments.html #######################

	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	conda create --name cdo_stable -y
	conda activate cdo_stable
	conda install -c conda-forge cdo -y
	conda update --all -y
	conda deactivate
	conda deactivate
	conda deactivate

	echo " "

	############################ WRF #################################
	## WRF v${WPS_VERSION}
	## Downloaded from git tagged releases
	# option 78, option 1 for intel and distributed memory w/basic nesting
	# large file support enable with WRFiO_NCD_LARGE_FILE_SUPPORT=1
	########################################################################

	source /opt/intel/oneapi/setvars.sh --force

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/wrf-model/WRF/releases/download/v${WRF_VERSION}/v${WRF_VERSION}.tar.gz -O WRF-${WRF_VERSION}.tar.gz
	LD_LIBRARY_PATH= tar -xvzf WRF-${WRF_VERSION}.tar.gz -C "${WRF_FOLDER}"/

	# If statment for changing folder name
	# Check if WRF directory exists
	if [ -d "${WRF_FOLDER}/WRF" ]; then
		mv -f "${WRF_FOLDER}/WRF" "${WRF_FOLDER}/WRF-${WRF_VERSION}"

	# Else, check for any folder matching WRFV*
	else
		for dir in "${WRF_FOLDER}"/WRFV*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WRF-${WRF_VERSION}"
				break
			fi
		done
	fi

	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}
	export WRFIO_NCD_LARGE_FILE_SUPPORT=1
	LD_LIBRARY_PATH= ./clean -a

	if [ ${auto_config} -eq 1 ]; then
		(
			echo 78
			echo 1
		) | ./configure

	else
		./configure 2>&1 | tee configure.log #option 78 intel compiler with distributed memory option 1 for basic nesting
	fi

	#Need to remove mpich/GNU config calls to Intel config calls
	sed -i '136s|mpif90 -f90=$(SFC)|mpiifx|g' "${WRF_FOLDER}"/WRF-${WRF_VERSION}/configure.wrf
	sed -i '137s|mpicc -cc=$(SCC)|mpiicx|g' "${WRF_FOLDER}"/WRF-${WRF_VERSION}/configure.wrf

	LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN em_real 2>&1 | tee compile.wrf1.log

	export WRF_DIR="${WRF_FOLDER}"/WRF-${WRF_VERSION}

	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/main
	n=$(ls ./*.exe | wc -l)
	if (($n >= 3)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}
		LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN em_real 2>&1 | tee compile.wrf2.log
		cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/main
		n=$(ls ./*.exe | wc -l)
		if (($n >= 3)); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	echo " "
	############################WPS#####################################
	## WPS v${WPS_VERSION}
	## Downloaded from git tagged releases
	#Option 19 for gfortran and distributed memory
	########################################################################

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/wrf-model/WPS/archive/refs/tags/v${WPS_VERSION}.tar.gz -O WPS-${WPS_VERSION}.tar.gz
	LD_LIBRARY_PATH= tar -xvzf WPS-${WPS_VERSION}.tar.gz -C "${WRF_FOLDER}"/
	# Check if WPS directory exists
	if [ -d "${WRF_FOLDER}/WPS" ]; then
		mv -f "${WRF_FOLDER}/WPS" "${WRF_FOLDER}/WPS-${WPS_VERSION}"

	# Else, check for any folder matching WPSV* or WPS-*
	else
		for dir in "${WRF_FOLDER}"/WPSV* "${WRF_FOLDER}"/WPS-*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WPS-${WPS_VERSION}"
				break
			fi
		done
	fi
	cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
	LD_LIBRARY_PATH= ./clean -a

	sed -i '77s|real ::|integer ::|g' "${WRF_FOLDER}"/WPS-${WPS_VERSION}/ungrib/src/rd_grib2.F

	if [ ${auto_config} -eq 1 ]; then
		echo 19 | ./configure 2>&1 | tee configure.log #Option 19 for intel and distributed memory
	else
		./configure 2>&1 | tee configure.log #Option 19 intel compiler with distributed memory
	fi

	sed -i '67s|mpif90|mpiifx|g' "${WRF_FOLDER}"/WPS-${WPS_VERSION}/configure.wps
	sed -i '68s|mpicc|mpiicx|g' "${WRF_FOLDER}"/WPS-${WPS_VERSION}/configure.wps

	LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.wps.log

	echo " "
	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
	n=$(ls ./*.exe | wc -l)
	if (($n == 3)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WPS. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.wps2.log
		cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
		n=$(ls ./*.exe | wc -l)
		if (($n == 3)); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WPS. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	echo " "
	############################WRFPLUS 4DVAR###############################
	## WRFPLUS v${WPS_VERSION} 4DVAR
	## Downloaded from git tagged releases
	## WRFPLUS is built within the WRF git folder
	## Does not include RTTOV Libarary for radiation data.  If wanted will need to install library then reconfigure
	##Note: if you intend to run both 3DVAR and 4DVAR experiments, it is not necessary to compile the code twice.
	#Option 40 for intel and distribunted memory
	########################################################################
	cd "${WRF_FOLDER}"/Downloads
	mkdir "${WRF_FOLDER}"/WRFPLUS
	LD_LIBRARY_PATH= tar -xvzf WRF-${WRF_VERSION}.tar.gz -C "${WRF_FOLDER}"/WRFPLUS

	# If statement for changing folder name inside WRFPLUS
	if [ -d "${WRF_FOLDER}/WRFPLUS/WRF" ]; then
		mv -f "${WRF_FOLDER}/WRFPLUS/WRF" "${WRF_FOLDER}/WRFPLUS/WRF-${WRF_VERSION}"

	else
		for dir in "${WRF_FOLDER}/WRFPLUS"/WRFV*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WRFPLUS/WRF-${WRF_VERSION}"
				break
			fi
		done
	fi

	cd "${WRF_FOLDER}"/WRFPLUS/WRF-${WRF_VERSION}
	mv * "${WRF_FOLDER}"/WRFPLUS
	cd "${WRF_FOLDER}"/WRFPLUS
	rm -rf WRF-${WRF_VERSION}/
	export NETCDF=$DIR/NETCDF
	export HDF5=$DIR/grib2
	LD_LIBRARY_PATH= ./clean -a

	if [ ${auto_config} -eq 1 ]; then
		echo 40 | ./configure wrfplus 2>&1 | tee configure.log #Option 40 for intel and distribunted memory
	else
		./configure wrfplus 2>&1 | tee configure.log #Option 40 for intel and distribunted memory
	fi
	echo " "

	sed -i '136s|mpif90 -f90=$(SFC)|mpiifx|g' "${WRF_FOLDER}"/WRFPLUS/configure.wrf
	sed -i '137s|mpicc -cc=$(SCC)|mpiicx|g' "${WRF_FOLDER}"/WRFPLUS/configure.wrf

	LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN wrfplus 2>&1 | tee wrfplus1.compile.log

	export WRFPLUS_DIR="${WRF_FOLDER}"/WRFPLUS

	echo " "

	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WRFPLUS/main
	n=$(ls ./wrfplus.exe | wc -l)
	if (($n == 1)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WRF Plus 4DVAR. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		cd "${WRF_FOLDER}"/WRFPLUS/
		LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN wrfplus 2>&1 | tee compile.wrfplus2.log
		cd "${WRF_FOLDER}"/WRFPLUS/main
		n=$(ls ./wrfplus.exe | wc -l)
		if (($n == 1)); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WRF Plus 4DVAR. I am going to wait for 5 seconds only ..."
		else
			echo "Missing one or more expected files."
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	echo " "

	############################WRFDA 4DVAR###############################
	## WRFDA v${WPS_VERSION} 4DVAR
	## Downloaded from git tagged releases
	## WRFDA is built within the WRFPLUS folder
	## Does not include RTTOV Libarary for radiation data.  If wanted will need to install library then reconfigure
	##Note: if you intend to run both 3DVAR and 4DVAR experiments, it is not necessary to compile the code twice.
	#Option 40 for intel and distribunted memory
	########################################################################
	cd "${WRF_FOLDER}"/Downloads
	mkdir "${WRF_FOLDER}"/WRFDA
	LD_LIBRARY_PATH= tar -xvzf WRF-${WRF_VERSION}.tar.gz -C "${WRF_FOLDER}"/WRFDA

	# If statement for changing folder name inside WRFDA
	if [ -d "${WRF_FOLDER}/WRFDA/WRF" ]; then
		mv -f "${WRF_FOLDER}/WRFDA/WRF" "${WRF_FOLDER}/WRFDA/WRF-${WRF_VERSION}"

	else
		for dir in "${WRF_FOLDER}/WRFDA"/WRFV*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WRFDA/WRF-${WRF_VERSION}"
				break
			fi
		done
	fi

	cd "${WRF_FOLDER}"/WRFDA/WRF-${WRF_VERSION}
	mv * "${WRF_FOLDER}"/WRFDA
	cd "${WRF_FOLDER}"/WRFDA
	rm -rf WRF-${WRF_VERSION}/
	export NETCDF=$DIR/NETCDF
	export HDF5=$DIR/grib2
	export WRFPLUS_DIR="${WRF_FOLDER}"/WRFPLUS
	LD_LIBRARY_PATH= ./clean -a

	if [ ${auto_config} -eq 1 ]; then
		echo 40 | ./configure 4dvar 2>&1 | tee configure.log #Option 40 for intel and distribunted memory
	else
		./configure 4dvar 2>&1 | tee configure.log #Option 40 for intel and distribunted memory
	fi
	echo " "

	sed -i '136s|mpif90 -f90=$(SFC)|mpiifx|g' "${WRF_FOLDER}"/WRFDA/configure.wrf
	sed -i '137s|mpicc -cc=$(SCC)|mpiicx|g' "${WRF_FOLDER}"/WRFDA/configure.wrf

	LD_LIBRARY_PATH= ./compile -j 2 all_wrfvar 2>&1 | tee wrfda.compile.log
	echo " "

	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WRFDA/var/da
	n=$(ls ./*.exe | wc -l)
	cd "${WRF_FOLDER}"/WRFDA/var/obsproc/src
	m=$(ls ./*.exe | wc -l)
	if ((($n == 43) && ($m == 1))); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WRFDA-4DVAR. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		cd "${WRF_FOLDER}"/WRFDA
		LD_LIBRARY_PATH= ./compile -j 2 all_wrfvar 2>&1 | tee compile.chem.wrfvar2.log
		cd "${WRF_FOLDER}"/WRFDA/var/da
		n=$(ls ./*.exe | wc -l)
		cd "${WRF_FOLDER}"/WRFDA/var/obsproc/src
		m=$(ls ./*.exe | wc -l)
		if ((($n == 43) && ($m == 1))); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WRFDA. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi
	echo " "

	######################## Static Geography Data inc/ Optional ####################
	# http://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html
	# These files are large so if you only need certain ones comment the others off
	# All files downloaded and untarred is 200GB
	# https://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html
	#################################################################################
	cd "${WRF_FOLDER}"/Downloads
	mkdir "${WRF_FOLDER}"/GEOG
	mkdir "${WRF_FOLDER}"/GEOG/WPS_GEOG

	echo " "
	echo "Mandatory WRF Preprocessing System (WPS) Geographical Input Data Mandatory Fields Downloads"
	echo " "
	wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_high_res_mandatory.tar.gz
	LD_LIBRARY_PATH= tar -xvzf geog_high_res_mandatory.tar.gz -C "${WRF_FOLDER}"/GEOG/

	wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_low_res_mandatory.tar.gz
	LD_LIBRARY_PATH= tar -xvzf geog_low_res_mandatory.tar.gz -C "${WRF_FOLDER}"/GEOG/
	mv "${WRF_FOLDER}"/GEOG/WPS_GEOG_LOW_RES/ "${WRF_FOLDER}"/GEOG/WPS_GEOG

	if [ ${WPS_Specific_Applications} -eq 1 ]; then
		echo " "
		echo " WPS Geographical Input Data Mandatory for Specific Applications"
		echo " "

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_thompson28_chem.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_thompson28_chem.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_noahmp.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_noahmp.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/irrigation.tar.gz
		LD_LIBRARY_PATH= tar -xvzf irrigation.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_px.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_px.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_urban.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_urban.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_ssib.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_ssib.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/lake_depth.tar.bz2
		LD_LIBRARY_PATH= tar -xvf lake_depth.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/topobath_30s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf topobath_30s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/gsl_gwd.tar.bz2
		LD_LIBRARY_PATH= tar -xvf gsl_gwd.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/cglc_modis_lcz_global.tar.gz
		LD_LIBRARY_PATH= tar -xvf cglc_modis_lcz_global.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG
	fi

	if [ ${Optional_GEOG} -eq 1 ]; then
		echo " "
		echo "Optional WPS Geographical Input Data"
		echo " "

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_older_than_2000.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_older_than_2000.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/modis_landuse_20class_15s_with_lakes.tar.gz
		LD_LIBRARY_PATH= tar -xvzf modis_landuse_20class_15s_with_lakes.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_alt_lsm.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_alt_lsm.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/nlcd2006_ll_9s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf nlcd2006_ll_9s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/updated_Iceland_LU.tar.gz
		LD_LIBRARY_PATH= tar -xvf updated_Iceland_LU.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/modis_landuse_20class_15s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf modis_landuse_20class_15s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG
	fi

fi

if [ "$macos_64bit_GNU" = "1" ] && [ "$WRF_PICK" = "1" ] && [ "$MAC_CHIP" = "Intel" ]; then

	#############################basic package managment############################
	brew cleanup -s
	brew update
	outdated_packages=$(brew outdated --quiet)

	# List of packages to check/install
	packages=(
		"autoconf" "automake" "bison" "byacc" "cmake" "curl" "flex" "gcc"
		"gedit" "git" "gnu-sed" "ksh"
		"libtool" "libxml2" "m4" "make" "python@3.12" "tcsh" "wget"
		"xauth" "xorgproto" "xorgrgb" "xquartz"
	)

	for pkg in "${packages[@]}"; do
		if brew list "$pkg" &>/dev/null; then
			echo "$pkg is already installed."
			if [[ $outdated_packages == *"$pkg"* ]]; then
				echo "$pkg has a newer version available. Upgrading..."
				brew upgrade "$pkg"
			fi
		else
			echo "$pkg is not installed. Installing..."
			brew install "$pkg"
		fi
		sleep 1
	done

	export LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH
	export PATH=/usr/local/bin:$PATH

	##############################Directory Listing############################

	export HOME=$(
		cd
		pwd
	)
	mkdir $HOME/WRF
	export WRF_FOLDER=$HOME/WRF
	cd "${WRF_FOLDER}"/
	mkdir Downloads

	mkdir Libs
	export DIR="${WRF_FOLDER}"/Libs
	mkdir -p Libs/grib2
	mkdir -p Libs/NETCDF
	mkdir -p Tests/Environment
	mkdir -p Tests/Compatibility

	#############################Core Management####################################
	export CPU_CORE=$(sysctl -n hw.ncpu) # number of available threads on system
	export CPU_6CORE="6"
	export CPU_QUARTER=$(($CPU_CORE / 4))
	#1/2 of availble cores on system
	export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))
	#Forces CPU cores to even number to avoid partial core export. ie 7 cores would be 3.5 cores.

	if [ $CPU_CORE -le $CPU_6CORE ]; then #If statement for low core systems.  Forces computers to only use 1 core if there are 4 cores or less on the system. then
		export CPU_QUARTER_EVEN="2"
	else
		export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))
	fi

	echo "##########################################"
	echo "Number of Threads being used $CPU_QUARTER_EVEN"
	echo "##########################################"
	echo " "

	##############################Downloading Libraries############################

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/madler/zlib/releases/download/v$Zlib_Version/zlib-$Zlib_Version.tar.gz
	wget -c https://github.com/HDFGroup/hdf5/releases/download/hdf5_$HDF5_Version/hdf5-$HDF5_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-c/archive/refs/tags/v$Netcdf_C_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-fortran/archive/refs/tags/v$Netcdf_Fortran_Version.tar.gz
	wget -c https://download.sourceforge.net/libpng/libpng-$Libpng_Version.tar.gz
	wget -c https://www.ece.uvic.ca/~frodo/jasper/software/jasper-$Jasper_Version.zip
	wget -c https://github.com/pmodels/mpich/releases/download/v$Mpich_Version/mpich-$Mpich_Version.tar.gz
	wget -c https://parallel-netcdf.github.io/Release/pnetcdf-$Pnetcdf_Version.tar.gz

	echo " "

	############################# Compilers #############################

	# Symlink to avoid clang conflicts with compilers
	# Default gcc path: /usr/bin/gcc
	# Default homebrew path: /usr/local/bin

	# Find the highest version of GCC, G++, and GFortran in /usr/local/bin
	latest_gcc=$(ls /usr/local/bin/gcc-* 2>/dev/null | grep -o 'gcc-[0-9]*' | sort -V | tail -n 1)
	latest_gpp=$(ls /usr/local/bin/g++-* 2>/dev/null | grep -o 'g++-[0-9]*' | sort -V | tail -n 1)
	latest_gfortran=$(ls /usr/local/bin/gfortran-* 2>/dev/null | grep -o 'gfortran-[0-9]*' | sort -V | tail -n 1)

	# Display the chosen versions
	echo "Selected gcc version: $latest_gcc"
	echo "Selected g++ version: $latest_gpp"
	echo "Selected gfortran version: $latest_gfortran"

	# Check if GCC was found

	# Create or update the symbolic links for GCC, G++, and GFortran
	echo "Linking the latest GCC version: $latest_gcc"
	echo $PASSWD | sudo -S ln -sf /usr/local/bin/$latest_gcc /usr/local/bin/gcc

	echo "Linking the latest G++ version: $latest_gpp"
	echo $PASSWD | sudo -S ln -sf /usr/local/bin/$latest_gpp /usr/local/bin/g++

	echo "Linking the latest GFortran version: $latest_gfortran"
	echo $PASSWD | sudo -S ln -sf /usr/local/bin/$latest_gfortran /usr/local/bin/gfortran

	echo "Updated symbolic links for GCC, G++, and GFortran."
	echo $PASSWD | sudo -S ln -sf /usr/local/bin/python3.12 /usr/local/bin/python3

	# Export compiler environment variables
	export CC=gcc
	export CXX=g++
	export FC=gfortran
	export F77=gfortran
	export CFLAGS="-fPIC -fPIE -Wno-implicit-function-declaration -Wno-incompatible-pointer-types -Wall"

	echo " "

	#IF statement for GNU compiler issue
	export GCC_VERSION=$(/usr/local/bin/$latest_gcc -dumpfullversion | awk '{print$1}')
	export GFORTRAN_VERSION=$(/usr/local/bin/$latest_gfortran -dumpfullversion | awk '{print$1}')
	export GPLUSPLUS_VERSION=$(/usr/local/bin/$latest_gpp -dumpfullversion | awk '{print$1}')

	export GCC_VERSION_MAJOR_VERSION=$(echo $GCC_VERSION | awk -F. '{print $1}')
	export GFORTRAN_VERSION_MAJOR_VERSION=$(echo $GFORTRAN_VERSION | awk -F. '{print $1}')
	export GPLUSPLUS_VERSION_MAJOR_VERSION=$(echo $GPLUSPLUS_VERSION | awk -F. '{print $1}')

	export version_10="10"

	if [ $GCC_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GFORTRAN_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GPLUSPLUS_VERSION_MAJOR_VERSION -ge $version_10 ]; then
		export fallow_argument=-fallow-argument-mismatch
		export boz_argument=-fallow-invalid-boz
	else
		export fallow_argument=
		export boz_argument=
	fi

	export FFLAGS="$fallow_argument -m64"
	export FCFLAGS="$fallow_argument -m64"

	echo "##########################################"
	echo "FFLAGS = $FFLAGS"
	echo "FCFLAGS = $FCFLAGS"
	echo "CFLAGS = $CFLAGS"
	echo "##########################################"

	echo " "

	############################# ZLib ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf zlib-$Zlib_Version.tar.gz
	cd zlib-$Zlib_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	export ZLIB_ROOT=$DIR/grib2
	export ZLIBLIB=$DIR/grib2/lib
	export ZLIBINC=$DIR/grib2/include

	echo " "
	############################## MPICH ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf mpich-$Mpich_Version.tar.gz
	cd mpich-$Mpich_Version/

	F90= ./configure --prefix=$DIR/MPICH --with-device=ch3 FFLAGS="$fallow_argument -m64" FCFLAGS="$fallow_argument -m64" 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee install.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/MPICH/bin:$PATH

	export MPIFC=$DIR/MPICH/bin/mpifort
	export MPIF77=$DIR/MPICH/bin/mpifort
	export MPIF90=$DIR/MPICH/bin/mpifort
	export MPICC=$DIR/MPICH/bin/mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx

	echo " "

	############################# libpng ############################

	cd "${WRF_FOLDER}"/Downloads

	# other libraries below need these variables to be set
	export LDFLAGS=-L$DIR/grib2/lib
	export CPPFLAGS=-I$DIR/grib2/include

	LD_LIBRARY_PATH= tar -xvzf libpng-$Libpng_Version.tar.gz
	cd libpng-$Libpng_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNG_ROOT=$DIR/grib2

	echo " "
	#############################JasPer ############################

	cd "${WRF_FOLDER}"/Downloads
	unzip jasper-$Jasper_Version.zip
	cd jasper-$Jasper_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	export JASPERLIB=$DIR/grib2/lib
	export JASPERINC=$DIR/grib2/include
	export JASPER_DIR=$DIR/grib2
	export Jasper_ROOT=$DIR/grib2/lib

	echo " "
	############################# hdf5 library for netcdf4 functionality ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf hdf5-$HDF5_Version.tar.gz
	cd hdf5-$HDF5_Version

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --with-zlib=$DIR/grib2 --enable-hl --enable-fortran --enable-parallel 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export HDF5=$DIR/grib2
	export PATH=$HDF5/bin:$PATH
	export PHDF5=$DIR/grib2
	export HDF5_ROOT=$DIR/grib2
	export PHDF5_ROOT=$DIR/grib2

	echo " "

	############################# Install Parallel-netCDF ##############################
	#Make file created with half of available cpu cores
	#Hard path for MPI added
	##################################################################################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf pnetcdf-$Pnetcdf_Version.tar.gz
	cd pnetcdf-$Pnetcdf_Version
	export MPIFC=$DIR/MPICH/bin/mpifort
	export MPIF77=$DIR/MPICH/bin/mpifort
	export MPIF90=$DIR/MPICH/bin/mpifort
	export MPICC=$DIR/MPICH/bin/mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --enable-static 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNETCDF=$DIR/grib2
	export PNETCDF_DIR=$DIR/grib2
	export PNETCDF_ROOT=$DIR/grib2

	echo " "

	############################## Install NETCDF C Library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_C_Version.tar.gz
	cd netcdf-c-$Netcdf_C_Version/
	export CPPFLAGS=-I$DIR/grib2/include
	export LDFLAGS="-L$DIR/grib2/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lhdf5_hl -lhdf5 -lz -lcurl -lgfortran -lgcc -lm -ldl -lpnetcdf"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --disable-dap --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-pnetcdf --enable-cdf5 --enable-parallel-tests --enable-logging 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/NETCDF/bin:$PATH
	export NETCDF=$DIR/NETCDF
	export NETCDF_INC=$DIR/NETCDF/include
	export NETCDF_LIB=$DIR/NETCDF/lib
	export NETCDF_ROOT=$DIR/NETCDF
	export LD_LIBRARY_PATH=$DIR/grib2/lib:$DIR/NETCDF/lib:$LD_LIBRARY_PATH

	echo " "

	############################## NetCDF fortran library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_Fortran_Version.tar.gz
	cd netcdf-fortran-$Netcdf_Fortran_Version/
	export LD_LIBRARY_PATH=$DIR/NETCDF/lib:$LD_LIBRARY_PATH
	export CPPFLAGS="-I$DIR/NETCDF/include -I$DIR/grib2/include"
	export LDFLAGS="-L$DIR/NETCDF/lib -L$DIR/grib2/lib -Wl,-rpath,$DIR/NETCDF/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lnetcdf -lpnetcdf -lcurl -lhdf5_hl -lhdf5 -lz -lm -ldl -lgcc -lgfortran"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-parallel-tests --enable-logging --enable-hdf5 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	echo " "

	#################################### System Environment Tests ##############
	mkdir -p "${WRF_FOLDER}"/Tests/Environment
	mkdir -p "${WRF_FOLDER}"/Tests/Compatibility

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_NETCDF_MPI_tests.tar
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_tests.tar

	LD_LIBRARY_PATH= tar -xvf Fortran_C_tests.tar -C "${WRF_FOLDER}"/Tests/Environment
	LD_LIBRARY_PATH= tar -xvf Fortran_C_NETCDF_MPI_tests.tar -C "${WRF_FOLDER}"/Tests/Compatibility
	export one="1"
	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Environment

	echo " "
	echo " "
	echo "Environment Testing "
	echo "Test 1"
	$FC TEST_1_fortran_only_fixed.f
	./a.out | tee env_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 1 Passed"
	else
		echo "Environment Compiler Test 1 Failed"
		exit
	fi
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 2"
	$FC TEST_2_fortran_only_free.f90
	./a.out | tee env_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 2 Passed"
	else
		echo "Environment Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 3"
	$CC TEST_3_c_only.c
	./a.out | tee env_test3.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test3.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 3 Passed"
	else
		echo "Environment Compiler Test 3 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 4"
	$CC -c -m64 TEST_4_fortran+c_c.c
	$FC -c -m64 TEST_4_fortran+c_f.f90
	$FC -m64 TEST_4_fortran+c_f.o TEST_4_fortran+c_c.o
	./a.out | tee env_test4.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test4.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 4 Passed"
	else
		echo "Environment Compiler Test 4 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Compatibility

	cp ${NETCDF}/include/netcdf.inc .

	echo " "
	echo " "
	echo "Library Compatibility Tests "
	echo "Test 1"
	$FC -c 01_fortran+c+netcdf_f.f
	$CC -c 01_fortran+c+netcdf_c.c
	$FC 01_fortran+c+netcdf_f.o 01_fortran+c+netcdf_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	./a.out | tee comp_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 1 Passed"
	else
		echo "Compatibility Compiler Test 1 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "

	echo "Test 2"
	$MPIFC -c 02_fortran+c+netcdf+mpi_f.f
	$MPICC -c 02_fortran+c+netcdf+mpi_c.c
	$MPIFC 02_fortran+c+netcdf+mpi_f.o \
		02_fortran+c+netcdf+mpi_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	$DIR/MPICH/bin/mpirun ./a.out | tee comp_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 2 Passed"
	else
		echo "Compatibility Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."
	echo " "

	echo " All tests completed and passed"
	echo " "

	################################OpenGrADS######################################
	#Verison 2.2.1 64bit of Linux
	#############################################################################
	if [[ $GRADS_PICK -eq 1 ]]; then
		cd "${WRF_FOLDER}"/Downloads
		wget -c https://sourceforge.net/projects/opengrads/files/grads2/2.2.1.oga.1/macOS/opengrads-2.2.1.oga.1-bundle-x86_64-apple-darwin20.5.0.pkg
		sudo -S installer -pkg opengrads-2.2.1.oga.1-bundle-x86_64-apple-darwin20.5.0.pkg -target /Applications/OpenGrads <<<"$PASSWD"

	fi
	################################## GrADS ###############################
	# Version  2.2.1
	# Sublibs library instructions: http://cola.gmu.edu/grads/gadoc/supplibs2.html
	# GrADS instructions: http://cola.gmu.edu/grads/downloads.php
	########################################################################
	if [[ $GRADS_PICK -eq 2 ]]; then

		brew install grads

	fi

	####################################################################
	#Installing Miniconda3 to WRF directory and updating libraries
	####################################################################
	echo $PASSWD | sudo -S apt -y install python3-zstandard python3-zstd

	export Miniconda_Install_DIR="${WRF_FOLDER}"/miniconda3

	mkdir -p $Miniconda_Install_DIR

	wget -c https://repo.anaconda.com/miniconda/Miniconda3-latest-MacOSX-x86_64.sh -O $Miniconda_Install_DIR/miniconda.sh
	bash $Miniconda_Install_DIR/miniconda.sh -b -u -p $Miniconda_Install_DIR

	rm -rf $Miniconda_Install_DIR/miniconda.sh

	export PATH="${WRF_FOLDER}"/miniconda3/bin:$PATH

	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	$Miniconda_Install_DIR/bin/conda init bash

	conda tos accept
	conda config --add channels conda-forge
	conda config --set auto_activate_base false
	conda update -n root --all -y

	echo " "

	#Installing NCL via Conda
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	conda create -n ncl_stable -c conda-forge ncl -y
	conda activate ncl_stable

	conda deactivate
	conda deactivate
	conda deactivate
	echo " "

	##################### WRF Python           ##################
	########### WRf-Python compiled via Conda  ##################
	########### This is the preferred method by NCAR      ##################
	##### https://wrf-python.readthedocs.io/en/latest/installation.html  ##################
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh
	conda env create -f $HOME/WRF-MOSIT/wrf-python-stable.yml

	######################### Climate Data Operators ############
	######################### CDO compiled via Conda ###########
	####################### This is the preferred method #######
	################### https://bairdlangenbrunner.github.io/python-for-climate-scientists/conda/setting-up-conda-environments.html #######################

	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	conda create --name cdo_stable -y
	conda activate cdo_stable
	conda install -c conda-forge cdo -y
	conda update --all -y
	conda deactivate
	conda deactivate
	conda deactivate

	echo " "

	############################ WRF #################################
	## WRF v${WPS_VERSION}
	## Downloaded from git tagged releases
	# option 17, option 1 for gfortran and distributed memory w/basic nesting
	# large file support enable with WRFiO_NCD_LARGE_FILE_SUPPORT=1
	########################################################################

	export WRFIO_NCD_LARGE_FILE_SUPPORT=1
	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/wrf-model/WRF/releases/download/v${WRF_VERSION}/v${WRF_VERSION}.tar.gz -O WRF-${WRF_VERSION}.tar.gz
	LD_LIBRARY_PATH= tar -xvzf WRF-${WRF_VERSION}.tar.gz -C "${WRF_FOLDER}"/

	# If statment for changing folder name
	# Check if WRF directory exists
	if [ -d "${WRF_FOLDER}/WRF" ]; then
		mv -f "${WRF_FOLDER}/WRF" "${WRF_FOLDER}/WRF-${WRF_VERSION}"

	# Else, check for any folder matching WRFV*
	else
		for dir in "${WRF_FOLDER}"/WRFV*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WRF-${WRF_VERSION}"
				break
			fi
		done
	fi

	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}

	LD_LIBRARY_PATH= ./clean -a

	if [ ${auto_config} -eq 1 ]; then
		(
			echo 17
			echo 1
		) | ./configure

	else
		./configure 2>&1 | tee configure.log #Option 17 gfortran compiler with distributed memory option 1 for basic nesting
	fi

	./compile em_real 2>&1 | tee compile.wrf.log

	export WRF_DIR="${WRF_FOLDER}"/WRF-${WRF_VERSION}

	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/main
	n=$(ls ./*.exe | wc -l)
	if (($n >= 3)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}
		LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN em_real 2>&1 | tee compile.wrf2.log
		cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/main
		n=$(ls ./*.exe | wc -l)
		if (($n >= 3)); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi
	echo " "
	############################WPS#####################################
	## WPS v${WPS_VERSION}
	## Downloaded from git tagged releases
	#Option 3 for gfortran and distributed memory
	########################################################################

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/wrf-model/WPS/archive/refs/tags/v${WPS_VERSION}.tar.gz -O WPS-${WPS_VERSION}.tar.gz
	LD_LIBRARY_PATH= tar -xvzf WPS-${WPS_VERSION}.tar.gz -C "${WRF_FOLDER}"/
	# Check if WPS directory exists
	if [ -d "${WRF_FOLDER}/WPS" ]; then
		mv -f "${WRF_FOLDER}/WPS" "${WRF_FOLDER}/WPS-${WPS_VERSION}"

	# Else, check for any folder matching WPSV* or WPS-*
	else
		for dir in "${WRF_FOLDER}"/WPSV* "${WRF_FOLDER}"/WPS-*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WPS-${WPS_VERSION}"
				break
			fi
		done
	fi
	cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
	LD_LIBRARY_PATH= ./clean -a

	if [ ${auto_config} -eq 1 ]; then
		echo 19 | ./configure 2>&1 | tee configure.log #Option 19 for gfortran and distributed memory
	else
		./configure 2>&1 | tee configure.log #Option 19 gfortran compiler with distributed memory
	fi

	LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.wrf.log

	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
	n=$(ls ./*.exe | wc -l)
	if (($n == 3)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WPS. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.wps2.log
		cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
		n=$(ls ./*.exe | wc -l)
		if (($n == 3)); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WPS. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi
	echo " "

	############################WRFPLUS 4DVAR###############################
	## WRFPLUS v${WPS_VERSION} 4DVAR
	## Downloaded from git tagged releases
	## WRFPLUS is built within the WRF git folder
	## Does not include RTTOV Libarary for radiation data.  If wanted will need to install library then reconfigure
	##Note: if you intend to run both 3DVAR and 4DVAR experiments, it is not necessary to compile the code twice.
	#Option 10 for gfortran/gcc and distribunted memory
	########################################################################

	cd "${WRF_FOLDER}"/Downloads
	mkdir "${WRF_FOLDER}"/WRFPLUS
	LD_LIBRARY_PATH= tar -xvzf WRF-${WRF_VERSION}.tar.gz -C "${WRF_FOLDER}"/WRFPLUS

	# If statement for changing folder name inside WRFPLUS
	if [ -d "${WRF_FOLDER}/WRFPLUS/WRF" ]; then
		mv -f "${WRF_FOLDER}/WRFPLUS/WRF" "${WRF_FOLDER}/WRFPLUS/WRF-${WRF_VERSION}"

	else
		for dir in "${WRF_FOLDER}/WRFPLUS"/WRFV*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WRFPLUS/WRF-${WRF_VERSION}"
				break
			fi
		done
	fi

	cd "${WRF_FOLDER}"/WRFPLUS/WRF-${WRF_VERSION}
	mv * "${WRF_FOLDER}"/WRFPLUS
	cd "${WRF_FOLDER}"/WRFPLUS
	rm -rf WRF-${WRF_VERSION}/
	export NETCDF=$DIR/NETCDF
	export HDF5=$DIR/grib2

	if [ ${auto_config} -eq 1 ]; then
		echo 10 | ./configure wrfplus 2>&1 | tee configure.log #Option 10 for gfortran/gcc and distribunted memory
	else
		./configure wrfplus 2>&1 | tee configure.log #Option 10 for gfortran/gcc and distribunted memory
	fi

	./compile wrfplus 2>&1 | tee compile.wrfplus.log
	export WRFPLUS_DIR="${WRF_FOLDER}"/WRFPLUS

	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WRFPLUS/main
	n=$(ls ./wrfplus.exe | wc -l)
	if (($n == 1)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WRF Plus 4DVAR. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		cd "${WRF_FOLDER}"/WRFPLUS/
		LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN wrfplus 2>&1 | tee compile.wrfplus2.log
		cd "${WRF_FOLDER}"/WRFPLUS/main
		n=$(ls ./wrfplus.exe | wc -l)
		if (($n == 1)); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WRF Plus 4DVAR. I am going to wait for 5 seconds only ..."
		else
			echo "Missing one or more expected files."
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	echo " "
	############################WRFDA 4DVAR###############################
	## WRFDA v${WPS_VERSION} 4DVAR
	## Downloaded from git tagged releases
	## WRFDA is built within the WRFPLUS folder
	## Does not include RTTOV Libarary for radiation data.  If wanted will need to install library then reconfigure
	##Note: if you intend to run both 3DVAR and 4DVAR experiments, it is not necessary to compile the code twice.
	#Option 10 for gfortran/clang and distribunted memory
	########################################################################

	cd "${WRF_FOLDER}"/Downloads
	mkdir "${WRF_FOLDER}"/WRFDA
	LD_LIBRARY_PATH= tar -xvzf WRF-${WRF_VERSION}.tar.gz -C "${WRF_FOLDER}"/WRFDA

	# If statement for changing folder name inside WRFDA
	if [ -d "${WRF_FOLDER}/WRFDA/WRF" ]; then
		mv -f "${WRF_FOLDER}/WRFDA/WRF" "${WRF_FOLDER}/WRFDA/WRF-${WRF_VERSION}"

	else
		for dir in "${WRF_FOLDER}/WRFDA"/WRFV*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WRFDA/WRF-${WRF_VERSION}"
				break
			fi
		done
	fi

	cd "${WRF_FOLDER}"/WRFDA/WRF-${WRF_VERSION}
	mv * "${WRF_FOLDER}"/WRFDA
	cd "${WRF_FOLDER}"/WRFDA
	rm -rf WRF-${WRF_VERSION}/
	export NETCDF=$DIR/NETCDF
	export HDF5=$DIR/grib2
	export WRFPLUS_DIR="${WRF_FOLDER}"/WRFPLUS

	if [ ${auto_config} -eq 1 ]; then
		echo 10 | ./configure 4dvar 2>&1 | tee configure.log #Option 18 for gfortran/gcc and distribunted memory
	else
		./configure 4dvar 2>&1 | tee configure.log #Option 18 for gfortran/gcc and distribunted memory
	fi

	LD_LIBRARY_PATH= ./compile -j 2 all_wrfvar 2>&1 | tee compile.wrf4dvar.log

	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WRFDA/var/da
	n=$(ls ./*.exe | wc -l)
	cd "${WRF_FOLDER}"/WRFDA/var/obsproc/src
	m=$(ls ./*.exe | wc -l)
	if ((($n == 43) && ($m == 1))); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WRFDA. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		cd "${WRF_FOLDER}"/WRFDA
		LD_LIBRARY_PATH= ./compile -j 2 all_wrfvar 2>&1 | tee compile.chem.wrfvar2.log
		cd "${WRF_FOLDER}"/WRFDA/var/da
		n=$(ls ./*.exe | wc -l)
		cd "${WRF_FOLDER}"/WRFDA/var/obsproc/src
		m=$(ls ./*.exe | wc -l)
		if ((($n == 43) && ($m == 1))); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WRFDA. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	echo " "

	######################## Static Geography Data inc/ Optional ####################
	# http://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html
	# These files are large so if you only need certain ones comment the others off
	# All files downloaded and untarred is 200GB
	# https://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html
	#################################################################################
	cd "${WRF_FOLDER}"/Downloads
	mkdir "${WRF_FOLDER}"/GEOG
	mkdir "${WRF_FOLDER}"/GEOG/WPS_GEOG

	echo " "
	echo "Mandatory WRF Preprocessing System (WPS) Geographical Input Data Mandatory Fields Downloads"
	echo " "
	wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_high_res_mandatory.tar.gz
	LD_LIBRARY_PATH= tar -xvzf geog_high_res_mandatory.tar.gz -C "${WRF_FOLDER}"/GEOG/

	wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_low_res_mandatory.tar.gz
	LD_LIBRARY_PATH= tar -xvzf geog_low_res_mandatory.tar.gz -C "${WRF_FOLDER}"/GEOG/
	mv "${WRF_FOLDER}"/GEOG/WPS_GEOG_LOW_RES/ "${WRF_FOLDER}"/GEOG/WPS_GEOG

	if [ ${WPS_Specific_Applications} -eq 1 ]; then
		echo " "
		echo " WPS Geographical Input Data Mandatory for Specific Applications"
		echo " "

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_thompson28_chem.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_thompson28_chem.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_noahmp.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_noahmp.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/irrigation.tar.gz
		LD_LIBRARY_PATH= tar -xvzf irrigation.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_px.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_px.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_urban.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_urban.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_ssib.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_ssib.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/lake_depth.tar.bz2
		LD_LIBRARY_PATH= tar -xvf lake_depth.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/topobath_30s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf topobath_30s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/gsl_gwd.tar.bz2
		LD_LIBRARY_PATH= tar -xvf gsl_gwd.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/cglc_modis_lcz_global.tar.gz
		LD_LIBRARY_PATH= tar -xvf cglc_modis_lcz_global.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

	fi

	if [ ${Optional_GEOG} -eq 1 ]; then

		echo " "
		echo "Optional WPS Geographical Input Data"
		echo " "

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_older_than_2000.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_older_than_2000.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/modis_landuse_20class_15s_with_lakes.tar.gz
		LD_LIBRARY_PATH= tar -xvzf modis_landuse_20class_15s_with_lakes.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_alt_lsm.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_alt_lsm.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/nlcd2006_ll_9s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf nlcd2006_ll_9s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/updated_Iceland_LU.tar.gz
		LD_LIBRARY_PATH= tar -xvf updated_Iceland_LU.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/modis_landuse_20class_15s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf modis_landuse_20class_15s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

	fi
fi

if [ "$macos_64bit_GNU" = "1" ] && [ "$WRF_PICK" = "1" ] && [ "$MAC_CHIP" = "ARM" ]; then
	#############################basic package managment############################
	brew cleanup -s
	brew update
	outdated_packages=$(brew outdated --quiet)

	# List of packages to check/install
	packages=(
		"autoconf" "automake" "bison" "byacc" "cmake" "curl" "flex" "gcc"
		"gedit" "git" "gnu-sed" "ksh"
		"libtool" "libxml2" "m4" "make" "python@3.12" "tcsh" "wget"
		"xauth" "xorgproto" "xorgrgb" "xquartz"
	)

	for pkg in "${packages[@]}"; do
		if brew list "$pkg" &>/dev/null; then
			echo "$pkg is already installed."
			if [[ $outdated_packages == *"$pkg"* ]]; then
				echo "$pkg has a newer version available. Upgrading..."
				brew upgrade "$pkg"
			fi
		else
			echo "$pkg is not installed. Installing..."
			brew install "$pkg"
		fi
		sleep 1
	done

	export LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH
	export PATH=/usr/local/bin:$PATH

	##############################Directory Listing############################

	export HOME=$(
		cd
		pwd
	)
	mkdir $HOME/WRF
	export WRF_FOLDER=$HOME/WRF
	cd "${WRF_FOLDER}"/
	mkdir Downloads

	mkdir Libs
	export DIR="${WRF_FOLDER}"/Libs
	mkdir -p Libs/grib2
	mkdir -p Libs/NETCDF
	mkdir -p Tests/Environment
	mkdir -p Tests/Compatibility

	#############################Core Management####################################
	export CPU_CORE=$(sysctl -n hw.ncpu) # number of available threads on system
	export CPU_6CORE="6"
	export CPU_QUARTER=$(($CPU_CORE / 4))
	#1/2 of availble cores on system
	export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))
	#Forces CPU cores to even number to avoid partial core export. ie 7 cores would be 3.5 cores.

	if [ $CPU_CORE -le $CPU_6CORE ]; then #If statement for low core systems.  Forces computers to only use 1 core if there are 4 cores or less on the system. then
		export CPU_QUARTER_EVEN="2"
	else
		export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))
	fi

	echo "##########################################"
	echo "Number of Threads being used $CPU_QUARTER_EVEN"
	echo "##########################################"
	echo " "

	##############################Downloading Libraries############################

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/madler/zlib/releases/download/v$Zlib_Version/zlib-$Zlib_Version.tar.gz
	wget -c https://github.com/HDFGroup/hdf5/releases/download/hdf5_$HDF5_Version/hdf5-$HDF5_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-c/archive/refs/tags/v$Netcdf_C_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-fortran/archive/refs/tags/v$Netcdf_Fortran_Version.tar.gz
	wget -c https://download.sourceforge.net/libpng/libpng-$Libpng_Version.tar.gz
	wget -c https://www.ece.uvic.ca/~frodo/jasper/software/jasper-$Jasper_Version.zip
	wget -c https://github.com/pmodels/mpich/releases/download/v$Mpich_Version/mpich-$Mpich_Version.tar.gz
	wget -c https://parallel-netcdf.github.io/Release/pnetcdf-$Pnetcdf_Version.tar.gz

	echo " "

	############################# Compilers #############################

	# Unlink any existing Homebrew compiler symlinks
	echo $PASSWD | sudo -S unlink /opt/homebrew/bin/gfortran
	echo $PASSWD | sudo -S unlink /opt/homebrew/bin/gcc
	echo $PASSWD | sudo -S unlink /opt/homebrew/bin/g++

	# Source the bashrc to ensure environment variables are loaded
	source ~/.bashrc

	# Check current versions of gcc, g++, and gfortran (these should show "command not found" if unlinked)
	gcc --version
	g++ --version
	gfortran --version

	# Navigate to the Homebrew binaries directory
	cd /opt/homebrew/bin

	# Find the latest version of GCC, G++, and GFortran
	latest_gcc=$(ls gcc-* 2>/dev/null | grep -o 'gcc-[0-9]*' | sort -V | tail -n 1)
	latest_gpp=$(ls g++-* 2>/dev/null | grep -o 'g++-[0-9]*' | sort -V | tail -n 1)
	latest_gfortran=$(ls gfortran-* 2>/dev/null | grep -o 'gfortran-[0-9]*' | sort -V | tail -n 1)

	# Check if the latest versions were found and link them
	echo "Linking the latest GCC version: $latest_gcc"
	echo $PASSWD | sudo -S ln -sf $latest_gcc gcc
	echo "Linking the latest G++ version: $latest_gpp"
	echo $PASSWD | sudo -S ln -sf $latest_gpp g++
	echo "Linking the latest GFortran version: $latest_gfortran"
	echo $PASSWD | sudo -S ln -sf $latest_gfortran gfortran

	# Return to the home directory
	cd

	# Source bashrc and bash_profile to reload the environment settings
	source ~/.bashrc
	source ~/.bash_profile

	# Check if the versions were successfully updated
	gcc --version
	g++ --version
	gfortran --version

	# Export compiler environment variables
	export CC=gcc
	export CXX=g++
	export FC=gfortran
	export F77=gfortran
	export CFLAGS="-fPIC -fPIE -Wno-implicit-function-declaration -Wno-incompatible-pointer-types -Wall"

	echo " "

	############################# End of Compiler Setup #############################

	#IF statement for GNU compiler issue
	export GCC_VERSION=$(/opt/homebrew/bin/$latest_gcc -dumpfullversion | awk '{print$1}')
	export GFORTRAN_VERSION=$(/opt/homebrew/bin/$latest_gfortran -dumpfullversion | awk '{print$1}')
	export GPLUSPLUS_VERSION=$(/opt/homebrew/bin/$latest_gpp -dumpfullversion | awk '{print$1}')

	export GCC_VERSION_MAJOR_VERSION=$(echo $GCC_VERSION | awk -F. '{print $1}')
	export GFORTRAN_VERSION_MAJOR_VERSION=$(echo $GFORTRAN_VERSION | awk -F. '{print $1}')
	export GPLUSPLUS_VERSION_MAJOR_VERSION=$(echo $GPLUSPLUS_VERSION | awk -F. '{print $1}')

	export version_10="10"

	if [ $GCC_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GFORTRAN_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GPLUSPLUS_VERSION_MAJOR_VERSION -ge $version_10 ]; then
		export fallow_argument=-fallow-argument-mismatch
		export boz_argument=-fallow-invalid-boz
	else
		export fallow_argument=
		export boz_argument=
	fi

	export FFLAGS="$fallow_argument -m64"
	export FCFLAGS="$fallow_argument -m64"

	echo "##########################################"
	echo "FFLAGS = $FFLAGS"
	echo "FCFLAGS = $FCFLAGS"
	echo "CFLAGS = $CFLAGS"
	echo "##########################################"

	echo " "

	############################# ZLib ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf zlib-$Zlib_Version.tar.gz
	cd zlib-$Zlib_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	export ZLIB_ROOT=$DIR/grib2
	export ZLIBLIB=$DIR/grib2/lib
	export ZLIBINC=$DIR/grib2/include

	echo " "
	############################## MPICH ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf mpich-$Mpich_Version.tar.gz
	cd mpich-$Mpich_Version/

	F90= ./configure --prefix=$DIR/MPICH --with-device=ch3 FFLAGS="$fallow_argument -m64" FCFLAGS="$fallow_argument -m64" 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/MPICH/bin:$PATH

	export MPIFC=$DIR/MPICH/bin/mpifort
	export MPIF77=$DIR/MPICH/bin/mpifort
	export MPIF90=$DIR/MPICH/bin/mpifort
	export MPICC=$DIR/MPICH/bin/mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx

	echo " "

	############################# libpng ############################

	cd "${WRF_FOLDER}"/Downloads

	# other libraries below need these variables to be set
	export LDFLAGS=-L$DIR/grib2/lib
	export CPPFLAGS=-I$DIR/grib2/include

	LD_LIBRARY_PATH= tar -xvzf libpng-$Libpng_Version.tar.gz
	cd libpng-$Libpng_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNG_ROOT=$DIR/grib2

	echo " "
	#############################JasPer ############################

	cd "${WRF_FOLDER}"/Downloads
	unzip jasper-$Jasper_Version.zip
	cd jasper-$Jasper_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	export JASPERLIB=$DIR/grib2/lib
	export JASPERINC=$DIR/grib2/include
	export JASPER_DIR=$DIR/grib2
	export Jasper_ROOT=$DIR/grib2/lib

	echo " "
	############################# hdf5 library for netcdf4 functionality ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf hdf5-$HDF5_Version.tar.gz
	cd hdf5-$HDF5_Version

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --with-zlib=$DIR/grib2 --enable-hl --enable-fortran --enable-parallel 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export HDF5=$DIR/grib2
	export PATH=$HDF5/bin:$PATH
	export PHDF5=$DIR/grib2
	export HDF5_ROOT=$DIR/grib2
	export PHDF5_ROOT=$DIR/grib2

	echo " "

	############################# Install Parallel-netCDF ##############################
	#Make file created with half of available cpu cores
	#Hard path for MPI added
	##################################################################################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf pnetcdf-$Pnetcdf_Version.tar.gz
	cd pnetcdf-$Pnetcdf_Version

	export MPIFC=$DIR/MPICH/bin/mpifort
	export MPIF77=$DIR/MPICH/bin/mpifort
	export MPIF90=$DIR/MPICH/bin/mpifort
	export MPICC=$DIR/MPICH/bin/mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --enable-static 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNETCDF=$DIR/grib2
	export PNETCDF_DIR=$DIR/grib2
	export PNETCDF_ROOT=$DIR/grib2

	echo " "

	############################## Install NETCDF C Library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_C_Version.tar.gz
	cd netcdf-c-$Netcdf_C_Version/

	export CPPFLAGS=-I$DIR/grib2/include
	export LDFLAGS="-L$DIR/grib2/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lhdf5_hl -lhdf5 -lz -lcurl -lgfortran -lgcc -lm -ldl -lpnetcdf"
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --disable-dap --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-pnetcdf --enable-cdf5 --enable-parallel-tests --enable-logging 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/NETCDF/bin:$PATH
	export NETCDF=$DIR/NETCDF
	export NETCDF_INC=$DIR/NETCDF/include
	export NETCDF_LIB=$DIR/NETCDF/lib
	export NETCDF_ROOT=$DIR/NETCDF
	export LD_LIBRARY_PATH=$DIR/grib2/lib:$DIR/NETCDF/lib:$LD_LIBRARY_PATH

	echo " "

	############################## NetCDF fortran library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_Fortran_Version.tar.gz
	cd netcdf-fortran-$Netcdf_Fortran_Version/

	export LD_LIBRARY_PATH=$DIR/NETCDF/lib:$LD_LIBRARY_PATH
	export CPPFLAGS="-I$DIR/NETCDF/include -I$DIR/grib2/include"
	export LDFLAGS="-L$DIR/NETCDF/lib -L$DIR/grib2/lib -Wl,-rpath,$DIR/NETCDF/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lnetcdf -lpnetcdf -lcurl -lhdf5_hl -lhdf5 -lz -lm -ldl -lgcc -lgfortran"
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-parallel-tests --enable-logging --enable-hdf5 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	echo " "

	#################################### System Environment Tests ##############
	mkdir -p "${WRF_FOLDER}"/Tests/Environment
	mkdir -p "${WRF_FOLDER}"/Tests/Compatibility

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_NETCDF_MPI_tests.tar
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_tests.tar

	LD_LIBRARY_PATH= tar -xvf Fortran_C_tests.tar -C "${WRF_FOLDER}"/Tests/Environment
	LD_LIBRARY_PATH= tar -xvf Fortran_C_NETCDF_MPI_tests.tar -C "${WRF_FOLDER}"/Tests/Compatibility
	export one="1"
	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Environment

	echo " "
	echo " "
	echo "Environment Testing "
	echo "Test 1"
	$FC TEST_1_fortran_only_fixed.f
	./a.out | tee env_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 1 Passed"
	else
		echo "Environment Compiler Test 1 Failed"
		exit
	fi
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 2"
	$FC TEST_2_fortran_only_free.f90
	./a.out | tee env_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 2 Passed"
	else
		echo "Environment Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 3"
	$CC TEST_3_c_only.c
	./a.out | tee env_test3.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test3.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 3 Passed"
	else
		echo "Environment Compiler Test 3 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 4"
	$CC -c -m64 TEST_4_fortran+c_c.c
	$FC -c -m64 TEST_4_fortran+c_f.f90
	$FC -m64 TEST_4_fortran+c_f.o TEST_4_fortran+c_c.o
	./a.out | tee env_test4.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test4.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 4 Passed"
	else
		echo "Environment Compiler Test 4 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Compatibility

	cp ${NETCDF}/include/netcdf.inc .

	echo " "
	echo " "
	echo "Library Compatibility Tests "
	echo "Test 1"
	$FC -c 01_fortran+c+netcdf_f.f
	$CC -c 01_fortran+c+netcdf_c.c
	$FC 01_fortran+c+netcdf_f.o 01_fortran+c+netcdf_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	./a.out | tee comp_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 1 Passed"
	else
		echo "Compatibility Compiler Test 1 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "

	echo "Test 2"
	$MPIFC -c 02_fortran+c+netcdf+mpi_f.f
	$MPICC -c 02_fortran+c+netcdf+mpi_c.c
	$MPIFC 02_fortran+c+netcdf+mpi_f.o \
		02_fortran+c+netcdf+mpi_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	$DIR/MPICH/bin/mpirun ./a.out | tee comp_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 2 Passed"
	else
		echo "Compatibility Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."
	echo " "

	echo " All tests completed and passed"
	echo " "

	################################OpenGrADS######################################
	#Verison 2.2.1 64bit of Linux
	#############################################################################
	if [[ $GRADS_PICK -eq 1 ]]; then
		cd "${WRF_FOLDER}"/Downloads
		wget -c https://sourceforge.net/projects/opengrads/files/grads2/2.2.1.oga.1/macOS/opengrads-2.2.1.oga.1-bundle-x86_64-apple-darwin20.5.0.pkg
		sudo -S installer -pkg opengrads-2.2.1.oga.1-bundle-x86_64-apple-darwin20.5.0.pkg -target /Applications/OpenGrads <<<"$PASSWD"

	fi
	################################## GrADS ###############################
	# Version  2.2.1
	# Sublibs library instructions: http://cola.gmu.edu/grads/gadoc/supplibs2.html
	# GrADS instructions: http://cola.gmu.edu/grads/downloads.php
	########################################################################
	if [[ $GRADS_PICK -eq 2 ]]; then

		brew install grads

	fi

	####################################################################
	#Installing Miniconda3 to WRF directory and updating libraries
	####################################################################
	echo $PASSWD | sudo -S apt -y install python3-zstandard python3-zstd

	export Miniconda_Install_DIR="${WRF_FOLDER}"/miniconda3

	mkdir -p $Miniconda_Install_DIR

	wget -c https://repo.anaconda.com/miniconda/Miniconda3-latest-MacOSX-x86_64.sh -O $Miniconda_Install_DIR/miniconda.sh
	bash $Miniconda_Install_DIR/miniconda.sh -b -u -p $Miniconda_Install_DIR

	rm -rf $Miniconda_Install_DIR/miniconda.sh

	export PATH="${WRF_FOLDER}"/miniconda3/bin:$PATH

	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	$Miniconda_Install_DIR/bin/conda init bash

	conda tos accept
	conda config --add channels conda-forge
	conda config --set auto_activate_base false
	conda update -n root --all -y

	echo " "

	#Installing NCL via Conda
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	conda create -n ncl_stable -c conda-forge ncl -y
	conda activate ncl_stable
	conda update -n ncl_stable --all -y
	conda deactivate
	conda deactivate
	conda deactivate
	echo " "

	##################### WRF Python           ##################
	########### WRf-Python compiled via Conda  ##################
	########### This is the preferred method by NCAR      ##################
	##### https://wrf-python.readthedocs.io/en/latest/installation.html  ##################
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh
	conda env create -f $HOME/WRF-MOSIT/wrf-python-stable.yml

	######################### Climate Data Operators ############
	######################### CDO compiled via Conda ###########
	####################### This is the preferred method #######
	################### https://bairdlangenbrunner.github.io/python-for-climate-scientists/conda/setting-up-conda-environments.html #######################

	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	conda create --name cdo_stable -y
	conda activate cdo_stable
	conda install -c conda-forge cdo -y
	conda update --all -y
	conda deactivate
	conda deactivate
	conda deactivate

	echo " "

	############################ WRF #################################
	## WRF v${WPS_VERSION}
	## Downloaded from git tagged releases
	# option 17, option 1 for gfortran and distributed memory w/basic nesting
	# large file support enable with WRFiO_NCD_LARGE_FILE_SUPPORT=1
	########################################################################

	export WRFIO_NCD_LARGE_FILE_SUPPORT=1
	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/wrf-model/WRF/releases/download/v${WRF_VERSION}/v${WRF_VERSION}.tar.gz -O WRF-${WRF_VERSION}.tar.gz
	LD_LIBRARY_PATH= tar -xvzf WRF-${WRF_VERSION}.tar.gz -C "${WRF_FOLDER}"/

	# If statment for changing folder name
	# Check if WRF directory exists
	if [ -d "${WRF_FOLDER}/WRF" ]; then
		mv -f "${WRF_FOLDER}/WRF" "${WRF_FOLDER}/WRF-${WRF_VERSION}"

	# Else, check for any folder matching WRFV*
	else
		for dir in "${WRF_FOLDER}"/WRFV*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WRF-${WRF_VERSION}"
				break
			fi
		done
	fi

	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}

	LD_LIBRARY_PATH= ./clean -a

	if [ ${auto_config} -eq 1 ]; then
		(echo 17 echo 1) | ./configure

	else
		./configure 2>&1 | tee configure.log #Option 17 gfortran compiler with distributed memory option 1 for basic nesting
	fi

	./compile em_real 2>&1 | tee compile.wrf.log

	export WRF_DIR="${WRF_FOLDER}"/WRF-${WRF_VERSION}

	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/main
	n=$(ls ./*.exe | wc -l)
	if (($n >= 3)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}
		LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN em_real 2>&1 | tee compile.wrf2.log
		cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/main
		n=$(ls ./*.exe | wc -l)
		if (($n >= 3)); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi
	echo " "
	############################WPS#####################################
	## WPS v${WPS_VERSION}
	## Downloaded from git tagged releases
	#Option 3 for gfortran and distributed memory
	########################################################################

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/wrf-model/WPS/archive/refs/tags/v${WPS_VERSION}.tar.gz -O WPS-${WPS_VERSION}.tar.gz
	LD_LIBRARY_PATH= tar -xvzf WPS-${WPS_VERSION}.tar.gz -C "${WRF_FOLDER}"/
	# Check if WPS directory exists
	if [ -d "${WRF_FOLDER}/WPS" ]; then
		mv -f "${WRF_FOLDER}/WPS" "${WRF_FOLDER}/WPS-${WPS_VERSION}"

	# Else, check for any folder matching WPSV* or WPS-*
	else
		for dir in "${WRF_FOLDER}"/WPSV* "${WRF_FOLDER}"/WPS-*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WPS-${WPS_VERSION}"
				break
			fi
		done
	fi
	cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
	LD_LIBRARY_PATH= ./clean -a

	if [ ${auto_config} -eq 1 ]; then
		echo 19 | ./configure 2>&1 | tee configure.log #Option 19 for gfortran and distributed memory
	else
		./configure 2>&1 | tee configure.log #Option 19 gfortran compiler with distributed memory
	fi

	./compile | tee 2>&1 compile.wrf.log

	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
	n=$(ls ./*.exe | wc -l)
	if (($n == 3)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WPS. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.wps2.log
		cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
		n=$(ls ./*.exe | wc -l)
		if (($n == 3)); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WPS. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi
	echo " "

	############################WRFPLUS 4DVAR###############################
	## WRFPLUS v${WPS_VERSION} 4DVAR
	## Downloaded from git tagged releases
	## WRFPLUS is built within the WRF git folder
	## Does not include RTTOV Libarary for radiation data.  If wanted will need to install library then reconfigure
	##Note: if you intend to run both 3DVAR and 4DVAR experiments, it is not necessary to compile the code twice.
	#Option 10 for gfortran/gcc and distribunted memory
	########################################################################

	cd "${WRF_FOLDER}"/Downloads
	mkdir "${WRF_FOLDER}"/WRFPLUS
	LD_LIBRARY_PATH= tar -xvzf WRF-${WRF_VERSION}.tar.gz -C "${WRF_FOLDER}"/WRFPLUS

	# If statement for changing folder name inside WRFPLUS
	if [ -d "${WRF_FOLDER}/WRFPLUS/WRF" ]; then
		mv -f "${WRF_FOLDER}/WRFPLUS/WRF" "${WRF_FOLDER}/WRFPLUS/WRF-${WRF_VERSION}"

	else
		for dir in "${WRF_FOLDER}/WRFPLUS"/WRFV*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WRFPLUS/WRF-${WRF_VERSION}"
				break
			fi
		done
	fi

	cd "${WRF_FOLDER}"/WRFPLUS/WRF-${WRF_VERSION}
	mv * "${WRF_FOLDER}"/WRFPLUS
	cd "${WRF_FOLDER}"/WRFPLUS
	rm -rf WRF-${WRF_VERSION}/
	export NETCDF=$DIR/NETCDF
	export HDF5=$DIR/grib2

	if [ ${auto_config} -eq 1 ]; then
		echo 10 | ./configure wrfplus 2>&1 | tee configure.log #Option 10 for gfortran/gcc and distribunted memory
	else
		./configure wrfplus 2>&1 | tee configure.log #Option 10 for gfortran/gcc and distribunted memory
	fi

	./compile wrfplus 2>&1 | tee compile.wrfplus.log
	export WRFPLUS_DIR="${WRF_FOLDER}"/WRFPLUS

	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WRFPLUS/main
	n=$(ls ./wrfplus.exe | wc -l)
	if (($n == 1)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WRF Plus 4DVAR. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		cd "${WRF_FOLDER}"/WRFPLUS/
		LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN wrfplus 2>&1 | tee compile.wrfplus2.log
		cd "${WRF_FOLDER}"/WRFPLUS/main
		n=$(ls ./wrfplus.exe | wc -l)
		if (($n == 1)); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WRF Plus 4DVAR. I am going to wait for 5 seconds only ..."
		else
			echo "Missing one or more expected files."
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	echo " "
	############################WRFDA 4DVAR###############################
	## WRFDA v${WPS_VERSION} 4DVAR
	## Downloaded from git tagged releases
	## WRFDA is built within the WRFPLUS folder
	## Does not include RTTOV Libarary for radiation data.  If wanted will need to install library then reconfigure
	##Note: if you intend to run both 3DVAR and 4DVAR experiments, it is not necessary to compile the code twice.
	#Option 10 for gfortran/clang and distribunted memory
	########################################################################

	cd "${WRF_FOLDER}"/Downloads
	mkdir "${WRF_FOLDER}"/WRFDA
	LD_LIBRARY_PATH= tar -xvzf WRF-${WRF_VERSION}.tar.gz -C "${WRF_FOLDER}"/WRFDA

	# If statement for changing folder name inside WRFDA
	if [ -d "${WRF_FOLDER}/WRFDA/WRF" ]; then
		mv -f "${WRF_FOLDER}/WRFDA/WRF" "${WRF_FOLDER}/WRFDA/WRF-${WRF_VERSION}"

	else
		for dir in "${WRF_FOLDER}/WRFDA"/WRFV*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WRFDA/WRF-${WRF_VERSION}"
				break
			fi
		done
	fi

	cd "${WRF_FOLDER}"/WRFDA/WRF-${WRF_VERSION}
	mv * "${WRF_FOLDER}"/WRFDA
	cd "${WRF_FOLDER}"/WRFDA
	rm -rf WRF-${WRF_VERSION}/
	export NETCDF=$DIR/NETCDF
	export HDF5=$DIR/grib2
	export WRFPLUS_DIR="${WRF_FOLDER}"/WRFPLUS

	if [ ${auto_config} -eq 1 ]; then
		echo 10 | ./configure 4dvar 2>&1 | tee configure.log #Option 18 for gfortran/gcc and distribunted memory
	else
		./configure 4dvar 2>&1 | tee configure.log #Option 18 for gfortran/gcc and distribunted memory
	fi

	LD_LIBRARY_PATH= ./compile -j 2 all_wrfvar 2>&1 | tee compile.wrf4dvar.log

	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WRFDA/var/da
	n=$(ls ./*.exe | wc -l)
	cd "${WRF_FOLDER}"/WRFDA/var/obsproc/src
	m=$(ls ./*.exe | wc -l)
	if ((($n == 43) && ($m == 1))); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WRFDA. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		cd "${WRF_FOLDER}"/WRFDA
		LD_LIBRARY_PATH= ./compile -j 2 all_wrfvar 2>&1 | tee compile.chem.wrfvar2.log
		cd "${WRF_FOLDER}"/WRFDA/var/da
		n=$(ls ./*.exe | wc -l)
		cd "${WRF_FOLDER}"/WRFDA/var/obsproc/src
		m=$(ls ./*.exe | wc -l)
		if ((($n == 43) && ($m == 1))); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WRFDA. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	echo " "

	######################## Static Geography Data inc/ Optional ####################
	# http://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html
	# These files are large so if you only need certain ones comment the others off
	# All files downloaded and untarred is 200GB
	# https://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html
	#################################################################################
	cd "${WRF_FOLDER}"/Downloads
	mkdir "${WRF_FOLDER}"/GEOG
	mkdir "${WRF_FOLDER}"/GEOG/WPS_GEOG

	echo " "
	echo "Mandatory WRF Preprocessing System (WPS) Geographical Input Data Mandatory Fields Downloads"
	echo " "
	wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_high_res_mandatory.tar.gz
	LD_LIBRARY_PATH= tar -xvzf geog_high_res_mandatory.tar.gz -C "${WRF_FOLDER}"/GEOG/

	wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_low_res_mandatory.tar.gz
	LD_LIBRARY_PATH= tar -xvzf geog_low_res_mandatory.tar.gz -C "${WRF_FOLDER}"/GEOG/
	mv "${WRF_FOLDER}"/GEOG/WPS_GEOG_LOW_RES/ "${WRF_FOLDER}"/GEOG/WPS_GEOG

	if [ ${WPS_Specific_Applications} -eq 1 ]; then
		echo " "
		echo " WPS Geographical Input Data Mandatory for Specific Applications"
		echo " "

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_thompson28_chem.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_thompson28_chem.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_noahmp.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_noahmp.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/irrigation.tar.gz
		LD_LIBRARY_PATH= tar -xvzf irrigation.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_px.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_px.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_urban.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_urban.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_ssib.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_ssib.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/lake_depth.tar.bz2
		LD_LIBRARY_PATH= tar -xvf lake_depth.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/topobath_30s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf topobath_30s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/gsl_gwd.tar.bz2
		LD_LIBRARY_PATH= tar -xvf gsl_gwd.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/cglc_modis_lcz_global.tar.gz
		LD_LIBRARY_PATH= tar -xvf cglc_modis_lcz_global.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

	fi

	if [ ${Optional_GEOG} -eq 1 ]; then

		echo " "
		echo "Optional WPS Geographical Input Data"
		echo " "

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_older_than_2000.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_older_than_2000.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/modis_landuse_20class_15s_with_lakes.tar.gz
		LD_LIBRARY_PATH= tar -xvzf modis_landuse_20class_15s_with_lakes.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_alt_lsm.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_alt_lsm.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/nlcd2006_ll_9s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf nlcd2006_ll_9s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/updated_Iceland_LU.tar.gz
		LD_LIBRARY_PATH= tar -xvf updated_Iceland_LU.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/modis_landuse_20class_15s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf modis_landuse_20class_15s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

	fi

fi

if [ "$RHL_64bit_GNU" = "1" ] && [ "$WRF_PICK" = "1" ]; then

	#############################basic package managment############################
	echo $PASSWD | sudo -S yum install epel-release -y
	echo $PASSWD | sudo -S yum install dnf -y
	echo $PASSWD | sudo -S dnf install epel-release -y
	echo $PASSWD | sudo -S dnf install dnf -y
	echo $PASSWD | sudo -S dnf -y update
	echo $PASSWD | sudo -S dnf -y upgrade
	echo $PASSWD | sudo -S dnf -y install bzip2 bzip2-devel byacc cairo-devel cmake cpp curl curl-devel flex fontconfig-devel fontconfig-devel gcc gcc-c++ gcc-gfortran git java-11-openjdk java-11-openjdk-devel ksh libX11-devel libX11-devel libXaw libXaw-devel libXext-devel libXext-devel libXmu-devel libXrender-devel libXrender-devel libstdc++ libstdc++-devel libxml2 libxml2-devel m4 nfs-utils perl "perl(XML::LibXML)" pkgconfig pixman-devel python3 python3-devel tcsh time unzip wget
	echo $PASSWD | sudo -S dnf -y groupinstall "Development Tools"
	echo $PASSWD | sudo -S dnf -y update
	echo $PASSWD | sudo -S dnf -y upgrade

	echo " "
	##############################Directory Listing############################
	export HOME=$(
		cd
		pwd
	)

	mkdir $HOME/WRF
	export WRF_FOLDER=$HOME/WRF
	cd "${WRF_FOLDER}"/
	mkdir Downloads

	mkdir Libs
	export DIR="${WRF_FOLDER}"/Libs
	mkdir Libs/grib2
	mkdir Libs/NETCDF
	mkdir Libs/MPICH
	mkdir -p Tests/Environment
	mkdir -p Tests/Compatibility

	echo " "
	#############################Core Management####################################

	export CPU_CORE=$(nproc) # number of available threads on system
	export CPU_6CORE="6"
	export CPU_QUARTER=$(($CPU_CORE / 4))                          #quarter of availble cores on system
	export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2))) #Forces CPU cores to even number to avoid partial core export. ie 7 cores would be 3.5 cores.

	if [ $CPU_CORE -le $CPU_6CORE ]; then #If statement for low core systems.  Forces computers to only use 1 core if there are 4 cores or less on the system. then
		export CPU_QUARTER_EVEN="2"
	else
		export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))
	fi

	echo "##########################################"
	echo "Number of Threads being used $CPU_QUARTER_EVEN"
	echo "##########################################"

	echo " "
	##############################Downloading Libraries############################
	cd Downloads
	wget -c https://github.com/madler/zlib/releases/download/v$Zlib_Version/zlib-$Zlib_Version.tar.gz
	wget -c https://github.com/HDFGroup/hdf5/releases/download/hdf5_$HDF5_Version/hdf5-$HDF5_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-c/archive/refs/tags/v$Netcdf_C_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-fortran/archive/refs/tags/v$Netcdf_Fortran_Version.tar.gz
	wget -c https://github.com/pmodels/mpich/releases/download/v$Mpich_Version/mpich-$Mpich_Version.tar.gz
	wget -c https://download.sourceforge.net/libpng/libpng-$Libpng_Version.tar.gz
	wget -c https://www.ece.uvic.ca/~frodo/jasper/software/jasper-$Jasper_Version.zip
	wget -c https://parallel-netcdf.github.io/Release/pnetcdf-$Pnetcdf_Version.tar.gz

	echo " "
	####################################Compilers#####################################
	export CC=gcc
	export CXX=g++
	export FC=gfortran
	export F77=gfortran
	export CFLAGS="-fPIC -fPIE -O3"

	#IF statement for GNU compiler issue
	export GCC_VERSION=$(gcc -dumpfullversion | awk '{print$1}')
	export GFORTRAN_VERSION=$(gfortran -dumpfullversion | awk '{print$1}')
	export GPLUSPLUS_VERSION=$(g++ -dumpfullversion | awk '{print$1}')

	export GCC_VERSION_MAJOR_VERSION=$(echo $GCC_VERSION | awk -F. '{print $1}')
	export GFORTRAN_VERSION_MAJOR_VERSION=$(echo $GFORTRAN_VERSION | awk -F. '{print $1}')
	export GPLUSPLUS_VERSION_MAJOR_VERSION=$(echo $GPLUSPLUS_VERSION | awk -F. '{print $1}')

	export version_10="10"

	if [ $GCC_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GFORTRAN_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GPLUSPLUS_VERSION_MAJOR_VERSION -ge $version_10 ]; then
		export fallow_argument=-fallow-argument-mismatch
		export boz_argument=-fallow-invalid-boz
	else
		export fallow_argument=
		export boz_argument=
	fi

	export FFLAGS="$fallow_argument -m64"
	export FCFLAGS="$fallow_argument -m64"

	echo "##########################################"
	echo "FFLAGS = $FFLAGS"
	echo "FCFLAGS = $FCFLAGS"
	echo "CFLAGS = $CFLAGS"
	echo "##########################################"

	echo " "
	############################# ZLib ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf zlib-$Zlib_Version.tar.gz
	cd zlib-$Zlib_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	export ZLIB_ROOT=$DIR/grib2
	export ZLIBLIB=$DIR/grib2/lib
	export ZLIBINC=$DIR/grib2/include

	echo " "
	############################## MPICH ############################
	#F90= due to compiler issues with mpich install
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf mpich-$Mpich_Version.tar.gz
	cd mpich-$Mpich_Version/

	F90= ./configure --prefix=$DIR/MPICH --with-device=ch3 FFLAGS=$fallow_argument FCFLAGS=$fallow_argument 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/MPICH/bin:$PATH
	export MPIFC=$DIR/MPICH/bin/mpifort
	export MPIF77=$DIR/MPICH/bin/mpifort
	export MPIF90=$DIR/MPICH/bin/mpifort
	export MPICC=$DIR/MPICH/bin/mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx

	echo " "
	############################# libpng ############################

	cd "${WRF_FOLDER}"/Downloads

	# other libraries below need these variables to be set
	export LDFLAGS=-L$DIR/grib2/lib
	export CPPFLAGS=-I$DIR/grib2/include

	LD_LIBRARY_PATH= tar -xvzf libpng-$Libpng_Version.tar.gz
	cd libpng-$Libpng_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNG_ROOT=$DIR/grib2

	echo " "
	#############################JasPer ############################
	cd "${WRF_FOLDER}"/Downloads
	unzip jasper-$Jasper_Version.zip
	cd jasper-$Jasper_Version/

	./configure --prefix=$DIR/grib2
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export JASPERLIB=$DIR/grib2/lib
	export JASPERINC=$DIR/grib2/include
	export JASPER_DIR=$DIR/grib2
	export Jasper_ROOT=$DIR/grib2/lib

	echo " "
	############################# hdf5 library for netcdf4 functionality ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf hdf5-$HDF5_Version.tar.gz
	cd hdf5-$HDF5_Version

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --with-zlib=$DIR/grib2 --enable-hl --enable-fortran --enable-parallel 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export HDF5=$DIR/grib2
	export PATH=$HDF5/bin:$PATH
	export PHDF5=$DIR/grib2
	export HDF5_ROOT=$DIR/grib2
	export PHDF5_ROOT=$DIR/grib2

	echo " "
	############################# Install Parallel-netCDF ##############################
	#Make file created with half of available cpu cores
	#Hard path for MPI added
	##################################################################################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf pnetcdf-$Pnetcdf_Version.tar.gz
	cd pnetcdf-$Pnetcdf_Version

	export MPIFC=$DIR/MPICH/bin/mpifort
	export MPIF77=$DIR/MPICH/bin/mpifort
	export MPIF90=$DIR/MPICH/bin/mpifort
	export MPICC=$DIR/MPICH/bin/mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --enable-static 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNETCDF=$DIR/grib2
	export PNETCDF_DIR=$DIR/grib2
	export PNETCDF_ROOT=$DIR/grib2

	echo " "

	############################## Install NETCDF C Library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_C_Version.tar.gz
	cd netcdf-c-$Netcdf_C_Version/
	export CPPFLAGS=-I$DIR/grib2/include
	export LDFLAGS="-L$DIR/grib2/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lhdf5_hl -lhdf5 -lz -lcurl -lgfortran -lgcc -lm -ldl -lpnetcdf"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --disable-dap --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-pnetcdf --enable-cdf5 --enable-parallel-tests --enable-logging 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/NETCDF/bin:$PATH
	export NETCDF=$DIR/NETCDF
	export NETCDF_INC=$DIR/NETCDF/include
	export NETCDF_LIB=$DIR/NETCDF/lib
	export NETCDF_ROOT=$DIR/NETCDF
	export LD_LIBRARY_PATH=$DIR/grib2/lib:$DIR/NETCDF/lib:$LD_LIBRARY_PATH

	echo " "
	############################## NetCDF fortran library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_Fortran_Version.tar.gz
	cd netcdf-fortran-$Netcdf_Fortran_Version/
	export LD_LIBRARY_PATH=$DIR/NETCDF/lib:$LD_LIBRARY_PATH
	export CPPFLAGS="-I$DIR/NETCDF/include -I$DIR/grib2/include"
	export LDFLAGS="-L$DIR/NETCDF/lib -L$DIR/grib2/lib -Wl,-rpath,$DIR/NETCDF/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lnetcdf -lpnetcdf -lcurl -lhdf5_hl -lhdf5 -lz -lm -ldl -lgcc -lgfortran"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-parallel-tests --enable-logging --enable-hdf5 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	echo " "
	#################################### System Environment Tests ##############

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_NETCDF_MPI_tests.tar
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_tests.tar

	LD_LIBRARY_PATH= tar -xvf Fortran_C_tests.tar -C "${WRF_FOLDER}"/Tests/Environment
	LD_LIBRARY_PATH= tar -xvf Fortran_C_NETCDF_MPI_tests.tar -C "${WRF_FOLDER}"/Tests/Compatibility

	export one="1"
	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Environment

	cp ${NETCDF}/include/netcdf.inc .

	echo " "
	echo " "
	echo "Environment Testing "
	echo "Test 1"
	$FC TEST_1_fortran_only_fixed.f
	./a.out | tee env_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 1 Passed"
	else
		echo "Environment Compiler Test 1 Failed"
		exit
	fi
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 2"
	$FC TEST_2_fortran_only_free.f90
	./a.out | tee env_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 2 Passed"
	else
		echo "Environment Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 3"
	$CC TEST_3_c_only.c
	./a.out | tee env_test3.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test3.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 3 Passed"
	else
		echo "Environment Compiler Test 3 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 4"
	$CC -c -m64 TEST_4_fortran+c_c.c
	$FC -c -m64 TEST_4_fortran+c_f.f90
	$FC -m64 TEST_4_fortran+c_f.o TEST_4_fortran+c_c.o
	./a.out | tee env_test4.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test4.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 4 Passed"
	else
		echo "Environment Compiler Test 4 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Compatibility

	cp ${NETCDF}/include/netcdf.inc .

	echo " "
	echo " "
	echo "Library Compatibility Tests "
	echo "Test 1"
	$FC -c 01_fortran+c+netcdf_f.f
	$CC -c 01_fortran+c+netcdf_c.c
	$FC 01_fortran+c+netcdf_f.o 01_fortran+c+netcdf_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	./a.out | tee comp_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 1 Passed"
	else
		echo "Compatibility Compiler Test 1 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "

	echo "Test 2"
	$MPIFC -c 02_fortran+c+netcdf+mpi_f.f
	$MPICC -c 02_fortran+c+netcdf+mpi_c.c
	$MPIFC 02_fortran+c+netcdf+mpi_f.o \
		02_fortran+c+netcdf+mpi_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	$DIR/MPICH/bin/mpirun ./a.out | tee comp_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 2 Passed"
	else
		echo "Compatibility Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."
	echo " "

	echo " All tests completed and passed"
	echo " "

	################################ OpenGrADS ##################################
	#Verison 2.2.1 32bit of Linux
	#############################################################################
	if [[ $GRADS_PICK -eq 1 ]]; then
		cd "${WRF_FOLDER}"/Downloads
		LD_LIBRARY_PATH= tar -xvzf cd "${WRF_FOLDER}"/Downloads
		wget -c https://sourceforge.net/projects/opengrads/files/grads2/2.2.1.oga.1/Linux%20%2864%20Bits%29/opengrads-2.2.1.oga.1-bundle-x86_64-pc-linux-gnu-glibc_2.17.tar.gz
		LD_LIBRARY_PATH= tar -xvzf opengrads-2.2.1.oga.1-bundle-x86_64-pc-linux-gnu-glibc_2.17.tar.gz -C "${WRF_FOLDER}"/ -C "${WRF_FOLDER}"/
		cd "${WRF_FOLDER}"/
		mv "${WRF_FOLDER}"/opengrads-2.2.1.oga.1 "${WRF_FOLDER}"/GrADS
		cd GrADS/Contents
		wget -c https://github.com/regisgrundig/SIMOP/blob/master/g2ctl.pl
		chmod +x g2ctl.pl
		wget -c https://sourceforge.net/projects/opengrads/files/wgrib2/0.1.9.4/wgrib2-v0.1.9.4-bin-i686-glib2.5-linux-gnu.tar.gz
		LD_LIBRARY_PATH= tar -xvzf wgrib2-v0.1.9.4-bin-i686-glib2.5-linux-gnu.tar.gz
		cd wgrib2-v0.1.9.4/bin
		mv wgrib2 "${WRF_FOLDER}"/GrADS/Contents
		cd "${WRF_FOLDER}"/GrADS/Contents
		rm wgrib2-v0.1.9.4-bin-i686-glib2.5-linux-gnu.tar.gz
		rm -r wgrib2-v0.1.9.4

		export PATH="${WRF_FOLDER}"/GrADS/Contents:$PATH

		echo " "
	fi
	################################## GrADS ###############################
	# Version  2.2.1
	# Sublibs library instructions: http://cola.gmu.edu/grads/gadoc/supplibs2.html
	# GrADS instructions: http://cola.gmu.edu/grads/downloads.php
	########################################################################
	if [[ $GRADS_PICK -eq 2 ]]; then
		cd "${WRF_FOLDER}"/Downloads
		wget -c ftp://cola.gmu.edu/grads/2.2/grads-2.2.1-bin-RHL7.4-x86_64.tar.gz
		LD_LIBRARY_PATH= tar -xvzf grads-2.2.1-bin-RHL7.4-x86_64.tar.gz -C "${WRF_FOLDER}"
		cd "${WRF_FOLDER}"/grads-2.2.1/bin
		chmod 775 *

	fi

	##################### NCAR COMMAND LANGUAGE           ##################
	########### NCL compiled via Conda                    ##################
	########### This is the preferred method by NCAR      ##################
	########### https://www.ncl.ucar.edu/index.shtml      ##################
	#Installing Miniconda3 to WRF-Hydro directory and updating libraries

	echo $PASSWD | sudo -S dnf -y install python3-zstandard python3-zstd

	export Miniconda_Install_DIR="${WRF_FOLDER}"/miniconda3

	mkdir -p $Miniconda_Install_DIR

	wget -c https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O $Miniconda_Install_DIR/miniconda.sh
	bash $Miniconda_Install_DIR/miniconda.sh -b -u -p $Miniconda_Install_DIR

	rm -rf $Miniconda_Install_DIR/miniconda.sh

	export PATH="${WRF_FOLDER}"/miniconda3/bin:$PATH

	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	$Miniconda_Install_DIR/bin/conda init bash

	conda tos accept
	conda config --add channels conda-forge
	conda config --set auto_activate_base false
	conda update -n root --all -y

	echo " "

	echo " "
	#Installing NCL via Conda
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	conda create -n ncl_stable -c conda-forge ncl -y
	conda activate ncl_stable

	conda deactivate
	conda deactivate
	conda deactivate

	echo " "
	echo " "

	############################OBSGRID###############################
	## OBSGRID
	## Downloaded from git tagged releases
	## Option #2
	########################################################################
	cd "${WRF_FOLDER}"/
	git clone https://github.com/wrf-model/OBSGRID.git
	cd "${WRF_FOLDER}"/OBSGRID

	LD_LIBRARY_PATH= ./clean -a
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh
	conda activate ncl_stable

	export HOME=$(
		cd
		pwd
	)
	export DIR="${WRF_FOLDER}"/Libs
	export NETCDF=$DIR/NETCDF

	if [ ${auto_config} -eq 1 ]; then
		echo 2 | ./configure 2>&1 | tee configure.log #Option 2 for gfortran/gcc and distribunted memory
	else
		./configure 2>&1 | tee configure.log #Option 2 for gfortran/gcc and distribunted memory
	fi

	sed -i '27s/-lnetcdf -lnetcdff/ -lnetcdff -lnetcdf/g' configure.oa

	sed -i '31s/-lncarg -lncarg_gks -lncarg_c -lX11 -lm -lcairo/-lncarg -lncarg_gks -lncarg_c -lX11 -lm -lcairo -lfontconfig -lpixman-1 -lfreetype -lhdf5 -lhdf5_hl /g' configure.oa

	sed -i '39s/-frecord-marker=4/-frecord-marker=4 ${fallow_argument} /g' configure.oa

	sed -i '44s/=	/=	${fallow_argument} /g' configure.oa

	sed -i '45s/-C -P -traditional/-P -traditional/g' configure.oa

	echo " "
	LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.obsgrid.log

	conda deactivate
	conda deactivate
	conda deactivate

	echo " "
	# IF statement to check that all files were created.
	if [[ -x ./obsgrid.exe ]]; then
		echo "obsgrid.exe found."
		read -r -t 5 -p "Finished installing OBSGRID. I am going to wait for 5 seconds only ..."
	else
		echo "obsgrid.exe is missing. Attempting to compile again..."

		LD_LIBRARY_PATH= ./clean -a
		LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.obsgrid.retry.log

		if [[ -x ./obsgrid.exe ]]; then
			echo "obsgrid.exe successfully created after recompilation."
			read -r -t 5 -p "Finished retrying OBSGRID compile. I am going to wait for 5 seconds only ..."
		else
			echo "Still missing obsgrid.exe after recompile. Exiting the script."
			read -r -p "Please contact script authors for assistance. Press 'Enter' to exit."
			exit 1
		fi
	fi

	echo " "

	##################### WRF Python           ##################
	########### WRf-Python compiled via Conda  ##################
	########### This is the preferred method by NCAR      ##################
	##### https://wrf-python.readthedocs.io/en/latest/installation.html  ##################
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh
	conda env create -f $HOME/WRF-MOSIT/wrf-python-stable.yml

	echo " "
	############################ WRF #################################
	## WRF v${WPS_VERSION}
	## Downloaded from git tagged releases
	# option 34, option 1 for gfortran and distributed memory w/basic nesting
	# large file support enable with WRFiO_NCD_LARGE_FILE_SUPPORT=1
	# In the namelist.input, the following settings support pNetCDF by setting value to 11:
	# io_form_boundary
	# io_form_history
	# io_form_auxinput2
	# io_form_auxhist2
	# Note that you need set nocolons = .true. in the section &time_control of namelist.input
	########################################################################
	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/wrf-model/WRF/releases/download/v${WRF_VERSION}/v${WRF_VERSION}.tar.gz -O WRF-${WRF_VERSION}.tar.gz
	LD_LIBRARY_PATH= tar -xvzf WRF-${WRF_VERSION}.tar.gz -C "${WRF_FOLDER}"/

	# If statment for changing folder name
	# Check if WRF directory exists
	if [ -d "${WRF_FOLDER}/WRF" ]; then
		mv -f "${WRF_FOLDER}/WRF" "${WRF_FOLDER}/WRF-${WRF_VERSION}"

	# Else, check for any folder matching WRFV*
	else
		for dir in "${WRF_FOLDER}"/WRFV*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WRF-${WRF_VERSION}"
				break
			fi
		done
	fi

	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}
	export WRFIO_NCD_LARGE_FILE_SUPPORT=1
	LD_LIBRARY_PATH= ./clean -a

	if [ ${auto_config} -eq 1 ]; then
		(
			echo 34
			echo 1
		) | ./configure

	else
		./configure 2>&1 | tee configure.log #Option 34 gfortran compiler with distributed memory option 1 for basic nesting
	fi

	LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN em_real 2>&1 | tee compile.wrf1.log

	export WRF_DIR="${WRF_FOLDER}"/WRF-${WRF_VERSION}

	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/main
	n=$(ls ./*.exe | wc -l)
	if (($n >= 3)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}
		LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN em_real 2>&1 | tee compile.wrf2.log
		cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/main
		n=$(ls ./*.exe | wc -l)
		if (($n >= 3)); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	echo " "
	############################WPS#####################################
	## WPS v${WPS_VERSION}
	## Downloaded from git tagged releases
	#Option 3 for gfortran and distributed memory
	########################################################################

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/wrf-model/WPS/archive/refs/tags/v${WPS_VERSION}.tar.gz -O WPS-${WPS_VERSION}.tar.gz
	LD_LIBRARY_PATH= tar -xvzf WPS-${WPS_VERSION}.tar.gz -C "${WRF_FOLDER}"/
	# Check if WPS directory exists
	if [ -d "${WRF_FOLDER}/WPS" ]; then
		mv -f "${WRF_FOLDER}/WPS" "${WRF_FOLDER}/WPS-${WPS_VERSION}"

	# Else, check for any folder matching WPSV* or WPS-*
	else
		for dir in "${WRF_FOLDER}"/WPSV* "${WRF_FOLDER}"/WPS-*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WPS-${WPS_VERSION}"
				break
			fi
		done
	fi
	cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
	LD_LIBRARY_PATH= ./clean -a

	if [ ${auto_config} -eq 1 ]; then
		echo 3 | ./configure 2>&1 | tee configure.log #Option 3 for gfortran and distributed memory
	else
		./configure 2>&1 | tee configure.log #Option 3 gfortran compiler with distributed memory
	fi
	LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.wps.log

	echo " "
	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
	n=$(ls ./*.exe | wc -l)
	if (($n == 3)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WPS. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.wps2.log
		cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
		n=$(ls ./*.exe | wc -l)
		if (($n == 3)); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WPS. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	echo " "
	############################WRFPLUS 4DVAR###############################
	## WRFPLUS v${WPS_VERSION} 4DVAR
	## Downloaded from git tagged releases
	## WRFPLUS is built within the WRF git folder
	## Does not include RTTOV Libarary for radiation data.  If wanted will need to install library then reconfigure
	##Note: if you intend to run both 3DVAR and 4DVAR experiments, it is not necessary to compile the code twice.
	#Option 18 for gfortran/gcc and distribunted memory
	########################################################################
	cd "${WRF_FOLDER}"/Downloads
	mkdir "${WRF_FOLDER}"/WRFPLUS
	LD_LIBRARY_PATH= tar -xvzf WRF-${WRF_VERSION}.tar.gz -C "${WRF_FOLDER}"/WRFPLUS

	# If statement for changing folder name inside WRFPLUS
	if [ -d "${WRF_FOLDER}/WRFPLUS/WRF" ]; then
		mv -f "${WRF_FOLDER}/WRFPLUS/WRF" "${WRF_FOLDER}/WRFPLUS/WRF-${WRF_VERSION}"

	else
		for dir in "${WRF_FOLDER}/WRFPLUS"/WRFV*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WRFPLUS/WRF-${WRF_VERSION}"
				break
			fi
		done
	fi

	cd "${WRF_FOLDER}"/WRFPLUS/WRF-${WRF_VERSION}
	mv * "${WRF_FOLDER}"/WRFPLUS
	cd "${WRF_FOLDER}"/WRFPLUS
	rm -rf WRF-${WRF_VERSION}/
	export NETCDF=$DIR/NETCDF
	export HDF5=$DIR/grib2
	LD_LIBRARY_PATH= ./clean -a

	if [ ${auto_config} -eq 1 ]; then
		echo 18 | ./configure wrfplus 2>&1 | tee configure.log #Option 18 for gfortran/gcc and distribunted memory
	else
		./configure wrfplus 2>&1 | tee configure.log #Option 18 for gfortran/gcc and distribunted memory
	fi
	echo " "
	LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN wrfplus 2>&1 | tee compile.wrfplus.log
	export WRFPLUS_DIR="${WRF_FOLDER}"/WRFPLUS

	echo " "
	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WRFPLUS/main
	n=$(ls ./wrfplus.exe | wc -l)
	if (($n == 1)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WRF Plus 4DVAR. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		cd "${WRF_FOLDER}"/WRFPLUS/
		LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN wrfplus 2>&1 | tee compile.wrfplus2.log
		cd "${WRF_FOLDER}"/WRFPLUS/main
		n=$(ls ./wrfplus.exe | wc -l)
		if (($n == 1)); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WRF Plus 4DVAR. I am going to wait for 5 seconds only ..."
		else
			echo "Missing one or more expected files."
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	echo " "
	############################WRFDA 4DVAR###############################
	## WRFDA v${WPS_VERSION} 4DVAR
	## Downloaded from git tagged releases
	## WRFDA is built within the WRFPLUS folder
	## Does not include RTTOV Libarary for radiation data.  If wanted will need to install library then reconfigure
	##Note: if you intend to run both 3DVAR and 4DVAR experiments, it is not necessary to compile the code twice.
	#Option 18 for gfortran/gcc and distribunted memory
	########################################################################
	cd "${WRF_FOLDER}"/Downloads
	mkdir "${WRF_FOLDER}"/WRFDA
	LD_LIBRARY_PATH= tar -xvzf WRF-${WRF_VERSION}.tar.gz -C "${WRF_FOLDER}"/WRFDA

	# If statement for changing folder name inside WRFDA
	if [ -d "${WRF_FOLDER}/WRFDA/WRF" ]; then
		mv -f "${WRF_FOLDER}/WRFDA/WRF" "${WRF_FOLDER}/WRFDA/WRF-${WRF_VERSION}"

	else
		for dir in "${WRF_FOLDER}/WRFDA"/WRFV*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WRFDA/WRF-${WRF_VERSION}"
				break
			fi
		done
	fi

	cd "${WRF_FOLDER}"/WRFDA/WRF-${WRF_VERSION}
	mv * "${WRF_FOLDER}"/WRFDA
	cd "${WRF_FOLDER}"/WRFDA
	rm -rf WRF-${WRF_VERSION}/
	export NETCDF=$DIR/NETCDF
	export HDF5=$DIR/grib2
	export WRFPLUS_DIR="${WRF_FOLDER}"/WRFPLUS
	LD_LIBRARY_PATH= ./clean -a

	if [ ${auto_config} -eq 1 ]; then
		echo 18 | ./configure 4dvar 2>&1 | tee configure.log #Option 18 for gfortran/gcc and distribunted memory
	else
		./configure 4dvar 2>&1 | tee configure.log #Option 18 for gfortran/gcc and distribunted memory
	fi
	echo " "
	LD_LIBRARY_PATH= ./compile -j 2 all_wrfvar 2>&1 | tee compile.wrf4dvar.log

	echo " "
	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WRFDA/var/da
	n=$(ls ./*.exe | wc -l)
	cd "${WRF_FOLDER}"/WRFDA/var/obsproc/src
	m=$(ls ./*.exe | wc -l)
	if ((($n == 43) && ($m == 1))); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WRFDA. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		cd "${WRF_FOLDER}"/WRFDA
		LD_LIBRARY_PATH= ./compile -j 2 all_wrfvar 2>&1 | tee compile.chem.wrfvar2.log
		cd "${WRF_FOLDER}"/WRFDA/var/da
		n=$(ls ./*.exe | wc -l)
		cd "${WRF_FOLDER}"/WRFDA/var/obsproc/src
		m=$(ls ./*.exe | wc -l)
		if ((($n == 43) && ($m == 1))); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WRFDA. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi
	echo " "

	echo " "

	######################## Static Geography Data inc/ Optional ####################
	# http://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html
	# These files are large so if you only need certain ones comment the others off
	# All files downloaded and untarred is 200GB
	# https://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html
	#################################################################################
	cd "${WRF_FOLDER}"/Downloads
	mkdir "${WRF_FOLDER}"/GEOG
	mkdir "${WRF_FOLDER}"/GEOG/WPS_GEOG

	echo " "
	echo "Mandatory WRF Preprocessing System (WPS) Geographical Input Data Mandatory Fields Downloads"
	echo " "
	wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_high_res_mandatory.tar.gz
	LD_LIBRARY_PATH= tar -xvzf geog_high_res_mandatory.tar.gz -C "${WRF_FOLDER}"/GEOG/

	wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_low_res_mandatory.tar.gz
	LD_LIBRARY_PATH= tar -xvzf geog_low_res_mandatory.tar.gz -C "${WRF_FOLDER}"/GEOG/
	mv "${WRF_FOLDER}"/GEOG/WPS_GEOG_LOW_RES/ "${WRF_FOLDER}"/GEOG/WPS_GEOG

	if [ ${WPS_Specific_Applications} -eq 1 ]; then
		echo " "
		echo " WPS Geographical Input Data Mandatory for Specific Applications"
		echo " "

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_thompson28_chem.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_thompson28_chem.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_noahmp.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_noahmp.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/irrigation.tar.gz
		LD_LIBRARY_PATH= tar -xvzf irrigation.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG
		mkdir "${WRF_FOLDER}"/GEOG/WPS_GEOG/irrigation
		mv "${WRF_FOLDER}"/GEOG/WPS_GEOG/fao "${WRF_FOLDER}"/GEOG/WPS_GEOG/irrigation

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_px.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_px.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_urban.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_urban.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_ssib.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_ssib.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/lake_depth.tar.bz2
		LD_LIBRARY_PATH= tar -xvf lake_depth.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/topobath_30s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf topobath_30s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/gsl_gwd.tar.bz2
		LD_LIBRARY_PATH= tar -xvf gsl_gwd.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/cglc_modis_lcz_global.tar.gz
		LD_LIBRARY_PATH= tar -xvf cglc_modis_lcz_global.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG
	fi

	if [ ${Optional_GEOG} -eq 1 ]; then
		echo " "
		echo "Optional WPS Geographical Input Data"
		echo " "

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_older_than_2000.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_older_than_2000.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/modis_landuse_20class_15s_with_lakes.tar.gz
		LD_LIBRARY_PATH= tar -xvzf modis_landuse_20class_15s_with_lakes.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_alt_lsm.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_alt_lsm.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/nlcd2006_ll_9s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf nlcd2006_ll_9s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/updated_Iceland_LU.tar.gz
		LD_LIBRARY_PATH= tar -xvf updated_Iceland_LU.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/modis_landuse_20class_15s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf modis_landuse_20class_15s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG
	fi
fi

if [ "$RHL_64bit_GNU" = "2" ] && [ "$WRF_PICK" = "1" ]; then

	#############################basic package managment############################
	echo "old version of GNU detected"
	echo $PASSWD | sudo -S yum install RHL-release-scl -y
	echo $PASSWD | sudo -S yum clean all
	echo $PASSWD | sudo -S yum remove devtoolset-11*
	echo $PASSWD | sudo -S yum install devtoolset-11
	echo $PASSWD | sudo -S yum install devtoolset-11-\* -y
	source /opt/rh/devtoolset-11/enable
	gcc --version
	echo $PASSWD | sudo -S yum install epel-release -y
	echo $PASSWD | sudo -S yum install dnf -y
	echo $PASSWD | sudo -S dnf install epel-release -y
	echo $PASSWD | sudo -S dnf install dnf -y
	echo $PASSWD | sudo -S dnf -y update
	echo $PASSWD | sudo -S dnf -y upgrade
	echo $PASSWD | sudo -S dnf -y install bzip2 bzip2-devel byacc cairo-devel cmake cpp curl curl-devel flex fontconfig-devel fontconfig-devel gcc gcc-c++ gcc-gfortran git java-11-openjdk java-11-openjdk-devel ksh libX11-devel libX11-devel libXaw libXaw-devel libXext-devel libXext-devel libXmu-devel libXrender-devel libXrender-devel libstdc++ libstdc++-devel libxml2 libxml2-devel m4 nfs-utils perl "perl(XML::LibXML)" pkgconfig pixman-devel python3 python3-devel tcsh time unzip wget
	echo $PASSWD | sudo -S dnf -y groupinstall "Development Tools"
	echo $PASSWD | sudo -S dnf -y update
	echo $PASSWD | sudo -S dnf -y upgrade

	echo " "
	##############################Directory Listing############################
	export HOME=$(
		cd
		pwd
	)

	mkdir $HOME/WRF
	export WRF_FOLDER=$HOME/WRF
	cd "${WRF_FOLDER}"/
	mkdir Downloads

	mkdir Libs
	export DIR="${WRF_FOLDER}"/Libs
	mkdir Libs/grib2
	mkdir Libs/NETCDF
	mkdir Libs/MPICH
	mkdir -p Tests/Environment
	mkdir -p Tests/Compatibility

	echo " "
	#############################Core Management####################################

	export CPU_CORE=$(nproc) # number of available threads on system
	export CPU_6CORE="6"
	export CPU_QUARTER=$(($CPU_CORE / 4))                          #quarter of availble cores on system
	export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2))) #Forces CPU cores to even number to avoid partial core export. ie 7 cores would be 3.5 cores.

	if [ $CPU_CORE -le $CPU_6CORE ]; then #If statement for low core systems.  Forces computers to only use 1 core if there are 4 cores or less on the system. then
		export CPU_QUARTER_EVEN="2"
	else
		export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))
	fi

	echo "##########################################"
	echo "Number of Threads being used $CPU_QUARTER_EVEN"
	echo "##########################################"

	echo " "
	##############################Downloading Libraries############################
	cd Downloads
	wget -c https://github.com/madler/zlib/releases/download/v$Zlib_Version/zlib-$Zlib_Version.tar.gz
	wget -c https://github.com/HDFGroup/hdf5/releases/download/hdf5_$HDF5_Version/hdf5-$HDF5_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-c/archive/refs/tags/v$Netcdf_C_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-fortran/archive/refs/tags/v$Netcdf_Fortran_Version.tar.gz
	wget -c https://github.com/pmodels/mpich/releases/download/v$Mpich_Version/mpich-$Mpich_Version.tar.gz
	wget -c https://download.sourceforge.net/libpng/libpng-$Libpng_Version.tar.gz
	wget -c https://www.ece.uvic.ca/~frodo/jasper/software/jasper-$Jasper_Version.zip
	wget -c https://parallel-netcdf.github.io/Release/pnetcdf-$Pnetcdf_Version.tar.gz

	echo " "
	####################################Compilers#####################################
	export CC=gcc
	export CXX=g++
	export FC=gfortran
	export F77=gfortran
	export CFLAGS="-fPIC -fPIE -O3"

	#IF statement for GNU compiler issue
	export GCC_VERSION=$(gcc -dumpfullversion | awk '{print$1}')
	export GFORTRAN_VERSION=$(gfortran -dumpfullversion | awk '{print$1}')
	export GPLUSPLUS_VERSION=$(g++ -dumpfullversion | awk '{print$1}')

	export GCC_VERSION_MAJOR_VERSION=$(echo $GCC_VERSION | awk -F. '{print $1}')
	export GFORTRAN_VERSION_MAJOR_VERSION=$(echo $GFORTRAN_VERSION | awk -F. '{print $1}')
	export GPLUSPLUS_VERSION_MAJOR_VERSION=$(echo $GPLUSPLUS_VERSION | awk -F. '{print $1}')

	export version_10="10"

	if [ $GCC_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GFORTRAN_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GPLUSPLUS_VERSION_MAJOR_VERSION -ge $version_10 ]; then
		export fallow_argument=-fallow-argument-mismatch
		export boz_argument=-fallow-invalid-boz
	else
		export fallow_argument=
		export boz_argument=
	fi

	export FFLAGS="$fallow_argument -m64"
	export FCFLAGS="$fallow_argument -m64"

	echo "##########################################"
	echo "FFLAGS = $FFLAGS"
	echo "FCFLAGS = $FCFLAGS"
	echo "CFLAGS = $CFLAGS"
	echo "##########################################"

	echo " "
	############################# ZLib ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf zlib-$Zlib_Version.tar.gz
	cd zlib-$Zlib_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	export ZLIB_ROOT=$DIR/grib2
	export ZLIBLIB=$DIR/grib2/lib
	export ZLIBINC=$DIR/grib2/include

	echo " "
	############################## MPICH ############################
	#F90= due to compiler issues with mpich install
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf mpich-$Mpich_Version.tar.gz
	cd mpich-$Mpich_Version/

	F90= ./configure --prefix=$DIR/MPICH --with-device=ch3 FFLAGS=$fallow_argument FCFLAGS=$fallow_argument 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/MPICH/bin:$PATH
	export MPIFC=$DIR/MPICH/bin/mpifort
	export MPIF77=$DIR/MPICH/bin/mpifort
	export MPIF90=$DIR/MPICH/bin/mpifort
	export MPICC=$DIR/MPICH/bin/mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx

	echo " "
	############################# libpng ############################

	cd "${WRF_FOLDER}"/Downloads

	# other libraries below need these variables to be set
	export LDFLAGS=-L$DIR/grib2/lib
	export CPPFLAGS=-I$DIR/grib2/include

	LD_LIBRARY_PATH= tar -xvzf libpng-$Libpng_Version.tar.gz
	cd libpng-$Libpng_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNG_ROOT=$DIR/grib2

	echo " "
	#############################JasPer ############################
	cd "${WRF_FOLDER}"/Downloads
	unzip jasper-$Jasper_Version.zip
	cd jasper-$Jasper_Version/

	./configure --prefix=$DIR/grib2
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export JASPERLIB=$DIR/grib2/lib
	export JASPERINC=$DIR/grib2/include
	export JASPER_DIR=$DIR/grib2
	export Jasper_ROOT=$DIR/grib2/lib

	echo " "
	############################# hdf5 library for netcdf4 functionality ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf hdf5-$HDF5_Version.tar.gz
	cd hdf5-$HDF5_Version

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --with-zlib=$DIR/grib2 --enable-hl --enable-fortran --enable-parallel 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export HDF5=$DIR/grib2
	export PATH=$HDF5/bin:$PATH
	export PHDF5=$DIR/grib2
	export HDF5_ROOT=$DIR/grib2
	export PHDF5_ROOT=$DIR/grib2

	echo " "
	############################# Install Parallel-netCDF ##############################
	#Make file created with half of available cpu cores
	#Hard path for MPI added
	##################################################################################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf pnetcdf-$Pnetcdf_Version.tar.gz
	cd pnetcdf-$Pnetcdf_Version
	export MPIFC=$DIR/MPICH/bin/mpifort
	export MPIF77=$DIR/MPICH/bin/mpifort
	export MPIF90=$DIR/MPICH/bin/mpifort
	export MPICC=$DIR/MPICH/bin/mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --enable-static 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNETCDF=$DIR/grib2
	export PNETCDF_DIR=$DIR/grib2
	export PNETCDF_ROOT=$DIR/grib2

	echo " "

	############################## Install NETCDF C Library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_C_Version.tar.gz
	cd netcdf-c-$Netcdf_C_Version/
	export CPPFLAGS=-I$DIR/grib2/include
	export LDFLAGS="-L$DIR/grib2/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lhdf5_hl -lhdf5 -lz -lcurl -lgfortran -lgcc -lm -ldl -lpnetcdf"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --disable-dap --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-pnetcdf --enable-cdf5 --enable-parallel-tests --enable-logging 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/NETCDF/bin:$PATH
	export NETCDF=$DIR/NETCDF
	export NETCDF_INC=$DIR/NETCDF/include
	export NETCDF_LIB=$DIR/NETCDF/lib
	export NETCDF_ROOT=$DIR/NETCDF
	export LD_LIBRARY_PATH=$DIR/grib2/lib:$DIR/NETCDF/lib:$LD_LIBRARY_PATH

	echo " "
	############################## NetCDF fortran library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_Fortran_Version.tar.gz
	cd netcdf-fortran-$Netcdf_Fortran_Version/
	export LD_LIBRARY_PATH=$DIR/NETCDF/lib:$LD_LIBRARY_PATH
	export CPPFLAGS="-I$DIR/NETCDF/include -I$DIR/grib2/include"
	export LDFLAGS="-L$DIR/NETCDF/lib -L$DIR/grib2/lib -Wl,-rpath,$DIR/NETCDF/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lnetcdf -lpnetcdf -lcurl -lhdf5_hl -lhdf5 -lz -lm -ldl -lgcc -lgfortran"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-parallel-tests --enable-logging --enable-hdf5 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	echo " "
	#################################### System Environment Tests ##############

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_NETCDF_MPI_tests.tar
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_tests.tar

	LD_LIBRARY_PATH= tar -xvf Fortran_C_tests.tar -C "${WRF_FOLDER}"/Tests/Environment
	LD_LIBRARY_PATH= tar -xvf Fortran_C_NETCDF_MPI_tests.tar -C "${WRF_FOLDER}"/Tests/Compatibility

	export one="1"
	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Environment

	cp ${NETCDF}/include/netcdf.inc .

	echo " "
	echo " "
	echo "Environment Testing "
	echo "Test 1"
	$FC TEST_1_fortran_only_fixed.f
	./a.out | tee env_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 1 Passed"
	else
		echo "Environment Compiler Test 1 Failed"
		exit
	fi
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 2"
	$FC TEST_2_fortran_only_free.f90
	./a.out | tee env_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 2 Passed"
	else
		echo "Environment Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 3"
	$CC TEST_3_c_only.c
	./a.out | tee env_test3.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test3.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 3 Passed"
	else
		echo "Environment Compiler Test 3 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 4"
	$CC -c -m64 TEST_4_fortran+c_c.c
	$FC -c -m64 TEST_4_fortran+c_f.f90
	$FC -m64 TEST_4_fortran+c_f.o TEST_4_fortran+c_c.o
	./a.out | tee env_test4.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test4.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 4 Passed"
	else
		echo "Environment Compiler Test 4 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Compatibility

	cp ${NETCDF}/include/netcdf.inc .

	echo " "
	echo " "
	echo "Library Compatibility Tests "
	echo "Test 1"
	$FC -c 01_fortran+c+netcdf_f.f
	$CC -c 01_fortran+c+netcdf_c.c
	$FC 01_fortran+c+netcdf_f.o 01_fortran+c+netcdf_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	./a.out | tee comp_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 1 Passed"
	else
		echo "Compatibility Compiler Test 1 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "

	echo "Test 2"
	$MPIFC -c 02_fortran+c+netcdf+mpi_f.f
	$MPICC -c 02_fortran+c+netcdf+mpi_c.c
	$MPIFC 02_fortran+c+netcdf+mpi_f.o \
		02_fortran+c+netcdf+mpi_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	$DIR/MPICH/bin/mpirun ./a.out | tee comp_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 2 Passed"
	else
		echo "Compatibility Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."
	echo " "

	echo " All tests completed and passed"
	echo " "

	################################ OpenGrADS ##################################
	#Verison 2.2.1 32bit of Linux
	#############################################################################
	if [[ $GRADS_PICK -eq 1 ]]; then
		cd "${WRF_FOLDER}"/Downloads
		LD_LIBRARY_PATH= tar -xvzf cd "${WRF_FOLDER}"/Downloads
		wget -c https://sourceforge.net/projects/opengrads/files/grads2/2.2.1.oga.1/Linux%20%2864%20Bits%29/opengrads-2.2.1.oga.1-bundle-x86_64-pc-linux-gnu-glibc_2.17.tar.gz
		LD_LIBRARY_PATH= tar -xvzf opengrads-2.2.1.oga.1-bundle-x86_64-pc-linux-gnu-glibc_2.17.tar.gz -C "${WRF_FOLDER}"/ -C "${WRF_FOLDER}"/
		cd "${WRF_FOLDER}"/
		mv "${WRF_FOLDER}"/opengrads-2.2.1.oga.1 "${WRF_FOLDER}"/GrADS
		cd GrADS/Contents
		wget -c https://github.com/regisgrundig/SIMOP/blob/master/g2ctl.pl
		chmod +x g2ctl.pl
		wget -c https://sourceforge.net/projects/opengrads/files/wgrib2/0.1.9.4/wgrib2-v0.1.9.4-bin-i686-glib2.5-linux-gnu.tar.gz
		LD_LIBRARY_PATH= tar -xvzf wgrib2-v0.1.9.4-bin-i686-glib2.5-linux-gnu.tar.gz
		cd wgrib2-v0.1.9.4/bin
		mv wgrib2 "${WRF_FOLDER}"/GrADS/Contents
		cd "${WRF_FOLDER}"/GrADS/Contents
		rm wgrib2-v0.1.9.4-bin-i686-glib2.5-linux-gnu.tar.gz
		rm -r wgrib2-v0.1.9.4

		export PATH="${WRF_FOLDER}"/GrADS/Contents:$PATH

		echo " "
	fi
	################################## GrADS ###############################
	# Version  2.2.1
	# Sublibs library instructions: http://cola.gmu.edu/grads/gadoc/supplibs2.html
	# GrADS instructions: http://cola.gmu.edu/grads/downloads.php
	########################################################################
	if [[ $GRADS_PICK -eq 2 ]]; then
		cd "${WRF_FOLDER}"/Downloads
		wget -c ftp://cola.gmu.edu/grads/2.2/grads-2.2.1-bin-RHL7.4-x86_64.tar.gz
		LD_LIBRARY_PATH= tar -xvzf grads-2.2.1-bin-RHL7.4-x86_64.tar.gz -C "${WRF_FOLDER}"
		cd "${WRF_FOLDER}"/grads-2.2.1/bin
		chmod 775 *

	fi

	##################### NCAR COMMAND LANGUAGE           ##################
	########### NCL compiled via Conda                    ##################
	########### This is the preferred method by NCAR      ##################
	########### https://www.ncl.ucar.edu/index.shtml      ##################
	#Installing Miniconda3 to WRF-Hydro directory and updating libraries

	echo $PASSWD | sudo -S dnf -y install python3-zstandard python3-zstd

	export Miniconda_Install_DIR="${WRF_FOLDER}"/miniconda3

	mkdir -p $Miniconda_Install_DIR

	wget -c https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O $Miniconda_Install_DIR/miniconda.sh
	bash $Miniconda_Install_DIR/miniconda.sh -b -u -p $Miniconda_Install_DIR

	rm -rf $Miniconda_Install_DIR/miniconda.sh

	export PATH="${WRF_FOLDER}"/miniconda3/bin:$PATH

	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	$Miniconda_Install_DIR/bin/conda init bash

	conda tos accept
	conda config --add channels conda-forge
	conda config --set auto_activate_base false
	conda update -n root --all -y

	echo " "

	echo " "
	#Installing NCL via Conda
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	conda create -n ncl_stable -c conda-forge ncl -y
	conda activate ncl_stable

	conda deactivate
	conda deactivate
	conda deactivate

	echo " "

	############################OBSGRID###############################
	## OBSGRID
	## Downloaded from git tagged releases
	## Option #2
	########################################################################
	cd "${WRF_FOLDER}"/
	git clone https://github.com/wrf-model/OBSGRID.git
	cd "${WRF_FOLDER}"/OBSGRID

	LD_LIBRARY_PATH= ./clean -a
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh
	conda activate ncl_stable

	export HOME=$(
		cd
		pwd
	)
	export DIR="${WRF_FOLDER}"/Libs
	export NETCDF=$DIR/NETCDF

	if [ ${auto_config} -eq 1 ]; then
		echo 2 | ./configure 2>&1 | tee configure.log #Option 2 for gfortran/gcc and distribunted memory
	else
		./configure 2>&1 | tee configure.log #Option 2 for gfortran/gcc and distribunted memory
	fi

	sed -i '27s/-lnetcdf -lnetcdff/ -lnetcdff -lnetcdf/g' configure.oa

	sed -i '31s/-lncarg -lncarg_gks -lncarg_c -lX11 -lm -lcairo/-lncarg -lncarg_gks -lncarg_c -lX11 -lm -lcairo -lfontconfig -lpixman-1 -lfreetype -lhdf5 -lhdf5_hl /g' configure.oa

	sed -i '39s/-frecord-marker=4/-frecord-marker=4 ${fallow_argument} /g' configure.oa

	sed -i '44s/=	/=	${fallow_argument} /g' configure.oa

	sed -i '45s/-C -P -traditional/-P -traditional/g' configure.oa

	echo " "
	LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.obsgrid.log

	conda deactivate
	conda deactivate
	conda deactivate

	echo " "
	# IF statement to check that all files were created.
	if [[ -x ./obsgrid.exe ]]; then
		echo "obsgrid.exe found."
		read -r -t 5 -p "Finished installing OBSGRID. I am going to wait for 5 seconds only ..."
	else
		echo "obsgrid.exe is missing. Attempting to compile again..."

		LD_LIBRARY_PATH= ./clean -a
		LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.obsgrid.retry.log

		if [[ -x ./obsgrid.exe ]]; then
			echo "obsgrid.exe successfully created after recompilation."
			read -r -t 5 -p "Finished retrying OBSGRID compile. I am going to wait for 5 seconds only ..."
		else
			echo "Still missing obsgrid.exe after recompile. Exiting the script."
			read -r -p "Please contact script authors for assistance. Press 'Enter' to exit."
			exit 1
		fi
	fi

	echo " "

	##################### WRF Python           ##################
	########### WRf-Python compiled via Conda  ##################
	########### This is the preferred method by NCAR      ##################
	##### https://wrf-python.readthedocs.io/en/latest/installation.html  ##################
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh
	conda env create -f $HOME/WRF-MOSIT/wrf-python-stable.yml

	echo " "

	############################ WRF #################################
	## WRF v${WPS_VERSION}
	## Downloaded from git tagged releases
	# option 34, option 1 for gfortran and distributed memory w/basic nesting
	# large file support enable with WRFiO_NCD_LARGE_FILE_SUPPORT=1
	# In the namelist.input, the following settings support pNetCDF by setting value to 11:
	# io_form_boundary
	# io_form_history
	# io_form_auxinput2
	# io_form_auxhist2
	# Note that you need set nocolons = .true. in the section &time_control of namelist.input
	########################################################################
	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/wrf-model/WRF/releases/download/v${WRF_VERSION}/v${WRF_VERSION}.tar.gz -O WRF-${WRF_VERSION}.tar.gz
	LD_LIBRARY_PATH= tar -xvzf WRF-${WRF_VERSION}.tar.gz -C "${WRF_FOLDER}"/

	# If statment for changing folder name
	# Check if WRF directory exists
	if [ -d "${WRF_FOLDER}/WRF" ]; then
		mv -f "${WRF_FOLDER}/WRF" "${WRF_FOLDER}/WRF-${WRF_VERSION}"

	# Else, check for any folder matching WRFV*
	else
		for dir in "${WRF_FOLDER}"/WRFV*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WRF-${WRF_VERSION}"
				break
			fi
		done
	fi

	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}
	export WRFIO_NCD_LARGE_FILE_SUPPORT=1
	LD_LIBRARY_PATH= ./clean -a

	if [ ${auto_config} -eq 1 ]; then
		(
			echo 34
			echo 1
		) | ./configure

	else
		./configure 2>&1 | tee configure.log #Option 34 gfortran compiler with distributed memory option 1 for basic nesting
	fi

	LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN em_real 2>&1 | tee compile.wrf1.log

	export WRF_DIR="${WRF_FOLDER}"/WRF-${WRF_VERSION}

	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/main
	n=$(ls ./*.exe | wc -l)
	if (($n >= 3)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}
		LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN em_real 2>&1 | tee compile.wrf2.log
		cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/main
		n=$(ls ./*.exe | wc -l)
		if (($n >= 3)); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	echo " "
	############################WPS#####################################
	## WPS v${WPS_VERSION}
	## Downloaded from git tagged releases
	#Option 3 for gfortran and distributed memory
	########################################################################

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/wrf-model/WPS/archive/refs/tags/v${WPS_VERSION}.tar.gz -O WPS-${WPS_VERSION}.tar.gz
	LD_LIBRARY_PATH= tar -xvzf WPS-${WPS_VERSION}.tar.gz -C "${WRF_FOLDER}"/
	# Check if WPS directory exists
	if [ -d "${WRF_FOLDER}/WPS" ]; then
		mv -f "${WRF_FOLDER}/WPS" "${WRF_FOLDER}/WPS-${WPS_VERSION}"

	# Else, check for any folder matching WPSV* or WPS-*
	else
		for dir in "${WRF_FOLDER}"/WPSV* "${WRF_FOLDER}"/WPS-*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WPS-${WPS_VERSION}"
				break
			fi
		done
	fi
	cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
	LD_LIBRARY_PATH= ./clean -a

	if [ ${auto_config} -eq 1 ]; then
		echo 3 | ./configure 2>&1 | tee configure.log #Option 3 for gfortran and distributed memory
	else
		./configure 2>&1 | tee configure.log #Option 3 gfortran compiler with distributed memory
	fi
	LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.wps.log

	echo " "
	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
	n=$(ls ./*.exe | wc -l)
	if (($n == 3)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WPS. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.wps2.log
		cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
		n=$(ls ./*.exe | wc -l)
		if (($n == 3)); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WPS. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	echo " "
	############################WRFPLUS 4DVAR###############################
	## WRFPLUS v${WPS_VERSION} 4DVAR
	## Downloaded from git tagged releases
	## WRFPLUS is built within the WRF git folder
	## Does not include RTTOV Libarary for radiation data.  If wanted will need to install library then reconfigure
	##Note: if you intend to run both 3DVAR and 4DVAR experiments, it is not necessary to compile the code twice.
	#Option 18 for gfortran/gcc and distribunted memory
	########################################################################
	cd "${WRF_FOLDER}"/Downloads
	mkdir "${WRF_FOLDER}"/WRFPLUS
	LD_LIBRARY_PATH= tar -xvzf WRF-${WRF_VERSION}.tar.gz -C "${WRF_FOLDER}"/WRFPLUS

	# If statement for changing folder name inside WRFPLUS
	if [ -d "${WRF_FOLDER}/WRFPLUS/WRF" ]; then
		mv -f "${WRF_FOLDER}/WRFPLUS/WRF" "${WRF_FOLDER}/WRFPLUS/WRF-${WRF_VERSION}"

	else
		for dir in "${WRF_FOLDER}/WRFPLUS"/WRFV*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WRFPLUS/WRF-${WRF_VERSION}"
				break
			fi
		done
	fi

	cd "${WRF_FOLDER}"/WRFPLUS/WRF-${WRF_VERSION}
	mv * "${WRF_FOLDER}"/WRFPLUS
	cd "${WRF_FOLDER}"/WRFPLUS
	rm -rf WRF-${WRF_VERSION}/
	export NETCDF=$DIR/NETCDF
	export HDF5=$DIR/grib2
	LD_LIBRARY_PATH= ./clean -a

	if [ ${auto_config} -eq 1 ]; then
		echo 18 | ./configure wrfplus 2>&1 | tee configure.log #Option 18 for gfortran/gcc and distribunted memory
	else
		./configure wrfplus 2>&1 | tee configure.log #Option 18 for gfortran/gcc and distribunted memory
	fi
	echo " "
	LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN wrfplus 2>&1 | tee compile.wrfplus.log
	export WRFPLUS_DIR="${WRF_FOLDER}"/WRFPLUS

	echo " "
	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WRFPLUS/main
	n=$(ls ./wrfplus.exe | wc -l)
	if (($n == 1)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WRF Plus 4DVAR. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		cd "${WRF_FOLDER}"/WRFPLUS/
		LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN wrfplus 2>&1 | tee compile.wrfplus2.log
		cd "${WRF_FOLDER}"/WRFPLUS/main
		n=$(ls ./wrfplus.exe | wc -l)
		if (($n == 1)); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WRF Plus 4DVAR. I am going to wait for 5 seconds only ..."
		else
			echo "Missing one or more expected files."
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	echo " "
	############################WRFDA 4DVAR###############################
	## WRFDA v${WPS_VERSION} 4DVAR
	## Downloaded from git tagged releases
	## WRFDA is built within the WRFPLUS folder
	## Does not include RTTOV Libarary for radiation data.  If wanted will need to install library then reconfigure
	##Note: if you intend to run both 3DVAR and 4DVAR experiments, it is not necessary to compile the code twice.
	#Option 18 for gfortran/gcc and distribunted memory
	########################################################################
	cd "${WRF_FOLDER}"/Downloads
	mkdir "${WRF_FOLDER}"/WRFDA
	LD_LIBRARY_PATH= tar -xvzf WRF-${WRF_VERSION}.tar.gz -C "${WRF_FOLDER}"/WRFDA

	# If statement for changing folder name inside WRFDA
	if [ -d "${WRF_FOLDER}/WRFDA/WRF" ]; then
		mv -f "${WRF_FOLDER}/WRFDA/WRF" "${WRF_FOLDER}/WRFDA/WRF-${WRF_VERSION}"

	else
		for dir in "${WRF_FOLDER}/WRFDA"/WRFV*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WRFDA/WRF-${WRF_VERSION}"
				break
			fi
		done
	fi

	cd "${WRF_FOLDER}"/WRFDA/WRF-${WRF_VERSION}
	mv * "${WRF_FOLDER}"/WRFDA
	cd "${WRF_FOLDER}"/WRFDA
	rm -rf WRF-${WRF_VERSION}/
	export NETCDF=$DIR/NETCDF
	export HDF5=$DIR/grib2
	export WRFPLUS_DIR="${WRF_FOLDER}"/WRFPLUS
	LD_LIBRARY_PATH= ./clean -a

	if [ ${auto_config} -eq 1 ]; then
		echo 18 | ./configure 4dvar 2>&1 | tee configure.log #Option 18 for gfortran/gcc and distribunted memory
	else
		./configure 4dvar 2>&1 | tee configure.log #Option 18 for gfortran/gcc and distribunted memory
	fi
	echo " "
	LD_LIBRARY_PATH= ./compile -j 2 all_wrfvar 2>&1 | tee compile.wrf4dvar.log
	echo " "
	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WRFDA/var/da
	n=$(ls ./*.exe | wc -l)
	cd "${WRF_FOLDER}"/WRFDA/var/obsproc/src
	m=$(ls ./*.exe | wc -l)
	if ((($n == 43) && ($m == 1))); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WRFDA. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		cd "${WRF_FOLDER}"/WRFDA
		LD_LIBRARY_PATH= ./compile -j 2 all_wrfvar 2>&1 | tee compile.chem.wrfvar2.log
		cd "${WRF_FOLDER}"/WRFDA/var/da
		n=$(ls ./*.exe | wc -l)
		cd "${WRF_FOLDER}"/WRFDA/var/obsproc/src
		m=$(ls ./*.exe | wc -l)
		if ((($n == 43) && ($m == 1))); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WRFDA. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi
	echo " "

	echo " "

	######################## Static Geography Data inc/ Optional ####################
	# http://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html
	# These files are large so if you only need certain ones comment the others off
	# All files downloaded and untarred is 200GB
	# https://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html
	#################################################################################
	cd "${WRF_FOLDER}"/Downloads
	mkdir "${WRF_FOLDER}"/GEOG
	mkdir "${WRF_FOLDER}"/GEOG/WPS_GEOG

	echo " "
	echo "Mandatory WRF Preprocessing System (WPS) Geographical Input Data Mandatory Fields Downloads"
	echo " "
	wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_high_res_mandatory.tar.gz
	LD_LIBRARY_PATH= tar -xvzf geog_high_res_mandatory.tar.gz -C "${WRF_FOLDER}"/GEOG/

	wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_low_res_mandatory.tar.gz
	LD_LIBRARY_PATH= tar -xvzf geog_low_res_mandatory.tar.gz -C "${WRF_FOLDER}"/GEOG/
	mv "${WRF_FOLDER}"/GEOG/WPS_GEOG_LOW_RES/ "${WRF_FOLDER}"/GEOG/WPS_GEOG

	if [ ${WPS_Specific_Applications} -eq 1 ]; then
		echo " "
		echo " WPS Geographical Input Data Mandatory for Specific Applications"
		echo " "

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_thompson28_chem.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_thompson28_chem.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_noahmp.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_noahmp.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/irrigation.tar.gz
		LD_LIBRARY_PATH= tar -xvzf irrigation.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG
		mkdir "${WRF_FOLDER}"/GEOG/WPS_GEOG/irrigation
		mv "${WRF_FOLDER}"/GEOG/WPS_GEOG/fao "${WRF_FOLDER}"/GEOG/WPS_GEOG/irrigation

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_px.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_px.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_urban.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_urban.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_ssib.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_ssib.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/lake_depth.tar.bz2
		LD_LIBRARY_PATH= tar -xvf lake_depth.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/topobath_30s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf topobath_30s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/gsl_gwd.tar.bz2
		LD_LIBRARY_PATH= tar -xvf gsl_gwd.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/cglc_modis_lcz_global.tar.gz
		LD_LIBRARY_PATH= tar -xvf cglc_modis_lcz_global.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG
	fi

	if [ ${Optional_GEOG} -eq 1 ]; then
		echo " "
		echo "Optional WPS Geographical Input Data"
		echo " "

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_older_than_2000.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_older_than_2000.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/modis_landuse_20class_15s_with_lakes.tar.gz
		LD_LIBRARY_PATH= tar -xvzf modis_landuse_20class_15s_with_lakes.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_alt_lsm.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_alt_lsm.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/nlcd2006_ll_9s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf nlcd2006_ll_9s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/updated_Iceland_LU.tar.gz
		LD_LIBRARY_PATH= tar -xvf updated_Iceland_LU.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/modis_landuse_20class_15s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf modis_landuse_20class_15s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG
	fi
fi

if [ "$RHL_64bit_Intel" = "1"] && [ "$WRF_PICK" ]; then

	#############################basic package managment############################
	echo $PASSWD | sudo -S yum install epel-release -y
	echo $PASSWD | sudo -S yum install dnf -y
	echo $PASSWD | sudo -S dnf install epel-release -y
	echo $PASSWD | sudo -S dnf install dnf -y
	echo $PASSWD | sudo -S dnf -y update
	echo $PASSWD | sudo -S dnf -y upgrade
	echo $PASSWD | sudo -S dnf -y install bzip2 bzip2-devel byacc cairo-devel cmake cpp curl curl-devel flex fontconfig-devel gcc-c++ gcc-gfortran git java-11-openjdk java-11-openjdk-devel ksh libX11-devel libXaw-devel libXext-devel libXrender-devel libstdc++-devel libxml2 libxml2-devel m4 nfs-utils perl "perl(XML::LibXML)" pkgconfig pixman-devel python3 python3-devel tcsh time unzip wget
	echo $PASSWD | sudo -S dnf -y groupinstall "Development Tools"

	# download the key to system keyring; this and the following echo command are
	# needed in order to install the Intel compilers

	echo $PASSWD | sudo bash -c 'printf "[oneAPI]\nname=Intel oneAPI repository\nbaseurl=https://yum.repos.intel.com/oneapi\nenabled=1\ngpgcheck=1\nrepo_gpgcheck=1\ngpgkey=https://yum.repos.intel.com/intel-gpg-keys/GPG-PUB-KEY-INTEL-SW-PRODUCTS.PUB\n" > /etc/yum.repos.d/oneAPI.repo'

	echo $PASSWD | sudo -S mv /tmp/oneAPI.repo /etc/yum.repos.d

	echo $PASSWD | sudo -S dnf install intel-cpp-essentials -y

	# install the Intel compilers
	echo $PASSWD | sudo -S dnf upgrade intel-cpp-essentials -y
	echo $PASSWD | sudo -S dnf install intel-oneapi-base-toolkit -y
	echo $PASSWD | sudo -S dnf install intel-oneapi-hpc-toolkit -y
	echo $PASSWD | sudo -S dnf install intel-oneapi-python -y

	echo $PASSWD | sudo -S dnf update
	echo $PASSWD | sudo -S dnf -y install cmake pkgconfig
	echo $PASSWD | sudo -S dnf groupinstall "Development Tools" -y

	echo $PASSWD | sudo -S dnf -y update
	echo $PASSWD | sudo -S dnf -y upgrade

	# add the Intel compiler file paths to various environment variables
	source /opt/intel/oneapi/setvars.sh --force

	# some of the libraries we install below need one or more of these variables

	export CC=icx
	export CXX=icpx
	export FC=ifx
	export F77=ifx
	export F90=ifx
	export MPIFC=mpiifx
	export MPIF77=mpiifx
	export MPIF90=mpiifx
	export MPICC=mpiicx
	export MPICXX=mpiicpx
	export CFLAGS="-fPIC -fPIE -O3 -Wno-implicit-function-declaration -Wno-incompatible-function-pointer-types -Wno-unused-command-line-argument"
	export FFLAGS="-m64"
	export FCFLAGS="-m64"

	############################# CPU Core Management ####################################

	export CPU_CORE=$(nproc) # number of available threads on system
	export CPU_6CORE="6"
	export CPU_QUARTER=$(($CPU_CORE / 4)) # quarter of availble cores on system
	# Forces CPU cores to even number to avoid partial core export. ie 7 cores would be 3.5 cores.
	export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))

	# If statement for low core systems.  Forces computers to only use 1 core if there are 4 cores or less on the system.
	if [ $CPU_CORE -le $CPU_6CORE ]; then
		export CPU_QUARTER_EVEN="2"
	else
		export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))
	fi

	echo "##########################################"
	echo "Number of Threads being used $CPU_QUARTER_EVEN"
	echo "##########################################"

	############################## Directory Listing ############################
	# makes necessary directories
	#
	############################################################################

	export HOME=$(
		cd
		pwd
	)
	export WRF_FOLDER=$HOME/WRF_Intel
	export DIR="${WRF_FOLDER}"/Libs
	mkdir "${WRF_FOLDER}"
	cd "${WRF_FOLDER}"
	mkdir Downloads

	mkdir Libs
	mkdir Libs/grib2
	mkdir Libs/NETCDF
	mkdir Libs/MPICH
	mkdir -p Tests/Environment
	mkdir -p Tests/Compatibility

	echo " "
	############################## Downloading Libraries ############################

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/madler/zlib/releases/download/v$Zlib_Version/zlib-$Zlib_Version.tar.gz
	wget -c https://github.com/HDFGroup/hdf5/releases/download/hdf5_$HDF5_Version/hdf5-$HDF5_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-c/archive/refs/tags/v$Netcdf_C_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-fortran/archive/refs/tags/v$Netcdf_Fortran_Version.tar.gz
	wget -c https://download.sourceforge.net/libpng/libpng-$Libpng_Version.tar.gz
	wget -c https://www.ece.uvic.ca/~frodo/jasper/software/jasper-$Jasper_Version.zip
	wget -c https://parallel-netcdf.github.io/Release/pnetcdf-$Pnetcdf_Version.tar.gz

	echo " "

	############################# ZLib ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf zlib-$Zlib_Version.tar.gz
	cd zlib-$Zlib_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	export ZLIB_ROOT=$DIR/grib2
	export ZLIBLIB=$DIR/grib2/lib
	export ZLIBINC=$DIR/grib2/include

	echo " "
	############################# LibPNG ############################

	cd "${WRF_FOLDER}"/Downloads

	# other libraries below need these variables to be set
	export LDFLAGS=-L$DIR/grib2/lib
	export CPPFLAGS=-I$DIR/grib2/include

	LD_LIBRARY_PATH= tar -xvzf libpng-$Libpng_Version.tar.gz
	cd libpng-$Libpng_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNG_ROOT=$DIR/grib2

	echo " "
	############################# JasPer ############################

	cd "${WRF_FOLDER}"/Downloads
	unzip jasper-$Jasper_Version.zip
	cd jasper-$Jasper_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	# other libraries below need these variables to be set
	export JASPERLIB=$DIR/grib2/lib
	export JASPERINC=$DIR/grib2/include
	export JASPER_DIR=$DIR/grib2
	export Jasper_ROOT=$DIR/grib2/lib

	echo " "
	############################# HDF5 library for NetCDF4 & parallel functionality ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf hdf5-$HDF5_Version.tar.gz
	cd hdf5-$HDF5_Version

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --with-zlib=$DIR/grib2 --enable-hl --enable-fortran --enable-parallel 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	# other libraries below need these variables to be set
	export HDF5=$DIR/grib2
	export PATH=$HDF5/bin:$PATH
	export PHDF5=$DIR/grib2
	export HDF5_ROOT=$DIR/grib2
	export PHDF5_ROOT=$DIR/grib2

	echo " "

	############################# Install Parallel-netCDF ##############################
	#Make file created with half of available cpu cores
	#Hard path for MPI added
	##################################################################################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf pnetcdf-$Pnetcdf_Version.tar.gz
	cd pnetcdf-$Pnetcdf_Version
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --enable-static 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	#make check

	export PNETCDF=$DIR/grib2
	export PNETCDF_DIR=$DIR/grib2
	export PNETCDF_ROOT=$DIR/grib2

	echo " "

	############################## Install NETCDF-C Library ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_C_Version.tar.gz
	cd netcdf-c-$Netcdf_C_Version/

	# these variables need to be set for the NetCDF-C install to work
	export CPPFLAGS=-I$DIR/grib2/include
	export LDFLAGS="-L$DIR/grib2/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lhdf5_hl -lhdf5 -lz -lcurl -lgcc -lm -ldl -lpnetcdf"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --disable-dap --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-pnetcdf --enable-cdf5 --enable-parallel-tests --enable-logging 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	# other libraries below need these variables to be set
	export PATH=$DIR/NETCDF/bin:$PATH
	export NETCDF=$DIR/NETCDF
	export NETCDF_INC=$DIR/NETCDF/include
	export NETCDF_LIB=$DIR/NETCDF/lib
	export NETCDF_ROOT=$DIR/NETCDF
	export LD_LIBRARY_PATH=$DIR/grib2/lib:$DIR/NETCDF/lib:$LD_LIBRARY_PATH

	echo " "
	############################## NetCDF-Fortran library ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_Fortran_Version.tar.gz
	cd netcdf-fortran-$Netcdf_Fortran_Version/

	# these variables need to be set for the NetCDF-Fortran install to work
	export LD_LIBRARY_PATH=$DIR/NETCDF/lib:$LD_LIBRARY_PATH
	export CPPFLAGS="-I$DIR/NETCDF/include -I$DIR/grib2/include"
	export LDFLAGS="-L$DIR/NETCDF/lib -L$DIR/grib2/lib -Wl,-rpath,$DIR/NETCDF/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lnetcdf -lpnetcdf -lcurl -lhdf5_hl -lhdf5 -lz -lm -ldl -lgcc"
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --enable-netcdf-4 --enable-netcdf4 --enable-parallel-tests --enable-logging --enable-hdf5 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	echo " "
	#################################### System Environment Tests ##############

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_NETCDF_MPI_tests.tar
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_tests.tar

	LD_LIBRARY_PATH= tar -xvf Fortran_C_tests.tar -C "${WRF_FOLDER}/Tests/Environment"
	LD_LIBRARY_PATH= tar -xvf Fortran_C_NETCDF_MPI_tests.tar -C "${WRF_FOLDER}"/Tests/Compatibility

	export one="1"
	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Environment

	echo " "
	echo " "
	echo "Environment Testing "
	echo "Test 1"
	$FC TEST_1_fortran_only_fixed.f
	./a.out | tee env_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 1 Passed"
	else
		echo "Environment Compiler Test 1 Failed"
		exit
	fi
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 2"
	$FC TEST_2_fortran_only_free.f90
	./a.out | tee env_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 2 Passed"
	else
		echo "Environment Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 3"
	$CC TEST_3_c_only.c
	./a.out | tee env_test3.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test3.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 3 Passed"
	else
		echo "Environment Compiler Test 3 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 4"
	$CC -c -m64 TEST_4_fortran+c_c.c
	$FC -c -m64 TEST_4_fortran+c_f.f90
	$FC -m64 TEST_4_fortran+c_f.o TEST_4_fortran+c_c.o
	./a.out | tee env_test4.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test4.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 4 Passed"
	else
		echo "Environment Compiler Test 4 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Compatibility

	cp ${NETCDF}/include/netcdf.inc .

	echo " "
	echo " "
	echo "Library Compatibility Tests "
	echo "Test 1"
	$FC -c 01_fortran+c+netcdf_f.f
	$CC -c 01_fortran+c+netcdf_c.c
	$FC 01_fortran+c+netcdf_f.o 01_fortran+c+netcdf_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	./a.out | tee comp_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 1 Passed"
	else
		echo "Compatibility Compiler Test 1 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "

	echo "Test 2"
	$MPIFC -c 02_fortran+c+netcdf+mpi_f.f
	$MPICC -c 02_fortran+c+netcdf+mpi_c.c
	$MPIFC 02_fortran+c+netcdf+mpi_f.o \
		02_fortran+c+netcdf+mpi_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	mpirun ./a.out | tee comp_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 2 Passed"
	else
		echo "Compatibility Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."
	echo " "

	echo " All tests completed and passed"
	echo " "

	################################OpenGrADS######################################
	#Verison 2.2.1 64bit of Linux
	#############################################################################
	if [[ $GRADS_PICK -eq 1 ]]; then
		cd "${WRF_FOLDER}"/Downloads
		LD_LIBRARY_PATH LD_LIBRARY_PATH= tar -xvzf cd "${WRF_FOLDER}"/Downloads
		wget -c https://sourceforge.net/projects/opengrads/files/grads2/2.2.1.oga.1/Linux%20%2864%20Bits%29/opengrads-2.2.1.oga.1-bundle-x86_64-pc-linux-gnu-glibc_2.17.tar.gz
		LD_LIBRARY_PATH= tar -xvzf opengrads-2.2.1.oga.1-bundle-x86_64-pc-linux-gnu-glibc_2.17.tar.gz -C "${WRF_FOLDER}"/ -C "${WRF_FOLDER}"/
		cd "${WRF_FOLDER}"/
		mv "${WRF_FOLDER}"/opengrads-2.2.1.oga.1 "${WRF_FOLDER}"/GrADS
		cd GrADS/Contents
		wget -c https://github.com/regisgrundig/SIMOP/blob/master/g2ctl.pl
		chmod +x g2ctl.pl
		wget -c https://sourceforge.net/projects/opengrads/files/wgrib2/0.1.9.4/wgrib2-v0.1.9.4-bin-x86_64-glibc2.5-linux-gnu.tar.gz
		LD_LIBRARY_PATH= tar -xvzf wgrib2-v0.1.9.4-bin-x86_64-glibc2.5-linux-gnu.tar.gz
		cd wgrib2-v0.1.9.4/bin
		mv wgrib2 "${WRF_FOLDER}"/GrADS/Contents
		cd "${WRF_FOLDER}"/GrADS/Contents
		rm wgrib2-v0.1.9.4-bin-x86_64-glibc2.5-linux-gnu.tar.gz
		rm -r wgrib2-v0.1.9.4

		export PATH="${WRF_FOLDER}"/GrADS/Contents:$PATH
	fi
	################################## GrADS ###############################
	# Version  2.2.1
	# Sublibs library instructions: http://cola.gmu.edu/grads/gadoc/supplibs2.html
	# GrADS instructions: http://cola.gmu.edu/grads/downloads.php
	########################################################################
	if [[ $GRADS_PICK -eq 2 ]]; then
		cd "${WRF_FOLDER}"/Downloads
		wget -c ftp://cola.gmu.edu/grads/2.2/grads-2.2.1-bin-centos7.4-x86_64.tar.gz
		LD_LIBRARY_PATH LD_LIBRARY_PATH= tar -xvzf grads-2.2.1-bin-centos7.4-x86_64.tar.gz -C "${WRF_FOLDER}"
		cd "${WRF_FOLDER}"/grads-2.2.1/bin
		chmod 775 *

	fi

	##################### NCAR COMMAND LANGUAGE           ##################
	########### NCL compiled via Conda                    ##################
	########### This is the preferred method by NCAR      ##################
	########### https://www.ncl.ucar.edu/index.shtml      ##################
	echo " "
	echo " "
	#Installing Miniconda3 to WRF directory and updating libraries

	echo $PASSWD | sudo -S dnf -y install python3-zstandard python3-zstd

	export Miniconda_Install_DIR="${WRF_FOLDER}"/miniconda3

	mkdir -p $Miniconda_Install_DIR

	wget -c https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O $Miniconda_Install_DIR/miniconda.sh
	bash $Miniconda_Install_DIR/miniconda.sh -b -u -p $Miniconda_Install_DIR

	rm -rf $Miniconda_Install_DIR/miniconda.sh

	export PATH="${WRF_FOLDER}"/miniconda3/bin:$PATH

	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	$Miniconda_Install_DIR/bin/conda init bash

	conda tos accept
	conda config --add channels conda-forge
	conda config --set auto_activate_base false
	conda update -n root --all -y

	#Special Thanks to @_WaylonWalker for code development
	echo " "
	#Installing NCL via Conda
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	conda create -n ncl_stable -c conda-forge ncl -y
	conda activate ncl_stable
	conda deactivate
	conda deactivate
	conda deactivate

	echo " "

	############################OBSGRID###############################
	## OBSGRID
	## Downloaded from git tagged releases
	## Option #3
	########################################################################
	cd "${WRF_FOLDER}"/
	git clone https://github.com/wrf-model/OBSGRID.git
	cd "${WRF_FOLDER}"/OBSGRID

	LD_LIBRARY_PATH= ./clean -a
	conda activate ncl_stable

	export HOME=$(
		cd
		pwd
	)
	export DIR="${WRF_FOLDER}"/Libs
	export NETCDF=$DIR/NETCDF

	if [ ${auto_config} -eq 1 ]; then
		echo 3 | ./configure 2>&1 | tee configure.log #Option 3 for itnel and distribunted memory
	else
		./configure 2>&1 | tee configure.log #Option 3 for intel and distribunted memory
	fi

	sed -i '27s/-lnetcdf -lnetcdff/ -lnetcdff -lnetcdf/g' configure.oa

	sed -i '31s/-lncarg -lncarg_gks -lncarg_c -lX11 -lm -lcairo/-lncarg -lncarg_gks -lncarg_c -lX11 -lm -lcairo -lfontconfig -lpixman-1 -lfreetype -lhdf5 -lhdf5_hl /g' configure.oa

	sed -i '38s/ifort/ifx/g' configure.oa
	sed -i '43s/gcc/icx/g' configure.oa
	sed -i '45s|/lib/cpp|ifx|g' configure.oa
	sed -i '46s|-I. -C -P -DDEC -traditional|-fpp -DDEC -I.|g' configure.oa

	# Patch .F90.o rule to use direct compile with Intel Fortran + fpp
	sed -i '/^\.F90\.o:/,/^\t\$(RM) \$\*\.f/ c\.F90.o:\n\t$(RM) $@ $*.mod\n\t$(FC) $(FFLAGS) -fpp $(CPPFLAGS) ${NETCDF_INC} -c $<' configure.oa

	echo " "
	LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.obsgrid.log

	conda deactivate
	conda deactivate
	conda deactivate

	echo " "
	# IF statement to check that all files were created.
	if [[ -x ./obsgrid.exe ]]; then
		echo "obsgrid.exe found."
		read -r -t 5 -p "Finished installing OBSGRID. I am going to wait for 5 seconds only ..."
	else
		echo "obsgrid.exe is missing. Attempting to compile again..."

		LD_LIBRARY_PATH= ./clean -a
		LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.obsgrid.retry.log

		if [[ -x ./obsgrid.exe ]]; then
			echo "obsgrid.exe successfully created after recompilation."
			read -r -t 5 -p "Finished retrying OBSGRID compile. I am going to wait for 5 seconds only ..."
		else
			echo "Still missing obsgrid.exe after recompile. Exiting the script."
			read -r -p "Please contact script authors for assistance. Press 'Enter' to exit."
			exit 1
		fi
	fi

	echo " "

	##################### WRF Python           ##################
	########### WRf-Python compiled via Conda  ##################
	########### This is the preferred method by NCAR      ##################
	##### https://wrf-python.readthedocs.io/en/latest/installation.html  ##################
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh
	conda env create -f $HOME/WRF-MOSIT/wrf-python-stable.yml

	######################### Climate Data Operators ############
	######################### CDO compiled via Conda ###########
	####################### This is the preferred method #######
	################### https://bairdlangenbrunner.github.io/python-for-climate-scientists/conda/setting-up-conda-environments.html #######################

	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	conda create --name cdo_stable -y
	conda activate cdo_stable
	conda install -c conda-forge cdo -y
	conda update --all -y
	conda deactivate
	conda deactivate
	conda deactivate

	echo " "

	############################ WRF #################################
	## WRF v${WPS_VERSION}
	## Downloaded from git tagged releases
	# option 78, option 1 for intel and distributed memory w/basic nesting
	# large file support enable with WRFiO_NCD_LARGE_FILE_SUPPORT=1
	########################################################################

	source /opt/intel/oneapi/setvars.sh --force

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/wrf-model/WRF/releases/download/v${WRF_VERSION}/v${WRF_VERSION}.tar.gz -O WRF-${WRF_VERSION}.tar.gz
	LD_LIBRARY_PATH= tar -xvzf WRF-${WRF_VERSION}.tar.gz -C "${WRF_FOLDER}"/

	# If statment for changing folder name
	# Check if WRF directory exists
	if [ -d "${WRF_FOLDER}/WRF" ]; then
		mv -f "${WRF_FOLDER}/WRF" "${WRF_FOLDER}/WRF-${WRF_VERSION}"

	# Else, check for any folder matching WRFV*
	else
		for dir in "${WRF_FOLDER}"/WRFV*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WRF-${WRF_VERSION}"
				break
			fi
		done
	fi

	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}
	export WRFIO_NCD_LARGE_FILE_SUPPORT=1
	LD_LIBRARY_PATH= ./clean -a

	if [ ${auto_config} -eq 1 ]; then
		(
			echo 78
			echo 1
		) | ./configure

	else
		./configure 2>&1 | tee configure.log #option 78 intel compiler with distributed memory option 1 for basic nesting
	fi

	#Need to remove mpich/GNU config calls to Intel config calls
	sed -i '136s|mpif90 -f90=$(SFC)|mpiifx|g' "${WRF_FOLDER}"/WRF-${WRF_VERSION}/configure.wrf
	sed -i '137s|mpicc -cc=$(SCC)|mpiicx|g' "${WRF_FOLDER}"/WRF-${WRF_VERSION}/configure.wrf

	LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN em_real 2>&1 | tee compile.wrf1.log

	export WRF_DIR="${WRF_FOLDER}"/WRF-${WRF_VERSION}

	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/main
	n=$(ls ./*.exe | wc -l)
	if (($n >= 3)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}
		LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN em_real 2>&1 | tee compile.wrf2.log
		cd "${WRF_FOLDER}"/WRF-${WRF_VERSION}/main
		n=$(ls ./*.exe | wc -l)
		if (($n >= 3)); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WRF. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	echo " "
	############################WPS#####################################
	## WPS v${WPS_VERSION}
	## Downloaded from git tagged releases
	#Option 19 for gfortran and distributed memory
	########################################################################

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://github.com/wrf-model/WPS/archive/refs/tags/v${WPS_VERSION}.tar.gz -O WPS-${WPS_VERSION}.tar.gz
	LD_LIBRARY_PATH= tar -xvzf WPS-${WPS_VERSION}.tar.gz -C "${WRF_FOLDER}"/
	# Check if WPS directory exists
	if [ -d "${WRF_FOLDER}/WPS" ]; then
		mv -f "${WRF_FOLDER}/WPS" "${WRF_FOLDER}/WPS-${WPS_VERSION}"

	# Else, check for any folder matching WPSV* or WPS-*
	else
		for dir in "${WRF_FOLDER}"/WPSV* "${WRF_FOLDER}"/WPS-*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WPS-${WPS_VERSION}"
				break
			fi
		done
	fi
	cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
	LD_LIBRARY_PATH= ./clean -a

	sed -i '77s|real ::|integer ::|g' "${WRF_FOLDER}"/WPS-${WPS_VERSION}/ungrib/src/rd_grib2.F

	if [ ${auto_config} -eq 1 ]; then
		echo 19 | ./configure 2>&1 | tee configure.log #Option 19 for intel and distributed memory
	else
		./configure 2>&1 | tee configure.log #Option 19 intel compiler with distributed memory
	fi

	sed -i '67s|mpif90|mpiifx|g' "${WRF_FOLDER}"/WPS-${WPS_VERSION}/configure.wps
	sed -i '68s|mpicc|mpiicx|g' "${WRF_FOLDER}"/WPS-${WPS_VERSION}/configure.wps

	LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.wps.log

	echo " "
	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
	n=$(ls ./*.exe | wc -l)
	if (($n == 3)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WPS. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		LD_LIBRARY_PATH= ./compile 2>&1 | tee compile.wps2.log
		cd "${WRF_FOLDER}"/WPS-${WPS_VERSION}
		n=$(ls ./*.exe | wc -l)
		if (($n == 3)); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WPS. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	echo " "
	############################WRFPLUS 4DVAR###############################
	## WRFPLUS v${WPS_VERSION} 4DVAR
	## Downloaded from git tagged releases
	## WRFPLUS is built within the WRF git folder
	## Does not include RTTOV Libarary for radiation data.  If wanted will need to install library then reconfigure
	##Note: if you intend to run both 3DVAR and 4DVAR experiments, it is not necessary to compile the code twice.
	#Option 40 for intel and distribunted memory
	########################################################################
	cd "${WRF_FOLDER}"/Downloads
	mkdir "${WRF_FOLDER}"/WRFPLUS
	LD_LIBRARY_PATH= tar -xvzf WRF-${WRF_VERSION}.tar.gz -C "${WRF_FOLDER}"/WRFPLUS

	# If statement for changing folder name inside WRFPLUS
	if [ -d "${WRF_FOLDER}/WRFPLUS/WRF" ]; then
		mv -f "${WRF_FOLDER}/WRFPLUS/WRF" "${WRF_FOLDER}/WRFPLUS/WRF-${WRF_VERSION}"

	else
		for dir in "${WRF_FOLDER}/WRFPLUS"/WRFV*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WRFPLUS/WRF-${WRF_VERSION}"
				break
			fi
		done
	fi

	cd "${WRF_FOLDER}"/WRFPLUS/WRF-${WRF_VERSION}
	mv * "${WRF_FOLDER}"/WRFPLUS
	cd "${WRF_FOLDER}"/WRFPLUS
	rm -rf WRF-${WRF_VERSION}/
	export NETCDF=$DIR/NETCDF
	export HDF5=$DIR/grib2
	LD_LIBRARY_PATH= ./clean -a

	if [ ${auto_config} -eq 1 ]; then
		echo 40 | ./configure wrfplus 2>&1 | tee configure.log #Option 40 for intel and distribunted memory
	else
		./configure wrfplus 2>&1 | tee configure.log #Option 40 for intel and distribunted memory
	fi
	echo " "

	sed -i '136s|mpif90 -f90=$(SFC)|mpiifx|g' "${WRF_FOLDER}"/WRFPLUS/configure.wrf
	sed -i '137s|mpicc -cc=$(SCC)|mpiicx|g' "${WRF_FOLDER}"/WRFPLUS/configure.wrf

	LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN wrfplus 2>&1 | tee wrfplus1.compile.log

	export WRFPLUS_DIR="${WRF_FOLDER}"/WRFPLUS

	echo " "

	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WRFPLUS/main
	n=$(ls ./wrfplus.exe | wc -l)
	if (($n == 1)); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WRF Plus 4DVAR. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		cd "${WRF_FOLDER}"/WRFPLUS/
		LD_LIBRARY_PATH= ./compile -j $CPU_QUARTER_EVEN wrfplus 2>&1 | tee compile.wrfplus2.log
		cd "${WRF_FOLDER}"/WRFPLUS/main
		n=$(ls ./wrfplus.exe | wc -l)
		if (($n == 1)); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WRF Plus 4DVAR. I am going to wait for 5 seconds only ..."
		else
			echo "Missing one or more expected files."
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi

	echo " "

	############################WRFDA 4DVAR###############################
	## WRFDA v${WPS_VERSION} 4DVAR
	## Downloaded from git tagged releases
	## WRFDA is built within the WRFPLUS folder
	## Does not include RTTOV Libarary for radiation data.  If wanted will need to install library then reconfigure
	##Note: if you intend to run both 3DVAR and 4DVAR experiments, it is not necessary to compile the code twice.
	#Option 40 for intel and distribunted memory
	########################################################################
	cd "${WRF_FOLDER}"/Downloads
	mkdir "${WRF_FOLDER}"/WRFDA
	LD_LIBRARY_PATH= tar -xvzf WRF-${WRF_VERSION}.tar.gz -C "${WRF_FOLDER}"/WRFDA

	# If statement for changing folder name inside WRFDA
	if [ -d "${WRF_FOLDER}/WRFDA/WRF" ]; then
		mv -f "${WRF_FOLDER}/WRFDA/WRF" "${WRF_FOLDER}/WRFDA/WRF-${WRF_VERSION}"

	else
		for dir in "${WRF_FOLDER}/WRFDA"/WRFV*; do
			if [ -d "$dir" ]; then
				mv -f "$dir" "${WRF_FOLDER}/WRFDA/WRF-${WRF_VERSION}"
				break
			fi
		done
	fi

	cd "${WRF_FOLDER}"/WRFDA/WRF-${WRF_VERSION}
	mv * "${WRF_FOLDER}"/WRFDA
	cd "${WRF_FOLDER}"/WRFDA
	rm -rf WRF-${WRF_VERSION}/
	export NETCDF=$DIR/NETCDF
	export HDF5=$DIR/grib2
	export WRFPLUS_DIR="${WRF_FOLDER}"/WRFPLUS
	LD_LIBRARY_PATH= ./clean -a

	if [ ${auto_config} -eq 1 ]; then
		echo 40 | ./configure 4dvar 2>&1 | tee configure.log #Option 40 for intel and distribunted memory
	else
		./configure 4dvar 2>&1 | tee configure.log #Option 40 for intel and distribunted memory
	fi
	echo " "

	sed -i '136s|mpif90 -f90=$(SFC)|mpiifx|g' "${WRF_FOLDER}"/WRFDA/configure.wrf
	sed -i '137s|mpicc -cc=$(SCC)|mpiicx|g' "${WRF_FOLDER}"/WRFDA/configure.wrf

	LD_LIBRARY_PATH= ./compile -j 2 all_wrfvar 2>&1 | tee wrfda.compile.log
	echo " "

	# IF statement to check that all files were created.
	cd "${WRF_FOLDER}"/WRFDA/var/da
	n=$(ls ./*.exe | wc -l)
	cd "${WRF_FOLDER}"/WRFDA/var/obsproc/src
	m=$(ls ./*.exe | wc -l)
	if ((($n == 43) && ($m == 1))); then
		echo "All expected files created."
		read -r -t 5 -p "Finished installing WRFDA-4DVAR. I am going to wait for 5 seconds only ..."
	else
		echo "Missing one or more expected files."
		echo "Running compiler again"
		cd "${WRF_FOLDER}"/WRFDA
		LD_LIBRARY_PATH= ./compile -j 2 all_wrfvar 2>&1 | tee compile.chem.wrfvar2.log
		cd "${WRF_FOLDER}"/WRFDA/var/da
		n=$(ls ./*.exe | wc -l)
		cd "${WRF_FOLDER}"/WRFDA/var/obsproc/src
		m=$(ls ./*.exe | wc -l)
		if ((($n == 43) && ($m == 1))); then
			echo "All expected files created."
			read -r -t 5 -p "Finished installing WRFDA. I am going to wait for 5 seconds only ..."
		else
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
			exit
		fi
	fi
	echo " "

	######################## Static Geography Data inc/ Optional ####################
	# http://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html
	# These files are large so if you only need certain ones comment the others off
	# All files downloaded and untarred is 200GB
	# https://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html
	#################################################################################
	cd "${WRF_FOLDER}"/Downloads
	mkdir "${WRF_FOLDER}"/GEOG
	mkdir "${WRF_FOLDER}"/GEOG/WPS_GEOG

	echo " "
	echo "Mandatory WRF Preprocessing System (WPS) Geographical Input Data Mandatory Fields Downloads"
	echo " "
	wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_high_res_mandatory.tar.gz
	LD_LIBRARY_PATH= tar -xvzf geog_high_res_mandatory.tar.gz -C "${WRF_FOLDER}"/GEOG/

	wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_low_res_mandatory.tar.gz
	LD_LIBRARY_PATH= tar -xvzf geog_low_res_mandatory.tar.gz -C "${WRF_FOLDER}"/GEOG/
	mv "${WRF_FOLDER}"/GEOG/WPS_GEOG_LOW_RES/ "${WRF_FOLDER}"/GEOG/WPS_GEOG

	if [ ${WPS_Specific_Applications} -eq 1 ]; then
		echo " "
		echo " WPS Geographical Input Data Mandatory for Specific Applications"
		echo " "

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_thompson28_chem.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_thompson28_chem.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_noahmp.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_noahmp.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/irrigation.tar.gz
		LD_LIBRARY_PATH= tar -xvzf irrigation.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_px.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_px.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_urban.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_urban.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_ssib.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_ssib.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/lake_depth.tar.bz2
		LD_LIBRARY_PATH= tar -xvf lake_depth.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/topobath_30s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf topobath_30s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/gsl_gwd.tar.bz2
		LD_LIBRARY_PATH= tar -xvf gsl_gwd.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/cglc_modis_lcz_global.tar.gz
		LD_LIBRARY_PATH= tar -xvf cglc_modis_lcz_global.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG
	fi

	if [ ${Optional_GEOG} -eq 1 ]; then
		echo " "
		echo "Optional WPS Geographical Input Data"
		echo " "

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_older_than_2000.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_older_than_2000.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/modis_landuse_20class_15s_with_lakes.tar.gz
		LD_LIBRARY_PATH= tar -xvzf modis_landuse_20class_15s_with_lakes.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/geog_alt_lsm.tar.gz
		LD_LIBRARY_PATH= tar -xvzf geog_alt_lsm.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/nlcd2006_ll_9s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf nlcd2006_ll_9s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/updated_Iceland_LU.tar.gz
		LD_LIBRARY_PATH= tar -xvf updated_Iceland_LU.tar.gz -C "${WRF_FOLDER}"/GEOG/WPS_GEOG

		wget -c https://www2.mmm.ucar.edu/wrf/src/wps_files/modis_landuse_20class_15s.tar.bz2
		LD_LIBRARY_PATH= tar -xvf modis_landuse_20class_15s.tar.bz2 -C "${WRF_FOLDER}"/GEOG/WPS_GEOG
	fi

fi

########################### COAWST: A Coupled-Ocean-Atmosphere-Wave-Sediment Transport Modeling System ############################
#COAWST installation with parallel process.
#Tested in Ubuntu 22.04 & 24.04, Rocky Linux 9 & MacOS Ventura 64bit
#Built in 64-bit system
#Built with GNU compilers
#Tested with current available libraries on 03/01/2025
#If newer libraries exist edit script paths for changes
#Estimated Run Time ~ 90 - 150 Minutes with 10mb/s downloadspeed.
#Special thanks to:
#USGS's Dr. John Warner
###################################################################################################################################

if [ "$Ubuntu_64bit_GNU" = "1" ] && [ "$COAWST_Pick" = "1" ]; then
	#############################basic package managment############################
	echo $PASSWD | sudo -S apt -y update
	echo $PASSWD | sudo -S apt -y upgrade

	release_version=$(lsb_release -r -s)

	# Compare the release version
	if [ "$release_version" = "24.04" ]; then
		# Install Emacs without recommended packages
		echo $PASSWD | sudo -S apt install emacs --no-install-recommends -y
	else
		# Attempt to install Emacs if the release version is not 24.04
		echo "The release version is not 24.04, attempting to install Emacs."
		echo $PASSWD | sudo -S apt install emacs -y
	fi

	echo $PASSWD | sudo -S apt -y install bison build-essential byacc cmake csh curl default-jdk default-jre flex libfl-dev g++ gawk gcc gettext gfortran git ksh libcurl4-gnutls-dev libjpeg-dev libncurses6 libpixman-1-dev libpng-dev libtool libxml2 libxml2-dev libxml-libxml-perl m4 make ncview pipenv pkg-config python3 python3-dev python3-pip python3-dateutil tcsh unzip xauth xorg time

	echo " "
	##############################Directory Listing############################
	export HOME=$(
		cd
		pwd
	)

	mkdir $HOME/COAWST
	export WRF_FOLDER=$HOME/COAWST
	cd "${WRF_FOLDER}"/
	mkdir Downloads

	mkdir Libs
	export DIR="${WRF_FOLDER}"/Libs
	mkdir Libs/grib2
	mkdir Libs/NETCDF
	mkdir Libs/MPICH
	mkdir -p Tests/Environment
	mkdir -p Tests/Compatibility

	echo " "
	#############################Core Management####################################

	export CPU_CORE=$(nproc) # number of available threads on system
	export CPU_6CORE="6"
	export CPU_QUARTER=$(($CPU_CORE / 4))                          #quarter of availble cores on system
	export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2))) #Forces CPU cores to even number to avoid partial core export. ie 7 cores would be 3.5 cores.

	if [ $CPU_CORE -le $CPU_6CORE ]; then #If statement for low core systems.  Forces computers to only use 1 core if there are 4 cores or less on the system. then
		export CPU_QUARTER_EVEN="2"
	else
		export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))
	fi

	echo "##########################################"
	echo "Number of Threads being used $CPU_QUARTER_EVEN"
	echo "##########################################"

	echo " "
	##############################Downloading Libraries############################
	cd Downloads
	wget -c https://github.com/madler/zlib/releases/download/v$Zlib_Version/zlib-$Zlib_Version.tar.gz
	wget -c https://github.com/HDFGroup/hdf5/releases/download/hdf5_$HDF5_Version/hdf5-$HDF5_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-c/archive/refs/tags/v$Netcdf_C_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-fortran/archive/refs/tags/v$Netcdf_Fortran_Version.tar.gz
	wget -c https://download.sourceforge.net/libpng/libpng-$Libpng_Version.tar.gz
	wget -c https://www.ece.uvic.ca/~frodo/jasper/software/jasper-$Jasper_Version.zip
	wget -c https://github.com/pmodels/mpich/releases/download/v$Mpich_Version/mpich-$Mpich_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-cxx4/archive/refs/tags/v$Netcdf_CXX_Version.tar.gz
	wget -c http://mtc-m21c.sid.inpe.br/col/sid.inpe.br/mtc-m21c/2020/10.02.15.11/doc/publicacao.pdf

	echo " "
	####################################Compilers#####################################
	export CC=gcc
	export CXX=g++
	export FC=gfortran
	export F77=gfortran
	export CFLAGS="-fPIC -fPIE -O3"

	#IF statement for GNU compiler issue
	export GCC_VERSION=$(/usr/bin/gcc -dumpfullversion | awk '{print$1}')
	export GFORTRAN_VERSION=$(/usr/bin/gfortran -dumpfullversion | awk '{print$1}')
	export GPLUSPLUS_VERSION=$(/usr/bin/g++ -dumpfullversion | awk '{print$1}')

	export GCC_VERSION_MAJOR_VERSION=$(echo $GCC_VERSION | awk -F. '{print $1}')
	export GFORTRAN_VERSION_MAJOR_VERSION=$(echo $GFORTRAN_VERSION | awk -F. '{print $1}')
	export GPLUSPLUS_VERSION_MAJOR_VERSION=$(echo $GPLUSPLUS_VERSION | awk -F. '{print $1}')

	export version_10="10"

	if [ $GCC_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GFORTRAN_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GPLUSPLUS_VERSION_MAJOR_VERSION -ge $version_10 ]; then
		export fallow_argument=-fallow-argument-mismatch
		export boz_argument=-fallow-invalid-boz
	else
		export fallow_argument=
		export boz_argument=
	fi

	export FFLAGS="$fallow_argument -m64"
	export FCFLAGS="$fallow_argument -m64"

	echo "##########################################"
	echo "FFLAGS = $FFLAGS"
	echo "FCFLAGS = $FCFLAGS"
	echo "CFLAGS = $CFLAGS"
	echo "##########################################"

	echo " "
	############################# ZLib ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf zlib-$Zlib_Version.tar.gz
	cd zlib-$Zlib_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	export ZLIB_ROOT=$DIR/grib2
	export ZLIBLIB=$DIR/grib2/lib
	export ZLIBINC=$DIR/grib2/include

	echo " "
	############################## MPICH ############################
	#F90= due to compiler issues with mpich install
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf mpich-$Mpich_Version.tar.gz
	cd mpich-$Mpich_Version/

	F90= ./configure --prefix=$DIR/MPICH --with-device=ch3 FFLAGS=$fallow_argument FCFLAGS=$fallow_argument 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/MPICH/bin:$PATH

	export MPIFC=$DIR/MPICH/bin/mpifort
	export MPIF77=$DIR/MPICH/bin/mpifort
	export MPIF90=$DIR/MPICH/bin/mpifort
	export MPICC=$DIR/MPICH/bin/mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx

	echo " "
	############################# libpng ############################

	cd "${WRF_FOLDER}"/Downloads

	# other libraries below need these variables to be set
	export LDFLAGS=-L$DIR/grib2/lib
	export CPPFLAGS=-I$DIR/grib2/include

	LD_LIBRARY_PATH= tar -xvzf libpng-$Libpng_Version.tar.gz
	cd libpng-$Libpng_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNG_ROOT=$DIR/grib2

	echo " "
	#############################JasPer ############################
	cd "${WRF_FOLDER}"/Downloads
	unzip jasper-$Jasper_Version.zip
	cd jasper-$Jasper_Version/

	./configure --prefix=$DIR/grib2
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export JASPERLIB=$DIR/grib2/lib
	export JASPERINC=$DIR/grib2/include
	export JASPER_DIR=$DIR/grib2
	export Jasper_ROOT=$DIR/grib2/lib

	echo " "
	############################# hdf5 library for netcdf4 functionality ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf hdf5-$HDF5_Version.tar.gz
	cd hdf5-$HDF5_Version

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --with-zlib=$DIR/grib2 --enable-hl --enable-fortran --enable-parallel 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export HDF5=$DIR/grib2
	export HDF5_INCDIR=$DIR/grib2/include
	export HDF5_LIBDIR=$DIR/grib2/lib
	export PHDF5=$DIR/grib2
	export PHDF5_INCDIR=$DIR/grib2/include
	export PHDF5_LIBDIR=$DIR/grib2/lib
	export PATH=$DIR/grib2/bin:$PATH
	export HDF5_ROOT=$DIR/grib2
	export PHDF5_ROOT=$DIR/grib2

	echo " "

	############################## Install NETCDF C Library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_C_Version.tar.gz
	cd netcdf-c-$Netcdf_C_Version/
	export CPPFLAGS=-I$DIR/grib2/include
	export LDFLAGS="-L$DIR/grib2/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lhdf5_hl -lhdf5 -lz -lcurl -lgfortran -lgcc -lm -ldl"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --disable-dap --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-cdf5 --enable-parallel-tests --enable-logging 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/NETCDF/bin:$PATH
	export NETCDF=$DIR/NETCDF
	export NETCDF_INC=$NETCDF/include
	export NETCDF_LIB=$NETCDF/lib
	export NETCDF_INCDIR=$NETCDF/include
	export NETCDF_LIBDIR=$NETCDF/lib
	export NETCDFPATH=$NETCDF
	echo " "
	############################## NetCDF fortran library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_Fortran_Version.tar.gz
	cd netcdf-fortran-$Netcdf_Fortran_Version/
	export LD_LIBRARY_PATH=$DIR/NETCDF/lib:$LD_LIBRARY_PATH
	export CPPFLAGS="-I$DIR/NETCDF/include -I$DIR/grib2/include"
	export LDFLAGS="-L$DIR/NETCDF/lib -L$DIR/grib2/lib -Wl,-rpath,$DIR/NETCDF/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lnetcdf -lcurl -lhdf5_hl -lhdf5 -lz -lm -ldl -lgcc -lgfortran"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-parallel-tests --enable-logging --enable-hdf5 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	echo " "

	############################NetCDF CXX library############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_CXX_Version.tar.gz
	cd netcdf-cxx4-$Netcdf_CXX_Version/
	export LD_LIBRARY_PATH=$DIR/NETCDF/lib:$LD_LIBRARY_PATH
	export CPPFLAGS="-I$DIR/NETCDF/include -I$DIR/grib2/include"
	export LDFLAGS="-L$DIR/NETCDF/lib -L$DIR/grib2/lib -Wl,-rpath,$DIR/NETCDF/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lnetcdff -lnetcdf  -lcurl -lhdf5_hl -lhdf5 -lz -lm -ldl -lgcc -lgfortran"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-parallel-tests --enable-logging --enable-hdf5 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	#make check

	echo " "

	#################################### System Environment Tests ##############

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_NETCDF_MPI_tests.tar
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_tests.tar

	LD_LIBRARY_PATH= tar -xvf Fortran_C_tests.tar -C "${WRF_FOLDER}"/Tests/Environment
	LD_LIBRARY_PATH= tar -xvf Fortran_C_NETCDF_MPI_tests.tar -C "${WRF_FOLDER}"/Tests/Compatibility

	export one="1"
	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Environment

	cp ${NETCDF}/include/netcdf.inc .

	echo " "
	echo " "
	echo "Environment Testing "
	echo "Test 1"
	$FC TEST_1_fortran_only_fixed.f
	./a.out | tee env_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 1 Passed"
	else
		echo "Environment Compiler Test 1 Failed"
		exit
	fi
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 2"
	$FC TEST_2_fortran_only_free.f90
	./a.out | tee env_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 2 Passed"
	else
		echo "Environment Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 3"
	$CC TEST_3_c_only.c
	./a.out | tee env_test3.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test3.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 3 Passed"
	else
		echo "Environment Compiler Test 3 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 4"
	$CC -c -m64 TEST_4_fortran+c_c.c
	$FC -c -m64 TEST_4_fortran+c_f.f90
	$FC -m64 TEST_4_fortran+c_f.o TEST_4_fortran+c_c.o
	./a.out | tee env_test4.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test4.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 4 Passed"
	else
		echo "Environment Compiler Test 4 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Compatibility

	cp ${NETCDF}/include/netcdf.inc .

	echo " "
	echo " "
	echo "Library Compatibility Tests "
	echo "Test 1"
	$FC -c 01_fortran+c+netcdf_f.f
	$CC -c 01_fortran+c+netcdf_c.c
	$FC 01_fortran+c+netcdf_f.o 01_fortran+c+netcdf_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	./a.out | tee comp_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 1 Passed"
	else
		echo "Compatibility Compiler Test 1 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "

	echo "Test 2"
	$MPIFC -c 02_fortran+c+netcdf+mpi_f.f
	$MPICC -c 02_fortran+c+netcdf+mpi_c.c
	$MPIFC 02_fortran+c+netcdf+mpi_f.o \
		02_fortran+c+netcdf+mpi_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	$DIR/MPICH/bin/mpirun ./a.out | tee comp_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 2 Passed"
	else
		echo "Compatibility Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."
	echo " "

	echo " All tests completed and passed"
	echo " "

	########################COAWST 3.8###################################
	cd "${WRF_FOLDER}"

	git clone https://github.com/DOI-USGS/COAWST.git

	# Compile Model Coupling Toolkit (MCT)
	cd "${WRF_FOLDER}"/COAWST/Lib/MCT
	MPIHEADER="-I$DIR/MPICH/include" ./configure --prefix="${WRF_FOLDER}"/Libs/MCT 2>&1 | tee coawst.configure.log

	make 2>&1 | tee coawst.make.log
	make install 2>&1 | tee coawst.make.install.log

	export MCT_INCDIR="${WRF_FOLDER}"/Libs/MCT/include
	export MCT_LIBDIR="${WRF_FOLDER}"/Libs/MCT/lib

	cd "${WRF_FOLDER}"/COAWST

	#modifying build_coawst to for paths
	sed -i '134s/INLET_TEST/SANDY/g' build_coawst.sh
	sed -i '142s|/cygdrive/e/data/models/COAWST|"${WRF_FOLDER}"/COAWST/ |g' build_coawst.sh
	sed -i '210s|export|#export|g' build_coawst.sh
	sed -i '211s|#export|export|g' build_coawst.sh
	sed -i '252s|#export|export|g' build_coawst.sh
	sed -i '306s|Inlet_test/Coupled|Sandy|g' build_coawst.sh
	sed -i '307s|Inlet_test/Coupled|Sandy|g' build_coawst.sh

	cd "${WRF_FOLDER}"/COAWST/Compilers
	sed -i '41a\      FFLAGS += -frecord-marker=4 -fconvert=big-endian' Linux-gfortran.mk

	#this removes the arch prompt for gnu compilers
	cd "${WRF_FOLDER}"/COAWST/WRF/arch/

	sed -i '433s|.*|  $response = "34 \\n";|g' Config.pl
	sed -i '898s|.*|  $response = "1 \\n";|g' Config.pl

	cd "${WRF_FOLDER}"/COAWST/

	chmod 775 *.sh

	./build_coawst.sh -j $CPU_QUARTER_EVEN 2>&1 | tee build_coawst.log

	if [ $? -eq 0 ] && [ -e "coawstM" ]; then
		echo "Script ran successfully and coawstM exists."
	else
		echo "Script did not run successfully or coawstM does not exist."
		echo "Running compiler again"
		cd "${WRF_FOLDER}/COAWST/WRF/arch/"
		./build_coawst.sh -j $CPU_QUARTER_EVEN 2>&1 | tee build_coawst2.log
		if [ $? -eq 0 ] && [ -e "coawstM" ]; then
			echo "Script ran successfully and coawstM exists."
		else
			echo "Script did not run successfully or coawstM does not exist."
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
		fi
	fi

fi

if [ "$RHL_64bit_GNU" = "1" ] && [ "$COAWST_Pick" = "1" ]; then

	#############################basic package managment############################
	echo $PASSWD | sudo -S yum install epel-release -y
	echo $PASSWD | sudo -S yum install dnf -y
	echo $PASSWD | sudo -S dnf install epel-release -y
	echo $PASSWD | sudo -S dnf install dnf -y
	echo $PASSWD | sudo -S dnf -y update
	echo $PASSWD | sudo -S dnf -y upgrade
	echo $PASSWD | sudo -S dnf -y install bzip2 bzip2-devel byacc cairo-devel cmake cpp curl curl-devel flex fontconfig-devel fontconfig-devel gcc gcc-c++ gcc-gfortran git java-11-openjdk java-11-openjdk-devel ksh libX11-devel libX11-devel libXaw libXaw-devel libXext-devel libXext-devel libXmu-devel libXrender-devel libXrender-devel libstdc++ libstdc++-devel libxml2 libxml2-devel m4 nfs-utils perl "perl(XML::LibXML)" pkgconfig pixman-devel python3 python3-devel tcsh time unzip wget
	echo $PASSWD | sudo -S dnf -y groupinstall "Development Tools"
	echo $PASSWD | sudo -S dnf -y update
	echo $PASSWD | sudo -S dnf -y upgrade

	echo " "
	##############################Directory Listing############################
	export HOME=$(
		cd
		pwd
	)

	mkdir $HOME/COAWST
	export WRF_FOLDER=$HOME/COAWST
	cd "${WRF_FOLDER}"/
	mkdir Downloads

	mkdir Libs
	export DIR="${WRF_FOLDER}"/Libs
	mkdir Libs/grib2
	mkdir Libs/NETCDF
	mkdir Libs/MPICH
	mkdir -p Tests/Environment
	mkdir -p Tests/Compatibility

	echo " "
	#############################Core Management####################################

	export CPU_CORE=$(nproc) # number of available threads on system
	export CPU_6CORE="6"
	export CPU_QUARTER=$(($CPU_CORE / 4))                          #quarter of availble cores on system
	export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2))) #Forces CPU cores to even number to avoid partial core export. ie 7 cores would be 3.5 cores.

	if [ $CPU_CORE -le $CPU_6CORE ]; then #If statement for low core systems.  Forces computers to only use 1 core if there are 4 cores or less on the system. then
		export CPU_QUARTER_EVEN="2"
	else
		export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))
	fi

	echo "##########################################"
	echo "Number of Threads being used $CPU_QUARTER_EVEN"
	echo "##########################################"

	echo " "
	##############################Downloading Libraries############################
	cd Downloads
	wget -c https://github.com/madler/zlib/releases/download/v$Zlib_Version/zlib-$Zlib_Version.tar.gz
	wget -c https://github.com/HDFGroup/hdf5/releases/download/hdf5_$HDF5_Version/hdf5-$HDF5_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-c/archive/refs/tags/v$Netcdf_C_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-fortran/archive/refs/tags/v$Netcdf_Fortran_Version.tar.gz
	wget -c https://download.sourceforge.net/libpng/libpng-$Libpng_Version.tar.gz
	wget -c https://www.ece.uvic.ca/~frodo/jasper/software/jasper-$Jasper_Version.zip
	wget -c https://github.com/pmodels/mpich/releases/download/v$Mpich_Version/mpich-$Mpich_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-cxx4/archive/refs/tags/v$Netcdf_CXX_Version.tar.gz

	cd "${WRF_FOLDER}"/
	wget -c http://mtc-m21c.sid.inpe.br/col/sid.inpe.br/mtc-m21c/2020/10.02.15.11/doc/publicacao.pdf -O COAWST_USER_GUIDE.pdf
	cd Downloads

	echo " "
	####################################Compilers#####################################
	export CC=gcc
	export CXX=g++
	export FC=gfortran
	export F77=gfortran
	export CFLAGS="-fPIC -fPIE -O3"

	#IF statement for GNU compiler issue
	export GCC_VERSION=$(gcc -dumpfullversion | awk '{print$1}')
	export GFORTRAN_VERSION=$(gfortran -dumpfullversion | awk '{print$1}')
	export GPLUSPLUS_VERSION=$(g++ -dumpfullversion | awk '{print$1}')

	export GCC_VERSION_MAJOR_VERSION=$(echo $GCC_VERSION | awk -F. '{print $1}')
	export GFORTRAN_VERSION_MAJOR_VERSION=$(echo $GFORTRAN_VERSION | awk -F. '{print $1}')
	export GPLUSPLUS_VERSION_MAJOR_VERSION=$(echo $GPLUSPLUS_VERSION | awk -F. '{print $1}')

	export version_10="10"

	if [ $GCC_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GFORTRAN_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GPLUSPLUS_VERSION_MAJOR_VERSION -ge $version_10 ]; then
		export fallow_argument=-fallow-argument-mismatch
		export boz_argument=-fallow-invalid-boz
	else
		export fallow_argument=
		export boz_argument=
	fi

	export FFLAGS="$fallow_argument -m64"
	export FCFLAGS="$fallow_argument -m64"

	echo "##########################################"
	echo "FFLAGS = $FFLAGS"
	echo "FCFLAGS = $FCFLAGS"
	echo "CFLAGS = $CFLAGS"
	echo "##########################################"

	echo " "
	############################# ZLib ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf zlib-$Zlib_Version.tar.gz
	cd zlib-$Zlib_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	export ZLIB_ROOT=$DIR/grib2
	export ZLIBLIB=$DIR/grib2/lib
	export ZLIBINC=$DIR/grib2/include

	echo " "
	############################## MPICH ############################
	#F90= due to compiler issues with mpich install
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf mpich-$Mpich_Version.tar.gz
	cd mpich-$Mpich_Version/

	F90= ./configure --prefix=$DIR/MPICH --with-device=ch3 FFLAGS=$fallow_argument FCFLAGS=$fallow_argument 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/MPICH/bin:$PATH

	export MPIFC=$DIR/MPICH/bin/mpifort
	export MPIF77=$DIR/MPICH/bin/mpifort
	export MPIF90=$DIR/MPICH/bin/mpifort
	export MPICC=$DIR/MPICH/bin/mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx

	echo " "
	############################# libpng ############################

	cd "${WRF_FOLDER}"/Downloads

	# other libraries below need these variables to be set
	export LDFLAGS=-L$DIR/grib2/lib
	export CPPFLAGS=-I$DIR/grib2/include

	LD_LIBRARY_PATH= tar -xvzf libpng-$Libpng_Version.tar.gz
	cd libpng-$Libpng_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNG_ROOT=$DIR/grib2

	echo " "
	#############################JasPer ############################
	cd "${WRF_FOLDER}"/Downloads
	unzip jasper-$Jasper_Version.zip
	cd jasper-$Jasper_Version/

	./configure --prefix=$DIR/grib2
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export JASPERLIB=$DIR/grib2/lib
	export JASPERINC=$DIR/grib2/include
	export JASPER_DIR=$DIR/grib2
	export Jasper_ROOT=$DIR/grib2/lib

	echo " "
	############################# hdf5 library for netcdf4 functionality ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf hdf5-$HDF5_Version.tar.gz
	cd hdf5-$HDF5_Version

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --with-zlib=$DIR/grib2 --enable-hl --enable-fortran --enable-parallel 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export HDF5=$DIR/grib2
	export HDF5_INCDIR=$DIR/grib2/include
	export HDF5_LIBDIR=$DIR/grib2/lib
	export PHDF5=$DIR/grib2
	export PHDF5_INCDIR=$DIR/grib2/include
	export PHDF5_LIBDIR=$DIR/grib2/lib
	export PATH=$DIR/grib2/bin:$PATH
	export HDF5_ROOT=$DIR/grib2
	export PHDF5_ROOT=$DIR/grib2

	echo " "

	############################## Install NETCDF C Library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_C_Version.tar.gz
	cd netcdf-c-$Netcdf_C_Version/
	export CPPFLAGS=-I$DIR/grib2/include
	export LDFLAGS="-L$DIR/grib2/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lhdf5_hl -lhdf5 -lz -lcurl -lgfortran -lgcc -lm -ldl"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --disable-dap --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-cdf5 --enable-parallel-tests --enable-logging 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/NETCDF/bin:$PATH
	export NETCDF=$DIR/NETCDF
	export NETCDF_INC=$NETCDF/include
	export NETCDF_LIB=$NETCDF/lib
	export NETCDF_INCDIR=$NETCDF/include
	export NETCDF_LIBDIR=$NETCDF/lib
	export NETCDFPATH=$NETCDF
	echo " "
	############################## NetCDF fortran library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_Fortran_Version.tar.gz
	cd netcdf-fortran-$Netcdf_Fortran_Version/
	export LD_LIBRARY_PATH=$DIR/NETCDF/lib:$LD_LIBRARY_PATH
	export CPPFLAGS="-I$DIR/NETCDF/include -I$DIR/grib2/include"
	export LDFLAGS="-L$DIR/NETCDF/lib -L$DIR/grib2/lib -Wl,-rpath,$DIR/NETCDF/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lnetcdf -lcurl -lhdf5_hl -lhdf5 -lz -lm -ldl -lgcc -lgfortran"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-parallel-tests --enable-logging --enable-hdf5 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	echo " "

	############################NetCDF CXX library############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_CXX_Version.tar.gz
	cd netcdf-cxx4-$Netcdf_CXX_Version/
	export LD_LIBRARY_PATH=$DIR/NETCDF/lib:$LD_LIBRARY_PATH
	export CPPFLAGS="-I$DIR/NETCDF/include -I$DIR/grib2/include"
	export LDFLAGS="-L$DIR/NETCDF/lib -L$DIR/grib2/lib -Wl,-rpath,$DIR/NETCDF/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lnetcdff -lnetcdf  -lcurl -lhdf5_hl -lhdf5 -lz -lm -ldl -lgcc -lgfortran"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-parallel-tests --enable-logging --enable-hdf5 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	#make check

	echo " "

	#################################### System Environment Tests ##############

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_NETCDF_MPI_tests.tar
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_tests.tar

	LD_LIBRARY_PATH= tar -xvf Fortran_C_tests.tar -C "${WRF_FOLDER}"/Tests/Environment
	LD_LIBRARY_PATH= tar -xvf Fortran_C_NETCDF_MPI_tests.tar -C "${WRF_FOLDER}"/Tests/Compatibility

	export one="1"
	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Environment

	cp ${NETCDF}/include/netcdf.inc .

	echo " "
	echo " "
	echo "Environment Testing "
	echo "Test 1"
	$FC TEST_1_fortran_only_fixed.f
	./a.out | tee env_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 1 Passed"
	else
		echo "Environment Compiler Test 1 Failed"
		exit
	fi
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 2"
	$FC TEST_2_fortran_only_free.f90
	./a.out | tee env_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 2 Passed"
	else
		echo "Environment Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 3"
	$CC TEST_3_c_only.c
	./a.out | tee env_test3.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test3.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 3 Passed"
	else
		echo "Environment Compiler Test 3 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 4"
	$CC -c -m64 TEST_4_fortran+c_c.c
	$FC -c -m64 TEST_4_fortran+c_f.f90
	$FC -m64 TEST_4_fortran+c_f.o TEST_4_fortran+c_c.o
	./a.out | tee env_test4.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test4.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 4 Passed"
	else
		echo "Environment Compiler Test 4 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Compatibility

	cp ${NETCDF}/include/netcdf.inc .

	echo " "
	echo " "
	echo "Library Compatibility Tests "
	echo "Test 1"
	$FC -c 01_fortran+c+netcdf_f.f
	$CC -c 01_fortran+c+netcdf_c.c
	$FC 01_fortran+c+netcdf_f.o 01_fortran+c+netcdf_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	./a.out | tee comp_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 1 Passed"
	else
		echo "Compatibility Compiler Test 1 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "

	echo "Test 2"
	$MPIFC -c 02_fortran+c+netcdf+mpi_f.f
	$MPICC -c 02_fortran+c+netcdf+mpi_c.c
	$MPIFC 02_fortran+c+netcdf+mpi_f.o \
		02_fortran+c+netcdf+mpi_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	$DIR/MPICH/bin/mpirun ./a.out | tee comp_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 2 Passed"
	else
		echo "Compatibility Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."
	echo " "

	echo " All tests completed and passed"
	echo " "

	################################ OpenGrADS ##################################
	#Verison 2.2.1 32bit of Linux
	#############################################################################
	if [[ $GRADS_PICK -eq 1 ]]; then
		cd "${WRF_FOLDER}"/Downloads
		LD_LIBRARY_PATH= tar -xvzf cd "${WRF_FOLDER}"/Downloads
		wget -c https://sourceforge.net/projects/opengrads/files/grads2/2.2.1.oga.1/Linux%20%2864%20Bits%29/opengrads-2.2.1.oga.1-bundle-x86_64-pc-linux-gnu-glibc_2.17.tar.gz
		LD_LIBRARY_PATH= tar -xvzf opengrads-2.2.1.oga.1-bundle-x86_64-pc-linux-gnu-glibc_2.17.tar.gz -C "${WRF_FOLDER}"/ -C "${WRF_FOLDER}"/
		cd "${WRF_FOLDER}"/
		mv "${WRF_FOLDER}"/opengrads-2.2.1.oga.1 "${WRF_FOLDER}"/GrADS
		cd GrADS/Contents
		wget -c https://github.com/regisgrundig/SIMOP/blob/master/g2ctl.pl
		chmod +x g2ctl.pl
		wget -c https://sourceforge.net/projects/opengrads/files/wgrib2/0.1.9.4/wgrib2-v0.1.9.4-bin-i686-glib2.5-linux-gnu.tar.gz
		LD_LIBRARY_PATH= tar -xvzf wgrib2-v0.1.9.4-bin-i686-glib2.5-linux-gnu.tar.gz
		cd wgrib2-v0.1.9.4/bin
		mv wgrib2 "${WRF_FOLDER}"/GrADS/Contents
		cd "${WRF_FOLDER}"/GrADS/Contents
		rm wgrib2-v0.1.9.4-bin-i686-glib2.5-linux-gnu.tar.gz
		rm -r wgrib2-v0.1.9.4

		export PATH="${WRF_FOLDER}"/GrADS/Contents:$PATH

		echo " "
	fi
	################################## GrADS ###############################
	# Version  2.2.1
	# Sublibs library instructions: http://cola.gmu.edu/grads/gadoc/supplibs2.html
	# GrADS instructions: http://cola.gmu.edu/grads/downloads.php
	########################################################################
	if [[ $GRADS_PICK -eq 2 ]]; then

		echo $PASSWD | sudo -S apt -y install grads

	fi

	##################### NCAR COMMAND LANGUAGE           ##################
	########### NCL compiled via Conda                    ##################
	########### This is the preferred method by NCAR      ##################
	########### https://www.ncl.ucar.edu/index.shtml      ##################
	#Installing Miniconda3 to WRF-Hydro directory and updating libraries

	echo $PASSWD | sudo -S apt -y install python3-zstandard python3-zstd

	export Miniconda_Install_DIR="${WRF_FOLDER}"/miniconda3

	mkdir -p $Miniconda_Install_DIR

	wget -c https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O $Miniconda_Install_DIR/miniconda.sh
	bash $Miniconda_Install_DIR/miniconda.sh -b -u -p $Miniconda_Install_DIR

	rm -rf $Miniconda_Install_DIR/miniconda.sh

	export PATH="${WRF_FOLDER}"/miniconda3/bin:$PATH

	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	$Miniconda_Install_DIR/bin/conda init bash

	conda tos accept
	conda config --add channels conda-forge
	conda config --set auto_activate_base false
	conda update -n root --all -y

	echo " "

	echo " "
	#Installing NCL via Conda
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	conda create -n ncl_stable -c conda-forge ncl -y
	conda activate ncl_stable

	conda deactivate
	conda deactivate
	conda deactivate

	echo " "

	##################### WRF Python           ##################
	########### WRf-Python compiled via Conda  ##################
	########### This is the preferred method by NCAR      ##################
	##### https://wrf-python.readthedocs.io/en/latest/installation.html  ##################
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh
	conda env create -f $HOME/WRF-MOSIT/wrf-python-stable.yml

	######################### Climate Data Operators ############
	######################### CDO compiled via Conda ###########
	####################### This is the preferred method #######
	################### https://bairdlangenbrunner.github.io/python-for-climate-scientists/conda/setting-up-conda-environments.html #######################

	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	conda create --name cdo_stable -y
	conda activate cdo_stable
	conda install -c conda-forge cdo -y
	conda update --all -y
	conda deactivate
	conda deactivate
	conda deactivate

	echo " "

	########################COAWST 3.8###################################
	cd "${WRF_FOLDER}"

	git clone https://github.com/DOI-USGS/COAWST.git

	# Compile Model Coupling Toolkit (MCT)
	cd "${WRF_FOLDER}"/COAWST/Lib/MCT
	MPIHEADER="-I$DIR/MPICH/include" ./configure --prefix="${WRF_FOLDER}"/Libs/MCT 2>&1 | tee coawst.configure.log

	make 2>&1 | tee coawst.make.log
	make install 2>&1 | tee coawst.make.install.log

	export MCT_INCDIR="${WRF_FOLDER}"/Libs/MCT/include
	export MCT_LIBDIR="${WRF_FOLDER}"/Libs/MCT/lib

	cd "${WRF_FOLDER}"/COAWST

	#modifying build_coawst to for paths
	sed -i '134s/INLET_TEST/SANDY/g' build_coawst.sh
	sed -i '142s|/cygdrive/e/data/models/COAWST|"${WRF_FOLDER}"/COAWST/ |g' build_coawst.sh
	sed -i '210s|export|#export|g' build_coawst.sh
	sed -i '211s|#export|export|g' build_coawst.sh
	sed -i '252s|#export|export|g' build_coawst.sh
	sed -i '306s|Inlet_test/Coupled|Sandy|g' build_coawst.sh
	sed -i '307s|Inlet_test/Coupled|Sandy|g' build_coawst.sh

	cd "${WRF_FOLDER}"/COAWST/Compilers
	sed -i '41a\      FFLAGS += -frecord-marker=4 -fconvert=big-endian' Linux-gfortran.mk

	#this removes the arch prompt for gnu compilers
	cd "${WRF_FOLDER}"/COAWST/WRF/arch/

	sed -i '433s|.*|  $response = "34 \\n";|g' Config.pl
	sed -i '898s|.*|  $response = "1 \\n";|g' Config.pl

	cd "${WRF_FOLDER}"/COAWST/

	chmod 775 *.sh

	./build_coawst.sh -j $CPU_QUARTER_EVEN 2>&1 | tee build_coawst.log

	if [ $? -eq 0 ] && [ -e "coawstM" ]; then
		echo "Script ran successfully and coawstM exists."
	else
		echo "Script did not run successfully or coawstM does not exist."
		echo "Running compiler again"
		cd "${WRF_FOLDER}/COAWST/WRF/arch/"
		./build_coawst.sh -j $CPU_QUARTER_EVEN 2>&1 | tee build_coawst2.log
		if [ $? -eq 0 ] && [ -e "coawstM" ]; then
			echo "Script ran successfully and coawstM exists."
		else
			echo "Script did not run successfully or coawstM does not exist."
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
		fi
	fi

fi

if [ "$RHL_64bit_GNU" = "2" ] && [ "$COAWST_Pick" = "1" ]; then

	#############################basic package managment############################
	echo "old version of GNU detected"
	echo $PASSWD | sudo -S yum install RHL-release-scl -y
	echo $PASSWD | sudo -S yum clean all
	echo $PASSWD | sudo -S yum remove devtoolset-11*
	echo $PASSWD | sudo -S yum install devtoolset-11
	echo $PASSWD | sudo -S yum install devtoolset-11-\* -y
	source /opt/rh/devtoolset-11/enable
	gcc --version
	echo $PASSWD | sudo -S yum install epel-release -y
	echo $PASSWD | sudo -S yum install dnf -y
	echo $PASSWD | sudo -S dnf install epel-release -y
	echo $PASSWD | sudo -S dnf install dnf -y
	echo $PASSWD | sudo -S dnf -y update
	echo $PASSWD | sudo -S dnf -y upgrade
	echo $PASSWD | sudo -S dnf -y install bzip2 bzip2-devel byacc cairo-devel cmake cpp curl curl-devel flex fontconfig-devel fontconfig-devel gcc gcc-c++ gcc-gfortran git java-11-openjdk java-11-openjdk-devel ksh libX11-devel libX11-devel libXaw libXaw-devel libXext-devel libXext-devel libXmu-devel libXrender-devel libstdc++ libstdc++-devel libxml2 libxml2-devel m4 nfs-utils perl "perl(XML::LibXML)" pkgconfig pixman-devel python3 python3-devel tcsh time unzip wget
	echo $PASSWD | sudo -S dnf -y groupinstall "Development Tools"
	echo $PASSWD | sudo -S dnf -y update
	echo $PASSWD | sudo -S dnf -y upgrade

	echo " "
	##############################Directory Listing############################
	export HOME=$(
		cd
		pwd
	)

	mkdir $HOME/COAWST
	export WRF_FOLDER=$HOME/COAWST
	cd "${WRF_FOLDER}"/
	mkdir Downloads

	mkdir Libs
	export DIR="${WRF_FOLDER}"/Libs
	mkdir Libs/grib2
	mkdir Libs/NETCDF
	mkdir Libs/MPICH
	mkdir -p Tests/Environment
	mkdir -p Tests/Compatibility

	echo " "
	#############################Core Management####################################

	export CPU_CORE=$(nproc) # number of available threads on system
	export CPU_6CORE="6"
	export CPU_QUARTER=$(($CPU_CORE / 4))                          #quarter of availble cores on system
	export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2))) #Forces CPU cores to even number to avoid partial core export. ie 7 cores would be 3.5 cores.

	if [ $CPU_CORE -le $CPU_6CORE ]; then #If statement for low core systems.  Forces computers to only use 1 core if there are 4 cores or less on the system. then
		export CPU_QUARTER_EVEN="2"
	else
		export CPU_QUARTER_EVEN=$(($CPU_QUARTER - ($CPU_QUARTER % 2)))
	fi

	echo "##########################################"
	echo "Number of Threads being used $CPU_QUARTER_EVEN"
	echo "##########################################"

	echo " "
	##############################Downloading Libraries############################
	cd Downloads
	wget -c https://github.com/madler/zlib/releases/download/v$Zlib_Version/zlib-$Zlib_Version.tar.gz
	wget -c https://github.com/HDFGroup/hdf5/releases/download/hdf5_$HDF5_Version/hdf5-$HDF5_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-c/archive/refs/tags/v$Netcdf_C_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-fortran/archive/refs/tags/v$Netcdf_Fortran_Version.tar.gz
	wget -c https://download.sourceforge.net/libpng/libpng-$Libpng_Version.tar.gz
	wget -c https://www.ece.uvic.ca/~frodo/jasper/software/jasper-$Jasper_Version.zip
	wget -c https://github.com/pmodels/mpich/releases/download/v$Mpich_Version/mpich-$Mpich_Version.tar.gz
	wget -c https://github.com/Unidata/netcdf-cxx4/archive/refs/tags/v$Netcdf_CXX_Version.tar.gz

	cd "${WRF_FOLDER}"/
	wget -c http://mtc-m21c.sid.inpe.br/col/sid.inpe.br/mtc-m21c/2020/10.02.15.11/doc/publicacao.pdf -O COAWST_USER_GUIDE.pdf
	cd Downloads

	echo " "
	####################################Compilers#####################################
	export CC=gcc
	export CXX=g++
	export FC=gfortran
	export F77=gfortran
	export CFLAGS="-fPIC -fPIE -O3"

	#IF statement for GNU compiler issue
	export GCC_VERSION=$(gcc -dumpfullversion | awk '{print$1}')
	export GFORTRAN_VERSION=$(gfortran -dumpfullversion | awk '{print$1}')
	export GPLUSPLUS_VERSION=$(g++ -dumpfullversion | awk '{print$1}')

	export GCC_VERSION_MAJOR_VERSION=$(echo $GCC_VERSION | awk -F. '{print $1}')
	export GFORTRAN_VERSION_MAJOR_VERSION=$(echo $GFORTRAN_VERSION | awk -F. '{print $1}')
	export GPLUSPLUS_VERSION_MAJOR_VERSION=$(echo $GPLUSPLUS_VERSION | awk -F. '{print $1}')

	export version_10="10"

	if [ $GCC_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GFORTRAN_VERSION_MAJOR_VERSION -ge $version_10 ] || [ $GPLUSPLUS_VERSION_MAJOR_VERSION -ge $version_10 ]; then
		export fallow_argument=-fallow-argument-mismatch
		export boz_argument=-fallow-invalid-boz
	else
		export fallow_argument=
		export boz_argument=
	fi

	export FFLAGS="$fallow_argument -m64"
	export FCFLAGS="$fallow_argument -m64"

	echo "##########################################"
	echo "FFLAGS = $FFLAGS"
	echo "FCFLAGS = $FCFLAGS"
	echo "CFLAGS = $CFLAGS"
	echo "##########################################"

	echo " "
	############################# ZLib ############################

	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf zlib-$Zlib_Version.tar.gz
	cd zlib-$Zlib_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	export ZLIB_ROOT=$DIR/grib2
	export ZLIBLIB=$DIR/grib2/lib
	export ZLIBINC=$DIR/grib2/include

	echo " "
	############################## MPICH ############################
	#F90= due to compiler issues with mpich install
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf mpich-$Mpich_Version.tar.gz
	cd mpich-$Mpich_Version/

	F90= ./configure --prefix=$DIR/MPICH --with-device=ch3 FFLAGS=$fallow_argument FCFLAGS=$fallow_argument 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/MPICH/bin:$PATH

	export MPIFC=$DIR/MPICH/bin/mpifort
	export MPIF77=$DIR/MPICH/bin/mpifort
	export MPIF90=$DIR/MPICH/bin/mpifort
	export MPICC=$DIR/MPICH/bin/mpicc
	export MPICXX=$DIR/MPICH/bin/mpicxx

	echo " "
	############################# libpng ############################

	cd "${WRF_FOLDER}"/Downloads

	# other libraries below need these variables to be set
	export LDFLAGS=-L$DIR/grib2/lib
	export CPPFLAGS=-I$DIR/grib2/include

	LD_LIBRARY_PATH= tar -xvzf libpng-$Libpng_Version.tar.gz
	cd libpng-$Libpng_Version/

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PNG_ROOT=$DIR/grib2

	echo " "
	#############################JasPer ############################
	cd "${WRF_FOLDER}"/Downloads
	unzip jasper-$Jasper_Version.zip
	cd jasper-$Jasper_Version/

	./configure --prefix=$DIR/grib2
	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export JASPERLIB=$DIR/grib2/lib
	export JASPERINC=$DIR/grib2/include
	export JASPER_DIR=$DIR/grib2
	export Jasper_ROOT=$DIR/grib2/lib

	echo " "
	############################# hdf5 library for netcdf4 functionality ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf hdf5-$HDF5_Version.tar.gz
	cd hdf5-$HDF5_Version

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/grib2 --with-zlib=$DIR/grib2 --enable-hl --enable-fortran --enable-parallel 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export HDF5=$DIR/grib2
	export HDF5_INCDIR=$DIR/grib2/include
	export HDF5_LIBDIR=$DIR/grib2/lib
	export PHDF5=$DIR/grib2
	export PHDF5_INCDIR=$DIR/grib2/include
	export PHDF5_LIBDIR=$DIR/grib2/lib
	export PATH=$DIR/grib2/bin:$PATH
	export HDF5_ROOT=$DIR/grib2
	export PHDF5_ROOT=$DIR/grib2

	echo " "

	############################## Install NETCDF C Library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_C_Version.tar.gz
	cd netcdf-c-$Netcdf_C_Version/
	export CPPFLAGS=-I$DIR/grib2/include
	export LDFLAGS="-L$DIR/grib2/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lhdf5_hl -lhdf5 -lz -lcurl -lgfortran -lgcc -lm -ldl"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --disable-dap --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-cdf5 --enable-parallel-tests --enable-logging 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	export PATH=$DIR/NETCDF/bin:$PATH
	export NETCDF=$DIR/NETCDF
	export NETCDF_INC=$NETCDF/include
	export NETCDF_LIB=$NETCDF/lib
	export NETCDF_INCDIR=$NETCDF/include
	export NETCDF_LIBDIR=$NETCDF/lib
	export NETCDFPATH=$NETCDF
	echo " "
	############################## NetCDF fortran library ############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_Fortran_Version.tar.gz
	cd netcdf-fortran-$Netcdf_Fortran_Version/
	export LD_LIBRARY_PATH=$DIR/NETCDF/lib:$LD_LIBRARY_PATH
	export CPPFLAGS="-I$DIR/NETCDF/include -I$DIR/grib2/include"
	export LDFLAGS="-L$DIR/NETCDF/lib -L$DIR/grib2/lib -Wl,-rpath,$DIR/NETCDF/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lnetcdf -lcurl -lhdf5_hl -lhdf5 -lz -lm -ldl -lgcc -lgfortran"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-parallel-tests --enable-logging --enable-hdf5 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log

	echo " "

	############################NetCDF CXX library############################
	cd "${WRF_FOLDER}"/Downloads
	LD_LIBRARY_PATH= tar -xvzf v$Netcdf_CXX_Version.tar.gz
	cd netcdf-cxx4-$Netcdf_CXX_Version/
	export LD_LIBRARY_PATH=$DIR/NETCDF/lib:$LD_LIBRARY_PATH
	export CPPFLAGS="-I$DIR/NETCDF/include -I$DIR/grib2/include"
	export LDFLAGS="-L$DIR/NETCDF/lib -L$DIR/grib2/lib -Wl,-rpath,$DIR/NETCDF/lib -Wl,-rpath,$DIR/grib2/lib"
	export LIBS="-lnetcdff -lnetcdf  -lcurl -lhdf5_hl -lhdf5 -lz -lm -ldl -lgcc -lgfortran"

	CC=$MPICC FC=$MPIFC F77=$MPIF77 F90=$MPIF90 CXX=$MPICXX CFLAGS=$CFLAGS FFLAGS=$FFLAGS FCFLAGS=$FCFLAGS ./configure --prefix=$DIR/NETCDF --enable-netcdf-4 --enable-netcdf4 --enable-static --enable-parallel-tests --enable-logging --enable-hdf5 2>&1 | tee configure.log

	make -j $CPU_QUARTER_EVEN 2>&1 | tee make.log
	make -j $CPU_QUARTER_EVEN install 2>&1 | tee make.install.log
	#make check

	echo " "

	#################################### System Environment Tests ##############

	cd "${WRF_FOLDER}"/Downloads
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_NETCDF_MPI_tests.tar
	wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_tests.tar

	LD_LIBRARY_PATH= tar -xvf Fortran_C_tests.tar -C "${WRF_FOLDER}"/Tests/Environment
	LD_LIBRARY_PATH= tar -xvf Fortran_C_NETCDF_MPI_tests.tar -C "${WRF_FOLDER}"/Tests/Compatibility

	export one="1"
	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Environment

	cp ${NETCDF}/include/netcdf.inc .

	echo " "
	echo " "
	echo "Environment Testing "
	echo "Test 1"
	$FC TEST_1_fortran_only_fixed.f
	./a.out | tee env_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 1 Passed"
	else
		echo "Environment Compiler Test 1 Failed"
		exit
	fi
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 2"
	$FC TEST_2_fortran_only_free.f90
	./a.out | tee env_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 2 Passed"
	else
		echo "Environment Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 3"
	$CC TEST_3_c_only.c
	./a.out | tee env_test3.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test3.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 3 Passed"
	else
		echo "Environment Compiler Test 3 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	echo "Test 4"
	$CC -c -m64 TEST_4_fortran+c_c.c
	$FC -c -m64 TEST_4_fortran+c_f.f90
	$FC -m64 TEST_4_fortran+c_f.o TEST_4_fortran+c_c.o
	./a.out | tee env_test4.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" env_test4.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Enviroment Test 4 Passed"
	else
		echo "Environment Compiler Test 4 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "
	############## Testing Environment #####

	cd "${WRF_FOLDER}"/Tests/Compatibility

	cp ${NETCDF}/include/netcdf.inc .

	echo " "
	echo " "
	echo "Library Compatibility Tests "
	echo "Test 1"
	$FC -c 01_fortran+c+netcdf_f.f
	$CC -c 01_fortran+c+netcdf_c.c
	$FC 01_fortran+c+netcdf_f.o 01_fortran+c+netcdf_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	./a.out | tee comp_test1.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test1.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 1 Passed"
	else
		echo "Compatibility Compiler Test 1 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."

	echo " "

	echo "Test 2"
	$MPIFC -c 02_fortran+c+netcdf+mpi_f.f
	$MPICC -c 02_fortran+c+netcdf+mpi_c.c
	$MPIFC 02_fortran+c+netcdf+mpi_f.o \
		02_fortran+c+netcdf+mpi_c.o \
		-L${NETCDF}/lib -lnetcdff -lnetcdf

	$DIR/MPICH/bin/mpirun ./a.out | tee comp_test2.txt
	export TEST_PASS=$(grep -w -o -c "SUCCESS" comp_test2.txt | awk '{print$1}')
	if [ $TEST_PASS -ge 1 ]; then
		echo "Compatibility Test 2 Passed"
	else
		echo "Compatibility Compiler Test 2 Failed"
		exit
	fi
	echo " "
	read -r -t 3 -p "I am going to wait for 3 seconds only ..."
	echo " "

	echo " All tests completed and passed"
	echo " "

	################################ OpenGrADS ##################################
	#Verison 2.2.1 32bit of Linux
	#############################################################################
	if [[ $GRADS_PICK -eq 1 ]]; then
		cd "${WRF_FOLDER}"/Downloads
		LD_LIBRARY_PATH= tar -xvzf cd "${WRF_FOLDER}"/Downloads
		wget -c https://sourceforge.net/projects/opengrads/files/grads2/2.2.1.oga.1/Linux%20%2864%20Bits%29/opengrads-2.2.1.oga.1-bundle-x86_64-pc-linux-gnu-glibc_2.17.tar.gz
		LD_LIBRARY_PATH= tar -xvzf opengrads-2.2.1.oga.1-bundle-x86_64-pc-linux-gnu-glibc_2.17.tar.gz -C "${WRF_FOLDER}"/ -C "${WRF_FOLDER}"/
		cd "${WRF_FOLDER}"/
		mv "${WRF_FOLDER}"/opengrads-2.2.1.oga.1 "${WRF_FOLDER}"/GrADS
		cd GrADS/Contents
		wget -c https://github.com/regisgrundig/SIMOP/blob/master/g2ctl.pl
		chmod +x g2ctl.pl
		wget -c https://sourceforge.net/projects/opengrads/files/wgrib2/0.1.9.4/wgrib2-v0.1.9.4-bin-i686-glib2.5-linux-gnu.tar.gz
		LD_LIBRARY_PATH= tar -xvzf wgrib2-v0.1.9.4-bin-i686-glib2.5-linux-gnu.tar.gz
		cd wgrib2-v0.1.9.4/bin
		mv wgrib2 "${WRF_FOLDER}"/GrADS/Contents
		cd "${WRF_FOLDER}"/GrADS/Contents
		rm wgrib2-v0.1.9.4-bin-i686-glib2.5-linux-gnu.tar.gz
		rm -r wgrib2-v0.1.9.4

		export PATH="${WRF_FOLDER}"/GrADS/Contents:$PATH

		echo " "
	fi
	################################## GrADS ###############################
	# Version  2.2.1
	# Sublibs library instructions: http://cola.gmu.edu/grads/gadoc/supplibs2.html
	# GrADS instructions: http://cola.gmu.edu/grads/downloads.php
	########################################################################
	if [[ $GRADS_PICK -eq 2 ]]; then

		echo $PASSWD | sudo -S apt -y install grads

	fi

	##################### NCAR COMMAND LANGUAGE           ##################
	########### NCL compiled via Conda                    ##################
	########### This is the preferred method by NCAR      ##################
	########### https://www.ncl.ucar.edu/index.shtml      ##################
	#Installing Miniconda3 to WRF-Hydro directory and updating libraries

	echo $PASSWD | sudo -S apt -y install python3-zstandard python3-zstd

	export Miniconda_Install_DIR="${WRF_FOLDER}"/miniconda3

	mkdir -p $Miniconda_Install_DIR

	wget -c https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O $Miniconda_Install_DIR/miniconda.sh
	bash $Miniconda_Install_DIR/miniconda.sh -b -u -p $Miniconda_Install_DIR

	rm -rf $Miniconda_Install_DIR/miniconda.sh

	export PATH="${WRF_FOLDER}"/miniconda3/bin:$PATH

	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	$Miniconda_Install_DIR/bin/conda init bash

	conda tos accept
	conda config --add channels conda-forge
	conda config --set auto_activate_base false
	conda update -n root --all -y

	echo " "

	echo " "
	#Installing NCL via Conda
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	conda create -n ncl_stable -c conda-forge ncl -y
	conda activate ncl_stable

	conda deactivate
	conda deactivate
	conda deactivate

	echo " "

	##################### WRF Python           ##################
	########### WRf-Python compiled via Conda  ##################
	########### This is the preferred method by NCAR      ##################
	##### https://wrf-python.readthedocs.io/en/latest/installation.html  ##################
	source $Miniconda_Install_DIR/etc/profile.d/conda.sh
	conda env create -f $HOME/WRF-MOSIT/wrf-python-stable.yml

	######################### Climate Data Operators ############
	######################### CDO compiled via Conda ###########
	####################### This is the preferred method #######
	################### https://bairdlangenbrunner.github.io/python-for-climate-scientists/conda/setting-up-conda-environments.html #######################

	source $Miniconda_Install_DIR/etc/profile.d/conda.sh

	conda create --name cdo_stable -y
	conda activate cdo_stable
	conda install -c conda-forge cdo -y
	conda update --all -y
	conda deactivate
	conda deactivate
	conda deactivate

	echo " "

	########################COAWST 3.8###################################
	cd "${WRF_FOLDER}"

	git clone https://github.com/DOI-USGS/COAWST.git

	# Compile Model Coupling Toolkit (MCT)
	cd "${WRF_FOLDER}"/COAWST/Lib/MCT
	MPIHEADER="-I$DIR/MPICH/include" ./configure --prefix="${WRF_FOLDER}"/Libs/MCT 2>&1 | tee coawst.configure.log

	make 2>&1 | tee coawst.make.log
	make install 2>&1 | tee coawst.make.install.log

	export MCT_INCDIR="${WRF_FOLDER}"/Libs/MCT/include
	export MCT_LIBDIR="${WRF_FOLDER}"/Libs/MCT/lib

	cd "${WRF_FOLDER}"/COAWST

	#modifying build_coawst to for paths
	sed -i '134s/INLET_TEST/SANDY/g' build_coawst.sh
	sed -i '142s|/cygdrive/e/data/models/COAWST|"${WRF_FOLDER}"/COAWST/ |g' build_coawst.sh
	sed -i '210s|export|#export|g' build_coawst.sh
	sed -i '211s|#export|export|g' build_coawst.sh
	sed -i '252s|#export|export|g' build_coawst.sh
	sed -i '306s|Inlet_test/Coupled|Sandy|g' build_coawst.sh
	sed -i '307s|Inlet_test/Coupled|Sandy|g' build_coawst.sh

	cd "${WRF_FOLDER}"/COAWST/Compilers
	sed -i '41a\      FFLAGS += -frecord-marker=4 -fconvert=big-endian' Linux-gfortran.mk

	#this removes the arch prompt for gnu compilers
	cd "${WRF_FOLDER}"/COAWST/WRF/arch/

	sed -i '433s|.*|  $response = "34 \\n";|g' Config.pl
	sed -i '898s|.*|  $response = "1 \\n";|g' Config.pl

	cd "${WRF_FOLDER}"/COAWST/

	chmod 775 *.sh

	./build_coawst.sh -j $CPU_QUARTER_EVEN 2>&1 | tee build_coawst.log

	if [ $? -eq 0 ] && [ -e "coawstM" ]; then
		echo "Script ran successfully and coawstM exists."
	else
		echo "Script did not run successfully or coawstM does not exist."
		echo "Running compiler again"
		cd "${WRF_FOLDER}/COAWST/WRF/arch/"
		./build_coawst.sh -j $CPU_QUARTER_EVEN 2>&1 | tee build_coawst2.log
		if [ $? -eq 0 ] && [ -e "coawstM" ]; then
			echo "Script ran successfully and coawstM exists."
		else
			echo "Script did not run successfully or coawstM does not exist."
			read -r -p "Please contact script authors for assistance, press 'Enter' to exit script."
		fi
	fi

fi

##################################### WRFCHEM Tools ###############################################
# This script will install the WRFCHEM pre-processor tools.
# Information on these tools can be found here:
# https://www2.acom.ucar.edu/wrf-chem/wrf-chem-tools-community#download
#
# Addtional information on WRFCHEM can be found here:
# https://ruc.noaa.gov/wrf/wrf-chem/
#
# We ask users of the WRF-Chem preprocessor tools to include in any publications the following acknowledgement:
# "We acknowledge use of the WRF-Chem preprocessor tool {mozbc, fire_emiss, etc.} provided by the Atmospheric Chemistry Observations and Modeling Lab (ACOM) of NCAR."
#
#
# This script installs the WRFCHEM Tools with gnu or intel compilers.
####################################################################################################

if [ "$WRFCHEM_TOOLS" = "1" ]; then

	if [ "$Ubuntu_64bit_GNU" = "1" ] && [ "$WRFCHEM_PICK" = "1" ]; then

		echo $PASSWD | sudo -S apt install git
		cd $HOME
		git clone https://github.com/HathewayWill/WRFCHEM-TOOLS-MOSIT.git
		cd WRFCHEM-TOOLS-MOSIT
		chmod 775 *.sh
		env -i PASSWD="$PASSWD" Ubuntu_64bit_GNU="$Ubuntu_64bit_GNU" ./WRFCHEM_TOOLS_MOSIT.sh $PASSWD $Ubuntu_64bit_GNU
		cd $HOME
	fi

	if [ "$Ubuntu_64bit_Intel" = "1" ] && [ "$WRFCHEM_PICK" = "1" ]; then

		echo $PASSWD | sudo -S apt install git
		cd $HOME
		git clone https://github.com/HathewayWill/WRFCHEM-TOOLS-MOSIT.git
		cd WRFCHEM-TOOLS-MOSIT
		chmod 775 *.sh
		env -i PASSWD="$PASSWD" Ubuntu_64bit_Intel="$Ubuntu_64bit_Intel" ./WRFCHEM_TOOLS_MOSIT.sh $PASSWD $Ubuntu_64bit_Intel
		cd $HOME
	fi

	if [ "$macos_64bit_GNU" = "1" ] && [ "$WRFCHEM_PICK" = "1" ]; then

		brew install git
		cd $HOME
		git clone https://github.com/HathewayWill/WRFCHEM-TOOLS-MOSIT.git
		cd WRFCHEM-TOOLS-MOSIT
		chmod 775 *.sh
		env -i PASSWD="$PASSWD" macos_64bit_GNU="$macos_64bit_GNU" ./WRFCHEM_TOOLS_MOSIT.sh $PASSWD $macos_64bit_GNU
		cd $HOME
	fi

	if [ "$RHL_64bit_GNU" = "1" ] && [ "$WRFCHEM_PICK" = "1" ]; then

		echo $PASSWD | sudo -S dnf install git
		cd $HOME
		git clone https://github.com/HathewayWill/WRFCHEM-TOOLS-MOSIT.git
		cd WRFCHEM-TOOLS-MOSIT
		chmod 775 *.sh
		env -i PASSWD="$PASSWD" RHL_64bit_GNU="$RHL_64bit_GNU" ./WRFCHEM_TOOLS_MOSIT.sh $PASSWD $RHL_64bit_GNU
		cd $HOME
	fi

	if [ "$RHL_64bit_GNU" = "2" ] && [ "$WRFCHEM_PICK" = "1" ]; then

		echo $PASSWD | sudo -S dnf install git
		cd $HOME
		git clone https://github.com/HathewayWill/WRFCHEM-TOOLS-MOSIT.git
		cd WRFCHEM-TOOLS-MOSIT
		chmod 775 *.sh
		env -i PASSWD="$PASSWD" RHL_64bit_GNU="$RHL_64bit_GNU" ./WRFCHEM_TOOLS_MOSIT.sh $PASSWD $RHL_64bit_GNU
		cd $HOME
	fi

fi

#####################################BASH Script Finished##############################

cd $HOME
end=$(date)
END=$(date +"%s")
DIFF=$(($END - $START))
echo "Install Start Time: ${start}"
echo "Install End Time: ${end}"
echo "Install Duration: $(($DIFF / 3600)) hours $((($DIFF % 3600) / 60)) minutes $(($DIFF % 60)) seconds"
